---
title: The power of doing nothing....
description: There's an ongoing discussion on COCAN  on how to make errors explicit
  in function signatures (the proposed solution is to go exceptionless ...
url: https://till-varoquaux.blogspot.com/2008/02/power-of-doing-nothing.html
date: 2008-02-10T10:52:00-00:00
preview_image:
authors:
- Till
source:
---

<p>There's an ongoing discussion on <a href="http://www.cocan.org" class="externalLink">COCAN</a> on how to make errors explicit in function signatures (the proposed solution is to <a href="http://wiki.cocan.org/osr/exceptionless_error_management" class="externalLink">go exceptionless</a>). I will not delve on why I do not think this is a standard that should be adopted. Instead we will explore a very lightweight solutions that preserves the stack unwinding capability of exceptions whilst making the possible errors explicit in the signatures of the function.</p> <h2>Basic types</h2> <p>When one of our function is applied there we can have <em>either</em> one of two possible outcomes: everything goes <em>right</em> or we are <em>left</em> over with an error (notice the cheap mnemonics). Now if we get rid of exceptions we want our return types to be able all this information. To do so we mimics Haskell's <a href="http://haskell.org/ghc/docs/latest/html/libraries/base/Prelude.html#v:either" class="externalLink"> either</a> type:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;either&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #009900">Left</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">of</span></span>&nbsp;'a&nbsp;<span style="color: #990000">|</span>&nbsp;<span style="color: #009900">Right</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">of</span></span>&nbsp;'b</tt></div> <p>In case you haden't caught my subtle hints <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt><span style="color: #009900">Right</span></tt></span> is used to hold results and <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt><span style="color: #009900">Left</span></tt></span> to hold errors.</p> <p>For our short example we shall have a limited number of possible errors:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;possible_exc&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[</span>`<span style="color: #009900">Too_Small</span><span style="color: #990000">|</span>`<span style="color: #009900">Too_Big</span><span style="color: #990000">|</span>`<span style="color: #009900">Div_by_zero</span><span style="color: #990000">|</span>`<span style="color: #009900">Some_other_error</span><span style="color: #990000">]</span></tt></div> <p>that can be thrown in an exception:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">exception</span></span>&nbsp;<span style="color: #009900">MyExc</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">of</span></span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc<span style="color: #990000">]</span></tt></div> <p>(Allthough I may not be using any unsafe features of OCaml I am actually exploiting a bug in the type-checker here. The absence of this hack would make one of our functions a little less precise).</p> <h2>External interface</h2> <p>Ideally we'd want to choose functions should raise an exception or return a wrapped value. This choice has to be made at function application. Bearing this in mind our external interface is:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #009900">External</span>&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">sig</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;value&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">constraint</span></span>&nbsp;'a&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc&nbsp;<span style="color: #990000">]</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;run&nbsp;<span style="color: #990000">:</span>&nbsp;<span style="color: #990000">(</span>'a&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #990000">(</span>'b<span style="color: #990000">,</span>'c<span style="color: #990000">)</span>&nbsp;value<span style="color: #990000">)</span>&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'a&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'c<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;run_exn&nbsp;<span style="color: #990000">:</span>&nbsp;<span style="color: #990000">(</span>'a&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #990000">(</span>'b<span style="color: #990000">,</span>'c<span style="color: #990000">)</span>&nbsp;value<span style="color: #990000">)</span>&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'a&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #990000">(</span>'b<span style="color: #990000">,</span>'c<span style="color: #990000">)</span>&nbsp;either<br/> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></div> <h2>Internal interface</h2> <p>The idea behind this implementation is to use a phantom type attached to a value we shall pass along. This phantom type will be unified with every single single value we might raise thus acting as a &quot;collector&quot; for all the possible exceptions. Without further ado let proceed:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #009900">Internal</span>&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">sig</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;'a&nbsp;t&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">constraint</span></span>&nbsp;'a&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc&nbsp;<span style="color: #990000">]</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;value&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">constraint</span></span>&nbsp;'a&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc&nbsp;<span style="color: #990000">]</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;create&nbsp;<span style="color: #990000">:</span>&nbsp;<span style="color: #009900">unit</span>&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'a&nbsp;t<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;raise&nbsp;<span style="color: #990000">:</span>&nbsp;'a&nbsp;t&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'a&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'b<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;return&nbsp;<span style="color: #990000">:</span>&nbsp;'a&nbsp;t&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'b&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;value<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">val</span></span>&nbsp;lift&nbsp;<span style="color: #990000">:</span>&nbsp;'a&nbsp;t&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;value&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;'b<br/> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></div> <p>The type <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>t</tt></span> is our collector. It can only be created via the <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>create</tt></span> function. <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>raise</tt></span> and <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>return</tt></span> are rather self explanatory, <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>lift</tt></span> might come as more of a surprise: it is used to get the returned values from one our function. It ensures the possible errors of the called functions are unified with the &quot;collector&quot; of the callee. The internal interface does not expose functions like <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt><span style="font-weight: bold"><span style="color: #000080">External</span></span><span style="color: #990000">.</span>run</tt></span> because it discards the possible error cases.</p> <h2>Implementation</h2> <p>Our interfaces being set we will now present an implementation. It has been stated at the beginning of this post that we want it as lightweight as possible. Since we will (ab)use the identity functions let's get it out of the way:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;ident&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>&nbsp;i&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;i</tt></div> <p>We are not using the more efficient external <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt><span style="color: #FF0000">&quot;%identity&quot;</span></tt></span> function because it is, in essence, not type safe. If we consider that the unit value is a value that carries no information (the <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt><span style="color: #009900">unit</span></tt></span> type being inhabited by only one value) and the identity function is a function that does nothing our implementation really doesn't do much:</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span>&nbsp;<span style="color: #009900">Impl</span>&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;'a&nbsp;t&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #009900">unit</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">constraint</span></span>&nbsp;'a&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc&nbsp;<span style="color: #990000">]</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">type</span></span>&nbsp;<span style="color: #990000">(</span>'a<span style="color: #990000">,</span>'b<span style="color: #990000">)</span>&nbsp;value&nbsp;<span style="color: #990000">=</span>&nbsp;'b&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">constraint</span></span>&nbsp;'a&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #990000">[&lt;</span>&nbsp;possible_exc&nbsp;<span style="color: #990000">]</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;create&nbsp;<span style="color: #990000">=</span>&nbsp;ident<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;raise&nbsp;<span style="color: #990000">()</span>&nbsp;e&nbsp;<span style="color: #990000">=</span>&nbsp;raise&nbsp;<span style="color: #990000">(</span><span style="color: #009900">MyExc</span>&nbsp;e<span style="color: #990000">)</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;return&nbsp;<span style="color: #990000">()</span>&nbsp;<span style="color: #990000">=</span>&nbsp;ident<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;run&nbsp;<span style="color: #990000">=</span>&nbsp;ident<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;lift&nbsp;<span style="color: #990000">()</span>&nbsp;<span style="color: #990000">=</span>&nbsp;ident<br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;run_exn&nbsp;f&nbsp;v&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">try</span></span>&nbsp;<span style="color: #009900">Right</span>&nbsp;<span style="color: #990000">(</span>f&nbsp;v<span style="color: #990000">)</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">with</span></span>&nbsp;&nbsp;<span style="color: #009900">MyExc</span>&nbsp;v&nbsp;<span style="color: #990000">-&gt;</span>&nbsp;<span style="color: #009900">Left</span>&nbsp;v<br/> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></div> <h2>Excercising it</h2> <p>Let's take our shiny new modules for a test run. The types commented are the inferred types and thus the most general ones.</p> <div style="background:#e6e6e6;border:1px solid #a0a0a0;"> <tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span>&nbsp;<span style="color: #009900">I</span><span style="color: #990000">:</span><span style="color: #009900">Internal</span>&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #009900">Impl</span><br/> <br/> <span style="font-style: italic"><span style="color: #9A1900">(*&nbsp;int&nbsp;-&gt;&nbsp;([&lt;&nbsp;possible_exc&nbsp;&gt;&nbsp;`Too_Big&nbsp;`Too_Small&nbsp;],&nbsp;unit)&nbsp;I.value&nbsp;*)</span></span><br/> <span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;check_range&nbsp;i&nbsp;<span style="color: #990000">=</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;t&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>create&nbsp;<span style="color: #990000">()</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">in</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">if</span></span>&nbsp;i&nbsp;<span style="color: #990000">&gt;</span>&nbsp;<span style="color: #993399">5</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">then</span></span><br/> &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>raise&nbsp;t&nbsp;`<span style="color: #009900">Too_Big</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">else</span></span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">if</span></span>&nbsp;i&nbsp;<span style="color: #990000">&lt;</span>&nbsp;<span style="color: #990000">-</span><span style="color: #993399">5</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">then</span></span><br/> &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>raise&nbsp;t&nbsp;`<span style="color: #009900">Too_Small</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">else</span></span><br/> &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>return&nbsp;t&nbsp;<span style="color: #990000">()</span><br/> <br/> <span style="font-style: italic"><span style="color: #9A1900">(*&nbsp;'a&nbsp;-&gt;&nbsp;int&nbsp;-&gt;&nbsp;([&lt;&nbsp;possible_exc&nbsp;&gt;&nbsp;`Div_by_zero&nbsp;],&nbsp;int)&nbsp;I.value&nbsp;*)</span></span><br/> <span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;div&nbsp;x&nbsp;y&nbsp;<span style="color: #990000">=</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;t&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>create&nbsp;<span style="color: #990000">()</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">in</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">if</span></span>&nbsp;y&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="color: #993399">0</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">then</span></span><br/> &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>raise&nbsp;t&nbsp;`<span style="color: #009900">Div_by_zero</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">else</span></span><br/> &nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>return&nbsp;t&nbsp;<span style="color: #993399">0</span><br/> <br/> <span style="font-style: italic"><span style="color: #9A1900">(*</span></span><br/> <span style="font-style: italic"><span style="color: #9A1900">&nbsp;int&nbsp;-&gt;</span></span><br/> <span style="font-style: italic"><span style="color: #9A1900">&nbsp;int&nbsp;-&gt;</span></span><br/> <span style="font-style: italic"><span style="color: #9A1900">&nbsp;([&lt;&nbsp;possible_exc&nbsp;&gt;&nbsp;`Div_by_zero&nbsp;`Too_Big&nbsp;`Too_Small&nbsp;],&nbsp;int)&nbsp;I.value</span></span><br/> <span style="font-style: italic"><span style="color: #9A1900">*)</span></span><br/> <span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;div_in_range&nbsp;x&nbsp;y&nbsp;<span style="color: #990000">=</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">let</span></span>&nbsp;e&nbsp;<span style="color: #990000">=</span>&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>create&nbsp;<span style="color: #990000">()</span>&nbsp;<span style="font-weight: bold"><span style="color: #0000FF">in</span></span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>lift&nbsp;e&nbsp;<span style="color: #990000">(</span>check_range&nbsp;x<span style="color: #990000">);</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>lift&nbsp;e&nbsp;<span style="color: #990000">(</span>check_range&nbsp;y<span style="color: #990000">);</span><br/> &nbsp;&nbsp;<span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>return&nbsp;e&nbsp;<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">I</span></span><span style="color: #990000">.</span>lift&nbsp;e&nbsp;<span style="color: #990000">(</span>div&nbsp;x&nbsp;y<span style="color: #990000">))</span></tt></div> <h2>Conclusion</h2> <p>Even though this actually works it does not scale well to multiple modules. It should be considered as a proof of concept rather than serious code.</p> <p>As there name imply exception should be used to handle exceptional cases. A well designed library should only throw exception when it encounters an error or a bug. Exception should only be used for error recovery (they might be used internally for hacks such as bugtracking but should never trickle out of the library). It seems cumbersome to impose the callee of library functions to handle a long trail of more and more exotic error cases.</p> <p>If one really desires to have explicit error handling combining our <span style="background:#e6e6e6;border:1px solid #a0a0a0;"><tt>either</tt></span> type with <a href="http://sigfpe.blogspot.com/2006/08/you-could-have-invented-monads-and.html" class="externalLink"> monads</a> seems to be the sane route. This is exactly what the haskell <a href="ttp://www.haskell.org/ghc/docs/6.2.2/html/libraries/base/Control.Monad.Error.html" class="externalLink"> error monad</a> does.</p> <p>Talking about haskell, an interesting read is <a href="http://www.randomhacks.net/articles/2007/03/10/haskell-8-ways-to-report-errors" class="externalLink"> 8 ways to report errors in Haskell</a>. It gives a good overview on how messy and uncoherent error reporting can get.</p>
