---
title: 'News from July '
description: Once again, here is the summary of our activities for last month. The
  highlight this month is the release of ocaml-top, an interactive editor for education
  which works well under Windows and that we hope professors all around the world
  will use to teach OCaml to their students. We are also continuyi...
url: https://ocamlpro.com/blog/2013_08_05_news_from_july
date: 2013-08-05T13:19:46-00:00
preview_image: URL_de_votre_image
authors:
- "\n    \xC7agdas Bozman\n  "
source:
---

<p>Once again, here is the summary of our activities for last month. The highlight this month is the release of <a href="http://www.typerex.org/ocaml-top.html">ocaml-top</a>, an interactive editor for education which works well under Windows and that we hope professors all around the world will use to teach OCaml to their students. We are also continuying our work on the improvement of the performance of OCaml, with new inlining heuristics in the compiler and adding multicore support to the runtime.</p>
<h2>Compiler updates</h2>
<p>Last month, we started to get very nice results with our compiler performance improvements. First, Pierre Chambart polished the prototype implementation of his new <code>flamba</code> intermediate language and he started to get impressive <a href="http://ocamlpro.com/2013/07/11/better-inlining-progress-report/">micro-benchmarks results</a>, with around 20% &ndash; 30% improvements on code using exceptions or functors. Following a discussion with our industrial users, he is currently focusing on improving the compilation of local recursive functions such as the very typical:</p>
<pre><code class="language-ocaml">let f x y =  
let rec loop v =  
&hellip; x &hellip;  
loop z  
in  
loop x  
</code></pre>
<p>A simple and reasonably efficient solutions is to eta-expand the auxiliary function, i.e. add an intermediate function calling the loop with all closure parameters passed as variables. The hard part is to then to add the right arguments to all the call sites: luckily enough the new inlining engine already does that kind of analysis so it can be re-used here. This means that these constructs will be compiled efficiently by the new inlining heuristics.</p>
<p>Second, Luca Saiu has finished debugging the native thread support on top of his <a href="https://github.com/lucasaiu/ocaml">multi-runtime variant of OCaml</a>, which has become quite usable and is pretty robust now. He has tentatively started adding support for <code>vmthreads</code> as well, concurrently cleaning up context finalization and solving other minor issues, such as configuration scripts for architectures that do not support the multi-runtime features yet. Then, after writing documentation and running a full pass over the sources to remove debugging stubs and prints which pollute the code after months of low-level experimentation, he is going to prepare patches for discussion and submission to the main OCaml compiler.</p>
<p>&Ccedil;agdas Bozman continued to improve the implementation of his <a href="https://github.com/cago/ocaml">profiling tools</a> for both native and byte-code programs. A great output of his recent work is that the location information is much more precise: with very different techniques for native and byte code, the program locations are now uniquely identified. The usability was improved as well, as the profiling location tables are now embedded directly into the programs. He also improved the post-mortem profiling tools to re-type dumped heaps, which also leads to much more accurate profiling information. &Ccedil;agdas is now actively using these tools on <a href="http://why3.lri.fr/">why3</a> and he expects to get feedback results very soon to continue to improve his tools.</p>
<p>Finally, Thomas Blanc is still working on whole program analysis for his internship, in order to find possibly uncaught exceptions. The project is moving quite well and the month was spent on analyzing the lambda intermediate representation of the compilation step. With the help of Pierre Chambart, he is working on a <a href="https://github.com/thomasblanc/ocaml-data-analysis">0-CFA library</a> that should allow to compute the &ldquo;possible&rdquo; values for each variable at each point of the program. The idea is to make a directed hypergraph with each hyperedge representing an instruction and each vertex being a state of the program. Then search a fixpoint in the possible values propagated through the graph. This allows the compiler to know everywhere in the program what possible values may be returned or what possible exceptions may be raised. In order to create a well-designed graph, it is needed to create a new intermediate representation that looks like Lambda except (mainly) that every expression gets an identifier. The next step is to specify a hypergraph construction for each primitive and control-flow.</p>
<h2>Development Tools</h2>
<h3>Editors</h3>
<p>This month, Louis Gesbert has been busy making the first release of <a href="http://www.typerex.org/ocaml-top.html">ocaml-top</a>, the simple graphical top-level for beginners and students. Together with the web-IDE, this project aims at lowering the entry barrier to OCaml. Ocaml-top features a clean and easy to access interface, with nonetheless advanced features like automatic semantic indentation, error marking, and integrated display of standard library types &mdash; using the engines of <a href="https://github.com/OCamlPro/ocp-indent">ocp-indent</a> and <a href="https://github.com/OCamlPro/ocp-index">ocp-index</a> of course. The biggest challenge was probably to make everything work as expected on Microsoft Windows, which was required for most beginners and classrooms.</p>
<p><img src="https://ocamlpro.com/blog/assets/img/ocaml_top.png" alt="ocaml-top"/></p>
<p>The two main issues were:</p>
<ul>
<li>Setup the build environment: there are several versions of OCaml for Windows ; we generally want to avoid any dependency on cygwin on the generated program, but it&rsquo;s very hard to avoid any need for it in the build chain. The easiest solution at the moment is to &ldquo;cross-compile&rdquo; from cygwin using the mingw32 gcc compiler. The hard part is to get all the needed libraries properly setup: this felt a lot like Linux 15 years ago, you can find some binaries but generally not properly configured, and there is no consistent packaging system (or at least you can&rsquo;t find what you want in it).
</li>
<li>Process management: ocaml-top runs the OCaml toplevel as a sub-process, so as not to be inpaired by any problem in the user program. Interacting with that process in a portable way is close to impossible, Windows having no POSIX signals, and read/write operations being very different in terms of blocking, etc. Some obscure C bindings were required to simulate a SIGINT that could tell the ocaml process to stop the current computation and return to the prompt. But at this cost, ocaml-top can be run with any existing external OCaml toplevel.
</li>
</ul>
<p>Not mentioning some gtk/lablgtk bugs that were often OS-specific. After having read <a href="http://gallium.inria.fr/~scherer/gagallium/the-ocaml-installer-for-windows/">horror stories</a> about the most commonly used &ldquo;Windows installer generator&rdquo; <a href="http://nsis.sourceforge.net/Main_Page">NSIS</a>, Louis opted for the Microsoft open source solution <a href="http://wixtoolset.org/">WiX</a> which turned out to be quite clean and efficient, although using a lot of XML. The only point that might be in favor of NSIS is that it can generate the installer from Linux, so it&rsquo;s much convenient when you cross-compile, which is not the case here ; also worth mentioning, Xen and LVM are really great tools which do save a lot of time when working and testing between two (or more) different OSes.</p>
<p>Always on the editor front, David and Pierrick have been working on a web-IDE for OCaml since the beginning of their internship two months ago. For now, the IDE includes <a href="http://ace.c9.io/">Ace</a>, an editor, plugged with some features specific for OCaml, particularly <a href="https://github.com/OCamlPro/ocp-indent">ocp-indent</a>, made possible by using <a href="http://ocsigen.org/js_of_ocaml/">js_of_ocaml</a> which compiles bytecode to Javascript. It also includes a basic project manager that uses a server to store files for each user. Authentication is done by using <a href="http://www.mozilla.org/en-US/persona/">Mozilla&rsquo;s Persona</a>. One particularly nice feature they are working on is <em>client-side</em> bytecode generation: this means users can ask their browser to produce the byte-code of the project they are working on <em>without any connection to the server</em> ! Beware that this is still work-in-progress and the feature is not bug-free for the moment. The project (undocumented for now) is available on <a href="https://github.com/pcouderc/ocp-webedit">Github</a>.</p>
<h3>Tools</h3>
<p>Meanwhile, most of my time last month has been spent preparing the next release of OPAM, with the help of Louis Gesbert. This new release will contain a <a href="https://github.com/OCamlPro/opam/issues?milestone=17&amp;page=1&amp;state=closed">lot of bug-fixes</a> and an improved <code>opam update</code> mechanism: it will be much more flexible, faster and more stable than the one present in <code>1.0</code>. Few months ago, I had already pushed a <a href="https://github.com/OCamlPro/opam/pull/597">first batch of patches</a> to the development version, which started to make things look much better. I decided last month to continue improving that feature and make it rock-solid: hence I have started a <a href="https://github.com/samoht/opam-rt">regression testing platform for OPAM</a> which is still young but already damn useful to stabilize my new <a href="https://github.com/OCamlPro/opam/pull/719">set of patches</a>. <code>opam-rt</code> is also written in OCaml: it generates random repositories with random packages, shuffles everything around and checks that OPAM correctly picks-up the changes. In the future this will make it easier to test complex OPAM scenarios and will hopefully lead to a better OPAM.</p>
<p><a href="https://github.com/OCamlPro/ocp-index">ocp-index</a> has seen some progress, with lots of rough edges rounded, and much better performance on big <code>cmi</code> files (typically module packs, like <code>Core.Std</code>). While more advanced functionality is being planned, it is already very helpful, and problems seen in earlier development versions have been fixed. The upcoming release also greatly improves the experience from emacs, and might become the first &ldquo;stable&rdquo;. The flow of bugs reported on <a href="https://github.com/OCamlPro/ocp-index">ocp-indent</a> is drying up, which means the tool is gaining some maturity. Not much visible changes for the past month except for a few bug-fixes, but the library interface has been completely rewritten to offer much more flexibility while being more friendly. This has allowed it to be plugged in the Web-IDE (see above), which being executed in JavaScript has much tighter performance constraints &mdash; the indent engine is only re-run where required after changes &mdash; ; and in ocaml-top, where it is also used to detect top-level phrase bounds.</p>
<h2>Community</h2>
<p>We are proud to be well represented at the <a href="http://ocaml.org/meetings/ocaml/2013/program.html">OCaml Developer Workshop 2013</a>. This year it happens in Boston, in September, co-located with the <a href="http://cufp.org/conference/schedule/2013">Conference of Users of Functional Programming</a>. Both conferences will contains a lot of OCaml-related talks: I am especially excited to hear about <a href="http://cufp.org/conference/schedule/2013">PHP type-inference efforts</a> at Facebook using OCaml! If you are in the area around the 22/23 and 24 of September and you want to chat about OCamlPro and OCaml, we will be around!</p>

