---
title: Build A CLI in OCaml with the Cmdliner Library
description: Learn to build a command-line interface in OCaml using Cmdliner library.
  Follow steps to set up, write code, and execute your CLI tool
url: https://debajyatidey.hashnode.dev/build-a-cli-in-ocaml-with-the-cmdliner-library
date: 2024-12-27T15:31:54-00:00
preview_image: https://hashnode.com/utility/r?url=https%3A%2F%2Fcdn.hashnode.com%2Fres%2Fhashnode%2Fimage%2Fupload%2Fv1735313191864%2Fc16e8a16-8804-4645-9136-7670ed8ca5f7.gif%3Fw%3D1200%26h%3D630%26fit%3Dcrop%26crop%3Dentropy%26auto%3Dformat%2Ccompress%26gif-q%3D60%26format%3Dwebm%26fm%3Dpng
authors:
- Debajyati's OCaml Blog
source:
---

In this tutorial we are building a simple CLI named textsearch which is able to search a provided piece of string (probably a word) in a given text file.<p></p><p>Prior knowledge of components of a dune project is <strong>recommended</strong> but <strong>not required</strong>. I will guide you setting up the dune project.</p><p>Entire source code of this demo project is available at - <a href="https://github.com/Debajyati/textsearch/releases/tag/v0.2.1" target="_blank">Release v0.2.1  Debajyati/textsearch</a></p><p>This tutorial assumes you have dune preinstalled. If not, then install it via opam -</p><pre><code class="lang-bash">opam install dune</code></pre><h1>Summary of the Content Prior to Reading the Article</h1><blockquote><p>In this tutorial, you'll learn to build a simple command-line interface (CLI) tool called "textsearch" using OCaml and the Cmdliner library. The tool searches for a specified term in a text file with options for case sensitivity and character order. You'll be guided through setting up a Dune project, configuring the necessary files, writing the search logic, and defining command-line arguments using Cmdliner. The tutorial covers the project structure, dependencies, and detailed explanations of the code components to help you understand and implement the CLI tool effectively.</p></blockquote><h1>What is Cmdliner?</h1><p>Cmdliner is a library that helps you build command line interface programs in OCaml.</p><p>It provides a simple and compositional mechanism to create commands and arguments in a declarative syntax.</p><p>So, lets get started!</p><p><img src="https://gifdb.com/images/high/let-the-games-begin-498-x-378-gif-y1jl2z80kk0g3ewi.gif" alt="" class="image--center mx-auto"></p><h1>Create a Dune Project</h1><p>Lets start writing code. But before that we need to create a dune project.</p><p>Initialize the dune project by -</p><pre><code class="lang-bash">dune init proj textsearch</code></pre><p>We will need the Cmdliner library installed in our system to build and run our project. So, install it via opam.</p><pre><code class="lang-bash">opam install cmdliner</code></pre><p>Great! Now before you write the actual code, you need to setup the dune project by writing the configuration files properly.</p><h1>Setting Up the Dune Project</h1><p>At the end of this tutorial the file tree of our project will be like -</p><pre><code class="lang-markdown">. bin    dune    main.ml lib    dune    search.ml test    dune    test<span class="hljs-emphasis">_textsearch.ml dune-project textsearch.opam</span></code></pre><p>Here the textsearch.opam file is not your concern, dont touch it. This file is generated by dune, edit dune-project instead.<br>The dune-project file defines project-wide settings.</p><p>For now, you dont need to edit most of the parts of the file dune-project.<br>Currently the file must look like -</p><pre><code class="lang-apache">(<span class="hljs-attribute">lang</span> dune <span class="hljs-number">3</span>.<span class="hljs-number">17</span>)(<span class="hljs-attribute">name</span> textsearch)(<span class="hljs-attribute">generate_opam_files</span> true)(<span class="hljs-attribute">source</span> (<span class="hljs-attribute">github</span> username/reponame))(<span class="hljs-attribute">authors</span> <span class="hljs-string">"Author Name &lt;author@example.com&gt;"</span>)(<span class="hljs-attribute">maintainers</span> <span class="hljs-string">"Maintainer Name &lt;maintainer@example.com&gt;"</span>)(<span class="hljs-attribute">license</span> LICENSE)(<span class="hljs-attribute">documentation</span> https://url/to/documentation)(<span class="hljs-attribute">package</span> (<span class="hljs-attribute">name</span> textsearch) (<span class="hljs-attribute">synopsis</span> <span class="hljs-string">"A short synopsis"</span>) (<span class="hljs-attribute">description</span> <span class="hljs-string">"A longer description"</span>) (<span class="hljs-attribute">depends</span> ocaml) (<span class="hljs-attribute">tags</span>  ("<span class="hljs-attribute">add</span> topics<span class="hljs-string">" "</span>to describe<span class="hljs-string">" your project))); See the complete stanza docs at https://dune.readthedocs.io/en/stable/reference/dune-project/index.html</span></code></pre><p>Now change the package stanza to this -</p><pre><code class="lang-apache">(<span class="hljs-attribute">package</span> (<span class="hljs-attribute">name</span> textsearch) (<span class="hljs-attribute">synopsis</span> <span class="hljs-string">"A simple text search CLI tool"</span>) (<span class="hljs-attribute">description</span> <span class="hljs-string">"CLI tool to search terms in files"</span>) (<span class="hljs-attribute">depends</span>  (<span class="hljs-attribute">ocaml</span> (&gt;= <span class="hljs-number">5</span>.<span class="hljs-number">2</span>))  (<span class="hljs-attribute">cmdliner</span> (&gt;= <span class="hljs-number">1</span>.<span class="hljs-number">3</span>.<span class="hljs-number">0</span>))  (<span class="hljs-attribute">dune</span> (&gt;= <span class="hljs-number">3</span>.<span class="hljs-number">17</span>))) (<span class="hljs-attribute">tags</span>  ("<span class="hljs-attribute">cmdline</span><span class="hljs-string">" "</span>text<span class="hljs-string">" "</span>search<span class="hljs-string">")))</span></code></pre><p>Nice!<br>We have two important directories here -</p><ul><li><p><code>lib/</code> - Holds the source code for libraries within your project.</p></li><li><p><code>bin/</code> - Contains the source code for executables.</p></li></ul><p>Forget the test folder for now as we are not going to write test cases for our project (At least not in this tutorial).</p><p>We also have a dune file in each of the folders. These files define how to build the specific executable within that directory.<br>Specifically, they are for -</p><ul><li><p>Specifying dependencies (both internal and external libraries).</p></li><li><p>Specifying rules for building the target.</p></li></ul><p>Paste the following code in <code>bin/dune</code> file -</p><pre><code class="lang-apache">(<span class="hljs-attribute">executable</span> (<span class="hljs-attribute">public_name</span> textsearch) (<span class="hljs-attribute">name</span> main) (<span class="hljs-attribute">libraries</span> search cmdliner))</code></pre><p>Paste the code below in the <code>lib/dune</code> file -</p><pre><code class="lang-apache">(<span class="hljs-attribute">library</span>  (<span class="hljs-attribute">name</span> search) (<span class="hljs-attribute">public_name</span> textsearch))</code></pre><p>All good! Finally, the configuration work is DONE! HUH!</p><p>We can finally write the actual code.</p><h1>Writing The Actual Code</h1><h2>Our Internal library</h2><p>We will need an internal library called <code>search.ml</code> as we have specified in the dune files. Create that file in the <code>lib/</code> directory.</p><pre><code class="lang-bash">touch lib/search.ml</code></pre><p>Now, paste this code in the file -</p><pre><code class="lang-ocaml"><span class="hljs-keyword">let</span> search_in_file ~case_sensitive ~consider_order term file =  <span class="hljs-keyword">let</span> normalize s =    <span class="hljs-keyword">if</span> case_sensitive <span class="hljs-keyword">then</span> s <span class="hljs-keyword">else</span> <span class="hljs-type">String</span>.lowercase_ascii s  <span class="hljs-keyword">in</span>  <span class="hljs-keyword">let</span> term = normalize term <span class="hljs-keyword">in</span>  <span class="hljs-keyword">let</span> contains_term line =    <span class="hljs-keyword">let</span> line = normalize line <span class="hljs-keyword">in</span>    <span class="hljs-keyword">if</span> consider_order <span class="hljs-keyword">then</span>      <span class="hljs-keyword">try</span>        <span class="hljs-keyword">let</span> line_len = <span class="hljs-type">String</span>.length line <span class="hljs-keyword">in</span>        <span class="hljs-keyword">let</span> term_len = <span class="hljs-type">String</span>.length term <span class="hljs-keyword">in</span>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> check_substring i =          <span class="hljs-keyword">if</span> i + term_len &gt; line_len <span class="hljs-keyword">then</span> <span class="hljs-literal">false</span>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-type">String</span>.sub line i term_len = term <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span>          <span class="hljs-keyword">else</span> check_substring (i + <span class="hljs-number">1</span>)        <span class="hljs-keyword">in</span>        check_substring <span class="hljs-number">0</span>      <span class="hljs-keyword">with</span> _ -&gt; <span class="hljs-literal">false</span>    <span class="hljs-keyword">else</span>      <span class="hljs-keyword">let</span> term_chars = <span class="hljs-type">String</span>.to_seq term |&gt; <span class="hljs-type">List</span>.of_seq <span class="hljs-keyword">in</span>      <span class="hljs-keyword">let</span> line_chars = <span class="hljs-type">String</span>.to_seq line |&gt; <span class="hljs-type">List</span>.of_seq <span class="hljs-keyword">in</span>      <span class="hljs-type">List</span>.for_all (<span class="hljs-keyword">fun</span> c -&gt; <span class="hljs-type">List</span>.mem c line_chars) term_chars  <span class="hljs-keyword">in</span>  <span class="hljs-keyword">let</span> ic = open_in file <span class="hljs-keyword">in</span>  <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> process_lines line_num acc =    <span class="hljs-keyword">try</span>      <span class="hljs-keyword">let</span> line = input_line ic <span class="hljs-keyword">in</span>      <span class="hljs-keyword">let</span> new_acc = <span class="hljs-keyword">if</span> contains_term line <span class="hljs-keyword">then</span> (line_num, line) :: acc <span class="hljs-keyword">else</span> acc <span class="hljs-keyword">in</span>      process_lines (line_num + <span class="hljs-number">1</span>) new_acc    <span class="hljs-keyword">with</span> <span class="hljs-type">End_of_file</span> -&gt;      close_in ic;      <span class="hljs-type">List</span>.rev acc  <span class="hljs-keyword">in</span>  process_lines <span class="hljs-number">1</span> <span class="hljs-literal">[]</span>;;<span class="hljs-keyword">let</span> print_matches matches =  <span class="hljs-type">List</span>.iter    (<span class="hljs-keyword">fun</span> (line_num, line) -&gt; <span class="hljs-type">Printf</span>.printf <span class="hljs-string">"%d: %s\n"</span> line_num line)    matches;;</code></pre><p>Weve two functions in this file.</p><ul><li><p><strong>search_in_file -</strong> This function takes four arguments:</p><ul><li><p><code>case_sensitive</code>: A boolean value indicating whether the search should be case sensitive or not.</p></li><li><p><code>consider_order</code>: A boolean value indicating whether the order of characters in the term matters during the search.</p></li><li><p><code>term</code>: The string to search for in the file.</p></li><li><p><code>file</code>: The path to the file to search in.</p><p>  The function opens a file for reading. Then it recursively iterates over the lines of the file. On each iteration, the function reads a line, checks if the line contains the term. If the line contains the term, it adds the line number and the line itself as a tuple to an accumulator list. It recursively calls itself on the next line number and the updated accumulator list. When it reaches the end of the file (<code>End_of_file</code> exception), it closes the file and reverses the accumulated list (to display lines in their original order).</p></li></ul></li><li><p><strong>print_matches - This function</strong> takes a list of matches as input where each match is a tuple containing the line number and the line itself. It iterates over the list of matches and prints each match in the format "line_num: line".</p></li></ul><p>I hope this explanation is clear and good to go ahead.</p><h2>Our Executable Program</h2><p>This is our <code>bin/main.ml</code> file. Here we will import both of our internal library <code>Search</code> and external library <code>Cmdliner</code>, and then define the command and arguments.</p><pre><code class="lang-ocaml"><span class="hljs-keyword">open</span> <span class="hljs-type">Cmdliner</span><span class="hljs-keyword">open</span> <span class="hljs-type">Search</span><span class="hljs-comment">(* Define arguments *)</span><span class="hljs-keyword">let</span> search_term =  <span class="hljs-keyword">let</span> doc = <span class="hljs-string">"The term to search for"</span> <span class="hljs-keyword">in</span>  <span class="hljs-type">Arg</span>.(required &amp; pos <span class="hljs-number">0</span> (some <span class="hljs-built_in">string</span>) <span class="hljs-type">None</span> &amp; info <span class="hljs-literal">[]</span> ~docv:<span class="hljs-string">"TERM"</span> ~doc)<span class="hljs-keyword">let</span> file_name =  <span class="hljs-keyword">let</span> doc = <span class="hljs-string">"The file to search in"</span> <span class="hljs-keyword">in</span>  <span class="hljs-type">Arg</span>.(required &amp; pos <span class="hljs-number">1</span> (some <span class="hljs-built_in">string</span>) <span class="hljs-type">None</span> &amp; info <span class="hljs-literal">[]</span> ~docv:<span class="hljs-string">"FILE"</span> ~doc)<span class="hljs-keyword">let</span> case_sensitive =  <span class="hljs-keyword">let</span> doc = <span class="hljs-string">"Perform a case-sensitive search"</span> <span class="hljs-keyword">in</span>  <span class="hljs-type">Arg</span>.(<span class="hljs-keyword">value</span> &amp; flag &amp; info [<span class="hljs-string">"c"</span>; <span class="hljs-string">"case-sensitive"</span>] ~doc)<span class="hljs-keyword">let</span> consider_order =  <span class="hljs-keyword">let</span> doc = <span class="hljs-string">"Consider the order of characters in the search term"</span> <span class="hljs-keyword">in</span>  <span class="hljs-type">Arg</span>.(<span class="hljs-keyword">value</span> &amp; flag &amp; info [<span class="hljs-string">"o"</span>; <span class="hljs-string">"consider-order"</span>] ~doc)<span class="hljs-comment">(* Core command logic *)</span><span class="hljs-keyword">let</span> run case_sensitive consider_order term file =  <span class="hljs-keyword">let</span> matches = search_in_file ~case_sensitive ~consider_order term file <span class="hljs-keyword">in</span>  print_matches matches;  <span class="hljs-keyword">if</span> <span class="hljs-type">List</span>.length matches = <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>    (<span class="hljs-type">Printf</span>.eprintf <span class="hljs-string">"No matches found.\n"</span>; exit <span class="hljs-number">1</span>)  <span class="hljs-keyword">else</span>    exit <span class="hljs-number">0</span><span class="hljs-comment">(* Create the command *)</span><span class="hljs-keyword">let</span> cmd =  <span class="hljs-keyword">let</span> info =    <span class="hljs-type">Cmd</span>.info <span class="hljs-string">"textsearch"</span>      ~version:<span class="hljs-string">"1.0.0"</span>      ~doc:<span class="hljs-string">"Search for a term in a file with options for case sensitivity and character order"</span>  <span class="hljs-keyword">in</span>  <span class="hljs-type">Cmd</span>.v info    <span class="hljs-type">Term</span>.(const run $ case_sensitive $ consider_order $ search_term $ file_name)<span class="hljs-comment">(* Main entry point *)</span><span class="hljs-keyword">let</span> <span class="hljs-literal">()</span> = <span class="hljs-type">Stdlib</span>.exit (<span class="hljs-type">Cmd</span>.eval cmd)</code></pre><p>Lets break down the <code>bin/main.ml</code> file to understand its components and the utilities of the <code>Cmdline</code> library used here.</p><p>After imports, we first define all the arguments as variables. The arguments for our program are defined using <strong>Cmdliner.Arg</strong> module.<br>In this program we defined 4 arguments.</p><ol><li><p>search_term (positional argument): - The term (word) to search for in the file.</p></li><li><p>file_name (positional argument): - The file in which the term is to be searched.</p></li><li><p>consider_order (flag): - Ensures that the order of characters in the search term is considered.</p></li><li><p>case_sensitive (flag): - Enables case-sensitive search.</p></li></ol><p><strong>Explanation of the Cmdliner library utilities used here:</strong> -</p><p><strong>Arg</strong>: This module provides functions for defining command-line arguments, including their types, descriptions, and help messages.</p><ul><li><p><code>Arg.required</code>: This function defines a required argument (makes the argument mandatory).</p></li><li><p><code>Arg.pos</code>: This function specifies the position of an argument in the command-line syntax. So, for example, <code>pos 0</code> will make the argument the first positional argument.</p></li><li><p><code>Arg.info</code>: This function provides a docstring and other metadata for an argument.</p></li><li><p><code>Arg.value</code>: This function defines the value of an argument. The documentation says, - <code>(value a) is a term that evaluates to a's value</code>.</p></li><li><p><code>Arg.flag</code>: This function defines a flag argument that may appear <em>at most</em> once on the command line. The argument holds <code>true</code> if the flag is present on the command line and <code>false</code> otherwise.</p></li><li><p><code>Arg.some</code>: This function wraps the argument value in an <code>Option</code> type.</p></li><li><p><code>Arg.(&amp;)</code>: This is an infix operator which performs a right associative composition operation, which simply means <code>Arg.(&amp;)</code> enables composition of the combinators of a command-line argument by connecting individual components (arguments type, default value, parsing logic and docs) in a declarative way.</p></li></ul><p>After imports we defined the core command logic. The whole command logic is encapsulated in the run function.</p><p>The <code>run</code> function calls the <code>search_in_file</code> function from the <strong>Search</strong> library. Prints the matching lines using <code>print_matches</code> function. Exits with code <strong>1</strong> if no matches are found, else exit code <strong>0</strong>.</p><p>Next, we define the command in the <code>cmd</code> variable.</p><p>And finally, there is the main entry point of our program where it starts its execution from. That is -</p><pre><code class="lang-ocaml"><span class="hljs-keyword">let</span> <span class="hljs-literal">()</span> = <span class="hljs-type">Stdlib</span>.exit (<span class="hljs-type">Cmd</span>.eval cmd)</code></pre><p>Here, the <code>cmd</code> command gets evaluated and then exits the program with the return code from run.</p><p><strong>Explanation of all the Cmdliner library utilities used here:</strong> -</p><p><strong>Cmd</strong>: This module is the core of Cmdliner. It provides functions to define the commands, specify their options and arguments, and handle argument parsing, grouping and usage messages.</p><ul><li><p><code>Cmd.info</code>: This function creates a command description, including its name, version, and helptexts (a docstring explaining its purpose).</p></li><li><p><code>Cmd.v</code>: This function creates a fully functional command combining the provided info and terms.</p></li><li><p><code>Cmd.eval</code>: This function evaluates the given command, parses arguments, and executes the corresponding logic.</p></li></ul><p><strong>Term</strong>: This module deals with creating and manipulating command-line terms (arguments and subcommands).</p><ul><li><p><code>Term.const</code>: This function creates a term that evaluates to a constant value. In the given code, it's used to create terms for the <code>run</code> function and its arguments.</p></li><li><p><code>Term.($)</code> - An infix operator that combines terms to pass arguments to a function (eventually the command to run from terminal).</p></li></ul><p>So, you finally understood the <code>Cmdline</code> library.</p><p>Now its time to build and run our project to see if this works or not.</p><h1>Building &amp; Running the Project</h1><p>Without waiting, let's build and run it!</p><h2>Building the Project</h2><ul><li><p>Open your terminal and navigate to the root directory of your project (where <code>dune-project</code> is located).</p></li><li><p>Run the following command to build the program:</p><pre><code class="lang-apache">  <span class="hljs-attribute">dune</span> build</code></pre></li></ul><p>This command will use the dune files to compile the source code in <code>lib/search.ml</code> and <code>bin/main.ml</code> and create an executable named <code>textsearch</code> in the <code>_build/install/default/bin/</code> directory.</p><p>Now, you can run the executable by this command -</p><pre><code class="lang-bash">dune <span class="hljs-built_in">exec</span> -- textsearch -c -o &lt;term&gt; <span class="hljs-string">"path/to/file/to/search/in"</span></code></pre><p>Here, <code>&lt;term&gt;</code> is the term you want to search in the file.</p><p>Replace "path/to/file/to/search/in" with the actual path of the file you want to search the term in.</p><p><code>-c</code> is the optional flag for case-sensitivity,</p><p><code>-o</code> is the optional flag for respecting order of characters.</p><p>For example, I use vim and have the vim config file <code>.vimrc</code> located in the <code>$HOME</code> directory of my system.</p><p>I want to search my name in the file if its there. I would run -</p><pre><code class="lang-bash">dune <span class="hljs-built_in">exec</span> -- textsearch -c -o Debajyati ~/.vimrc</code></pre><p>And the program would print the matching lines in the console.</p><p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1735309890159/34559be3-7997-4bd3-a1af-48ba533085c0.png" alt="output of the command I've run" class="image--center mx-auto"></p><p>Tadaaa! And it works pretty well and smooth! Neat!</p><p>Congratulations! üéâ You now have a functional CLI tool built with OCaml and Cmdliner!</p><h1>Ending</h1><p>I would really appreciate your feedback on this tutorial. How would you rate it? How can I improve it?</p><p>If you found this project or tutorial helpful, please consider starring the repository below. It will encourage me to create more content like this.</p><div class="embed-wrapper"><div class="embed-loading"><div class="loadingRow"></div><div class="loadingRow"></div></div><a href="https://github.com/Debajyati/textsearch" class="embed-card">https://github.com/Debajyati/textsearch</a></div><p> </p><p>If you found this POST helpful, if this blog added some value to your time and energy, please show some love by giving the article some likes and share it with your developer friends.</p><p>Feel free to connect with me at - <a href="https://twitter.com/ddebajyati" target="_blank"><strong>Twitter</strong></a>, <a href="https://www.linkedin.com/in/debajyati-dey" target="_blank"><strong>LinkedIn</strong></a> or <a href="https://github.com/Debajyati" target="_blank"><strong>GitHub</strong></a> :)</p><p>Happy Coding üßëüèΩüíªüë©üèΩüíª! Have a nice day ahead! üöÄ</p>]]&gt;
