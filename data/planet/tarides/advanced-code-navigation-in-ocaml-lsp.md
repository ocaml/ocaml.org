---
title: Advanced Code Navigation in OCaml-LSP
description: Explore advanced code navigation in OCaml with the latest OCaml-LSP updates.
  Discover features, tips, and best practices to boost your productivity.
url: https://tarides.com/blog/2024-11-20-advanced-code-navigation-in-ocaml-lsp
date: 2024-11-20T00:00:00-00:00
preview_image: https://tarides.com/blog/images/merlin-jump-cover-1360w.webp
authors:
- Tarides
source:
---

<h2>1. Introduction</h2>
<p>The <a href="https://microsoft.github.io/language-server-protocol/">Language Server Protocol (LSP)</a> defines a standardised protocol that facilitates communication between an editor (client) and a language server. It is developed by Microsoft and was designed to simplify the process of adding language support to different code editors by abstracting away the most common implementation details of the programming language.</p>
<p>OCaml-LSP, which relies on Merlin's amazing engine, is an implementation of the LSP protocol for the OCaml programming language.</p>
<h2>2. Code Navigation in LSP</h2>
<p>When it comes to navigating through code, the LSP protocol provides four ways to do this:</p>
<ul>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_declaration">Goto Declaration Request</a>: Resolves the declaration location of a symbol.</li>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_definition">Goto Definition Request</a>: Resolves the definition location of a symbol.</li>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_typeDefinition">Goto Type Definition Request</a>: Resolves the type definition location of a symbol.</li>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_implementation">Goto Implementation Request</a>: Resolves the implementation location of a symbol. Not supported in <code>ocaml-lsp</code>.</li>
</ul>
<p>While these goto requests provide general navigation for most programming languages, it falls short when dealing with complex syntax such as OCaml's modules, functors, etc., and being able to navigate to specific sections.</p>
<h2>3. Code Navigation in Merlin</h2>
<p>Merlin offers a range of commands that allow precise code navigation, including the ability to jump to specific constructs like functions, module definitions, and match cases. As earlier seen, generalised navigation in LSP is insufficient for precise movements. To solve this, Merlin introduces a specialised <a href="https://github.com/ocaml/merlin/blob/main/doc/dev/PROTOCOL.md#jump--target-string--position-position">Jump command</a> that allows users to jump to specific targets within their OCaml code.</p>
<p>The key targets include:</p>
<ul>
<li><code>fun</code>: Jumps to a function definition.</li>
<li><code>let</code>: Jumps to a let binding.</li>
<li><code>module</code>: Jumps to a module.</li>
<li><code>module-type</code>: Jumps to a module type definition.</li>
<li><code>match</code>: Jumps to a match construct.
<ul>
<li><code>match-next-case</code>: Jumps to the next case in a match statement.</li>
<li><code>match-prev-case</code>: Jumps to the previous case in a match statement.</li>
</ul>
</li>
</ul>
<h2>4. Custom Requests in LSP</h2>
<p>When standard LSP requests are insufficient, we have the possibility of writing custom requests to implement the functionality we want. The downside to this approach is that we lose native support in the various editors or clients and will also have to write the resulting client implementations for each custom request. Implementing precise navigation in OCaml-LSP using Merlin's Jump is a typical use for a custom request.</p>
<p>For this implementation, our focus was on being able to use the requests already available on LSP and use them in non-typical, innovative ways. With this in mind, our solution works by using a <code>CodeAction</code> in combination with a <code>ShowDocument</code> request to move the cursor to our desired position.</p>
<h2>5. Implementing Merlin's Jump in OCaml-LSP</h2>
<p>Code action requests are used to execute commands for a given text document and range. These commands are typically used to change the state of a document, such as code fixes and beautifying or refactoring code. In general, we use code actions to perform quick edits in code. It's a bit unusual to think of code actions as a navigation tool, but with some smart workarounds, we can indeed use code actions to move through code.
Here's how the feature works:</p>
<ul>
<li>
<p><strong>a) Document Detection</strong>: When a source file is opened in the editor, the OCaml-LSP server checks if it is an OCaml file supported by Merlin. If the document is incompatible, the "Jump to Target" functionality is not provided.</p>
</li>
<li>
<p><strong>b) Client Capability Check</strong>: The LSP allows servers to query what features a client (the editor) supports. For "Jump to Target" to work, the server checks if the client supports the <code>ShowDocument</code> capability, which is necessary to move the cursor to the correct location.</p>
</li>
<li>
<p><strong>c) Generating CodeActions</strong>: The client begins by sending a request for all valid code actions:</p>
</li>
</ul>
<pre><code><span class="ocaml-source">[</span><span class="ocaml-constant-language-capital-identifier">Trace</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">06</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">21</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">32</span><span class="ocaml-source">]</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-capital-identifier">Sending</span><span class="ocaml-source"> </span><span class="ocaml-source">request</span><span class="ocaml-source"> </span><span class="ocaml-storage-type">'textDocument</span><span class="ocaml-keyword-operator">/</span><span class="ocaml-source">codeAction</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-numeric-decimal-integer">71</span><span class="ocaml-source">)</span><span class="ocaml-source">'</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-source">
</span><span class="ocaml-constant-language-capital-identifier">Params</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">textDocument</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">uri</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">file:///.../test.ml</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">range</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">start</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">5</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">12</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">end</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">5</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">12</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">context</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">diagnostics</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-list">[]</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">triggerKind</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">}</span><span class="ocaml-source">
</span></code></pre>
<p>The server receives this request, and for each target (fun, let, match, module, etc.), it asynchronously queries Merlin's Jump command. It assembles the possible jumps into a list of code actions and returns this list back to the client.</p>
<pre><code><span class="ocaml-source">[</span><span class="ocaml-constant-language-capital-identifier">Trace</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">06</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">21</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">32</span><span class="ocaml-source">]</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-capital-identifier">Received</span><span class="ocaml-source"> </span><span class="ocaml-source">response</span><span class="ocaml-source"> </span><span class="ocaml-storage-type">'textDocument</span><span class="ocaml-keyword-operator">/</span><span class="ocaml-source">codeAction</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-numeric-decimal-integer">71</span><span class="ocaml-source">)</span><span class="ocaml-source">' </span><span class="ocaml-keyword-other">in</span><span class="ocaml-source"> 7ms</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-source">
</span><span class="ocaml-constant-language-capital-identifier">Result</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">[</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">command</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">arguments</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">[</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">file:///.../test.ml</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">                    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">end</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">                        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">                    </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">start</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">                        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">                    </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-source">]</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">command</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">ocamllsp/merlin-jump-to-target</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">title</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">Let jump</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">kind</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">merlin-jump-let</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">title</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">Let jump</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">]</span><span class="ocaml-source">
</span></code></pre>
<p>Given that code actions are a standard LSP functionality, we benefit from an already existing pool of client implementations, so the clients display the codeactions returned by the server without any coding or customisation.
Each CodeAction includes a:</p>
<ul>
<li>
<p><em>Title</em> (e.g., "Jump to function").</p>
</li>
<li>
<p><em>Command</em> (ocamllsp/merlin-jump-to-target): A command that is executed when the code action is selected.</p>
</li>
<li>
<p><em>Kind</em>: This parameter distinguishes various code actions and can be used to group similar code actions or differentiate them especially for use with keybindings.</p>
</li>
<li>
<p><strong>d) Executing CodeAction Commands</strong>: When a user clicks or selects a specific code action, the command associated with that code action is executed.
The client sends an <code>executeCommand</code> request to the server.</p>
</li>
</ul>
<pre><code><span class="ocaml-source">[</span><span class="ocaml-constant-language-capital-identifier">Trace</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">06</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">37</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">10</span><span class="ocaml-source">]</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-capital-identifier">Sending</span><span class="ocaml-source"> </span><span class="ocaml-source">request</span><span class="ocaml-source"> </span><span class="ocaml-storage-type">'workspace</span><span class="ocaml-keyword-operator">/</span><span class="ocaml-source">executeCommand</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-numeric-decimal-integer">73</span><span class="ocaml-source">)</span><span class="ocaml-source">'</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-source">
</span><span class="ocaml-constant-language-capital-identifier">Params</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">command</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">ocamllsp/merlin-jump-to-target</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">arguments</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">[</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">file:///.../test.ml</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">end</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">start</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">                </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">]</span><span class="ocaml-source">
</span><span class="ocaml-source">}</span><span class="ocaml-source">
</span></code></pre>
<p>This <code>executeCommand</code> request triggers the server to ask the client to perform a <code>showDocument</code> request using the document URI and location range received from the code action.</p>
<pre><code><span class="ocaml-source">[</span><span class="ocaml-constant-language-capital-identifier">Trace</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">06</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">37</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-constant-numeric-decimal-integer">10</span><span class="ocaml-source">]</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-capital-identifier">Received</span><span class="ocaml-source"> </span><span class="ocaml-source">request</span><span class="ocaml-source"> </span><span class="ocaml-storage-type">'window</span><span class="ocaml-keyword-operator">/</span><span class="ocaml-source">showDocument</span><span class="ocaml-source"> </span><span class="ocaml-keyword-operator">-</span><span class="ocaml-source"> </span><span class="ocaml-source">(</span><span class="ocaml-constant-numeric-decimal-integer">6</span><span class="ocaml-source">)</span><span class="ocaml-source">'</span><span class="ocaml-keyword-other-ocaml punctuation-other-period punctuation-separator">.</span><span class="ocaml-source">
</span><span class="ocaml-constant-language-capital-identifier">Params</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">selection</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">end</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">start</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-source">{</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">character</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">2</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">            </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">line</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-numeric-decimal-integer">9</span><span class="ocaml-source">
</span><span class="ocaml-source">        </span><span class="ocaml-source">}</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-source">}</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">takeFocus</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-constant-language-boolean">true</span><span class="ocaml-keyword-other-ocaml punctuation-comma punctuation-separator">,</span><span class="ocaml-source">
</span><span class="ocaml-source">    </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">uri</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-keyword-other-ocaml punctuation-other-colon punctuation">:</span><span class="ocaml-source"> </span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-string-quoted-double">file:///.../test.ml</span><span class="ocaml-string-quoted-double">"</span><span class="ocaml-source">
</span><span class="ocaml-source">}</span><span class="ocaml-source">
</span></code></pre>
<p>Both <code>executeCommand</code> and <code>showDocument</code> are standard LSP requests, meaning all clients that already have LSP support can automatically perform this jump.</p>
<ul>
<li><strong>e) Error Handling</strong>: In cases where Merlin fails to find a valid target (e.g., the target does not exist or the position is invalid), the server gracefully handles the error by omitting the specific code action for that particular target, ensuring a smooth user experience.</li>
</ul>
<h2>6. Feature Demonstration</h2>
<p>Below is a demonstration showing the various code actions which perform navigation.</p>
<p><img src="https://tarides.com/blog/images/merlin-jump~3HRsyh_aCuRziN8_3Uil4g.gif" alt="Merlin Jump code actions"></p>
<h2>7. Conclusion</h2>
<p>Set for release in early December 2024, Merlin's Jump functionality in OCaml-LSP brings precision navigation into the LSP world, enhancing OCaml code navigation capabilities across various editors. By using a combination of existing LSP requests, the feature is implemented in a way that is client-agnostic and fully compatible with LSP, ensuring a smooth and efficient user experience for developers working with OCaml.</p>
<p>For developers working on large or complex OCaml projects, this precise navigation capability will significantly streamline workflows, enabling quick and direct navigation to relevant parts of their code.</p>
<p>While implementing Merlin's Jump as a code action offers a broad client-agnostic solution, there are several drawbacks to this approach. First, it can clutter the code action lists, making them noisy for users who are used to a more streamlined selection. Since code actions are typically used for refactoring or fixing issues, adding navigation-related actions here is not an expected usage of code actions. Additionally, binding these navigation actions to shortcuts becomes harder, as code actions do not naturally lend themselves to precise key bindings for navigation.</p>
<p>To overcome these limitations, one potential solution is to use a custom LSP request, which would allow navigation functionality without overloading the code action list. We have a an <a href="https://github.com/ocaml/ocaml-lsp/pull/1374">open PR</a> on <code>ocaml-lsp</code> repository which introduces this custom request. Alternatively, a client-side tool like <code>tree-sitter</code> could be used to parse the code and generate the necessary jump targets directly in the client, offering a more flexible and efficient solution tailored to the user's editor setup.</p>
<h2>8. Resources</h2>
<ul>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#window_showDocument">LSP Protocol - ShowDocument Request</a></li>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_executeCommand">LSP Protocol - ExecuteCommand Request</a></li>
<li><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_codeAction">LSP Protocol - CodeActions Request</a></li>
<li><a href="https://github.com/ocaml/merlin/issues">Issue Tacker - Merlin</a></li>
<li><a href="https://github.com/ocaml/ocaml-lsp/issues">Issue Tacker - OCaml-LSP</a></li>
</ul>

