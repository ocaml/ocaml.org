---
title: Irmin in the Browser
description: "Introduction Over the past six months, I have been working on using
  Irmin in the browser, including irmin-server and the GraphQL interface\u2026"
url: https://tarides.com/blog/2022-08-02-irmin-in-the-browser
date: 2022-08-02T00:00:00-00:00
preview_image: https://tarides.com/static/2878361a6dba26b0fa43b0b048f42cd4/10057/joy_img.jpg
featured:
---


<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#introduction" aria-label="introduction permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>Over the past six months, I have been working on using Irmin in the browser, including <code>irmin-server</code> and the GraphQL interface. This has been fun and a great learning journey for me. Before this internship, <code>irmin-server</code> was primarily a Unix-based application. My project was to port <code>irmin-server</code> to work in the browser and design interfaces for people to interact with the store (Irmin stores).</p>
<p>I was paired to work with Patrick Ferris as my mentor and with the entire Irmin team, who all contributed immensely to this project.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#irmin-and-irmin-server" aria-label="irmin and irmin server permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Irmin and <code>irmin-server</code></h2>
<p>Irmin is simply a data store (database). It is based on the same design principle as Git with features to merge and branch data stores. Irmin has several stores (<code>irmin-mem</code>, <code>irmin-indexeddb</code>, <code>irmin-fs</code>, <code>irmin-chunk</code>, <code>irmin-git</code>) and store interfaces (<code>irmin-http</code>, <code>irmin-graphql</code>).</p>
<p><code>irmin-server</code> is a high-performance server for Irmin. For efficient communication, it implements a specialised <a href="https://github.com/mirage/irmin-server/blob/master/PROTOCOL.md">wire-protocol</a> to send and receive data over a bytestream. It wraps an Irmin store, providing a way to connect to the server and access the store via its API using a client. But the client makes an assumption that the user is on a Unix machine, which makes <code>irmin-server</code> primarily a Unix-based application.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#irminirmin-client-in-the-browser" aria-label="irminirmin client in the browser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>irmin/irmin-client</code> in the Browser</h2>
<p>In this modern age, it's become a necessity to make applications &quot;offline first.&quot; Offline-First applications function without being affected by the intermittent lack of a network connection. It usually implies the ability to sync data between multiple devices. Irmin as a data store supports multiple backends, making it very portable. Plus, Irmin's mergeable replicated data-types make it much easier to build applications that can transform the state offline and resynchronise the state later, just like Git. With this concept, resynchronising Irmin stores (from server to client) is much simpler on <code>irmin-server</code>, which implements a specialised wire protocol for efficient communication. Making <code>irmin/irmin-client</code> work in the browser simply means that it would be possible to create offline-first web applications.</p>
<p>More information on offline-first applications can be found <a href="https://2022.ecoop.org/home/plf-2022">here</a></p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-problems" aria-label="the problems permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Problems</h2>
<p>An initial summary of the problem was published on this <a href="https://github.com/mirage/irmin-server/issues/46">issue</a>, but here is a quick breakdown of the problems we identified.</p>
<ol>
<li><strong><code>irmin-server</code> was tightly coupled around <code>conduit-lwt-unix</code>:</strong> <code>irmin-server</code> was initially designed to be a Unix-based application that established communication with a client via <code>conduit-lwt-unix</code>. This became a problem because <code>conduit-lwt-unix</code> cannot establish a communication from a browser. This meant that there was a need to abstract the I/O module so that every client will provide its I/O.</li>
<li><strong>Reuse some internal modules:</strong> We needed to reuse the <code>irmin-server</code> internal logic related to the protocol but provide a portable I/O interface that can work in the browser.</li>
<li><strong>Provide a browser communication channel:</strong> We needed a non-blocking way to establish a channel to create communication between <code>irmin-server</code> and the browser, and also pass data across this channel.</li>
</ol>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-solutions" aria-label="the solutions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Solutions</h2>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#irmin-server-was-tightly-coupled-around-conduit-lwt-unix" aria-label="irmin server was tightly coupled around conduit lwt unix permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>irmin-server</code> was tightly coupled around <code>conduit-lwt-unix</code></h3>
<p>Thanks to Zach Shipko, who abstracted the I/O library and split out <code>irmin-client-unix</code> and <code>irmin-client-cli</code> to have their own I/O module that depends on <code>conduit-lwt-unix</code> (<a href="https://github.com/mirage/irmin-server/pull/32">here</a>), a client can connect to a running <code>irmin-server</code> using its own I/O module. While he was working on the restructuring, I spent my time working on a sample project that combines <code>dream</code> with <code>irmin-graphql</code> (more on this project).</p>
<p>With the coupling out of the way, the next step was to create <code>irmin-client-jsoo</code>, a browser client with its own I/O module.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#irmin-server-was-primarily-a-unix-based-application" aria-label="irmin server was primarily a unix based application permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>irmin-server</code> was primarily a Unix-based application</h3>
<p>The <code>irmin-server</code> initial architecture had to be restructured to accommodate other platforms. To achieve this, <code>irmin-client</code> was no longer coupled with a specific I/O implementation. Rather, a Unix-based one was provided over conduit flows, which are <code>Lwt_io</code> input and output channels. This channel was established over a TCP connection or a Unix domain socket.</p>
<p>Right now, <code>irmin-server</code> can communicate with two (2) clients: <code>irmin-client-cli</code> from a command line and <code>irmin-client-unix</code> from a Unix-based machine. This project was about creating a third client: <code>irmin-client-jsoo</code>, to be called from browser applications.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#enable-communication-from-the-browser" aria-label="enable communication from the browser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enable communication from the browser</h3>
<p>After considering other options to create a communication channel for <code>irmin-client-jsoo</code>, like HTTP, RPC, etc., Patrick suggested WebSocket, so we decided to go with WebSocket, a bidirectional communication protocol between client and server.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#the-challenges" aria-label="the challenges permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Challenges</h4>
<p><code>irmin-server</code> uses flows to communicate between the server and the client and flows are bytestreams. WebSocket provides a bidirectional communication channel in the browser, but it is not stream-oriented rather it is message-oriented.</p>
<p>TCP (Transmission Control Protocol) is a type of protocol or standard to transfer information over the Internet while WebSocket is a message-oriented application protocol, which uses TCP as the transportation layer.</p>
<p>The idea behind the WebSocket protocol consists of reusing the established TCP connection between a client and server. Even though WebSocket is built on TCP, the data it passes is always either sent as a whole &quot;message&quot; or not at all. These implementations are non-blocking.</p>
<p>Since we are avoiding a full redesign of the <code>irmin-server</code> protocol, we had to make the message-oriented process seem like bytestreams of data.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#more-on-irmin-client-jsoo" aria-label="more on irmin client jsoo permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>More on <code>irmin-client-jsoo</code></h2>
<p>Communicating with <code>irmin-server</code> from the browser is very easy. You can achieve that by following these steps:</p>
<ol>
<li>Pin <code>irmin-server</code>, using this command: <code>opam pin add git+https://github.com/mirage/irmin-server/commit#013a28fd1507f8ba69494515533119804903aa99</code></li>
<li>Set up the server.</li>
</ol>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">open Lwt.Syntax
module Store = Irmin_mem.KV.Make (Irmin.Contents.String)
module Server = Irmin_server.Make (Store)

let main =
  let uri = Uri.of_string &quot;ws://localhost:9090/ws&quot; in
  let config = Irmin_git.config &quot;penit&quot; in
  let* store = Store.Repo.v config in
  let* main = Store.main store in
  let* server = Server.v ~uri config in
  let () = Format.printf &quot;Listening on %a@.&quot; Uri.pp uri in
  Server.serve server

let () = Lwt_main.run main</code></pre></div>
<p><a href="https://github.com/dinakajoy/pen-it-down/blob/main/server/server.ml">Check out this implementation</a></p>
<ol start="3">
<li>Create the client and ping the server.</li>
</ol>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">module Store = Irmin_mem.KV.Make (Irmin.Contents.String)
module Client = Irmin_client_jsoo.Make (Store)

let config = Irmin_client_jsoo.config (Uri.of_string &quot;ws://localhost:9090/ws&quot;)
let client = Client.Repo.v config in
Client.ping client</code></pre></div>
<p>More examples can be found on <a href="https://github.com/mirage/irmin-server/tree/master/examples">here</a></p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#my-projects" aria-label="my projects permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>My Projects</h2>
<p><strong>Simple Mini GitHub:</strong>
I worked on this project to experiment with combining <code>irmin-graphql</code> with <code>dream</code>. This turned out simpler than I thought. You only need to expose <code>irmin-graphql</code> schema. In this application, you simply enter a GitHub repository, and the repository details such as name, date, author, commit message, and README file will be displayed. You can also open <code>/graphiql</code> and make queries.</p>
<p>The full code can be accessed <a href="https://github.com/dinakajoy/simple_mini_github">here</a>.</p>
<p><strong>Pen-It-Down:</strong>
Pen-it-down is a note app that uses <code>irmin-indexeddb</code> and <code>irmin-server</code> to show an offline-first functionality. Users can type in their notes without being bothered about internet connectivity. You can create, edit, delete, and sync your notes to the server.</p>
<p>The full code can be accessed <a href="https://github.com/dinakajoy/pen-it-down">here</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>Working on this project was challenging! I am so glad I had the opportunity to work on it, even though there were days I felt lost. Some days I was confused because it seemed I was doing the wrong thing. Other days I was happy because things worked as expected! It&rsquo;s basically been about research and experimenting for me. I learned a lot from Patrick and Zach. I was exposed to networking concepts like the network layers, client-server handshake, data encryption, and decryption, and I got to try out WebSocket for the first time. I look forward to building more projects with OCaml.</p>
