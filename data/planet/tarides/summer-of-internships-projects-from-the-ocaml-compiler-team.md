---
title: 'Summer of Internships: Projects From the OCaml Compiler Team'
description: "We have had the pleasure of hosting several interns in the compiler
  team this past year. Their projects have tackled varied and challenging\u2026"
url: https://tarides.com/blog/2024-09-24-summer-of-internships-projects-from-the-ocaml-compiler-team
date: 2024-09-24T00:00:00-00:00
preview_image: https://tarides.com/static/513afe441c908c744458da8f54c1049d/0132d/rowers-team.jpg
authors:
- Tarides
source:
---

<p>We have had the pleasure of hosting several interns in the compiler team this past year. Their projects have tackled varied and challenging tasks touching on different aspects of compiler development, ranging from modularising the observability tool Olly to creating eBPF-based kernel-side performance monitoring, improving polyglot package management, and lifting limitations of the Ortac tool that helps developers test Gospel specifications for OCaml.</p>
<p>Let's take a look at what the interns have been up to over the past six months. Remember, if you want to intern with us, keep an eye on our <a href="https://tarides.com/careers/">careers page</a> for upcoming opportunities!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#eutro-and-olly" aria-label="eutro and olly permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eutro and Olly</h2>
<p><a href="https://github.com/eutro">@eutro's</a> internship focussed on making the observability tool <a href="https://github.com/tarides/runtime_events_tools">Olly</a> more useful for developers by addressing two shortcomings: an incompatibility between Olly and the Runtime Events API that would cause crashes in certain cases, and the number of Olly's dependencies which made it difficult or impossible to use its core functions with unreleased ("trunk") OCaml (or at all on Windows). To resolve these issues, @eutro modularised Olly, implementing a table-based translation of runtime event names and tags.</p>
<p>@eutro modularised Olly by refactoring the binary into smaller libraries, with the awkward dependencies isolated into an optional library. Splitting up the libraries gives users greater control over their dependencies and you can <a href="https://github.com/tarides/runtime_events_tools/pull/43">learn more about modularisation in the PR</a>.</p>
<p>The second part of the internship focussed on the table-based translation of runtime event names and tags to allow different versions of OCaml to consume runtime events. The goal was to avoid two bugs that arose when Olly profiles a program compiled with a different version of OCaml, <code>olly trace</code> generating nonsensical names for the slices and <code>olly gc-stats</code> silently generating garbage output. To delve into the details, check out <a href="https://github.com/tarides/runtime_events_tools/pull/44">@eutro's PR about runtime event names</a>.</p>
<p>Lastly, @eutro managed to squeeze in some bug-fixes as well!  One PR addresses the <a href="https://github.com/ocaml/ocaml/pull/13089">incorrect use of <code>snprintf_os</code> in formatting the runtime events ring file path</a> and another that <a href="https://github.com/ocaml/ocaml/pull/13091">fixes some memory bugs in <code>runtime_events_consumer.c</code></a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#lee-koon-wen-and-eio" aria-label="lee koon wen and eio permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lee Koon Wen and Eio</h2>
<p>The <a href="https://github.com/ocaml-multicore/eio">Eio library</a> enables users to write high-performance I/O programs leveraging the new effects system that came with OCaml 5. The I/O library pairs well with the io_uring interface on Linux as a rule; however, the asynchronous nature of <code>io_uring</code> can make it hard for the developer to get a grasp on the performance of their Eio programs when they are bottlenecked by something within the kernel rather than the program itself.</p>
<p>The Linux kernel has a mature and extensive system for gathering data on its performance. In his internship project, <a href="https://github.com/koonwen">Lee Koon Wen's</a> task was to produce a library that used the <a href="https://ebpf.io/what-is-ebpf/">Linux eBPF</a> probes to gather kernel-side data on an Eio program's <code>io_uring</code> use and deliver them to the program's runtime events. This would let users analyse kernel-side performance data alongside their program's performance using an observability tool like <a href="https://github.com/tarides/runtime_events_tools">Olly</a>.</p>
<p>Two projects have sprung from this work, <a href="https://github.com/koonwen/uring-trace?tab=readme-ov-file"><code>uring-trace</code></a> and <a href="https://github.com/koonwen/ocaml-libbpf"><code>ocaml-libbpf</code></a>. The former is a tracer that, using bindings provided by the latter, can extract events from a Linux kernel. These traces can then be generated in <a href="https://fuchsia.dev/fuchsia-src/reference/tracing/trace-format">Fuschia</a> format and displayed on <a href="https://ui.perfetto.dev/">Perfetto</a>. This project will benefit developers on the Linux platform, helping them understand and optimise their programs using accurate data.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#ryan-and-polyglot-package-management" aria-label="ryan and polyglot package management permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ryan and Polyglot Package Management</h2>
<p>Using several programming languages in one project lets you take advantage of the particular strengths of each language and of its library ecosystem. For example, <a href="https://www.python.org/">Python</a> is well-known for its data science libraries, <a href="https://www.rust-lang.org/">Rust</a> for its ownership memory model, and <a href="https://ocaml.org/">OCaml</a> for its type safety. Over the past couple of decades, many large programming language ecosystems (and even some smaller ones) have acquired language-specific package managers, e.g. <code>pip</code> (Python's; 2008), <code>cargo</code> (Rust's; 2015 - although it started with one) and, of course, <code>opam</code> (OCaml's; 2013). Managing these so-called 'polyglot programming' projects, with several languages working together, relies on coordinating these package managers to provide language libraries and toolchains like compilers and build systems. The need to use multiple package managers naturally increases the complexity of these projects. Additionally, dependencies are hard, or impossible, to express across different package managers.</p>
<p><a href="https://github.com/RyanGibb">Ryan Gibb's</a> research internship at Tarides focussed on using nix as an initial bridge towards these objectives, extending <a href="https://opam.ocaml.org/"><code>opam</code></a> to support the provision of "external dependencies" using <a href="https://nixos.org/">Nix</a>, the language-agnostic functional package manager, instead of the OS's own package manager. There has been much work in this area already (e.g. <a href="https://github.com/tweag/opam-nix">opam-nix</a> and <a href="https://github.com/timbertson/opam2nix">opam2nix</a>), but these have focussed more on being able to take <code>opam</code> packages themselves and install them <em>using</em> nix.</p>
<p>Ryan's work moves in the other direction, allowing Nix packages to be used within the environment set-up by opam, by adding a <code>depext</code> mechanism to <code>opam</code>. Parallel with this work, Ryan also extended a previous investigation with <code>nixpkgs</code> to allow users to be able to specify versions of Nix dependencies. In general, Nix only supports the latest versions, but by analysing <code>nixpkgs</code> repository history we can map the versions of the packages we’re interested in to the ranges in <code>nixpkgs</code> commit history which provide them. Using <code>opam</code>’s solver we can then find the maximum commit of <code>nixpkgs</code> satisfying the version constraints on the packages (as long as a state exists meeting the conditions).</p>
<p>Future work will address current limitations and bring improvements to the workflow for users. For example, <code>opam</code>’s Nix <code>depext</code> mechanism picks up the environment variables from the builder's shell, meaning it must manually specify the environment it wants to extract. It may be possible to access the <code>env</code> attribute of derivations directly as the Nix binary does. Ryan intends to keep working on these limitations as well as future goals, including shepherding Opam's Nix <code>depext</code> support through review and possibly productionising <code>opam-nix-repository</code> for use in <code>opam-repository.</code></p>
<p>For more information, check out the project's PRs, <a href="https://github.com/ocaml/opam/pull/5982">#5982</a> and <a href="https://github.com/RyanGibb/opam/pull/2">#2</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#nikolaus-gospel-and-ortac" aria-label="nikolaus gospel and ortac permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Nikolaus, Gospel and Ortac</h2>
<p>The culture around OCaml values safety and reliability, so it is no surprise that a suite of tools has been developed to ensure these qualities. One such tool, <a href="https://ocaml-gospel.github.io/gospel/">Gospel</a>, is a contract-based behavioural specification language that can provide a logical model for OCaml types and describe the intended behaviour of functions using pre- and post-conditions. <a href="https://github.com/ocaml-gospel/ortac/tree/main">Ortac</a>, in turn, is a tool that can generate a <a href="https://ocaml-multicore.github.io/multicoretests/">QCheck-STM</a> test suite based on the Gospel specification of a library. You can find out more about them in the dedicated post <a href="https://tarides.com/blog/2024-09-03-getting-specific-announcing-the-gospel-and-ortac-projects/">Getting Specific: Announcing the Gospel and Ortac Projects</a>.</p>
<p>The goal of <a href="https://github.com/nikolaushuber">Nikolaus Huber's</a> internship was to lift some of the limitations of Ortac and QCheck-STM to expand its use cases for developers. It's essential to increase the types of tests that users can generate so that more OCaml code can be checked using Gospel. His project has produced three PRs, <a href="https://github.com/ocaml-gospel/ortac/pull/235">#235</a> which centres on allowing tests to run without system under test in the signature, <a href="https://github.com/ocaml-gospel/ortac/pull/237">#237</a> focusses on adding support for tests with tuples in their signature, and <a href="https://github.com/ocaml-gospel/ortac/pull/247">#247</a> aiming to introduce support for testing functions with multiple systems under test as arguments.</p>
<p>In addition to the PRs addressing Ortac limitations, Nikolaus has also fixed several issues regarding Gospel and Ortac. He <a href="https://github.com/ocaml-gospel/ortac/pull/234">added a new error</a> for when there are no commands produced during the translation from Gospel to OCaml,  <a href="https://github.com/ocaml-gospel/ortac/pull/240">fixed a bug within the QCheck-STM</a> that occurred when testing functions that return integers, and <a href="https://github.com/ocaml-gospel/ortac/pull/245">addressed another bug where a type check would incorrectly indicate that code was correct</a>. All in all, Nikolaus' project benefits developers who want to test their OCaml programs to ensure they perform predictably and correctly.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#stay-in-touch" aria-label="stay in touch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stay in Touch</h2>
<p>We want to hear from you! Follow us on <a href="https://twitter.com/tarides_">X</a>, <a href="https://mastodon.social/@tarides">Mastodon</a>, <a href="https://www.threads.net/@taridesltd">Threads</a>, and <a href="https://www.linkedin.com/company/tarides">LinkedIn</a> for the latest news from Tarides and to share your thoughts with us. Are you interested in completing an internship project with us? Keep an eye on <a href="https://tarides.com/careers/">our careers page</a>, where we announce upcoming internship opportunities. Happy hacking!</p>
<blockquote>
<p>Tarides champions open-source development. We create and maintain key features of the OCaml language in collaboration with the OCaml community. To learn more about how you can support our open-source work, discover our <a href="https://github.com/sponsors/tarides">page on GitHub</a>.</p>
</blockquote>
<blockquote>
<p>We are always happy to discuss commercial opportunities around OCaml. We provide core services, including training, tailor-made tools, and secure solutions. <a href="https://tarides.com/contact/">Contact us today</a> to learn more about how Tarides can help your teams realise their vision.</p>
</blockquote>
