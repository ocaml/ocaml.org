---
title: 'Irmin on MirageOS: Introducing the Notafs File System'
description: Announcing a new filesystem for MirageOS projects, designed to be used
  on satellites with SpaceOS, that also lets developers use Irmin with MirageOS!
url: https://tarides.com/blog/2024-11-27-irmin-on-mirageos-introducing-the-notafs-file-system
date: 2024-11-27T00:00:00-00:00
preview_image: https://tarides.com/blog/images/notafs-1-1360w.webp
authors:
- Tarides
source:
---

<p>We are pleased to announce one (or two) new filesystems for MirageOS! The motivation behind creating them is an exciting new use case requiring the system to store data on disk.</p>
<p><a href="https://mirage.io/docs/overview-of-mirage">MirageOS</a> allows you to compile OCaml applications into unikernels. By selecting the operating system functionalities required, a unikernel can be constructed for your application using only the necessary components. This process reduces the attack surface and increases the hardware efficiency of your final application. MirageOS unikernels can be deployed to various cloud and mobile platforms.</p>
<p>As a case in point, Tarides is developing <a href="https://tarides.com/blog/2023-07-31-ocaml-in-space-welcome-spaceos/">SpaceOS</a> to run unikernels on satellites, an industry where both security and performance are critical. While MirageOS has a long history of cloud usage and comes with advanced network capabilities, SpaceOS provides an interesting use case for disk storage. A possible use case for satellites is to take pictures from space and send them to Earth for analysis, and since satellites may not be able to send the pictures right away (due to their location, for example), storing high-resolution images on a disk is a must.</p>
<p>So, naturally, the question we posed ourselves was what MirageOS file system could we use for SpaceOS? And that started us down the journey to the new file system Notafs, that even lets you use Irmin on top!</p>
<h2>Why Create a New Filesystem?</h2>
<p>At the start, there were a couple of existing filesystems available for MirageOS that we needed to evaluate:</p>
<ul>
<li>The <a href="https://github.com/yomimono/chamelon">Chamelon</a> filesystem is designed to efficiently support a large number of very small files on a disk.</li>
<li>The <a href="https://github.com/dinosaure/docteur">Docteur</a> filesystem which provides read-only file compression.</li>
<li>The <a href="https://github.com/mirage/ocaml-fat/tree/main">FAT</a> filesystem, which provides support for the (old) standard <a href="https://en.wikipedia.org/wiki/File_Allocation_Table">FAT16</a> filesystem with restrictions on file sizes.</li>
<li>The <a href="https://github.com/mirage/ocaml-tar">TAR</a> file format, which has the limitation that users can only add new files: deletion or modification of existing files is not supported.</li>
</ul>
<p>All of the above libraries are well-tested and highly recommended if they fit your application needs! But, as we will illustrate in part 2 with our benchmarks, none of these systems satisfied the SpaceOS requirement to store large files.</p>
<p>Furthermore, using a conventional file system like the ones available on traditional operating systems like Linux and Windows was also not an option since they are closely tied to large operating system functionalities. This is because to ensure higher security, MirageOS libraries are built using the <a href="https://ocaml.org">OCaml programming language</a>, which provides <a href="https://tarides.com/blog/2023-12-14-ocaml-memory-safety-and-beyond/">strong memory-safety guarantees</a>. While this is a fantastic design choice for the <a href="https://tarides.com/blog/2024-03-07-a-time-for-change-our-response-to-the-white-house-cybersecurity-press-release/">future of computing</a>, it is harder to support a conventional filesystem (programmed in C/C++) natively on MirageOS. A unikernel based on that kind of technology would lose the appeal of a small software stack with high-security guarantees. In comparison, the Notafs solution fits into four thousand lines, which is a much more ‘human-sized’ project to review.</p>
<h2>The Challenges With Filesystems</h2>
<p>Implementing a filesystem is a complex task requiring compromises, which explains the lack of options for storing large files with the SpaceOS project. For example, even though file systems may appear simple, with an interface that everyone is familiar with, their critical main function is to protect applications from (recoverable) hardware defects. Unless the disk dies, the user should never lose or see corrupted data, even if a power outage was to interrupt the filesystem in the middle of an operation. In other words, a filesystem update should have transactional semantics: either the operation succeeds, or it does not, but applications should never observe an in-between broken state. Without this property, software built on top of the file system would be vulnerable to experiencing faults.</p>
<p>Tarides is well aware of the challenges involved with implementing a filesystem – we maintain the <a href="https://irmin.org">Irmin database</a>, which provides a hierarchical key-value store with high data consistency guarantees, git-inspired history for rollbacks, and distributed replication over the network. While the Irmin API resembles a filesystem, it is a full-blown database and provides many more functionalities. So rather than starting a new filesystem implementation from scratch, we asked ourselves whether we could reuse the Irmin database as a filesystem for MirageOS.</p>
<h2>Irmin as a Filesystem?</h2>
<p>Using Irmin for this purpose is not a new idea, and Irmin already provides multiple backends that allow users to run its databases on various platforms with different constraints. The <code>irmin-pack</code> backend was of particular interest for MirageOS support. We have spent years optimising its performance since this backend is notably used to <a href="https://tarides.com/blog/2022-04-26-lightning-fast-with-irmin-tezos-storage-is-6x-faster-with-1000-tps-surpassed/">store the Tezos blockchain</a>, and it enables the freeing of disk space by <a href="https://tarides.com/blog/2023-05-05-optimising-archive-node-storage-for-tezos/">truncating the database history to get rid of unnecessary old backups</a>.</p>
<p>Finally, the low-level implementation of <code>irmin-pack</code> is especially suited for a port to MirageOS, as it only requires support for a few large (append-only) files from the operating system.</p>
<p>This last technical requirement was especially relevant to the SpaceOS use case, where the satellite needs to be able to store high-resolution pictures on disk. If our custom-made file system supported large files, then we would be able to support SpaceOS and enable the general-purpose use of Irmin for MirageOS unikernels. This realisation still left us with the task of developing the foundations of a file system, but even just the bare functionalities would satisfy our use cases.</p>
<h2>Notafs is Born</h2>
<p>We called this new file system ‘Notafs’, which, as the name suggests, is not a general-purpose file system due to its focus on handling a few large files. It is designed to handle a small number of large files for Mirage block devices. It can, however, be used to run the <code>irmin-pack</code> backend, which gives users all the benefits of an Irmin filesystem for MirageOS. Together, running <code>irmin-pack</code> on Notafs lifts the limitations of the latter, and supports many file names, is optimised for small and large files, and includes a git-like history with branching and merging <a href="https://irmin.org/">just to name a few features</a>!</p>
<p>Navigating design restrictions is an excellent way to focus the efforts of a project. In our case, that meant directing them towards the correctness and performance of the few selected operations of <code>Notafs</code>. We didn’t need to implement advanced filesystem operations since missing functionalities could be provided by <code>irmin-pack</code>, including optimised management of many small files. As long as our underlying file system could provide fast operations on large files, the rest was taken care of!</p>
<p>From a unikernel developer’s perspective, <code>Notafs</code> provides an implementation of the <a href="https://ocaml.org/p/mirage-kv/latest/doc/Mirage_kv/index.html"><code>Mirage_kv</code></a> interfaces. This is the standard API for filesystem usage on MirageOS, so any existing unikernel can use it without needing to change its application code. We also provide a <a href="https://github.com/tarides/notafs?tab=readme-ov-file#notafs-cli">command-line interface</a> to simplify the formatting of disks and to allow for external inspection of file system contents of the unikernel. Check out this example of a <a href="https://github.com/tarides/notafs/tree/master/unikernel-kv">minimal setup of Notafs in MirageOS</a>.</p>
<p>While Notafs has restricted functionalities, it provides a nice developer experience and a useful alternative in the file system design space for MirageOS. We are especially proud of the safety guarantees that Notafs provides for your data stored on disk.</p>
<h2>Using Irmin on Notafs</h2>
<p>To enable users to run Irmin on MirageOS, we provide an implementation of the syscalls required by the <code>irmin-pack</code> backend on top of Notafs. This was straightforward as Notafs provides the functionalities required to run <code>irmin-pack</code>. Thanks to <a href="https://dev.realworldocaml.org/functors.html">OCaml functors</a>, the <code>irmin-pack</code> codebase was already structured for alternative syscall implementations.</p>
<p>One OCaml subtlety we encountered was handling asynchronous I/O: MirageOS and Notafs use the <code>Lwt</code> monad, while the Irmin syscalls expected a direct-style I/O implementation. This would have been an issue in the past, but we could bridge that gap using the <a href="https://ocaml.org/manual/5.2/effects.html">effect handlers that came with OCaml 5</a>. Note that OCaml 5 support is still experimental on MirageOS at the time of writing!</p>
<p>From a user perspective, using Irmin addresses the design limitations of Notafs (while keeping its desirable consistency properties) by adding efficient support for managing a large number of small files. Irmin is a much more general-purpose file system; on top of that, a user can build a unikernel application with many additional features. We’re hopeful that applications already using Irmin will consider this new bridge for targeting MirageOS unikernels.</p>
<h2>Until Next Time!</h2>
<p>Thank you for checking out the first part of this two-part series where we’ve introduced Notafs, the motivation behind the file system, the challenges, and its use cases. Look out for part two where we delve into the details behind Notafs’ design alongside benchmarks and visualisations of the file system in action.</p>
<p>Connect with us online on <a href="https://twitter.com/tarides_">X</a>, <a href="https://mastodon.social/@tarides">Mastodon</a>, <a href="https://www.threads.net/@taridesltd">Threads</a>, and <a href="https://www.linkedin.com/company/tarides">LinkedIn</a> to stay updated on our latest projects. We also invite you to consult the <a href="https://github.com/tarides/notafs">open-source Notafs repository</a> for more information or to test out the file system yourself!</p>

