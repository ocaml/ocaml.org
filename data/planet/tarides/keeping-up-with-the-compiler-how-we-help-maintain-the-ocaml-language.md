---
title: 'Keeping Up With the Compiler: How we Help Maintain the OCaml Language'
description: "Not all of our projects have a definite end: a grand culmination of
  effort and time where we pop champagne and set off fireworks (which is\u2026"
url: https://tarides.com/blog/2024-06-19-keeping-up-with-the-compiler-how-we-help-maintain-the-ocaml-language
date: 2024-06-19T00:00:00-00:00
preview_image: https://tarides.com/static/8ec96e439c32fa8aca635373a2f53e00/2070e/maintenance.jpg
authors:
- Tarides
source:
---

<p>Not all of our projects have a definite end: a grand culmination of effort and time where we pop champagne and set off fireworks (which is, of course, how we celebrate most of the time). Indeed, providing ongoing support for the OCaml ecosystem is one of our biggest priorities, and it means that we resolve issues, maintain libraries, and improve features continuously over time.</p>
<p>Providing high-quality maintenance may not be glamorous, but it is crucial work that keeps the OCaml compiler running smoothly and efficiently. No matter how well-designed an individual feature is, if it does not receive regular maintenance, it risks going out of sync with all the other features. Since the compiler is made up of many interrelated parts, sustained and targeted maintenance of its individual parts, as well as their interactions, is crucial to ensure stability and robustness.</p>
<p>Read on to learn about the process behind ensuring the long-term quality of the compiler and discover what our team has achieved so far!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#how-do-we-maintain-the-compiler" aria-label="how do we maintain the compiler permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How do we Maintain the Compiler?</h2>
<p>Many teams, companies, and community members collaborate on the development and maintenance of the OCaml compiler. We are just one group among many, and aligning our work with the goals and needs of the ecosystem at large is essential. Our team members generally focus on areas where they have expertise and can be most helpful, including multicore support, Windows compatibility, and build system enhancements. Their skills range from compiler front-end development (including the PPX and type system) to the runtime, from signal handling to the garbage collector.</p>
<p>We work closely with researchers at <a href="https://www.inria.fr/fr">Inria</a>, who created OCaml and continue to significantly contribute to its development and maintenance, to discuss existing issues and goals. Core maintainers and other contributors to OCaml hold triaging meetings every two weeks, led by Florian Angeletti at Inria, where they review recent issues and pull requests made <a href="https://github.com/ocaml/ocaml/issues">to the OCaml repository</a>. Each question, bug, or contribution is assigned to a developer responsible for ensuring it is addressed. This is a collaborative process between maintainers across organisations and companies. Several existing core maintainers are also Tarides staff members, and we support their work as part of our internal compiler maintenance effort. More and more Tarides engineers are becoming OCaml core maintainers, with the rights and responsibilities that come along with it, as the community recognises the high quality of their contributions.</p>
<p>Tarides encourages all of our compiler developers to allocate time towards maintenance. This helps us disseminate knowledge more evenly around the teams and ensures continuous attention is put towards improvements, fixes, and optimisations.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#identifying-key-areas-of-effective-long-term-maintenance" aria-label="identifying key areas of effective long term maintenance permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Identifying Key Areas of Effective Long-Term Maintenance</h2>
<p>The best way to maintain a project is to target areas of strategic importance while remaining flexible and responding to issues as they arise. Our goal is to ensure that the maintenance of OCaml is effective in the long run, and to accomplish this, we focus on areas where we have considerable expertise and on fostering growing community involvement.</p>
<ul>
<li><strong>Long-Term Improvements:</strong></li>
</ul>
<p>Maintenance work on the compiler does not just mean fixing small issues as they come up but includes long-term work towards key features. For example, OCaml 5 introduced a <a href="https://ocaml.org/manual/5.2/memorymodel.html">relaxed memory model</a> that provides strong guarantees for programs that have data races. While the recommendation is prescriptive, OCaml, having started out as a sequential language, does not always enforce the memory model correctly. When such divergences (bugs) are identified, Tarides maintainers aim to identify the expected behaviour based on the prescriptive definition of the memory model and enforce it. In addition, we work on projects that make the build system simpler and hence more maintainable, that increase portability across various platforms (which was reduced in the move from OCaml 4 to OCaml 5), and <a href="https://tarides.com/blog/2024-05-22-launching-the-first-class-windows-project/">improve the user experience on Windows</a>.</p>
<ul>
<li><strong>Automated Quality Assurance:</strong></li>
</ul>
<p>Part of guaranteeing the long-term stability of the compiler happens through the Continuous Integration (CI) process. Contributions to the OCaml compiler are subject to rounds of testing to ensure that their code behaves predictably. The first round runs on <a href="https://github.com/marketplace/actions/build-and-test-with-ghcr-io-kxcinc-ocaml-general">GitHub actions</a> and is completed before a contribution is even accepted into the compiler. Only contributions that pass these tests can be accepted. The second round is significantly more exhaustive (and therefore requires much more computing power to execute) and is performed on PRs with a <code>needs-precheck</code> label. This round of testing uses the <a href="https://ci.inria.fr/hwloc/">Jenkins-CI</a> hosted by Inria. Jenkins-CI has a lot more backends than GitHub Actions and is used to check changes that may affect backend code.</p>
<p>In addition to the above-mentioned rounds of CI, <a href="https://tarides.com/blog/2024-04-24-under-the-hood-developing-multicore-property-based-tests-for-ocaml-5/">multicore tests</a> are frequently performed on the compiler as part of the team's workflow, enabling them to catch and fix some hard-to-spot bugs, <a href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/">including data races</a>. As a case in point, developers are using multicore tests alongside their ongoing efforts to restore MSVC support to OCaml 5.3 in order to ensure that changes do not introduce unwanted behaviours into the code.</p>
<ul>
<li><strong>Community:</strong></li>
</ul>
<p>When all is said and done, the OCaml compiler exists for the language's wider open-source community, so encouraging community engagement and feedback is vital. We prioritise clear documentation and open discussion in the public repositories to allow everyone to weigh in. We also organise regular compiler hacking events where we invite people into our offices (in 2023, we hosted people in <a href="https://tarides.com/blog/2023-03-22-compiler-hacking-in-cambridge-is-back/">Cambridge</a> and in <a href="https://tarides.com/blog/2023-11-09-ocaml-hacking-day-in-chennai/">Chennai</a>) to discuss, hack, and hang out. Our hacking days have sparked significant contributions to the compiler and brought new contributors on board. These initiatives are designed to facilitate open communication, share progress, and involve the community in the ongoing development of the OCaml compiler &ndash; thereby fostering alignment with community interests.</p>
<p>The compiler team's effort, in collaboration with other ecosystem members, provides a core service to the OCaml community. Together, we improve and maintain fundamental parts of the OCaml compiler with high levels of oversight, safety, and transparency.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#compiler-maintenance-fixes" aria-label="compiler maintenance fixes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiler Maintenance Fixes</h2>
<p>Here is a short list illustrating the range of issues, big and small, that the compiler engineers at Tarides address as part of compiler maintenance. This list is far from exhaustive and instead aims to give an overview of the kinds of tasks that we undertake:</p>
<ul>
<li><a href="https://github.com/ocaml/flexdll/pull/114">Fixing Bugs in MSVC on Windows</a></li>
</ul>
<p>Our compiler team not only introduces features and resolves problems relevant to Tarides but also addresses issues raised by different members of the OCaml community. This task includes reviewing external PRs and helping to keep the OCaml compiler maintained and up-to-date. <a href="https://github.com/dra27">David Allsopp</a> reviewed this PR, which fixed a bug happening when a 32-bit MSVC ran on Windows, and the CI script accidentally ran 32-bit Cygwin.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/12213">Improving Error Messaging</a></li>
</ul>
<p>Improving the OCaml user experience involves making error messages easier to understand and, therefore, also falls under the goals of the compiler team. More accessible error messages make the language easier for beginners to use and learn. In this PR, <a href="https://github.com/shym">Samuel Hym</a> made a <code>symlink</code> error message that appeared when users tried to link non-existent files much easier to understand.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/11594">Updated <code>framepointers</code> Tests to Avoid False Positives With Inlined C Functions</a></li>
</ul>
<p>This pull request addressed a problem where the <a href="https://gcc.gnu.org">Gnu Compiler Collection</a> C compiler would inline some C function backtraces and not others. <a href="https://github.com/fabbing">Fabrice Buoro</a> updated the <code>ocaml_program</code> frame-pointer backtrace to ignore differences in the case of inconsistent inlining decisions made by the C compiler. In addition, <code>caml_program</code> now does all of the previous 'backtrace post-processing' locally to the C code, eliminating the <code>awk</code>, <code>sh</code>, and <code>sed</code> dependencies.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/12383">Improve Backtrace Abstractions Inside the Runtime</a></li>
</ul>
<p>Part of the compiler team's work is also to prepare the compiler for future features. <a href="https://github.com/NickBarnes">Nick Barnes</a> has been working on bringing <code>statmemprof</code> support to OCaml 5 and preparing the trunk runtime to be compatible with <code>statmemprof</code>; he has improved its backtrace abstractions in this PR. Previously, the OCaml backtrace API allowed backtraces to be obtained as a single per-domain buffer or as an object on the OCaml heap. However, <code>statmemprof</code> needs to be able to use the current backtrace at arbitrary allocation points when Caml heap allocation might not be possible. Nick's PR changed the <code>backtrace.h</code> abstraction by adding <code>caml_get_callstack()</code>.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/12768">Improvements to <code>$ocaml_cv_cc_vendor</code> in Configure</a></li>
</ul>
<p>With this PR, <a href="https://github.com/MisterDA">Antonin D&eacute;cimo</a> improved the detection of the C compiler on Windows, replacing the use of <code>$cc_basename</code> with <code>$ocaml_cv_cc_vendor</code>. This change helps users detect when <code>mingw-w64</code>  and <code>clang-cl</code> are used, fixes TSan detection on macOS, and removes uses of <code>$cc_basename</code>. A bonus of this change is that improved detection improves the quality of bug reports since users can report which C compiler they use when they experience a bug.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/13207">Fixing a Hard-to-Reproduce Bug</a></li>
</ul>
<p>Some bugs can be far-reaching but hard to identify and reproduce (where developers try to re-create the condition under which the bug manifests). These cases call for a lot of patience and meticulousness on behalf of the programmer trying to solve it. In PR <a href="https://github.com/ocaml/ocaml/pull/13207">#13207</a> <a href="https://github.com/dustanddreams">Miod Vallat</a> worked on a bug identified by <a href="https://github.com/polytypic">Vesa Karvonen</a> that affected all 64-bit architectures apart from <code>amd64</code>. The bug could only be reproduced when the system was calling C code that reached back to OCaml code, and that OCaml code had had to grow its stack, and upon return from the invoked C code, there was an exception pending. In OCaml 5, as opposed to in OCaml 4, growing the OCaml stack changes the value of the exception pointer. Thus, the cached pointer was now pointing to the old stack - an issue fixed by ensuring that the register storing the cached exception pointer is refreshed upon return.</p>
<ul>
<li><a href="https://github.com/ocaml/ocaml/pull/12707">Resolving a Complicated Bug in the Debug Runtime</a></li>
</ul>
<p>Finally, a decent chunk of the team's tasks requires a lot of investigative skills! Some bugs are so hard to define and understand that our engineers must act as detectives, piecing together a larger picture from hard-won clues. This is what <a href="https://github.com/jmid">Jan Midtgaard</a> did to understand the cause of a rare race condition in the debug runtime. It's essential to allow the problem-solving process to take the time it requires and not try to rush it. Complex problems require a patient and methodical approach, and we have set up the compiler maintenance project to manage these essential tasks.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#sharing-the-load" aria-label="sharing the load permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sharing the Load</h2>
<p>Aside from the fixes contributed by the team, Tarides also contributes significantly to reviewing issues and pull requests. For example, of the 273 PRs that went into the OCaml 5.2.0 release, Tarides was significantly involved in approximately 160. That number includes several of our feature PRs, yes, and tens of fixes (some mentioned above), but our team also reviewed about 40% of non-Tarides contributions, making up the remaining 183. Among the many areas of OCaml maintenance, ensuring that issues and PRs are addressed is of significant importance for the project's sustainability, and Tarides is proud to do its part.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#stay-in-touch" aria-label="stay in touch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stay in Touch!</h2>
<p>Tarides supports many critical projects and parts of the OCaml ecosystem, as we believe long-term maintenance is vital to improving and strengthening the language over time. We're lucky to collaborate with people and organisations passionate about the language, and we invite you to <a href="https://github.com/ocaml/ocaml/blob/b02f003ad335ec086614d6c99346067abac5784e/CONTRIBUTING.md">contribute your own expertise to the repo</a> and join the discussions on the <a href="https://discuss.ocaml.org/">OCaml Discuss Forum</a>.</p>
<p>Follow us on <a href="https://www.linkedin.com/company/tarides">LinkedIn</a> and <a href="https://twitter.com/tarides_">X</a> (formerly known as Twitter) for the latest news from Tarides. You can also <a href="https://tarides.com/contact/">contact us</a> directly on our website if you have questions or want more information about our projects and how you can benefit from them.</p>
