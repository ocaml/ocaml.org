---
title: 'The OCaml 5.2 Release: Features and Fixes!'
description: "There has been a new release of OCaml! The 5.2 release brings several
  new features, along with improvements, optimisations, and bug fixes\u2026"
url: https://tarides.com/blog/2024-05-15-the-ocaml-5-2-release-features-and-fixes
date: 2024-05-15T00:00:00-00:00
preview_image: https://tarides.com/static/b5f991adf6571187a3269d086d32f31c/0132d/camel-eclipse.jpg
authors:
- Tarides
source:
---

<p>There has been a new release of OCaml! The 5.2 release brings several new features, along with improvements, optimisations, and bug fixes. New features include compaction, ThreadSanitizer, and restored support for compiling to the POWER architeture on OCaml, plus other crucial changes that prepare the ground for future updates.</p>
<p>This post highlights new and restored features and gives you a good overview of the release. We won&rsquo;t cover everything, however, so if you&rsquo;re looking for an exhaustive list I recommend that you read the <a href="https://github.com/ocaml/ocaml/blob/5.2/Changes">Changes document</a> on GitHub. Let&rsquo;s get started!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#compaction" aria-label="compaction permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compaction</h2>
<p>The 5.2 release reintroduces compaction to OCaml 5.*. Compaction is a technique where blocks of memory are reordered to be adjacent to each other, releasing the fragmented free spaces  between them in the pools back to the allocator.  In 5.2, the compaction process needs to be multicore compatible, so a parallel compactor is added for the shared pools that make up the GC&rsquo;s major heap.</p>
<p>This work is part of the ongoing effort to achieve feature parity between OCaml 5.* and OCaml 4.14, and providing users with familiar favourites from previous iterations of the language. The bulk of the compaction work can be found in <a href="https://github.com/ocaml/ocaml/pull/12193">PR #12193</a>, which details how the compaction algorithm works and how the pools of memory are released back to the OS. <a href="https://github.com/sadiqj">Sadiq Jaffer</a> and <a href="https://github.com/NickBarnes">Nick Barnes'</a> impressive efforts, alongside reviews and input from the wider OCaml community, have brought compaction back to OCaml.</p>
<p>There have also been two additional pull requests, <a href="https://github.com/ocaml/ocaml/pull/12859">#12859</a> and <a href="https://github.com/ocaml/ocaml/pull/12850">#12850</a>, which update and fine-tune the commands for compaction to be more accurate and useful. <a href="https://github.com/ocaml/ocaml/pull/12850">#12850</a> adds <code>caml_collect_stats_sample_stw</code> to the major heap cycling stop-the-world (STW) meaning that <code>Gc.quick_stat</code> reflects the state of the heap after a major cycle or compaction accurately. <a href="https://github.com/ocaml/ocaml/pull/12859">#12859</a> ensures that <code>Gc.compact</code> completes a full major cycle before compacting (in contrast to <code>Gc.quick_compact</code> which only performs a single one).</p>
<p>Look out for a post on compaction coming to our blog soon!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#threadsanitizer-support" aria-label="threadsanitizer support permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ThreadSanitizer Support</h2>
<p><a href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer</a> (or TSan) is a tool originally developed by Google that can detect data races that occur during a program's execution. Data races can happen in parallel programs and easily go undetected. Developers can use TSan to monitor their programs, flagging data races so that they can be eliminated before the program is released. Since OCaml 5 brings multicore capabilities to the language, adding support for a reliable way to detect data races has been a top priority.</p>
<p>In the 5.2 release, the big PR <a href="https://github.com/ocaml/ocaml/pull/12114">#12114</a> adds TSan support and introduces a new configure-time flag <code>--enable-tsan</code> to enable compilation with TSan instrumentation. When enabled, the OCaml compiler instruments your executables with calls to TSan's runtime, which keeps a record of previous memory accesses (at a cost to performance). Executables instrumented with TSan will report data races without false positives. The original TSan PR added support for Linux on the x86_64 architecture, and since then the community has added support for all actively maintained tier 1 platforms.</p>
<p>PRs <a href="https://github.com/ocaml/ocaml/pull/12876">#12876</a>, <a href="https://github.com/ocaml/ocaml/pull/12809">#12809</a>, <a href="https://github.com/ocaml/ocaml/pull/12810">#12810</a>, <a href="https://github.com/ocaml/ocaml/pull/12907">#12907</a>, and <a href="https://github.com/ocaml/ocaml/pull/12915">#12915</a>, all extend the TSan support to further platforms including FreeBSD on x86_64, Linux and macOS on arm64, and Linux on RISC-V, POWER, and s390x. PRs <a href="https://github.com/ocaml/ocaml/pull/12681">#12681</a> and <a href="https://github.com/ocaml/ocaml/pull/12746">#12746</a> fix false positives and tidy up some annotations, and PR <a href="https://github.com/ocaml/ocaml/pull/12802">#12802</a> adds a chapter on TSan to the OCaml reference manual. We applaud the hard work of <a href="https://github.com/OlivierNicole">Olivier Nicole</a>, <a href="https://github.com/fabbing">Fabrice Buoro</a>, and <a href="https://github.com/dustanddreams">Miod Vallat</a> (based on initial efforts by <a href="https://github.com/anmolsahoo25">Anmol Sahoo</a>) to bring TSan to OCaml, with feedback and input from <a href="https://github.com/jhjourdan">Jacques-Henri Jourdan</a>, <a href="https://github.com/maranget">Luc Maranget</a>, <a href="https://github.com/shindere">S&eacute;bastien Hinderer</a>, <a href="https://github.com/art-w">Arthur Wendling</a>, <a href="https://github.com/gadmm">Guillaume Munch-Maccagnoni</a>, and more!</p>
<p>If you would like to learn more about TSan, you can <a href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/">check out our blog post on the tool</a>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#tsan-in-action" aria-label="tsan in action permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TSan in Action</h3>
<p>As part of the work on this update, <a href="https://github.com/gasche">Gabriel Scherer</a>, <a href="https://github.com/eutro">Eutro</a>, <a href="https://github.com/OlivierNicole">Olivier Nicole</a>, <a href="https://github.com/fabbing">Fabrice Buoro</a>, and others have been able to use TSan to catch and fix data race bugs in different parts of the OCaml runtime. A direct benefit of TSan support is the number of data race fixes that this update brings to users, which include:</p>
<ul>
<li><strong>Fix for a Race in the Minor GC:</strong> PRs <a href="https://github.com/ocaml/ocaml/pull/12595">#12595</a> and <a href="https://github.com/ocaml/ocaml/pull/12597">#12597</a> describe a race condition occurring when <code>caml_collect_gc_stats_sample</code> makes calls to <code>domain_terminate</code>, and #12597 outlines the fix implemented in 5.2.</li>
<li><strong>Data Race Between Marking and Sweeping:</strong> PR <a href="https://github.com/ocaml/ocaml/pull/12934">#12934</a> fix a <a href="https://github.com/ocaml/ocaml/issues/12916">reported race between marking and sweeping</a> caught by TSan.</li>
<li><strong>Data Race on Global Pools Arrays:</strong> <a href="https://github.com/ocaml/ocaml/pull/12755">PR #12755</a> addresses races on <code>global_avail_pools</code> and <code>global_full_pools</code> members of the <code>struct pool_freelist</code> in <code>shared_heap.c</code>.</li>
<li><strong>Data Races in <code>minor_gc.c</code>:</strong> This <a href="https://github.com/ocaml/ocaml/pull/12737">PR #12737</a> fixes two races, one in the minor GC occurring when promoting the values that are in the remembered set, and one in <code>caml_natdynlink_open</code>.</li>
<li><strong>Data Race fix for #12799:</strong> PR <a href="https://github.com/ocaml/ocaml/pull/12851">#12851</a> fixes a bug described in issue <a href="https://github.com/ocaml/ocaml/issues/12799">#12799</a> where runtime events teardown and event emission could race each other.</li>
<li><strong>Data Race When Using the Debug Runtime:</strong> PR <a href="https://github.com/ocaml/ocaml/pull/12969">#12969</a> resolves a data race involving <code>caml_scan_stack</code> and <code>caml_free_stack</code>.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#user-experience" aria-label="user experience permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User Experience</h2>
<p>Improving user experience is a high priority and iterative changes are made regularly to make OCaml easier for developers to use, with a special focus on newcomers. Each new release therefore brings quality-of-life improvements alongside the bigger features. In 5.2, examples of these user experience improvements include:</p>
<ul>
<li><strong>Improve Dynlink Error Messages:</strong> In PR <a href="https://github.com/ocaml/ocaml/pull/12213">#12213</a>, <a href="https://github.com/shym">Samuel Hym</a> addresses some complexities in the Dynlink library making certain error messages hard to parse. Changes to the way the errors are wrapped means that they are now simplified and easier to understand.</li>
<li><strong>New Chapter in the Manual:</strong> <a href="https://github.com/OlivierNicole">Olivier Nicole's</a> PR <a href="https://github.com/ocaml/ocaml/pull/12840">#12840</a> adds a new chapter on custom events to the OCaml reference manual. Improved documentation is key to help newcomers get the most out of OCaml, and help developers adopt new tools.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#power-backend-restored" aria-label="power backend restored permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>POWER Backend Restored</h2>
<p>In PR <a href="https://github.com/ocaml/ocaml/pull/12276">#12276</a> <a href="https://github.com/xavierleroy">Xavier Leroy</a> restores native-code support for the POWER/PowerPC backend, specifically for the 64 bit little endian architecture. In a subsequent <a href="https://github.com/ocaml/ocaml/pull/12667">PR #12667</a> <a href="https://github.com/awilfox">A. Wilcox</a> extends the support to include 64 bit big endian as well. Leroy's <a href="https://github.com/ocaml/ocaml/pull/12601">PR #12601</a> highlights some of the fine-tuning that took place to transition between OCaml 4.* and 5.*, specifically to implement the leaf functions in a way that would work better for the 64 bit architecture.</p>
<p>The <a href="https://en.wikipedia.org/wiki/IBM_Power_Systems#:~:text=IBM%20Power%20Systems%20is%20a,and%20System%20i%20product%20lines.">IBM POWER processor family</a>, including PowerPC, is used in servers, supercomputers, embedded systems, and even on personal computers. Historically, OCaml has supported the POWER processors, and restoring this support lets users take advantage of post 5.* features on it as well.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#bug-fixes" aria-label="bug fixes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bug Fixes</h2>
<p>There are literally dozens and dozens of bug fixes included with this release, and I can&rsquo;t mention them all here, but let&rsquo;s take a look at a few:</p>
<ul>
<li><strong>Fixing a Segmentation Fault:</strong> In PR <a href="https://github.com/ocaml/ocaml/pull/12726">#12726</a> <a href="https://github.com/nojb">Nicolas Ojeda B&auml;r</a> addresses a segmentation fault that happens when <code>ocamlrun.exe</code> is not found in the PATH.</li>
<li><strong>Locking Bugs:</strong> In PR <a href="https://github.com/ocaml/ocaml/issues/12897">#12897</a> <a href="https://github.com/talex5">Thomas Leonard</a> identifies a locking bug that affects custom events tracing, where the program <code>runtime_events</code> stops indefinitely without being able to proceed.  <a href="https://github.com/gasche">Gabriel Scherer</a> introduces a fix in the form of a mutex in PR <a href="https://github.com/ocaml/ocaml/pull/12900">#12900</a>.</li>
<li><strong><code>Threads</code> Crash:</strong> The <code>threads</code> library contained a bug that could cause a crash, where users could not update <code>Caml_state&ndash;&gt;backtrace_last_exn</code> using direct assignment. Doing so caused the program to crash. In PR <a href="https://github.com/ocaml/ocaml/pull/12861">#12861</a> <a href="https://github.com/mshinwell">Mark Shinwell</a> identified and fixed the bug.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#preparing-for-upcoming-features" aria-label="preparing for upcoming features permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preparing for Upcoming Features</h2>
<p>Part of the contributions to each release focus on preparing the way for future features. 5.2 lays the foundation for some long-anticipated additions including:</p>
<ul>
<li><strong>Project-Wide Occurrences:</strong> <a href="https://github.com/voodoos">Ulysse G&eacute;rard's</a> PR <a href="https://github.com/ocaml/ocaml/pull/12508">#12508</a> provides the required steps to support <code>project-wide-occurrences</code> in OCaml projects, a feature that many <a href="https://github.com/ocaml/merlin">Merlin</a> users in particular have been waiting for. Work is ongoing to implement this in Merlin to enhance code navigation and refactoring. This change is possible thanks to OCaml's <a href="https://icfp22.sigplan.org/details/mlfamilyworkshop-2022-papers/10/Module-Shapes-for-Modern-Tooling">Shapes</a> feature.</li>
<li><strong>Statmemprof:</strong> Statmemprof is a well-loved statistical memory profiler that was removed from OCaml before the multicore 5.0 release, due to unanswered questions about how it would perform. Significant efforts have gone into bringing <code>statmemprof</code> back, and 5.2 prepares the way in two PRs. PR <a href="https://github.com/ocaml/ocaml/issues/11911">#11911</a> features much of the initial conversation and collaboration to bring the feature back, and <a href="https://github.com/NickBarnes">Nick Barnes's</a> <a href="https://github.com/ocaml/ocaml/pull/12381">#12381</a> PR changes part of the memory profiler&rsquo;s API to prepare it for multicore. This feature is expected to be included in 5.3 this autumn.</li>
<li><strong>MSVC:</strong> MSVC is Microsoft's C/C++ compiler and users can compile OCaml 4.14 with MSVC. However, in OCaml 5.0 the runtime uses C features that MSVC doesn't support, making it incompatible with MSVC. <a href="https://github.com/MisterDA">Antonin D&eacute;cimo's</a> PR <a href="https://github.com/ocaml/ocaml/pull/12769">#12769</a> unifies MSVC and MinGW-w64 code paths to prepare for full MSVC support for OCaml 5, also expected to be re-introduced in OCaml 5.3 later this autumn.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#whats-next" aria-label="whats next permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What&rsquo;s Next?</h2>
<p>Work on OCaml never stops! The following months will bring more bug fixes and updates to OCaml in the lead up to the 5.3 release, where popular features like MSVC support and <code>statmemprof</code> are being reintroduced. It&rsquo;s great to see contributors from many different backgrounds coming together to work on improving the OCaml language. Anyone can gain more insight into how the language is developed by exploring the public <a href="https://github.com/ocaml/ocaml">OCaml GitHub repository</a> and the official <a href="https://ocaml.org">OCaml Website</a></p>
<p>Stay in touch with us on <a href="https://twitter.com/tarides_">X</a> (formerly known as Twitter) and <a href="https://www.linkedin.com/company/tarides">LinkedIn</a> &ndash; we would love to hear about your experience with 5.2 and how you are using OCaml!</p>
