---
title: Porting OBuilder to FreeBSD
description: "OBuilder is a tool for performing arbitrary, reproduceable builds of
  OCaml-related software within a sandboxed environment. It is used by\u2026"
url: https://tarides.com/blog/2023-10-04-porting-obuilder-to-freebsd
date: 2023-10-04T00:00:00-00:00
preview_image: https://tarides.com/static/a5bcde1ae8acf18ab1586db0c6368d87/0132d/freebsd.jpg
featured:
authors:
- Tarides
source:
---
    
<p>OBuilder is a tool for performing arbitrary, reproduceable builds of OCaml-related software within a sandboxed environment. It is used by the CI team at Tarides to provide OCaml-based Continuous Integration (CI) for projects like <code>opam-repo-ci</code>, <code>ocaml-ci</code>, and <code>multicoretest-ci</code>. Originally written for Linux, OBuilder had Windows and macOS support added later. Previous blog posts have covered porting to <a href="https://tarides.com/blog/2023-08-02-obuilder-on-macos/">macOS</a> and <a href="https://tarides.com/blog/2023-07-12-ocaml-ci-renovated/">OCaml CI in general</a>.</p>
<p>Here we cover the work to add the remaining Tier-1 supported architecture for OCaml that's missing from OBuilder and FreeBSD. With this work, the CI systems maintained by the team at Tarides will be able to support FreeBSD.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-challenge" aria-label="the challenge permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Challenge</h2>
<p>Being initially Linux-centric, OBuilder is architected around three major requirements:</p>
<ul>
<li>Initial build environments are Docker images.</li>
<li>Sandboxing is performed using the Open Container Initiative (OCI) tool <code>runc</code>.</li>
<li>A filesystem with snapshot capabilities is needed and acts as a cache of
identical build steps.</li>
</ul>
<p>Neither of the first two items are available under FreeBSD (a Docker client is available, but there is no native Docker server); therefore, alternative solutions must be found. As for the filesystem requirement, FreeBSD has been supporting <a href="https://openzfs.org">Sun's ZFS filesystem</a> out of the box for many releases now. ZFS support already existed for Linux and macOS, and it is being used in the macOS port <a href="https://tarides.com/blog/2023-08-02-obuilder-on-macos/">(more details here)</a>.</p>
<p>Fortunately, the existing architecture for OBuilder encapsulates these needs as <code>Fetcher</code>, <code>Sandbox</code>, and <code>Store</code> modules, respectively, so the only work required would be to write FreeBSD-specific <code>Fetcher</code> and <code>Sandbox</code> modules.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#the-fetcher" aria-label="the fetcher permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Fetcher</h3>
<p>Initially we tried to fetch Docker images without using the <code>docker</code> command. We have an existing script, <code>download-frozen-image</code>, of this attempt in the <code>moby</code> GitHub project (the open source parts of Docker). Although if we use that script to fetch the Docker image's various layers and apply them in order, the result won't be beneficial from a FreeBSD perspective because the available Docker images are filled with Linux binaries. These can run under FreeBSD with the help of the compatibility module, but the OCaml toolchain would believe it was running under Linux, so it would build Linux binaries. This is not the solution we are looking for. Until Docker is available under FreeBSD, there won't be a repository of FreeBSD images suitable for OBuilder. Such images will, at least in the beginning, be built locally in the Tarides CI network.</p>
<p>Given this, it makes sense to expect <code>.tar.gz</code> archives to be available, then we can simply download and extract them to implement the <code>Fetcher</code> module. Moreover, FreeBSD provides its own <code>fetch</code> command, which is able to download files over <code>http</code> and <code>https</code>. It can also use <code>file://</code> URIs, which turned out to be very helpful during development. There is currently no attempt to support aliases or canonical names, so all the <code>(from ...)</code> stanzas in OBuilder command files will need to be adjusted for use with FreeBSD. This limitation can be overcome by prepopulating the OBuilder cache with the most-used images under their expected names on the OBuilder worker systems.</p>
<p>The final solution for the Fetcher on FreeBSD uses ZFS to store the base images as ZFS datasets on each machine. These get mounted into the jail with the approriate installs of OCaml, opam, and a Git clone of the <code>opam-repository</code>. We ended up with a layout of:</p>
<table>
<thead>
<tr>
<th>ZFS Volumes for FreeBSD</th>
</tr>
</thead>
<tbody>
<tr>
<td>obuilder/base-image/freebsd-ocaml-4.14</td>
</tr>
<tr>
<td>obuilder/base-image/freebsd-ocaml-5.1</td>
</tr>
</tbody>
</table>
<p>The base image name is used in the <code>(from ...)</code> stanza of the OBuilder spec files to select an OCaml version. Interestingly, we used a similar layout in the macOS OBuilder port. More details are available in the <a href="https://github.com/ocurrent/freebsd-infra">freebsd-infra ansible scripts</a>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#the-sandbox" aria-label="the sandbox permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Sandbox</h3>
<p>FreeBSD has come with its own sandboxing mechanism, named <code>jail</code>, since the late 1990s. In addition to only having access to a subset of the file system, jails can also be denied network access, which fits the OBuilder usage pattern where network access is only allowed to fetch build dependencies.</p>
<p>In order to start a jail, the <code>jail</code> command is invoked with either a plain text file providing its configuration or with the configuration parameters (in the &quot;name=value&quot; form) on its command line.</p>
<p>In order to keep things simple in OBuilder, and since the jail configuration will only need a few parameters, they are all passed on the command line. This might be a problem if the length of the run command, as specified in the OBuilder command file, reaches the FreeBSD command-line size limit. Since this limit is a few hundred kilobytes, it does not seem to be a serious concern.</p>
<p>The <code>jail</code> invocation will provide:</p>
<ul>
<li>A unique jail name</li>
<li>The absolute path of the jail filesystem</li>
<li>The command (or shell script) to run in the jail</li>
<li>The user on behalf of which the command will be run. This requires the user to exist within the jail filesystem (<code>/etc/passwd</code> and <code>/etc/group</code> entries).</li>
</ul>
<p>More options may be used to allow for network access or specify commands to run on the host or within the jail at various states of the jail lifecycle.</p>
<p>Also, for processes running under the jail to behave correctly, a stripped-down <code>devfs</code> pseudo-filesystem needs to be mounted on the <code>/dev</code> directory within the jail. While this can be done automatically by <code>jail(8)</code> using the proper <code>mount.devfs</code> option, care must be taken to correctly unmount this directory after the command run within the jail has exited. In order to be sure there will be no leftover <code>devfs</code> mounts, which would prevent removal of the jail filesystem at cleanup time, OBuilder unconditionally runs an <code>umount</code> command after the <code>jail</code> command exits.</p>
<p>Lastly, since most (if not all) OBuilder commands will expect a proper opam environment configuration, it is necessary to run the commands within a login shell. Such a shell can only be run as <code>root</code>. Therefore the command that will run within the jail is:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">  /usr/bin/su -l obuilder_user_name -c &quot;cd obuilder_directory &amp;&amp; obuilder_command&quot;</code></pre></div>
<p>The <code>jail</code>-based sandbox environment provided by FreeBSD OBuilder closely mirrors the original Linux <code>runc</code>-based implementation because it targets an operating system-level virtualisation. In both cases, we expect to see similar performance and stability from the FreeBSD port. With the <code>Fetcher</code> and the <code>Sandbox</code> modules written, a complete OBuilder run can be attempted.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#integrating-with-ocluster" aria-label="integrating with ocluster permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integrating with OCluster</h3>
<p>OCluster is a larger system that processes build requests on a cluster of servers, each running an OCluster worker that uses OBuilder as a library. In order to make the FreeBSD systems compatible with OCluster's needs, a few more adjustments are necessary. A Docker client for running health checks, a ZFS pool, and a FreeBSD base image all need to be addressed.</p>
<p>Fortunately the Docker client is available as a FreeBSD package: <code>pkg install -y docker</code> would do the trick; however, we do something even simpler and create a shell script which does nothing. OCluster worker uses this script as a healthcheck. In future, we plan to change this to target a more appropriate FreeBSD health check.</p>
<p>As we hinted at earler, FreeBSD needs to be setup with a ZFS pool on a separate disk or a separate partition. The basic idea is that OBuilder will store base images plus build-state snapshots on this pool, and it is better to keep it separate from the main system. Additionally, the usage patterns of this pool involve a huge amount of reads, writes, snapshot creations, and deletions, so it makes operational sense to isolate it and allocate it on different storage than the operating system storage.</p>
<p>The FreeBSD base images are created by building opam and OCaml from source, then initialising an opam repository from a Git clone of the <code>opam-repository</code> GitHub repo. More details are available in the <a href="https://github.com/ocurrent/freebsd-infra">freebsd-infra ansible scripts</a>. With some FreeBSD knowledge, this should allow anyone to setup an OCluster worker on FreeBSD. In future, these base images could be built on a single machine and copied between machines using <code>zfs send</code> on the source machine and <code>zfs recv</code> on the build machine.</p>
<p>Currently we have a <a href="http://infra.ocaml.org/by-use/freebsd-x86_64">single server running FreeBSD 13.2</a> providing OCaml 4.14 and 5.1 builds on x86_64. This modest Dual Xeon machine (16 cores) is easily handling the load from <code>opam-repo-ci</code>, <code>ocaml-ci</code>, and <code>opam-health-check</code>, with a peak observed throughput of 40 jobs per hour. This initial deployment has confirmed the performance and stability expectations we had.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#future-work" aria-label="future work permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Future Work</h2>
<p>Some future work that we would like to do:</p>
<ul>
<li>Optimising I/O using an in-memory OverlayFS. A similar setup on Linux has given us some impressive performance improvements.</li>
<li>Supporting FreeBSD on ARM (if there is sufficient interest in this architecture)</li>
<li>Investigate OCluster performance on FreeBSD using DTrace</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>The modular design of OBuilder has allowed for it to be easily adapted to run under FreeBSD. A few FreeBSD systems are currently being set up as OBuilder workers within the OCluster orchestrator used by Tarides for automated OCaml package testing. Support has been added to <a href="https://opam.ci.ocaml.org">opam.ci.ocaml.org</a> for checking opam packages, and <a href="https://ocaml.ci.dev">ocaml.ci.dev</a> has FreeBSD builds available for OCaml projects hosted on GitHub and GitLab. In addition, the FreeBSD-specific instance of <a href="https://freebsd.check.ci.dev">opam health check</a> is providing base-level metrics of the repository health on the now-supported platform. Numerous packages need fixing, and we encourage the community to have a look and lend the maintainers a hand.</p>
<p>Extending OBuilder's capabilities to include FreeBSD as a Tier 1 platform is a crucial step to ensure the robustness and accessibility of OCaml-related software development. By implementing FreeBSD-specific modules for the <code>Fetcher</code> and <code>Sandbox</code> components, developers will be empowered to perform reproducible builds within a sandboxed environment on FreeBSD. The inclusion of FreeBSD in the OBuilder ecosystem will contribute to the overall growth and adoption of OCaml, facilitating the development of reliable and efficient software on this platform.</p>
<p>Please <a href="https://tarides.com/contact/">get in touch with us</a> if you are interested in FreeBSD support, and tell us what architecture/version of FreeBSD you'd like to be supported. Or better yet, get involved with the <a href="https://github.com/ocurrent/overview">OCurrent</a> project! We are also active on <a href="https://discuss.ocaml.org">Discuss</a>.</p>
