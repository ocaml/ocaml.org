---
title: 'Under the Hood: Developing Multicore Property-Based Tests for OCaml 5'
description: "In 2022, Multicore OCaml became reality. Programming on multiple threads
  brings new possibilities, but also new complexities. In order to\u2026"
url: https://tarides.com/blog/2024-04-24-under-the-hood-developing-multicore-property-based-tests-for-ocaml-5
date: 2024-04-24T00:00:00-00:00
preview_image: https://tarides.com/static/8d5e62879e4d0ba9248c8e9497e61cd0/eee8e/underthehood.jpg
featured:
authors:
- Tarides
source:
---

<p>In 2022, Multicore OCaml became reality. Programming on multiple threads brings new possibilities, but also new complexities. In order to foster confidence in OCaml 5 and retain OCaml's reputation as a trustworthy and memory-safe platform, Tarides has developed <a href="https://github.com/ocaml-multicore/multicoretests"><code>multicoretests</code></a>: Two property-based testing libraries with a test suite built on top. This effort <a href="https://github.com/ocaml-multicore/multicoretests#issues">has successfully pinpointed a range of issues</a> and contributed towards a stable multicore environment for the OCaml community to build on.</p>
<p>In this article and in the upcoming part two, I describe how we developed <a href="https://github.com/ocaml-multicore/multicoretests">property-based tests</a> for OCaml 5, the challenges we encountered, and the lessons we learned. Part one will focus mainly on the two open-source testing libraries <code>STM</code> and <code>Lin</code>, including some of our findings along the way. It may be of interest to both compiler hackers and library writers who are curious about how their code behaves under parallel usage.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#unit-testing-vs-property-based-testing" aria-label="unit testing vs property based testing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Unit Testing vs. Property-Based Testing</h2>
<p>In traditional <a href="https://en.wikipedia.org/wiki/Unit_testing">unit testing</a>, a developer asserts an expected result for a given input on a case-by-case basis. For example, when calling OCaml's <code>floor : float -&gt; float</code> function with argument <code>0.5</code> we expect the result to be <code>0.</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">assert</span> <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>equal <span class="token number">0.</span> <span class="token punctuation">(</span>floor <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;;</span></code></pre></div>
<p>In general, one can imagine a range of test cases on this form:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">assert</span> <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>equal <span class="token number">0.</span> <span class="token punctuation">(</span>floor <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>equal <span class="token number">0.</span> <span class="token punctuation">(</span>floor <span class="token number">0.9999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>equal <span class="token number">1.</span> <span class="token punctuation">(</span>floor <span class="token number">1.0000001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>equal <span class="token number">10.</span> <span class="token punctuation">(</span>floor <span class="token number">10.999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token operator">..</span><span class="token punctuation">.</span></code></pre></div>
<p>Rather than manually writing several of these tests, property-based testing (PBT) (QuickCheck) advocates for expressing a general <em>property</em> which should hold true across all inputs. For example, for any input <code>f</code> given to the <code>floor</code> function, we expect the result to be less or equal to <code>f</code>: <code>floor f &lt;= f</code> to capture that the function is rounding down. Based on this presumption, we can test this property on any <code>f</code> provided by a <em>generator</em> conveniently named <code>float</code>, here phrased as a <a href="https://github.com/c-cube/qcheck">QCheck</a> test:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> floor_test <span class="token operator">=</span> Test<span class="token punctuation">.</span>make float <span class="token punctuation">(</span><span class="token keyword">fun</span> f <span class="token operator">-&gt;</span> floor f <span class="token operator">&lt;=</span> f<span class="token punctuation">)</span><span class="token punctuation">;;</span></code></pre></div>
<p>Such a parameterised property-based test allows us to check the property for each input generated. For the above example, this corresponds to a collection of test cases beyond what developers like to write by hand:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token number">1313543.66397378966</span> <span class="token operator">&lt;=</span> <span class="token number">1313543.66397378966</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">24763.5086878848342</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">24763.5086878848342</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token number">1280.58075149504566</span> <span class="token operator">&lt;=</span> <span class="token number">1280.58075149504566</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.00526932453845931851</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">0.00526932453845931851</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">35729.1783938070657</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">35729.1783938070657</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">152180.150007840159</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">152180.150007840159</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>floor <span class="token number">0.000198774450118538313</span> <span class="token operator">&lt;=</span> <span class="token number">0.000198774450118538313</span><span class="token punctuation">)</span><span class="token punctuation">;;</span>
<span class="token operator">..</span><span class="token punctuation">.</span></code></pre></div>
<p>By default, QCheck's <code>Test.make</code> runs 100 such test cases, but by passing an optional <code>~count</code> parameter, we can raise the test count to our liking with minimal effort. In <code>QCheck</code>, the input for each such test case is randomised and produced with the help of a <a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">pseudo-random number generator (PRNG)</a>. By passing the same seed to the PRNG, we are thus able to trigger the same test case runs and reproduce any issue we may encounter.</p>
<p>Testing is still incomplete since, as captured in the immortal words of Edsger Dijkstra:</p>
<blockquote>
<p>&ldquo;Program testing can be used to show the presence of bugs, but never to show their absence!&rdquo; -- Edsger W. Dijkstra, <a href="https://www.cs.utexas.edu/users/EWD/ewd02xx/EWD249.PDF">Notes On Structured Programming</a>, 1970</p>
</blockquote>
<p>Property-based testing does not change that incompleteness. However, because the amount of test cases is less tied to developer effort, PBT tends to be 'less incomplete' than handwritten test cases and can thus reveal the presence of otherwise undetected bugs. Its effectiveness, however, depends on the strength of the tested properties and the distribution of test inputs from the generator. For example, the property <code>floor f &lt;= f</code> alone does not fully capture <code>floor</code>'s correct behaviour. Similarly, we may want to adjust the generator's distribution to exercise <code>floor</code> on corner cases such as <code>nan</code> or floating point numbers ending in <code>.0</code> or <code>.5</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#property-based-testing-with-a-state-machine-model" aria-label="property based testing with a state machine model permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Property-Based Testing With a State-Machine Model</h2>
<p>Above, we saw an example of using randomised input to test a property of <em>one</em> function, <code>floor</code>, in isolation. Often, software defects only appear when combining a particular sequence of function calls. A property-based test against a state-machine model allows us to test behaviour across a <em>random combination of function calls</em>. For each call, we perform it twice: once over the <em>system under test</em> and once over a purely functional reference <em>model</em>, and finally compare the two results as illustrated in the below figure. This idea grew out of the <a href="https://clean-lang.org">Clean</a> and <a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=b268715b8c0bcebe53db857aa2d7a95fbb5c5dbf">Erlang QuickCheck</a> communities and has since been <a href="https://github.com/jmid/pbt-frameworks">ported to numerous other programming languages</a>.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 573px; ">
      <a href="https://tarides.com/static/f0452e1a8cfe1935b4d8790971766120/3c024/model-based.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.11764705882354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACy0lEQVR42n1Ty07bQBS1IPAZSCAhUZYg2CHRBQI2LMofILFGbGHLR0CRUEooKiqiUlJoHUISm2BCiO3YediJnfcTKElhxcY5nRkQrVS1Ix3P+My9Z+6dO5d7fHx0ms2m02q1nJubG+f29paBriuVilMul1/nUqnk1Gq1v+yoL9V4eHhwuGq1CsMwUCgUYJomVFVlsCwLyWQSgiAgGAyC53lIksQ4updIJJjdn77kMHC2bWNpaQnz8/PY2NhAPp9nRqurq5ibm8Pa2hpzIFFifX0ds7OzWFlZQSqVQrFYZD7Ud3l5GVSLS6fTGBgYQF9fH2ZmZiCKItxuNwYHB9Hb24uxsTGEw2EcHR1heHgYPT09GB0dxcnJCbxeL8bHx+FyuTA0NASqxQRHRkbQ39+PxXeL0HWdCUxMTDDB6em3LD1FVjA1NcUEJycnWfo05YWFBbhIMG/IIZlMBtx9+54pRy7Okc2ZaDQaDPSexHMBhplm/81mA7ZlE05ExkijXq8TrsnSvIhEYJAruG+3wQFd0JGtxVH9mWZrp+uwudgwYP+IsXX3hau0LFh3UTyPLvPuNOpAqcAYrtPpIEMqxAcCKJaLrxEWyxUcf/8Oq2C/RNhEqVLF8TfK5VF/4crVCvjTU5KJiTbR4mxSQXfoCluCgoOQBOkiglNi4AlfYTMsYz8UhURSEsIh7AYihFOwL8rsns/Jk9rzi3gvKkyDanE0kt1oCluXGXwUYgiSSD0eD3aEOLZjOexFVATPAvh88AlbfATb1zl4JA1+vx9fDg+x6QtgR7bxQUqyrLgS+fguZRyrJs6uE8hlTVYtPq7DJxvgYwlSjByBBf+1Bq/8vEffoZXL4iyuwacY+BpVUSqXwTpFVWToCRW6loCmaQw6eSq6qjCedgqFRm0YfttpZJ0knCrLz51CevmJ9OTT3d3dP0G65In08n9tqAbV+gW1kUxarchLXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/f0452e1a8cfe1935b4d8790971766120/3c024/model-based.png" class="gatsby-resp-image-image" alt="A diagram with two rows of 'call' boxes (one for the System Under Test and one for the Model) along with arrows between the corresponding call boxes" title="" srcset="/static/f0452e1a8cfe1935b4d8790971766120/04472/model-based.png 170w,
/static/f0452e1a8cfe1935b4d8790971766120/9f933/model-based.png 340w,
/static/f0452e1a8cfe1935b4d8790971766120/3c024/model-based.png 573w" sizes="(max-width: 573px) 100vw, 573px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>Suppose we want to test a selection of the <code>Float.Array</code> interface across random combinations using OCaml's <code>qcheck-stm</code> test library. To do so, we first express a type of symbolic commands, <code>cmd</code>, along with a function <code>show_cmd</code> to render them as strings:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">type</span> cmd <span class="token operator">=</span>
    <span class="token operator">|</span> To_list
    <span class="token operator">|</span> Sort
    <span class="token operator">|</span> Set <span class="token keyword">of</span> int <span class="token operator">*</span> float

  <span class="token keyword">let</span> show_cmd cmd <span class="token operator">=</span> <span class="token keyword">match</span> cmd <span class="token keyword">with</span>
    <span class="token operator">|</span> To_list    <span class="token operator">-&gt;</span> <span class="token string">&quot;To_list&quot;</span>
    <span class="token operator">|</span> Sort       <span class="token operator">-&gt;</span> <span class="token string">&quot;Sort&quot;</span>
    <span class="token operator">|</span> Set <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Printf<span class="token punctuation">.</span>sprintf <span class="token string">&quot;Set (%i, %F)&quot;</span> x y</code></pre></div>
<p>We will furthermore need to express the type of our 'System Under Test' (SUT), how to initialise it, and how to clean up after it:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">type</span> sut <span class="token operator">=</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>t
  
  <span class="token keyword">let</span> floatarray_size <span class="token operator">=</span> <span class="token number">12</span>
  <span class="token keyword">let</span> init_sut <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>make floatarray_size <span class="token number">1.0</span>
  <span class="token keyword">let</span> cleanup <span class="token punctuation">_</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>This will test a float array of size 12, initialised to contain <code>1.0</code> entries.
For the <code>cleanup</code> we will just let OCaml's garbage collector reclaim the array for us.</p>
<p>We can now phrase an interpreter over the symbolic commands. We annotate each result with combinators and wrap each result up in a <code>Res</code> constructor for later comparison. For example, since <code>Float.Array.to_list</code> returns a <code>float list</code> it is annotated with the combinator <code>list float</code> mimicking its return type:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">let</span> run f fa <span class="token operator">=</span> <span class="token keyword">match</span> f <span class="token keyword">with</span>
    <span class="token operator">|</span> To_list   <span class="token operator">-&gt;</span> Res <span class="token punctuation">(</span>list float<span class="token punctuation">,</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>to_list fa<span class="token punctuation">)</span>
    <span class="token operator">|</span> Sort      <span class="token operator">-&gt;</span> Res <span class="token punctuation">(</span>unit<span class="token punctuation">,</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>sort Float<span class="token punctuation">.</span>compare fa<span class="token punctuation">)</span>
    <span class="token operator">|</span> Set <span class="token punctuation">(</span>i<span class="token punctuation">,</span>f<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Res <span class="token punctuation">(</span>result unit exn<span class="token punctuation">,</span> protect <span class="token punctuation">(</span>Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>set fa i<span class="token punctuation">)</span> f<span class="token punctuation">)</span></code></pre></div>
<p>Since <code>Float.Array.set</code> may raise an out of bounds exception, we wrap its invocation with <code>protect</code> which will turn the result into an OCaml <code>Result</code> type, and suitably annotate it with <code>result unit exn</code> to reflect that it may either complete normally or raise an exception.</p>
<p>Now, what should we compare the <code>Float.Array</code> operations to? We can express a pure <em>model</em>, capturing its intended meaning. The state of a float array can be expressed as a simple <code>float list</code>. We then explain to <code>STM</code> how to initialise this model with <code>init_state</code> and how each of our 3 commands change the state of the model using a second interpreter:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">type</span> state <span class="token operator">=</span> float list

  <span class="token keyword">let</span> init_state  <span class="token operator">=</span> List<span class="token punctuation">.</span>init floatarray_size <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> next_state f s <span class="token operator">=</span> <span class="token keyword">match</span> f <span class="token keyword">with</span>
    <span class="token operator">|</span> To_list   <span class="token operator">-&gt;</span> s
    <span class="token operator">|</span> Sort      <span class="token operator">-&gt;</span> List<span class="token punctuation">.</span>sort Float<span class="token punctuation">.</span>compare s
    <span class="token operator">|</span> Set <span class="token punctuation">(</span>i<span class="token punctuation">,</span>f<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> List<span class="token punctuation">.</span>mapi <span class="token punctuation">(</span><span class="token keyword">fun</span> j f' <span class="token operator">-&gt;</span> <span class="token keyword">if</span> i<span class="token operator">=</span>j <span class="token keyword">then</span> f <span class="token keyword">else</span> f'<span class="token punctuation">)</span> s</code></pre></div>
<p>Out of the three commands, only <code>To_list</code> does not change the underlying array and hence returns our model <code>s</code> unmodified. The <code>Sort</code> case utilises <code>List.sort</code> to sort the model accordingly. Finally the <code>Set</code> case expresses how the <code>list</code> model is updated on the <em>i</em>-th entry, to reflect the array assignment of a new entry <code>f</code>.</p>
<p>With a model in place, we can then express as pre- and post-conditions what we deem acceptable behaviour. As none of the functions have pre-conditions we leave <code>precond</code> as constantly <code>true</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">let</span> precond _cmd _s <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">let</span> postcond f <span class="token punctuation">(</span>s<span class="token punctuation">:</span>float list<span class="token punctuation">)</span> res <span class="token operator">=</span> <span class="token keyword">match</span> f<span class="token punctuation">,</span> res <span class="token keyword">with</span>
    <span class="token operator">|</span> To_list<span class="token punctuation">,</span> Res <span class="token punctuation">(</span><span class="token punctuation">(</span>List Float<span class="token punctuation">,</span><span class="token punctuation">_</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fs<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> List<span class="token punctuation">.</span>equal Float<span class="token punctuation">.</span>equal fs s
    <span class="token operator">|</span> Sort<span class="token punctuation">,</span> Res <span class="token punctuation">(</span><span class="token punctuation">(</span>Unit<span class="token punctuation">,</span><span class="token punctuation">_</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">|</span> Set <span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">_</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Res <span class="token punctuation">(</span><span class="token punctuation">(</span>Result <span class="token punctuation">(</span>Unit<span class="token punctuation">,</span>Exn<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">_</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
      <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">&gt;=</span> List<span class="token punctuation">.</span>length s
      <span class="token keyword">then</span> r <span class="token operator">=</span> Error <span class="token punctuation">(</span>Invalid_argument <span class="token string">&quot;index out of bounds&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">else</span> r <span class="token operator">=</span> Ok <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">|</span> <span class="token punctuation">_</span><span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token boolean">false</span></code></pre></div>
<p>In the <code>To_list</code> case we use <code>List.equal</code> to compare the actual list result to the model. Since <code>Sort</code> returns a <code>unit</code> and is executed for its side effect, there is not much to verify about the result. Finally in the <code>Set</code> case we verify that <code>cmd</code> fails as expected when receiving invalid array indices.</p>
<p>As a final piece of the puzzle we write a function <code>arb_cmd</code> to generate arbitrary commands using QCheck's combinators:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">  <span class="token keyword">let</span> arb_cmd s <span class="token operator">=</span>
    <span class="token keyword">let</span> int_gen <span class="token operator">=</span> Gen<span class="token punctuation">.</span><span class="token punctuation">(</span>frequency <span class="token punctuation">[</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>small_nat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                   <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span>int_bound <span class="token punctuation">(</span>List<span class="token punctuation">.</span>length s <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> float_gen <span class="token operator">=</span> Gen<span class="token punctuation">.</span>float <span class="token keyword">in</span>
    QCheck<span class="token punctuation">.</span>make <span class="token label property">~print</span><span class="token punctuation">:</span>show_cmd
      Gen<span class="token punctuation">.</span><span class="token punctuation">(</span>oneof
             <span class="token punctuation">[</span> return To_list<span class="token punctuation">;</span>
               return Sort<span class="token punctuation">;</span>
               map2 <span class="token punctuation">(</span><span class="token keyword">fun</span> i f <span class="token operator">-&gt;</span> Set <span class="token punctuation">(</span>i<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> int_gen float_gen<span class="token punctuation">;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>The function accepts a <code>state</code> parameter to enable model-dependent <code>cmd</code> generation. Here we use it to generate an array index guaranteed to be within bounds in 7/8 of the cases. In the other cases we fall back on QCheck's <code>small_nat</code> generator to check the out-of-bounds indexing behaviour of <code>Float.Array.set</code>. Overall, we choose uniformly between generating either a <code>To_list</code>, a <code>Sort</code>, or a <code>Set</code> <code>cmd</code>.</p>
<p>Assuming we surround the above code in a suitable OCaml module <code>FAConf</code>, we can pass it
to the functor <code>STM_sequential.Make</code> to create a runnable sequential <code>STM</code> test:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> FAConf <span class="token operator">=</span>
<span class="token keyword">struct</span>
  <span class="token punctuation">[</span><span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> FA_STM_seq <span class="token operator">=</span> STM_sequential<span class="token punctuation">.</span>Make<span class="token punctuation">(</span>FAConf<span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  QCheck_base_runner<span class="token punctuation">.</span>run_tests_main
    <span class="token punctuation">[</span>FA_STM_seq<span class="token punctuation">.</span>agree_test <span class="token label property">~count</span><span class="token punctuation">:</span><span class="token number">1000</span> <span class="token label property">~name</span><span class="token punctuation">:</span><span class="token string">&quot;Sequential STM Float Array test&quot;</span><span class="token punctuation">]</span></code></pre></div>
<p>This test quickly checks 1000 <code>cmd</code> lists for agreement with our model:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">random seed: 271125846
generated error fail pass / total     time test name
[&#10003;] 1000    0    0 1000 / 1000     0.5s Sequential STM Float Array test
================================================================================
success (ran 1 tests)</code></pre></div>
<p>This hasn't always been so &ndash; on all platforms at least. When testing OCaml 5's newly restored PowerPC backend, <a href="https://github.com/ocaml/ocaml/issues/12482">we first started to observe crashes on array-related tests such as the above</a>. This was <a href="https://github.com/ocaml/ocaml/pull/12540">fixed by Tarides compiler engineer Miod Vallat by changing the PowerPC compiler backend to avoid using signals for array-bounds checks</a>. However that fix alone wasn't enough to get the <code>STM</code> float array test passing. In particular, <a href="https://github.com/ocaml/ocaml/pull/12540#issuecomment-1713640499">it found wrong <code>float</code> values appearing, causing a disagreement between the SUT and the model on the 64-bit PowerPC platform</a>.</p>
<p>For example, here is the output of our example model from one such failing run under PowerPC:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">random seed: 421297093
generated error fail pass / total     time test name
[&#10007;]   27    0    1   26 / 1000     0.0s STM Float Array test sequential

--- Failure --------------------------------------------------------------------

Test STM Float Array test sequential failed (0 shrink steps):

   To_list
   Sort
   Set (1, 9.02935000701)
   Set (0, 118.517154099)
   Set (8, -0.33441184552)
   To_list
   Set (5, -0.000114416837276)
   Sort
   To_list


+++ Messages ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Messages for test STM Float Array test sequential:

  Results incompatible with model

   To_list : [1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.]
   Sort : ()
   Set (1, 9.02935000701) : Ok (())
   Set (0, 118.517154099) : Ok (())
   Set (8, -0.33441184552) : Ok (())
   To_list : [118.517154099; 9.02935000701; 1.; 1.; 1.; 1.; 1.; 1.; -0.33441184552; 1.; 1.; 1.]
   Set (5, -0.000114416837276) : Ok (())
   Sort : ()
   To_list : [-0.33441184552; -0.000114416837276; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 118.517154099; 1.; 9.02935000701]
================================================================================
failure (1 tests failed, 0 tests errored, ran 1 tests)</code></pre></div>
<p>Here the counterexample consists of 9 <code>cmd</code>s first printed without the returned results and then with the observed result. After <code>set</code>ting 4 entries (index 1, 0, 8, and 5) arbitrarily the result of the final <code>to_list</code> appears unsorted with the <code>118.517154099</code> entry strangely out of place! A similar observation from our larger model-based <code>STM</code> test prompted us <a href="https://github.com/ocaml/ocaml/pull/12540#issuecomment-1713640499">to create and share a small stand-alone reproducer illustrating the misbehaviour</a>. With that at hand, OCaml's own Xavier Leroy then quickly identified and fixed the bug, which was caused by PowerPC's FPR0 floating point register not being properly saved and restored across function calls. Both these fixes went into <a href="https://github.com/ocaml/ocaml/pull/12540">ocaml/ocaml#12540</a> and will be included in the forthcoming OCaml 5.2 release, restoring the 64-bit POWER backend.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#testing-parallel-behaviour-against-a-sequential-stm-model" aria-label="testing parallel behaviour against a sequential stm model permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Testing Parallel Behaviour Against a Sequential <code>STM</code> Model</h2>
<p>Since Multicore OCaml programs can be non-deterministic &ndash; meaning that they can behave in not just one way but in a number of different, equally acceptable, ways &ndash; it is harder to capture acceptable behaviour in a test. Furthermore, errors may go unnoticed or be hard to reproduce, which further complicate their testing and debugging.</p>
<p>Fortunately a sequential model can also function as an oracle for the observed behaviour of the SUT under parallel usage. This idea originates from the paper <a href="http://happy-testing.com/hans/papers/ICFP2009-PULSE.pdf"><em>&quot;Finding Race Conditions in Erlang with QuickCheck and PULSE&quot;</em> by Claessen et al.,</a> from ICFP 2009. Rather than generate a sequential list of arbitrary <code>cmd</code>s, one can generate two such <code>cmd</code> lists to be executed in parallel. If we add a &quot;sequential prefix&quot; to bring the SUT to an arbitrary state before <code>spawn</code>-ing two parallel <code>Domain</code>s, the result is an upside-down <code>Y</code>-shaped test.</p>
<p>Without changing anything, from the model above we can create a parallel <code>STM</code> test by passing our specification module <code>FAConf</code> to the functor <code>STM_domain.Make</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> FA_STM_dom <span class="token operator">=</span> STM_domain<span class="token punctuation">.</span>Make<span class="token punctuation">(</span>FAConf<span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  QCheck_base_runner<span class="token punctuation">.</span>run_tests_main
    <span class="token punctuation">[</span>FA_STM_dom<span class="token punctuation">.</span>agree_test_par <span class="token label property">~count</span><span class="token punctuation">:</span><span class="token number">1000</span> <span class="token label property">~name</span><span class="token punctuation">:</span><span class="token string">&quot;Parallel STM Float Array test&quot;</span><span class="token punctuation">]</span></code></pre></div>
<p>This will test that each observed parallel behaviour can be explained by <em>some</em> sequential interleaved <code>cmd</code> run of the model. As such, the property performs an interleaving search.
To counter that each random <code>Y</code>-shaped <code>cmd</code> input may yield a non-deterministic answer, <code>STM</code> repeats each property 25 times and fails if just one of the runs cannot be explained by an interleaved model run.</p>
<p>Running the test quickly finds a counterexample, illustrating that float arrays are not safe to use in parallel:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">random seed: 224773045
generated error fail pass / total     time test name
[&#10007;]    1    0    1    0 / 1000     1.0s Parallel STM Float Array test

--- Failure --------------------------------------------------------------------

Test Parallel STM Float Array test failed (7 shrink steps):

                                  |           
                       Set (8, -327818.639845)
                                  |           
                     .------------------------.
                     |                        |           
                  To_list                   Sort          


+++ Messages ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Messages for test Parallel STM Float Array test:

  Results incompatible with linearized model

                                                               |                             
                                               Set (8, -327818.639845) : Ok (())             
                                                               |                             
                                 .-----------------------------------------------------------.
                                 |                                                           |                             
     To_list : [1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.]                          Sort : ()                         

================================================================================
failure (1 tests failed, 0 tests errored, ran 1 tests)</code></pre></div>
<p>The produced counterexample shows that from a float array with all <code>1.0</code>-entries, if one sets entry 8 to, e.g., <code>-327818.639845</code> and then proceeds to sample the array contents with a <code>To_list</code> call in parallel with executing a mutating call to <code>Sort</code>, we may experience unexpected behaviour: The <code>To_list</code> result indicates no <code>-327818.639845</code> entry! This illustrates and confirms that OCaml arrays and <code>Float.Array</code> in particular are not safe to use in parallel without coordinated access, e.g., with a <code>Mutex</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#lowering-model-requirements-with-lin" aria-label="lowering model requirements with lin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lowering Model-Requirements With <code>Lin</code></h2>
<p>One may rightfully point out that developing an <code>STM</code> model takes some effort. This inspired us to develop a simpler library <code>Lin</code>, requiring substantially less input from its end user. <code>Lin</code> also tests a property by performing and recording the output of a Y-shaped parallel run like <code>STM</code>. However, it does so by trying to consolidate the outcome against <em>some</em> sequential run of the tested system, by performing a search over all possible <code>cmd</code> interleavings. In effect, <code>Lin</code> thus reuses the tested system as a &quot;sequential oracle&quot;.</p>
<p>Here is the complete code for a corresponding <code>Float.Array</code> example, now using <code>Lin</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> FAConf <span class="token operator">=</span>
<span class="token keyword">struct</span>
  <span class="token keyword">type</span> t <span class="token operator">=</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>t
  <span class="token keyword">let</span> array_size <span class="token operator">=</span> <span class="token number">12</span>
  <span class="token keyword">let</span> init <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>make array_size <span class="token number">1.0</span>
  <span class="token keyword">let</span> cleanup <span class="token punctuation">_</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">open</span> Lin
  <span class="token keyword">let</span> int <span class="token operator">=</span> int_small
  <span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token punctuation">[</span>
    val_ <span class="token string">&quot;Float.Array.to_list&quot;</span> Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>to_list        <span class="token punctuation">(</span>t <span class="token operator">@-&gt;</span> returning <span class="token punctuation">(</span>list float<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val_ <span class="token string">&quot;Float.Array.sort&quot;</span>    Float<span class="token punctuation">.</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>sort compare<span class="token punctuation">)</span> <span class="token punctuation">(</span>t <span class="token operator">@-&gt;</span> returning unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val_ <span class="token string">&quot;Float.Array.set&quot;</span>     Float<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>set            <span class="token punctuation">(</span>t <span class="token operator">@-&gt;</span> int <span class="token operator">@-&gt;</span> float <span class="token operator">@-&gt;</span> returning_or_exc unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">]</span>
<span class="token keyword">end</span></code></pre></div>
<p>Just as with <code>STM</code>, <code>Lin</code> needs to be told the type <code>t</code> of the system under test, how to initialise it with <code>init</code>, and how to clean up after it with <code>cleanup</code>. Finally, we describe the type signatures of the tested system with a combinator-based DSL in the style of OCaml's <code>ctypes</code> library. In the <code>to_list</code> case, the input is pretty close to the signature <code>to_list : t -&gt; float list</code> from the <code>Float.Array</code> signature. In the <code>sort</code> case, we test the result of passing the <code>Float.compare</code> function. Finally, in the <code>set</code> case, the <code>returning_or_exc</code> combinator expresses that an out-of-bounds exception may be raised.</p>
<p>Based on the above, we can now create and run our <code>qcheck-lin</code> test as follows:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> FA_Lin_dom <span class="token operator">=</span> Lin_domain<span class="token punctuation">.</span>Make<span class="token punctuation">(</span>FAConf<span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  QCheck_base_runner<span class="token punctuation">.</span>run_tests_main
    <span class="token punctuation">[</span>FA_Lin_dom<span class="token punctuation">.</span>neg_lin_test <span class="token label property">~count</span><span class="token punctuation">:</span><span class="token number">1000</span> <span class="token label property">~name</span><span class="token punctuation">:</span><span class="token string">&quot;Lin Float.Array test with Domain&quot;</span><span class="token punctuation">]</span></code></pre></div>
<p>The result of the <code>Lin_domain.Make</code> functor offers both <code>lin_test</code> for a positive test of sequential consistency and <code>neg_lin_test</code> as we use here for a negative test, confirming absense of sequential consistency with a counterexample:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">random seed: 349336243
generated error fail pass / total     time test name
[&#10003;]    2    0    1    1 / 1000     1.1s Lin Float.Array test with Domain

--- Info -----------------------------------------------------------------------

Negative test Lin Float.Array test with Domain failed as expected (27 shrink steps):

                                            |                
                            Float.Array.set t 0 111.772797434
                                            |                
                          .----------------------------------.
                          |                                  |                
                Float.Array.to_list t               Float.Array.sort t        


+++ Messages ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Messages for test Lin Float.Array test with Domain:

  Results incompatible with sequential execution

                                                                                                   |                                               
                                                                              Float.Array.set t 0 111.772797434 : Ok (())                          
                                                                                                   |                                               
                                                   .-----------------------------------------------------------------------------------------------.
                                                   |                                                                                               |                                               
     Float.Array.to_list t : [111.772797434; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 1.; 111.772797434]                                     Float.Array.sort t : ()                                    

================================================================================
success (ran 1 tests)</code></pre></div>
<p>Note how the above result is a passing test, which found a counterexample in the second attempt: 2 generated, 1 pass, 1 fail. After shrinking, the resulting shape is similar to the one found by <code>STM</code>. The details differ from run to run, reflecting the non-determinism of the tested program. The output this time illustrates how the non-<code>1.0</code> entry <code>111.772797434</code> can unexpectedly show up twice in a result from <code>to_list</code>, again illustrating how <code>Float.Array</code> is unsafe to use in parallel.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#growing-a-test-suite" aria-label="growing a test suite permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Growing a Test Suite</h2>
<p>Over time we have developed a growing test suite, which includes tests of (parts of) <code>Array</code>, <code>Atomic</code>, <code>Bigarray</code>, <code>Buffer</code>, <code>Bytes</code>, <code>Dynlink</code>, <code>Ephemeron</code>, <code>Hashtbl</code>, <code>In_channel</code>, <code>Out_channel</code>, <code>Lazy</code>, <code>Queue</code>, <code>Semaphore</code>, <code>Stack</code>, <code>Sys</code>, and <code>Weak</code> from OCaml's <code>Stdlib</code> in addition to the above-mentioned <code>Float.Array</code> test.</p>
<p>Not everything fits into the <code>STM</code> and <code>Lin</code> formats. To stress-test the new runtime's primitives underlying the <code>Domain</code> and <code>Thread</code> modules, we have developed separate ad-hoc property-based tests of each of these, as well as a property-based test of their combination.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#growing-a-ci-system" aria-label="growing a ci system permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Growing a CI System</h2>
<p>Starting from a single GitHub Actions workflow to run the test suite on Linux, we have gradually added additional CI targets, to the point that we can now run the test suite under Linux, macOS, and
Windows (MinGW + Cygwin). Furthermore, we can run the test suite on OCaml with particular configurations, such as</p>
<ul>
<li>Bytecode builds</li>
<li>32-bit builds</li>
<li>Enabling frame pointers</li>
<li>The debug runtime</li>
</ul>
<p><a href="https://github.blog/changelog/2024-01-30-github-actions-introducing-the-new-m1-macos-runner-available-to-open-source/">Until recently</a> GitHub Actions offered only amd64-based machines for testing, limiting testing to just one OCaml compiler backend. Our colleague Ben Andrew therefore built <a href="https://github.com/ocurrent/multicoretests-ci"><code>multicoretests-ci</code></a> &ndash; an <code>ocurrent</code>-based CI system that lets us run the testsuite on a range of additional platforms:</p>
<ul>
<li>Linux ARM64</li>
<li>macOS ARM64</li>
<li>Linux PowerPC64</li>
<li>Linux s390x</li>
<li>FreeBSD amd64</li>
</ul>
<p>The above mentioned POWER bugs were found thanks to <code>multicoretests-ci</code> runs.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#understanding-issues-found" aria-label="understanding issues found permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Understanding Issues Found</h2>
<p>Up to this point, we have found 30 issues, ranging from test cases crashing OCaml's runtime to discovering that the <code>Sys.readdir</code> function may behave differently on Windows. In order to better understand the issues we have found, we have divided them into categories:</p>
<ul>
<li><code>runtime</code> &ndash; for issues requiring a change in OCaml's runtime system</li>
<li><code>stdlib</code> &ndash; for issues requiring a change in OCaml's standard library</li>
<li><code>codegen</code> &ndash; for issues requiring a change in a backend code generator</li>
<li><code>flexdll</code> &ndash; for issues requiring a change in the <code>FlexDLL</code> tool for Windows</li>
<li><code>dune</code> - for issues requiring a change in the <code>dune</code> build system tool</li>
<li><code>domainslib</code> &ndash; for issues discovered while testing the <code>domainslib</code> library</li>
<li><code>lockfree</code> &ndash; for issues discovered while testing the <code>lockfree</code> (now: <code>saturn</code>) library</li>
</ul>
<p>The found issues are distributed as follows:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 353px; ">
      <a href="https://tarides.com/static/696f8d2e4846fdc3c74ed764765910c8/6c115/bug-distribution.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 97.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADqUlEQVR42oXU61NUdRzH8X3Uk57Yk6Yx/4Sii8TEJSSGIgWsnqQPrGmyGWscZKCCRTLDgnWsJ2AP5CIMN4NY0KUVaNAuZisrN8tRAy2aBMRkl73v2cs5775nz0KaUGfmM2f3/M55ne/vd36/n4nkoWkaYV+IWDjKekdc1Vh0B5i745Pf6pr3mFZBuTkSVOSsEvYGmXVOc9n6E8Pt31PTcZ6W05eYmrmFEo2vFrAuuNIYj8S4OjzJ6Y9OYC1txlbSRH3JcbL3tZNT0k5eWSfFdcOM/7qwLmoieS3kCfDDUTvWfY3YKtoY2N/BcFUHjVVdbN/fk0hRZQ8vCKqn7ezMP2gCNpKoMBqOCzZIX2kT9g87GahsxyYZkjRUdlJg7qZQUmT+kpcru8k227GUv4M63pRE1Xu7fHPUTn9ZAyfLewXTq2u7D9SxAnMPuRU2jlfvQa3ZQMiyCXVuAs2/iOb6DS1wB5Oq3MIzkcvNke38WGfhVPkJSRc2QYcE18FCwbYJttVsxVq9E612AwHBAgceJGLba5QWDYMax6Tc7sN14SlB0/GMp3P91BucsRyl74NuBs0dNAmcL1CRgCPVRSCV+Ws2EpAEDz1EqD4FLeRemXuYgr9/isuRgvviFkkmvqlUXM5sfu4q5szBZures7LD3MLEJ+lw+AGp7GGClkcI1G7EX7sJX/WjxOd/MUC9Qv90mVT4tGDPJUCXMwv3WAa+S5tZOpfPUOMBhmt24qpKY6ksD/feHNy7n2d5Vx6eHdtwbc0jMjWFqijEl5cFnKkQ8ElBDHAlCXj8WQKTz3Dt3Isc6S+huO0zDrU0c6yhlfa6Y/Qe+ZwBsxn3jRtGj6NRTKE/vxBQujyWfQ+YiDOTJYF9Mraui2l8/W0Oe/pf41Xr+7w5WM+7Z09S+t0I834fvkgEv8QU9Thwj6audnmtuBLnLMLjGSyMZtJq38Kujnxeai7k4DeHE9XFZMnG9DFEi+G9/Dqu0c3/iepZknjHMolOZHDdkcvHX6Vjv9qLElP4K3BbwFhypSyfT4KZ/4smKh7LwT+agnLtbUGiAoYJRYOosmIENJZNeL7VmD7O9OR4Zt2P6R9O2lwXnsA9WUAs9MfKVvXv7cvYIZTFXuMBx+PyldOSUJYReZG+AJYcj+G98hbx8GySUNfeD1ca4qFZArMWPFOvyDCkSVKN4ZAXea/sRl9ZmqpwdyHrbLCKTM4FtLjf+B/zEg9ME/U4ifkmpKI5/eJd0Nob7N/m5tK4YJJgxwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/696f8d2e4846fdc3c74ed764765910c8/6c115/bug-distribution.png" class="gatsby-resp-image-image" alt="A pie chart illustrating the following distribution: 50% runtime, 17% stdlib, 13% codegen, 10% domainslib, 3% dune, 3% flexdll, 3% lockfree" title="" srcset="/static/696f8d2e4846fdc3c74ed764765910c8/04472/bug-distribution.png 170w,
/static/696f8d2e4846fdc3c74ed764765910c8/9f933/bug-distribution.png 340w,
/static/696f8d2e4846fdc3c74ed764765910c8/6c115/bug-distribution.png 353w" sizes="(max-width: 353px) 100vw, 353px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>This distribution was a surprise to us: Half of the issues are runtime related! Initially, we had expected to use the PBT approach to test OCaml's existing <code>Stdlib</code> for safety under parallel usage. However, as testing has progressed, it has become apparent that the approach also works well to stress test and detect errors in the new multicore runtime.</p>
<p>The above only counts fixed issues for which PRs have been merged. Without a 'fix PR', it is harder to judge where changes are required and thus to categorise each issue. In addition to the above, we are currently aware of at least 3 additional outstanding issues that we need to investigate further.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#lin-vs-stm-vs-tsan-vs-dscheck" aria-label="lin vs stm vs tsan vs dscheck permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lin vs STM vs TSan vs DSCheck</h2>
<p>At Tarides, we test multicore OCaml with a variety of tools. <code>Lin</code> tests are relatively easy to write and useful in themselves, but they test a weaker property compared to <code>STM</code>. For one, they only test a parallel property. Secondly, they do not express anything about the intended semantics of a tested API, e.g. a module with functions consistently raising a <code>Not_implemented_yet</code> exception would pass a <code>Lin</code> test. Furthermore, if we had only used a negative <code>Lin</code> test such as the above, the PowerPC register bug is likely to have been missed or disregarded as a parallel-usage misbehaviour.</p>
<p>On the other hand, a <code>Lin</code> test was sufficient to reveal, e.g. <a href="https://github.com/ocaml-multicore/multicoretests/pull/214">early out-of-thin air values from the <code>Weak</code> module</a> or <a href="https://github.com/ocaml/ocaml/issues/11878">reading of uninitialised bytes with <code>In_channel.seek</code> on a channel</a>. As such, <code>Lin</code> and <code>STM</code> present a trade-off between required user input and provided guarantees in a passing test.</p>
<p><a href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/">ThreadSanitizer (TSan) for OCaml</a> is a compiler instrumentation mode targeted at detecting data races in OCaml code. For comparison, TSan may detect races even if a thread schedule has not revealed a difference in the resulting output, an ability which is beyond <code>Lin</code> and <code>STM</code> as <a href="https://en.wikipedia.org/wiki/Black-box_testing">black-box testing libraries</a>. On the other hand, <code>Lin</code> and <code>STM</code> can detect a broader class of observable defects. In one case, <code>STM</code> even detected <a href="https://github.com/ocaml/ocaml/pull/12707">an issue caused by a race between atomic reads and writes</a>. As such TSan and PBT are very much complementary tools.</p>
<p><a href="https://tarides.com/blog/2024-02-14-multicore-testing-tools-dscheck-pt-1/">DSCheck</a> is a model-checking tool that exhaustively explores all thread schedules (up to some bound). As such, OCaml code tested with DSCheck ensures correctness even for very rarely occurring schedules, thus offering an advantage over <code>Lin</code> and <code>STM</code>. On the other hand, <code>Lin</code> and <code>STM</code> excel in exploring random combinations of <code>cmd</code>s and input parameters, rather than the thread schedules they may give rise to. As such, we again see DSCheck and PBT as supplementary.</p>
<p>Finally, <a href="https://tarides.com/blog/2022-12-22-ocaml-5-multicore-testing-tools/">Arthur Wendling's earlier blog post</a> offers an example that nicely illustrates how <code>Lin</code>, TSan, and DSCheck can complement each other well when developing and testing multicore OCaml code. <a href="https://tarides.com/blog/2024-04-10-multicore-testing-tools-dscheck-pt-2/">Part two of our DSCheck series</a> provides additional background on how the model checker works and how we use it to test data structures for the <a href="https://github.com/ocaml-multicore/saturn">Saturn</a> library.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#end-of-part-one" aria-label="end of part one permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>End of Part One</h2>
<p>We will stop here for now and continue in the second part of this miniseries. The next part will focus on the challenges and lessons learned during the process I've described. I will share some findings that surprised us and threw spanners in the works, as well as how we got creative to overcome them.</p>
<p>In the meantime, you can stay up-to-date with Tarides on <a href="https://twitter.com/tarides_">X</a> and <a href="https://www.linkedin.com/company/tarides">LinkedIn</a>, and sign up <a href="https://tarides.com/newsletter/">for our Newsletter</a>. See you next time!</p>
