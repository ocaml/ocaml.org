---
title: Up-to-Date Online Documentation
description: "Into the Fire The OCaml ecosystem relies on various resources and infrastructure
  such as ocaml.org, OCaml Docker images, opam-repo-ci, that\u2026"
url: https://tarides.com/blog/2022-10-20-up-to-date-online-documentation
date: 2022-10-20T00:00:00-00:00
preview_image: https://tarides.com/static/0c807033635ee6b82101e60222093da0/af462/cover.jpg
authors:
- Tarides
source:
---

<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#into-the-fire" aria-label="into the fire permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Into the Fire</h2>
<p>The OCaml ecosystem relies on various resources and infrastructure such as <a href="https://ocaml.org">ocaml.org</a>, <a href="https://hub.docker.com/r/ocaml/opam">OCaml Docker images</a>, <a href="http://check.ocamllabs.io/">opam-repo-ci</a>, that are built and deployed using <a href="https://www.ocurrent.org">OCurrent</a>. OCurrent is a library to express workflows and keep things up to date. As many of these projects are created using the same technology, it was interesting to centralise the documentation as it was spread throughout the various repositories. This post is about how we used OCurrent itself to automate this problem. We think it might also demonstrate how you can use OCurrent to automate some of yours!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#cant-keep-my-eyes-off-you" aria-label="cant keep my eyes off you permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Can't Keep My Eyes Off You</h2>
<p>Before digging into the logic, it's essential to thoroughly define the problems in the documentation. The first problem was that the documentation lives in many GitHub repositories. Indeed, to make sure we update it whenever we modify the associated code, we keep the documentation closest to the code. The result is a repository organisation like this:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 401px; ">
      <a href="https://tarides.com/static/13de7358e2149b6d1a660a4452c279bc/9144d/tracker.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 140.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD2ElEQVR42o1Va08bRxT1X2+lKCQQSNsoKiHQkn4ILUmrtmqVVkDNw2CwDcb4/cDGwsbr9dqu7d3Zx8yc6o7HyG0Bs9LRvTu7OrqPM/eG8MAjte1zjp1OB391OtgxzbFvWQphy8Jut4tty0JqOEToMYSmEHiVTuPp/j6ehMN4eXaGZ5EInkejWEwk1Pnnu7v4vdV6HGF7NMKvxSKSjoPz0QgX2qZsGxe2jbPhELHBAGXXfZhwQuoyBnswUO+ulHAAMACOlLClBJfy9v+ZhEEQQEp5G+1et4s3hQJWLi6wVijg28tLND1PfeOzCDnnYzIdQbPZxM+VCt4WCvg6mcRaPj8m9P3bbEIPkREmvhACnm1j5PsY6XRHQmAoBILHpEypThMLKVH0faQ9D1nXRZoxZFwXWc/DqW3D1P/fSUjREKajpOf7Wg2fhcOYi0TwIpHAk709LJycYD6ZRJGx+wknKRJupdNu46DdxpZpItzpjMXcbit/u9tFS9cxdFd0lO6/6iclbkwT3lTx5ZSspO4wyef/hERG9ZByLBkhlPZ+M01s1uv4UK9js1bD5tUVNioVbFxe4odqFe/rdSXy0IBz9KREX8P0ffQ4RycIwChlztHs9ZT2qF5LiQQWjo/xxfk5nh8eKsxHIngWjyNGd5ku/HIupzS1ksngrfaX83lUqNCco95o4Mb3YQiBFudjGwTKGpyjzTluOFdDJERFXc3n8a5YxFo2i29IrESez+OSMUjPQ90w0KRIOUcjCHDt+8onS5ictYMAoYEQ6AmBvrZtz0OXc5W6I4SKMGcYKuKFw0N8lUziy9NTLMViWIhE8DqdxhJJ5/gYfxjGjKZQp4WAxTl+abWwUSrhY72OH6+vsVmt4kOthp+ur/Hx6kpp9KjXQ0hOtV5q2fhBMCajdxI31cqy4FLXtUTEf6DO7pLN9HWbDAd6aq0WPjWb2LEsbJHANbZNE58MAznHeeTVozoCGAJYKZXw4uQEi7EY5o+O8JIkFI3iaTSKPct6eDhMolPknMMVAlnHUcgxppAl6zhIOw4aeibeS6ginETnOEiUyyrKv4VQIHUMpLxFV5+FZk1r6jZJar1SwXI6rYRPeJPJ4PXZmdLwai6HlXIZEeryzCWlb8Bmo4HVTAbrxSLelcvqAhDWSyWs68kd7fdn7xSKkORi0KKiBaUXE9O+o/2BnuCzt95ENtUqTns9pFwX53p1Jm0bKcdBfDS6fx7et5tJuN/Vapg7OsLcwQEW43HM7e/jVSqlJjaNrgkhewx8Idhhv8+2Oh223emwcLc7tpbF/rQsdsXUDmD/AGO5Q30gUeyvAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/13de7358e2149b6d1a660a4452c279bc/9144d/tracker.png" class="gatsby-resp-image-image" alt="Tracking" title="" srcset="/static/13de7358e2149b6d1a660a4452c279bc/04472/tracker.png 170w,
/static/13de7358e2149b6d1a660a4452c279bc/9f933/tracker.png 340w,
/static/13de7358e2149b6d1a660a4452c279bc/9144d/tracker.png 401w" sizes="(max-width: 401px) 100vw, 401px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>It's not a good judgement to count on humans' actions to monitor changes in all these repositories. As they fluctuate on their own time, we can't expect maintainers to backport documentation changes to the <code>ocurrent.org</code> website for each modification. To say it more technically, we need to track many files and keep them up to date. These actions should also update incrementally which matches with OCurrent nicely.</p>
<p>In addition, this documentation needs to stay up to date. Even if we centralise the documentation automatically, we must rebuild it regularly and fetch the changes from the repositories we track. Otherwise, the documentation will start to be outdated quickly. This is the opposite of what we want.</p>
<p>Furthermore, the system has to scale and be updated easily. Indeed, we would like to have the possibility to introduce new documents and repositories without having to install more applications. For instance, it would be beneficial to simply make a pull request somewhere.</p>
<p>In the next section, we will focus on the OCurrent pipeline design, which will automate our tasks and solve these problems.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#here-i-dreamt-i-was-an-architect" aria-label="here i dreamt i was an architect permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Here I Dreamt I Was an Architect</h2>
<p>The project is composed of several blocks we want to write to achieve our work:</p>
<ul>
<li>Fetch files from GitHub</li>
<li>Rebuild a subset of the code</li>
<li>Make the system modular</li>
<li>Store and deploy the data easily</li>
</ul>
<p>One aspect that will make our work a bit easier is to have it all concentrated in the same place, GitHub. As OCurrent provides a plugin to fetch information from GitHub, <code>current_github</code>, we don't have to worry about it. Furthermore, everything is cached thanks to OCurrent itself. We don't have to care about the incremental build. The only requirement is wisely choosing the data we want to cache.</p>
<p>Our architecture uses a <code>trackers.yml</code> file describing how the pipeline should interact with our heterogeneous repositories. It describes the files we want to track and where we would like them in the final website structure. The configuration gives a way to achieve modularity at a low cost, as we only have to open a PR on the repository that contains the tracker file to update them. Additionally, it allows us to track the repositories we want quickly. Once it's followed, we don't have to worry about the monitoring, as OCurrent can be set to rebuild stuff at the regular cycle. In our case, we want to control every week that the code hasn't mutated. In the present version of <code>trackers.yml</code>, we can specify the files we want to copy and the indexes we want to create to build our structure. This file is stored in the repository on which the <code>GitHub App</code> is installed.</p>
<p>Another critical component in the architecture is handling new files from the remote repository and integrating them into the website structure. This element is in charge of moving the piece from one part of the system to another. Moreover, it will have to ensure the paths are consistent and fail if not.</p>
<p>The last item must push the code to a specific Git repository because we decided to use <code>GitHub Pages</code> to store the website. To avoid issues with account management, it needs <code>ssh</code> to get access to a specific repository.</p>
<p>In the end, the pipeline design would look like this:
<span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 379px; ">
      <a href="https://tarides.com/static/6f25d575c0b498df6b0b07fe910849cc/811d1/pipeline.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 128.82352941176472%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEEElEQVR42pVWC1MaSRDm71+i0UtilGi0orkz6kUvdZW68nyEEFC0xAfCIiAEFNhdNjz2weKys/vddcMSzZkrb6u6+uueb3qZ7flmCPkYPGXHQdQwkLBt7He7SPR6I7zX7WLftjnes6xBzrI4jpomKjc3XMPzPBEKCmZubjAtSXh6cICFQgHPk0mMf/6MmVQKY9EowufnjMMUf/qEib095i7V68j0elxD3C54bttYqFaxUCxi8eoKrwoFzF5cYK5QwDzlKpVvY/k84/lCAa9lGWnb/nfBjhC47vdRFwI110Xd8xgrnoeSZaFoGFB8n8fk4Zg8nENzR0vGfzy+P3hdS9PwVVXv5H7AFyHh+zCEgOn70D2PrRN4IUCLOSsW2ezhSgJOwDM8D6bnwaVfSMl1TcNatYp1VcVGo4H3zSYb4fVGA79rGtv7VotzG6p6h7Ohafij00Gr3x8U/KVaxaPdXTyJxTCVTOLp4SEe7ezgSTzOnab8z4kEXpye4nEkghfHx5igsWiUY5rzrtlEkwrqQmBT17FjWdg2TWwbBv7SdTaOTRObnQ7blmGMcoS3dB1bt3DHdQdd7vv+veZ4Hqh/bV1Hs91mTLn7uO7/6fJ1pYKrcvlhXTaFQLrXw4XrIus4yN7cIBdgx0FeCMTqdbaC543y2X7/mzkOpF4PBi1ZFQKLtRqmTk8RliSEs1lMHh6yOl5ms+xJFS8lCVOpFKbOzjj/7OQEM+k0WziTwbKmQXYcEVJcF78qCqaJfHyM+ctLPCdfKGAul2M/m81yjl5IhV/lcsynQjQWTqexrKpQqMu0ZNIx/XTJcfiQyLouY4lwv48Tw8CpaY4+ixQsebh8nhcs+SFN0XUd7VbrblPuaQ43xfN9kPzcWz6wvucxMZvPI5vLMaac+x2P5wID6SUtCx+aTWzTZu50Bhu73Wa/RbGu44Om4U/i0MamzUzcdnvE27UsbBoGkqYpQnHbxlg8jrGPH1lOs5KEiVgMk/v7mD454RxJjzwdsiRBOmBnzs44xxKMRDBfKiFuWSIUN028VVWs1mpYlWWsEVYUrNRqjNcUBav1OlbqdbxrNAaxLOO3RoM98ZYrFaw0GogZhgh1g+PH99mCo4hjz4MFoGGaUHSdccC9PScwa9TlH8gp6Kgqy5BrtYdJT6MjXQiQYuQhJlOG8VcAR+UyG2ESAnHJK0OeMrwSGrSx6RokRSwWi3jz5QvelMtYKpfx+vKSbZm+0fU13tZqPDaXyWD+4gKLpRIW8nkslUqcJ6VE6RtGDANT6TRfiyyvTIYl+FMkgvF4HNPn53hGh+7REUtunA7bgwNMJhI8RvHjaBRzpRIiVDBl24h1uzgYXuR0iX9/0SdujQX5xPDyD/4AxLtdpP7ZNn8D7kZuwOCbyBYAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/6f25d575c0b498df6b0b07fe910849cc/811d1/pipeline.png" class="gatsby-resp-image-image" alt="Pipeline" title="" srcset="/static/6f25d575c0b498df6b0b07fe910849cc/04472/pipeline.png 170w,
/static/6f25d575c0b498df6b0b07fe910849cc/9f933/pipeline.png 340w,
/static/6f25d575c0b498df6b0b07fe910849cc/811d1/pipeline.png 379w" sizes="(max-width: 379px) 100vw, 379px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>Now that we have our workflow let's see how it is implemented in practice!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#this-is-how-we-do-it" aria-label="this is how we do it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>This is How We Do It</h2>
<p>In this section, we will focus on the way to implement this infrastructure. We won't view all the elements in detail, but we will try to concentrate on the most important ones, like how to create a custom <code>ocurrent</code> component and chain them together to build a pipeline.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#current_github" aria-label="current_github permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>current_github</code></h3>
<p>Let's focus on a standard structure in an OCurrent project: the way to get the HEAD of a branch on GitHub and fetch the commit with Git. In the related code, we find the HEAD, then ask GitHub to give us information about the HEAD commit on the default branch and finally get the content with Git (it returns the related commit):</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> fetch_commit <span class="token label property">~github</span> <span class="token label property">~repo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> head <span class="token operator">=</span> Current_github<span class="token punctuation">.</span>API<span class="token punctuation">.</span>head_commit GitHub repo <span class="token keyword">in</span>
  <span class="token keyword">let</span> commit_id <span class="token operator">=</span>
    Current<span class="token punctuation">.</span>map Current_github<span class="token punctuation">.</span>Api<span class="token punctuation">.</span>Commit<span class="token punctuation">.</span>id head
  <span class="token keyword">in</span>
  <span class="token keyword">let</span> commit <span class="token operator">=</span>
    Current_git<span class="token punctuation">.</span>fetch commit_id
  <span class="token keyword">in</span>
  commit

<span class="token keyword">let</span> main <span class="token operator">=</span>
  <span class="token keyword">let</span> github <span class="token operator">=</span> <span class="token comment">(* GitHub App code *)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> commit <span class="token operator">=</span> fetch_commit <span class="token label property">~github</span> <span class="token label property">~repo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token comment">(* Use the commit code *)</span></code></pre></div>
<p>The documentation of <code>current_github</code> and <code>current_git</code> is available <a href="https://www.ocurrent.org/ocurrent/">online</a>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#fetching-the-files" aria-label="fetching the files permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fetching the Files</h3>
<p>As we know how to extract data from GitHub, applying the process to various repositories will be easy. It can be noticed that the <code>commit</code> element is of type <code>Commit.t Current.t</code>. To work with <code>Current.t</code>, we need to &quot;unwrap&quot; the object with specific functions like <code>map</code> and <code>bind</code>. This post does not present how to load the content from a <code>Yaml</code> file. We assume that we get a <code>selection list Current.t</code>, where <code>selection</code> is defined as:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> selection <span class="token operator">=</span> <span class="token punctuation">{</span>
  repo <span class="token punctuation">:</span> string<span class="token punctuation">;</span>
  commit <span class="token punctuation">:</span> Current_git<span class="token punctuation">.</span>Commit<span class="token punctuation">.</span>t Current<span class="token punctuation">.</span>t<span class="token punctuation">;</span>
  files <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>It contains the source repository, the commit associated with the specified branch, and the list of files to monitor from this repository.</p>
<p>To <code>git clone</code> the content, we must apply the <code>fetch_commit</code> function.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#copy-the-content" aria-label="copy the content permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Copy the Content</h3>
<p>In this subsection, we will see how we can define a custom component and how to make it interact with the rest of our code.</p>
<p>The component is in charge of fetching the content of the files from the source directory and storing it in memory. To trigger the action only when the content changes, we will define a <code>Current_cache</code> element. Thanks to OCurrent, the content is cached and only rebuilt on change or request.</p>
<p>It manipulates some <code>File.info</code> (source, destination, &hellip;) and produces a <code>File.t</code> when the content is read. <code>File.t</code> is simply a:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> File<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token punctuation">{</span>
  metadata<span class="token punctuation">:</span> File<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
  content<span class="token punctuation">:</span> string list<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Our file is represented as a <code>string list</code>, as we need to be able to add more information. We know the size of the files is limited, so it is not an issue for us.
The component is defined as a <code>Current_cache.BUILDER</code> with whom the signature looks like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> <span class="token keyword">type</span> BUILDER <span class="token operator">=</span> <span class="token keyword">sig</span>

<span class="token keyword">type</span> context

<span class="token keyword">module</span> Key <span class="token punctuation">:</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> t
  <span class="token keyword">val</span> digest<span class="token punctuation">:</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> Value <span class="token punctuation">:</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> t
  <span class="token keyword">val</span> marshall <span class="token punctuation">:</span> t <span class="token operator">-&gt;</span> string
  <span class="token keyword">val</span> unmarshall <span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> t
<span class="token keyword">end</span>

<span class="token keyword">val</span> build <span class="token punctuation">:</span>
  context <span class="token operator">-&gt;</span>
  Current<span class="token punctuation">.</span>Job<span class="token punctuation">.</span>t <span class="token operator">-&gt;</span>
  Key<span class="token punctuation">.</span>t <span class="token operator">-&gt;</span>
  Value<span class="token punctuation">.</span>t Current<span class="token punctuation">.</span>or_error Lwt<span class="token punctuation">.</span>t
<span class="token keyword">end</span></code></pre></div>
<p>As the <code>Value</code> and the <code>Key</code> modules only use functions to manipulate <code>JSON</code>, we can focus on the <code>build</code> function definition:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> build files job <span class="token punctuation">{</span> Key<span class="token punctuation">.</span>commit<span class="token punctuation">;</span> Key<span class="token punctuation">.</span>repo<span class="token punctuation">;</span> <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  Current<span class="token punctuation">.</span>Job<span class="token punctuation">.</span>start job <span class="token label property">~level</span><span class="token punctuation">:</span>Current<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>Average <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  Current_git<span class="token punctuation">.</span>with_checkout <span class="token label property">~job</span> commit <span class="token operator">@@</span> <span class="token keyword">fun</span> dir <span class="token operator">-&gt;</span>
  extract <span class="token label property">~job</span> <span class="token label property">~dir</span> repo files
  <span class="token operator">&gt;&gt;=</span> Lwt_result<span class="token punctuation">.</span>return</code></pre></div>
<p>It creates a temporary directory with the content fetched from Git. Then, it extracts the data as a <code>File.t</code> and returns the result. The interesting detail here is <code>Current_git.with_checkout fn</code>. It is used to copy our code somewhere in the system temporarily. <code>Current.Job.start</code> is just some boilerplate code to start a job asynchronously.</p>
<p>Consequently, we can give the builder a functor to construct our cache system. Moreover, we create a function associated with it thanks to the <code>Content</code> module newly created:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> Content <span class="token operator">=</span> Current_cache<span class="token punctuation">.</span>Make <span class="token punctuation">(</span>Content<span class="token punctuation">)</span>

<span class="token keyword">let</span> weekly <span class="token operator">=</span> Current_cache<span class="token punctuation">.</span>Schedule<span class="token punctuation">.</span>v <span class="token label property">~valid_for</span><span class="token punctuation">:</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span>of_day <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> fetch <span class="token label property">~repo</span> <span class="token operator">~</span> commit files <span class="token operator">=</span>
  Current<span class="token punctuation">.</span>component <span class="token string">&quot;fetch-doc&quot;</span> <span class="token operator">|&gt;</span>
  <span class="token keyword">let</span><span class="token operator">&gt;</span> commit <span class="token operator">=</span> commit <span class="token keyword">in</span>
  Content<span class="token punctuation">.</span>get <span class="token label property">~schedule</span><span class="token punctuation">:</span>weekly files
    <span class="token punctuation">{</span>content<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>repo<span class="token punctuation">;</span> Content<span class="token punctuation">.</span>Key<span class="token punctuation">.</span>commit <span class="token punctuation">}</span></code></pre></div>
<p>We specify the date when the cache is invalidated to trigger the rebuild at least every week.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#build--deploy" aria-label="build  deploy permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Build &amp; Deploy</h3>
<p>In this last subsection, we discuss how to write all the files stored in the cache to the right place in the filesystem. We use <code>hugo</code> to build the website and <code>git</code> with <code>ssh</code> to deploy it. As we expect the information to be cached, we build a <code>Current_cache</code> module again, where the <code>build</code> function is:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> build <span class="token punctuation">{</span> files<span class="token punctuation">;</span> indexes<span class="token punctuation">;</span> conf <span class="token punctuation">}</span> job <span class="token punctuation">{</span> Key<span class="token punctuation">.</span>commit<span class="token punctuation">;</span> <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  Current<span class="token punctuation">.</span>Job<span class="token punctuation">.</span>start job <span class="token label property">~level</span><span class="token punctuation">:</span>Current<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>Average <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  Current_git<span class="token punctuation">.</span>with_checkout <span class="token label property">~job</span> commit <span class="token operator">@@</span> <span class="token keyword">fun</span> dir <span class="token operator">-&gt;</span>
  write_all job dir files indexes <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  Lwt_result<span class="token punctuation">.</span>bind <span class="token punctuation">(</span>hugo <span class="token label property">~cwd</span><span class="token punctuation">:</span>dir job<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
      <span class="token keyword">let</span> f cwd <span class="token operator">=</span>
        <span class="token keyword">let</span> commit <span class="token operator">=</span> Current_git<span class="token punctuation">.</span>Commit<span class="token punctuation">.</span>hash commit <span class="token keyword">in</span>
        deploy_over_git <span class="token label property">~cwd</span> <span class="token label property">~job</span> <span class="token label property">~conf</span> dir commit
      <span class="token keyword">in</span>
      Current<span class="token punctuation">.</span>Process<span class="token punctuation">.</span>with_tmpdir f<span class="token punctuation">)</span></code></pre></div>
<p>In this context, the pipeline creates an <code>indexes</code> file as <code>_index.md</code>. It's used by Hugo to build the directory structure. This function uses the same <code>Current_git.checkout</code> process to create a temporary directory containing the website's skeleton. All the work is done in the <code>deploy_over_git</code> function, but this is not relevant to go further in detail. The component writes all the <code>File.t.content</code> to the destination specified in their metadata. Once we have successfully written them, we generate the website with <code>hugo --minify --output-dir=public/</code>. Last but not least, we copy the content of the <code>public</code> repository to a fresh temporary one, so we can add the files with a <code>git init</code> and push our work to GitHub. Finally, on the target repository, GitHub Pages will deploy the website.</p>
<p>And voila, our website is up-to-date and online!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#happy-together" aria-label="happy together permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Happy Together</h2>
<p>This blog post has described how we handle our distributed documentation and centralise it on our website. We have seen how to use some <code>Current_*</code> plugins and how to write our own. It was also the occasion to speak about various OCurrent structures.</p>
<p>If you are curious, you can check the code in the <a href="https://github.com/ocurrent/ocurrent.org">ocurrent/ocurrent.org</a> repository. Feel free to look at the <a href="https://ocurrent.org">ocurrent.org</a> built with this pipeline. The description of the pipeline is also available in the <a href="https://github.com/ocurrent/ocurrent.org/tree/master/bin">bin</a> repository.</p>
