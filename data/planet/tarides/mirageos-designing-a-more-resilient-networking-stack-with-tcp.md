---
title: "MirageOS: Designing a More Resilient Networking Stack With \xB5TCP"
description: "There is no room for complacency in software development! In the OCaml
  ecosystem, improvements are continuously introduced to optimise\u2026"
url: https://tarides.com/blog/2024-01-24-mirageos-designing-a-more-resilient-networking-stack-with-tcp
date: 2024-01-24T00:00:00-00:00
preview_image: https://tarides.com/static/ab6bfb1e10da8c94b8c319acadb93d55/eee8e/lightflow.jpg
authors:
- Tarides
source:
---

<p>There is no room for complacency in software development! In the <a href="https://ocaml.org/">OCaml</a> ecosystem, improvements are continuously introduced to optimise existing workflows, introduce new features, and boost performance.</p>
<p><a href="https://mirage.io/">MirageOS</a> is a toolchain for creating unikernels (very small images that embed both an application and the OS components needed to run it) from several libraries written in OCaml. It allows users to create robust, fast, and secure applications.</p>
<p>We invest in the development of MirageOS, supporting great work both internally and at other organisations. One of these projects is <a href="https://hannes.robur.coop/About">Hannes Mehnert&rsquo;s</a> work at <a href="https://robur.coop/Home">Robur</a>, developing an updated <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Transmission Control Protocol</a> (TCP) for MirageOS.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#networking-in-mirageos" aria-label="networking in mirageos permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Networking in MirageOS</h2>
<p>Historically, much work has gone into implementing a complete network stack native to MirageOS. Getting networking right without relying on the Linux stack and in a <a href="https://tarides.com/blog/2023-12-14-ocaml-memory-safety-and-beyond/">safe language like OCaml</a> is tremendously important for a tool that aims to build unikernels deployed in a cloud environment. Good network management is paramount for applications with large user bases. Over time, developers have written multiple libraries for MirageOS to handle every layer of the networking stack, from Ethernet to HTTP.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#tcp" aria-label="tcp permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TCP</h2>
<p>The TCP protocol, described in <a href="https://hannes.robur.coop/Posts/TCP-ns">Hannes's recent blog post</a>, is a protocol that is a fundamental building block for most of the higher-level protocols and applications. Its role is to handle reliable data delivery from one point to the other so that the rest of the stack can focus on the actual content of that data. The protocol is specified in English in a series of RFCs, and a variety of implementations exist for this specification, with potentially different behaviours depending on their interpretation of (or even compliance with) the specification. This means that TCP traffic in the wild is not uniform, and coping with it means accepting a broad interpretation of the specification and recovering gracefully from non-complying traffic.</p>
<p>The historical library that implements TCP in MirageOS is the widely used <a href="https://github.com/mirage/mirage-tcpip">mirage-tcpip</a>. <code>Mirage-tcpip</code> is used by thousands of developers every single day in <a href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a>, where it handles traffic between container and host. While it usually works well under controlled circumstances (well-formed traffic, local networks), this library has some issues that are not easily solved, which Hannes describes in his post (memory leakage, low tolerance to non-ideal traffic, etc).</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#%C2%B5tcp-and-formal-methods" aria-label="&micro;tcp and formal methods permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://github.com/robur-coop/utcp">&micro;TCP</a> and Formal Methods</h2>
<p>As part of our mission to build robust and secure systems, we strive to support technology that roots its design in the field of <a href="https://en.wikipedia.org/wiki/Formal_methods">formal methods</a>, a variety of techniques, tools and approaches which provide a rigorous framework for the specification and implementation of software. HOL4 is one such tool, allowing users to formally specify and prove theorems. It can be used as a foundation to define complex specifications that can then serve as a reference to test or prove compliance with implementations.</p>
<p>Peter Sewell et al. used HOL4 to build a semantic model of the TCP specification (by describing the byte-stream service provided to users) that could cope with diverse complying implementations of TCP, as checked by testing it against real traffic. That same model is what Hannes is using to derive an OCaml implementation usable by MirageOS, called &micro;TCP. While there is no formal link between the model and the implementation (the work is primarily manual, and the transposition is not always 1:1), it is a perfect opportunity for a new TCP implementation that copes with more realistic traffic by design, and may avoid some of the other problems of <code>mirage-tcpip</code> such as memory leaks and performance limitations. Eventually, it may become a suitable replacement for <code>mirage-tpcip</code> within MirageOS, where the change should be seamless thanks to the abstract TCP interface of MirageOS.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#next-steps" aria-label="next steps permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Next Steps</h2>
<p>Keep an eye out for updates from Hannes and Robur, as they will be testing &micro;TCP more to get it ready for public release. The team appreciates feedback, so please check out &micro;TCP on your own and report on your experience <a href="https://github.com/robur-coop/utcp">in the repo</a>. We are thrilled to see improved features for MirageOS, and hopefully it will bring even more users to the ecosystem.</p>
<p>You can also follow us on <a href="https://twitter.com/tarides_">X</a> (formerly known as Twitter) and <a href="https://www.linkedin.com/company/tarides">LinkedIN</a> to keep up with our projects. We would <a href="https://tarides.com/contact/">love to discuss</a> how MirageOS can benefit you in your projects!</p>
