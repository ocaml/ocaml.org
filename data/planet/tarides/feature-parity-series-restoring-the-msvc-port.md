---
title: 'Feature Parity Series: Restoring the MSVC Port'
description: Discover everything that went into bringing MSVC support to OCaml 5 including
  C11 atomics, bug reports, winpthreads, and CI updates.
url: https://tarides.com/blog/2025-04-23-feature-parity-series-restoring-the-msvc-port
date: 2025-04-23T00:00:00-00:00
preview_image: https://tarides.com/blog/images/manycomputers-1360w.webp
authors:
- Tarides
source:
---

<p>After the release of OCaml 5, restoring any features that were left out of the initial release has been a high priority for our teams and collaborators. We call this effort our 'feature parity' project, and <a href="https://tarides.com/blog/2024-09-11-feature-parity-series-compaction-is-back/">compaction</a> is one example of a feature being brought back to OCaml 5 under its banner.</p>
<p>In this post, we look at another returning property, MSVC support, and the steps along the path to implementation. If you want to skip straight to the code, check out the <a href="https://github.com/ocaml/ocaml/pull/12954">#12954 pull request</a> (and the dozen more linked from it!) in the OCaml repo. Let's dive in!</p>
<h2>MSVC Support for OCaml on Windows</h2>
<p>First, let's explain what 'MSVC support' means. In general, OCaml supports compilation to Windows through three separate toolchains: <a href="https://www.cygwin.com/">Cygwin</a>, <a href="https://www.mingw-w64.org/">mingw-w64</a>, and <a href="https://visualstudio.microsoft.com/vs/features/cplusplus/">MSVC</a>. The <code>mingw-w64</code> toolchain was available for OCaml 5 from the moment the update launched. Cygwin was restored in OCaml 5.1, but MSVC support has lagged behind until now!</p>
<p>The delay stemmed from MSVC's initial incompatibility with C11 atomics, which the OCaml 5 runtime requires. David Allsopp had been exploring possible ways to overcome this incompatibility, testing how C++ atomics worked with older compilers. Eventually, however, Microsoft introduced support, albeit experimentally.</p>
<p>To restore the port, the team needed to ensure that the C11 atomics support was reliable, port <code>winpthreads</code> onto MSVC, and create a continuous integration (CI) workflow.</p>
<p>Since it is Microsoft's own C/C++ compiler, MSVC is popular and well-known to many developers and Windows users. Bringing compatibility with the compiler to OCaml 5 is an important step towards enabling more users to adopt the latest version of OCaml and explore its new features!</p>
<h3>C11 Atomics and Bug Reports</h3>
<p><a href="https://en.cppreference.com/w/c/11">C11</a> is a version of the C standard. Since the OCaml runtime is written almost entirely in C, the general standard lets us specify which properties of the C compiler can be used to build OCaml. If we didn't rely on a standard, we would have to list supported C compiler versions individually (GCC from one such version, Clang from another such version, etc). Instead, developers know that the OCaml runtime environment supports any C compiler that is C11-compliant.</p>
<p>For OCaml 5 and onwards, the C compiler must be C11 compliant and support C11 atomics.  All we need to know about atomics for this post is that the C11 atomic spec enables the compiler to help the programmer access data that can be shared between multiple cores. Without it, the developer would need to use other synchronisation mechanisms such as mutexes, that require more code, both to write and to run. So C11 atomics go beyond what most of us associate with atomicity and are key to writing sound and efficient code in a multicore setting.</p>
<p>Once the <a href="https://learn.microsoft.com/en-gb/visualstudio/releases/2022/release-notes">Visual Studio 2022</a> release introduced experimental support for C11 atomics, it provided a much clearer path for the team to work on restoring MSVC support. This team included David Allsopp, Antonin DÃ©cimo, and Samuel Hym from Tarides, but of course, the success of the project relied on the collaboration, input, and reviews of many open-source OCaml community members. With C11 atomics support in Visual Studio 2022 being experimental, the team needed to ensure that all the sequential tests passed and identify places where parallel tests failed due to bugs in MSVC. The team created several bug reports against the MSVC compiler as a result of this project.</p>
<p>The bug reports include:</p>
<ul>
<li><strong><a href="https://developercommunity.visualstudio.com/t/C11-atomics-Pointers-to-atomic-values-/10507360">Missing Atomic Stores When Dereferencing Pointer to Atomics</a>:</strong> MSVC version 19.38.33128 lacked support for pointers to atomic values and was not emitting atomic stores when writing to a dereferenced pointer for an atomic variable.</li>
<li><strong><a href="https://developercommunity.visualstudio.com/t/C11-atomics-Compound-assignment-operat/10507357">Compound Assignment Operators are not Atomics on Pointers to Atomic Values</a>:</strong> Again, MSVC 19.38.33128 lacked support for pointers to atomic values, and this bug report highlighted that MSVC did not generate atomic code for compound assignment operators with a pointer to an atomic value.</li>
<li><strong><a href="https://developercommunity.visualstudio.com/t/C11-atomics:-Missing-atomic-stores-whe/10507356">Pointers to Atomic Values Should be Reloaded</a>:</strong> In version 19.38.33128 MSVC failed to generate atomic code, meaning that pointers were not reloaded when they needed to be, causing threads to spin indefinitely.</li>
</ul>
<p>Thanks to great support from Microsoft, these bugs were resolved, and C11 atomics support was satisfactory to enable MSVC support for multicore OCaml. This was the biggest roadblock to the project's success, and with it cleared, the team turned their attention to new challenges.</p>
<h3>Winpthreads and MSVC</h3>
<p>The next hurdle on the road to success was another Windows-specific compatibility issue. OCaml 4.* had limited support for threading in the form of the optional systhread library, but the runtime itself made no use of it. That completely changed with OCaml 5! The abstraction used to enable threading support was Unix's <code>posix</code> threads, known as 'pthreads'. At the time, the runtime was prepared in the hope that a Windows version could be implemented in the future.</p>
<p>However, the original multicore PR could use the <code>winpthreads</code> part of the <code>mingw-w64</code> library to provide a <code>pthread</code> implementation for the Windows MinGW port. The intention then was that it would be a temporary workaround allowing all the existing <code>pthreads</code> code to be reused, partly due to the belief that it would only work for <code>mingw-w64</code> and not for MSVC.</p>
<p>Upon further investigation, David discovered a <a href="https://github.com/sgeto/winpthreads-msvc">library</a> demonstrating that <code>winpthreads</code> could be compiled with MSVC without introducing too many dependencies. Samuel and Antonin worked on formalising the process of extracting the <code>winpthreads</code> sources from the <code>mingw-w64</code> project to use them for the MSVC port. Antonin also <a href="https://github.com/MisterDA/mingw-w64">contributed directly</a> to the <code>mingw-w64</code> project to patch its <code>winpthreads</code> component.</p>
<p>Thanks to this work, the initially temporary <code>winpthreads</code> workaround has been implemented as a submodule for MSVC. This lets the new MSVC port use <code>pthread.h</code> via the <code>winpthreads</code> submodule (instead of using winpthreads implicitly as provided by the <code>mingw-w64</code> GCC compiler).</p>
<p>The future of pthreads in OCaml is still up for discussion, with one school of thought being that reimplementing OCaml's use of pthreads in a more abstract way would allow its primitives to function without the full weight of the <a href="https://posix.opengroup.org/">POSIX</a> spec, resulting in better performance. Work has started to <a href="https://github.com/ocaml/ocaml/pull/13416">remove winpthreads and use modern Windows APIs for the MSVC and MinGW-w64 ports</a>.</p>
<h3>CI</h3>
<p>Finally, the team <a href="https://github.com/ocaml/ocaml/pull/12954/commits/23a3209278b3f9d6b1c68a08d735086c250d3c93">added a continuous integration workflow</a> enabling <a href="https://github.com/features/actions">GitHub Actions</a> for MSVC testing.</p>
<p>As most OCaml compiler developers use a different port than MSVC, and since there are many differences between MSVC and the other ports, being able to test MSVC in CI helps the developer be confident that their modifications do not break the code. In particular, part of the CI workflow includes a check to make sure the assembly used in the MSVC port (meaning that it's written in MASM syntax) is kept consistent with the assembly used in the MinGW port (written in GNU Assembler syntax). This check has already allowed OCaml core developers to catch a few PRs that only updated the assembler in GNU syntax, catching a problem early and preventing it from affecting the program.</p>
<h2>A Note on the Unloadable Runtime</h2>
<p>Before we leave you, let's briefly review another feature parity project, the return of the unloadable runtime. This project was paired with the return of the MSVC port as two features that were important to the community. The 'unloadable runtime' is a feature that cleans up OCaml resources, including the stack, heap sections, code fragments, buffers, tables, and more, when OCaml is used as a shared library. For example, if a host program uses OCaml as a library, when control returns to the host program, the unloadable runtime ensures proper resource cleanup.</p>
<p>The return of this feature was <a href="https://github.com/ocaml/ocaml/issues/10865#issuecomment-1559741460">requested by the community</a>, and our team worked hard to make the restoration a reality. The PR associated with this effort is <a href="https://github.com/ocaml/ocaml/pull/12964">#12964</a>, which you can check out to learn more about the process behind the changes. The PR has been merged and is expected to be released with the 5.4 update.</p>
<h2>Stay in Touch!</h2>
<p>Keep an eye out for future updates on restored features on our blog. For a broader overview of the 5.3 update, you can check out our <a href="https://tarides.com/blog/2025-01-09-ocaml-5-3-features-and-fixes/">release blog post</a> covering the changes.</p>
<p>You can connect with us on <a href="https://bsky.app/profile/tarides.com">Bluesky</a>, <a href="https://mastodon.social/@tarides">Mastodon</a>, <a href="https://www.threads.net/@taridesltd">Threads</a>, and <a href="https://www.linkedin.com/company/tarides">LinkedIn</a> or sign up for our mailing list to stay updated on our latest projects. We look forward to hearing from you!</p>

