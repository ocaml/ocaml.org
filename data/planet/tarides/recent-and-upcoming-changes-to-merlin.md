---
title: Recent and upcoming changes to Merlin
description: "Merlin is a language server for the OCaml programming language; that
  is, a daemon\nthat connects to your favourite text editor and provides\u2026"
url: https://tarides.com/blog/2021-01-26-recent-and-upcoming-changes-to-merlin
date: 2021-01-26T00:00:00-00:00
preview_image: https://tarides.com/static/1d86af9747be51519d2c89b476b5b306/0132d/camelgicien.jpg
featured:
---

<p>Merlin is a language server for the OCaml programming language; that is, a daemon
that connects to your favourite text editor and provides the usual services of
an IDE: instant feedback on warnings and errors, autocompletion, &quot;type of the
code under the cursor&quot;, &quot;go to definition&quot;, etc. As we (Fr&eacute;d&eacute;ric Bour, Ulysse
G&eacute;rard and I) are about to do a new major release, we thought now would be a
good time to talk a bit about some of the changes that are going into this
release.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#project-configuration" aria-label="project configuration permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Project configuration</h2>
<p>Since its very first release, merlin has been getting information about the
project being worked on through a <code>.merlin</code> file, which used to be written by
the user, but is now often generated by build systems.</p>
<p>This had the advantage of being fairly simple: Merlin would just look in the
current directory if such a file existed, otherwise it would look in the parent
directories until it found one; and then read it. But there were also some
sore points: the granularity of the configuration is the directory not the file,
and this information is duplicated from the build system configuration (be it
dune, Makefiles, or, back in the days, ocamlbuild).</p>
<p>After years of thinking about it, we've finally decided to make some light
changes to this process. Since version 3.4, when it scans the filesystem Merlin
is now looking for either a <code>.merlin</code> file or a dune (or dune-project) file. And
when it finds one of those, it starts an external process in the directory where
that file lives, and asks that process for the configuration of the ml(i) file
being edited.</p>
<p>The process in charge of communicating the configuration to Merlin will either
be a specific dune subcommand (when a dune file is found), or a dedicated
<code>.merlin</code> reader program.</p>
<p>We see several advantages in doing things this way (rather than, for instance,
changing the format of <code>.merlin</code> files):</p>
<ol>
<li>this change is entirely backward compatible, and indeed the transition has
already happened silently; although dune is still emitting <code>.merlin</code> files,
this will only stop with dune 2.8.</li>
<li>externalizing the reading of <code>.merlin</code> files and simply requiring a
&quot;normalized&quot; version of the config (i.e. with no mention of packages, just of
flags and paths) allowed us to simplify the internals of Merlin.</li>
<li>talking to the build system directly not only gets us a much finer grained
configuration (which is important when you build different executables with
different flags in the same directory, or if you apply different ppxes to
different files of a library), it opens the door to getting a nicer behavior
of Merlin in some circumstances. For instance, the build system can (and
does) tell Merlin when the project isn't built. Currently we only report that
information to the user when he asks for errors, alongside all the other
(mostly rubbish) errors. Which is already helpful in itself. But in the
future we can start filtering the other errors to only report those that
would remain even after building the project (e.g. parse errors).</li>
</ol>
<p>There are however some changes to look out for:</p>
<ul>
<li>people who still use <code>.merlin</code> files but do not install Merlin using opam need
to make sure to also have the <code>dot-merlin-reader</code> binary in their PATH (it is
available as an opam package, but is also buildable from Merlin's git
repository)</li>
<li>vim and emacs users who could previously load packages interactively (by
calling <code>M-x merlin-use</code> or <code>:MerlinUse</code>) cannot do that anymore, since Merlin
itself stopped linking with findlib. They'll have to write a <code>.merlin</code> file.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#dropping-support-for-old-versions-of-ocaml" aria-label="dropping support for old versions of ocaml permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dropping support for old versions of OCaml</h2>
<p>Until now, every release of Merlin has kept support from OCaml 4.02 to the
latest version of OCaml available at the time of that release.</p>
<p>We have done this by having one version of &quot;<em>the frontend</em>&quot; (i.e. handling of
buffer state, project configuration; analyses like <em>jump-to-definition</em>,
<em>prefix-completion</em>, etc.), but several versions of &quot;<em>the backend</em>&quot; (OCaml's
ASTs, parser and typechecker), and choosing at build time which one to use.
The reason for doing this instead of having, for instance, one branch of Merlin
per version of OCaml, is that while the backends are fairly stable once
released, Merlin's frontend keeps evolving. Having just one version of it makes
it easier to add features and fix bugs (patches don't need to be duplicated),
whilst ensuring that Merlin's behavior is consistent across every version of
OCaml that we support.</p>
<p>For this to work however, one needs a well defined API between the frontend and
all the versions of the backend. This implies mapping every versions of OCaml's
internal ASTs (which receive modifications from one version to the next), to a
unified one, so as to keep Merlin's various features version agnostic. But it
also means being resilient to OCaml's internal API changes. For instance between
4.02 and 4.11 there were big refactorings impacting: the way one accesses the
typing environment, the way one accesses the &quot;load path&quot; (the part of the file
system the compiler/Merlin is aware of), the way error message are produced, ...</p>
<p>The rate of changes on the compiler is a lot higher than what it was when we
first started Merlin (7 years ago now!) which doesn't just mean that we have to
spend more and more time on updating the common interface, but also that the
interface is getting harder to define. Recently (with the 4.11 release) some of
the changes were significant enough that for some parts of the backend we just
didn't manage to produce a single interface to access old and new versions, so
instead we had to start duplicating and specializing parts of the frontend.
And we don't expect things to get much better in the near future.</p>
<p>Furthermore, Merlin's backends are patched to be more resilient to parsing and
typing errors in the user's code. Those patches also need to be evolved at each
new release of the compiler.
The work required to keep the &quot;unified interface&quot; working was taking time away
from updating our patches properly, and our support of user errors has slowly
been getting worse over the past few years, resulting in less precise type
information when asked, incomplete results when asking for auto-completion, etc.</p>
<p>Therefore we have decided to stop dragging older versions of OCaml along. We
plan to switch to a system where we have one branch of Merlin per version of
OCaml, and each opam release of Merlin will only be buildable with one version
of OCaml. We will keep maintaining all the relatively recent branches (that is:
4.02 definitely will not get fixes, but 4.06 is still in the clear). However,
all the new features will be developed against the latest version of OCaml and
cherry-picked to older branches if, and only if, there are no merge conflicts
and they work as expected without changes.</p>
<p>We hope that this will make it easier for us to update to new versions of OCaml
(actually, we already know it does, working on adding support for 4.12 was
easier than for any of the other recent versions), will allow us to clean up
Merlin's codebase (let's call that a work in progress), and will free some time
to work on new features.</p>
<p>You might wonder what all this changes for you, as a user, in practice. Well, it
depends:</p>
<ul>
<li>if you install Merlin from opam: nothing, or almost nothing. Everything that
you currently do with Merlin will keep working. In the future, perhaps some
new feature will appear that won't work on all versions. But that day hasn't
come yet.</li>
<li>if you install Merlin some other way (manually?): you can't just fetch master
and build it anymore. You have to pick the appropriate branch for your
version of OCaml.</li>
<li>if you're reusing Merlin's codebase as part of another project and (even
worse) have patches on it: come and talk to us if you haven't done so already!
We can try and integrate your patches, so that you only need to worry about
vendoring the right version(s) for your needs.</li>
</ul>
<hr/>
<p>Over the years, Merlin has received bugfixes and improvements from a long list of
people, but for the upcoming release Fr&eacute;d&eacute;ric and I are particularly grateful to
Rudi Grinberg, a long time and regular contributor who also maintains the OCaml
LSP project, as well as Ulysse G&eacute;rard, who joined our team a year ago now. They
are in particular the main authors of the work to improve the handling of
projects' configuration.</p>
<p>We hope you'll be as excited as us by all these changes!</p>
