---
title: 'Tutorial: Building a Browser Extension With Irmin'
description: "Irmin is a collection of OCaml libraries that makes it easy to build
  applications with Git-like data stores. We recently released irmin\u2026"
url: https://tarides.com/blog/2023-10-25-tutorial-building-a-browser-extension-with-irmin
date: 2023-10-25T00:00:00-00:00
preview_image: https://tarides.com/static/8a1986214799abe0ac1afd6b0e0aa0e2/eee8e/library.jpg
featured:
authors:
- Tarides
source:
---
    
<p><a href="https://irmin.org">Irmin</a> is a collection of OCaml libraries that makes it easy to build applications with Git-like data stores. We <a href="https://github.com/mirage/irmin/releases/tag/3.9.0">recently released</a> <code>irmin-client</code> and <code>irmin-server</code> as official Irmin packages. These packages open up a new way to use Irmin by implementing a custom protocol that lets you write a client application that can interact with a remote data store as if it is local using the <a href="https://mirage.github.io/irmin/irmin/Irmin/module-type-S/index.html">Irmin Store API</a>.</p>
<p>In addition to creating a <a href="https://github.com/mirage/irmin/tree/main/examples/server">simple example</a>, we also thought it would be fun to build a browser extension that demonstrates a real-life application of these packages and the portability of <a href="https://tarides.com/blog/2022-08-02-irmin-in-the-browser/">Irmin in the browser</a>. We created <a href="https://github.com/tarides/irmin-bookmarks"><code>irmin-bookmarks</code></a>, a browser extension for saving bookmarks in a Git repository. This post gives an overview of the project!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#creating-a-browser-extension" aria-label="creating a browser extension permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a Browser Extension</h2>
<p>At the core of a browser extension is its <code>manifest.json</code>. This is the primary metadata for the extension that tells the browser about the extension: its name, its icons, what permissions it needs, what extension features it uses, etc.</p>
<p>Here is the <a href="https://github.com/tarides/irmin-bookmarks/blob/main/extension/manifest.json"><code>manifest.json</code></a> for <code>irmin-bookmarks</code>:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;manifest_version&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Irmin Bookmarks&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Save bookmarks to a local git repository. Powered by Irmin.&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icons/icon.png&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;96&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icons/icon@2x.png&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;options_ui&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token string">&quot;options/index.html&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;tabs&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;browser_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icons/icon@2x.png&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Add bookmark!&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;popup/index.html&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We will focus on the <code>browser_action</code> key in this article, but you can read more about the keys in this file <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json">on MDN</a>. Note: this key has been renamed to <code>action</code> in version 3 of the manifest specification; we are using version 2 for the widest browser compatibility.</p>
<p>The <code>browser_action</code> key defines the look and behaviour of the button that represents our extension. We want the UI to display when our button is clicked, so we set <code>default_popup</code> to an HTML page that will display our UI for adding a bookmark.</p>
<p>The UI for adding a bookmark looks like this:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/a58fecb95084deeff8fe6652910cf6a8/59822/uiforbookmark.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 80.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACw0lEQVR42o2TzW8MYRzHH+FAIiESSREkRGqRikMPaLfSNuXgLYJ6iWjRBBdXiZPEBeEgpCeJBJH4B5w4aJSUavegXTQN23bbnd3ZmdnZed2Z/cg8266Wkn6Tb555Zp7n8zzP9/mN+JHK8DM1SWpsioJpoRvFOVbzBTKKytDwd9KTCjlVJ6capCcUXvUP0Df8HTWroesmnwaTCFU1KRhF6SAIKZWCv+w4LrpuyNbzSpRKJRzLYmQqzbiSw3N9ymGZ5LcUIq8V8P0SYRhSLpf/6UiVtoymeeRyLq4Tyrm27cnvX0fGEJbtyIERcLZmILP7M+8M3SeTcTBNnyCsnCJSb18Ckcnm/wBWJiWHh0gMJujr+0gikWBgYJDP/f3kVHXOgkEQyKgive3tR4xNKLIT5eK6ThXsuq604zjYto1l2diWJQGzFY0Ppuf0vP+MSKWz5DQT3TD4mkyiKIqEeJ5Xte/7+NPPsxeJ+lFlTGRUCpbLq9e9iGVbD1Lb3ImSVUmnJ/gy9IV8XpM7qcLmcXTjUTwPHr9kyYYGVta20HbiKkLUNFCz6yh5zUDXdYrF4pzd/ctRBJHuPnqKWLoJsaGNxlM3EGJdnLX1x5nKKIyOjqJp+vQOnGqO87loWdPAJ4gVdYiGW8S7HiHExv2sqT9JNpevhrwQR/Ungd3PEXXXEAceE7/0ECE2HWbdnvMyw3I5lNktBBhVBYTc6X6BqGlG1LbTePI6QqxvYW28C80w8TwX23bkcf/nmTKKJIFCSLe0HY4ybGLN3k5My533D5mryrfJyQw9PR/QVZX7z94gFq+WwGPtHZVLqdl9DsN0FgCsyCoWGR8bh8Dj9rN3iOWx38BFG5tZsuUgW1ovs33/Fba1XWZby0ViTWeIxU8Ti7cT23eWWNNZYo3txBpPsKO1g/oL3ew8fY9VrTcRmw9J4JHj5/kF4AtGIyY3npQAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/a58fecb95084deeff8fe6652910cf6a8/c5bb3/uiforbookmark.png" class="gatsby-resp-image-image" alt="UI for the menu of saving a bookmark in the browser, shows a pop-up card with the option to click 'save' the current webpage to bookmarks. It also lets users name and add notes to the bookmark." title="" srcset="/static/a58fecb95084deeff8fe6652910cf6a8/04472/uiforbookmark.png 170w,
/static/a58fecb95084deeff8fe6652910cf6a8/9f933/uiforbookmark.png 340w,
/static/a58fecb95084deeff8fe6652910cf6a8/c5bb3/uiforbookmark.png 680w,
/static/a58fecb95084deeff8fe6652910cf6a8/59822/uiforbookmark.png 916w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>The HTML page for the UI for adding a bookmark, <code>popup/index.html</code>, has a simple body definition:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ui<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>popup.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></code></pre></div>
<p>The UI is created and managed through <code>popup.js</code>, which is compiled from the following OCaml code to JavaScript using <a href="https://github.com/ocsigen/js_of_ocaml"><code>js_of_ocaml</code></a>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* extension/popup/popup.ml *)</span>
<span class="token keyword">open</span> Shared

<span class="token keyword">let</span> main <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">open</span> Lwt<span class="token punctuation">.</span>Syntax <span class="token keyword">in</span>
  <span class="token keyword">let</span><span class="token operator">*</span> tab <span class="token operator">=</span> Browser<span class="token punctuation">.</span>tabs <span class="token operator">|&gt;</span> Tabs<span class="token punctuation">.</span>active <span class="token keyword">in</span>
  <span class="token keyword">let</span> model <span class="token operator">=</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> Tab<span class="token punctuation">.</span>title tab <span class="token keyword">in</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> Tab<span class="token punctuation">.</span>url tab <span class="token keyword">in</span>
    <span class="token keyword">let</span> created_at <span class="token operator">=</span> Date<span class="token punctuation">.</span>now <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    Model<span class="token punctuation">.</span>v <span class="token label property">~created_at</span> <span class="token label property">~name</span> <span class="token label property">~url</span> <span class="token label property">~notes</span><span class="token punctuation">:</span><span class="token string">&quot;&quot;</span>
  <span class="token keyword">in</span>
  <span class="token keyword">let</span><span class="token operator">*</span> client <span class="token operator">=</span> Client<span class="token punctuation">.</span>connect <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  Ui<span class="token punctuation">.</span>bind client model

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Document<span class="token punctuation">.</span>on_content_loaded <span class="token operator">@@</span> <span class="token keyword">fun</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> Lwt<span class="token punctuation">.</span>async main</code></pre></div>
<p>We only need a subset of the browser and extension APIs, so we wrap what we need using <a href="https://github.com/dbuenzli/brr"><code>Brr</code></a> in <a href="https://github.com/tarides/irmin-bookmarks/blob/main/extension/shared/ext.ml">one shared file</a>. Here is a snippet from this file that shows how to bind to the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs"><code>tabs</code></a> browser extension API, as used above:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* snippet from extension/shared/ext.ml *)</span>
<span class="token keyword">module</span> Tab <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">type</span> t <span class="token operator">=</span> Jv<span class="token punctuation">.</span>t

  <span class="token keyword">let</span> title t <span class="token operator">=</span> Jv<span class="token punctuation">.</span>get t <span class="token string">&quot;title&quot;</span> <span class="token operator">|&gt;</span> Jv<span class="token punctuation">.</span>to_string
  <span class="token keyword">let</span> url t <span class="token operator">=</span> Jv<span class="token punctuation">.</span>get t <span class="token string">&quot;url&quot;</span> <span class="token operator">|&gt;</span> Jv<span class="token punctuation">.</span>to_string
<span class="token keyword">end</span>

<span class="token keyword">module</span> Browser <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">let</span> v <span class="token punctuation">:</span> Jv<span class="token punctuation">.</span>t <span class="token operator">=</span> Jv<span class="token punctuation">.</span>get Jv<span class="token punctuation">.</span>global <span class="token string">&quot;browser&quot;</span>
  <span class="token keyword">let</span> tabs <span class="token punctuation">:</span> Tabs<span class="token punctuation">.</span>t <span class="token operator">=</span> Jv<span class="token punctuation">.</span>get v <span class="token string">&quot;tabs&quot;</span>
<span class="token keyword">end</span></code></pre></div>
<p>The core UI code for the popup is in <a href="https://github.com/tarides/irmin-bookmarks/blob/main/extension/popup/ui.ml"><code>extension/popup/ui.ml</code></a>. Since our UI is not that complicated, the code implements rendering as a simple recursive function based on the state of the UI that calculates the appropriate DOM elements and replaces them as-needed in the <code>&lt;div id=&quot;ui&quot;&gt;&lt;/div&gt;</code> element of our HTML page:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* render snippet from extension/popup/ui.ml *)</span>
<span class="token keyword">let</span> <span class="token keyword">rec</span> render t <span class="token operator">=</span>
  <span class="token keyword">let</span><span class="token operator">+</span> elems <span class="token operator">=</span>
    <span class="token keyword">match</span> t <span class="token keyword">with</span>
    <span class="token operator">|</span> Disconnected e <span class="token operator">-&gt;</span> Lwt<span class="token punctuation">.</span>return <span class="token punctuation">[</span> msg <span class="token string">&quot;error&quot;</span> e <span class="token punctuation">]</span>
    <span class="token operator">|</span> Connected <span class="token punctuation">{</span> client<span class="token punctuation">;</span> model<span class="token punctuation">;</span> <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
          Lwt<span class="token punctuation">.</span>async <span class="token operator">@@</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
          <span class="token keyword">let</span><span class="token operator">*</span> model <span class="token operator">=</span>
            <span class="token keyword">let</span><span class="token operator">+</span> saved_model <span class="token operator">=</span> Client<span class="token punctuation">.</span>load client model <span class="token keyword">in</span>
            <span class="token keyword">match</span> saved_model <span class="token keyword">with</span> None <span class="token operator">-&gt;</span> model <span class="token operator">|</span> Some m <span class="token operator">-&gt;</span> m
          <span class="token keyword">in</span>
          render <span class="token punctuation">(</span>Loaded <span class="token punctuation">{</span> model<span class="token punctuation">;</span> client<span class="token punctuation">;</span> error <span class="token operator">=</span> None <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">in</span>
        Lwt<span class="token punctuation">.</span>return <span class="token punctuation">[</span> msg <span class="token string">&quot;info&quot;</span> <span class="token string">&quot;Loading...&quot;</span> <span class="token punctuation">]</span>
    <span class="token operator">|</span> Loaded <span class="token punctuation">{</span> client<span class="token punctuation">;</span> model<span class="token punctuation">;</span> error <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> ui <span class="token operator">=</span>
          header <span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">::</span> form model <span class="token punctuation">(</span><span class="token keyword">fun</span> model <span class="token operator">-&gt;</span>
                 Lwt<span class="token punctuation">.</span>async <span class="token operator">@@</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                 <span class="token keyword">let</span><span class="token operator">*</span> r <span class="token operator">=</span> Client<span class="token punctuation">.</span>save client model <span class="token keyword">in</span>
                 <span class="token keyword">match</span> r <span class="token keyword">with</span>
                 <span class="token operator">|</span> Ok <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> Window<span class="token punctuation">.</span>close <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> Lwt<span class="token punctuation">.</span>return
                 <span class="token operator">|</span> Error error <span class="token operator">-&gt;</span>
                     render <span class="token punctuation">(</span>Loaded <span class="token punctuation">{</span> error <span class="token operator">=</span> Some error<span class="token punctuation">;</span> model<span class="token punctuation">;</span> client <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">in</span>
        <span class="token punctuation">(</span><span class="token keyword">match</span> error <span class="token keyword">with</span> None <span class="token operator">-&gt;</span> ui <span class="token operator">|</span> Some err <span class="token operator">-&gt;</span> msg <span class="token string">&quot;error&quot;</span> err <span class="token punctuation">::</span> ui<span class="token punctuation">)</span>
        <span class="token operator">|&gt;</span> Lwt<span class="token punctuation">.</span>return
  <span class="token keyword">in</span>

  <span class="token keyword">let</span> ui <span class="token operator">=</span> Document<span class="token punctuation">.</span>lookup_by_id <span class="token string">&quot;ui&quot;</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> <span class="token punctuation">_</span> <span class="token operator">=</span>
    elems
    <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>map Brr<span class="token punctuation">.</span>El<span class="token punctuation">.</span>to_jv
    <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>of_list
    <span class="token operator">|&gt;</span> Jv<span class="token punctuation">.</span>call <span class="token punctuation">(</span>Brr<span class="token punctuation">.</span>El<span class="token punctuation">.</span>to_jv ui<span class="token punctuation">)</span> <span class="token string">&quot;replaceChildren&quot;</span>
  <span class="token keyword">in</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>You can see references in the extension code to <code>Model</code> and <code>Client</code>. We now turn to the core part of the extension: writing our integration with <code>irmin-client</code> and <code>irmin-server</code>!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#creating-our-client-and-server" aria-label="creating our client and server permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating Our Client and Server</h2>
<p>Like the rest of Irmin, <code>irmin-client</code> and <code>irmin-server</code> are libraries meant to be used in applications:</p>
<ul>
<li><code>irmin-server</code> lets you write a server application that exposes an Irmin store's API using a custom protocol via an HTTP or WebSocket connection.</li>
<li><code>irmin-client</code> lets you build a client application that can connect to a remote Irmin store served by <code>irmin-server</code>.</li>
</ul>
<p>The client and server are wrappers around Irmin stores, so the first step is to decide how to set up our store. When creating an Irmin store, you need to make some choices:</p>
<ul>
<li>Which Irmin backend do I want to use?</li>
<li>What is the content type for my store?</li>
</ul>
<p>For <code>irmin-bookmarks</code>, we chose to use <a href="https://mirage.github.io/irmin/irmin-git/index.html"><code>irmin-git</code></a> as our backend since we wanted our bookmarks stored in a Git repository for easy backing up and sharing to a remote Git host. Some other backends that Irmin provides are:</p>
<ul>
<li><code>irmin-fs</code> for simple filesystem-based storage</li>
<li><code>irmin-pack</code> for <a href="https://tarides.com/blog/2023-05-05-optimising-archive-node-storage-for-tezos/">optimised storage of large amounts of data</a> with features like <a href="https://tarides.com/blog/2022-11-10-towards-minimal-disk-usage-for-tezos-bakers/">garbage collection</a></li>
<li><code>irmin-mem</code> for in-memory-only storage</li>
</ul>
<p>To create our server module, we only need the following <a href="https://github.com/tarides/irmin-bookmarks/blob/90f2cbd9d04ddb3327ccf638b227521637d5799b/server/main.ml#L2-L4">three lines of code</a>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> Store <span class="token operator">=</span> Irmin_git_unix<span class="token punctuation">.</span>FS<span class="token punctuation">.</span>KV <span class="token punctuation">(</span>Model<span class="token punctuation">)</span>
<span class="token keyword">module</span> Codec <span class="token operator">=</span> Irmin_server<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span>Codec<span class="token punctuation">.</span>Bin
<span class="token keyword">module</span> Server <span class="token operator">=</span> Irmin_server_unix<span class="token punctuation">.</span>Make_ext <span class="token punctuation">(</span>Codec<span class="token punctuation">)</span> <span class="token punctuation">(</span>Store<span class="token punctuation">)</span></code></pre></div>
<p>The first line creates our Irmin store: a key-value (<code>KV</code>) store that persists to disk (<code>FS</code>) in a Git-compatible repository (<code>Irmin_git_unix</code>). We will discuss our custom content type, <code>Model</code>, later. The second line defines the wire encoding for communication between our client and server. We choose a binary encoding (<code>Codec.Bin</code>), but JSON is also available. The final line uses our codec and store to create a server that can bind to a local port for our client to connect. For the complete server binary, see <a href="https://github.com/tarides/irmin-bookmarks/blob/main/server/main.ml"><code>server/main.ml</code></a>.</p>
<p>A <a href="https://github.com/tarides/irmin-bookmarks/blob/90f2cbd9d04ddb3327ccf638b227521637d5799b/extension/shared/client.ml#L1-L9">few more lines of code</a> are required to setup our client, but not many!</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> Store <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">module</span> Git_impl <span class="token operator">=</span> Irmin_git<span class="token punctuation">.</span>Mem
  <span class="token keyword">module</span> Sync <span class="token operator">=</span> Git<span class="token punctuation">.</span>Mem<span class="token punctuation">.</span>Sync <span class="token punctuation">(</span>Git_impl<span class="token punctuation">)</span>
  <span class="token keyword">module</span> Maker <span class="token operator">=</span> Irmin_git<span class="token punctuation">.</span>KV <span class="token punctuation">(</span>Git_impl<span class="token punctuation">)</span> <span class="token punctuation">(</span>Sync<span class="token punctuation">)</span>
  <span class="token keyword">include</span> Maker<span class="token punctuation">.</span>Make <span class="token punctuation">(</span>Model<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> Codec <span class="token operator">=</span> Irmin_server<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span>Codec<span class="token punctuation">.</span>Bin
<span class="token keyword">module</span> Client <span class="token operator">=</span> Irmin_client_jsoo<span class="token punctuation">.</span>Make_codec <span class="token punctuation">(</span>Codec<span class="token punctuation">)</span> <span class="token punctuation">(</span>Store<span class="token punctuation">)</span></code></pre></div>
<p>Our client compiles to JavaScript via <code>js_of_ocaml</code> as a part of our browser extension, so our store setup looks a little different from the server. Instead of using a filesystem-backed Git repository, we use the in-memory Git implementation (<code>Irmin_git.Mem</code>). It is the same setup as our server: a key-value store backed by an in-memory Git repository. In the last line, we create our client for the browser using our code and store. Note that we use <code>Irmin_client_jsoo</code> since we are compiling for the browser (<code>jsoo</code> is shorthand for <code>js_of_ocaml</code>).</p>
<p>That's all there is to setting up the core server and client! Now let's take a look at our <code>Model</code>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#bookmark-model" aria-label="bookmark model permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bookmark Model</h3>
<p>Irmin stores support custom <a href="https://mirage.github.io/irmin/irmin/Irmin/Contents/index.html">serialisable and mergeable content types</a>. These types define not only how to encode and decode the type for persistence but also how to perform a <a href="https://mirage.github.io/irmin/irmin/Irmin/Merge/index.html">3-way merge</a> when conflicts arise. For our model, we use a simple merge algorithm of picking the &quot;latest&quot; updated one, based on a clock timestamp.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> merge_m <span class="token label property">~old</span> x y <span class="token operator">=</span>
  ignore old<span class="token punctuation">;</span>
  <span class="token comment">(* Simple merge: pick &quot;latest&quot; updated model *)</span>
  Irmin<span class="token punctuation">.</span>Merge<span class="token punctuation">.</span>ok <span class="token operator">@@</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>updated_at <span class="token operator">&gt;</span> y<span class="token punctuation">.</span>updated_at <span class="token keyword">then</span> x <span class="token keyword">else</span> y

<span class="token keyword">let</span> merge <span class="token operator">=</span> Irmin<span class="token punctuation">.</span>Merge<span class="token punctuation">.</span><span class="token punctuation">(</span>option <span class="token punctuation">(</span>v t merge_m<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>Irmin has built-in content types for strings and JSON. Since our bookmarks contain a few fields of information, and we would like a human-readable format in our repository, we use JSON for our serialisation format. The <a href="https://mirage.github.io/irmin/irmin/Irmin/Contents/Json/index.html">JSON content type</a> exposed by Irmin is low-level, so we define a module to wrap this lower level type by mapping from our custom type to Irmin's JSON type:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> t <span class="token operator">=</span> Irmin<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>map Json<span class="token punctuation">.</span>t of_json to_json</code></pre></div>
<p>You can look at <a href="https://github.com/tarides/irmin-bookmarks/blob/main/model/model.ml"><code>model.ml</code></a> to see our complete model. Here is an example of what a bookmark looks like in our repository:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span><span class="token string-property property">&quot;updated_at&quot;</span><span class="token operator">:</span><span class="token number">1696621685526</span><span class="token punctuation">,</span><span class="token string-property property">&quot;created_at&quot;</span><span class="token operator">:</span><span class="token number">1696621683493</span><span class="token punctuation">,</span><span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Tarides&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;notes&quot;</span><span class="token operator">:</span><span class="token string">&quot;Building Functional Systems&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span><span class="token string">&quot;https://tarides.com/&quot;</span><span class="token punctuation">}</span></code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#using-the-irmin-api" aria-label="using the irmin api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using the Irmin API</h3>
<p>Our client only <a href="https://github.com/tarides/irmin-bookmarks/blob/main/extension/shared/client.ml">uses a small part</a> of the Irmin store API to list, load, save, and delete our bookmarks.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> list t <span class="token operator">=</span>
  <span class="token keyword">let</span><span class="token operator">*</span> tree <span class="token operator">=</span> tree t <span class="token keyword">in</span>
  <span class="token comment">(* [Store.Tree.fold] *)</span>
  Tree<span class="token punctuation">.</span>fold <span class="token label property">~order</span><span class="token punctuation">:</span><span class="token variant symbol">`Undefined</span>
    <span class="token label property">~contents</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">fun</span> _path m acc <span class="token operator">-&gt;</span> m <span class="token punctuation">::</span> acc <span class="token operator">|&gt;</span> Lwt<span class="token punctuation">.</span>return<span class="token punctuation">)</span>
    tree <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> load t model <span class="token operator">=</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> Model<span class="token punctuation">.</span>key_path model <span class="token keyword">in</span>
  <span class="token comment">(* [Store.find] *)</span>
  find t key

<span class="token keyword">let</span> save t model <span class="token operator">=</span>
  <span class="token keyword">let</span> f tree <span class="token operator">=</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> Model<span class="token punctuation">.</span>key_path model <span class="token keyword">in</span>
    <span class="token comment">(* [Store.Tree.add] *)</span>
    Tree<span class="token punctuation">.</span>add tree key model
  <span class="token keyword">in</span>
  update t f <span class="token label property">~info</span><span class="token punctuation">:</span><span class="token punctuation">(</span>Info_jsoo<span class="token punctuation">.</span>v <span class="token label property">~author</span> <span class="token string">&quot;Update %s&quot;</span> model<span class="token punctuation">.</span>url <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> delete t model <span class="token operator">=</span>
  <span class="token keyword">let</span> f tree <span class="token operator">=</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> Model<span class="token punctuation">.</span>key_path model <span class="token keyword">in</span>
    <span class="token comment">(* [Store.Tree.remove] *)</span>
    Tree<span class="token punctuation">.</span>remove tree key
  <span class="token keyword">in</span>
  update t f <span class="token label property">~info</span><span class="token punctuation">:</span><span class="token punctuation">(</span>Info_jsoo<span class="token punctuation">.</span>v <span class="token label property">~author</span> <span class="token string">&quot;Delete %s&quot;</span> model<span class="token punctuation">.</span>url <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>Each bookmark is stored in the Git repository using <a href="https://github.com/tarides/irmin-bookmarks/blob/bf96308a8ddeacf0ae66475383338b26c9cbb192/model/model.ml#L15-L21">a unique path</a>. Loading, saving, and deleting is as easy as passing this path to the corresponding store functions.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/8fee6040882306a29fe23c46f8f24649/59822/listofbookmarks.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACMUlEQVR42p1U227bMAzN/3/X9jAgBRqg6LC1WWvHF10sW4ps+Sb7DFRSN0mLpRmDA1K0zJA8pFdSGbRtj8Z1H1CoCkIqyEIttjYW7uK+rVuMfsLj7wirumlBMuNd5vlw2j4/Y71e4/7+HpvNBnd3d8iy7OwOyTQd7D9RjpXRDdx+QOdGzPSbzzFN06Lf7Et4P70HFPkeLxuNImlwKadZ/EvOMlSlhlISZVlCSgnGWECSJMs5iiJwzhHHcQDZeZ4Hv9Z6CRwClpWGEAJSFlBKBRRFAWvtkuVbud77s7KXdswnGRJ7hZTIcxaCcsZRVeRToZR5AmbSM4J9tWRrG3g/oO0adH2LtnMYxxHd0P5fDyWzSH/V4K8N5M6hYh1U5pBva6RPFnLXgEc12AvdqUO2VwIapM8aybYCizREsgeLDdJthXSrwXcm+Mim533Xo+97DP2AYRiCPXp/QorWUJUE4xm4YAFpnqJQErLg4CIPviTbQUgeGKbhTtM02DQJzrlTls3hgZAw2kCpMthEkBAS5fFMpDnXXu9hqU2YJWKXZpFGpmmaoGlMLrfls00h//vq7RtM3mP0Q2CX+kKBqDdvF29iWWQW8YPF47cC+6I7DjNukg+rxzKBPJXQlUGlq7At1AbS/sjgTQGpX1zwEIAIok0hbYz5UtlnAcMH07nwsrV12OGu67G39tjw6xjHw59uX7PPP7C3ylmGP59ixAnH644tiHZ80V/BS8yQM4XvPx7wF/ZtB5kijXAXAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/8fee6040882306a29fe23c46f8f24649/c5bb3/listofbookmarks.png" class="gatsby-resp-image-image" alt="An example list of saved bookmarks, here the bookmarks are: Irmin, OCaml.org, and Tarides.com" title="" srcset="/static/8fee6040882306a29fe23c46f8f24649/04472/listofbookmarks.png 170w,
/static/8fee6040882306a29fe23c46f8f24649/9f933/listofbookmarks.png 340w,
/static/8fee6040882306a29fe23c46f8f24649/c5bb3/listofbookmarks.png 680w,
/static/8fee6040882306a29fe23c46f8f24649/59822/listofbookmarks.png 916w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>For listing our bookmarks, we can accumulate all of our models in the store's tree. If our repository contained a large number of bookmarks, we would need to implement some kind of pagination API, but simple accumulation is enough for our demo application.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#concurrent-atomic-updates" aria-label="concurrent atomic updates permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Concurrent Atomic Updates</h3>
<p>An interesting function to look at more closely is <code>update</code>. This function is used when saving and deleting and performs atomic updates to our store, even if multiple tabs are concurrently writing.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> update t f <span class="token label property">~info</span> <span class="token operator">=</span>
  catch <span class="token operator">@@</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  <span class="token keyword">let</span> repo <span class="token operator">=</span> repo t <span class="token keyword">in</span>
  <span class="token comment">(* Get latest tree for main branch *)</span>
  <span class="token keyword">let</span><span class="token operator">*</span> main <span class="token operator">=</span> of_branch repo Branch<span class="token punctuation">.</span>main <span class="token keyword">in</span>
  <span class="token keyword">let</span><span class="token operator">*</span> head <span class="token operator">=</span> Head<span class="token punctuation">.</span>get main <span class="token keyword">in</span>
  <span class="token comment">(* Apply [f] to the tree on main to get our new tree *)</span>
  <span class="token keyword">let</span><span class="token operator">*</span> tree <span class="token operator">=</span> Commit<span class="token punctuation">.</span>tree head <span class="token operator">|&gt;</span> f <span class="token keyword">in</span>
  <span class="token comment">(* Commit this tree *)</span>
  <span class="token keyword">let</span><span class="token operator">*</span> commit <span class="token operator">=</span> Commit<span class="token punctuation">.</span>v repo <span class="token label property">~info</span> <span class="token label property">~parents</span><span class="token punctuation">:</span><span class="token punctuation">[</span> Commit<span class="token punctuation">.</span>key head <span class="token punctuation">]</span> tree <span class="token keyword">in</span>
  <span class="token comment">(* Merge commit to main *)</span>
  <span class="token keyword">let</span><span class="token operator">*</span> main <span class="token operator">=</span> of_branch repo Branch<span class="token punctuation">.</span>main <span class="token keyword">in</span>
  merge_with_commit main commit <span class="token label property">~info</span><span class="token punctuation">:</span><span class="token punctuation">(</span>Info_jsoo<span class="token punctuation">.</span>v <span class="token label property">~author</span> <span class="token string">&quot;Merge to main&quot;</span><span class="token punctuation">)</span></code></pre></div>
<p>The key to how this works is merging!</p>
<p>Simply writing a commit directly to the main branch, like when using <a href="https://mirage.github.io/irmin/irmin/Irmin/module-type-S/index.html#val-set_tree">Irmin's <code>set_tree</code></a>, can fail when done concurrently because updating the main branch reference is done using a <a href="https://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> operation. To avoid this issue, we first create a new commit with our changes and then attempt to merge it to the main branch using <code>merge_with_commit</code>. When performed concurrently, the process of merging our updated commit into the latest commit on main and updating the reference is retried if it fails. The process will terminate either with a successful merge and update or a merge conflict that cannot be handled automatically.</p>
<p>When merging, there are two conflict scenarios:</p>
<ol>
<li>The same bookmark is added or updated on main and added or updated in the update commit. This will be resolved by our merge function since it picks the &quot;newest&quot; model.</li>
<li>The same bookmark is deleted either on main or the update commit and added or updated in the other. This will result in a merge conflict since the custom merge function of our model is not called when one side is deleted.</li>
</ol>
<p>The current code in the extension simply propagates the error in the second case which means that a user needs to try again. This case could be handled specially to build an improved user experience, but was sufficient for our demo application. The important aspect is that our extension handles concurrent updates correctly and can automatically resolve conflicts in many cases.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#wrapping-up" aria-label="wrapping up permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Wrapping up</h2>
<p>And that's it! Take a look at the <a href="https://github.com/tarides/irmin-bookmarks">project's repository</a> to see that it only takes about 500 lines of OCaml code to have a fully working browser extension that saves, loads, lists, and deletes bookmarks in a local git repository.</p>
<p>Check out the project's <a href="https://github.com/tarides/irmin-bookmarks/blob/main/README.md">README</a> for how to build and use the extension. If you give any Irmin packages a try and run into issues, feel free to open issues or PRs on <a href="https://github.com/mirage/irmin/">the Irmin repository</a>. Happy hacking!</p>
