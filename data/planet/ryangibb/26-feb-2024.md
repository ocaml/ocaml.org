---
title: 26 Feb 2024
description:
url: https://ryan.freumh.org/2024-02-26.html
date: 2024-02-26T00:00:00-00:00
preview_image:
authors:
- Ryan Gibb
source:
---

<article>
    <div class="container">
        <span>  Previous: <a href="https://ryan.freumh.org/2024-02-19.html">19 Feb 2024</a>  </span>
        <span>  Next: <a href="https://ryan.freumh.org/2024-03-11.html">11 Mar 2024</a>  </span>
    </div>
    
    <section>
        <h3>Shark</h3>
<p><span>We’ve got an obuilder runc container using
Linux network namespaces with VPNkit forwarding outgoing http requests
to a cohttp-proxy-lwt. I’ve created a monorepo assembling obuilder,
VPNkit, and cohttp and got them building. Some issues were VPNkit having
an outdated version of cohttp and having it’s own dune <code>dns</code>
library which collides with the Mirage DNS library.</span></p>
<p><span>Next is assembling a binary to do the
container, namespace, VPNkit, and http proxy orchestration.</span></p>
<p><span>I’m thinking about the UI of what this will
look like. Something like</span></p>
<pre><code>$ shark create &lt;name&gt;
$ shark attach &lt;name&gt;
$ ...</code></pre>
<p><span>We also need to implement some kind of store
to cache and replay http queries.</span></p>
<p><span>Some technical nodes on reproducing this
prototype separate-binary setup follow:</span></p>
<p><span>build obuilder:</span></p>
<pre><code>$ cd ~/projects/obuilder
$ git clone git@github.com:ocurrent/obuilder.git
$ nix-shell -p sqlite pkg-config
$ opam install . --deps-only
$ dune build main.exe</code></pre>
<p><span>build vpnkit:</span></p>
<pre><code>$ cd ~/projects/vpnkit
$ git clone git@github.com:moby/vpnkit.git
$ opam install . --deps-only
$ dune build vpnkit.exe
$ nix-shell -p glibc.static gcc
$ dune build vpnkit.exe</code></pre>
<p><span>set up the network namespace proxing traffic
to TAP device:</span></p>
<pre><code>$ sudo ip netns add neto
$ sudo ip netns exec neto ip tuntap add tapo mode tap
$ sudo ip netns exec neto ip link set tapo netns neto
$ sudo ip netns exec neto ip addr add 192.168.65.3/24 dev tapo
$ sudo ip netns exec neto ip link set tapo up
$ sudo ip netns exec neto ip route add default via 192.168.65.1
$ sudo ip netns exec neto ~/projects/vpnkit/c/vpnkit-tap-vsockd/sbin/vpnkit-tap-vsockd --tap tapo --path /tmp/vpnkit-ethernet.sock</code></pre>
<p><span>run a HTTP proxy:</span></p>
<pre><code>$ cohttp-proxy-lwt -p 3128 -vv</code></pre>
<p><span>run VPNkit with a HTTP proxy:</span></p>
<pre><code>$ cat '{"http": "localhost:3128","https": "localhost:3128","exclude": "*.local"}' &gt; host.json
$ ~/projects/vpnkit/_build/default/vpnkit.exe --ethernet /tmp/vpnkit-ethernet.sock --http host.json</code></pre>
<p><span>try curling in the namespace:</span></p>
<pre><code>$ sudo ip netns exec neto curl http://freumh.org</code></pre>
<p><span>create an obuilder container in
namespace:</span></p>
<pre><code>$ nix shell nixpkgs#runc
$ cat "
((from ocaml/opam)
  (run
   (network /var/run/netns/neto)
   (shell "curl http://freumh.org -v")))
" &gt; example.spec
$ sudo ~/projects/obuilder/_build/default/main.exe build -f example.spec . --store=rsync:`pwd`/rsync/ --rsync-mode=copy
main.exe: [INFO] Architectures for multi-arch system: [SCMP_ARCH_X86_64;
                                                       SCMP_ARCH_X86;
                                                       SCMP_ARCH_X32]
(from ocaml/opam)
---&gt; using "ac36be11f82fb13bcf2d2c33422ae3481389700eb141c54e8f01f9c9740faffb" from cache
/: (run (network /var/run/netns/neto)
        (shell "curl http://freumh.org -v"))
main.exe: [INFO] Exec "rsync" "-aHq" "/tmp/rsync/result/ac36be11f82fb13bcf2d2c33422ae3481389700eb141c54e8f01f9c9740faffb/" "/tmp/rsync/result-tmp/3fa186a54e74aad5a53c2c4dcb26ca0b493e0a4032cf0295ba717ea139bca747"
main.exe: [INFO] Exec "runc" "--root" "/tmp/rsync/state/sandbox" "run" "0"
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 135.181.100.27:80...
* Connected to freumh.org (135.181.100.27) port 80 (#0)
&gt; GET / HTTP/1.1
&gt; Host: freumh.org
&gt; User-Agent: curl/7.88.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 301 Moved Permanently
&lt; Server: nginx
&lt; Date: Sat, 02 Mar 2024 15:34:26 GMT
&lt; Content-Type: text/html
&lt; Location: https://freumh.org/
&lt; Strict-Transport-Security: max-age=31536000
&lt; X-Frame-Options: SAMEORIGIN
&lt; X-Content-Type-Options: nosniff
&lt; Content-Security-Policy: default-src 'self' 'unsafe-inline' 'unsafe-eval'; base-uri 'self'; frame-src 'self'; frame-ancestors 'self'; form-action 'self';
&lt; Referrer-Policy: same-origin
&lt; transfer-encoding: chunked
&lt;
{ [173 bytes data]
100   162    0   162    0     0   1264      0 --:--:-- --:--:-- --:--:--  1255
* Connection #0 to host freumh.org left intact
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
main.exe: [INFO] Exec "mv" "/tmp/rsync/result-tmp/3fa186a54e74aad5a53c2c4dcb26ca0b493e0a4032cf0295ba717ea139bca747" "/tmp/rsync/result/3fa186a54e74aad5a53c2c4dcb26ca0b493e0a4032cf0295ba717ea139bca747"
---&gt; saved as "3fa186a54e74aad5a53c2c4dcb26ca0b493e0a4032cf0295ba717ea139bca747"
Got: "3fa186a54e74aad5a53c2c4dcb26ca0b493e0a4032cf0295ba717ea139bca747"</code></pre>
<p><span>in the VPNkit logs:</span></p>
<pre><code>[2024-03-02T15:34:26.170356988Z][vpnkit.exe][info] ethernet: Connected Ethernet interface f6:16:36:bc:f9:c6
[2024-03-02T15:34:26.170392036Z][vpnkit.exe][info] udp: UDP layer connected on 100.100.100.100
[2024-03-02T15:34:26.170403957Z][vpnkit.exe][info] tcp.pcb: TCP layer connected on 100.100.100.100
[2024-03-02T15:34:26.189383983Z][vpnkit.exe][info] http: HTTP proxy --&gt; 127.0.0.1:3128 Host:freumh.org:80 (Proxy): GET /
[2024-03-02T15:34:26.189481019Z][vpnkit.exe][info] http: HTTP proxy --&gt; 127.0.0.1:3128 Host:freumh.org:80 (Proxy): Successfully connected to 127.0.0.1:3128
[2024-03-02T15:34:26.189506053Z][vpnkit.exe][info] http: Outgoing.Request.write
[2024-03-02T15:34:26.189560890Z][vpnkit.exe][info] http: Outgoing.Response.read
[2024-03-02T15:34:26.297271966Z][vpnkit.exe][info] http: HTTP proxy &lt;-- 127.0.0.1:3128 Host:freumh.org:80 (Proxy): HTTP/1.1 301 Moved Permanently
[2024-03-02T15:34:26.297477960Z][vpnkit.exe][info] http: HTTP proxy &lt;-- 127.0.0.1:3128 Host:freumh.org:80 (Proxy): proxying body</code></pre>
<p><span>and the cohttp proxy logs:</span></p>
<pre><code>[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; GET http://freumh.org:80/ HTTP/1.1
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; host: freumh.org
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Accept: */*
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt;
[DEBUG][cohttp.lwt.server]: Handle request: ((headers ((host freumh.org) (User-Agent curl/7.88.1) (Accept */*)))
 (meth GET) (scheme ()) (resource http://freumh.org:80/) (version HTTP_1_1)
 (encoding Unknown)).
--&gt; GET http://freumh.org:80/ ((headers ((host freumh.org) (User-Agent curl/7.88.1) (Accept */*)))
 (meth GET) (scheme ()) (resource http://freumh.org:80/) (version HTTP_1_1)
 (encoding Unknown))
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; User-Agent: curl/7.88.1
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; GET / HTTP/1.1
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; host: freumh.org
User-Agent: curl/7.88.1
Accept: */*
accept-encoding: identity
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; HTTP/1.1 301 Moved Permanently
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Server: nginx
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Date: Sat, 02 Mar 2024 15:34:26 GMT
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Content-Type: text/html
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Connection: keep-alive
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Content-Length: 162
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; X-Content-Type-Options: nosniff
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Content-Security-Policy: default-src 'self' 'unsafe-inline' 'unsafe-eval'; base-uri 'self'; frame-src 'self'; frame-ancestors 'self'; form-action 'self';
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Referrer-Policy: same-origin
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt;
&lt;-- http://freumh.org:80/ ((encoding (Fixed 162))
 (headers
  ((Server nginx) (Date "Sat, 02 Mar 2024 15:34:26 GMT")
   (Content-Type text/html) (Content-Length 162) (Connection keep-alive)
   (Location https://freumh.org/)
   (Strict-Transport-Security max-age=31536000) (X-Frame-Options SAMEORIGIN)
   (X-Content-Type-Options nosniff)
   (Content-Security-Policy
    "default-src 'self' 'unsafe-inline' 'unsafe-eval'; base-uri 'self'; frame-src 'self'; frame-ancestors 'self'; form-action 'self';")
   (Referrer-Policy same-origin)))
 (version HTTP_1_1) (status Moved_permanently) (flush false))
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; HTTP/1.1 301 Moved Permanently
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; Server: nginx
Date: Sat, 02 Mar 2024 15:34:26 GMT
Content-Type: text/html
Location: https://freumh.org/
Strict-Transport-Security: max-age=31536000
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
Content-Security-Policy: default-src 'self' 'unsafe-inline' 'unsafe-eval'; base-uri 'self'; frame-src 'self'; frame-ancestors 'self'; form-action 'self';
Referrer-Policy: same-origin
transfer-encoding: chunked
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; &lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt;
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; 0
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Location: https://freumh.org/
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; Strict-Transport-Security: max-age=31536000
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; X-Frame-Options: SAMEORIGIN
[DEBUG][cohttp.lwt.io]: &gt;&gt;&gt; a2
[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt;[162] &lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;

[DEBUG][cohttp.lwt.io]: &lt;&lt;&lt; EOF
Connection (TCP ((fd &lt;opaque&gt;) (ip 127.0.0.1) (port 36222))) closed</code></pre>
<h3>Lenscap</h3>
<p><span>Got a bit distracted with shark this week,
but watch this space.</span></p>
    </section>
</article>

