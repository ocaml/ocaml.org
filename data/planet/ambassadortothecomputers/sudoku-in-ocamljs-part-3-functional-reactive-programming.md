---
title: 'Sudoku in ocamljs, part 3: functional reactive programming'
description: In part 1  and part 2  of this series, we made a simple Sudoku game and
  connected it to a game server. In this final installment I want to r...
url: http://ambassadortothecomputers.blogspot.com/2009/05/sudoku-in-ocamljs-part-3-functional.html
date: 2009-05-12T04:51:00-00:00
preview_image:
authors:
- Jake Donham
source:
---

<p>In <a href="http://ambassadortothecomputers.blogspot.com/2009/04/sudoku-in-ocamljs-part-1-dom.html">part 1</a> and <a href="http://ambassadortothecomputers.blogspot.com/2009/05/sudoku-in-ocamljs-part-2-rpc-over-http.html">part 2</a> of this series, we made a simple Sudoku game and connected it to a game server. In this final installment I want to revisit how we check that a board satisfies the Sudoku rules. There's a small change to the UI: instead of a &quot;Check&quot; button, the board is checked continuously as the player enters numbers; any conflicts are highlighted as before. Here's the <a href="http://froc.googlecode.com/svn/examples/froc-dom/sudoku/index.html">final result</a>.<br/>
</p><p>Let's review how we want checking to work: a cell is colored red if any other cell in the same row, column, or square (outlined in bold) contains the same number; otherwise the cell is colored white. Now take another look at the <code>check_board</code> function from <a href="http://ambassadortothecomputers.blogspot.com/2009/04/sudoku-in-ocamljs-part-1-dom.html">part 1</a>. Is it obvious that this code meets the specification? The function is essentially stateful, clearing all the cell colors then setting them red when it discovers a conflict. In fact, I had a bug in it related to state--I was clearing the background color in the <code>None</code> arm of <code>check_set</code>, so each checked constraint would overwrite the highlighting of the previous ones where they overlapped.<br/>
</p><p>It would be easier to convince ourselves that we'd gotten it right if the code looked more like the specification. What we want is a function that maps each cell and its &quot;adjacent&quot; cells (the ones in the same row, column, or square) to a boolean (true if the cell is highlighted). Abstracting from the DOM details, suppose a cell is an <code>int option</code> and we have a function <code>adjacents i j</code> that returns a list of cells adjacent to the cell at (i, j). Then the check function is just: </p><pre><span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">highlighted</span><span class="htmlize-variable-name"> cell i j </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  cell <span class="htmlize-tuareg-font-lock-operator">&lt;&gt;</span> None <span class="htmlize-tuareg-font-lock-operator">&amp;&amp;</span> <span class="htmlize-type">List</span>.mem cell <span class="htmlize-tuareg-font-lock-operator">(</span>adjacents i j<span class="htmlize-tuareg-font-lock-operator">)</span>
</pre><p>So how do we hook this function into the UI? We could just call it for every cell, every time we get a change event for some cell. That seems like a lot of needless computation, since almost all the cells haven't changed. On the other hand, if we manually keep track of which cells might be affected by a change, our code is no longer obviously correct. It would be nice to have some kind of incremental update, like a spreadsheet.<br/>
</p><p>This is where <em>functional reactive programming</em> comes in. The main idea is to write functions over <em>behaviors</em>, or values that can change. If you change an input to a function, the output (another behavior) is automatically recomputed. The dependency bookkeeping is taken care of by the framework; we'll use the <a href="http://code.google.com/p/froc/">froc</a> library.<br/>
</p><p>It turns out to be convenient to give behaviors a monadic interface. So we have a type <code>'a behavior</code>; we turn a constant into a behavior with <code>return</code>, and we use a behavior with <code>bind</code>. We saw in <a href="http://ambassadortothecomputers.blogspot.com/2009/05/sudoku-in-ocamljs-part-2-rpc-over-http.html">part 2</a> that the monadic interface of Lwt enables blocking: since <code>bind</code> takes a function to apply to the result of a thread, the framework can wait until the thread has completed before applying it. With froc, the framework applies the function passed to <code>bind</code> whenever the bound behavior changes. With both Lwt and froc you can think of a computation as a collection of dependencies rather than a linear sequence.<br/>
</p><p>There's another important piece of functional reactive programming: events. An <code>'a event</code> in froc is a channel over which values of type <code>'a</code> can be passed. You can connect froc events to DOM events to interact with the stateful world of the UI. The library includes several functions for working with events (e.g. mapping a function over an event stream) and in particular for mediating between behaviors and events, such as: </p><pre><span class="htmlize-tuareg-font-lock-governing">val</span> <span class="htmlize-variable-name">hold </span><span class="htmlize-tuareg-font-lock-operator">:</span> <span class="htmlize-tuareg-font-lock-operator">'</span>a <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-tuareg-font-lock-operator">'</span>a event <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-tuareg-font-lock-operator">'</span>a behavior
</pre>which takes an initial value and an event channel, and returns a behavior that begins at the initial value then changes to each successive value that's sent on the channel, and <pre><span class="htmlize-tuareg-font-lock-governing">val</span> <span class="htmlize-variable-name">changes </span><span class="htmlize-tuareg-font-lock-operator">:</span> <span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-type">a behavior </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span><span class="htmlize-type"> </span><span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-type">a event</span>
</pre>which takes a behavior and returns an event channel that has a value sent on it whenever the behavior changes.<br/>
<p>This all probably seems a bit abstract, so let's dive into the example code: </p><pre><span class="htmlize-tuareg-font-lock-governing">module</span> <span class="htmlize-type">D </span><span class="htmlize-tuareg-font-lock-operator">=</span> Dom
<span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">d </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-type">D</span>.document

<span class="htmlize-tuareg-font-lock-governing">module</span> <span class="htmlize-type">F </span><span class="htmlize-tuareg-font-lock-operator">=</span> Froc
<span class="htmlize-tuareg-font-lock-governing">module</span> <span class="htmlize-type">Fd </span><span class="htmlize-tuareg-font-lock-operator">=</span> Froc_dom
<span class="htmlize-tuareg-font-lock-governing">let</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">(&gt;&gt;=)</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-type">F</span>.<span class="htmlize-tuareg-font-lock-operator">(&gt;&gt;=)</span>
</pre>We set up some constants we'll need below. The <code>Froc</code> module contains the core FRP implementation, not tied to a particular UI toolkit; <code>Froc_dom</code> contains functions that are specific to DOM programming (with the <code>Dom</code> module we saw before). <pre><span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">make_cell</span><span class="htmlize-variable-name"> </span><span class="htmlize-variable-name">v </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">ev </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-type">F</span>.make_event <span class="htmlize-tuareg-font-lock-operator">()</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">cell </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-type">F</span>.hold v ev <span class="htmlize-tuareg-font-lock-governing">in</span>
  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">set</span><span class="htmlize-variable-name"> v </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-type">F</span>.send ev v <span class="htmlize-tuareg-font-lock-governing">in</span>
  <span class="htmlize-tuareg-font-lock-operator">(</span>cell<span class="htmlize-tuareg-font-lock-operator">,</span> set<span class="htmlize-tuareg-font-lock-operator">)</span>
<span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">notify_e</span><span class="htmlize-variable-name"> e f </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  <span class="htmlize-type">F</span>.notify_e e <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">function</span>
   <span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-type">F</span>.Fail _ <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-tuareg-font-lock-operator">()</span>
    <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-type">F</span>.Value v <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> f v<span class="htmlize-tuareg-font-lock-operator">)</span>
</pre>These are a couple of functions that really should be part of froc (and will be in the next version). The first makes a cell, which is a behavior (the <code>hold</code> of an event channel) along with a function to set its value (which sends the value on the channel). It's like a <code>ref</code> cell, but we can <code>bind</code> it so changes are propagated. We'll have one of these for each square on the Sudoku board, but it is a generally useful construct.<br/>
<p>The second papers over a design error in the froc API: like with Lwt threads, a froc behavior or event value can be either a normal value or an exception (together, a <em>result</em>). The <code>notify_e</code> function sets a callback that's called when an event arrives on the channel, but most of the time we just want to ignore exceptional events. </p><pre><span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">attach_input_value</span><span class="htmlize-variable-name"> i b </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  notify_e <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-type">F</span>.changes b<span class="htmlize-tuareg-font-lock-operator">)</span> <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">v </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span> i<span class="htmlize-tuareg-font-lock-operator">#</span>_set_value v<span class="htmlize-tuareg-font-lock-operator">)</span>
<span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">attach_backgroundColor</span><span class="htmlize-variable-name"> e b </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  notify_e
    <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-type">F</span>.changes b<span class="htmlize-tuareg-font-lock-operator">)</span>
    <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">v </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span> e<span class="htmlize-tuareg-font-lock-operator">#</span>_get_style<span class="htmlize-tuareg-font-lock-operator">#</span>_set_backgroundColor v<span class="htmlize-tuareg-font-lock-operator">)</span>
</pre>These are functions that should be part of <code>Froc_dom</code>. To <em>attach</em> a DOM element to a behavior means to update the DOM element whenever the behavior changes. But there are lots of ways to update a DOM element, and <code>Froc_dom</code> doesn't include them all. (This design contrasts with that of <a href="http://www.flapjax-lang.org/">Flapjax</a>, where you work with behaviors whose value is an entire DOM element. It's certainly possible to do this in froc, but more tedious because of the types.) <pre><span class="htmlize-tuareg-font-lock-governing">let</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-variable-name">check_enabled</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name"> set_check_enabled</span><span class="htmlize-tuareg-font-lock-operator">)</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span> make_cell <span class="htmlize-constant">false</span>
</pre>Now we're in the application code. The <code>check_enabled</code> cell controls whether checking is turned on--we'll see below what this is for, as you may have noticed that there is no such switch in the actual UI. <pre><span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">make_board</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">()</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span>
  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">make_input</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">()</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span>
    <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">input </span><span class="htmlize-tuareg-font-lock-operator">=</span> <span class="htmlize-tuareg-font-lock-operator">(</span>d<span class="htmlize-tuareg-font-lock-operator">#</span>createElement <span class="htmlize-string">&quot;input&quot;</span> <span class="htmlize-tuareg-font-lock-operator">:</span> <span class="htmlize-type">D.input</span><span class="htmlize-tuareg-font-lock-operator">)</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
    input<span class="htmlize-tuareg-font-lock-operator">#</span>setAttribute <span class="htmlize-string">&quot;type&quot;</span> <span class="htmlize-string">&quot;text&quot;</span><span class="htmlize-tuareg-font-lock-operator">;</span>
    input<span class="htmlize-tuareg-font-lock-operator">#</span>_set_size 1<span class="htmlize-tuareg-font-lock-operator">;</span>
    input<span class="htmlize-tuareg-font-lock-operator">#</span>_set_maxLength 1<span class="htmlize-tuareg-font-lock-operator">;</span>
    <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">style </span><span class="htmlize-tuareg-font-lock-operator">=</span> input<span class="htmlize-tuareg-font-lock-operator">#</span>_get_style <span class="htmlize-tuareg-font-lock-governing">in</span>
    style<span class="htmlize-tuareg-font-lock-operator">#</span>_set_border <span class="htmlize-string">&quot;none&quot;</span><span class="htmlize-tuareg-font-lock-operator">;</span>
    style<span class="htmlize-tuareg-font-lock-operator">#</span>_set_padding <span class="htmlize-string">&quot;0px&quot;</span><span class="htmlize-tuareg-font-lock-operator">;</span>

    <span class="htmlize-tuareg-font-lock-governing">let</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-variable-name">cell</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name"> set</span><span class="htmlize-tuareg-font-lock-operator">)</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span> make_cell None <span class="htmlize-tuareg-font-lock-governing">in</span>
    attach_input_value input
      <span class="htmlize-tuareg-font-lock-operator">(</span>cell <span class="htmlize-tuareg-font-lock-operator">&gt;&gt;=</span> <span class="htmlize-keyword">function</span>
       <span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">|</span> None <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-type">F</span>.return <span class="htmlize-string">&quot;&quot;</span>
        <span class="htmlize-tuareg-font-lock-operator">|</span> Some v <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-type">F</span>.return <span class="htmlize-tuareg-font-lock-operator">(</span>string_of_int v<span class="htmlize-tuareg-font-lock-operator">));</span>
    <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">ev </span><span class="htmlize-tuareg-font-lock-operator">=</span>
      <span class="htmlize-type">F</span>.map
        <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">function</span>
         <span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;1&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;2&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;3&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;4&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;5&quot;</span>
          <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;6&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;7&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;8&quot;</span> <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-string">&quot;9&quot;</span>  <span class="htmlize-keyword">as</span> v <span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
            Some <span class="htmlize-tuareg-font-lock-operator"> (</span>int_of_string v<span class="htmlize-tuareg-font-lock-operator">)</span>
          <span class="htmlize-tuareg-font-lock-operator">|</span> _ <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> None<span class="htmlize-tuareg-font-lock-operator">)</span>
        <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-type">Fd</span>.input_value_e input<span class="htmlize-tuareg-font-lock-operator">)</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
    notify_e ev set<span class="htmlize-tuareg-font-lock-operator">;</span>
    <span class="htmlize-tuareg-font-lock-operator">(</span>cell<span class="htmlize-tuareg-font-lock-operator">,</span> set<span class="htmlize-tuareg-font-lock-operator">,</span> input<span class="htmlize-tuareg-font-lock-operator">)</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
</pre>Here we make the game board much as we did in <a href="http://ambassadortothecomputers.blogspot.com/2009/04/sudoku-in-ocamljs-part-1-dom.html">part 1</a>. The main difference is that instead of working directly with DOM input nodes, we connect each input to a cell of type <code>int option</code>. The <code>attach_input</code> call sets the value of the DOM input node whenever the cell changes, and the <code>notify_e</code> call sets the cell whenever the input node changes. (This doesn't loop, because <code>Fd.input_value_e</code> makes an event stream from the &quot;onchange&quot; events of the input, and &quot;onchange&quot; events are only sent when the user changes the input, not when it's changed from Javascript.) We take the stream of <code>string</code>s and map it into a stream of <code>int option</code>s, validating the string as we go.<br/>
<pre>  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">rows </span><span class="htmlize-tuareg-font-lock-operator">=</span>
    <span class="htmlize-type">Array</span>.init 9 <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">i </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
      <span class="htmlize-type">Array</span>.init 9 <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">j </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
        make_input <span class="htmlize-tuareg-font-lock-operator">()))</span> <span class="htmlize-tuareg-font-lock-governing">in</span>

  <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">adjacents</span><span class="htmlize-variable-name"> i j </span><span class="htmlize-tuareg-font-lock-operator">=</span>
    <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-function-name">adj</span><span class="htmlize-variable-name"> i</span><span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-variable-name"> j</span><span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span>
      <span class="htmlize-tuareg-font-lock-operator">(</span>i<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">&lt;&gt;</span> i <span class="htmlize-tuareg-font-lock-operator">||</span> j<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">&lt;&gt;</span> j<span class="htmlize-tuareg-font-lock-operator">)</span> <span class="htmlize-tuareg-font-lock-operator">&amp;&amp;</span>
        <span class="htmlize-tuareg-font-lock-operator">(</span>i<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">=</span> i <span class="htmlize-tuareg-font-lock-operator">or</span> j<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">=</span> j <span class="htmlize-tuareg-font-lock-operator">or</span>
            <span class="htmlize-tuareg-font-lock-operator">(</span>i<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">/</span> 3 <span class="htmlize-tuareg-font-lock-operator">=</span> i <span class="htmlize-tuareg-font-lock-operator">/</span> 3 <span class="htmlize-tuareg-font-lock-operator">&amp;&amp;</span> j<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">/</span> 3 <span class="htmlize-tuareg-font-lock-operator">=</span> j <span class="htmlize-tuareg-font-lock-operator">/</span> 3<span class="htmlize-tuareg-font-lock-operator">))</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
    <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-tuareg-font-lock-governing">rec</span> <span class="htmlize-function-name">adjs</span><span class="htmlize-variable-name"> i</span><span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-variable-name"> j</span><span class="htmlize-tuareg-font-lock-operator">'</span><span class="htmlize-variable-name"> l </span><span class="htmlize-tuareg-font-lock-operator">=</span>
      <span class="htmlize-keyword">match</span> i<span class="htmlize-tuareg-font-lock-operator">',</span> j<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-keyword">with</span>
        <span class="htmlize-tuareg-font-lock-operator">|</span> 9<span class="htmlize-tuareg-font-lock-operator">,</span> _ <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> l
        <span class="htmlize-tuareg-font-lock-operator">|</span> _<span class="htmlize-tuareg-font-lock-operator">,</span> 9 <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> adjs <span class="htmlize-tuareg-font-lock-operator">(</span>i<span class="htmlize-tuareg-font-lock-operator">'+</span>1<span class="htmlize-tuareg-font-lock-operator">)</span> 0 l
        <span class="htmlize-tuareg-font-lock-operator">|</span> _<span class="htmlize-tuareg-font-lock-operator">,</span> _ <span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
            <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">l </span><span class="htmlize-tuareg-font-lock-operator">=</span>
              <span class="htmlize-keyword">if</span> adj i<span class="htmlize-tuareg-font-lock-operator">'</span> j<span class="htmlize-tuareg-font-lock-operator">'</span>
              <span class="htmlize-keyword">then</span>
                <span class="htmlize-tuareg-font-lock-governing">let</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-variable-name">cell</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name">_</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name">_</span><span class="htmlize-tuareg-font-lock-operator">)</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">=</span> rows.<span class="htmlize-tuareg-font-lock-operator">(</span>i<span class="htmlize-tuareg-font-lock-operator">')</span>.<span class="htmlize-tuareg-font-lock-operator">(</span>j<span class="htmlize-tuareg-font-lock-operator">')</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
                cell<span class="htmlize-tuareg-font-lock-operator">::</span>l
              <span class="htmlize-keyword">else</span> l <span class="htmlize-tuareg-font-lock-governing">in</span>
            adjs i<span class="htmlize-tuareg-font-lock-operator">'</span> <span class="htmlize-tuareg-font-lock-operator">(</span>j<span class="htmlize-tuareg-font-lock-operator">'+</span>1<span class="htmlize-tuareg-font-lock-operator">)</span> l <span class="htmlize-tuareg-font-lock-governing">in</span>
    adjs 0 0 <span class="htmlize-tuareg-font-lock-operator">[]</span> <span class="htmlize-tuareg-font-lock-governing">in</span>
</pre>We make the game board as a matrix of inputs as before, but now each element of the matrix contains a cell (an <code>int option behavior</code>), the function to set that cell, and the actual DOM input element. Next we set up the rule-checking. The <code>adjacents</code> function returns a list of cells adjacent to the cell at <code>(i, j)</code> (adjacent in the sense we discussed above). All my bugs when I wrote this example were in this function, but it clearly embodies the specification we're trying to meet: a cell is adjacent to the current cell if it is not the same cell and is in the same row, column, or square. (The loop would be clearer if we had <code>Array.foldi</code>.)<br/>
<pre>  <span class="htmlize-type">ArrayLabels</span>.iteri rows <span class="htmlize-tuareg-font-lock-operator">~</span><span class="htmlize-variable-name">f</span><span class="htmlize-tuareg-font-lock-operator">:(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">i row </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
    <span class="htmlize-type">ArrayLabels</span>.iteri row <span class="htmlize-tuareg-font-lock-operator">~</span><span class="htmlize-variable-name">f</span><span class="htmlize-tuareg-font-lock-operator">:(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">j </span><span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-variable-name">cell</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name"> _</span><span class="htmlize-tuareg-font-lock-operator">,</span><span class="htmlize-variable-name"> input</span><span class="htmlize-tuareg-font-lock-operator">)</span><span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
      <span class="htmlize-tuareg-font-lock-governing">let</span> <span class="htmlize-variable-name">adjs </span><span class="htmlize-tuareg-font-lock-operator">=</span> adjacents i j <span class="htmlize-tuareg-font-lock-governing">in</span>
      attach_backgroundColor input
        <span class="htmlize-tuareg-font-lock-operator">(</span>check_enabled <span class="htmlize-tuareg-font-lock-operator">&gt;&gt;=</span> <span class="htmlize-keyword">function</span>
         <span class="htmlize-variable-name"> </span><span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-constant">false</span> <span class="htmlize-tuareg-font-lock-operator">-&gt;</span> <span class="htmlize-type">F</span>.return <span class="htmlize-string">&quot;#ffffff&quot;</span>
          <span class="htmlize-tuareg-font-lock-operator">|</span> <span class="htmlize-constant">true</span> <span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
              <span class="htmlize-type">F</span>.bindN adjs <span class="htmlize-tuareg-font-lock-operator">(</span><span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">adjs </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
                cell <span class="htmlize-tuareg-font-lock-operator">&gt;&gt;=</span> <span class="htmlize-keyword">fun</span> <span class="htmlize-variable-name">v </span><span class="htmlize-tuareg-font-lock-operator">-&gt;</span>
                  <span class="htmlize-keyword">if</span> v <span class="htmlize-tuareg-font-lock-operator">&lt;&gt;</span> None <span class="htmlize-tuareg-font-lock-operator">&amp;&amp;</span> <span class="htmlize-type">List</span>.mem v adjs
                  <span class="htmlize-keyword">then</span> <span class="htmlize-type">F</span>.return <span class="htmlize-string">&quot;#ff0000&quot;</span>
                  <span class="htmlize-keyword">else</span> <span class="htmlize-type">F</span>.return <span class="htmlize-string">&quot;#ffffff&quot;</span><span class="htmlize-tuareg-font-lock-operator">))));</span>
</pre>This is the functional reactive core of the program. For each square on the board we compute essentially the <code>highlighted</code> function above, but in monadic form (the <code>bindN</code> function binds a list of behaviors at once), and attach the result to the background color of the input node. Because the set of adjacent cells does not depend on the value of the cells, we can hoist its computation out of the reactive part so it won't be recomputed every time a cell changes (and since dependency on a behavior is captured in the type of a function, the fact that this typechecks tells us it is safe to do!).<br/>
<p>That's it. The rest of the program is almost the same as before. (Here's the <a href="http://code.google.com/p/froc/source/browse/#svn/trunk/examples/froc-dom/sudoku">full code</a>.) The one important change has to do with <code>check_enabled</code>. In the reaction to cell changes, we consult <code>check_enabled</code>, returning the unhighlighted color when it's false. Since we do this before binding the cells, a change to a cell causes no recomputation when <code>check_enabled</code> is false. So we turn off <code>check_enabled</code> while loading a new game board, saving a lot of needless recomputation that otherwise makes it annoyingly slow.<br/>
</p><p>It's interesting to compare functional reactive programming to the model-view-controller pattern. The point of MVC is to separate the changeable state (the model) from how it is displayed (the view). Although MVC is typically implemented with change events and state update, a view behaves as a pure function of the state (or can be made so by making the state of UI components explicit). So you could think of FRP as &quot;automatic&quot; MVC: you just write down dependencies (with <code>bind</code>) and the framework manages events and state update. For small examples this may not seem like a big win, but FRP takes care of some complexities that tend to swamp MVC apps: managing dynamic dependencies (registering and unregistering event handlers in response to events) and maintaining coherence (i.e. functional behavior) over different event orders.<br/>
</p><p>I haven't yet written a serious application with froc, but so far I think it is awesome!<br/>
</p>
