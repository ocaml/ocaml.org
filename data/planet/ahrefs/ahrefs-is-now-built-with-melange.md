---
title: Ahrefs is now built with Melange
description: OCaml, all the way down
url: https://tech.ahrefs.com/ahrefs-is-now-built-with-melange-b14f5ec56df4?source=rss----303662d88bae--ocaml
date: 2023-05-03T19:06:58-00:00
preview_image: https://miro.medium.com/v2/resize:fit:1200/0*cGDQZKJ2bKMARpj9
featured:
authors:
- ahrefs
---

<h3>OCaml, all the way&nbsp;down</h3><figure><img src="https://cdn-images-1.medium.com/max/1024/0*cGDQZKJ2bKMARpj9" alt=""/><figcaption>Photo by <a href="https://unsplash.com/ja/@lg17?utm_source=medium&amp;utm_medium=referral">Lance Grandahl</a> on&nbsp;<a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral">Unsplash</a></figcaption></figure><h4>Some history</h4><p>In 2021, we decided to evaluate <a href="https://github.com/melange-re/melange">Melange</a> as an alternative to <a href="http://rescript-lang.org/">ReScript</a> for compiling Ahrefs&rsquo; frontend codebase. We wrote about the reasons that led us there, as well as the limitations we encountered at the time, in <a href="https://tech.ahrefs.com/building-ahrefs-codebase-with-melange-9f881f6d022b">a previous&nbsp;article</a>.</p><p>After this experiment, discussions continued inside the team. Switching to a different compiler, which was in a very early stage, involved quite some risk. But so did the continued use of ReScript, which seemed to be diverging further and further away from&nbsp;OCaml.</p><p>Finally, in September 2022 (during <a href="https://icfp22.sigplan.org/">ICFP in Ljubljana</a>), we decided to bite the bullet and kicked off a project to deepen the integration between <a href="http://dune.build/">Dune</a> (OCaml&rsquo;s most used build system) and Melange. This better integration was the key to solve two of the three limitations we had encountered during our initial exploration of&nbsp;Melange:</p><ul><li>Build speed would increase due to less work needed to parse dune files, and more efficient rules planning and execution.</li><li>Developer ergonomics would get better, as Melange would become a first-class citizen in Dune, with concepts like Dune <a href="https://dune.readthedocs.io/en/stable/dune-files.html#library">libraries</a> and other stanzas becoming available to Melange&nbsp;users.</li></ul><p>Ahrefs&rsquo; leadership backed the project and agreed to financially support the development of this tighter integration. With this support, we set about building a team that included Rudi Grinberg, who maintains Dune as part of its development team, and Antonio Monteiro, who created Melange and is also part of the Dune development team.</p><h4>Heads down</h4><p>During the following months, we focused on two tasks, iterating over multiple cycles where the progress on one task would inform the next steps to take for the&nbsp;other:</p><ol><li>Evolve Dune to add stanzas, fields, and documentation to support Melange projects.</li><li>Migrate Ahrefs&rsquo; frontend codebase to use the Melange compiler and Dune, adapt third-party libraries and bindings to Melange, and polish the editor integration, build scripts, and other aspects of the development experience.</li></ol><p>We believe that tackling these two tasks in parallel led us to better results, compared to a more waterfall-based approach. As we applied the changes over Ahrefs&rsquo; large-ish frontend codebase&#8202;&mdash;&#8202;it will soon reach 5000 modules&#8202;&mdash;&#8202;we kept finding and fixing bugs, improving the ergonomics of the Dune and Melange integration, and in general making the solution more robust, real-world ready, and developer-friendly.</p><p>Another upside of the way the project was implemented is that we developed it initially in stealth mode, keeping it quite private. By working on it within a tight-knit team, before making a public release, we could make progress faster. We believe that this approach saved future Melange users a lot of churn and burn caused by the multiple changes in Dune stanza options, Melange flags, and other configurations we changed along the way, as we learned more about this integration.</p><h4>Migration strategies</h4><p>Initially, our plan was to progressively migrate Ahrefs&rsquo; code to Melange. As the frontend codebase is divided into different tools, each being self-contained, we thought we could introduce Melange to build one tool, then another tool, gradually migrating them one by&nbsp;one.</p><p>However, this approach turned out to be too complex because configuring a development environment that works on both Melange and ReScript is challenging. As developers could be working on multiple tools during the same week, or even within the same day, we realized that it was unfeasible to reconfigure the environment every time a developer switched from a tool built with Melange to a tool built with ReScript.</p><p>Therefore, we changed our minds and opted for a one-shot migration. We would ensure that CI, development, and staging environments were working with Melange and Dune. And we would do this on separate branches, while still using ReScript on our main branch CI and development scripts. Once we were confident everything was building and functioning correctly with Melange, we switched all CI and development scripts to use the Melange and Dune commands. We tried to keep the PR that applied this switch as small as possible, with just a few hundreds of lines of changes so that we could switch back to ReScript if needed. In fact, after a first attempt in March, we had to switch back to ReScript due to some issues on the developer experience side, related to build performance and ergonomics, which took a few more weeks to&nbsp;solve.</p><p>In terms of package management and third-party Melange dependencies, we followed a more gradual approach. Dune is quite flexible when it comes to <a href="https://dune.readthedocs.io/en/stable/dune-files.html#vendored-dirs">vendoring</a>, so in the initial phase, we downloaded Melange libraries with npm, and had Dune include them in the project as if they were local sources. Now we have started migrating some of these libraries so that we can consume them using opam, the OCaml package manager. This will involve first publishing them in our private opam mirror, but the plan is to have them published in the <a href="https://ocaml.org/packages">public opam repository</a> in the future so that other Melange developers can also use&nbsp;them.</p><h4>Timings</h4><p>You may be curious about the performance differences between the previous and current approaches. Measuring performance is tricky, but we attempted to measure a few different scenarios with both setups. The results can be seen&nbsp;below.</p><p>Keep in mind that Ahrefs frontend setup has specific characteristics, which affect the performance measurements:</p><ul><li>Before migration: Dune generated ml files from atd files, then ReScript build tool bsb built all hand-written source files plus the ones generated from atd&nbsp;files.</li><li>After migration: everything is built with Dune and&nbsp;Melange.</li></ul><p>All measurements were taken on a node with 2x AMD EPYC 7742 cpu @3.2 GHz (nproc=256), 1TB RAM, Debian 11 x86_64 GNU/Linux. The build target is always the entire Ahrefs frontend codebase.</p><p><strong>Cold build:</strong></p><ul><li>Before: real 0m28.232s, user 9m23.883s, sys 13m33.939s</li><li>After: real 1m14.208s, user 10m33.708s, sys 5m45.644s</li></ul><p><strong>Warm build</strong>, noop (no file is&nbsp;built):</p><ul><li>Before: real 0m14.687s, user 3m17.058s, sys 3m57.903s</li><li>After: real 0m21.895s, user 0m20.528s, sys&nbsp;0m1.372s</li></ul><p><strong>Watch mode, modifying an &ldquo;edge&rdquo; file</strong> with almost no reverse dependencies:</p><ul><li>Before: 1002ms</li><li>After: 1576ms</li></ul><p><strong>Watch mode, modifying an &ldquo;inner&rdquo; file</strong> belonging to a library, with many reverse dependencies:</p><ul><li>Before: 7032ms</li><li>After: 15394ms</li></ul><p>In general, Melange and Dune are slower than ReScript for cold builds in our setup. However, the differences are smaller for warm builds. For watch mode, the difference gets reduced when modifying edge&nbsp;files.</p><p>There is room for improvement in the way the Melange and Dune rules are arranged so that cold builds can get faster. For example, delaying some <a href="https://github.com/melange-re/melange/issues/464">optimizations in Melange</a> might allow to parallelize more&nbsp;work.</p><h4>Conclusions</h4><p>The results so far are quite encouraging. These are some of the things that are possible thanks to the deeper integration between Dune and Melange, and its application within the Ahrefs codebase:</p><ul><li>The same OCaml compiler is used on both frontend and backend codebases.</li><li>Access to all the bug fixes, error improvements, and new features that the OCaml compiler team added between versions 4.06 and 4.14 of the compiler.</li><li>A shared developer environment across teams, including editor extensions, OCaml LSP server, etc. No more need to maintain a different set of tooling for backend and frontend.</li><li>Removal of hand-written CI checks that were ensuring different tools in the frontend codebase would not access components from other tools. This is now solved by Dune libraries, and the OCaml compiler will complain if logical units try to reach outside their&nbsp;bounds.</li><li>Frontend and backend shared dependencies, such as <a href="https://github.com/anuragsoni/routes/">anuragsoni/routes</a>, can now be defined in a single place: an opam&nbsp;file.</li><li>Faster rebuilds and better watch mode, as Dune now controls all the build artifacts. Previously, Dune and ReScript were sharing responsibilities, which was leading to unnecessary rebuilds of some artifacts. Or alternatively, rebuilds were not starting when required due to the build system not tracking changes in some subsets of the&nbsp;sources.</li><li>Easier <a href="https://ocaml.org/docs/metaprogramming">PPX</a> maintenance, as there is no longer a need to publish pre-built versions of these&nbsp;tools.</li><li>Melange allows to run all ppxs <a href="https://github.com/melange-re/melange/pull/171">from a single executable file</a>, which has some nice performance benefits.</li><li>All the other advantages of using Dune: virtual libraries, watch mode, leverage integrations with tools like&nbsp;odoc&hellip;</li></ul><h4>What&rsquo;s next?</h4><p>We are excited about this project becoming a reality, and we believe that the deeper integration between OCaml and Melange through Dune, together with Melange&rsquo;s ergonomic integration with the JavaScript ecosystem through its bindings, can enable projects that were previously impossible to imagine. For example, full-stack React by hydrating components that are rendered <a href="https://github.com/ml-in-barcelona/server-reason-react/">server-side using native&nbsp;OCaml</a>.</p><p>Now, we have to make it easier for other people who are willing to try and use Melange and Dune. So our focus is shifting to documenting how Melange&nbsp;works.</p><p>There is a section for Melange in the Dune manual that will be included in the next stable release, and that can be consulted today in the latest branch: <a href="https://dune.readthedocs.io/en/latest/melange.html">https://dune.readthedocs.io/en/latest/melange.html</a>.</p><p>The next step will be to design and create a site where everyone can read and learn about what is needed to create and maintain a project using Melange and Dune. This site will include a playground, in the spirit of the <a href="https://reasonml.github.io/en/try">ReasonML one</a>, so that we can share snippets, see the resulting JavaScript compilation output, and iterate on ideas together.</p><p>Besides the above, we have plenty of other things we will be working on in the next months. We will share more information about the roadmap as soon as Dune 3.8 and its respective Melange version are published in the main public opam repository, which should happen in the next&nbsp;weeks.</p><h4>How to contribute?</h4><p>If you want to be a part of this, or you want to write or port your libraries to Melange, the best way to do so is by reaching out on the <a href="https://discord.gg/reasonml">ReasonML Discord</a>. There is a #melange dedicated channel where one can get help and advice on how to get&nbsp;started.</p><p>Otherwise, if you are missing features, find bugs, or run into confusing errors, please open an issue <a href="https://github.com/melange-re/melange">in the Melange public&nbsp;repo</a>.</p><p>We hope you share our excitement about this update. Our journey to integrate our frontend stack more naturally within the incredible language and ecosystem of OCaml will be well-documented. Stay tuned for further updates in the&nbsp;future!</p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=b14f5ec56df4" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/ahrefs-is-now-built-with-melange-b14f5ec56df4">Ahrefs is now built with Melange</a> was originally published in <a href="https://tech.ahrefs.com">Ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
