---
title: Profiling Dune Builds
description: "Co-authored with Louis Roch\xE9."
url: https://tech.ahrefs.com/profiling-dune-builds-a8de589ec268?source=rss----303662d88bae--ocaml
date: 2024-02-05T22:05:01-00:00
preview_image: https://miro.medium.com/v2/resize:fit:1200/1*_LJOnS_B8eWfQC3D8dFc0A.png
authors:
- Ahrefs
source:
---

<p><em>Co-authored with </em><a href="https://medium.com/u/a988f59eb129"><em>Louis&nbsp;Roch&eacute;</em></a><em>.</em></p><p>There are multiple ways to know what&rsquo;s going on in <a href="https://dune.build/">Dune</a> (build system for OCaml). The tool itself includes a few ways that are mentioned at the end of the guide, but they&rsquo;re not sufficient as of the current date (Feb &lsquo;24). So the most relevant information at this moment is obtained through external&nbsp;tools.</p><p>Note that the process explained below with perf and memtrace is applicable to any OCaml program, not just Dune&nbsp;itself.</p><h3>Performance trace with&nbsp;perf</h3><p>perf is a tool coming with the Linux kernel. Essentially, it will run any application and take measurements every few milliseconds to get a snapshot of the callstack.</p><p>The main subcommand to record a run is perf&nbsp;record.</p><p>perf reports created with perf record can be opened with perf report. But if you prefer more visual ways, Firefox has a profiler that can be used as&nbsp;well.</p><pre>perf record -F 1000 --call-graph dwarf dune build @all # or any other alias / target<br/>perf script -F +pid &gt; test.perf # converts perf.data to test.perf so it can be opened</pre><p>Then upload the resulting test.perf to the online tool in <a href="https://profiler.firefox.com/">https://profiler.firefox.com/</a>.</p><figure><img src="https://cdn-images-1.medium.com/max/1024/1*cclbT429D-AhqYh16i_rgg.png" alt="Call tree view in Firefox profiling tool"/><figcaption>Call tree view in Firefox profiling tool</figcaption></figure><figure><img src="https://cdn-images-1.medium.com/max/1024/1*fVCNHpCZ6Q0xbT_iYy0C_g.png" alt="Flame graph view on Firefox profiling tool"/><figcaption>Flame graph view in Firefox profiling tool</figcaption></figure><h3>Custom version of&nbsp;dune</h3><p>If you want to profile some custom version of Dune you&rsquo;re working on locally, remember to replace the path to the dune binary when recording.</p><p>First, build the custom version of dune (run the command from wherever the Dune fork is located in your machine):</p><pre>dune build bin/main.exe</pre><p>Then, update the path in perf record (run the command from the folder where the project build you are trying to profile is located):</p><pre>perf record -F 1000 --call-graph dwarf ../dune/_build/default/bin/main.exe build @all</pre><h3>Source lines</h3><p>perf has an option to include the source files linked to each function&nbsp;call:</p><pre>perf report -F +srcline</pre><p>Unfortunately, there does not seem to be a way to view the source lines in Firefox&nbsp;reports.</p><p>In case the visualization of source files is needed, we can use Speedscope instead of Firefox profiling tool.</p><p>After getting the perf report using perf record as explained above, process it with the following commands:</p><pre>perf script -F +srcline &gt; test.perf<br/>./perf-addlines.pl test.perf &gt; test-speedscope.perf</pre><p>You can obtain perf-addlines.pl <a href="https://raw.githubusercontent.com/ibogosavljevic/johnysswlab/master/scripts/perf-addlines.pl">here</a>.</p><p>Now, open test-speedscope.perf from <a href="https://www.speedscope.app/">https://www.speedscope.app/</a>. Remember to select main.exe thread in top selector:</p><figure><img src="https://cdn-images-1.medium.com/max/1024/1*_LJOnS_B8eWfQC3D8dFc0A.png" alt="Flame chart view in Speedscope profiling tool"/><figcaption>Flame chart view in Speedscope profiling tool</figcaption></figure><h3>Memory profiling with&nbsp;memtrace</h3><p>Sometimes you might encounter a lot of work done in garbage collection functions in the traces, like caml_call_gc. In these cases, you might want to know more about how memory is being used in&nbsp;Dune.</p><p>To do this we can use <a href="https://github.com/janestreet/memtrace">memtrace</a>. To add it to your custom dune&nbsp;build:</p><h4>From the Dune&nbsp;folder</h4><ul><li>Install memtrace in the opam switch of your local Dune copy: opam install&nbsp;memtrace</li><li>Add memtrace lib to the main exe&nbsp;<a href="https://github.com/ocaml/dune/blob/c1f54663cecc3268a9206047463bbb96b3fb7d1e/bin/dune#L10">here</a></li><li>Add Memtrace.trace_if_requested (); in the main entry point&nbsp;<a href="https://github.com/ocaml/dune/blob/c1f54663cecc3268a9206047463bbb96b3fb7d1e/bin/main.ml#L104">here</a></li></ul><h4>From your project&nbsp;folder</h4><ul><li>Run your custom version of dune with the flag to activate memtrace: MEMTRACE=dune-build-all.ctf&nbsp;../dune/_build/default/bin/main.exe build&nbsp;@all</li></ul><p>Then you can open the generated report using memtrace-viewer:</p><pre>opam install memtrace_viewer<br/>memtrace-viewer js_of_ocaml-leaky.ctf</pre><figure><img src="https://cdn-images-1.medium.com/max/1024/1*LXncCj1EG3UyRaf1ZhR1xg.png" alt="Main view of a report obtained with OCaml memtrace"/><figcaption>Main view of a report obtained with OCaml&nbsp;memtrace</figcaption></figure><p>For a more complete guide to memtrace, refer to <a href="https://blog.janestreet.com/finding-memory-leaks-with-memtrace/">this&nbsp;link</a>.</p><h3>Garbage collection stats</h3><p>As Dune is an OCaml program, we can request the runtime to print information about the garbage collector by setting the v value in the OCAMLRUNPARAM environment variable. To get a summary of the garbage collection work for an entire build, set v to&nbsp;1024.</p><pre>OCAMLRUNPARAM=v=1024 dune build @all</pre><p>The output looks like&nbsp;this:</p><pre>allocated_words: 5027692323<br/>minor_words: 4856526503<br/>promoted_words: 869694473<br/>major_words: 1040860293<br/>minor_collections: 18873<br/>major_collections: 14<br/>heap_words: 890589184<br/>heap_chunks: 28<br/>top_heap_words: 890589184<br/>compactions: 0<br/>forced_major_collections: 0</pre><p>There are many different messages which can be displayed. All the options are described in <a href="https://v2.ocaml.org/releases/5.1/htmlman/runtime.html#s:ocamlrun-options">the OCaml&nbsp;manual</a>.</p><pre>(verbose) What GC messages to print to stderr. This is a sum of values selected from the following:<br/><br/>1 (= 0x001)<br/>    Start and end of major GC cycle.<br/>2 (= 0x002)<br/>    Minor collection and major GC slice.<br/>4 (= 0x004)<br/>    Growing and shrinking of the heap.<br/>8 (= 0x008)<br/>    Resizing of stacks and memory manager tables.<br/>16 (= 0x010)<br/>    Heap compaction.<br/>32 (= 0x020)<br/>    Change of GC parameters.<br/>64 (= 0x040)<br/>    Computation of major GC slice size.<br/>128 (= 0x080)<br/>    Calling of finalization functions<br/>256 (= 0x100)<br/>    Startup messages (loading the bytecode executable file, resolving shared libraries).<br/>512 (= 0x200)<br/>    Computation of compaction-triggering condition.<br/>1024 (= 0x400)<br/>    Output GC statistics at program exit.<br/>2048 (= 0x800)<br/>    GC debugging messages.<br/>4096 (= 0x1000)<br/>    Address space reservation changes.</pre><h3>Dune internal tracing&nbsp;tools</h3><p>Dune provides at least three ways to inspect what it&rsquo;s doing behind the&nbsp;scenes.</p><h4>--trace-file</h4><p>This flag will generate a json file that can be loaded in Firefox profiling tool or Speedscope, for&nbsp;example:</p><pre>dune build @all --trace-file dune-build-all.json</pre><p>Unfortunately, these traces don&rsquo;t include any of the internal work Dune is doing, only calls to external commands like ocamldep, ocamlc or melc. So it&rsquo;s only useful if you want to investigate slowness in those parts. If you want to keep up with any updates on that functionality, you can follow <a href="https://github.com/ocaml/dune/issues/3862">ocaml/dune#3862</a>.</p><h4>--print-metrics</h4><p>This flag shows some internal measurements taken during the build, both for Memo metrics and also other code. At the moment the latter only includes a single function generic_digest. Example&nbsp;usage:</p><pre>$ dune build @all --print-metrics<br/>Memo graph: 2/1/0 nodes/edges/blocked (restore), 531541/2985230/599695<br/>nodes/edges/blocked (compute)<br/>Memo cycle detection graph: 328685/898708/599695 nodes/edges/paths<br/>(21.26s total, 271.9M heap words)<br/>Timers:<br/>generic_digest - time spent = 0.38s, count = 195711</pre><h4>--dump-gc-stats</h4><p>This flag will print some GC metrics to a given file,&nbsp;e.g.</p><pre>dune build @all --dump-gc-stats all-gc-stats.txt</pre><p>The contents in the generated txt file look&nbsp;like:</p><pre>((minor_words 2753427060.)<br/> (promoted_words 384483892.)<br/> (major_words 398169012.)<br/> (minor_collections 10718)<br/> (major_collections 19)<br/> (heap_words 271897088)<br/> (heap_chunks 28)<br/> (live_words 200276449)<br/> (live_blocks 43138894)<br/> (free_words 71620633)<br/> (free_blocks 16)<br/> (largest_free 8766464)<br/> (fragments 6)<br/> (compactions 1)<br/> (top_heap_words 271897088)<br/> (stack_size 255))</pre><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=a8de589ec268" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/profiling-dune-builds-a8de589ec268">Profiling Dune Builds</a> was originally published in <a href="https://tech.ahrefs.com">Ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
