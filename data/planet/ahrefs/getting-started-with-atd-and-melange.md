---
title: Getting started with ATD and Melange
description: "ATD is a project to create types and data structures that can be serialized
  to JSON. It is very convenient when communicating between\_\u2026"
url: https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081?source=rss----303662d88bae--ocaml
date: 2018-09-12T02:53:58-00:00
preview_image:
featured:
authors:
- Ahrefs
source:
---
    
<p><em>Edit: this article was updated by </em><a href="https://medium.com/u/e8a4820f0de0">Javier Ch&aacute;varri</a> <em>on Oct 2023 to replace the usage of BuckleScript with&nbsp;Melange.</em></p><p><a href="https://github.com/ahrefs/atd">ATD</a> is a project to create types and data structures that can be serialized to JSON. It is very convenient when communicating between multiple processes, creating a REST API or consuming JSON objects from other tools. It can be compared to <a href="https://json-schema.org/">JSON schema</a> or <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>, but with richer types and more features.</p><p>The idea is to write a list of types in a specification file, an&nbsp;.atd file. Then by running atdgen, it is possible to generate code in many languages like OCaml, DLang, Java, Python, Scala, TypeScript, or interface description languages like JSON Schema, to serialize/deserialize values of those types to/from the corresponding JSON.</p><p>Originally, ATD could generate code only for native OCaml. But nowadays it also supports <a href="https://melange.re">Melange</a>, a backend for the OCaml compiler that emits JavaScript. atdgen the cli tool is still a native OCaml binary. But it can output some OCaml code that can be compiled using&nbsp;Melange.</p><p>The work to implement the compatibility with Melange in ATD was funded by <a href="https://ahrefs.com/">Ahrefs</a>. We highly appreciate open source tools. And as much as possible, we prefer to contribute to existing open source projects rather than to re-invent the wheel internally.</p><h3>Installation</h3><p>To install ATD we first need to install <a href="https://opam.ocaml.org/">opam</a> (OCaml package manager). The procedure is simple and documented here: <a href="https://opam.ocaml.org/doc/Install.html">https://opam.ocaml.org/doc/Install.html</a></p><p>Then we need to initialize opam and create a switch. To work with Melange 2.0 or newer versions, we will need at least the version 5.1.0 of the OCaml compiler.</p><pre>opam init -a<br/>opam switch create . 5.1.0 -y</pre><p>Once it is done, we have to install&nbsp;ATD:</p><pre>opam install atdgen</pre><p>Make sure that atdgen is available.</p><pre>$ which atdgen<br/>(current $PWD)/_opam/bin/atdgen</pre><p>Of course, we need&nbsp;Melange.</p><pre>opam install melange</pre><p>We also need the Melange runtime, as it is not currently provided by ATD itself. This runtime is also open-source: <a href="https://github.com/ahrefs/melange-atdgen-codec-runtime">https://github.com/ahrefs/melange-atdgen-codec-runtime</a>.</p><p>This runtime is responsible for the conversion between JSON values and OCaml values. The JSON values are based on the standard <a href="https://melange.re/v2.0.0/api/re/melange/Js/Json/index.html#type-t">Js.Json.t type</a> provided by Melange to be sure that it is easy to interoperate with the rest of the ecosystem.</p><p>It is also published on&nbsp;opam:</p><pre>opam install melange-atdgen-codec-runtime</pre><h3>Project configuration</h3><p>Next, we will add a dune-project file to the root folder. This file tells Dune how our project is configured:</p><pre>(lang dune 3.8)<br/>(using melange 0.1)<br/>(name melange-atdgen-example)</pre><p>After this, we can add a dune file inside the src folder that describes how to compile the code using&nbsp;Melange:</p><pre>(melange.emit<br/> (target example)<br/> (alias example)<br/> (libraries melange.node melange_atdgen_codec_runtime)<br/> (promote (until-clean)))<br/><br/>(rule<br/> (targets meetup_bs.ml meetup_bs.mli)<br/> (deps meetup.atd)<br/> (action<br/>  (run atdgen -bs %{deps})))<br/><br/>(rule<br/> (targets meetup_t.ml meetup_t.mli)<br/> (deps meetup.atd)<br/> (action<br/>  (run atdgen -t %{deps})))</pre><p>For more information about Dune and melange.emit stanza, refer to the <a href="https://dune.readthedocs.io/en/stable/melange.html">Dune documentation site</a>.</p><h3>First ATD definitions</h3><p>It is time to create a first&nbsp;.atd file, containing our types. This part is also documented on <a href="https://atd.readthedocs.io/en/latest/atdgen.html#getting-started">https://atd.readthedocs.io/en/latest/atdgen.html#getting-started</a></p><p>For this example, I decided to go with a meetup event. Put the type definitions in src/meetup.atd.</p><pre>(* This is a comment. Same syntax as in ocaml. *)<br/><br/>type access = [ Private | Public ]<br/><br/>(* the date will be a float in the json and a Js.Date.t in ocaml *)<br/>type date = float wrap &lt;ocaml module=&quot;Js.Date&quot; wrap=&quot;Js.Date.fromFloat&quot; unwrap=&quot;Js.Date.valueOf&quot;&gt;<br/><br/>(* Some people don't want to provide a phone number, make it optional *)<br/>type person = {<br/>  name: string;<br/>  email: string;<br/>  ?phone: string nullable;<br/>}<br/><br/>type event = {<br/>  access: access;<br/>  name: string;<br/>  host: person;<br/>  date: date;<br/>  guests: person list;<br/>}<br/><br/>type events = event list</pre><p>We use the atdgen binary (compiled previously) to generate the ocaml types and the code to serialize/deserialize those&nbsp;types.</p><pre>atdgen -t meetup.atd # generates an ocaml file containing the types<br/>atdgen -bs meetup.atd # generates the code to (de)serialize</pre><p>The generated files&nbsp;are:</p><ul><li>meetup_t.ml(i) which contain the ocaml types corresponding to our ATD definitions.</li><li>meetup_bs.ml(i) which contain the ocaml code to transform from and to json&nbsp;values.</li></ul><p>At this point we can compile our&nbsp;project.</p><pre>dune build</pre><p>If everything worked properly, we now have two&nbsp;.js files in the src/example/src directory, which is where Dune places the generated JavaScript files:</p><pre>$ tree src/example/src<br/>src/example/src<br/>&#9500;&#9472;&#9472; meetup_bs.js<br/>&#9492;&#9472;&#9472; meetup_t.js<br/>0 directories, 3 files</pre><p>At this point, we can create new OCaml/Reason files in the src directory and use all the code atdgen generated for us. Two examples to illustrate that.</p><h3>Query a REST&nbsp;API</h3><p>A common usage of atdgen is to decode the JSON returned by a REST API. Here is a short example, using the reason syntax and <a href="https://github.com/melange-community/melange-fetch">melange-fetch</a>.</p><pre>let get = (url, decode) =&gt;<br/>  Js.Promise.(<br/>    Fetch.fetchWithInit(url, Fetch.RequestInit.make(~method_=Get, ()))<br/>    |&gt; then_(Fetch.Response.json)<br/>    |&gt; then_(json =&gt; json |&gt; decode |&gt; resolve)<br/>  );<br/>let v: Meetup_t.events =<br/>  get(<br/>    &quot;http://localhost:8000/events&quot;,<br/>    Atdgen_codec_runtime.Decode.decode(Meetup_bs.read_events),<br/>  );</pre><h3>Read and write a JSON&nbsp;file</h3><p>Atdgen for Melange doesn&rsquo;t take care of converting a string to a JSON object. Which allows us to use the performant JSON parser included in Node or the&nbsp;browser.</p><pre>let read_events = filename =&gt; {<br/>  /* Read and parse the json file from disk, this doesn't involve atdgen. */<br/>  let json = Node.Fs.readFileAsUtf8Sync(filename) |&gt; Js.Json.parseExn;<br/>  /* Turn it into a proper record. The annotation is of course optional. */<br/>  let events: Meetup_t.events = (<br/>    Atdgen_codec_runtime.Decode.decode(Meetup_bs.read_events, json): Meetup_t.events<br/>  );<br/>  events;<br/>};</pre><p>The reverse operation, converting a record to a JSON object and writing it in a file is also straightforward.</p><pre>let write_events = (filename, events) =&gt;<br/>  /* turn a list of records into json */<br/>  Atdgen_codec_runtime.Encode.encode(Meetup_bs.write_events, events)<br/>  /* convert the json to a pretty string */<br/>  -&gt;(Js.Json.stringifyWithSpace(2))  <br/>  /* write the json in our file */<br/>  |&gt; Node_fs.writeFileAsUtf8Sync(filename);</pre><h3>Full example</h3><p>Now that we have our functions to read and write events, we can build a small cli to pretty print the list of events and add new&nbsp;events.</p><p>The source code of the full example is available <a href="https://github.com/ahrefs/melange-atdgen-codec-runtime/tree/master/example">on&nbsp;github</a>.</p><p>You can run it like&nbsp;this:</p><pre>$ echo &quot;[]&quot; &gt; events.json<br/>$ node src/example/src/cli.js add louis louislouis@nospam.com<br/>$ node src/example/src/cli.js add bob bobbob@nospam.com<br/>$ node src/example/src/cli.js meetup print<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:16 GMT<br/>access: public<br/>host: bob &lt;bob@nospam.com&gt;<br/>guests: 1<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:13 GMT<br/>access: public<br/>host: louis &lt;louis@nospam.com&gt;<br/>guests: 1<br/>$ cat events.json<br/>[<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;bob@nospam.com&quot;,<br/>        &quot;name&quot;: &quot;bob&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678256177,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;bob@nospam.com&quot;,<br/>      &quot;name&quot;: &quot;bob&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  },<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;louis@nospam.com&quot;,<br/>        &quot;name&quot;: &quot;louis&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678253790,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;louis@nospam.com&quot;,<br/>      &quot;name&quot;: &quot;louis&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  }<br/>]</pre><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=1f3a14004081" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081">Getting started with ATD and Melange</a> was originally published in <a href="https://tech.ahrefs.com">Ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
