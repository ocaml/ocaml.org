---
title: Getting started with atdgen and bucklescript
description: "atdgen is a project to create types and data structures that can be
  serialized to JSON. It is very convenient when communicating between\u2026"
url: https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081?source=rss----303662d88bae--ocaml
date: 2018-09-12T02:53:58-00:00
preview_image:
featured:
---

<p><a href="https://github.com/mjambon/atd">atdgen</a> is a project to create types and data structures that can be serialized to JSON. It is very convenient when communicating between multiple processes, creating a REST API or consuming JSON objects from other tools. It can be compared to <a href="https://json-schema.org/">JSON schema</a> or <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>, but with richer types and more features.</p><p>The idea is to write a list of types in a specification file, an&nbsp;.atd file. Then running atdgen, it is possible to generate OCaml or Java code to serialize/deserialize values of those types to/from corresponding json.</p><p>Until very recently, atdgen could generate code only for native OCaml. But <a href="https://github.com/mjambon/atd/pull/44">the support of bucklescript has been merged</a>! atdgen the cli tool is still a native OCaml binary. But it can output some OCaml code that can be compiled using <a href="https://bucklescript.github.io/">bucklescript</a>.</p><p>The work to implement this new feature of atdgen has been funded by <a href="https://ahrefs.com/">Ahrefs</a>. We highly appreciate open source tools. And as much as possible, we prefer to contribute to existing open source projects rather than to re-invent the wheel internally.</p><h3>Installation</h3><p>To install atdgen we first need to install <a href="https://opam.ocaml.org">opam</a> (OCaml package manager), as atdgen doesn&rsquo;t provide ready to use binaries and is only distributed as source package via opam. The procedure is simple and documented here: <a href="https://opam.ocaml.org/doc/2.0/Install.html">https://opam.ocaml.org/doc/2.0/Install.html</a></p><p>Then we need to initialize opam and create a switch. Any version of ocaml greater or equal to 4.03.0 should be&nbsp;fine.</p><pre>opam init -a<br/>opam switch create . 4.07.1 -y</pre><p>Once it is done, we have to install the development version of atdgen. The support of bucklescript is not officially released.</p><pre>opam pin add atd --dev-repo   <br/>opam pin add atdgen --dev-repo</pre><p>Make sure that atdgen is available.</p><pre>$ which atdgen                 <br/>(current $PWD)/_opam/bin/atdgen</pre><p>Of course, we need bucklescript.</p><pre>yarn init                 <br/>yarn add bs-platform --dev</pre><p>We also need the bucklescript runtime for atdgen, as it is not currently provided by atdgen itself. So we have written and open-sourced our version of the runtime&nbsp;: <a href="https://github.com/ahrefs/bs-atdgen-codec-runtime">https://github.com/ahrefs/bs-atdgen-codec-runtime</a>.</p><p>This runtime is responsible for the conversion between JSON values and OCaml values. The JSON values are based on the standard <a href="https://bucklescript.github.io/bucklescript/api/Js.Json.html#TYPEt">Js.Json.t type</a> provided by bucklescript to be sure that it is easy to interoperate with the rest of the ecosystem.</p><p>It is published on npm for easy integration in bucklescript projects.</p><pre>yarn add @ahrefs/bs-atdgen-codec-runtime</pre><h3>Project configuration</h3><p>After the previous section, package.json should be almost ready. We can add a few scripts to make it more convenient to compile the project. Here is how it should look once completed.</p><pre>{<br/>  &quot;name&quot;: &quot;demo-bs-atdgen&quot;,<br/>  &quot;version&quot;: &quot;0.0.1&quot;,<br/>  &quot;description&quot;: &quot;demo of atdgen with bucklescript&quot;,<br/>  &quot;scripts&quot;: {<br/>    &quot;clean&quot;: &quot;bsb -clean-world&quot;,<br/>    &quot;build&quot;: &quot;bsb -make-world&quot;,<br/>    &quot;watch&quot;: &quot;bsb -make-world -w&quot;,<br/>    &quot;atdgen&quot;: &quot;atdgen -t meetup.atd &amp;&amp; atdgen -bs meetup.atd&quot;<br/>  },<br/>  &quot;devDependencies&quot;: {<br/>    &quot;bs-platform&quot;: &quot;^4.0.5&quot;<br/>  },<br/>  &quot;peerDependencies&quot;: {<br/>    &quot;bs-platform&quot;: &quot;^4.0.5&quot;<br/>  },<br/>  &quot;dependencies&quot;: {<br/>    &quot;<a href="http://twitter.com/ahrefs/bs-atdgen-codec-runtime">@ahrefs/bs-atdgen-codec-runtime</a>&quot;: &quot;^1.0.4&quot;<br/>  }<br/>}</pre><p>The bucklescript configuration is very simple. We use the basic configuration that can be found in any bucklescript project. Except that we need to add one dependency to bsconfig.json:</p><pre>{<br/>  &quot;name&quot;: &quot;demo-bs-atdgen&quot;,<br/>  &quot;version&quot;: &quot;0.0.1&quot;,<br/>  &quot;sources&quot;: {<br/>    &quot;dir&quot;: &quot;src&quot;,<br/>    &quot;subdirs&quot;: true<br/>  },<br/>  &quot;package-specs&quot;: {<br/>    &quot;module&quot;: &quot;commonjs&quot;,<br/>    &quot;in-source&quot;: true<br/>  },<br/>  &quot;suffix&quot;: &quot;.bs.js&quot;,<br/>  &quot;bs-dependencies&quot;: [<br/>    &quot;<a href="http://twitter.com/ahrefs/bs-atdgen-codec-runtime">@ahrefs/bs-atdgen-codec-runtime</a>&quot;<br/>  ],<br/>  &quot;warnings&quot;: {<br/>    &quot;error&quot;: &quot;+101&quot;<br/>  },<br/>  &quot;generate-merlin&quot;: true,<br/>  &quot;namespace&quot;: true,<br/>  &quot;refmt&quot;: 3<br/>}</pre><h3>First ATD definitions</h3><p>It is time to create a first&nbsp;.atd file, containing our types. This part is also documented on <a href="https://atd.readthedocs.io/en/latest/tutorial.html#getting-started">https://atd.readthedocs.io/en/latest/tutorial.html#getting-started</a></p><p>For this example, I decided to go with a meetup event. Put the type definitions in src/meetup.atd.</p><pre>(* This is a comment. Same syntax as in ocaml. *)</pre><pre>type access = [ Private | Public ]</pre><pre>(* the date will be a float in the json and a Js.Date.t in ocaml *)<br/>type date = float wrap &lt;ocaml module=&quot;Js.Date&quot; wrap=&quot;Js.Date.fromFloat&quot; unwrap=&quot;Js.Date.valueOf&quot;&gt;</pre><pre>(* Some people don't want to provide a phone number, make it optional *)<br/>type person = {<br/>  name: string;<br/>  email: string;<br/>  ?phone: string nullable;<br/>}</pre><pre>type event = {<br/>  access: access;<br/>  name: string;<br/>  host: person;<br/>  date: date;<br/>  guests: person list;<br/>}</pre><pre>type events = event list</pre><p>We use the atdgen binary (compiled previously) to generate the ocaml types and the code to serialize/deserialize those&nbsp;types.</p><pre>atdgen -t meetup.atd # generates an ocaml file containing the types<br/>atdgen -bs meetup.atd # generates the code to (de)serialize</pre><p>The generated files&nbsp;are:</p><ul><li>meetup_t.ml(i) which contain the ocaml types corresponding to our ATD definitions.</li><li>meetup_bs.ml(i) which contain the ocaml code to transform from and to json&nbsp;values.</li></ul><p>At this point we can compile our&nbsp;project.</p><pre>yarn build</pre><p>If everything worked properly, we now have two&nbsp;.bs.js files in the src directory.</p><pre>$ tree src<br/>src<br/>&#9500;&#9472;&#9472; meetup.atd<br/>&#9500;&#9472;&#9472; meetup_bs.bs.js<br/>&#9500;&#9472;&#9472; meetup_bs.ml<br/>&#9500;&#9472;&#9472; meetup_bs.mli<br/>&#9500;&#9472;&#9472; meetup_t.bs.js<br/>&#9500;&#9472;&#9472; meetup_t.ml<br/>&#9492;&#9472;&#9472; meetup_t.mli</pre><pre>0 directories, 7 files</pre><p>At this point, we can create new OCaml/Reason files in the src directory and use all the code atdgen generated for us. Two examples to illustrate that.</p><h3>Query a REST&nbsp;API</h3><p>A common usage of atdgen is to decode the JSON returned by a REST API. Here is a short example, using the reason syntax and bs-fetch.</p><pre>let get = (url, decode) =&gt;<br/>  Js.Promise.(<br/>    Fetch.fetchWithInit(<br/>      url,<br/>      Fetch.RequestInit.make(~method_=Get, ()),<br/>    )<br/>    |&gt; then_(Fetch.Response.json)<br/>    |&gt; then_(json =&gt; json |&gt; decode |&gt; resolve)<br/>  );</pre><pre>let v: Meetup_t.events =<br/>  get(<br/>    &quot;<a href="http://localhost:8000/events">http://localhost:8000/events</a>&quot;,<br/>    Atdgen_codec_runtime.Decode.decode(Meetup_bs.read_events),<br/>  );</pre><h3>Read and write a JSON&nbsp;file</h3><p>Atdgen for bucklescript doesn&rsquo;t take care of converting a string to a JSON object. Which allows us to use the performant json parser included in nodejs or the&nbsp;browser.</p><pre>let read_events filename =<br/>  (* Read and parse the json file from disk, this doesn't involve atdgen. *)<br/>  let json =<br/>    Node_fs.readFileAsUtf8Sync filename<br/>    |&gt; Js.Json.parseExn<br/>  in<br/>  (* Turn it into a proper record. The annotation is of course optional. *)<br/>  let events: Meetup_t.events =<br/>    Atdgen_codec_runtime.Decode.decode Meetup_bs.read_events json<br/>  in<br/>  events</pre><p>The reverse operation, converting a record to a JSON object and writing it in a file is also straightforward.</p><pre>let write_events filename events =<br/>  Atdgen_codec_runtime.Encode.encode Meetup_bs.write_events events (* turn a list of records into json *)<br/>  |. Js.Json.stringifyWithSpace 2   (* convert the json to a pretty string *)<br/>  |&gt; Node_fs.writeFileAsUtf8Sync filename  (* write the json in our file *)</pre><h3>Full example</h3><p>Now that we have our functions to read and write events, we can build a small cli to pretty print the list of events and add new&nbsp;events.</p><p>The source code of the full example is available <a href="https://github.com/ahrefs/bs-atdgen-codec-runtime/tree/master/example">on&nbsp;github</a>.</p><p>You can run it like&nbsp;this:</p><pre>$ echo &quot;[]&quot; &gt; events.json<br/>$ nodejs src/cli.bs.js add louis <a href="mailto:louis@nospam.com">louis@nospam.com</a><br/>$ nodejs src/cli.bs.js add bob <a href="mailto:bob@nospam.com">bob@nospam.com</a><br/>$ nodejs src/cli.bs.js print<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:16 GMT<br/>access: public<br/>host: bob &lt;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&gt;<br/>guests: 1<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:13 GMT<br/>access: public<br/>host: louis &lt;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&gt;<br/>guests: 1<br/>$ cat events.json<br/>[<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&quot;,<br/>        &quot;name&quot;: &quot;bob&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678256177,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&quot;,<br/>      &quot;name&quot;: &quot;bob&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  },<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&quot;,<br/>        &quot;name&quot;: &quot;louis&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678253790,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&quot;,<br/>      &quot;name&quot;: &quot;louis&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  }<br/>]</pre><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=1f3a14004081" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081">Getting started with atdgen and bucklescript</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
