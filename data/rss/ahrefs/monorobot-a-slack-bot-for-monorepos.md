---
title: 'Monorobot: a Slack bot for monorepos'
description: "Slack integrations for GitHub don\u2019t work well with monorepos, so
  we built one that does. Now you can use it, too."
url: https://tech.ahrefs.com/monorobot-a-slack-bot-for-monorepos-374260e2ca43?source=rss----303662d88bae--ocaml
date: 2021-12-09T15:19:04-00:00
preview_image: https://miro.medium.com/max/1200/1*BQNCNLNPxGV3eXajYe6y2g.png
featured:
---

<h3>Monorobot: a notification bot for monorepos</h3><figure><img src="https://cdn-images-1.medium.com/max/1024/1*BQNCNLNPxGV3eXajYe6y2g.png" alt=""/><figcaption>Monorobot enables configurable directory tree notifications for your monorepo.</figcaption></figure><p>A few years ago, we decided to move most of our code into a monorepo. Many <a href="https://danluu.com/monorepo/">advocates</a> have highlighted its upsides, which include better cross-project coordination and simpler dependency management.</p><p>But one problem remained: <strong>none of the available GitHub integrations for Slack work nicely with monorepos</strong>. Slack is vital for day to day communication among Ahrefs&rsquo; globally distributed team, so a Slack integration was a must-have feature. We needed a service that could map activity from our various subprojects to their corresponding Slack channels&#8202;&mdash;&#8202;something existing solutions didn&rsquo;t&nbsp;offer.</p><p>That&rsquo;s why we built our own integration: <strong>Monorobot</strong>, a notification bot for monorepos. We&rsquo;ve improved it iteratively since the monorepo transition, incorporating real time feedback from our engineers over time. Today, Monorobot is an active member of Ahrefs&rsquo; Slack workspace, dutifully routing GitHub activity notifications to different channels based on the relevance of each activity.</p><p>And now we&rsquo;re <a href="https://github.com/ahrefs/monorobot">open-sourcing Monorobot</a>, for anybody to use in their monorepo setup! The package is available via&nbsp;<a href="https://opam.ocaml.org/packages/monorobot/">OPAM</a>:</p><pre>opam install monorobot</pre><p>Read on for more details about the motivation, an overview of the main features, and what&rsquo;s in the pipeline.</p><h3>Existing Slack integrations lack monorepo&nbsp;support</h3><p>Within a monorepo, multiple projects have their code located in separate, nested directories. Correspondingly, each project&rsquo;s Slack channel is only interested in activity from that part of the overall repository. The issue with most GitHub-to-Slack integrations is that once you subscribe a Slack channel to a GitHub repository, the channel receives <em>all</em> activity from that repository.</p><p>Suppose we operate various camel-related services, and we&rsquo;re planning to launch a new camel ride-sharing app called Camel Ride. The directory structure could look like&nbsp;this:</p><pre>monorepo/<br/>| frontend/<br/>| | camelride_ui/<br/>| | | mobile/<br/>| | | web/<br/>| | cameldance/<br/>| backend/<br/>| | camelride/<br/>| | | routing/<br/>| | | pricing/<br/>| | camelfood/</pre><p>As you can see, both the frontend/ and backend/ directories contain code for our fictitious ride-sharing service, along with code from other projects.</p><p>If we were to connect the <a href="https://slack.com/help/articles/232289568-GitHub-for-Slack">GitHub for Slack</a> integration to this repository, notifications for activity from all projects would be sent to the same channel. Even if I were only interested in activity from the Camel Ride project, I&rsquo;d need to sift through notifications from the other, unrelated projects. Imagine the volume of notifications this would create for a larger monorepo with dozens of projects. What a&nbsp;mess!</p><h3>Enter Monorobot</h3><figure><img src="https://cdn-images-1.medium.com/max/1024/1*ZHkBDdpNcMMw29BmHirM_A.png" alt=""/><figcaption>Monorobot, hard at&nbsp;work.</figcaption></figure><p>Monorobot enables more granular control over where notifications from the same repository get routed, depending on the type of activity. This routing behavior can be defined in a configuration file named&nbsp;.monorobot.json, which should be committed to the root of the monorepo. Once you create a <a href="https://docs.github.com/en/developers/webhooks-and-events/webhooks/about-webhooks">GitHub webhook</a> from the repository to a running instance of Monorobot, it will use the configuration file to route notifications to relevant channels based on the webhook event&nbsp;payload:</p><ul><li>For pushed commits, it checks the path prefixes of the files modified in the&nbsp;commits.</li><li>For activity related to PRs and issues, it checks their&nbsp;labels.</li><li>For status updates on pushed commits (e.g., CI builds), it uses the same path prefix logic as pushed&nbsp;commits.</li></ul><p>Additionally, Monorobot supports unfurling GitHub links shared in&nbsp;Slack.</p><h4>Path prefix routing for commit push notifications</h4><p>Continuing with our example, suppose we want to route all commit activity related to the Camel Ride project to a Slack channel called <em>#camelride</em>. Our configuration file might look like&nbsp;this:</p><pre>{<br/>  ...,<br/>  &quot;prefix_rules&quot;: {<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;frontend/camelride_ui/&quot;,<br/>          &quot;backend/camelride/&quot;<br/>        ],<br/>        &quot;ignore&quot;: [<br/>          &quot;frontend/camelride_ui/images&quot;,<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Each rule &ldquo;matches&rdquo; a file path to a channel. Whenever someone pushes a commit touching files with either of these prefixes, the <em>#camelride</em> channel will be notified. All other commits will be&nbsp;ignored.</p><p>If a file prefix appears in a rule&rsquo;s optional ignore field, the rule won't be matched even if the prefix is is also in the match field. In the above snippet, the Camel Ride frontend team has decided to silence notifications for activity in the images/ subdirectory.</p><p>Now, let&rsquo;s say the project&rsquo;s price optimization team is growing, and they&rsquo;ve decided to create their own separate Slack channel called <em>#camelride-pricing</em>. We can simply commit an update to the&nbsp;.monorobot.json file, and Monorobot will detect the configuration change:</p><pre>{<br/>  ...,<br/>  &quot;prefix_rules&quot;: {<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;frontend/camelride_ui/&quot;,<br/>          &quot;backend/camelride/&quot;<br/>        ],<br/>        &quot;ignore&quot;: [<br/>          &quot;frontend/camelride_ui/images&quot;,<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      },<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;backend/camelride/pricing/&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride-pricing&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Since Monorobot will match the rule with the longest matched prefix, only commits related to the price optimization aspect of Camel Ride will notify <em>#camelride-pricing</em>, and all other general Camel Ride commits will notify <em>#camelride</em>.</p><p>There are additional configuration options for prefix rules (and for label rules discussed in the next section) that aren&rsquo;t mentioned here. Visit the <a href="https://github.com/ahrefs/monorobot">repository</a> for the full&nbsp;details.</p><h4>Label-based routing for PRs and issue notifications</h4><p>For activity related to pull requests and issues (opening, closing, merging, commenting, and reviewing), Monorobot uses labels to determine routing. The format is largely the same as for path prefix&nbsp;routing:</p><pre>{<br/>  ...,<br/>  &quot;label_rules&quot;: {<br/>    &quot;default_channel&quot;: &quot;notifications&quot;,<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;Camel Ride&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      },<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;Price Optimization&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride-pricing&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Here, all PRs and issues with the &ldquo;Camel Ride&rdquo; label will have activity sent to <em>#camelride</em>; those with the &ldquo;Price Optimization&rdquo; label to <em>#camelride-pricing</em>; and those with both labels to both channels.</p><p>The default_channel field provides an option to fall back on a channel if no rule is matched; this option is available for prefix rules as&nbsp;well.</p><h4>Status notifications</h4><p>Monorobot also supports build status notifications for CI pipelines. When it receives a status update for a pushed commit, it routes it to the relevant channel(s) by applying the prefix rules to the commit associated with the build. Further filtering based on status (e.g., ignoring canceled builds, and only notifying for a successful build when preceded by a failed one) is also possible.</p><h4>Link unfurling</h4><p>Finally, Monorobot can unfurl links to GitHub repositories shared on Slack (including private ones, if a personal access token is provided). This applies to commit, issue, and pull request&nbsp;URLs.</p><h3>What&rsquo;s next</h3><p>Monorobot is actively used at Ahrefs today, but there are lots of promising future directions it could take. Here, we list a&nbsp;few.</p><h4>Unifying GitHub and Slack identities</h4><p>It would be useful to allow GitHub user IDs to be mapped to Slack ones. This would enable more personalized features for Monorobot, such as direct messaging a user when their review is requested or when a CI build fails on a feature branch they authored.</p><h4>Consolidating notifications</h4><p>Sometimes, a collection of multiple GitHub webhook events makes sense to be grouped and delivered as a single Slack notification. For example, pull request reviews generate discrete webhook events for each review comment, but it would make more sense to pool them together, so as not to spam a channel with many notifications.</p><h4>Better status notifications</h4><p>A CI build failure can have multiple potential causes:</p><ol><li>A bad&nbsp;commit</li><li>A previous bad commit that has yet to be&nbsp;fixed</li><li>An issue with the pipeline itself (this is out of scope for Monorobot)</li></ol><p>It can be quite tricky to discern between the first two causes from the GitHub webhook event alone. Cause 1 is handled well by our current approach of using path prefix routing on the commit associated with the build. But with cause 2, that same approach doesn&rsquo;t always send the build failure notification to the channel where it is actually relevant. In that case, the originator of the initial bad commit won&rsquo;t be nagged about all subsequent failures, and Slack channels with no relevance to the cause of failure will get polluted with unnecessary notifications.</p><p>How can we best determine whether a status notification is &ldquo;relevant&rdquo; to a Slack channel? This is still an open question, but one possible direction is to track build state per <em>build step</em> rather than per <em>status</em>, and route notifications based on that. For example, if an overall build fails due to a backend build step failure, then it could be sent to a channel where the frontend team won&rsquo;t be notified.</p><h3>Wrapping up</h3><p>The overall goal of Monorobot is to make Slack notifications more <em>relevant</em> for all teams in a large <em>monorepo environment</em>, using the information available from GitHub webhook events. We&rsquo;ve had fairly positive results with our own internal usage, and now we hope others find it useful as&nbsp;well.</p><p>Monorobot is written in OCaml. <a href="https://github.com/ahrefs/monorobot">We welcome your feedback and contributions on&nbsp;GitHub!</a></p><p>P.S. If anyone does make an actual ride sharing service for camels, do let us&nbsp;know&hellip;</p><p><em>Thanks to Feihong, Igor, and Louis for feedback on this&nbsp;post.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=374260e2ca43" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/monorobot-a-slack-bot-for-monorepos-374260e2ca43">Monorobot: a Slack bot for monorepos</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
