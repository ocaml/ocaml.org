---
title: How to write a library for BuckleScript and Native
description: This blog post is an introduction on how to setup a library available
  for both BuckleScript and OCaml, sharing as much code as possible.
url: https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d?source=rss----303662d88bae--ocaml
date: 2019-10-22T10:09:09-00:00
preview_image:
featured:
---

<p><em>Written with </em><a href="https://twitter.com/javierwchavarri"><em>Javier Ch&aacute;varri</em></a><em> and </em><a href="https://github.com/feihong/"><em>Feihong&nbsp;Hsu</em></a><em>.</em></p><p>The first <a href="https://www.reason-conf.us/">Reason Conf US</a> just ended. Many talks mentioned native compilation. Sharing code between BuckleScript and native artifacts is a use case which is more and more common. This blog post is an introduction on how to set up a library available for both worlds, sharing as much code as possible.</p><h3>The goal</h3><p>What we try to produce is a library with an identical interface for BuckleScript and native. But without duplicating code. It should also be possible to have some parts of the library that are a different implementation depending on the target, as we want to be able to leverage existing libraries that are working only in one of the&nbsp;worlds.</p><h3>The build&nbsp;systems</h3><p>For BuckleScript, there is only one build system: bsb. It is driven by a bsconfig.json file. And is installed as part of the bs-platform.</p><p>On the native side, there are a lot of different build systems that are available. But recently one of them became a de facto standard: dune. It works with a very minimal amount of configuration. And it supports the reason syntax by&nbsp;default.</p><p>These two tools are working in a way which is pretty similar. They share a lot of concepts. And it is easy to set them up so that both are working in the same codebase.</p><p>The main similarities that interest us&nbsp;are:</p><ul><li>The ability to work on specific source directories</li><li>Namespacing in bsb and wrapping in dune are both putting all the<br/>files of the library under a single module&nbsp;name</li></ul><h3>The source code file&nbsp;tree</h3><p>The code of the library is split into 3 directories.</p><pre>&#9500;&#9472;&#9472; js/<br/>&#9500;&#9472;&#9472; native/<br/>&#9492;&#9472;&#9472; shared/</pre><ul><li>shared is meant to host most of the code and all the code in this directory will be compiled in both&nbsp;modes.</li><li>js contains the parts that are specific to BuckleScript.</li><li>native contains the parts that are specific to native&nbsp;OCaml.</li></ul><h3>Set up the build&nbsp;systems</h3><p>Once we have our basic skeleton for the library, it is time to set up the build systems. We want to have two configurations as similar as possible to make them easier to understand. Once we are done, the tree will look like&nbsp;this:</p><pre>&#9500;&#9472;&#9472; bsconfig.json<br/>&#9500;&#9472;&#9472; dune<br/>&#9500;&#9472;&#9472; dune-project<br/>&#9500;&#9472;&#9472; js/<br/>&#9500;&#9472;&#9472; native/<br/>&#9492;&#9472;&#9472; shared/</pre><h4>BuckleScript</h4><p>At the root of the library we need a bsconfig.json file to drive<br/>bsb. The documentation is available at <a href="https://bucklescript.github.io/docs/en/build-configuration%5D(https://bucklescript.github.io/docs/en/build-configuration).">https://bucklescript.github.io/docs/en/build-configuration</a>.</p><p>The main part for us is sources. We will use it to tell bsb to look at the js and shared folders. We also want to set namespace to true, which will wrap all your project&rsquo;s files under a common module&nbsp;name.</p><pre>  &quot;namespace&quot;: true,<br/>  &quot;sources&quot;: [<br/>    {<br/>      &quot;dir&quot;: &quot;js&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }, {<br/>      &quot;dir&quot;: &quot;shared&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }<br/>  ],</pre><p>The rest of the file is as&nbsp;usual.</p><pre>{<br/>  &quot;name&quot;: &quot;sharedlib&quot;,<br/>  &quot;namespace&quot;: true,<br/>  &quot;sources&quot;: [<br/>    {<br/>      &quot;dir&quot;: &quot;js&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }, {<br/>      &quot;dir&quot;: &quot;shared&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }<br/>  ],<br/>  &quot;package-specs&quot;: {<br/>    &quot;module&quot;: &quot;es6&quot;,<br/>    &quot;in-source&quot;: true<br/>  },<br/>  &quot;refmt&quot;: 3,<br/>  &quot;suffix&quot;: &quot;.bs.js&quot;,<br/>  &quot;generate-merlin&quot;: true,<br/>}</pre><h4>Dune</h4><p>We must also add a dune file to the root of the library. For dune, we have different options&#8202;&mdash;&#8202;it is possible to ignore the js directory but read everything else. Or to check only shared and native. To make the configuration similar to BuckleScript, we will go with the second solution.</p><p>The dune directive to do that is dirs. By defaults it tells dune to explore every directory except the ones hidden (starting with a dot) or starting with an underscore. <a href="https://dune.readthedocs.io/en/stable/dune-files.html#dirs-since-1-6">More details in dune&rsquo;s documentation</a>. To make it do what we want, the configuration should&nbsp;be:</p><pre>(dirs shared native)</pre><p>We also use another option of dune to tell it to include the content of those two directories as if it was at the root of the project. Without this stanza, dune would only use the source files at the root of the project and ignore everything in the sub directories.</p><pre>(include_subdirs unqualified)</pre><p>Then we need the usual library stanza to give a name to our library, state the dependencies, compilation flags, etc. In our simple case, the only information needed is the name. We can explicitly set wrapped to true, but this is already the default behavior. The <a href="https://dune.readthedocs.io/en/stable/dune-files.html#library">documentation for the whole library stanza</a> describes how to specify more&nbsp;details.</p><p>The final dune file looks like&nbsp;this:</p><pre>(dirs shared native)<br/> (include_subdirs unqualified)<br/> (library<br/>  (name sharedlib))</pre><p>We also want a basic dune-project. If we don&rsquo;t write it by hand, dune will generate it for us. I am using version 1.10 as an example. But it can be changed to whatever version suits your&nbsp;project.</p><pre>(lang dune 1.10)</pre><h3>Compilation</h3><p>With the setup described above, the compilation for BuckleScript and native is the same as in a setup with only one or the&nbsp;other.</p><ul><li>bsb -make-world for BuckleScript</li><li>dune build @all for&nbsp;dune</li></ul><p>The call to bsb is usally put in package.json in the scripts part, so that the usual yarn build can be used. For native, it depends if you rely on esy or&nbsp;opam.</p><h3>How to consume the&nbsp;library</h3><p>This is exactly the same setup that would be used in a pure BuckleScript or pure native&nbsp;library.</p><p>To use your library in BuckleScript:</p><ul><li>Add the name and version to package.json</li><li>Add the name to bsbconfig.json of consuming library/app</li></ul><p>To use your library in native OCaml, add the name of your library to the libraries part an executable or library stanza,&nbsp;e.g.</p><pre>(executable<br/> (name main)<br/> (libraries sharedlib))</pre><h3>Module naming</h3><p>If you want your module name to contain capital letters in the middle (e.g. TeenageMutantNinjaTurtles), then be aware that <a href="https://bucklescript.github.io/docs/en/build-configuration.html#name-namespace">name munging</a> works differently between bsbconfig.json and dune. For example, if you want to refer to your module as CoolSharedLib in your code, then the name in bsbconfig.json must be cool-shared-lib, and in dune it must be coolSharedLib.</p><h3>Platform specific&nbsp;code</h3><p>The whole library does not have to be exactly the same in the two platform. It is possible to add modules that are available only in one mode. Or to have modules with a different interface.</p><p>For example, by adding a file Foo.re in js but not in native, the library now has a module Foo available when compiled to javascript. But only when compiled to javascript.</p><h3>Downsides</h3><ul><li>Both bsb and dune generate&nbsp;.merlin files when they compile our library. They override each other. It might be troublesome if the version of ocaml used for native code is not 4.02.3. Simply recompile the library for your platform to solve the&nbsp;problem.</li><li>Out of the box, this approach doesn&rsquo;t really allow us to share interface files between both platforms: native and BuckleScript. One workaround for that, if we wanted to share some module Foo, is to:<br/>1. add Foo.mli or Foo.rei file in shared<br/>2. add include FooImplementation in Foo.ml<br/>3. add FooImplementation in both native and js&nbsp;folder</li><li>It&rsquo;s not possible to be platform specific for just a few lines of code (e.g. if IS_NATIVE foo else bar), the minimal per-platform unit is a file/module.</li></ul><h3>Example project</h3><p>We have set up a simple library to showcase what a repository looks like once the whole configuration is in place. It is <a href="https://github.com/ahrefs/hello-native-bucklescript">available on&nbsp;github</a>.</p><p>For now the repository contains only a library. But with this setup, it is actually possible to build an executable too. It is also possible to enrich it, for example by adding <a href="https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081">atdgen to communicate between both sides of the&nbsp;library</a>.</p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=22f45e5e946d" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d">How to write a library for BuckleScript and Native</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
