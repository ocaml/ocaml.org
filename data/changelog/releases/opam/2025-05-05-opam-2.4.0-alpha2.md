---
title: opam 2.4.0~alpha2
tags:
- opam
- platform
authors:
- kit-ty-kate
contributors:
changelog: |
    ## Changes

    *   Do not include compiler packages flagged with `avoid-version`/`deprecated` in the generated invariant when calling `opam switch create [name] <version>` \[[#6494](https://github.com/ocaml/opam/pull/6494) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   Cygwin: Fallback to the existing `setup-x86_64.exe` if its upgrade failed to be fetched \[[#6482](https://github.com/ocaml/opam/pull/6482) [@kit-ty-kate](https://github.com/kit-ty-kate) - fix [#6495](https://github.com/ocaml/opam/issues/6495), partial fix [#6474](https://github.com/ocaml/opam/issues/6474)\]
    *   Fix a memory leak happening when running large numbers of commands or opening large number of opam files \[[#6485](https://github.com/ocaml/opam/pull/6485) [@hannesm](https://github.com/hannesm) - fix [#6484](https://github.com/ocaml/opam/issues/6484)\]
    *   Remove handling of the `OPAMSTATS` environment variable \[[#6485](https://github.com/ocaml/opam/pull/6485) [@hannesm](https://github.com/hannesm)\]

    ### Regression fixes from 2.4.0~alpha1

    *   Fix a crash when updating a repository that is deleting or adding empty files \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   Fix an extreme performance issue (takes several hours) when applying a large repository update \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   Fix a crash when updating a git repository that moved a file to a new directory \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]

    ### Build changes

    *   Update the requirement for the `patch` library to `3.0.0~alpha2` \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   Upgrade the downloaded-if-missing `patch` library to `3.0.0~alpha2` \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]

    ### Testing and documentation

    *   Improve and extend the testsuite \[[#6490](https://github.com/ocaml/opam/pull/6490) [#6494](https://github.com/ocaml/opam/pull/6494) [@rjbou](https://github.com/rjbou) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   Improve and extend the test infrastructure \[[#6277](https://github.com/ocaml/opam/pull/6277) [@rjbou](https://github.com/rjbou) [@kit-ty-kate](https://github.com/kit-ty-kate)\]

    ## API updates

    ### opam-core

    *   `OpamArg.environment_variable`: make `STATS` as removed from cli 2.3 \[[#6485](https://github.com/ocaml/opam/pull/6485) [@rjbou](https://github.com/rjbou)\]
    *   `OpamClientConfig`: remove `STATS` variant and related `print_stats` field in config record \[[#6485](https://github.com/ocaml/opam/pull/6485) [@hannesm](https://github.com/hannesm)\]

    ### opam-format

    *   `OpamFile`: remove `Stats` module \[[#6485](https://github.com/ocaml/opam/pull/6485) [@hannesm](https://github.com/hannesm)\]

    ### opam-core

    *   `OpamSystem`: remove `print_stats` function \[[#6485](https://github.com/ocaml/opam/pull/6485) [@hannesm](https://github.com/hannesm)\]
    *   `OpamSystem`: add the `rmdir_cleanup` function \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   `OpamSystem.dir_is_empty`: Speedup and change its type to handle unreachable directories better \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   `OpamSystem.internal_patch`: remove parent directories when all of their content has been moved somewhere else \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
    *   `OpamSystem.internal_patch`: fix moving files to new directories when receiving a git diff \[[#6490](https://github.com/ocaml/opam/pull/6490) [@kit-ty-kate](https://github.com/kit-ty-kate)\]
versions:
unstable: true
ignore: false
github_release_tags:
- 2.4.0-alpha2
---

This is the second alpha release of opam 2.4.0.

Binaries and full archive are signed by the [opam dev team](https://opam.ocaml.org/opam-dev-pubkey.pgp) (fingerprint `92C5 26AE 50DF 3947 0EB2 911B ED4C F1CA 67CB AA92`).

Please see our [blog post](https://opam.ocaml.org/blog/opam-2-4-0-alpha2) for a highlight on the major changes and upgrade instructions.
