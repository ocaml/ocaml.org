type active_nav_item =
  | Learn
  | Packages
  | Community
  | Blog
  | Playground

let menu_link
~(active: bool)
~href
~title
?(_class="")
()
=
  <a href="<%s href %>" class="block font-normal py-3 mg:py-4 px-1 lg:px-3 hover:text-primary dark:hover:text-dark-primary<%s _class %> <%s if active then "text-primary dark:text-dark-primary underline" else "text-title dark:text-dark-title" %>"><%s title %></a>


let render
?(show_get_started=true)
?(active_top_nav_item: active_nav_item option)
()
=
let search_dropdown () =
  <div id="header-search-results" aria-live="polite"></div>
  <a class="flex py-2 px-2 mx-2 gap-4 hover:bg-primary_nav_block_hover_10 dark:hover:bg-dark-primary_nav_block_hover_10 font-normal rounded-md text-primary dark:text-dark-primary" href="<%s Url.api %>">
    Standard Library API
    <%s! Icons.arrow_top_right_on_square "w-6 h-6" %>
  </a>
in
let darkmode_switch =
  <div x-data class="relative">
    <button class="mr-4" :class="$store.themeSettings.preference? 'text-primary dark:text-dark-primary' : 'text-title dark:text-dark-title'" @click="$store.themeSettings.open = !$store.themeSettings.open">
      <template x-if="$store.themeSettings.preference === 'light'">
        <%s! Icons.light_mode "h-8 w-8" %>
      </template>
      <template x-if="$store.themeSettings.preference === 'dark'">
        <%s! Icons.dark_mode "h-8 w-8" %>
      </template>
      <template x-if="!$store.themeSettings.preference && $store.themeSettings.isSystemDefaultDark">
        <%s! Icons.dark_mode "h-8 w-8" %>
      </template>
      <template x-if="!$store.themeSettings.preference && !$store.themeSettings.isSystemDefaultDark">
        <%s! Icons.light_mode "h-8 w-8" %>
      </template>
    </button>

    <ul x-show="$store.themeSettings.open" x-cloak @click.outside="$store.themeSettings.open = false" class="absolute bg-white dark:bg-dark-card rounded-lg shadow-lg w-36 py-1 mt-8 top-[20%] -left-full z-50 border border-separator_20 dark:border-dark-separator_30 text-sm text-title dark:text-dark-title" role="listbox">
      <li class="py-1 px-2 flex items-center cursor-pointer hover:bg-[#E2E9F3] dark:hover:bg-dark-card_hover" @click="$store.themeSettings.storageAccess? $store.themeSettings.togglePreference('light') : $store.themeSettings.openAlert('light')" :class="$store.themeSettings.preference === 'light'? 'bg-[#E2E9F3] dark:bg-dark-card_hover' : ''">Light</li>
      <li class="py-1 px-2 flex items-center cursor-pointer hover:bg-[#E2E9F3] dark:hover:bg-dark-card_hover" :class="$store.themeSettings.preference === 'dark'? 'bg-[#E2E9F3] dark:bg-dark-card_hover' : ''" @click="$store.themeSettings.storageAccess? $store.themeSettings.togglePreference('dark') : $store.themeSettings.openAlert('dark')">Dark</li>
      <li class="py-1 px-2 flex items-center cursor-pointer hover:bg-[#E2E9F3] dark:hover:bg-dark-card_hover" :class="!$store.themeSettings.preference? 'bg-[#E2E9F3] dark:bg-dark-card_hover' : ''" @click="$store.themeSettings.togglePreference('system')">System</li>
    </ul>
  </div>
in

<header
  class="h-20 flex items-center bg-sand dark:bg-dark-background_navigation"
  x-data="{ open: false }">
  <nav class="container-fluid wide header flex justify-between items-center gap-5 xl:gap-8">
    <ul class="order-0 space space-x-5 xl:space-x-8 items-center flex text-content font-medium dark:text-title dark:text-opacity-60 dark:font-semibold">
      <li style="width:132px">
        <a href="<%s Url.index %>" class="block pb-2">
          <img src="<%s Ocamlorg_static.Asset.url "logo-with-name.svg" %>" width="132" alt="OCaml logo" class="dark:hidden">
          <img src="<%s Ocamlorg_static.Asset.url "logo-with-name-white.svg" %>" width="132" alt="OCaml logo" class="hidden dark:inline">
        </a>
      </li>
    </ul>
    <ul class="order-2 hidden lg:flex items-center">
      <li>
        <%s! darkmode_switch %>
      </li>
      <li>
        <form
          <%s! Packages_autocomplete_fragment.form_attributes %>
          action="/packages/search" method="GET">
          <%s! Forms.search_input
            ~name:"q"
            ~label:"Search OCaml packages"
            ~button_attrs:{|type="submit"|}
            ~input_attrs:({|@keydown.stop |} ^ Packages_autocomplete_fragment.input_attributes ~target_sel:"#header-search-results" ~indicator_sel:"#header-search-indicator")
            ~dropdown_html:(search_dropdown ())
            "lg:w-56 xl:w-80"
          %>
        </form>
      </li>
    </ul>
    <ul class="order-1 mr-auto items-center hidden lg:flex font-medium dark:text-white dark:text-opacity-60 dark:font-semibold">
      <li><%s! menu_link ~active:(active_top_nav_item=Some Learn) ~href:Url.learn ~title:"Learn" () %></li>
      <li><%s! menu_link ~active:(active_top_nav_item=Some Packages) ~href:Url.packages ~title:"Packages" () %></li>
      <li><%s! menu_link ~active:(active_top_nav_item=Some Community) ~href:Url.community ~title:"Community" () %></li>
      <li><%s! menu_link ~active:(active_top_nav_item=Some Blog) ~href:Url.blog ~title:"Blog" () %></li>
      <li><%s! menu_link ~active:(active_top_nav_item=Some Playground) ~href:Url.playground ~title:"Playground" () %></li>
    </ul>
    <% if show_get_started then (%>
    <ul class="order-3 hidden lg:flex items-center">
      <li><a href="<%s Url.getting_started %>" class="border border-primary dark:border-dark-primary text-primary dark:text-dark-primary font-bold py-2.5 px-7 whitespace-nowrap rounded">Get Started</a></li>
    </ul>
    <% ); %>
    <ul class="order-1 lg:hidden flex items-center">
      <li>
        <%s! darkmode_switch %>
      </li>
      <li
        class="h-12 w-12 hover:bg-primary_25 dark:hover:bg-primary_20 flex items-center justify-center rounded-full text-content dark:text-dark-title">
        <button aria-label="open menu" @click="open = ! open">
          <%s! Icons.hamburger_menu "h-8 w-8" %>
        </button>
      </li>
    </ul>
  </nav>

  <div class="bg-black fixed w-full h-full left-0 top-0 opacity-60 z-40" x-show='open' x-cloak></div>

  <div class="fixed inset-0 flex items-center justify-center z-50" x-show='$store.themeSettings.alertOpen' x-cloak>
    <div class="bg-black fixed inset-0 opacity-60"></div>
    <div class="p-8 rounded-lg shadow-lg relative bg-white dark:bg-dark-card text-content dark:text-dark-content">
      <p>This settings requires us to access your browser's storage?</p>
      <div class="flex justify-center mt-5">
        <button class="mr-8 hover:bg-[#E2E9F3] dark:hover:bg-dark-card_hover px-7 rounded" @click="$store.themeSettings.declineAlert()">Decline</button>
        <button class="btn" @click="$store.themeSettings.confirmAlert()">Accept</button>
      </div>
    </div>
  </div>

  <nav class="z-50 h-full fixed right-0 top-0 max-w-full w-96 bg-background dark:bg-dark-background shadow-lg" x-show="open" x-cloak
    @click.away="open = false" x-transition:enter="transition duration-200 ease-out"
    x-transition:enter-start="translate-x-full" x-transition:leave="transition duration-100 ease-in"
    x-transition:leave-end="translate-x-full">
    <ul class="text-content p-6 font-semibold">
      <li class="flex justify-between items-center">
        <a href="<%s Url.index %>">
          <img src="<%s Ocamlorg_static.Asset.url "logo-with-name.svg" %>" width="132" alt="OCaml logo" class="dark:hidden">
          <img src="<%s Ocamlorg_static.Asset.url "logo-with-name-white.svg" %>" width="132" alt="OCaml logo" class="hidden dark:inline">
        </a>

        <div class=""
          x-on:click="open = false">
          <button aria-label="close" class="text-content dark:text-dark-title">
            <%s! Icons.close_x "h-8 w-8" %>
          </button>
        </div>
      </li>
      <li class="mt-6 mb-3">
        <form action="/packages/search" method="GET">
          <%s! Forms.search_input
            ~name:"q"
            ~label:"Search OCaml packages"
            ~button_attrs:{|type="submit"|}
            ""
            %>
        </form>
      </li>

      <li><%s! menu_link ~_class:"block" ~active:(active_top_nav_item=Some Learn) ~href:Url.learn ~title:"Learn" () %></li>
      <li><%s! menu_link ~_class:"block" ~active:(active_top_nav_item=Some Packages) ~href:Url.packages ~title:"Packages" () %></li>
      <li><%s! menu_link ~_class:"block" ~active:(active_top_nav_item=Some Community) ~href:Url.community ~title:"Community" () %></li>
      <li><%s! menu_link ~_class:"block" ~active:(active_top_nav_item=Some Blog) ~href:Url.blog ~title:"Blog" () %></li>
      <li><%s! menu_link ~_class:"block" ~active:(active_top_nav_item=Some Playground) ~href:Url.playground ~title:"Playground" () %></li>
      <li>
        <a href="<%s Url.api %>" class="flex py-3 px-1 gap-4 font-semibold text-primary dark:text-dark-primary">Standard Library API<%s! Icons.arrow_top_right_on_square "w-6 h-6" %></a>
      </li>
      <li class="mt-3 mb-6">
        <a href="<%s Url.getting_started %>" class="w-full rounded font-normal py-3 px-7 flex items-center justify-center bg-primary dark:bg-dark-primary text-white dark:text-dark-title">Get started</a>
      </li>
      <li>
        <div class="space-x-6 text-2xl flex items-center">
          <a aria-label="OCaml's Discord" href="https://discord.gg/cCYQbqN" class="opacity-60 hover:opacity-100 text-content dark:text-dark-title hover:text-primary dark:hover:text-dark-primary">
            <%s! Icons.discord "w-6 h-6" %>
          </a>
          <a aria-label="The OCaml Compiler on GitHub" href="https://github.com/ocaml/ocaml" class="opacity-60 hover:opacity-100 text-content dark:text-dark-title hover:text-primary dark:hover:text-dark-primary">
            <%s! Icons.github "w-6 h-6" %>
          </a>
          <a aria-label="The OCaml Language Twitter Account" href="https://twitter.com/ocaml_org" class="opacity-60 hover:opacity-100 text-content dark:text-dark-title hover:text-primary dark:hover:text-dark-primary">
            <%s! Icons.twitter "w-6 h-6" %>
          </a>
        </div>
      </li>
    </ul>
  </nav>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('themeSettings', {
        init() {
          this.storageAccess = localStorage.getItem('storageAccess')
          this.preference = localStorage.getItem('theme')
          this.isSystemDefaultDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        },
        open: false,
        selected: '',
        alertOpen: false,
        storageAccess: false,
        preference: undefined,
        isSystemDefaultDark: false,
        togglePreference(preference) {
          if (preference === 'dark') {
            document.body.classList.add("dark");
          } 
          if (preference === 'light') {
            document.body.classList.remove("dark");
          }
          if (preference === 'system') {
            if (this.isSystemDefaultDark) {
              document.body.classList.add("dark");
            } else {
              document.body.classList.remove("dark");
            }
            localStorage.removeItem('theme')
            this.preference = undefined
            this.open = false
            return
          }
          this.preference = preference
          localStorage.setItem('theme', preference)
          this.open = false
        },
        openAlert(selected) {
          this.alertOpen = true
          this.selected = selected
        },
        confirmAlert() {
          this.storageAccess = true
          localStorage.setItem('storageAccess', true)
          this.togglePreference(this.selected)
          this.selected = ''
          this.alertOpen = false
        },
        declineAlert() {
          this.alertOpen = false
          this.open = false
          this.selected = ''
        }
      })
    })
  </script>
</header>