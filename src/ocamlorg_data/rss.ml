
type t =
  { title : string
  ; slug : string
  ; description : string option
  ; url : string
  ; date : string
  ; preview_image : string option
  ; featured : bool
  ; body_html : string
  }
  
let all = 
[
  { title = {js|OCaml Labs Joins Tarides|js}
  ; slug = {js|ocaml-labs-joins-tarides|js}
  ; description = Some {js|Today I am incredibly delighted to announce that OCaml
Labs, a spinout from the
University of Cambridge, is joining
Tarides. After…|js}
  ; url = {js|https://tarides.com/blog/2022-01-27-ocaml-labs-joins-tarides|js}
  ; date = {js|2022-01-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/f77149b54403b557e824e316edede0d7/a1920/cambridge.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Today I am incredibly delighted to announce that <a href="https://anil.recoil.org/projects/ocamllabs">OCaml
Labs</a>, a spinout from the
<a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>, is joining
<a href="https://tarides.com/">Tarides</a>. After successfully collaborating on
many OCaml projects over the last four years, this alliance will
combine the expertise of both groups and enable us to bring OCaml, one
of the most advanced programming languages in the world, into
mainstream use. Combining forces will accelerate OCaml development and
its broader adoption. Furthermore, it will bring the security,
portability, and performance of OCaml to a large spectrum of
use-cases: from academic endeavours, such as formal methods and
existing threats within cyber-security, to real-world applications for
climate change, sustainable agriculture, and even space exploration!</p>
<p>All of OCaml Labs&rsquo; existing responsibilities and open-source
commitments will migrate over to Tarides, and thanks to how closely
the teams already work, business will continue without interruption to
continuity or delivery. Gemma Gordon will step up as CEO of Tarides,
and I will continue to lead the technological vision and strategy as
CTO. As Prof. Anil Madhavapeddy, founder of OCaml Labs and scientific
advisor of Tarides, points out, &ldquo;The cutting edge research we
conducted at the University over the past decade has now migrated into
mainline OCaml, and so the ongoing curation and development will now
happen on a commercially supported basis. I&rsquo;m excited to continue
collaborating on research with Tarides from the University of
Cambridge.&rdquo; Tarides will continue the work started at OCaml Labs and
invest in the growth, health, and development of OCaml alongside its
wider use-cases.</p>
<p>I am honoured to have the incredible OCaml Labs team - the team who
carefully designed and crafted <a href="https://discuss.ocaml.org/tag/multicore-monthly">Multicore OCaml</a> - join Tarides. We
share a similar view that a common plague affects the ever-growing
software industry, namely the bad quality of software and the
omnipresence of bugs. However, this is not a fatal flaw. Tools
developed by OCaml Labs over the years do not compromise on quality,
and they allow dev teams to automatically fix at least 70% of
<a href="https://msrc-blog.microsoft.com/2019/07/18/we-need-a-safer-systems-programming-language/">security
bugs</a>
and <a href="https://googleprojectzero.blogspot.com/p/0day.html">0-days security
exploits</a>. Consequently,
OCaml is a simple yet powerful language that can respond to the many
challenges developers face today. Since Tarides&rsquo;s inception, we have
envisioned a future where all OCaml applications are easily deployable
as specialised, secure, and energy-efficient
<a href="https://mirage.io">MirageOS</a> unikernels. This alliance is a step
further in that direction. Since OCaml is the language used to develop
MirageOS, Tarides has continuously developed and maintained parts of
the OCaml ecosystem since its creation. Our alliance with OCaml Labs
makes this more evident. The MirageOS ecosystem critically depends on
OCaml, and the OCaml ecosystem benefits from innovations coming from
the MirageOS project. Tarides is therefore fully committed to making
the synergy between OCaml and MirageOS a success.</p>
<p>Several exciting projects related to Multicore OCaml are coming to a
head this year. The OCaml 5.0 release will support multicore and
effects handlers, influencing every aspect of the language and its
ecosystem. The update will significantly improve both performance and
user experience whilst maintaining existing features that make OCaml
the language of choice for building, for instance, verification
software tools. Using the teams&rsquo; combined experience and zest for
innovation, Tarides is looking to the future of the OCaml language and
community with excitement. We will continue to push the boundaries of
exploration whilst focusing on what's good for the
community. <strong>Therefore, this alliance will complement the commercial
offering of Tarides and contribute to Tarides' mission: empowering
developers, communities and organisations to adopt OCaml as their
primary programming experience by providing training, expertise, and
development services around the OCaml language.</strong></p>
<p>&ldquo;We are thrilled to be part of an organisation innovating in many
areas around operating systems, distributed systems, and security with
the <a href="https://irmin.org">Irmin</a> distributed store and the MirageOS
unikernel projects,&rdquo; says Gemma Gordon, CEO of Tarides. &ldquo;I am
incredibly proud of the people OCaml Labs has collaborated with. We
have been able to build a sustainable open-source community, with
people from various backgrounds all collaborating together. It used to
be that people would have to volunteer their time on OCaml, or work in
academic research. We have created an additional funded path, one that
has increased the diversity and innovation of our community. I&rsquo;m
excited to continue to be part of a group that brings the best minds
together to solve the many problems the software industry faces
today. I look forward to building a flourishing and sustainable
commercial business with existing Tarides partners as well as
developing new collaborative opportunities.&rdquo;</p>
<p>This alliance brings the headcount of Tarides up to 60+ people, all
working towards making OCaml the best language for any and every
project. Join our team: <a href="https://tarides.com/company">https://tarides.com/company</a></p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#ocaml-labs" aria-label="ocaml labs permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OCaml Labs</h4>
<p><em>OCaml Labs has been at the forefront of innovation in OCaml for
nearly a decade. It was founded at the University of Cambridge by
Prof. Anil Madhavapeddy in 2012 and developed into a spin-out
consultancy company in 2016. OCaml Labs' mission was to push OCaml and
functional programming forward as a platform, making it a more
effective tool for all users (including large-scale industrial
deployments) while at the same time growing the appeal of the language
to broaden its applicability and popularity.</em></p>
<p><em>OCaml Labs has been instrumental in developing and maintaining the
OCaml platform for OCaml usage at an industrial scale. OCaml Labs
contributed to the development and maintenance of the
<a href="https://opam.ocaml.org/">opam</a> package management
ecosystem and of the OCaml community website, <a href="https://ocaml.org/">https://ocaml.org/</a>,
first launched in 2012. These sites act as hubs for the OCaml community
to showcase the state-of-the-art and facilitate innovation. A new and
improved version of the site has been <a href="https://v3.ocaml.org/">released under
beta</a> this month. In addition, OCaml Labs' most
significant (and technically complex) project, OCaml Multicore, will
finally come to fruition this year. Work on this project began in
2014, followed by award-winning papers and presentations in 2020 and
the announcement in late 2021 that Multicore will become part of the
mainline OCaml compiler.</em></p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#tarides" aria-label="tarides permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tarides</h4>
<p><em>Tarides is a tech start-up founded in Paris in 2018 by pioneers of
programming languages and cloud computing. They develop a software
infrastructure platform to deploy secure, distributed applications
with strict resource constraints and low-latency performance
requirements. This platform builds upon innovative and open-source
projects such as MirageOS and Irmin and underpins mission-critical
deployments such as
<a href="https://tarides.com/blog/2021-03-04-florence-and-beyond-the-future-of-tezos-storage">Tezos</a>,
Citrix XenServer, or <a href="https://www.docker.com/blog/how-docker-desktop-networking-works-under-the-hood/">Docker for
Desktop</a>. In
addition, Tarides uses unikernel technologies and applies the research
done in programming languages to real-world systems to build safe and
performant applications.</em></p>
<p><em>Tarides has been part of the Founder program of Station F in 2018. In
addition, it got selected in France for the <a href="https://tarides.com/blog/2019-07-05-i-lab-2019">Concours d&rsquo;Innovation
i-Lab</a>, organised by
the French Ministry of Higher Education, Research and Innovation in
partnership with Bpifrance. This national contest awards company
creation and innovative technologies. Tarides got awarded during the
<a href="https://tarides.com/blog/2019-12-11-tarides-wins-the-fic-2020-startup-award">FIC
2020</a>,
the leading European cybersecurity event.</em></p>|js}
  };
 
  { title = {js|Magic-trace: Diagnosing tricky performance issues easily with Intel Processor Trace|js}
  ; slug = {js|magic-trace-diagnosing-tricky-performance-issues-easily-with-intel-processor-trace|js}
  ; description = Some {js|Intel Processor Trace is a hardware technology that can record allprogram execution flow along with timing information accurate toaround 30ns. As far as I ca...|js}
  ; url = {js|https://blog.janestreet.com/magic-trace/|js}
  ; date = {js|2022-01-11T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/magic-trace/magic-trace-blog-image.jpg|js}
  ; featured = true
  ; body_html = {js|<p>Intel Processor Trace is a hardware technology that can record all
program execution flow along with timing information accurate to
around 30ns. As far as I can tell <a href="https://engineering.fb.com/2021/04/27/developer-tools/reverse-debugging/">a</a><a href="https://easyperf.net/blog/2019/08/23/Intel-Processor-Trace">l</a><a href="https://github.com/nyx-fuzz/libxdc">m</a><a href="https://blog.trailofbits.com/2021/03/19/un-bee-lievable-performance-fast-coverage-guided-fuzzing-with-honeybee-and-intel-processor-trace/">o</a><a href="http://halobates.de/blog/p/410">s</a><a href="https://dl.acm.org/doi/10.1145/3029806.3029830">t</a>
nobody uses it, seemingly because capturing the data is tricky and,
without any visualization tools, you&rsquo;re forced to read enormous text
dumps.</p>|js}
  };
 
  { title = {js|Monorobot: a Slack bot for monorepos|js}
  ; slug = {js|monorobot-a-slack-bot-for-monorepos|js}
  ; description = Some {js|Slack integrations for GitHub don’t work well with monorepos, so we built one that does. Now you can use it, too.|js}
  ; url = {js|https://tech.ahrefs.com/monorobot-a-slack-bot-for-monorepos-374260e2ca43?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2021-12-09T15:19:04-00:00|js}
  ; preview_image = Some {js|https://miro.medium.com/max/1200/1*BQNCNLNPxGV3eXajYe6y2g.png|js}
  ; featured = false
  ; body_html = {js|<h3>Monorobot: a notification bot for monorepos</h3><figure><img src="https://cdn-images-1.medium.com/max/1024/1*BQNCNLNPxGV3eXajYe6y2g.png" alt=""/><figcaption>Monorobot enables configurable directory tree notifications for your monorepo.</figcaption></figure><p>A few years ago, we decided to move most of our code into a monorepo. Many <a href="https://danluu.com/monorepo/">advocates</a> have highlighted its upsides, which include better cross-project coordination and simpler dependency management.</p><p>But one problem remained: <strong>none of the available GitHub integrations for Slack work nicely with monorepos</strong>. Slack is vital for day to day communication among Ahrefs&rsquo; globally distributed team, so a Slack integration was a must-have feature. We needed a service that could map activity from our various subprojects to their corresponding Slack channels&#8202;&mdash;&#8202;something existing solutions didn&rsquo;t&nbsp;offer.</p><p>That&rsquo;s why we built our own integration: <strong>Monorobot</strong>, a notification bot for monorepos. We&rsquo;ve improved it iteratively since the monorepo transition, incorporating real time feedback from our engineers over time. Today, Monorobot is an active member of Ahrefs&rsquo; Slack workspace, dutifully routing GitHub activity notifications to different channels based on the relevance of each activity.</p><p>And now we&rsquo;re <a href="https://github.com/ahrefs/monorobot">open-sourcing Monorobot</a>, for anybody to use in their monorepo setup! The package is available via&nbsp;<a href="https://opam.ocaml.org/packages/monorobot/">OPAM</a>:</p><pre>opam install monorobot</pre><p>Read on for more details about the motivation, an overview of the main features, and what&rsquo;s in the pipeline.</p><h3>Existing Slack integrations lack monorepo&nbsp;support</h3><p>Within a monorepo, multiple projects have their code located in separate, nested directories. Correspondingly, each project&rsquo;s Slack channel is only interested in activity from that part of the overall repository. The issue with most GitHub-to-Slack integrations is that once you subscribe a Slack channel to a GitHub repository, the channel receives <em>all</em> activity from that repository.</p><p>Suppose we operate various camel-related services, and we&rsquo;re planning to launch a new camel ride-sharing app called Camel Ride. The directory structure could look like&nbsp;this:</p><pre>monorepo/<br/>| frontend/<br/>| | camelride_ui/<br/>| | | mobile/<br/>| | | web/<br/>| | cameldance/<br/>| backend/<br/>| | camelride/<br/>| | | routing/<br/>| | | pricing/<br/>| | camelfood/</pre><p>As you can see, both the frontend/ and backend/ directories contain code for our fictitious ride-sharing service, along with code from other projects.</p><p>If we were to connect the <a href="https://slack.com/help/articles/232289568-GitHub-for-Slack">GitHub for Slack</a> integration to this repository, notifications for activity from all projects would be sent to the same channel. Even if I were only interested in activity from the Camel Ride project, I&rsquo;d need to sift through notifications from the other, unrelated projects. Imagine the volume of notifications this would create for a larger monorepo with dozens of projects. What a&nbsp;mess!</p><h3>Enter Monorobot</h3><figure><img src="https://cdn-images-1.medium.com/max/1024/1*ZHkBDdpNcMMw29BmHirM_A.png" alt=""/><figcaption>Monorobot, hard at&nbsp;work.</figcaption></figure><p>Monorobot enables more granular control over where notifications from the same repository get routed, depending on the type of activity. This routing behavior can be defined in a configuration file named&nbsp;.monorobot.json, which should be committed to the root of the monorepo. Once you create a <a href="https://docs.github.com/en/developers/webhooks-and-events/webhooks/about-webhooks">GitHub webhook</a> from the repository to a running instance of Monorobot, it will use the configuration file to route notifications to relevant channels based on the webhook event&nbsp;payload:</p><ul><li>For pushed commits, it checks the path prefixes of the files modified in the&nbsp;commits.</li><li>For activity related to PRs and issues, it checks their&nbsp;labels.</li><li>For status updates on pushed commits (e.g., CI builds), it uses the same path prefix logic as pushed&nbsp;commits.</li></ul><p>Additionally, Monorobot supports unfurling GitHub links shared in&nbsp;Slack.</p><h4>Path prefix routing for commit push notifications</h4><p>Continuing with our example, suppose we want to route all commit activity related to the Camel Ride project to a Slack channel called <em>#camelride</em>. Our configuration file might look like&nbsp;this:</p><pre>{<br/>  ...,<br/>  &quot;prefix_rules&quot;: {<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;frontend/camelride_ui/&quot;,<br/>          &quot;backend/camelride/&quot;<br/>        ],<br/>        &quot;ignore&quot;: [<br/>          &quot;frontend/camelride_ui/images&quot;,<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Each rule &ldquo;matches&rdquo; a file path to a channel. Whenever someone pushes a commit touching files with either of these prefixes, the <em>#camelride</em> channel will be notified. All other commits will be&nbsp;ignored.</p><p>If a file prefix appears in a rule&rsquo;s optional ignore field, the rule won't be matched even if the prefix is is also in the match field. In the above snippet, the Camel Ride frontend team has decided to silence notifications for activity in the images/ subdirectory.</p><p>Now, let&rsquo;s say the project&rsquo;s price optimization team is growing, and they&rsquo;ve decided to create their own separate Slack channel called <em>#camelride-pricing</em>. We can simply commit an update to the&nbsp;.monorobot.json file, and Monorobot will detect the configuration change:</p><pre>{<br/>  ...,<br/>  &quot;prefix_rules&quot;: {<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;frontend/camelride_ui/&quot;,<br/>          &quot;backend/camelride/&quot;<br/>        ],<br/>        &quot;ignore&quot;: [<br/>          &quot;frontend/camelride_ui/images&quot;,<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      },<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;backend/camelride/pricing/&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride-pricing&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Since Monorobot will match the rule with the longest matched prefix, only commits related to the price optimization aspect of Camel Ride will notify <em>#camelride-pricing</em>, and all other general Camel Ride commits will notify <em>#camelride</em>.</p><p>There are additional configuration options for prefix rules (and for label rules discussed in the next section) that aren&rsquo;t mentioned here. Visit the <a href="https://github.com/ahrefs/monorobot">repository</a> for the full&nbsp;details.</p><h4>Label-based routing for PRs and issue notifications</h4><p>For activity related to pull requests and issues (opening, closing, merging, commenting, and reviewing), Monorobot uses labels to determine routing. The format is largely the same as for path prefix&nbsp;routing:</p><pre>{<br/>  ...,<br/>  &quot;label_rules&quot;: {<br/>    &quot;default_channel&quot;: &quot;notifications&quot;,<br/>    &quot;rules&quot;: [<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;Camel Ride&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride&quot;<br/>      },<br/>      {<br/>        &quot;match&quot;: [<br/>          &quot;Price Optimization&quot;<br/>        ],<br/>        &quot;channel&quot;: &quot;camelride-pricing&quot;<br/>      }<br/>    ]<br/>  }<br/>}</pre><p>Here, all PRs and issues with the &ldquo;Camel Ride&rdquo; label will have activity sent to <em>#camelride</em>; those with the &ldquo;Price Optimization&rdquo; label to <em>#camelride-pricing</em>; and those with both labels to both channels.</p><p>The default_channel field provides an option to fall back on a channel if no rule is matched; this option is available for prefix rules as&nbsp;well.</p><h4>Status notifications</h4><p>Monorobot also supports build status notifications for CI pipelines. When it receives a status update for a pushed commit, it routes it to the relevant channel(s) by applying the prefix rules to the commit associated with the build. Further filtering based on status (e.g., ignoring canceled builds, and only notifying for a successful build when preceded by a failed one) is also possible.</p><h4>Link unfurling</h4><p>Finally, Monorobot can unfurl links to GitHub repositories shared on Slack (including private ones, if a personal access token is provided). This applies to commit, issue, and pull request&nbsp;URLs.</p><h3>What&rsquo;s next</h3><p>Monorobot is actively used at Ahrefs today, but there are lots of promising future directions it could take. Here, we list a&nbsp;few.</p><h4>Unifying GitHub and Slack identities</h4><p>It would be useful to allow GitHub user IDs to be mapped to Slack ones. This would enable more personalized features for Monorobot, such as direct messaging a user when their review is requested or when a CI build fails on a feature branch they authored.</p><h4>Consolidating notifications</h4><p>Sometimes, a collection of multiple GitHub webhook events makes sense to be grouped and delivered as a single Slack notification. For example, pull request reviews generate discrete webhook events for each review comment, but it would make more sense to pool them together, so as not to spam a channel with many notifications.</p><h4>Better status notifications</h4><p>A CI build failure can have multiple potential causes:</p><ol><li>A bad&nbsp;commit</li><li>A previous bad commit that has yet to be&nbsp;fixed</li><li>An issue with the pipeline itself (this is out of scope for Monorobot)</li></ol><p>It can be quite tricky to discern between the first two causes from the GitHub webhook event alone. Cause 1 is handled well by our current approach of using path prefix routing on the commit associated with the build. But with cause 2, that same approach doesn&rsquo;t always send the build failure notification to the channel where it is actually relevant. In that case, the originator of the initial bad commit won&rsquo;t be nagged about all subsequent failures, and Slack channels with no relevance to the cause of failure will get polluted with unnecessary notifications.</p><p>How can we best determine whether a status notification is &ldquo;relevant&rdquo; to a Slack channel? This is still an open question, but one possible direction is to track build state per <em>build step</em> rather than per <em>status</em>, and route notifications based on that. For example, if an overall build fails due to a backend build step failure, then it could be sent to a channel where the frontend team won&rsquo;t be notified.</p><h3>Wrapping up</h3><p>The overall goal of Monorobot is to make Slack notifications more <em>relevant</em> for all teams in a large <em>monorepo environment</em>, using the information available from GitHub webhook events. We&rsquo;ve had fairly positive results with our own internal usage, and now we hope others find it useful as&nbsp;well.</p><p>Monorobot is written in OCaml. <a href="https://github.com/ahrefs/monorobot">We welcome your feedback and contributions on&nbsp;GitHub!</a></p><p>P.S. If anyone does make an actual ride sharing service for camels, do let us&nbsp;know&hellip;</p><p><em>Thanks to Feihong, Igor, and Louis for feedback on this&nbsp;post.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=374260e2ca43" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/monorobot-a-slack-bot-for-monorepos-374260e2ca43">Monorobot: a Slack bot for monorepos</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|'Signals and Threads' Podcast: What is an Operating System?|js}
  ; slug = {js|signals-and-threads-podcast-what-is-an-operating-system|js}
  ; description = Some {js|November has become MirageOS month! Between the upcoming official MirageOS 4.0 release, making custom Christmas Tree garlands
with MirageOS…|js}
  ; url = {js|https://tarides.com/blog/2021-11-23--signals-and-threads-podcast-what-is-an-operating-system|js}
  ; date = {js|2021-11-23T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/f29bc7106b13c642c50f91913cbade3e/dcbfe/anilpodcast.jpg|js}
  ; featured = false
  ; body_html = {js|<p>November has become MirageOS month! Between the upcoming official MirageOS 4.0 release, making custom Christmas Tree garlands
with <a href="https://tarides.com/blog/2021-11-11-mirageos-workshop-working-with-the-raspberry-pi-4">MirageOS on a Raspberry Pi</a>,
and now <a href="https://signalsandthreads.com/what-is-an-operating-system">this &quot;What is an Operating System?&quot; podcast</a> (featuring Tarides advisor and core MirageOS maintainer Anil Madhavapeddy), it truly is MirageOS month!</p>
<p>MirageOS can do much more than program a Raspberry Pi for Christmas decor. From
<a href="https://tarides.com/blog/2021-11-18-tarides-hyper-partners-in-agricultural-innovation">agricultural monitoring</a> to
<a href="https://tarides.com/blog/2021-06-29-tarides-introduces-osmose-at-the-open-source-innovation-sprint">smart buildings</a>, its
applications cover a wide range of needs. For example, it can also be used in critical pieces of infrastructure where security is of paramount importance, such as the <a href="https://tarides.com/blog/2020-04-20-the-future-of-tezos-on-mirageos">Tezos blockchain</a>.
Combined with <a href="https://irmin.org">Irmin</a>, it allows developers to build secure-by-design, offline-first systems and invert
the current cloud-centric model for designing applications to securely connect physical spaces with extremely low latency
and high bandwidth, using local-area computation capabilities.</p>
<p>You can read the entire <a href="https://signalsandthreads.com/what-is-an-operating-system/">transcript here</a> and find links to multiple places to listen through podcast apps.</p>|js}
  };
 
  { title = {js|Tarides & Hyper: Partners in Agricultural Innovation|js}
  ; slug = {js|tarides--hyper-partners-in-agricultural-innovation|js}
  ; description = Some {js|We are thrilled to announce a partnership between Tarides and Hyper, a technology provider in the agritech space who’s building
an…|js}
  ; url = {js|https://tarides.com/blog/2021-11-18-tarides-hyper-partners-in-agricultural-innovation|js}
  ; date = {js|2021-11-18T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/6e815455d642f44ecdd6d2b080c8d64f/0132d/hyper.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are thrilled to announce a partnership between Tarides and <a href="https://hyper.ag">Hyper</a>, a technology provider in the agritech space who&rsquo;s building
an &quot;operating system for high-performing farms.&quot; Indoor and vertical farms are becoming tech businesses that require scalable,
flexible, and easy-to-use tools to facilitate data analysis and thereby increase productivity. According to the <a href="https://www.eitfood.eu/blog/post/is-vertical-farming-really-sustainable">State of Indoor
Farming 2020 Report</a>, &ldquo;40% of vertical and indoor farms are
implementing data analytics and control automation to increase yield and lower cost of production.&rdquo;</p>
<p>Hyper&rsquo;s product offers a developer-friendly platform for modern farms to integrate analytics and automation without
worrying about hardware, scaling, or maintenance. There is a natural synergy between Hyper's product and Tarides&rsquo;s mission
to bring robust and scalable functional systems to the industry. Both teams will be working on technology to help solve
some big problems the world faces.</p>
<p>First, some context about how agriculture affects our environment:<br/>
<strong>The world&rsquo;s population is growing, but the size of our planet is not.</strong></p>
<p>Agriculture is currently responsible for:</p>
<ul>
<li>75% of the world&rsquo;s deforestation<sup><a href="https://tarides.com/feed.xml#fn-1" class="footnote-ref">1</a></sup></li>
<li>50% of the world&rsquo;s habitable land</li>
<li>70% of the world's freshwater withdrawals</li>
<li>26% of the greenhouse gas emissions<sup><a href="https://tarides.com/feed.xml#fn-2" class="footnote-ref">2</a></sup></li>
</ul>
<p>It&rsquo;s an important time for indoor farming, as it&rsquo;s already producing twenty times (20x) more yield per area while using 95% less water and
zero (0) pesticides. Plus, indoor farming will reduce the carbon footprint by cutting their food miles in half (50%)<sup><a href="https://tarides.com/feed.xml#fn-3" class="footnote-ref">3</a></sup>. Vertical farming
complements traditional farming by growing fresh produce for cities in a sustainable way.</p>
<p>Hyper's mission is to simplify the integration of sensors and controllers for data collection and automation. Their roadmap is
focused on implementing real-time computation of metrics for environmental data gathered from farms, prototyping computer vision models
for crop analysis, and automated crop traceability infrastructure. With their data platform, growers can optimise yield and reduce operating
costs by getting access to crop growth metrics and climate automation profiles without a dedicated engineering team.</p>
<p>Hyper's founders are experienced engineers and OCaml hackers who have worked on IoT and data analytics products in the past in the retail,
biotech, and multimedia industries. Utilizing our MirageOS ecosystem, Hyper's sensor networks and cameras are continuously collecting
millions of data points across large-scale farming operations to ensure consistent crop quality, detect issues early, and automate climate
control. Since the technology is offline-first, it enables Hyper to collect this data securely, without the risk of breach or loss, as is
sometimes the case in cloud computing.</p>
<p>As a technological partner, Tarides will help Hyper build a scalable IoT platform that leverages the OCaml ecosystem. Our support will
help Hyper bring the product to the market faster while also contributing to the open-source IoT ecosystem for MirageOS and related
projects. Hyper&rsquo;s IoT platform will be fully open-source next year and will focus on implementing better support for MQTT, CoAP, and other protocols.</p>
<p>A new version of MirageOS will be released in November, so this exciting announcement couldn't come at a better time! Hyper&rsquo;s use of
the <a href="https://mirage.io">MirageOS</a> ecosystem to build its data intelligence product is yet another real-world example that displays the
power and efficiency of MirageOS.</p>
<p>It&rsquo;s truly exciting technology because we&rsquo;re at a point in history where even the most adamant climate change critics have begun to admit
the climate is indeed changing. There are things we can each do to contribute, so Tarides is proud to collaborate with a company that&rsquo;s
actively seeking solutions to help reduce the amount of greenhouse gas emissions while increasing productivity.</p>
<p>Hyper currently has production deployments in vertical and indoor farms in the UK and East Africa and is planning on scaling the
operations in the coming months.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#sources" aria-label="sources permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SOURCES</h4>
<div class="footnotes">
<hr/>
<ol>
<li><a href="https://ourworldindata.org/drivers-of-deforestation">https://ourworldindata.org/drivers-of-deforestation</a><a href="https://tarides.com/feed.xml#fnref-1" class="footnote-backref">&#8617;</a></li>
<li><a href="https://ourworldindata.org/food-ghg-emissions">https://ourworldindata.org/food-ghg-emissions</a><a href="https://tarides.com/feed.xml#fnref-2" class="footnote-backref">&#8617;</a></li>
<li><a href="https://ourworldindata.org/environmental-impacts-of-food">https://ourworldindata.org/environmental-impacts-of-food</a><a href="https://tarides.com/feed.xml#fnref-3" class="footnote-backref">&#8617;</a></li>
</ol>
</div>|js}
  };
 
  { title = {js|MirageOS Workshop: Working with the Raspberry Pi 4|js}
  ; slug = {js|mirageos-workshop-working-with-the-raspberry-pi-4|js}
  ; description = Some {js|Earlier this week, Romain Calascibetta hosted an in-house MirageOS workshop for employees, both locally and remotely
around the world. This…|js}
  ; url = {js|https://tarides.com/blog/2021-11-11-mirageos-workshop-working-with-the-raspberry-pi-4|js}
  ; date = {js|2021-11-11T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/da5dfbb0de440a1ed000f0e3d74f9f51/2070e/RP4.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Earlier this week, Romain Calascibetta hosted an in-house MirageOS workshop for employees, both locally and remotely
around the world. This interactive workshop taught participants how to build an operating system on a Raspberry
Pi 4 using MirageOS. They got to create their own OS and play with projects, like one they dubbed <em>GuirlandeOS</em> for
which they programmed an LED garland to trim their Christmas tree, creating their own customized light show! There will
be a dedicated blog to <em>GuirlandeOS</em> soon.</p>
<p>That&rsquo;s one fun example of what can be done with MirageOS and Raspberry Pi, but the possibilities are endless.
For example, one could use this dynamic pair to create solar-powered websites (something we&rsquo;ll hear more about next week).</p>
<p>The spirit of <a href="https://mirage.io">MirageOS</a> is that anyone can integrate it, even if they don't work at Tarides. Although the
workshop was only for employees, MirageOS is for everyone! Since it's autonomous from Tarides, we encourage you
to play with MirageOS and see what you can create.</p>
<p>Romain has opened the contents of his informative workshop to the world! Follow along with
<a href="https://drive.google.com/file/d/1NeYA5pjN-4xjFWCpyYxkVSsn4ii9Nktp/view?usp=drivesdk">his slides</a>,
which will walk you through the MirageOS toolchain to create your very own projects. You can read more about the
Raspberry Pi process <a href="https://github.com/mirage/mirage/pull/1253">in this repo</a>.</p>
<p>Early next week, we&rsquo;ll continue with MirageOS month by showcasing a podcast where Anil Madhavapeddy
talks about those solar-powered websites and more!</p>
<p>Happy hacking!</p>|js}
  };
 
  { title = {js|MirageOS 4.0 Preview Live Presentation|js}
  ; slug = {js|mirageos-40-preview-live-presentation|js}
  ; description = Some {js|The official release of MirageOS 4.0 quickly approaches! Learn about some general MirageOS concepts and get a
sneak park at the forthcoming…|js}
  ; url = {js|https://tarides.com/blog/2021-11-09-mirageos-4-0-preview-live-presentation|js}
  ; date = {js|2021-11-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/619c072d0a24bc8e8421e02cdafca46e/0132d/projector.jpg|js}
  ; featured = true
  ; body_html = {js|<p>The official release of MirageOS 4.0 quickly approaches! Learn about some general MirageOS concepts and get a
sneak park at the forthcoming changes in MirageOS 4.0 during a LIVE presentation today at 15h CET.</p>
<p>Lucas Pluvinage will lead you through a live-streaming presentation to acquaint you with MirageOS 4.0. You&rsquo;ll learn
what kinds of problems MirageOS can solve and about Functoria, the compilation model. Then Lucas will also discuss the switch
to the&nbsp;Dune&nbsp;build system and how that enables cross-compilation, not to mention the creation of new compilation targets,
such as the Raspberry Pi!</p>
<p>Watch the live presentation today at 15h CET. Just go to: <a href="https://meet.google.com/iqy-urht-rcn">https://meet.google.com/iqy-urht-rcn</a>, or dial &#8234;(FR) +33 1 87 40 43 45&#8236; with
the PIN: &#8234;288 878 885&#8236;#. You can also find other phone numbers here:&nbsp;<a href="https://tel.meet/iqy-urht-rcn?pin=3736259978366">https://tel.meet/iqy-urht-rcn?pin=3736259978366</a> if you're not in France.</p>
<p>This presentation will be a great introduction to Romain Calascibetta's forthcoming MirageOS workshop tomorrow.
Check back on this blog and <a href="https://twitter.com/tarides_">follow us on Twitter</a> to find out more about how to watch
and participate in this informative workshop tomorrow!</p>
<p>Until then, check out Lucas's presentation today at 15h CET.</p>|js}
  };
 
  { title = {js|Hiring a Developer Educator|js}
  ; slug = {js|hiring-a-developer-educator|js}
  ; description = Some {js|We spend a lot of time on education at Jane Street.  Like, really alot.|js}
  ; url = {js|https://blog.janestreet.com/hiring-a-developer-educator/|js}
  ; date = {js|2021-10-21T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/hiring-a-developer-educator/teaching-blog.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We spend a lot of time on education at Jane Street.  Like, really a
lot.</p>|js}
  };
 
  { title = {js|SCoP Passed Phase 1 of the DAPSI Initiative!|js}
  ; slug = {js|scop-passed-phase-1-of-the-dapsi-initiative|js}
  ; description = Some {js|In April, we announced that the DAPSI initiative accepted
the proposal for our Secure-by-Design Communication Protocols (SCoP) project…|js}
  ; url = {js|https://tarides.com/blog/2021-10-14-scop-selected-for-dapsi-phase2|js}
  ; date = {js|2021-10-14T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/1a54502893f8f38db2c6e37811c75b0c/7d5a2/DAPSI_scop_banner.jpg|js}
  ; featured = false
  ; body_html = {js|<p><strong>In April, <a href="https://tarides.com/blog/2021-04-30-scop-selected-for-dapsi-initiative">we announced</a> that the <a href="https://dapsi.ngi.eu">DAPSI initiative</a> accepted
the proposal for our Secure-by-Design Communication Protocols (SCoP) project. Today, we are thrilled to announce that SCoP has passed the initiative&rsquo;s Phase 1,
and we are now on our way to Phase 2!</strong></p>
<p>SCoP is an open, secure, and resource-efficient infrastructure to engineer a modern basis for open messaging (for existing and emerging protocols)
using type-safe languages and unikernels&mdash;to ensure your private information remains secure. After all, you wouldn&rsquo;t like your postal carrier reading
your snail mail, so why should emails be any different?</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#challenges" aria-label="challenges permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Challenges</h2>
<p>To operate an email service requires many technical skills and reliable infrastructure. As a result, only a few large companies can handle emails with
the proper security levels.  Unfortunately, the core business model of these companies is to mine your personal data.</p>
<p>The number of emails exchanged every day is expected to reach 333 billion in 2022. That&rsquo;s a considerable amount of data, much of it private or sensitive,
sent across Cyberspace through portals with questionable security. The &lsquo;memory unsafe&rsquo; languages used in most communication services leave far too much room
for mistakes that have serious ramifications, like security flaws that turn into security breaches, leaving your personal or business information vulnerable to
malicious hackers.</p>
<p>Due to this global challenge, we set out to build a simple, secure, easily deployable solution to preserve users' privacy, and we&rsquo;re making great strides toward
accomplishing that goal. We base our systems on scientific foundations to last for decades and drive positive change for the world. Our robust understanding of
both theory and practice enables us to solve these security problems, so we explore ideas where research and engineering meet at the intersection of the domains
of operating systems, distributed systems, and programming languages.</p>
<p>Every component of SCoP is carefully designed as independent libraries, using modern development techniques to avoid the common reported threats and flaws.
For instance, the implementation of protocol parsers and serializers are written in a type-safe language and tested using fuzzing. Combining these techniques
will increase users' trust to migrate their personal data to these new, more secure services.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#architecture" aria-label="architecture permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Architecture</h2>
<p>The architecture of the SCoP communication service is composed of an Email Service based on a secure extension of the SMTP protocol, and a decentralised
real-time communication system based on Matrix.</p>
<p>The <a href="https://github.com/dinosaure/ptt">SMTP</a> and <a href="https://github.com/clecat/ocaml-matrix">Matrix</a> protocols implemented in SCoP follow the separation of
concerns design principle, meaning that the SMTP Sender and SMTP Receiver are designed as two distinct units. They&rsquo;re implemented as isolated micro-services
which run as unikernels. The SMTP Sender, Receiver, and Matrix are all configurable, and each configuration comes with a security risk analysis report to
understand possible privacy risks</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#progress" aria-label="progress permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Progress</h2>
<p>Not only are we on our way to Phase 2 in the <a href="https://dapsi.ngi.eu">DAPSI Initiative</a>, but we&rsquo;re also proud to report that we&rsquo;re on track with our
planned milestones!</p>
<p>Our <strong>first milestone</strong> was to generate a corpus of emails to test our parser implementation against existing projects in order to detect differences
between the descriptions specified in the RFCs. We now have 1 million emails that have been parsed/encoded without any issues! Our email corpus keeps
isomorphism between the encoder and decoder, and you can find it in this <a href="https://github.com/mirage/hamlet">GitHub Repo</a>, as we encourage implementors of other languages to use it to improve
their trust in their own implementation.</p>
<p>We set out to implement an SMTP extension mechanism and support for SPF as well as implement DMARC, a security framework, on top of DKIM and SPF for our
<strong>second milestone</strong>, and we are right on target. To date, we&rsquo;ve completed four components:</p>
<ul>
<li><a href="https://github.com/dinosaure/ocaml-spf">SPF</a></li>
<li><a href="https://github.com/dinosaure/ocaml-dkim">DKIM</a></li>
<li><a href="https://github.com/dinosaure/ptt">SMTP</a> can send and verify emails</li>
<li><a href="https://tarides.com/blog/2019-09-25-mr-mime-parse-and-generate-emails">MrMIME</a> can generate the email, then SMTP sends the email (signed by a DKIM private key). We can correctly sign an email, generate a signature, and the DKIM field containing the signature. When the email is received, we check the DKIM signature and the SPF metadata.</li>
</ul>
<p>For our <strong>third milestone</strong>, we set out to implement DNSSEC, a set of security extensions over DNS. This security layer verifies the identity of an email sender
through DKIM/SPF/DMARC, but it also needs security extensions in the DNS protocol. We completed our initial investigation of a DNSSEC implementation prototype,
and we discovered several issues, like some of the elliptic curve cryptography was missing. Those necessary cryptographic primitives are now available, so we
should complete this milestone by the end of the month.</p>
<p>Finally, our <strong>fourth milestone</strong> was to implement the Matrix protocol (client and server). We completed the protocol&rsquo;s client library, which sends a notification
from OCaml CI. Plus, we have a PoC, and Matrix&rsquo;s server-side, which received the notification, is also complete.</p>
<p>Although we still have much work ahead of us, we&rsquo;re quite pleased with the progress thus far, and so is the DAPSI Initiative! Follow our progress by <a href="https://tarides.com/feed.xml">subscribing
to this blog</a> and our <a href="https://twitter.com/tarides_">Twitter feed (@tarides_)</a> for the latest updates.</p>
<br/>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/50ddca27efa367497d954f667fc921f8/a76d6/DAPSI_generic.jpg" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 3.5294117647058822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAABABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHSsFSCf//EABYQAQEBAAAAAAAAAAAAAAAAAAMQM//aAAgBAQABBQIc0n//xAAVEQEBAAAAAAAAAAAAAAAAAAACEP/aAAgBAwEBPwET/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/ATV//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQgf/aAAgBAQAGPwJGz//EABkQAAMAAwAAAAAAAAAAAAAAAAABQXGhsf/aAAgBAQABPyHdfScSI//aAAwDAQACAAMAAAAQCA//xAAWEQEBAQAAAAAAAAAAAAAAAAAAATH/2gAIAQMBAT8Q3Ef/xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAgEBPxCx/8QAGhAAAQUBAAAAAAAAAAAAAAAAAAEhMVHwsf/aAAgBAQABPxDUuQwdDgf/2Q=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/50ddca27efa367497d954f667fc921f8/7bf67/DAPSI_generic.jpg" class="gatsby-resp-image-image" alt="Sequence of entity logos: in association with NGI, EU, Zabala, FGS,
cap-digital, IMT Starter, Fraunhofer IAIS." title="Sequence of entity logos: in association with NGI, EU, Zabala, FGS,
cap-digital, IMT Starter, Fraunhofer IAIS." srcset="/static/50ddca27efa367497d954f667fc921f8/651be/DAPSI_generic.jpg 170w,
/static/50ddca27efa367497d954f667fc921f8/d30a3/DAPSI_generic.jpg 340w,
/static/50ddca27efa367497d954f667fc921f8/7bf67/DAPSI_generic.jpg 680w,
/static/50ddca27efa367497d954f667fc921f8/990cb/DAPSI_generic.jpg 1020w,
/static/50ddca27efa367497d954f667fc921f8/a76d6/DAPSI_generic.jpg 1139w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>|js}
  };
 
  { title = {js|The New Replaying Benchmark in Irmin|js}
  ; slug = {js|the-new-replaying-benchmark-in-irmin|js}
  ; description = Some {js|As mentioned in our Tezos Storage / Irmin Summer 2021 Update on the Tezos Agora forum, the Irmin team's goal has been to improve Irmin's…|js}
  ; url = {js|https://tarides.com/blog/2021-10-04-the-new-replaying-benchmark-in-irmin|js}
  ; date = {js|2021-10-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/37ab792f992f4bdb89846ecd0bda664c/2ae3d/footprints.jpg|js}
  ; featured = false
  ; body_html = {js|<p>As mentioned in our <a href="https://forum.tezosagora.org/t/tezos-storage-irmin-summer-2021-update/3744">Tezos Storage / Irmin Summer 2021 Update</a> on the Tezos Agora forum, the Irmin team's goal has been to improve Irmin's performance in order to speed up the <em>Baking Account</em> migration process in Octez, and we managed to make it 10x faster in the first quarter of 2021. Since then, we've been working on a new benchmark program for Irmin that's based on the interactions between Irmin and Octez. This won't just help make Irmin even faster, it will also help speed up the Tezos blockchain process and enable us to monitor Irmin's behavior in Octez.</p>
<p>Octez is the <a href="https://gitlab.com/tezos/tezos">Tezos node implementation</a> that uses Irmin to store the blockchain state, so Irmin is a core component of Octez that's responsible for virtually all the filesystem operations. Whether a node is launched to produce new blocks (aka &ldquo;bake&rdquo;) or just to participate in peer-to-peer sharing of existing blocks, it must first update itself by rebuilding blocks individually until it reaches the head of the blockchain. This first phase is called <em>bootstrapping</em>, and once it reaches the blockchain head, we say it has been <em>bootstrapped</em>. Currently, the <em>bootstrapped</em> phase processes 2 block per minute, which is the rate at which the Tezos blockchain progresses. The next goal is to increase that rate to 12 blocks per minute.</p>
<p>Irmin stores the content of the Tezos blockchain on a disk using the <code>irmin-pack</code> library. There is one-to-one correspondence between the Tezos block and the Irmin commits. Each time Tezos produces a block, Irmin produces a commit, and then the Tezos block hash is computed using the Irmin commit hash. The Irmin developers are working on improving the <code>irmin-pack</code> performance which in turn will improve the performance of Octez.</p>
<p>A benchmark program is considered &ldquo;fair&rdquo; when it's representative of how the benchmarked code is used in the real world&mdash;for example, the access-patterns to Irmin. A standard database benchmark would first insert random data and then remove it. Such a synthetic benchmark would fail to reproduce the bottlenecks that occur when the insertions and removal are interleaved. Our solution to &ldquo;fairness&rdquo; is radical: <em>replaying</em>. Within a sandboxed environment, we <em>replay</em> a real world situation.</p>
<p>Basically, our new benchmark program makes use of a benchmarked code and records statistics for later analysis. The program is stored in the <code>irmin-bench</code> library and makes use of operation traces (called <em>action traces</em>) when Octez runs with Irmin. Later, the program replays the recorded operations one at a time while simultaneously recording tonnes of statistics (called stat traces). Data analysis of the stat traces may reveal many interesting facts about the behaviour of Irmin, especially if we tweak:</p>
<ul>
<li>the configuration of Irmin (e.g., what&rsquo;s the impact of doubling the size of a certain cache?)</li>
<li>the replay parameters (e.g., does Irmin's performance decay over time? Does <code>irmin-pack</code> perform as well after 24 hours of replay as after 1 minute of replay?)</li>
<li>the hardware (e.g., does <code>irmin-pack</code> perform well on a Raspberry Pi?)</li>
<li>the code of Irmin (e.g., does this PR have an impact on performance?)</li>
</ul>
<p>This benchmarking process is similar to the record-replay feature available with <a href="https://docs.tezedge.com/tezedge/record-replay">TezEdge</a>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#recording-the-action-trace" aria-label="recording the action trace permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Recording the Action Trace</h3>
<p>By adding logs to Tezos, we can record the Tezos-Irmin interactions and thus capture the Irmin &ldquo;view&rdquo; of Tezos. We&rsquo;ve recorded <em>action traces</em> during the <em>bootstrapping</em> phase of Tezos nodes, which started from <em>Genesis</em>&mdash;the name of the very first Tezos block inserted into an empty Irmin store.</p>
<p>The interaction surface between Irmin and Octez is quite simple, so we were able to reduce it to eight (8) elementary operations:</p>
<ul>
<li><code>checkout</code>, to pull an Irmin tree from disk;</li>
<li><code>find</code>, <code>mem</code> and <code>mem_tree</code>, read only operations on an Irmin tree;</li>
<li><code>add</code>, <code>remove</code> and <code>copy</code>, write only operations on an Irmin tree;</li>
<li><code>commit</code>, to push an Irmin tree to disk.</li>
</ul>
<p>It&rsquo;s important to remember that Irmin behaves much like Git. It has built-in snapshotting and is compatible with Git itself when using the <code>irmin-git</code> library. In fact, these operations are very similar to Git, too.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#sequence-of-operations" aria-label="sequence of operations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sequence of Operations</h3>
<p>To illustrate further, here's a concrete example of an operation sequence inside an action trace:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/d133a7455102c1b17e30fae407e04c78/7131f/ygWh3cg.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVQoz51S246DIBT0/3+xT2qr3ARRuQk6m0Njs910H3ZPMpkDhmHmYMOkAYFLg/sgYIyB1hopJVx1nucbrr1P1ajJ4AkNJiSmSVdRM8+QUlYopbDv+0fxn5c0o9AYmKouuzuvhy8wxqp4zrk6Jv7N2bXfdP0dbdfj8Rgqd12HxS5o2xbjOKLve9xuN3DOq3iMsR4+jgOllMpvDoWcoLSFnCjmAqkkpOZgfIScRJ2ntRbrulbQ2jn36rdtq85fggOTGEYBoTS4UNBOQQcBn1fEEl6RLie/Aue3GfIJXBk8mILSGuUo+G81zgf4EEEcYoL3oc7J+Wcs732NRUyguPRA9I36uAeEvKGcufYNuaMXJlZmgVIaWswwykLLGd55hBjqb0MXkSjNjMRCCEg5IZWAcmTsOaGZ7YJl3WDMDOc8ZmsRfUJyO3IqKPvxp8hfHYUHR2MmLUsAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/d133a7455102c1b17e30fae407e04c78/c5bb3/ygWh3cg.png" class="gatsby-resp-image-image" alt="ygWh3cg" title="ygWh3cg" srcset="/static/d133a7455102c1b17e30fae407e04c78/04472/ygWh3cg.png 170w,
/static/d133a7455102c1b17e30fae407e04c78/9f933/ygWh3cg.png 340w,
/static/d133a7455102c1b17e30fae407e04c78/c5bb3/ygWh3cg.png 680w,
/static/d133a7455102c1b17e30fae407e04c78/7131f/ygWh3cg.png 710w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>This shows Octez&rsquo;s first interaction with Irmin at the very beginning of the blockchain! The first block, <em>Genesis</em>, is quite small (it ends at operation #5), but the second one is massive (it ends at operation #309273). It contains no transactions because it only sets up the entire structure of the tree. It precedes the beginning of Tezos's initial protocol called &ldquo;Alpha I&rdquo;.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#benchmark-benefits" aria-label="benchmark benefits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Benchmark Benefits</h3>
<p>Our benchmark results convey the sheer magnitude of the Tezos blockchain and the role that Irmin plays within it. We&rsquo;ve recorded a trace that covers the blocks from the beginning the blockchain in June 2018 all the way up to May 2021. It weighs <strong>96GB</strong>.</p>
<p>Although it took <strong>34 months</strong> for Tezos to reach that state, bootstrapping so far takes only <strong>170 hours</strong>, and replaying it takes a mere <strong>37 hours</strong> on a section of the blockchain that contains <strong>1,343,486 blocks</strong>. On average, this corresponds to <strong>1 per minute</strong> when the blocks were created, <strong>132 per minute</strong> when bootstrapping, and <strong>611 per minute</strong> during replay.</p>
<p>On this particular section of the blockchain, Octez had <strong>1,089,853,521 interactions</strong> with Irmin. On average, this corresponds to <strong>12 per second</strong> when the blocks were created, <strong>1782 per second</strong> during bootstrapping, and <strong>8258 per second</strong> during replay.</p>
<p>The chart below demonstrates how many of each Irmin operation occur per block (on average):</p>
<center>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; ">
      <a href="https://tarides.com/static/c87031f583955f306e8c64611c474c01/0b533/4yKd8iQ.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACWUlEQVQ4y5VUS2/TQBBeceBQ8Xe49cAJiT+BxAX+AhK9VDRwIQqoEqoQFUJIKL2gCorIAURBokCEmkoQpXmR2A22U+dh1/Emfux+yI6d2ImTwkizXu/ufDPf7MwSzAjn3BvAg3moiPwvE5K0yHk4TIVxDidQtsQBWRShJ3JPR61ahSQrc06joDHAWTpRyopmQNM0f18dOVivdJCqdaHZbgx0LkIPxGFj5QEYwGPRrB6IIDtHINkCruVbiynPLkYjDSMQLQayV8bF7fe4sP0BK7kqTqidSH2SwzclFW+P1djFWIxBVVWcqiouf6qD7BRAsoe4+k2cgLFIAJ76gKmPdZCbL0FuZfHgc8M/7DKOpmmh/LuB4ZmOP9TG7WMVa+UOOpYTuk3O4erWd5DrWyA3nuLKk7y/4TA2oeK47pxx3+H4olkQTztoyzJkWQaldAz46qeMlTvvcGkth71S2zewA0BjYOJXsYgBpfBWbNeFNRyiqRnYbZuoSAqk1glMSuE4zrRsFGMExbBiCWYcoLYDbo8vYMSBmqKiXq1AkiRYlpVMOVpP4fxQH+J5S8ezlo79HvVLyhNzZIG5bmJVTC4lLBE3MCroI9yrd5EWNGQEHRu1DnLqYAriOWYssdfJrCdPXrR0pAUd9wt13M2X8EjUsdns48xhsZQs7eXoIY9qutlH6kcF61+LyDR62BT6k5Zb9uKQpIY/6FNs1LrINDU8FDS/f3cV45+esETK3ne/S7Elangs9PG6bcB02bnRLaQcysBl0IO8LTqzlHLUgCU8GP9FOQk0qSzOk7/gvPf7dblftQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/c87031f583955f306e8c64611c474c01/0b533/4yKd8iQ.png" class="gatsby-resp-image-image" alt="4yKd8iQ" title="4yKd8iQ" srcset="/static/c87031f583955f306e8c64611c474c01/04472/4yKd8iQ.png 170w,
/static/c87031f583955f306e8c64611c474c01/9f933/4yKd8iQ.png 340w,
/static/c87031f583955f306e8c64611c474c01/0b533/4yKd8iQ.png 500w" sizes="(max-width: 500px) 100vw, 500px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
</center>
<p>This next chart displays where the time is spent during replay:</p>
<center>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/85cffd35d784692988f8aa1f04e9180a/78797/u5Fv2Zb.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAUlEQVQoz2WSy0uUURjGzzSLFhFUtPJPEKlFRGQYROC2XbZpE+EqahGtpAaCtCjDLmJqGhXhLqU2NcWMM43DVKAT5KWRwlAMZ0ad5vZdzvnOL77PGeeT3s15zznP+7y3R2itcc09lQbbtpFSobTG/+f3bamoVCrYUqK3Hrcxog6iFmCZBijp+Y6PyLs7DT+Xy6JtC22ZFEul7WSiEaDp+7bKyYlZ2t/OM/4zv4PUqeGqpk3XcJzWzpdcep0mvVEA7XiVeoSqlvXG1xXEvTjiQQLRG0f0pRhfLnt//vY7Qm8QzdcRx7ppGU1wKJohspIHZXukwjIMltdyHOyPIh5+IjiQ4vDYNGeehbn2aISF2e/Ue5j+scquth4CrT3sOztIc2yJ4ESarpklr0pLSneGmmzZYO+TJOLxFIGBFBfCc4QjEe7fvkV0MoZtuzN1+JhaIHDiJuJ4N03nR2l/t0jTYJRQco5iPsdmoYCoz+bch0XE3RiiP4nom2L/8xkmf2cxin+pj8U9jlx8gWgJsft0L1cj8xwdjvM0sYBV3MSwrAbhhinpeJ9hz9BnDox84XL8FxXpUCmXWMtmMQzTw2WW1zl1ZYxg2x06X6WYNwyUaSHlljJEfZPbcqjaFEyJ37wtO84O3J/1MlVToSwTpdT/snF80vBv1q/Duhb9b9qX1K3wH6T+vJF1g8x/AAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/85cffd35d784692988f8aa1f04e9180a/c5bb3/u5Fv2Zb.png" class="gatsby-resp-image-image" alt="u5Fv2Zb" title="u5Fv2Zb" srcset="/static/85cffd35d784692988f8aa1f04e9180a/04472/u5Fv2Zb.png 170w,
/static/85cffd35d784692988f8aa1f04e9180a/9f933/u5Fv2Zb.png 340w,
/static/85cffd35d784692988f8aa1f04e9180a/c5bb3/u5Fv2Zb.png 680w,
/static/85cffd35d784692988f8aa1f04e9180a/b12f7/u5Fv2Zb.png 1020w,
/static/85cffd35d784692988f8aa1f04e9180a/78797/u5Fv2Zb.png 1125w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
</center>
<p>With <code>irmin-pack</code>, an OCaml thread managed by the <a href="https://github.com/mirage/index/"><code>index</code> library</a> is running concurrently to the main thread (i.e., the <em>merge</em> thread), a fraction of the durations (shown above) are actually spent in that thread. Refer to this <a href="https://tarides.com/blog/2020-09-01-introducing-irmin-pack">blog post</a> for more details on <code>index</code>'s <em>merges</em>.</p>
<p>The following chart illustrates how memory usage evolves during replay:</p>
<center>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/fda8364be92a0ed94a1228298ea88b68/20c85/F0bORTg.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVQozz1Si46jMAzk/79x91SqUrUJCeT9cGBWdrkijcY448E2mQAgpgwdIkwq0CHBpAwT8xVfuZixXiznKUOFBMXvzmO+3bDvOybvPZTWoDEwjgOtd2Ea/+NTmM9bp69OtESC2hpCCIKp9w7nHI4xgPMEEeE8TxxsSiS5ceXGGML44hCczABKKZjYTHOHRJdJFzGL2Aj4fITN+tUpx6yNqWLzGT4maKWksYldt81KEdGACxkuFrhQsLkEnyrMHqFsxNt46C0KlA2CPbBhhjHmY5hSgl4N1JawhYqQGnIlpNIRc0NphFz7dw38dBqwPmNZHvj3+4N5vmGeZ/D/mFiglIZzAbUWeO/QW0UpGTEEtFoQgkfOWQq4AZ4q5oLH44FlWYTf77doJh6Tk9YaWGvlsLUme30+n3IV7ve7MOter9dn32NgXVcZlet4vzzBH7XCagqdGWelAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/fda8364be92a0ed94a1228298ea88b68/c5bb3/F0bORTg.png" class="gatsby-resp-image-image" alt="F0bORTg" title="F0bORTg" srcset="/static/fda8364be92a0ed94a1228298ea88b68/04472/F0bORTg.png 170w,
/static/fda8364be92a0ed94a1228298ea88b68/9f933/F0bORTg.png 340w,
/static/fda8364be92a0ed94a1228298ea88b68/c5bb3/F0bORTg.png 680w,
/static/fda8364be92a0ed94a1228298ea88b68/20c85/F0bORTg.png 999w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
</center>
<p>On a logarithmic scale, this last chart shows the evolution of the <em>write amplification</em>, which indicates the amount of rewriting (e.g., at the end of the replay, 20TB of data have been written to disk in order to create a store that weighs 73GB).</p>
<center>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/865f6695d4f8132e84cadef0cd099f38/20c85/PhNqloN.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABm0lEQVQozz1Sia7jMAjM//9it+rqtc2maRLn8IEN9jxB07WECNcAQ7rWGmKMmN2Kxa0YhgHjOMI5hxAC4imUoukUI7bDY9kOuN1jnGbc73fLLaWgI8p4DQPee8C87fhzueDn5wdcCvTVBsTMiNwwh4w1MY5csROb6CB9/8SyLPDeo9MJ1QjeGwAzQ0SQimDyCS5muECIRVAKQ2r9NBIGpWRTKVA9/Z0CGGAI5sisQISNGFQYaA04k5vqVg0kEVljDautNB3HgW7fd7xeL8QYoGXjnsAi5xSC2hqIBaU1+ETwKSGxIEpFkorNe6Mo5wzdttMPRVdA5ScVRqmf5MACqhWB6COJUGpD02a12oSqicgOq7at7JbZDuJIQCLIUm2yTGTJKt+JbUddv7X/vOnK0zQZbZ063+ML43pgY01uEGY7Tjkv/X3tFK3RzVS0mXInJ03d92J/+wH/pgXzNMGtq11u2zZLXk9btfr0iNfr1eRyueB2u5nfOPyO/Hg8MM8zns/efmot7vveDqax9/tt5GuhPo1rTHO/2yjgL5L0Bvxu8SjCAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/865f6695d4f8132e84cadef0cd099f38/c5bb3/PhNqloN.png" class="gatsby-resp-image-image" alt="PhNqloN" title="PhNqloN" srcset="/static/865f6695d4f8132e84cadef0cd099f38/04472/PhNqloN.png 170w,
/static/865f6695d4f8132e84cadef0cd099f38/9f933/PhNqloN.png 340w,
/static/865f6695d4f8132e84cadef0cd099f38/c5bb3/PhNqloN.png 680w,
/static/865f6695d4f8132e84cadef0cd099f38/20c85/PhNqloN.png 999w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
</center>
<p>The <em>merge</em> operations of the <code>index</code> library are the source of this poor <em>write amplification</em>. The Irmin team is working hard on improving this metric:</p>
<ul>
<li>on the one hand, the new <em>structured keys</em> feature of the upcoming Irmin 3.0 release will help to reduce the pressure on the <code>index</code> library,</li>
<li>on the other hand, we are working on algorithmic improvements of <code>index</code> itself.</li>
</ul>
<p>Another nice way to use the trace is for testing. When replaying a trace, we can recompute the commit hashes and check that they correspond to the trace hashes, so the benchmark acts as additional tests to ensure we don't compromise the hashes computed in Tezos.</p>
<p>Complex changes to Tezos can be simulated first in Irmin. For example, the <a href="https://gitlab.com/tezos/tezos/-/merge_requests/2771">path flattening in Tezos</a> feature (merged in August 2021) can now be tested earlier in the process with our benchmark. Prior to the trace benchmarks, we first had to make the changes in Tezos to understand their repercussions on Irmin directly from the Tezos benchmarks.</p>
<p>Lastly, we continue to test alternative libraries and compare them with the ones integrated in Tezos; however, using these alternative libraries to build Tezos nodes has proven to be more complicated than merely adding them in Irmin and running our benchmarks. While testing continues on most new libraries, we can definitely use replays to compare our <a href="https://github.com/mirage/cactus/">new <code>cactus</code> library</a> as a replacement for our <a href="https://github.com/mirage/index/"><code>index</code> library</a>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#future-directions" aria-label="future directions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Future Directions</h3>
<p>While the <em>action trace</em> recording was only made possible on a development branch of Octez, we would next like to upstream the feature to the main branch of Octez, which would give all users the option to record Tezos-Irmin interactions. This would simplify bug reporting overall.</p>
<p>Although the first version only deals with the <em>bootstapping</em> phase of Tezos, an upcoming goal is to make it possible to benchmark the <em>boostrapped</em> phase of Tezos as well. Additionally, we plan to replay the multiprocess aspects of a Tezos node in the near future.</p>
<p>The first stable version of this benchmark has existed in Irmin&rsquo;s development branch since Q2 2021, and we will release it as part of <code>irmin-bench</code> for Irmin 3.0 in Q4 2021. This release will allow integration into the <a href="https://github.com/ocaml-bench/sandmark">Sandmark OCaml</a> benchmarking suite.</p>
<p>Follow the Tarides blog for future Irmin updates.</p>|js}
  };
 
  { title = {js|Announcing Tezos’ 8th protocol upgrade proposal: Hangzhou|js}
  ; slug = {js|announcing-tezos-8th-protocol-upgrade-proposal-hangzhou|js}
  ; description = Some {js|The last upgrade of the Tezos protocol, Granada, activated on August 6th, 2021.|js}
  ; url = {js|https://marigold.dev/blog/announcing-hangzhou/|js}
  ; date = {js|2021-09-21T00:00:00-00:00|js}
  ; preview_image = Some {js|https://uploads-ssl.webflow.com/616ab4741d375d9bfbc19060/618160ee59e0d37af7286bb7_blog7.png|js}
  ; featured = false
  ; body_html = {js|<p>The last upgrade of the Tezos protocol, Granada, activated on August 6th, 2021.
We are now glad to announce a new protocol proposal, Hangzhou, the result of a
collaborative work from various teams.</p>
<p><em>This is a joint post with <a href="https://www.nomadic-labs.com/">Nomadic Labs</a>,
<a href="https://marigold.dev/">Marigold</a>, <a href="https://www.oxheadalpha.com/">Oxhead Alpha</a>
and <a href="https://www.dailambda.jp/">DaiLambda</a>.</em></p>|js}
  };
 
  { title = {js|Tarides Returns to FIC 2021|js}
  ; slug = {js|tarides-returns-to-fic-2021|js}
  ; description = Some {js|Last year, Tarides had the honour of winning the “Coup de Coeur” Startup Award
at the International Cybersecurity Forum (FIC). It’s the…|js}
  ; url = {js|https://tarides.com/blog/2021-09-06-tarides-returns-to-fic-2021|js}
  ; date = {js|2021-09-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/b65b5b10c49eebfc82b9e474d0d5ffe8/0132d/cyber_lock.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Last year, Tarides had the honour of winning the &ldquo;Coup de Coeur&rdquo; Startup Award
at the International Cybersecurity Forum (FIC). It&rsquo;s the leading cybersecurity
event in the EU. It&rsquo;s both a forum, to present and discuss innovations and
reflect on the state of the European cybersecurity ecosystem, and a trade fair,
where cybersecurity and other tech professionals can meet and network.</p>
<p>This year, Tarides returns to FIC with their own booth! Our representatives,
including founder and CEO of Tarides, Thomas Gazagnaire, look forward to making
new connections, looking for collaborators, and catching up with colleagues.</p>
<p>The FIC theme for 2021 centres on encouraging &ldquo;a collective and collaborative
cybersecurity.&rdquo; From the <a href="https://www.forum-fic.com/en/home/discover/what-is-the-fic.htm">FIC
Website</a>:</p>
<blockquote>
<p>&rdquo;Collective, because each stakeholder is responsible not only for its own
security but also for the security of every other stakeholder, and therefore of
the whole. Collaborative, because cooperation and information sharing are
essential to compensate the asymmetry between the &laquo;attacker&raquo; and the
&laquo;defender&raquo;&hellip;FIC 2021 will focus on the major operational, industrial,
technological, and strategic challenges of cooperation&rdquo;</p>
</blockquote>
<p>Solutions for most cybersecurity issues already exist, and we at Tarides are
happy to consult on our many solutions that can make your systems more secure.
From secure emails to runtime protection to secure IoT protocols, our
representatives can help!</p>
<p>So stop by the Tarides booth at FIC to chat about your options. We&rsquo;ll have
snacks and other goodies, too!</p>|js}
  };
 
  { title = {js|Tarides Engineers to Present at ICFP 2021|js}
  ; slug = {js|tarides-engineers-to-present-at-icfp-2021|js}
  ; description = Some {js|This year marks the 25th anniversary of the OCaml Language! It's an exciting
time for OCaml programmers and enthusiasts. A fun and…|js}
  ; url = {js|https://tarides.com/blog/2021-08-26-tarides-engineers-to-present-at-icfp-2021|js}
  ; date = {js|2021-08-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/3ffd2661c6cd98ccc55ced480bc5e65a/eee8e/camel_party.jpg|js}
  ; featured = false
  ; body_html = {js|<p>This year marks the 25th anniversary of the OCaml Language! It's an exciting
time for OCaml programmers and enthusiasts. A fun and informative way to
celebrate OCaml's birthday is to attend the <a href="https://icfp21.sigplan.org/home/ocaml-2021">26th Annual International
Conference on Functional
Programming</a> (ICFP), held online
this year due to ongoing Covid restrictions. While this is disappointing news
for so many, it's beneficial to those of you outside France because now you
can hear professionals talk about cutting edge technology from the comfort of
your own home.</p>
<p>Tarides engineers, as well as our colleagues at <a href="https://tarides.com/ocamllabs.io">OCaml Labs
Consultancy</a> and <a href="https://segfault.systems/">Segfault Systems</a>,
have some exciting presentations at this year's ICFP! Listen to talks on running
OCaml on multiple cores, generating fuzzing suites, benchmarking, and the
experimental OCaml effects.</p>
<p>You can search the [complete ICFP
Timetable](<a href="https://icfp21.sigplan.org/program/program-icfp-2021/?past=Show">https://icfp21.sigplan.org/program/program-icfp-2021/?past=Show</a>
upcoming events only&amp;date=Fri 27 Aug 2021) for other topics of interest and read
below about our engineers' projects and presentations. Times are listed both in
London (GMT +1) and Paris (GMT +2) for ease of planning. The following talks are
scheduled for Friday, 27 August 2021.</p>
<p>Grab a cup of coffee for our first morning talk at <strong>9am London / 10am Paris</strong>
and learn about <strong>Adapting the OCaml Ecosystem for Multicore OCaml.</strong> With the
soon-to-be released OCaml 5.0, there will be support for Shared-Memory
Parallelism. There&rsquo;s increasing interest in the community to port existing
libraries to Multicore, so this talk will cover the arrival of Multicore and
what that means to the OCaml ecosystem. Our engineers will highlight existing
tools and provide methods for a smooth transition, so viewers can benefit from
Multicore parallelism. They'll also share some insights from their experience
porting existing libraries to Multicore OCaml.</p>
<p>Read more about this topic on todays' post at <a href="https://segfault.systems/blog/2021/adapting-to-multicore/">Segfault
Systems</a>, written by
one of tomorrow's presenters, <a href="https://icfp21.sigplan.org/profile/sudhaparimala">Sudha
Parimala</a> of Segfault Systems.
Joining Sudha for the presentation are <a href="https://icfp21.sigplan.org/profile/enguerranddecorne1">Enguerrand
Decorne</a> (Tarides),
<a href="https://icfp21.sigplan.org/profile/sadiqjaffer">Sadiq Jaffer</a> (Opsian and OCaml
Labs Consultancy), <a href="https://icfp21.sigplan.org/profile/tomkelly">Tom Kelly</a>
(OCaml Labs Consultancy), and <a href="https://icfp21.sigplan.org/profile/kcsivaramakrishnan">KC
Sivaramakrishnan</a> of IIT
Madras.</p>
<p>Next up is <strong>Leveraging Formal Specifications to Generate Fuzzing Suites</strong> at
<strong>11:10 London / 12:10 Paris,</strong> presented by Tarides's own <a href="https://icfp21.sigplan.org/profile/nicolasosborne">Nicolas
Osborne</a> and <a href="https://icfp21.sigplan.org/profile/clementpascutto">Cl&eacute;ment
Pascutto</a>. They'll discuss
how developers typically first have to capture the semantics they want when
checking a library and then write the code implementing these tests and find
relevant test cases that expose possible misbehaviours. Through their work,
they'll present a tool that automatically takes care of those last two steps by
automatically generating fuzz testing suites from OCaml interfaces annotated
with formal behavioural specifications. They'll also show some ongoing
experiments on fuzzing capabilities and limitations applied to real-world
libraries.</p>
<p>Next up is our talk on <strong>Continuous Benchmarking for
OCaml Projects</strong> at <strong>12:30 London / 13:30 Paris</strong>. Regular CI systems are
optimised for workloads that do not require stable performance over time, which
makes them unsuitable for running performance benchmarks. Tarides engineers
<a href="https://icfp21.sigplan.org/profile/gargisharma">Gargi Sharma</a>, <a href="https://icfp21.sigplan.org/profile/rizoisrof">Rizo
Isrof</a>, and <a href="https://icfp21.sigplan.org/profile/magnusskjegstad">Magnus
Skjegstad</a> will discuss how
<code>current-bench</code> provides a predictable environment for performance benchmarks
and a UI for analysing results over time. Similar to a CI system it runs on pull
requests and branches allowing performance to be analysed and compared, and it
can currently be enabled on as an app on GitHub repositories with zero
configuration. Several public repositories already run <code>current-bench</code>,
including <a href="https://github.com/mirage/irmin">Irmin</a> and
<a href="https://github.com/ocaml/dune">Dune</a>, and they plan to enable it on more
projects in the future. <a href="https://tarides.com/blog/2021-08-26-benchmarking-ocaml-projects-with-current-bench">Read Gargi's recent blog post for more information on
benchmarking</a>.</p>
<p>In this presentation, they will give a technical overview of <code>current-bench</code>, showing how results are collected and analysed, requirements for using it, and how they built the infrastructure for stable benchmarks. They'll also cover some future work that will allow more OCaml projects to run <code>current-bench</code>.</p>
<p>Immediately after the Benchmarking talk, catch <strong>A Multiverse of Glorious Documentation</strong>
scheduled at <strong>12:50 London / 13:50 Paris.</strong> <a href="https://icfp21.sigplan.org/profile/lucaspluvinage1">Lucas
Pluvinage</a> of Tarides and
<a href="https://icfp21.sigplan.org/profile/jonathanludlam">Jonathan Ludlam</a> of OCaml
Labs Consultancy will discuss the process of generating documentation for every
version of every package that can be built from the Opam repository and present
it as a single coherent website that's continuously updated as new packages are
released and old packages are updated. They will address the challenges of
caching, handling different compiler versions, and incompatible libraries. The
process has been implemented as an OCurrent pipeline named <code>ocaml-docs-ci</code> and
is already available on Github. It has been used to produce the documentation of
more than 10,000 package versions, generating 2.5M HTML pages. That's 38GB of
artifacts!</p>
<p>After a relaxing lunch, come back for <strong>Experiences with Effects</strong> at <strong>15:30
London / 16:30 Paris</strong>. Join OCaml Labs and Tarides engineers <a href="https://icfp21.sigplan.org/profile/thomasleonard">Thomas
Leonard</a>, <a href="https://icfp21.sigplan.org/profile/craigferguson">Craig
Ferguson</a>, <a href="https://icfp21.sigplan.org/profile/patrickferris">Patrick
Ferris</a>, <a href="https://icfp21.sigplan.org/profile/sadiqjaffer">Sadiq
Jaffer</a>, <a href="https://icfp21.sigplan.org/profile/tomkelly">Tom
Kelly</a>, <a href="https://icfp21.sigplan.org/profile/kcsivaramakrishnan">KC
Sivaramakrishnan</a>, and
<a href="https://icfp21.sigplan.org/profile/anilmadhavapeddy">Anil Madhavapeddy</a> as they
talk about an exciting, experimental branch of Multicore OCaml that adds support
for effect handlers. In this presentation, they'll discuss their experiences
with effects, both from converting existing code and from writing new code. They
discovered that converting the Angstrom parser from a callback style to effects
greatly simplified the code while also improving performance and reducing
allocations. Their <a href="https://github.com/ocaml-multicore/eio">experimental Eio
library</a> uses effects that allows
writing concurrent code in direct style, without the need for monads (as found
in Lwt or Async).</p>
<p>Enjoy a full day of OCaml innovation and get to know some of our talented
engineers better by joining Tarides, OCaml Labs, and Segfault Systems at ICFP on
Friday, 27 August 2021. See you there!</p>|js}
  };
 
  { title = {js|Benchmarking OCaml projects with current-bench|js}
  ; slug = {js|benchmarking-ocaml-projects-with-current-bench|js}
  ; description = Some {js|Regular CI systems are optimised for workloads that do not require stable performance over time. This makes them unsuitable for running…|js}
  ; url = {js|https://tarides.com/blog/2021-08-26-benchmarking-ocaml-projects-with-current-bench|js}
  ; date = {js|2021-08-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/2bd2e5940bdb329b93e236f44dd37e01/dfe86/current-bench-camel.jpg|js}
  ; featured = true
  ; body_html = {js|<p>Regular CI systems are optimised for workloads that do not require stable performance over time. This makes them unsuitable for running performance benchmarks.</p>
<p><a href="https://github.com/ocurrent/current-bench"><code>current-bench</code></a> provides a predictable environment for performance benchmarks and a UI for analysing results over time. Similar to a CI system, it runs on pull requests and branches which allows performance to be analysed and compared.  It can currently be enabled as an app on GitHub repositories with zero configuration. Several public repositories are running<code>current-bench</code>, including <a href="https://github.com/mirage/irmin">Irmin</a> and <a href="https://github.com/ocaml/dune">Dune</a>. We plan to enable it on more projects in the future.</p>
<p>In this article, we give a technical overview of <code>current-bench</code>, showing how results are collected and analysed, requirements for using it and how we built the infrastructure for stable benchmarks. We also describe future work that would allow more OCaml projects to run <code>current-bench</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#introduction" aria-label="introduction permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>For performance critical software, we must run benchmarks to ensure that there's no regression. Running benchmarks before the user submits their pull request is tedious, and since every user might have a different machine, you can't be sure if the benchmarks performed actually improved or regressed performance.</p>
<p>Our <code>current-bench</code> aims to solve this problem by providing a stable benchmarking platform that runs every time the user submits a pull request and compares the result to the benchmarks on the main branch. As <code>current-bench</code> is zero-configuration, users can enroll their repository to run benchmarks with ease. This <code>current-bench</code> has helped projects ensure that regression doesn't happen, so you can merge code with more confidence.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#architecture" aria-label="architecture permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Architecture</h2>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/37523/current-bench-arch.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 75.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACXUlEQVQ4y51T205TURBd57Sn9BQL3lLQmEjilfLgpYlVIWhoT6GFFltKS7EUe8OQ0BSvGIO3GNP4glQDRaAUUIPxiSBq4iXBBx+Q+AV+g36ByTYbp5UHtY2TTPacfWZW1qzZg6AyDrf5IZymBwjZpgBALQoqDQAR/2PdlkeN7hOjSvuxESVozdRrJPkAgOMChO0cHIAEQENxcYs759n12BK72b/M+t0LzLTXvw9AmV5n0ALgoEYAu/gdAKEoYMQx8ynhW1hLdj3/EmubW9mx1WgCcFAlSlUAKngMoIpYFgdkjIESxVjXXR5vA8Db1lEKZ2YoCYybobIWEhoAHMGh6v4/pfC260rWMKiMIdT8eP0c8CxCFAt1POA6bgGgp+Fwl+lbRzm8g3K6l3B0vxsBaxoByyhc9bdQV2MD+84gqWUVgJ0AzACqCaCc2jeTNJvoPEwyyehpniiwTXpfC0PBD+L7MSYYa5QyrUZfSQAVxFZLTDYTM5ncQMBl6LFlCsNJeF7idnQVqcQahkOrSHqX/6XWxiH9XgTv6fsY6v4oXOh8i96WqWjcOf/0/JknExFHbjZgTZuHQ59hNgZUVMAZ5mNhwzZpC7G/aQSpvq/CVd8qwi25lYTvBbsWWWR9rmcsYEkPTl7+gdrdTTIVce1M1G5+gzT07xdjT+M9DHa+QaJjieuphO3ZK2FHduCcffpijy2zp73hDtg3lm9NRf536ziVwiX/OyS9r9afT8SRQ7Qth7A9i97mSThP3hDo8ZdmBcCOdUAx2jqrjrtm1WHHjPqsMiYEbeOIts6VDPgTWbaWqtMw1t4AAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/c5bb3/current-bench-arch.png" class="gatsby-resp-image-image" alt="Figure 1: Current bench architecture" title="Figure 1: Current bench architecture" srcset="/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/04472/current-bench-arch.png 170w,
/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/9f933/current-bench-arch.png 340w,
/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/c5bb3/current-bench-arch.png 680w,
/static/2924487e1eab06d8ffdb4bc2e3cdbbd1/37523/current-bench-arch.png 720w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#benchmarking-pipeline" aria-label="benchmarking pipeline permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Benchmarking Pipeline</h3>
<p>As shown in Figure 1 (above), the benchmarking infrastructure uses <code>ocurrent</code><sup><a href="https://icfp20.sigplan.org/details/ocaml-2020-papers/6/OCaml-CI-A-Zero-Configuration-CI">1</a></sup>, an embedded Domain Specific Language to write a pipeline. The <code>ocurrent</code> command computes the build incrementally and helps with static analysis. Whenever a pull request is opened on a repository monitored by <code>current-bench</code>, a <code>POST</code> request is sent to the server running the pipeline. The pipeline fetches the head commit on the pull request and uses Docker to compile the code, and then it runs the <code>make bench</code> command inside the generated Docker image.</p>
<p>The pipeline runs on a single node, and the process is pinned to a single core to ensure there's no contention of resources when running the benchmarks. Once finished, the raw JSON result is stored in a <code>Postgres</code> database, which the frontend can query using a <code>GraphQL</code> API, as shown in Figure 2 below.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/766e96b985de064519c776b0c59635b7/d0c2f/current-bench-ui.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVQ4y5VT227aQBD1R3NJq/Sl6mP/I38QqaqaKgEUICAS2iAqh0JSUbCN8W1t767XPtWMa9T2rSMdzXrmeHbm7K716eMHXF9fo9fr4fPVFd6cn6PdaqHbbqPTbqPb6Zxw9hu87nYZnVYLr89esX//7i2s9WICnYUQaYokSfDw8IDZbIbF4wKLxQJPT081bBu2bbOnb1p/nc8xHY5xNxpjOr7D4OYGlj0fYvv9G/auh+PRh9Ia/2NlVZ3+2e33sO7nj/D8EGVZIstSOI6LNE2ZUJUlytJgu/0Jx3HgeS6CIODYy8sPuK4L3/e5EbLVagXr/ssSaV6gKAoIIeC4HvwgRGEq5KqAVAVEJiHSHHGSIhYZtKk4logMUSwQi7oBksKazuaQqkRVlaxhIiRcL4IfRNCFgSoMjkEI1/O5uNQFHO8A9+AjzXLemBqgnM0FpxOUxvAOcZxgtarw/FxBa4pV9djGwD8csN1ua92MgdYKz5sNpJRQUsLZ77FcLmFNJhMYY1BVVETDdX3WRojkL/HDMIJSijUj0DSNHY8BgjDik7dGwyETyahwludwDwHCOOUx4lQiEjlrSJsmieB8lGSscSQkDkEMXZS1hqPRiA+EjDwVzXMJrQtIqZAzJPQfHGqA86rOE49ss9nAGo/HTKJrQyMTOcuy01orxZ5AHPKkW6E1c2qe5ILr9RoWvYp/jQrSFaL72CDP81Oe9KNYw2n03O12sC4uLtDv9zEcDjEYDE6eYg3onTec29tb9Hu9U6zJU+7y8hK/AFPuveOUWPcYAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/766e96b985de064519c776b0c59635b7/c5bb3/current-bench-ui.png" class="gatsby-resp-image-image" alt="Figure 2: Current bench UI" title="Figure 2: Current bench UI" srcset="/static/766e96b985de064519c776b0c59635b7/04472/current-bench-ui.png 170w,
/static/766e96b985de064519c776b0c59635b7/9f933/current-bench-ui.png 340w,
/static/766e96b985de064519c776b0c59635b7/c5bb3/current-bench-ui.png 680w,
/static/766e96b985de064519c776b0c59635b7/b12f7/current-bench-ui.png 1020w,
/static/766e96b985de064519c776b0c59635b7/b5a09/current-bench-ui.png 1360w,
/static/766e96b985de064519c776b0c59635b7/d0c2f/current-bench-ui.png 1362w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>The frontend supports historical navigation and provides comparison with the default branch. It allows users to select a pull request of which they want to see the graphs. The graphs display the individual result of the head commit and the comparison with the commits on the default branch. The frontend permits users to select the historical interval when they want to compare benchmarks, and it also shows the standard deviation.  Once the benchmarks have run successfully, the pipeline sets the pull request status to the frontend URL. Then the user can look at the graphs.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#hardware-optimisation" aria-label="hardware optimisation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hardware Optimisation</h3>
<p>Our <code>current-bench</code> uses the hardware optimisations developed for OCaml multicore compiler benchmarks <a href="https://github.com/ocaml-bench/ocaml_bench_scripts#notes-on-hardware-and-os-settings-for-linux-benchmarking">(presented at ICFP OCaml Workshop 2019)</a> with a few modifications to allow the benchmarks to run inside Docker containers. To get stable performance, we configured the kernel to isolate some of the CPU cores. Linux then avoids scheduling other user processes automatically. We also disabled IRQ handling and power saving.</p>
<p>The container that runs the benchmark is pinned to one of the isolated cores. Since I/O operations can make the benchmarks less stable, we use an in-memory <code>tmpfs</code> partition in <code>/dev/shm</code> for all storage. For NUMA enabled systems, we configure this partition to be allocated on the NUMA node of the isolated core. The pipeline disables ASLR inside the container automatically, which is normally blocked by the default Docker seccomp profile, so we have modified the profile to allow the <code>personality(2)</code> syscall.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#enrolling-a-repository" aria-label="enrolling a repository permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enrolling a repository</h2>
<p>To enroll a repository, you need to ensure the following:</p>
<ul>
<li>Enable the <a href="https://github.com/marketplace/ocaml-benchmarks">ocaml-benchmarks</a> GitHub app for your repository.</li>
<li>The repository needs a <code>bench</code> Makefile target. This is triggered from the <code>current-bench</code> pipeline.</li>
<li>The output of the <code>make bench</code> target is JSON, which can be parsed by the pipeline and displayed by the frontend.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#future-work" aria-label="future work permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Future work</h2>
<p>Anyone who wants to roll out a continuous, zero-configured benchmarking infrastructure can set up the current-bench infrastructure. In the future, we want to scale <code>current-bench</code> by isolating cores on multiple machines and adding a scheduler to ensure that benchmarks use only one core at a time per machine. We plan to add support for different benchmarking libraries that repositories can use&mdash;for example, we currently support repositories using <code>bechamel</code>.  We also aim to make the adoption of <code>current-bench</code> easier by adding a conversion library that can convert any benchmark output into output parseable by <code>current-bench</code>. We intend to add support for <code>quick</code> and <code>slow</code> benchmarks, which would allow users to have faster feedback loops on pull requests while ensuring they can still run more extensive, time consuming benchmarks to see the performance.</p>
<p>Thank you for reading! You can check out the implementation for <code>current-bench</code> <a href="https://github.com/ocurrent/current-bench">here</a>!</p>|js}
  };
 
  { title = {js|Goodbye Core_kernel|js}
  ; slug = {js|goodbye-corekernel|js}
  ; description = Some {js|We recently restructured our standard libraries at Jane Street in away that eliminates the difference between Core_kernel and Coreand we’re happy with the re...|js}
  ; url = {js|https://blog.janestreet.com/goodbye-Core_kernel/|js}
  ; date = {js|2021-08-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/goodbye-Core_kernel/./core_kernel.png|js}
  ; featured = false
  ; body_html = {js|<p>We recently restructured our standard libraries at Jane Street in a
way that eliminates the difference between <code class="highlighter-rouge">Core_kernel</code> and <code class="highlighter-rouge">Core</code>
and we&rsquo;re happy with the result. The new layout should reach the open
source world before the end of the year.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2021 edition|js}
  ; slug = {js|what-the-interns-have-wrought-2021-edition|js}
  ; description = Some {js|It’s the end of another dev internship season, and this one markedsomething of a transition, since halfway through the season, NY-basedinterns were invited b...|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2021/|js}
  ; date = {js|2021-08-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/what-the-interns-have-wrought-2021/internswrought_2021.jpg|js}
  ; featured = false
  ; body_html = {js|<p>It&rsquo;s the end of another dev internship season, and this one marked
something of a transition, since halfway through the season, NY-based
interns were invited back to the recently reinvigorated office.  Which
means that many more of us got the chance to meet and hang out with
the interns in person than we did last year.  And hopefully the
interns were able to get a better sense of Jane Street and how it
operates.</p>|js}
  };
 
  { title = {js|Tarides at WomenHack Virtual Event|js}
  ; slug = {js|tarides-at-womenhack-virtual-event|js}
  ; description = Some {js|Tarides takes great pride in a diverse workforce and strives to continue
bringing talented people to its team from around the globe. This is…|js}
  ; url = {js|https://tarides.com/blog/2021-07-20-tarides-at-womenhack-virtual-event|js}
  ; date = {js|2021-07-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/d57d3ef7c12240d9300498f6be74d3a9/0132d/ColorfulCode.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Tarides takes great pride in a diverse workforce and strives to continue
bringing talented people to its team from around the globe. This is why Sonja
Heinze, a Tarides software engineer, and the Head of HR, H&eacute;lo&iuml;se Lutton, will
attend WomenHack, an online event dedicated to recruiting more women into the
tech world. They're participating not only to present Tarides to the Women In
Tech community, but to also network and possibly find new talented programmers
to join our growing team.</p>
<p>The <strong>WomenHack</strong> event has a unique setup similar to 'speed dating,' but for
prospective jobs. Each candidate is paired with a company, and they have 5
minutes to chat before moving on to the next company. This &quot;rapid interview&quot; is
both fun and efficient for all involved, and it ensures each company will meet
several talented candidates from diverse backgrounds, which increases their
chance of finding that perfect fit for an open position!</p>
<p>From their website:</p>
<blockquote>
<p><strong><a href="https://womenhack.com/">WomenHack</a></strong> is a community that empowers women in
tech through events, jobs, and reviews. We aim to create a more inclusive and
diverse workplace for all. Our diversity recruiting events target some of the
most talented women in tech which include software developers, designers, and
product talent.&nbsp;</p>
</blockquote>
<p>Join us tomorrow, July 21st, at WomenHack! You can <a href="https://womenhack.com/events/72907/?tickets">get your ticket
here</a>.</p>|js}
  };
 
  { title = {js|Deploying binary MirageOS unikernels|js}
  ; slug = {js|deploying-binary-mirageos-unikernels|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/Deploy|js}
  ; date = {js|2021-06-30T13:13:37-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Introduction</h2>
<p>MirageOS development focus has been a lot on tooling and the developer experience, but to accomplish <a href="https://robur.coop">our</a> goal to &quot;get MirageOS into production&quot;, we need to lower the barrier. This means for us to release binary unikernels. As described <a href="https://hannes.robur.coop/Posts/NGI">earlier</a>, we received a grant for &quot;Deploying MirageOS&quot; from <a href="https://pointer.ngi.eu">NGI Pointer</a> to work on the required infrastructure. This is joint work with <a href="https://reynir.dk/">Reynir</a>.</p>
<p>We provide at <a href="https://builds.robur.coop">builds.robur.coop</a> binary unikernel images (and supplementary software). Doing binary releases of MirageOS unikernels is challenging in two aspects: firstly to be useful for everyone, a binary unikernel should not contain any configuration (such as private keys, certificates, etc.). Secondly, the binaries should be <a href="https://reproducible-builds.org">reproducible</a>. This is crucial for security; everyone can reproduce the exact same binary and verify that our build service did only use the sources. No malware or backdoors included.</p>
<p>This post describes how you can deploy MirageOS unikernels without compiling it from source, then dives into the two issues outlined above - configuration and reproducibility - and finally describes how to setup your own reproducible build infrastructure for MirageOS, and how to bootstrap it.</p>
<h2>Deploying MirageOS unikernels from binary</h2>
<p>To execute a MirageOS unikernel, apart from a hypervisor (Xen/KVM/Muen), a tender (responsible for allocating host system resources and passing these to the unikernel) is needed. Using virtio, this is conventionally done with qemu on Linux, but its code size (and attack surface) is huge. For MirageOS, we develop <a href="https://github.com/solo5/solo5">Solo5</a>, a minimal tender. It supports <em>hvt</em> - hardware virtualization (Linux KVM, FreeBSD BHyve, OpenBSD VMM), <em>spt</em> - sandboxed process (a tight seccomp ruleset (only a handful of system calls allowed, no hardware virtualization needed), Linux only). Apart from that, <a href="https://muen.sk"><em>muen</em></a> (a hypervisor developed in Ada), <em>virtio</em> (for some cloud deployments), and <em>xen</em> (PVHv2 or Qubes 4.0) - <a href="https://github.com/Solo5/solo5/blob/master/docs/building.md">read more</a>. We deploy our unikernels as hvt with FreeBSD BHyve as hypervisor.</p>
<p>On <a href="https://builds.robur.coop">builds.robur.coop</a>, next to the unikernel images, <a href="https://builds.robur.coop/job/solo5-hvt/"><em>solo5-hvt</em> packages</a> are provided - download the binary and install it. A <a href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/os-specific/solo5">NixOS package</a> is already available - please note that <a href="https://github.com/Solo5/solo5/pull/494">soon</a> packaging will be much easier (and we will work on packages merged into distributions).</p>
<p>When the tender is installed, download a unikernel image (e.g. the <a href="https://builds.robur.coop/job/traceroute/build/latest/">traceroute</a> described in <a href="https://hannes.robur.coop/Posts/Traceroute">an earlier post</a>), and execute it:</p>
<pre><code>$ solo5-hvt --net:service=tap0 -- traceroute.hvt --ipv4=10.0.42.2/24 --ipv4-gateway=10.0.42.1
</code></pre>
<p>If you plan to orchestrate MirageOS unikernels, you may be interested in <a href="https://github.com/roburio/albatross">albatross</a> - we provide <a href="https://builds.robur.coop/job/albatross/">binary packages as well for albatross</a>. An upcoming post will go into further details of how to setup albatross.</p>
<h2>MirageOS configuration</h2>
<p>A MirageOS unikernel has a specific purpose - composed of OCaml libraries - selected at compile time, which allows to only embed the required pieces. This reduces the attack surface drastically. At the same time, to be widely useful to multiple organisations, no configuration data must be embedded into the unikernel.</p>
<p>Early MirageOS unikernels such as <a href="https://github.com/mirage/mirage-www">mirage-www</a> embed content (blog posts, ..) and TLS certificates and private keys in the binary (using <a href="https://github.com/mirage/ocaml-crunch">crunch</a>). The <a href="https://github.com/mirage/qubes-mirage-firewall">Qubes firewall</a> (read the <a href="http://roscidus.com/blog/blog/2016/01/01/a-unikernel-firewall-for-qubesos/">blog post by Thomas</a> for more information) used to include the firewall rules until <a href="https://github.com/mirage/qubes-mirage-firewall/releases/tag/v0.6">v0.6</a> in the binary, since <a href="https://github.com/mirage/qubes-mirage-firewall/tree/v0.7">v0.7</a> the rules are read dynamically from QubesDB. This is big usability improvement.</p>
<p>We have several possibilities to provide configuration information in MirageOS, on the one hand via boot parameters (can be pre-filled at development time, and further refined at configuration time, but those passed at boot time take precedence). Boot parameters have a length limitation.</p>
<p>Another option is to <a href="https://github.com/roburio/tlstunnel/">use a block device</a> - where the TLS reverse proxy stores the configuration, modifiable via a TCP control socket (authentication using a shared hmac secret).</p>
<p>Several other unikernels, such as <a href="https://github.com/Engil/Canopy">this website</a> and <a href="https://github.com/roburio/caldav">our CalDAV server</a>, store the content in a remote git repository. The git URI and credentials (private key seed, host key fingerprint) are passed via boot parameter.</p>
<p>Finally, another option that we take advantage of is to introduce a post-link step that rewrites the binary to embed configuration. The tool <a href="https://github.com/dinosaure/caravan">caravan</a> developed by Romain that does this rewrite is used by our <a href="https://github.com/roburio/openvpn/tree/robur/mirage-router">openvpn router</a> (<a href="https://builds.robur.coop/job/openvpn-router/build/latest/">binary</a>).</p>
<p>In the future, some configuration information - such as monitoring system, syslog sink, IP addresses - may be done via DHCP on one of the private network interfaces - this would mean that the DHCP server has some global configuration option, and the unikernels no longer require that many boot parameters. Another option we want to investigate is where the tender shares a file as read-only memory-mapped region from the host system to the guest system - but this is tricky considering all targets above (especially virtio and muen).</p>
<h2>Behind the scenes: reproducible builds</h2>
<p>To provide a high level of assurance and trust, if you distribute binaries in 2021, you should have a recipe how they can be reproduced in a bit-by-bit identical way. This way, different organisations can run builders and rebuilders, and a user can decide to only use a binary if it has been reproduced by multiple organisations in different jurisdictions using different physical machines - to avoid malware being embedded in the binary.</p>
<p>For a reproduction to be successful, you need to collect the checksums of all sources that contributed to the built, together with other things (host system packages, environment variables, etc.). Of course, you can record the entire OS and sources as a tarball (or file system snapshot) and distribute that - but this may be suboptimal in terms of bandwidth requirements.</p>
<p>With opam, we already have precise tracking which opam packages are used, and since opam 2.1 the <code>opam switch export</code> includes <a href="https://github.com/ocaml/opam/pull/4040">extra-files (patches)</a> and <a href="https://github.com/ocaml/opam/pull/4055">records the VCS version</a>. Based on this functionality, <a href="https://github.com/roburio/orb">orb</a>, an alternative command line application using the opam-client library, can be used to collect (a) the switch export, (b) host system packages, and (c) the environment variables. Only required environment variables are kept, all others are unset while conducting a build. The only required environment variables are <code>PATH</code> (sanitized with an allow list, <code>/bin</code>, <code>/sbin</code>, with <code>/usr</code>, <code>/usr/local</code>, and <code>/opt</code> prefixes), and <code>HOME</code>. To enable Debian's <code>apt</code> to install packages, <code>DEBIAN_FRONTEND</code> is set to <code>noninteractive</code>. The <code>SWITCH_PATH</code> is recorded to allow orb to use the same path during a rebuild. The <code>SOURCE_DATE_EPOCH</code> is set to enable tools that record a timestamp to use a static one. The <code>OS*</code> variables are only used for recording the host OS and version.</p>
<p>The goal of reproducible builds can certainly be achieved in several ways, including to store all sources and used executables in a huge tarball (or docker container), which is preserved for rebuilders. The question of minimal trusted computing base and how such a container could be rebuild from sources in reproducible way are open.</p>
<p>The opam-repository is a community repository, where packages are released to on a daily basis by a lot of OCaml developers. Package dependencies usually only use lower bounds of other packages, and the continuous integration system of the opam repository takes care that upon API changes all reverse dependencies include the right upper bounds. Using the head commit of opam-repository usually leads to a working package universe.</p>
<p>For our MirageOS unikernels, we don't want to stay behind with ancient versions of libraries. That's why our automated building is done on a daily basis with the head commit of opam-repository. Since our unikernels are not part of the main opam repository (they include the configuration information which target to use, e.g. <em>hvt</em>), and we occasionally development versions of opam packages, we use <a href="https://git.robur.io/robur/unikernel-repo">the unikernel-repo</a> as overlay.</p>
<p>If no dependent package got a new release, the resulting binary has the same checksum. If any dependency was released with a newer release, this is picked up, and eventually the checksum changes.</p>
<p>Each unikernel (and non-unikernel) job (e.g. <a href="https://builds.robur.coop/job/dns-primary-git/build/latest/">dns-primary</a> outputs some artifacts:</p>
<ul>
<li>the <a href="https://builds.robur.coop/job/dns-primary-git/build/latest/f/bin/primary_git.hvt">binary image</a> (in <code>bin/</code>, unikernel image, OS package)
</li>
<li>the <a href="https://builds.robur.coop/job/dns-primary-git/build/latest/f/build-environment"><code>build-environment</code></a> containing the environment variables used for this build
</li>
<li>the <a href="https://builds.robur.coop/job/dns-primary-git/build/latest/f/system-packages"><code>system-packages</code></a> containing all packages installed on the host system
</li>
<li>the <a href="https://builds.robur.coop/job/dns-primary-git/build/latest/f/opam-switch"><code>opam-switch</code></a> that contains all opam packages, including git commit or tarball with checksum, and potentially extra patches, used for this build
</li>
<li>a job script and console output
</li>
</ul>
<p>To reproduce such a built, you need to get the same operating system (OS, OS_FAMILY, OS_DISTRIBUTION, OS_VERSION in build-environment), the same set of system packages, and then you can <code>orb rebuild</code> which sets the environment variables and installs the opam packages from the opam-switch.</p>
<p>You can <a href="https://builds.robur.coop/job/dns-primary-git/">browse</a> the different builds, and if there are checksum changes, you can browse to a diff between the opam switches to reason whether the checksum change was intentional (e.g. <a href="https://builds.robur.coop/compare/ba9ab091-9400-4e8d-ad37-cf1339114df8/23341f6b-cd26-48ab-9383-e71342455e81/opam-switch">here</a> the checksum of the unikernel changed when the x509 library was updated).</p>
<p>The opam reproducible build infrastructure is driven by:</p>
<ul>
<li><a href="https://github.com/roburio/orb">orb</a> conducting reproducible builds (<a href="https://builds.robur.coop/job/orb/">packages</a>)
</li>
<li><a href="https://github.com/roburio/builder">builder</a> scheduling builds in contained environments (<a href="https://builds.robur.coop/job/builder/">packages</a>)
</li>
<li><a href="https://git.robur.io/robur/builder-web">builder-web</a> storing builds in a database and providing a HTTP interface (<a href="https://builds.robur.coop/job/builder-web/">packages</a>)
</li>
</ul>
<p>These tools are themselves reproducible, and built on a daily basis. The infrastructure executing the build jobs installs the most recent packages of orb and builder before conducting a build. This means that our build infrastructure is reproducible as well, and uses the latest code when it is released.</p>
<h2>Conclusion</h2>
<p>Thanks to NGI funding we now have reproducible MirageOS binary builds available at <a href="https://builds.robur.coop">builds.robur.coop</a>. The underlying infrastructure is reproducible, available for multiple platforms (Ubuntu using docker, FreeBSD using jails), and can be easily bootstrapped from source (once you have OCaml and opam working, getting builder and orb should be easy). All components are open source software, mostly with permissive licenses.</p>
<p>We also have an index over sha-256 checksum of binaries - in the case you find a running unikernel image where you forgot which exact packages were used, you can do a reverse lookup.</p>
<p>We are aware that the web interface can be improved (PRs welcome). We will also work on the rebuilder setup and run some rebuilds.</p>
<p>Please reach out to us (at team AT robur DOT coop) if you have feedback and suggestions.</p>|js}
  };
 
  { title = {js|Tarides Introduces OSMOSE at the Open-Source Innovation Sprint|js}
  ; slug = {js|tarides-introduces-osmose-at-the-open-source-innovation-sprint|js}
  ; description = Some {js|Tarides is excited to announce that our CEO, Dr. Thomas Gazagnaire, and Prof.
Anil Madhavapeddy, from the University of Cambridge, will…|js}
  ; url = {js|https://tarides.com/blog/2021-06-29-tarides-introduces-osmose-at-the-open-source-innovation-sprint|js}
  ; date = {js|2021-06-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/61be7fbf64e3a8abb9518d02f63aa5e6/0d665/OSIS-talk.png|js}
  ; featured = false
  ; body_html = {js|<p>Tarides is excited to announce that our CEO, Dr. Thomas Gazagnaire, and Prof.
Anil Madhavapeddy, from the University of Cambridge, will present their
innovative platform OSMOSE at the Open Source Innovation Sprint (OSIS)
conference on 1 July 2021. This event is organized by
<a href="https://systematic-paris-region.org">Systematic</a>.</p>
<p>OSMOSE is a software platform made to manage digital infrastructure at scale,
securely and efficiently. It uses the groundbreaking creation of unikernels to
radically simplify the way applications are built and deployed for the cloud.</p>
<p>Since digital transformation has become more and more dependent on cloud
computing, it has increasing problems with high response latency, security
risks, and resource inefficiencies&mdash;all which make these services ultimately
unreliable. The demand for interconnected devices is ever increasing, but the
security of these devices remain unchecked, making them susceptible to security
vulnerabilities. This leaves consumers and businesses open to exploitation, as
demonstrated in reports of tech devices violating users&rsquo; privacy, like sending
audio recordings without their knowledge or consent.</p>
<p>Tarides addresses these issues with OSMOSE, a platform which combines hardware
and software elements to invert the current cloud-centric model. OSMOSE securely
connects with physical spaces to provide extremely low latency and
high-bandwidth, local-area computation capabilities, which can turn a fleet of
IoT devices into a local data-centre.</p>
<p>This innovative platform enables computer resources to be tracked efficiently
and temporarily rented to users. This turns any IoT deployment into a local,
private cloud, allowing a better utilization of local resources and improved
security.</p>
<p>Major components of OSMOSE already have commercial applications. It&rsquo;s been used
to make existing cloud deployments more secure and efficient by companies such
as Amazon, Citrix, and Docker.</p>
<p>Tarides applies a high-touch, mixed business strategy&mdash;using consultancy services
to field test open source components under development. Tarides applies their
research to real-world systems to build unikernels, a secure-by-design and
resource-efficient application specialised to their run-time environments. If
interested in using OSMOSE as a solution for your business,
<a href="https://tarides.com/company/">please reach out to Tarides</a> for more
information.</p>
<p><a href="https://systematic-paris-region.org/evenement/open-source-innovation-spring-edge-iot/">Register for OSIS</a>
to attend the OSMOSE presentation on 1 July 2021.</p>|js}
  };
 
  { title = {js|Looking for a developer experience engineer|js}
  ; slug = {js|looking-for-a-developer-experience-engineer|js}
  ; description = Some {js|The Jane Street Tools & Compilers team is looking to hire a developerwho will act as the primary contact point with users of our toolsthroughout the firm.|js}
  ; url = {js|https://blog.janestreet.com/looking-for-a-developer-experience-engineer-index/|js}
  ; date = {js|2021-06-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/looking-for-a-developer-experience-engineer-index/generic_tech.jpg|js}
  ; featured = false
  ; body_html = {js|<p>The Jane Street Tools &amp; Compilers team is looking to hire a developer
who will act as the primary contact point with users of our tools
throughout the firm.</p>|js}
  };
 
  { title = {js|Building Ahrefs codebase with Melange|js}
  ; slug = {js|building-ahrefs-codebase-with-melange|js}
  ; description = Some {js|What we learnt after experimenting with Melange, a fork of ReScript with a strong focus on keeping compatibility with OCaml.|js}
  ; url = {js|https://tech.ahrefs.com/building-ahrefs-codebase-with-melange-9f881f6d022b?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2021-05-18T15:24:20-00:00|js}
  ; preview_image = Some {js|https://miro.medium.com/max/1200/1*tYLUO4FDmJ6bzlsPp14LdQ.jpeg|js}
  ; featured = false
  ; body_html = {js|<figure><img src="https://cdn-images-1.medium.com/max/1024/1*tYLUO4FDmJ6bzlsPp14LdQ.jpeg" alt=""/><figcaption>Photo by <a href="https://unsplash.com/@madebyjens?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Jens Lelie</a> on&nbsp;<a href="https://unsplash.com/s/photos/fork-road?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></figcaption></figure><p>At Ahrefs, we have been using BuckleScript and ReasonML in production <a href="https://tech.ahrefs.com/one-and-a-half-years-of-reasonml-in-production-2250cf5ba63b">for more than two years</a>. We already have a codebase of tens of thousands of lines of code, with several web applications that are data intensive and communicate with backend services written in <a href="http://ocaml.org/">OCaml</a>, using tools like&nbsp;<a href="https://github.com/ahrefs/atd">atd</a>.</p><p>Given our investment in these technologies, we have been following closely the recent changes in <a href="https://rescript-lang.org/">ReScript</a>, with its rebrand and renaming, and the split with the ReasonML project, explained in the project <a href="https://rescript-lang.org/blog/bucklescript-is-rebranding">blog&nbsp;post</a>.</p><h3>ReScript: becoming its own&nbsp;language</h3><p>We are excited about the way ReScript is unifying the experience and making it easier for developers who are getting started to find documentation in a single place, as well as continuing its strong focus on performance and readable JavaScript output.</p><p>On the other hand, we are trying to figure out the implications of this change in the mid- and long-term, especially regarding the integration with the OCaml ecosystem. And more importantly, what this evolution will mean for production users like us who rely on this integration.</p><p>ReScript integration with OCaml has historically been seamless, as BuckleScript started originally as a <a href="https://www.reddit.com/r/ocaml/comments/4enok3/bloombergbucklescript_a_back_end_for_the_ocaml/">new backend for the OCaml compiler</a>. However, in recent months, there have been several hints that ReScript wants to evolve towards becoming its own language:</p><ul><li>It has now <a href="https://github.com/rescript-lang/syntax">its own parser</a>, incompatible with OCaml native applications</li><li>Official repository guidelines for technical writing mentions explicitly that <a href="https://github.com/rescript-association/rescript-lang.org/blob/master/CONTRIBUTING.md#technical-writing-documentation">no reference to OCaml</a> should appear in&nbsp;docs</li><li>Upgrades to the latest version of OCaml compiler, which <a href="https://web.archive.org/web/20210208054855if_/https://github.com/rescript-lang/rescript-compiler/wiki">used to be part of the roadmap</a>, have been <a href="https://forum.rescript-lang.org/t/some-thoughts-on-community-building/1474">deprioritized</a> recently.</li></ul><p>So, even if officially ReScript has not announced that they will break backwards compatibility with OCaml, just the fact that it is sticking with an old version of the OCaml compiler poses some challenges for us in terms of tooling. The uncertainty about the future and the pace of changes add some risk to the high-level goals we have for our teams and codebase: we would like to share <em>more</em> code between frontend and backend, not&nbsp;less.</p><h3>Melange: a fork of ReScript, focused on OCaml compatibility</h3><p>When Ant&oacute;nio Monteiro <a href="https://anmonteiro.com/2021/03/on-ocaml-and-the-js-platform/">announced Melange</a>, a fork of ReScript but with a strong focus on keeping compatibility with OCaml, we decided to try it out and see how it could work for&nbsp;us.</p><p>Ultimately, the experiment was successful. We managed to build all our frontend applications with Melange, while keeping the existing bundling setup, which currently uses&nbsp;Webpack.</p><p>Throughout this process, we had to modify some parts of the code. We will now go through the most relevant parts of the&nbsp;process:</p><ul><li>Upgrade to OCaml 4.12: the most relevant part was the deprecation of Pervasives module to use&nbsp;Stdlib.</li><li>Use ppxlib in our ppxs: we had to upgrade the two ppxs that we use in the frontend codebase to the latest compiler version, <a href="https://github.com/ahrefs/bs-emotion/compare/master...jchavarri:ocaml4.12-ppxlib">bs-emotion-ppx</a> and an in-house <a href="https://github.com/ahrefs/bs-react-intl-ppx">ppx for internationalization</a>.</li><li>Configure esy: we were already using esy to bring the editor tooling into scope of the developer environment, so we just had to make sure melange would also be included in the json configuration.</li><li>Upgrade to Reason 3.7.0: a quite simple change too, as the whole process is automated by using refmt. As a side note, we ran into <a href="https://github.com/reasonml/reason/issues/2636">a small bug</a> with some type annotations, that we were able to work&nbsp;around.</li><li>&ldquo;Lift&rdquo; dune workspace to the root of our monorepo: this is probably the most intrusive change. Because we have shared code between backend and frontend, and Dune needs to have access to all sources under its workspace, we had to &ldquo;lift&rdquo; the Dune workspace from the backend directory to the root of monorepo.</li></ul><h3>The good</h3><p>This experiment allowed us to experience what a project like Melange could offer for our use case. Here are some of the things we might be able to leverage in a codebase built with&nbsp;Melange:</p><ul><li>Recent version of the OCaml compiler: at some point, we could pin compiler version between backend and frontend teams, making upgrades more straightforward as they would happen atomically.</li><li>Shared editor tooling: the official OCaml <a href="https://github.com/ocamllabs/vscode-ocaml-platform">vscode extension</a> works great with Melange, as well as any other OCaml editor integration. Having backend and frontend teams use similar editor setup removes a lot of maintenance work for&nbsp;us.</li><li>Consuming ppxs from source: Melange allows to consume ppxs from source, which also removes issues with pre-compiled ppxs (like this issue with the recent <a href="https://github.com/ahrefs/bs-emotion/issues/53">M1&nbsp;Macs</a>).</li><li>Melange allows to run all ppxs <a href="https://github.com/melange-re/melange/pull/171">from a single executable file</a>, which has some nice performance benefits.</li><li>Use Dune for atd files generators: ReScript &ldquo;generators&rdquo; are unfortunately <a href="https://web.archive.org/web/20200710044513if_/https://reasonml.org/docs/reason-compiler/latest/build-advanced">not documented anymore</a>, but we use them extensively for atd file generation. Being able to share Dune rules in backend and frontend would make our build setup&nbsp;easier.</li><li>Access to OCaml documentation tooling: Melange allows to leverage existing tooling for generating documentation, like&nbsp;<a href="https://github.com/ocaml/odoc/">odoc</a>.</li><li>Async syntax: the latest Reason version <a href="https://github.com/reasonml/reason/pull/2487">supports &ldquo;let op&rdquo; syntax</a>, which is handy for client-side code.</li></ul><h3>The bad</h3><p>While there are many things that are exciting about Melange, there are some other parts that can be improved.</p><ul><li>Build performance: We already knew that performance would be far worse than ReScript, as Melange uses Dune in a way that it was not designed for. In our tests, builds with Melange are roughly 1 order of magnitude slower than ReScript&nbsp;ones.</li><li>First-class Dune support: if there was a deeper integration between Dune and Melange, we could explore features like shared libraries or shared rules between backend and frontend. As of today, Dune has no knowledge about Melange environment, so it can perform basic rules execution, but there is no access to high level stanzas like library in&nbsp;Melange.</li><li>Two-headed goal: finally, we see a more strategic risk in Melange proposition. Right now it has two goals: keep compatibility with both ReScript and OCaml. But we don&rsquo;t know how long these goals will be feasible. If at some point ReScript decides to move away from the OCaml compiler fully, then Melange users would not be able to consume any updates to the ReScript ecosystem anymore.</li></ul><h3>Alright, but are you migrating to Melange or ReScript?</h3><p>With all the information available, the answer is: we don&rsquo;t know yet. &#128516; We want to keep exploring all the available options and have as much information as possible before committing further. So for now, we are upgrading the codebase to recent versions of ReScript, but we are holding up on features that only work one way. For example, we have not migrated our codebase to the ReScript syntax yet, as <a href="https://github.com/rescript-lang/syntax/issues/405">there is no way to translate back to Reason&nbsp;syntax</a>.</p><p>In the meantime, we will keep exploring how far the limitations of Melange can be mitigated. To be continued! &#128640;</p><p><em>Thanks to Igor and Feihong for reviewing and improving earlier versions of this&nbsp;post.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=9f881f6d022b" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/building-ahrefs-codebase-with-melange-9f881f6d022b">Building Ahrefs codebase with Melange</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|Tarides project SCoP is selected as one of the brightest Data Portability projects in Europe!|js}
  ; slug = {js|tarides-project-scop-is-selected-as-one-of-the-brightest-data-portability-projects-in-europe|js}
  ; description = Some {js|Tarides is taking part in the Data Portability & Services Incubator (DAPSI), a
3-year EU funded project that empowers internet innovators to…|js}
  ; url = {js|https://tarides.com/blog/2021-04-30-scop-selected-for-dapsi-initiative|js}
  ; date = {js|2021-04-30T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/1a54502893f8f38db2c6e37811c75b0c/7d5a2/DAPSI_scop_banner.jpg|js}
  ; featured = false
  ; body_html = {js|<p><strong>Tarides is taking part in the Data Portability &amp; Services Incubator (DAPSI), a
3-year EU funded project that empowers internet innovators to develop new
solutions in the Data Portability field.</strong></p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#what-is-dapsi" aria-label="what is dapsi permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is DAPSI?</h2>
<p>The <a href="https://dapsi.ngi.eu">Data Portability and Services Incubator (DAPSI)</a> is
an EU funded project, under the European Commission&rsquo;s Next Generation Internet
(NGI) initiative. The aim of this initiave is to empower top internet innovators
to develop human-centric solutions. DAPSI addresses the challenge of personal
data portability on the internet, as foreseen under the GDPR and make it
significantly easier for citizens to have any data which is stored with one
service provider transmitted directly to another provider.</p>
<p>Take a look at the <a href="https://dapsi.ngi.eu/hall-of-fame/">DAPSI innovators
portfolio</a> to see more information about the
selected projects.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#what-is-our-project" aria-label="what is our project permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is our project?</h2>
<p>Our project, called <strong>SCoP</strong> for <strong>Secure-by-design Communication Protocols</strong>,
is taking part in the DAPSI to tackle data portability issues in communication
services.</p>
<p>Over the past few decades, the usage of emails has been massively widespread by
both individuals and companies. Billions of emails are sent every day and this
number is expected to increase to reach 333 billion of emails exchanged daily
in 2022. Moreover, as managing internet communication stacks have become
increasingly complex, end-users have tended to entrust this task to third-party
companies like Google and Microsoft. Furthermore, existing implementations of
these communication services rely on ad-hoc methodologies and memory-unsafe
languages, where minor developer errors can easily escalate into major security
flaws. The centralization of these communication services means that a single
successful attack leads to major personal data breaches.</p>
<p>To fix this issue, <strong>our project aims to engineer a modern basis for open
messaging that supports existing protocols such as emails but is also extensible
and customizable for emerging protocols such as matrix</strong>. We will be building
trustable implementations of these open protocols using type-safe languages and
we will deploy these implementations as specialized, secure and resource
efficient unikernels. They will become the basis of the communication system of
OSMOSE, Tarides&rsquo; commercial solution for secure-by-design IoT infrastructure.</p>
<p>Every component of that system will be carefully designed as independent
libraries, using modern development techniques to avoid the common reported
threats and flaws. For instance, the implementation of protocol parsers and
serializers will be written in a type-safe language and will be using fuzzing,
e.g state-of-the-art coverage-driven tests. The combination of these techniques
will increase users&rsquo; trust to migrate their personal data to these new secure
services.</p>
<p>Moreover, these techniques are also useful to produce a large and reusable
corpus of test materials, which we plan to release separately for other
implementations to use. It will give the tools to other developers to write the
next generation of messaging applications by extending the existing protocols
with more confidence.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#want-to-be-part-of-it" aria-label="want to be part of it permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Want to be part of it?</h2>
<p>Would you like to hear more about the project? Or want to deploy our solution?
This project will build on a number of existing components in
<a href="https://mirage.io">MirageOS</a>, such as
<a href="https://tarides.com/blog/2019-09-25-mr-mime-parse-and-generate-emails">MrMime</a>
and <a href="https://tarides.com/blog/2020-09-08-irmin-september-2020-update">Irmin</a>,
so feel free to contribute to these existing components! Please reach out to <a href="mailto:contact@tarides.com"></a><a href="mailto:contact@tarides.com">contact@tarides.com</a>.</p>
<br/>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/50ddca27efa367497d954f667fc921f8/a76d6/DAPSI_generic.jpg" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 3.5294117647058822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAABABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHSsFSCf//EABYQAQEBAAAAAAAAAAAAAAAAAAMQM//aAAgBAQABBQIc0n//xAAVEQEBAAAAAAAAAAAAAAAAAAACEP/aAAgBAwEBPwET/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/ATV//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQgf/aAAgBAQAGPwJGz//EABkQAAMAAwAAAAAAAAAAAAAAAAABQXGhsf/aAAgBAQABPyHdfScSI//aAAwDAQACAAMAAAAQCA//xAAWEQEBAQAAAAAAAAAAAAAAAAAAATH/2gAIAQMBAT8Q3Ef/xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAgEBPxCx/8QAGhAAAQUBAAAAAAAAAAAAAAAAAAEhMVHwsf/aAAgBAQABPxDUuQwdDgf/2Q=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/50ddca27efa367497d954f667fc921f8/7bf67/DAPSI_generic.jpg" class="gatsby-resp-image-image" alt="Sequence of entity logos: in association with NGI, EU, Zabala, FGS,
cap-digital, IMT Starter, Fraunhofer IAIS." title="Sequence of entity logos: in association with NGI, EU, Zabala, FGS,
cap-digital, IMT Starter, Fraunhofer IAIS." srcset="/static/50ddca27efa367497d954f667fc921f8/651be/DAPSI_generic.jpg 170w,
/static/50ddca27efa367497d954f667fc921f8/d30a3/DAPSI_generic.jpg 340w,
/static/50ddca27efa367497d954f667fc921f8/7bf67/DAPSI_generic.jpg 680w,
/static/50ddca27efa367497d954f667fc921f8/990cb/DAPSI_generic.jpg 1020w,
/static/50ddca27efa367497d954f667fc921f8/a76d6/DAPSI_generic.jpg 1139w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>|js}
  };
 
  { title = {js|Cryptography updates in OCaml and MirageOS|js}
  ; slug = {js|cryptography-updates-in-ocaml-and-mirageos|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/EC|js}
  ; date = {js|2021-04-23T13:33:06-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Introduction</h2>
<p>Tl;DR: mirage-crypto-ec, with x509 0.12.0, and tls 0.13.0, provide fast and secure elliptic curve support in OCaml and MirageOS - using the verified <a href="https://github.com/mit-plv/fiat-crypto/">fiat-crypto</a> stack (Coq to OCaml to executable which generates C code that is interfaced by OCaml). In x509, a long standing issue (countryName encoding), and archive (PKCS 12) format is now supported, in addition to EC keys. In tls, ECDH key exchanges are supported, and ECDSA and EdDSA certificates.</p>
<h2>Elliptic curve cryptography</h2>
<p><a href="https://mirage.io/blog/tls-1-3-mirageos">Since May 2020</a>, our <a href="https://usenix15.nqsb.io">OCaml-TLS</a> stack supports TLS 1.3 (since tls version 0.12.0 on opam).</p>
<p>TLS 1.3 requires elliptic curve cryptography - which was not available in <a href="https://github.com/mirage/mirage-crypto">mirage-crypto</a> (the maintained fork of <a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a>).</p>
<p>There are two major uses of elliptic curves: <a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman">key exchange (ECDH)</a> for establishing a shared secret over an insecure channel, and <a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm">digital signature (ECDSA)</a> for authentication, integrity, and non-repudiation. (Please note that the construction of digital signatures on Edwards curves (Curve25519, Ed448) is called EdDSA instead of ECDSA.)</p>
<p>Elliptic curve cryptoraphy is <a href="https://eprint.iacr.org/2020/615">vulnerable</a> <a href="https://raccoon-attack.com/">to</a> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5407">various</a> <a href="https://github.com/mimoo/timing_attack_ecdsa_tls">timing</a> <a href="https://minerva.crocs.fi.muni.cz/">attacks</a> - have a read of the <a href="https://blog.trailofbits.com/2020/06/11/ecdsa-handle-with-care/">overview article on ECDSA</a>. When implementing elliptic curve cryptography, it is best to avoid these known attacks. Gladly, there are some projects which address these issues by construction.</p>
<p>In addition, to use the code in MirageOS, it should be boring C code: no heap allocations, only using a very small amount of C library functions -- the code needs to be compiled in an environment with <a href="https://github.com/mirage/ocaml-freestanding/tree/v0.6.4/nolibc">nolibc</a>.</p>
<p>Two projects started in semantics, to solve the issue from the grounds up: <a href="https://github.com/mit-plv/fiat-crypto/">fiat-crypto</a> and <a href="https://github.com/project-everest/hacl-star/">hacl-star</a>: their approach is to use a proof system (<a href="https://coq.inria.fr">Coq</a> or <a href="https://www.fstar-lang.org/">F*</a> to verify that the code executes in constant time, not depending on data input. Both projects provide as output of their proof systems C code.</p>
<p>For our initial TLS 1.3 stack, <a href="https://github.com/pascutto/">Cl&eacute;ment</a>, <a href="https://github.com/NathanReb/">Nathan</a> and <a href="https://github.com/emillon/">Etienne</a> developed <a href="https://github.com/mirage/fiat">fiat-p256</a> and <a href="https://github.com/mirage/hacl">hacl_x5519</a>. Both were one-shot interfaces for a narrow use case (ECDH for NIST P-256 and X25519), worked well for their purpose, and allowed to gather some experience from the development side.</p>
<h3>Changed requirements</h3>
<p>Revisiting our cryptography stack with the elliptic curve perspective had several reasons, on the one side the customer project <a href="https://www.nitrokey.com/products/nethsm">NetHSM</a> asked for feasibility of ECDSA/EdDSA for various elliptic curves, on the other side <a href="https://github.com/mirage/ocaml-dns/pull/251">DNSSec</a> uses elliptic curve cryptography (ECDSA), and also <a href="https://www.wireguard.com/">wireguard</a> relies on elliptic curve cryptography. The number of X.509 certificates using elliptic curves is increasing, and we don't want to leave our TLS stack in a state where it can barely talk to a growing number of services on the Internet.</p>
<p>Looking at <a href="https://github.com/project-everest/hacl-star/"><em>hacl-star</em></a>, their <a href="https://hacl-star.github.io/Supported.html">support</a> is limited to P-256 and Curve25519, any new curve requires writing F*. Another issue with hacl-star is C code quality: their C code does neither <a href="https://github.com/mirage/hacl/issues/46">compile with older C compilers (found on Oracle Linux 7 / CentOS 7)</a>, nor when enabling all warnings (&gt; 150 are generated). We consider the C compiler as useful resource to figure out undefined behaviour (and other problems), and when shipping C code we ensure that it compiles with <code>-Wall -Wextra -Wpedantic --std=c99 -Werror</code>. The hacl project <a href="https://github.com/mirage/hacl/tree/master/src/kremlin">ships</a> a bunch of header files and helper functions to work on all platforms, which is a clunky <code>ifdef</code> desert. The hacl approach is to generate a whole algorithm solution: from arithmetic primitives, group operations, up to cryptographic protocol - everything included.</p>
<p>In contrast, <a href="https://github.com/mit-plv/fiat-crypto/"><em>fiat-crypto</em></a> is a Coq development, which as part of compilation (proof verification) generates executables (via OCaml code extraction from Coq). These executables are used to generate modular arithmetic (as C code) given a curve description. The <a href="https://github.com/mirage/mirage-crypto/tree/main/ec/native">generated C code</a> is highly portable, independent of platform (word size is taken as input) - it only requires a <code>&lt;stdint.h&gt;</code>, and compiles with all warnings enabled (once <a href="https://github.com/mit-plv/fiat-crypto/pull/906">a minor PR</a> got merged). Supporting a new curve is simple: generate the arithmetic code using fiat-crypto with the new curve description. The downside is that group operations and protocol needs to implemented elsewhere (and is not part of the proven code) - gladly this is pretty straightforward to do, especially in high-level languages.</p>
<h3>Working with fiat-crypto</h3>
<p>As mentioned, our initial <a href="https://github.com/mirage/fiat">fiat-p256</a> binding provided ECDH for the NIST P-256 curve. Also, BoringSSL uses fiat-crypto for ECDH, and developed the code for group operations and cryptographic protocol on top of it.</p>
<p>The work needed was (a) ECDSA support and (b) supporting more curves (let's focus on NIST curves). For ECDSA, the algorithm requires modular arithmetics in the field of the group order (in addition to the prime). We generate these primitives with fiat-crypto (named <code>npYYY_AA</code>) - that required <a href="https://github.com/mit-plv/fiat-crypto/commit/e31a36d5f1b20134e67ccc5339d88f0ff3cb0f86">a small fix in decoding hex</a>. Fiat-crypto also provides inversion <a href="https://github.com/mit-plv/fiat-crypto/pull/670">since late October 2020</a>, <a href="https://eprint.iacr.org/2021/549">paper</a> - which allowed to reduce our code base taken from BoringSSL. The ECDSA protocol was easy to implement in OCaml using the generated arithmetics.</p>
<p>Addressing the issue of more curves was also easy to achieve, the C code (group operations) are macros that are instantiated for each curve - the OCaml code are functors that are applied with each curve description.</p>
<p>Thanks to the test vectors (as structured data) from <a href="https://github.com/google/wycheproof/">wycheproof</a> (and again thanks to Etienne, Nathan, and Cl&eacute;ment for their OCaml code decodin them), I feel confident that our elliptic curve code works as desired.</p>
<p>What was left is X25519 and Ed25519 - dropping the hacl dependency entirely felt appealing (less C code to maintain from fewer projects). This turned out to require more C code, which we took from BoringSSL. It may be desirable to reduce the imported C code, or to wait until a project on top of fiat-crypto which provides proven cryptographic protocols is in a usable state.</p>
<p>To avoid performance degradation, I distilled some <a href="https://github.com/mirage/mirage-crypto/pull/107#issuecomment-799701703">X25519 benchmarks</a>, turns out the fiat-crypto and hacl performance is very similar.</p>
<h3>Achievements</h3>
<p>The new opam package <a href="https://mirage.github.io/mirage-crypto/doc/mirage-crypto-ec/Mirage_crypto_ec/index.html">mirage-crypto-ec</a> is released, which includes the C code generated by fiat-crypto (including <a href="https://github.com/mit-plv/fiat-crypto/pull/670">inversion</a>), <a href="https://github.com/mirage/mirage-crypto/blob/main/ec/native/point_operations.h">point operations</a> from BoringSSL, and some <a href="https://github.com/mirage/mirage-crypto/blob/main/ec/mirage_crypto_ec.ml">OCaml code</a> for invoking these functions and doing bounds checks, and whether points are on the curve. The OCaml code are some functors that take the curve description (consisting of parameters, C function names, byte length of value) and provide Diffie-Hellman (Dh) and digital signature algorithm (Dsa) modules. The nonce for ECDSA is computed deterministically, as suggested by <a href="https://tools.ietf.org/html/rfc6979">RFC 6979</a>, to avoid private key leakage.</p>
<p>The code has been developed in <a href="https://github.com/mirage/mirage-crypto/pull/101">NIST curves</a>, <a href="https://github.com/mirage/mirage-crypto/pull/106">removing blinding</a> (since we use operations that are verified to be constant-time), <a href="https://github.com/mirage/mirage-crypto/pull/108">added missing length checks</a> (reported by <a href="https://github.com/greg42">Greg</a>), <a href="https://github.com/mirage/mirage-crypto/pull/107">curve25519</a>, <a href="https://github.com/mirage/mirage-crypto/pull/117">a fix for signatures that do not span the entire byte size (discovered while adapting X.509)</a>, <a href="https://github.com/mirage/mirage-crypto/pull/118">fix X25519 when the input has offset &lt;&gt; 0</a>. It works on x86 and arm, both 32 and 64 bit (checked by CI). The development was partially sponsored by Nitrokey.</p>
<p>What is left to do, apart from further security reviews, is <a href="https://github.com/mirage/mirage-crypto/issues/109">performance improvements</a>, <a href="https://github.com/mirage/mirage-crypto/issues/112">Ed448/X448 support</a>, and <a href="https://github.com/mirage/mirage-crypto/issues/105">investigating deterministic k for P521</a>. Pull requests are welcome.</p>
<p>When you use the code, and encounter any issues, please <a href="https://github.com/mirage/mirage-crypto/issues">report them</a>.</p>
<h2>Layer up - X.509 now with ECDSA / EdDSA and PKCS 12 support, and a long-standing issue fixed</h2>
<p>With the sign and verify primitives, the next step is to interoperate with other tools that generate and use these public and private keys. This consists of serialisation to and deserialisation from common data formats (ASN.1 DER and PEM encoding), and support for handling X.509 certificates with elliptic curve keys. Since X.509 0.12.0, it supports EC private and public keys, including certificate validation and issuance.</p>
<p>Releasing X.509 also included to go through the issue tracker and attempt to solve the existing issues. This time, the <a href="https://github.com/mirleft/ocaml-x509/issues/69">&quot;country name is encoded as UTF8String, while RFC demands PrintableString&quot;</a> filed more than 5 years ago by <a href="https://github.com/reynir">Reynir</a>, re-reported by <a href="https://github.com/paurkedal">Petter</a> in early 2017, and again by <a href="https://github.com/NightBlues">Vadim</a> in late 2020, <a href="https://github.com/mirleft/ocaml-x509/pull/140">was fixed by Vadim</a>.</p>
<p>Another long-standing pull request was support for <a href="https://tools.ietf.org/html/rfc7292">PKCS 12</a>, the archive format for certificate and private key bundles. This has <a href="https://github.com/mirleft/ocaml-x509/pull/114">been developed and merged</a>. PKCS 12 is a widely used and old format (e.g. when importing / exporting cryptographic material in your browser, used by OpenVPN, ...). Its specification uses RC2 and 3DES (see <a href="https://unmitigatedrisk.com/?p=654">this nice article</a>), which are the default algorithms used by <code>openssl pkcs12</code>.</p>
<h2>One more layer up - TLS</h2>
<p>In TLS we are finally able to use ECDSA (and EdDSA) certificates and private keys, this resulted in slightly more complex configuration - the constraints between supported groups, signature algorithms, ciphersuite, and certificates are intricate:</p>
<p>The ciphersuite (in TLS before 1.3) specifies which key exchange mechanism to use, but also which signature algorithm to use (RSA/ECDSA). The supported groups client hello extension specifies which elliptic curves are supported by the client. The signature algorithm hello extension (TLS 1.2 and above) specifies the signature algorithm. In the end, at load time the TLS configuration is validated and groups, ciphersuites, and signature algorithms are condensed depending on configured server certificates. At session initiation time, once the client reports what it supports, these parameters are further cut down to eventually find some suitable cryptographic parameters for this session.</p>
<p>From the user perspective, earlier the certificate bundle and private key was a pair of <code>X509.Certificate.t list</code> and <code>Mirage_crypto_pk.Rsa.priv</code>, now the second part is a <code>X509.Private_key.t</code> - all provided constructors have been updates (notably <code>X509_lwt.private_of_pems</code> and <code>Tls_mirage.X509.certificate</code>).</p>
<h2>Finally, conduit and mirage</h2>
<p>Thanks to <a href="https://github.com/dinosaure">Romain</a>, conduit* 4.0.0 was released which supports the modified API of X.509 and TLS. Romain also developed patches and released mirage 3.10.3 which supports the above mentioned work.</p>
<h2>Conclusion</h2>
<p>Elliptic curve cryptography is now available in OCaml using verified cryptographic primitives from the fiat-crypto project - <code>opam install mirage-crypto-ec</code>. X.509 since 0.12.0 and TLS since 0.13.0 and MirageOS since 3.10.3 support this new development which gives rise to smaller EC keys. Our old bindings, fiat-p256 and hacl_x25519 have been archived and will no longer be maintained.</p>
<p>Thanks to everyone involved on this journey: reporting issues, sponsoring parts of the work, helping with integration, developing initial prototypes, and keep motivating me to continue this until the release is done.</p>
<p>In the future, it may be possible to remove zarith and gmp from the dependency chain, and provide EC-only TLS servers and clients for MirageOS. The benefit will be much less C code (libgmp-freestanding.a is 1.5MB in size) in our trusted code base.</p>
<p>Another potential project that is very close now is a certificate authority developed in MirageOS - now that EC keys, PKCS 12, revocation lists, ... are implemented.</p>
<h2>Footer</h2>
<p>If you want to support our work on MirageOS unikernels, please <a href="https://robur.coop/Donate">donate to robur</a>. I'm interested in feedback, either via <a href="https://twitter.com/h4nnes">twitter</a>, <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|Florence and beyond: the future of Tezos storage|js}
  ; slug = {js|florence-and-beyond-the-future-of-tezos-storage|js}
  ; description = Some {js|In collaboration with Nomadic Labs, Marigold and DaiLambda, we're happy to
announce the completion of the next Tezos protocol proposal…|js}
  ; url = {js|https://tarides.com/blog/2021-03-04-florence-and-beyond-the-future-of-tezos-storage|js}
  ; date = {js|2021-03-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/d81c504dbb5172d29c2aa38512f1dfe3/7d5a2/florence.jpg|js}
  ; featured = false
  ; body_html = {js|<p>In collaboration with Nomadic Labs, Marigold and DaiLambda, we're happy to
announce the completion of the next Tezos protocol proposal:
<a href="http://doc.tzalpha.net/protocols/009_florence.html"><strong>Florence</strong></a>.</p>
<p><a href="https://tezos.com/">Tezos</a> is an open-source decentralised blockchain network providing a
platform for smart contracts and digital assets. A crucial feature of Tezos is
<a href="https://tezos.com/static/white_paper-2dc8c02267a8fb86bd67a108199441bf.pdf"><em>self-amendment</em></a>: the network protocol can be upgraded
dynamically by the network participants themselves. This amendment process is
initiated when a participant makes a <em>proposal</em>, which is then subject to a
vote. After several years working on the Tezos storage stack, this is our first
contribution to a proposal; we hope that it will be the first of many!</p>
<p>As detailed in today's <a href="https://blog.nomadic-labs.com/florence-our-next-protocol-upgrade-proposal.html">announcement from Nomadic Labs</a>,
the Florence proposal contains several important changes, from the introduction
of Baking Accounts to major quality-of-life improvements for smart contract
developers. Of all of these changes, we're especially excited about the
introduction of <em>sub-trees</em> to the blockchain context API. In this post, we'll
give a brief tour of what these sub-trees will bring for the future of Tezos.
But first, what <em>are</em> they?</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#merkle-sub-trees" aria-label="merkle sub trees permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Merkle sub-trees</h3>
<p>The Tezos protocol runs on top of a versioned tree called the &ldquo;context&rdquo;, which
holds the chain state (balances, contracts etc.). Ever since the pre-Alpha era,
the Tezos context has been implemented using <a href="https://github.com/mirage/irmin">Irmin</a> &ndash; an open-source
Merkle tree database originally written for use by MirageOS unikernels.</p>
<p>For MirageOS, Irmin&rsquo;s key strength is flexibility: it can run over arbitrary
backends. This is a perfect fit for Tezos, which must be agile and
widely-deployable. Indeed, the Tezos shell has already leveraged this agility
many times, all the way from initial prototypes using a Git backend to the
optimised <a href="https://tarides.com/blog/2020-09-01-introducing-irmin-pack"><code>irmin-pack</code></a> implementation used today.</p>
<p>But Irmin can do more than just swapping backends! It also allows users to
manipulate the underlying Merkle tree structure of the store with a high-level
API. This &ldquo;<a href="https://mirage.github.io/irmin/irmin/Irmin/module-type-S/Tree/">Tree</a>&rdquo; API enables lots of interesting use-cases of
Irmin, from mergeable data types (<a href="https://kcsrk.info/papers/banyan_aplas20.pdf">MRDTs</a>) to zero-knowledge proofs.
Tezos doesn't use these more powerful features directly yet; that&rsquo;s where Merkle
proofs come in!</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#proofs-and-lightweight-tezos-clients" aria-label="proofs and lightweight tezos clients permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proofs and lightweight Tezos clients</h3>
<p>Since the Tezos context keeps track of the current &quot;state&quot; of the blockchain,
each participant needs their own copy of the tree to run transactions against.
This context can grow to be very large, so it's important that it be stored as
compactly as possible: this goal shaped the design of <code>irmin-pack</code>, our latest
Irmin backend.</p>
<p>However, it's possible to reduce the storage requirements even further via the
magic of Merkle trees: individuals only need to store a <em>fragment</em> of the root
tree, provided they can demonstrate that this fragment is valid by sending
&ldquo;<a href="https://bentnib.org/posts/2016-04-12-authenticated-data-structures-as-a-library.html">proofs</a>&rdquo; of its membership to the other participants.</p>
<p>This property can be used to support ultra-lightweight Tezos clients, a feature
<a href="https://gitlab.com/smelc/tezos/-/commits/tweag-client-light-mode">currently being developed</a> by TweagIO. To make this a reality,
the Tezos protocol needs fine-grained access to context sub-trees in order build
Merkle proofs out of them. Fortunately, Irmin already supports this! We
<a href="https://gitlab.com/tezos/tezos/-/merge_requests/2457">extended the protocol</a> to understand sub-trees, lifting the power
of Merkle trees to the user.</p>
<p>We&rsquo;re excited to work with TweagIO and Nomadic Labs on lowering the barriers to
entering the Tezos ecosystem and look forward to seeing what they achieve with
sub-trees!</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#efficient-merkle-proof-representations" aria-label="efficient merkle proof representations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Efficient Merkle proof representations</h3>
<p>Simply exposing sub-trees in the Tezos context API isn&rsquo;t quite enough:
lightweight clients will also need to <em>serialize</em> them efficiently, since proofs
must be exchanged over the network to establish trust between collaborating
nodes. Enter <a href="https://dailambda.jp/blog/2020-05-11-plebeia/">Plebeia</a>.</p>
<p>Plebeia is an alternative Tezos storage layer &ndash; developed by DaiLambda &ndash; with
strengths that complement those of Irmin. In particular, Plebeia is capable of
generating very compact Merkle proofs. This is partly due to its specialized
store structure, and partly due to clever optimizations such as path compression
and inlining.</p>
<p>We&rsquo;re working with the DaiLambda team to unite the strengths of Irmin and
Plebeia, which will bring built-in Merkle proof support to the Tezos storage
stack. The future is bright for Merkle proofs in Tezos!</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#baking-account-migrations" aria-label="baking account migrations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Baking account migrations</h3>
<p>Trees don&rsquo;t just enable <em>new</em> features; they have a big impact on performance
too! Currently, indexing into the context always happens from its <em>root</em>, which
duplicates effort when accessing adjacent values deep in the tree. Fortunately,
the new sub-trees provide a natural representation for &ldquo;cursors&rdquo; into the
context, allowing the protocol to optimize its interactions with the storage
layer.</p>
<p>To take just one example, DaiLambda recently exploited this feature to reduce
the migration time necessary to introduce Baking Accounts to the network by a
factor of 15! We&rsquo;ll be teaming up with Nomadic Labs and DaiLambda to ensure that
Tezos extracts every bit of performance from its storage.</p>
<p>It's especially exciting to have access to lightning-fast storage migrations,
since this enables Tezos to evolve rapidly even as the ecosystem expands.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#storage-in-other-languages" aria-label="storage in other languages permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storage in other languages</h3>
<p>Of course, Tezos isn&rsquo;t just an OCaml project: the storage layer also has a
performant Rust implementation as part of <a href="https://github.com/simplestaking/tezedge">TezEdge</a>. We&rsquo;re working with
<a href="https://github.com/simplestaking">Simple Staking</a> to bring Irmin to the Rust community via an
<a href="https://github.com/simplestaking/ocaml-interop">FFI toolchain</a>, enabling closer alignment between the different
Tezos shell implementations.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h3>
<p>All in all, it&rsquo;s an exciting time to work on Tezos storage, with many
open-source collaborators from around the world. We&rsquo;re especially happy to see
Tezos taking greater advantage of Irmin&rsquo;s features, which will strengthen both
projects and help them grow together.</p>
<p>If all of this sounds interesting, you can play with it yourself using the
recently-released <a href="https://github.com/mirage/irmin">Irmin 2.5.0</a>. Thanks for reading, and stay tuned for
future Tezos development updates!</p>|js}
  };
 
  { title = {js|Partnering for more diversity in Tech|js}
  ; slug = {js|partnering-for-more-diversity-in-tech|js}
  ; description = Some {js|Tarides is very glad to announce our partnership with Ada Tech
School. Founded in 2019 and based in Paris (France), Ada Tech School, named…|js}
  ; url = {js|https://tarides.com/blog/2021-02-15-partnering-for-more-diversity-in-tech|js}
  ; date = {js|2021-02-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/6b03b0cada1534ce78483ee37b3475c8/7d5a2/ada_tech_school.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Tarides is very glad to announce our partnership with <a href="https://adatechschool.fr">Ada Tech
School</a>.</p>
<p>Founded in 2019 and based in Paris (France), Ada Tech School, named for pioneer
computer scientist <a href="https://en.wikipedia.org/wiki/Ada_Lovelace">Ada Lovelace</a>,
is a programming school designed for women but open to all. The program is
driven by three values: feminism, empathy and singularity. Its mission is to
facilitate access to programming positions and promote the feminization of tech,
by creating training that tackles the gender and cultural biases of IT.</p>
<p>Unfortunately, the diversity of the candidate pool is very limited when a
company tries to fill positions. Barely 10% of computer science students in
France are girls. Ada Tech School is an excellent initiative to democratize
software education amongst women. The school was created so that women can land
a job easily in the IT industry through rigorous training, and then offer
ongoing coaching and support to ascend the professional ladder within tech
companies.</p>
<p>At Tarides, we believe that a healthy team is a diverse one; and that trust,
fairness and inclusion are values needed to build a strong company.</p>
<p>We are committed to doing better, not only by hiring a diverse team and
providing a welcoming work environment, but also by putting people first at
every stage. This means providing fair and equitable compensation as well as
meaningful career advancement opportunities for every employee.</p>
<p>We believe that a great technology always derives from great people, regardless
of their background. Head <a href="https://tarides.com/company">here</a> to see our
currently-open positions.</p>|js}
  };
 
  { title = {js|Recent and upcoming changes to Merlin|js}
  ; slug = {js|recent-and-upcoming-changes-to-merlin|js}
  ; description = Some {js|Merlin is a language server for the OCaml programming language; that is, a daemon
that connects to your favourite text editor and provides…|js}
  ; url = {js|https://tarides.com/blog/2021-01-26-recent-and-upcoming-changes-to-merlin|js}
  ; date = {js|2021-01-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/1d86af9747be51519d2c89b476b5b306/0132d/camelgicien.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Merlin is a language server for the OCaml programming language; that is, a daemon
that connects to your favourite text editor and provides the usual services of
an IDE: instant feedback on warnings and errors, autocompletion, &quot;type of the
code under the cursor&quot;, &quot;go to definition&quot;, etc. As we (Fr&eacute;d&eacute;ric Bour, Ulysse
G&eacute;rard and I) are about to do a new major release, we thought now would be a
good time to talk a bit about some of the changes that are going into this
release.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#project-configuration" aria-label="project configuration permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Project configuration</h2>
<p>Since its very first release, merlin has been getting information about the
project being worked on through a <code>.merlin</code> file, which used to be written by
the user, but is now often generated by build systems.</p>
<p>This had the advantage of being fairly simple: Merlin would just look in the
current directory if such a file existed, otherwise it would look in the parent
directories until it found one; and then read it. But there were also some
sore points: the granularity of the configuration is the directory not the file,
and this information is duplicated from the build system configuration (be it
dune, Makefiles, or, back in the days, ocamlbuild).</p>
<p>After years of thinking about it, we've finally decided to make some light
changes to this process. Since version 3.4, when it scans the filesystem Merlin
is now looking for either a <code>.merlin</code> file or a dune (or dune-project) file. And
when it finds one of those, it starts an external process in the directory where
that file lives, and asks that process for the configuration of the ml(i) file
being edited.</p>
<p>The process in charge of communicating the configuration to Merlin will either
be a specific dune subcommand (when a dune file is found), or a dedicated
<code>.merlin</code> reader program.</p>
<p>We see several advantages in doing things this way (rather than, for instance,
changing the format of <code>.merlin</code> files):</p>
<ol>
<li>this change is entirely backward compatible, and indeed the transition has
already happened silently; although dune is still emitting <code>.merlin</code> files,
this will only stop with dune 2.8.</li>
<li>externalizing the reading of <code>.merlin</code> files and simply requiring a
&quot;normalized&quot; version of the config (i.e. with no mention of packages, just of
flags and paths) allowed us to simplify the internals of Merlin.</li>
<li>talking to the build system directly not only gets us a much finer grained
configuration (which is important when you build different executables with
different flags in the same directory, or if you apply different ppxes to
different files of a library), it opens the door to getting a nicer behavior
of Merlin in some circumstances. For instance, the build system can (and
does) tell Merlin when the project isn't built. Currently we only report that
information to the user when he asks for errors, alongside all the other
(mostly rubbish) errors. Which is already helpful in itself. But in the
future we can start filtering the other errors to only report those that
would remain even after building the project (e.g. parse errors).</li>
</ol>
<p>There are however some changes to look out for:</p>
<ul>
<li>people who still use <code>.merlin</code> files but do not install Merlin using opam need
to make sure to also have the <code>dot-merlin-reader</code> binary in their PATH (it is
available as an opam package, but is also buildable from Merlin's git
repository)</li>
<li>vim and emacs users who could previously load packages interactively (by
calling <code>M-x merlin-use</code> or <code>:MerlinUse</code>) cannot do that anymore, since Merlin
itself stopped linking with findlib. They'll have to write a <code>.merlin</code> file.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#dropping-support-for-old-versions-of-ocaml" aria-label="dropping support for old versions of ocaml permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dropping support for old versions of OCaml</h2>
<p>Until now, every release of Merlin has kept support from OCaml 4.02 to the
latest version of OCaml available at the time of that release.</p>
<p>We have done this by having one version of &quot;<em>the frontend</em>&quot; (i.e. handling of
buffer state, project configuration; analyses like <em>jump-to-definition</em>,
<em>prefix-completion</em>, etc.), but several versions of &quot;<em>the backend</em>&quot; (OCaml's
ASTs, parser and typechecker), and choosing at build time which one to use.
The reason for doing this instead of having, for instance, one branch of Merlin
per version of OCaml, is that while the backends are fairly stable once
released, Merlin's frontend keeps evolving. Having just one version of it makes
it easier to add features and fix bugs (patches don't need to be duplicated),
whilst ensuring that Merlin's behavior is consistent across every version of
OCaml that we support.</p>
<p>For this to work however, one needs a well defined API between the frontend and
all the versions of the backend. This implies mapping every versions of OCaml's
internal ASTs (which receive modifications from one version to the next), to a
unified one, so as to keep Merlin's various features version agnostic. But it
also means being resilient to OCaml's internal API changes. For instance between
4.02 and 4.11 there were big refactorings impacting: the way one accesses the
typing environment, the way one accesses the &quot;load path&quot; (the part of the file
system the compiler/Merlin is aware of), the way error message are produced, ...</p>
<p>The rate of changes on the compiler is a lot higher than what it was when we
first started Merlin (7 years ago now!) which doesn't just mean that we have to
spend more and more time on updating the common interface, but also that the
interface is getting harder to define. Recently (with the 4.11 release) some of
the changes were significant enough that for some parts of the backend we just
didn't manage to produce a single interface to access old and new versions, so
instead we had to start duplicating and specializing parts of the frontend.
And we don't expect things to get much better in the near future.</p>
<p>Furthermore, Merlin's backends are patched to be more resilient to parsing and
typing errors in the user's code. Those patches also need to be evolved at each
new release of the compiler.
The work required to keep the &quot;unified interface&quot; working was taking time away
from updating our patches properly, and our support of user errors has slowly
been getting worse over the past few years, resulting in less precise type
information when asked, incomplete results when asking for auto-completion, etc.</p>
<p>Therefore we have decided to stop dragging older versions of OCaml along. We
plan to switch to a system where we have one branch of Merlin per version of
OCaml, and each opam release of Merlin will only be buildable with one version
of OCaml. We will keep maintaining all the relatively recent branches (that is:
4.02 definitely will not get fixes, but 4.06 is still in the clear). However,
all the new features will be developed against the latest version of OCaml and
cherry-picked to older branches if, and only if, there are no merge conflicts
and they work as expected without changes.</p>
<p>We hope that this will make it easier for us to update to new versions of OCaml
(actually, we already know it does, working on adding support for 4.12 was
easier than for any of the other recent versions), will allow us to clean up
Merlin's codebase (let's call that a work in progress), and will free some time
to work on new features.</p>
<p>You might wonder what all this changes for you, as a user, in practice. Well, it
depends:</p>
<ul>
<li>if you install Merlin from opam: nothing, or almost nothing. Everything that
you currently do with Merlin will keep working. In the future, perhaps some
new feature will appear that won't work on all versions. But that day hasn't
come yet.</li>
<li>if you install Merlin some other way (manually?): you can't just fetch master
and build it anymore. You have to pick the appropriate branch for your
version of OCaml.</li>
<li>if you're reusing Merlin's codebase as part of another project and (even
worse) have patches on it: come and talk to us if you haven't done so already!
We can try and integrate your patches, so that you only need to worry about
vendoring the right version(s) for your needs.</li>
</ul>
<hr/>
<p>Over the years, Merlin has received bugfixes and improvements from a long list of
people, but for the upcoming release Fr&eacute;d&eacute;ric and I are particularly grateful to
Rudi Grinberg, a long time and regular contributor who also maintains the OCaml
LSP project, as well as Ulysse G&eacute;rard, who joined our team a year ago now. They
are in particular the main authors of the work to improve the handling of
projects' configuration.</p>
<p>We hope you'll be as excited as us by all these changes!</p>|js}
  };
 
  { title = {js|The road ahead for MirageOS in 2021|js}
  ; slug = {js|the-road-ahead-for-mirageos-in-2021|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/NGI|js}
  ; date = {js|2021-01-25T12:45:54-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Introduction</h2>
<p>2020 was an intense year. I hope you're healthy and keep being healthy. I am privileged (as lots of software engineers and academics are) to be able to work from home during the pandemic. Let's not forget people in less privileged situations,  and let&rsquo;s try to give them as much practical, psychological and financial support as we can these days. And as much joy as possible to everyone around :)</p>
<p>I cancelled the autumn MirageOS retreat due to the pandemic. Instead I collected donations for our hosts in Marrakech - they were very happy to receive our financial support, since they had a difficult year, since their income is based on tourism. I hope that in autumn 2021 we'll have an on-site retreat again.</p>
<p>For 2021, we (at <a href="https://robur.coop">robur</a>) got a grant from the EU (via <a href="https://pointer.ngi.eu">NGI pointer</a>) for &quot;Deploying MirageOS&quot; (more details below), and another grant from <a href="https://ocaml-sf.org">OCaml software foundation</a> for securing the opam supply chain (using <a href="https://github.com/hannesm/conex">conex</a>). Some long-awaited releases for MirageOS libraries, namely a <a href="https://discuss.ocaml.org/t/ann-first-release-of-awa-ssh">ssh implementation</a> and a rewrite of our <a href="https://discuss.ocaml.org/t/ann-release-of-ocaml-git-v3-0-duff-encore-decompress-etc/">git implementation</a> have already been published.</p>
<p>With my MirageOS view, 2020 was a pretty successful year, where we managed to add more features, fixed lots of bugs, and paved the road ahead. I want to thank <a href="https://ocamllabs.io/">OCamlLabs</a> for funding work on MirageOS maintenance.</p>
<h2>Recap 2020</h2>
<p>Here is a very subjective random collection of accomplishments in 2020, where I was involved with some degree.</p>
<h3>NetHSM</h3>
<p><a href="https://www.nitrokey.com/products/nethsm">NetHSM</a> is a hardware security module in software. It is a product that uses MirageOS for security, and is based on the <a href="https://muen.sk">muen</a> separation kernel. We at <a href="https://robur.coop">robur</a> were heavily involved in this product. It already has been security audited by an external team. You can pre-order it from Nitrokey.</p>
<h3>TLS 1.3</h3>
<p>Dating back to 2016, at the <a href="https://www.ndss-symposium.org/ndss2016/tron-workshop-programme/">TRON</a> (TLS 1.3 Ready or NOt), we developed a first draft of a 1.3 implementation of <a href="https://github.com/mirleft/ocaml-tls">OCaml-TLS</a>. Finally in May 2020 we got our act together, including ECC (ECDH P256 from <a href="https://github.com/mit-plv/fiat-crypto/">fiat-crypto</a>, X25519 from <a href="https://project-everest.github.io/">hacl</a>) and testing with <a href="https://github.com/tlsfuzzer/tlsfuzzer">tlsfuzzer</a>, and release tls 0.12.0 with TLS 1.3 support. Later we added <a href="https://github.com/mirleft/ocaml-tls/pull/414">ECC ciphersuites to TLS version 1.2</a>, implemented <a href="https://github.com/mirleft/ocaml-tls/pull/414">ChaCha20/Poly1305</a>, and fixed an <a href="https://github.com/mirleft/ocaml-tls/pull/424">interoperability issue with Go's implementation</a>.</p>
<p><a href="https://github.com/mirage/mirage-crypto">Mirage-crypto</a> provides the underlying cryptographic primitives, initially released in March 2020 as a fork of <a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> -- huge thanks to <a href="https://github.com/pqwy">pqwy</a> for his great work. Mirage-crypto detects <a href="https://github.com/mirage/mirage-crypto/pull/53">CPU features at runtime</a> (thanks to <a href="https://github.com/Julow">Julow</a>) (<a href="https://github.com/mirage/mirage-crypto/pull/96">bugfix for bswap</a>), using constant time modular exponentation (powm_sec) and hardens against Lenstra's CRT attack, supports <a href="https://github.com/mirage/mirage-crypto/pull/39">compilation on Windows</a> (thanks to <a href="https://github.com/avsm">avsm</a>), <a href="https://github.com/mirage/mirage-crypto/pull/90">async entropy harvesting</a> (thanks to <a href="https://github.com/seliopou">seliopou</a>), <a href="https://github.com/mirage/mirage-crypto/pull/65">32 bit support</a>, <a href="https://github.com/mirage/mirage-crypto/pull/72">chacha20/poly1305</a> (thanks to <a href="https://github.com/abeaumont">abeaumont</a>), <a href="https://github.com/mirage/mirage-crypto/pull/84">cross-compilation</a> (thanks to <a href="https://github.com/EduardoRFS">EduardoRFS</a>) and <a href="https://github.com/mirage/mirage-crypto/pull/78">various</a> <a href="https://github.com/mirage/mirage-crypto/pull/81">bug</a> <a href="https://github.com/mirage/mirage-crypto/pull/83">fixes</a>, even <a href="https://github.com/mirage/mirage-crypto/pull/95">memory leak</a> (thanks to <a href="https://github.com/talex5">talex5</a> for reporting several of these issues), and <a href="https://github.com/mirage/mirage-crypto/pull/99">RSA</a> <a href="https://github.com/mirage/mirage-crypto/pull/100">interoperability</a> (thanks to <a href="https://github.com/psafont">psafont</a> for investigation and <a href="https://github.com/mattjbray">mattjbray</a> for reporting). This library feels very mature now - being used by multiple stakeholders, and lots of issues have been fixed in 2020.</p>
<h3>Qubes Firewall</h3>
<p>The <a href="https://github.com/mirage/qubes-mirage-firewall/">MirageOS based Qubes firewall</a> is the most widely used MirageOS unikernel. And it got major updates: in May <a href="https://github.com/linse">Steffi</a> <a href="https://groups.google.com/g/qubes-users/c/Xzplmkjwa5Y">announced</a> her and <a href="https://github.com/yomimono">Mindy's</a> work on improving it for Qubes 4.0 - including <a href="https://www.qubes-os.org/doc/vm-interface/#firewall-rules-in-4x">dynamic firewall rules via QubesDB</a>. Thanks to <a href="https://prototypefund.de/project/portable-firewall-fuer-qubesos/">prototypefund</a> for sponsoring.</p>
<p>In October 2020, we released <a href="https://mirage.io/blog/announcing-mirage-39-release">Mirage 3.9</a> with PVH virtualization mode (thanks to <a href="https://github.com/mato">mato</a>). There's still a <a href="https://github.com/mirage/qubes-mirage-firewall/issues/120">memory leak</a> to be investigated and fixed.</p>
<h3>IPv6</h3>
<p>In December, with <a href="https://mirage.io/blog/announcing-mirage-310-release">Mirage 3.10</a> we got the IPv6 code up and running. Now MirageOS unikernels have a dual stack available, besides IPv4-only and IPv6-only network stacks. Thanks to <a href="https://github.com/nojb">nojb</a> for the initial code and <a href="https://github.com/MagnusS">MagnusS</a>.</p>
<p>Turns out this blog, but also robur services, are now available via IPv6 :)</p>
<h3>Albatross</h3>
<p>Also in December, I pushed an initial release of <a href="https://github.com/roburio/albatross">albatross</a>, a unikernel orchestration system with remote access. <em>Deploy your unikernel via a TLS handshake -- the unikernel image is embedded in the TLS client certificates.</em></p>
<p>Thanks to <a href="https://github.com/reynir">reynir</a> for statistics support on Linux and improvements of the systemd service scripts. Also thanks to <a href="https://github.com/cfcs">cfcs</a> for the initial Linux port.</p>
<h3>CA certs</h3>
<p>For several years I postponed the problem of how to actually use the operating system trust anchors for OCaml-TLS connections. Thanks to <a href="https://github.com/emillon">emillon</a> for initial code, there are now <a href="https://github.com/mirage/ca-certs">ca-certs</a> and <a href="https://github.com/mirage/ca-certs-nss">ca-certs-nss</a> opam packages (see <a href="https://discuss.ocaml.org/t/ann-ca-certs-and-ca-certs-nss">release announcement</a>) which fills this gap.</p>
<h2>Unikernels</h2>
<p>I developed several useful unikernels in 2020, and also pushed <a href="https://mirage.io/wiki/gallery">a unikernel gallery</a> to the Mirage website:</p>
<h3>Traceroute in MirageOS</h3>
<p>I already wrote about <a href="https://hannes.robur.coop/Posts/Traceroute">traceroute</a> which traces the routing to a given remote host.</p>
<h3>Unipi - static website hosting</h3>
<p><a href="https://github.com/roburio/unipi">Unipi</a> is a static site webserver which retrieves the content from a remote git repository. Let's encrypt certificate provisioning and dynamic updates via a webhook to be executed for every push.</p>
<h4>TLSTunnel - TLS demultiplexing</h4>
<p>The physical machine this blog and other robur infrastructure runs on has been relocated from Sweden to Germany mid-December. Thanks to UPS! Fewer IPv4 addresses are available in the new data center, which motivated me to develop <a href="https://github.com/roburio/tlstunnel">tlstunnel</a>.</p>
<p>The new behaviour is as follows (see the <code>monitoring</code> branch):</p>
<ul>
<li>listener on TCP port 80 which replies with a permanent redirect to <code>https</code>
</li>
<li>listener on TCP port 443 which forwards to a backend host if the requested server name is configured
</li>
<li>its configuration is stored on a block device, and can be dynamically changed (with a custom protocol authenticated with a HMAC)
</li>
<li>it is setup to hold a wildcard TLS certificate and in DNS a wildcard entry is pointing to it
</li>
<li>setting up a new service is very straightforward: only the new name needs to be registered with tlstunnel together with the TCP backend, and everything will just work
</li>
</ul>
<h2>2021</h2>
<p>The year started with a release of <a href="https://discuss.ocaml.org/t/ann-first-release-of-awa-ssh">awa</a>, a SSH implementation in OCaml (thanks to <a href="https://github.com/haesbaert">haesbaert</a> for initial code). This was followed by a <a href="https://discuss.ocaml.org/t/ann-release-of-ocaml-git-v3-0-duff-encore-decompress-etc/">git 3.0 release</a> (thanks to <a href="https://github.com/dinosaure">dinosaure</a>).</p>
<h3>Deploying MirageOS - NGI Pointer</h3>
<p>For 2021 we at robur received funding from the EU (via <a href="https://pointer.ngi.eu/">NGI pointer</a>) for &quot;Deploying MirageOS&quot;, which boils down into three parts:</p>
<ul>
<li>reproducible binary releases of MirageOS unikernels,
</li>
<li>monitoring (and other devops features: profiling) and integration into existing infrastructure,
</li>
<li>and further documentation and advertisement.
</li>
</ul>
<p>Of course this will all be available open source. Please get in touch via eMail (team aT robur dot coop) if you're eager to integrate MirageOS unikernels into your infrastructure.</p>
<p>We discovered at an initial meeting with an infrastructure provider that a DNS resolver is of interest - even more now that dnsmasq suffered from <a href="https://www.jsof-tech.com/wp-content/uploads/2021/01/DNSpooq_Technical-Whitepaper.pdf">dnspooq</a>. We are already working on an <a href="https://github.com/mirage/ocaml-dns/pull/251">implementation of DNSSec</a>.</p>
<p>MirageOS unikernels are binary reproducible, and <a href="https://github.com/rjbou/orb/pull/1">infrastructure tools are available</a>. We are working hard on a web interface (and REST API - think of it as &quot;Docker Hub for MirageOS unikernels&quot;), and more tooling to verify reproducibility.</p>
<h3>Conex - securing the supply chain</h3>
<p>Another funding from the <a href="http://ocaml-sf.org/">OCSF</a> is to continue development and deploy <a href="https://github.com/hannesm/conex">conex</a> - to bring trust into opam-repository. This is a great combination with the reproducible build efforts, and will bring much more trust into retrieving OCaml packages and using MirageOS unikernels.</p>
<h3>MirageOS 4.0</h3>
<p>Mirage so far still uses ocamlbuild and ocamlfind for compiling the virtual machine binary. But the switch to dune is <a href="https://github.com/mirage/mirage/issues/1195">close</a>, a lot of effort has been done. This will make the developer experience of MirageOS much more smooth, with a per-unikernel monorepo workflow where you can push your changes to the individual libraries.</p>
<h2>Footer</h2>
<p>If you want to support our work on MirageOS unikernels, please <a href="https://robur.coop/Donate">donate to robur</a>. I'm interested in feedback, either via <a href="https://twitter.com/h4nnes">twitter</a>, <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|Tarides sponsors the Oxbridge Women in Computer Science Conference 2020|js}
  ; slug = {js|tarides-sponsors-the-oxbridge-women-in-computer-science-conference-2020|js}
  ; description = Some {js|The Oxbridge Women in Computer Science
conference is an annual one-day
event hosted by the Universities of Oxford and Cambridge (UK). The…|js}
  ; url = {js|https://tarides.com/blog/2020-12-14-tarides-sponsors-the-oxbridge-women-in-computer-science-conference-2020|js}
  ; date = {js|2020-12-14T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/683df7e1cdbf16d2cc6e889c9f3c39a5/7d5a2/laptop_overhead.jpg|js}
  ; featured = false
  ; body_html = {js|<p>The <a href="https://oxbridgewomenincs8.wixsite.com/2020">Oxbridge Women in Computer Science
conference</a> is an annual one-day
event hosted by the Universities of Oxford and Cambridge (UK). The
conference is free and open to everyone from any discipline, regardless of
gender identity. Its purpose is to spotlight the successes of women within
computer science and strengthen the network of women in computer science
within a supportive and friendly environment.</p>
<p>This year, the conference was organised by the University of Cambridge and was
held virtually on December 7th.</p>
<p>Tarides is very glad to sponsor this event as we strongly believe that diversity
and inclusive culture is a key factor in building a competitive and innovative
company. Our employees come from 8 different countries and are 1&frasl;3 women.
Tarides promotes transparency, openness and autonomy, creating a work atmosphere
auspicious for employees to strive in their work, to solve novel, impactful and
technical challenges. By working on open-source projects, a collaboration is
possible with worldwide experts from both academia and industry, encouraging
continuous training and education; in this context, it is very important to have
teams with diverse backgrounds and experience.</p>
<p>The underrepresentation of women in tech, and particularly in computer science,
is not a new problem and gender equality remains a major issue in the corporate
world. By celebrating female computer scientists, as during the Oxbridge Women
in Computer Science Conference, it will hopefully encourage more women to pursue
their interests and careers in the tech field. Head
<a href="https://tarides.com/company/">here</a> to see our currently-open positions.</p>
<p>For the event, we made a short video to experience a day in the life of a
software engineer:</p>
<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%">
  <iframe style="position: absolute; width: 100%; height: 100%; left: 0; right: 0" src="https://www.youtube-nocookie.com/embed/5qK8elKNxKI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe>
</div>|js}
  };
 
  { title = {js|Growing the Hardcaml toolset|js}
  ; slug = {js|growing-the-hardcaml-toolset|js}
  ; description = Some {js|I am pleased to announce that we have recently released a slew of newHardcaml libraries!|js}
  ; url = {js|https://blog.janestreet.com/growing-the-hardcaml-toolset-index/|js}
  ; date = {js|2020-12-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/growing-the-hardcaml-toolset-index/Hardcaml_blog_image_scaled.png|js}
  ; featured = false
  ; body_html = {js|<p>I am pleased to announce that we have recently released a slew of new
Hardcaml libraries!</p>|js}
  };
 
  { title = {js|Announcing Our Market Prediction Kaggle Competition|js}
  ; slug = {js|announcing-our-market-prediction-kaggle-competition|js}
  ; description = Some {js|Jane Street is running a Kaggle contest based on a real problem withreal financial data. If you like ML projects, or think you might,head over and check itou...|js}
  ; url = {js|https://blog.janestreet.com/announcing-our-market-prediction-kaggle-competition-index/|js}
  ; date = {js|2020-11-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/announcing-our-market-prediction-kaggle-competition-index/kaggle_blogpost.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street is running a Kaggle contest based on a real problem with
real financial data. If you like ML projects, or think you might,
<a href="https://www.kaggle.com/c/jane-street-market-prediction" target="_blank">head over and check it
out</a>.
We think it&rsquo;s a pretty fun one. The prizes are pretty good too, with a
total $100K being paid out.</p>|js}
  };
 
  { title = {js|Finding memory leaks with Memtrace|js}
  ; slug = {js|finding-memory-leaks-with-memtrace|js}
  ; description = Some {js|Memory issues can be hard to track down. A function that onlyallocates a few small objects can cause a space leak if it’s calledoften enough and those object...|js}
  ; url = {js|https://blog.janestreet.com/finding-memory-leaks-with-memtrace/|js}
  ; date = {js|2020-10-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/finding-memory-leaks-with-memtrace/memory-leak.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Memory issues can be hard to track down. A function that only
allocates a few small objects can cause a space leak if it&rsquo;s called
often enough and those objects are never collected. Even then, many
objects are <em>supposed</em> to be long-lived. How can a tool, armed with data
on allocations and their lifetimes,
help sort out the expected from the suspicious?</p>|js}
  };
 
  { title = {js|Building portable user interfaces with Nottui and Lwd|js}
  ; slug = {js|building-portable-user-interfaces-with-nottui-and-lwd|js}
  ; description = Some {js|At Tarides, we build many tools and writing UI is usually a tedious task. In this post we will see how to write functional UIs in OCaml…|js}
  ; url = {js|https://tarides.com/blog/2020-09-24-building-portable-user-interfaces-with-nottui-and-lwd|js}
  ; date = {js|2020-09-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/06fbdcdb40efa879b814b744c5ea3fbf/fcfee/nottui-rain.png|js}
  ; featured = false
  ; body_html = {js|<p>At Tarides, we build many tools and writing UI is usually a tedious task. In this post we will see how to write functional UIs in OCaml using the <code>Nottui</code> &amp; <code>Lwd</code> libraries.</p>
<p>These libraries were developed for <a href="https://github.com/ocurrent/citty">Citty</a>, a frontend to the <a href="https://github.com/ocurrent/ocaml-ci">Continuous Integration service</a> of OCaml Labs.</p>
<div>
  <video controls="controls" width="100%">
    <source src="./nottui-citty.mp4" type="video/mp4"></source>
    <source src="./nottui-citty.webm" type="video/webm;codecs=vp9"></source>
  </video>
</div>
<p>In this recording, you can see the lists of repositories, branches and jobs monitored by the CI service, as well as the result of job execution. Most of the logic is asynchronous, with all the contents being received from the network in a non-blocking way.</p>
<p><code>Nottui</code> extends <a href="https://github.com/pqwy/notty">Notty</a>, a library for declaring terminal images, to better suit the needs of UIs. <code>Lwd</code> (Lightweight Document) exposes a simple form of reactive computation (values that evolve over time). It can be thought of as an alternative to the DOM, suitable for building interactive documents.
They are used in tandem: <code>Nottui</code> for rendering the UI and <code>Lwd</code> for making it interactive.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#nottui--notty-with-layout-and-events" aria-label="nottui  notty with layout and events permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Nottui = Notty with layout and events</h2>
<p>Notty exposes a nice way to display images in a terminal. A Notty image is matrix of characters with optional styling attributes (tweaking foreground and background colors, using <strong>bold</strong> glyphs...).</p>
<p>These images are pure values and can be composed (concatenated, cropped, ...) very efficiently, making them very convenient to manipulate in a functional way.</p>
<p>However these images are inert: their contents are fixed and their only purpose is to be displayed. Nottui reuses Notty images and exposes essentially the same interface but it adds two features: layout &amp; event dispatch. UI elements now adapt to the space available and can react to keyboard and mouse actions.</p>
<p><strong>Layout DSL</strong>. Specifying a layout is done using &quot;stretchable&quot; dimensions, a concept loosely borrowed from TeX. Each UI element has a fixed size (expressed as a number of columns and rows) and a stretchable size (possibly empty). The stretchable part is interpreted as a strength that is used to determine how to share the space available among all UI elements.</p>
<p>This is a simple system amenable to an efficient implementation while being powerful enough to express common layout patterns.</p>
<p><strong>Event dispatch</strong>. Reacting to mouse and keyboard events is better done using local behaviors, specific to an element. In Nottui, images are augmented with handlers for common actions. There is also a global notion of focus to determine which element should consume input events.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#interactivity-with-lwd" aria-label="interactivity with lwd permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interactivity with Lwd</h2>
<p>Nottui's additions are nice for resizing and attaching behaviors to images, but they are still static objects. In practice, user interfaces are very dynamic: parts can be independently updated to display new information.</p>
<p>This interactivity layer is brought by Lwd and is developed separately from the core UI library. It is built around a central type, <code>'a Lwd.t</code>, that represents a value of type <code>'a</code> that can change over time.</p>
<p><code>Lwd.t</code> is an <a href="https://en.wikipedia.org/wiki/Applicative_functor">applicative functor</a> (and even a monad), making it a highly composable abstraction.</p>
<p>Primitive changes are introduced by <code>Lwd.var</code>, which are OCaml references with an extra operation <code>val get : 'a Lwd.var -&gt; 'a Lwd.t</code>. This operation turns a variable into a <em>changing value</em> that changes whenever the variable is set.</p>
<p>In practice this leads to a mostly declarative style of programming interactive documents (as opposed to the DOM that is deeply mutable). Most of the code is just function applications without spooky action at a distance! However, it is possible to opt-out of this pure style by introducing an <code>Lwd.var</code>, on a case-by-case basis.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#and-much-more" aria-label="and much more permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>And much more...</h2>
<p>A few extra libraries are provided to target more specific problems.</p>
<p><code>Lwd_table</code> and <code>Lwd_seq</code> are two datastructures to manipulate dynamic collections. <code>Nottui_pretty</code> is an interactive pretty printing library that supports arbitrary Nottui layouts and widgets. Finally <code>Tyxml_lwd</code> is a strongly-typed abstraction of the DOM driven by Lwd.</p>
<p>Version 0.1 has just been released on OPAM.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#getting-started" aria-label="getting started permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting started!</h2>
<p>Here is a small example to start using the library. First, install the Nottui library:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ opam install nottui</code></pre></div>
<p>Now we can play in the top-level. We will start with a simple button that counts the number of clicks:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token operator">$</span> utop
# <span class="token directive important">#require</span> <span class="token string">&quot;nottui&quot;</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
# <span class="token keyword">open</span> <span class="token module variable">Nottui</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
# <span class="token keyword">module</span> W <span class="token operator">=</span> <span class="token module variable">Nottui_widgets</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* State for holding the number of clicks *)</span>
# <span class="token keyword">let</span> vcount <span class="token operator">=</span> <span class="token module variable">Lwd</span><span class="token punctuation">.</span>var <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* Image of the button parametrized by the number of clicks *)</span>
# <span class="token keyword">let</span> button count <span class="token operator">=</span>
    W<span class="token punctuation">.</span>button <span class="token label function">~attr</span><span class="token punctuation">:</span><span class="token module variable">Notty</span><span class="token punctuation">.</span>A<span class="token punctuation">.</span><span class="token punctuation">(</span>bg green <span class="token operator">++</span> fg black<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token module variable">Printf</span><span class="token punctuation">.</span>sprintf <span class="token string">&quot;Clicked %d times!&quot;</span> count<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token module variable">Lwd</span><span class="token punctuation">.</span>set vcount <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* Run the UI! *)</span>
# <span class="token module variable">Ui_loop</span><span class="token punctuation">.</span>run <span class="token punctuation">(</span><span class="token module variable">Lwd</span><span class="token punctuation">.</span>map button <span class="token punctuation">(</span><span class="token module variable">Lwd</span><span class="token punctuation">.</span>get vcount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre></div>
<p><strong>Note:</strong> to quit the example, you can press Ctrl-Q or Esc.</p>
<p>We will improve the example and turn it into a mini cookie clicker game.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* Achievements to unlock in the cookie clicker *)</span>
# <span class="token keyword">let</span> badges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">&quot;Cursor&quot;</span><span class="token punctuation">;</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string">&quot;Grandma&quot;</span><span class="token punctuation">;</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string">&quot;Farm&quot;</span><span class="token punctuation">;</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">&quot;Mine&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* List the achievements unlocked by the player *)</span>
# <span class="token keyword">let</span> unlocked_ui count <span class="token operator">=</span>
    <span class="token comment">(* Filter the achievements *)</span>
    <span class="token keyword">let</span> predicate <span class="token punctuation">(</span>target<span class="token punctuation">,</span> text<span class="token punctuation">)</span> <span class="token operator">=</span>
      <span class="token keyword">if</span> count <span class="token operator">&gt;=</span> target
      <span class="token keyword">then</span> <span class="token module variable">Some</span> <span class="token punctuation">(</span>W<span class="token punctuation">.</span>printf <span class="token string">&quot;% 4d: %s&quot;</span> target text<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token module variable">None</span>
    <span class="token keyword">in</span>
    <span class="token comment">(* Concatenate the UI elements vertically *)</span>
    <span class="token module variable">Ui</span><span class="token punctuation">.</span>vcat <span class="token punctuation">(</span><span class="token module variable">List</span><span class="token punctuation">.</span>filter_map predicate badges<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* Display the next achievement to reach *)</span>
# <span class="token keyword">let</span> next_ui count <span class="token operator">=</span>
    <span class="token keyword">let</span> predicate <span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> target <span class="token operator">&gt;</span> ciybt <span class="token keyword">in</span>
    <span class="token keyword">match</span> <span class="token module variable">List</span><span class="token punctuation">.</span>find_opt predicate badges <span class="token keyword">with</span>
    <span class="token operator">|</span> <span class="token module variable">Some</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">_</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
      W<span class="token punctuation">.</span>printf <span class="token label function">~attr</span><span class="token punctuation">:</span><span class="token module variable">Notty</span><span class="token punctuation">.</span>A<span class="token punctuation">.</span><span class="token punctuation">(</span>st bold<span class="token punctuation">)</span> <span class="token string">&quot;% 4d: ???&quot;</span> target
    <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">Ui</span><span class="token punctuation">.</span>empty<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* Let's make use of the fancy let-operators recently added to OCaml *)</span>
# <span class="token keyword">open</span> <span class="token module variable">Lwd_infix</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
# <span class="token keyword">let</span> ui <span class="token operator">=</span>
    <span class="token keyword">let</span><span class="token operator">$</span> count <span class="token operator">=</span> <span class="token module variable">Lwd</span><span class="token punctuation">.</span>get vcount <span class="token keyword">in</span>
    <span class="token module variable">Ui</span><span class="token punctuation">.</span>vcat <span class="token punctuation">[</span>button count<span class="token punctuation">;</span> unlocked_ui count<span class="token punctuation">;</span> next_ui count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token comment">(* Launch the game! *)</span>
# <span class="token module variable">Ui_loop</span><span class="token punctuation">.</span>run ui<span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre></div>
<div>
  <video controls="controls">
    <source src="./nottui-cookie-clicker.mp4" type="video/mp4"></source>
    <source src="./nottui-cookie-clicker.webm" type="video/webm;codecs=vp9"></source>
  </video>
</div>
<p>Et voil&agrave;! We hope you enjoy experimenting with <code>Nottui</code> and <code>Lwd</code>. Check out the <a href="https://github.com/let-def/lwd/tree/master/lib/nottui">Nottui page</a> for more examples, and watch our recent presentation of these libraries at the 2020 ML Workshop here:</p>
<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%">
  <iframe style="position: absolute; width: 100%; height: 100%; left: 0; right: 0" src="https://www.youtube-nocookie.com/embed/w7jc35kgBZE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen">
  </iframe>
</div>|js}
  };
 
  { title = {js|Tarides is now a sponsor of the OCaml Software Foundation|js}
  ; slug = {js|tarides-is-now-a-sponsor-of-the-ocaml-software-foundation|js}
  ; description = Some {js|Tarides is pleased to provide support for the OCaml Software
Foundation, a non-profit foundation hosted by
the Inria Foundation. The OCaml…|js}
  ; url = {js|https://tarides.com/blog/2020-09-17-tarides-is-now-a-sponsor-of-the-ocaml-software-foundation|js}
  ; date = {js|2020-09-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/305bd3e2ab2e164e61b7781d183976fd/0d665/ocaml-software-foundation.png|js}
  ; featured = false
  ; body_html = {js|<p>Tarides is pleased to provide support for the <a href="https://ocaml-sf.org">OCaml Software
Foundation</a>, a non-profit foundation hosted by
the Inria Foundation. The OCaml Software Foundation's mission is to
promote the OCaml programming language and its ecosystem by
supporting the growth of a diverse and international community of
OCaml users.</p>
<p>Tarides develops secure-by-design solutions in which OCaml's memory and
type-safety guarantees play a major role. Hence, most of the software
development that is done at Tarides is in OCaml: for instance,
<a href="https://mirage.io">MirageOS</a>, a library operating system that
constructs unikernels for secure, high-performance network
applications; and <a href="https://irmin.org">Irmin</a>, a library for building
mergeable, branchable distributed data stores, with built-in
snapshotting and support for a wide variety of storage backends.</p>
<p>Tarides is also very involved in the OCaml compiler development and
OCaml developer tooling ecosystem: as active maintainers of the <a href="https://www.youtube.com/watch?v=E8T_4zqWmq8&amp;list=PLKO_ZowsIOu5fHjRj0ua7_QWE_L789K_f&amp;ab_channel=ocaml2020">OCaml
platform</a>, Tarides is involved with most of the major
OCaml developer tools, including <a href="https://github.com/ocaml/ocaml">opam</a>, <a href="https://github.com/ocaml/dune">dune</a> and <a href="https://github.com/ocaml/merlin">merlin</a>.</p>|js}
  };
 
  { title = {js|Memory allocator showdown|js}
  ; slug = {js|memory-allocator-showdown|js}
  ; description = Some {js|Since version 4.10, OCaml offers a new best-fit memory allocatoralongside its existing default, the next-fit allocator. At JaneStreet, we’ve seen a big impro...|js}
  ; url = {js|https://blog.janestreet.com/memory-allocator-showdown/|js}
  ; date = {js|2020-09-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/memory-allocator-showdown/MemoryAllocator.jpg|js}
  ; featured = false
  ; body_html = {js|Since version 4.10, OCaml offers a new best-fit memory allocator
alongside its existing default, the next-fit allocator. At Jane
Street, we've seen a big improvement after switching over to the new
allocator.

This post isn't about how the new allocator works. For that, the best
source is these notes from a talk by its
author.  Instead, this post is about just how tricky it is to compare two
allocators in a reasonable way, especially for a garbage-collected
system.|js}
  };
 
  { title = {js|Irmin: September 2020 update|js}
  ; slug = {js|irmin-september-2020-update|js}
  ; description = Some {js|This post will survey the latest design decisions and performance improvements
made to irmin-pack, the Irmin storage backend used by
Tezos…|js}
  ; url = {js|https://tarides.com/blog/2020-09-08-irmin-september-2020-update|js}
  ; date = {js|2020-09-08T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/eb48bbf490e4011a9fa8806a56d4098b/0132d/tree_autumn.jpg|js}
  ; featured = false
  ; body_html = {js|<p>This post will survey the latest design decisions and performance improvements
made to <code>irmin-pack</code>, the <a href="https://irmin.org/">Irmin</a> storage backend used by
<a href="https://tezos.gitlab.io/">Tezos</a>. Tezos is an open-source blockchain technology,
written in OCaml, which uses many libraries from the MirageOS ecosystem. For
more context on the design of <code>irmin-pack</code> and how it is optimised for the Tezos
use-case, you can check out our <a href="https://tarides.com/blog/2020-09-01-introducing-irmin-pack">previous blog post</a>.</p>
<p>This post showcases the improvements to <code>irmin-pack</code> since its initial
deployment on Tezos:</p>
<ol>
<li><a href="https://tarides.com/feed.xml#faster-read-only-store-instances">Faster read-only store instances</a></li>
<li><a href="https://tarides.com/feed.xml#better-flushing-for-the-read-write-instance">Improved automatic flushing</a></li>
<li><a href="https://tarides.com/feed.xml#faster-serialisation-for-irmintype">Staging generic serialisation operations</a></li>
<li><a href="https://tarides.com/feed.xml#more-control-over-indexmerge">More control over <code>Index.merge</code></a></li>
<li><a href="https://tarides.com/feed.xml#clearing-stores">Clearing stores</a></li>
</ol>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#faster-read-only-store-instances" aria-label="faster read only store instances permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Faster read-only store instances</h2>
<p>The Tezos use-case of Irmin requires both <em>read-only</em> and <em>read-write</em>
store handles, with multiple readers and a single writer all accessing the same
Irmin store concurrently. These store handles are held by different processes
(with disjoint memory spaces) so the instances must use files on disk to
synchronise, ensuring that the readers never miss updates from the writer. The
writer instance automatically flushes its internal buffers to disk at regular
intervals, allowing the readers to regularly pick up <code>replace</code> calls.</p>
<p>Until recently, each time a reader looked for a value &ndash; be it a commit, a node,
or a blob &ndash; it first checked if the writer had flushed new contents to disk. This
ensured that the readers always see the latest changes from the writer. However,
if the writer isn't actively modifying the regions being read, the readers make
one unnecessary system call per <code>find</code>. The higher the rate of reads, the more
time is lost to these synchronisation points. This is particularly problematic
in two use-cases:</p>
<ul>
<li>
<p><strong>Taking snapshots of the store</strong>. Tezos supports <a href="https://tezos.gitlab.io/user/snapshots.html">exporting portable
snapshots</a> of the store data. Since this operation only reads
<em>historic</em> data in the store (traversing backwards from a given block hash),
it's never necessary to synchronise with the writer.</p>
</li>
<li>
<p><strong>Bulk writes</strong>. It's sometimes necessary for the writer to dump lots of new
data to disk at once (for instance, when adding a commit to the history). In
these cases, any readers will repeatedly synchronise with the disk even though
they don't need to do so until the bulk operation is complete. More on this in
the coming months!</p>
</li>
</ul>
<p>To better support these use-cases, we dropped the requirement for readers to
maintain strict consistency with the writer instance. Instead, readers can call
an explicit <code>sync</code> function only when they <em>need</em> to see the latest concurrent
updates from the writer instance.</p>
<p>In our benchmarks, there is a clear speed-up for <code>find</code> operations from readers:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[RO] Find in random order with implicit syncs
        Total time: 67.276527
        Operations per second: 148640.253086
        Mbytes per second: 6.378948
        Read amplification in syscalls: 3.919739
        Read amplification in bytes: 63.943734

[RO] Find in random order with only one call to sync
        Total time: 40.817458
        Operations per second: 244993.208543
        Mbytes per second: 10.513968
        Read amplification in syscalls: 0.919588
        Read amplification in bytes: 63.258072</code></pre></div>
<p>Not only it is faster, we can see also that fewer system calls are used in the
<code>Read amplification in syscalls</code> column. The benchmarks consists of reading
10,000,000 entries of 45 bytes each.</p>
<p>Relevant PRs: <a href="https://github.com/mirage/irmin/pull/1008">irmin #1008</a>,
<a href="https://github.com/mirage/index/pull/175">index #175</a>,
<a href="https://github.com/mirage/index/pull/198">index #198</a> and
<a href="https://github.com/mirage/index/pull/203">index #203</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#better-flushing-for-the-read-write-instance" aria-label="better flushing for the read write instance permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Better flushing for the read-write instance</h2>
<p>Irmin-pack uses an <a href="https://github.com/mirage/index/">index</a> to speed up <code>find</code>
calls: a <code>pack</code> file is used to store pairs of <code>(key, value)</code> and an <code>index</code>
records the address in pack where a <code>key</code> is stored. A read-write instance has
to write both the <code>index</code> and the <code>pack</code> file, for a read-only instance to find
a value. Moreover, the order in which the data is flushed to disk for the two
files is important: the address for the pair <code>(key, value)</code> cannot be written
before the pair itself. Otherwise the read-only instance can read an address for
a non existing <code>(key, value)</code> pair. But both <code>pack</code> and <code>index</code> have internal
buffers that accumulate data, in order to reduce the number of system calls, and
both decide arbitrarily when to flush those buffers to disk.</p>
<p>We introduce a <code>flush_callback</code> argument in <code>index</code>, which registers a callback
for whenever the index decides to flush. <code>irmin-pack</code> uses this callback to flush
its pack file, resolving the issue of the dangling address.</p>
<p>Relevant PRs: <a href="https://github.com/mirage/index/pull/189">index #189</a>,
<a href="https://github.com/mirage/index/pull/216">index #216</a>,
<a href="https://github.com/mirage/irmin/pull/1051">irmin #1051</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#faster-serialisation-for-irmintype" aria-label="faster serialisation for irmintype permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Faster serialisation for <code>Irmin.Type</code></h2>
<p>Irmin uses a library of <a href="http://ocamllabs.io/iocamljs/generic_programming.html"><em>generic</em></a> operations: functions
that take a runtime representation of a type and derive some operation on that
type. These are used in many places to automatically derive encoders and
decoders for our types, which are then used to move data to and from disk. For
instance:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> decode <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> t <span class="token operator">-&gt;</span> string <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span>
<span class="token comment">(** [decode t] is the binary decoder of values represented by [t]. *)</span>

<span class="token comment">(** Read an integer from a binary-encoded file. *)</span>
<span class="token keyword">let</span> int_of_file <span class="token label function">~path</span> <span class="token operator">=</span> open_in_bin path <span class="token operator">|&gt;</span> input_line <span class="token operator">|&gt;</span> decode <span class="token module variable">Irmin</span><span class="token punctuation">.</span><span class="token module variable">Type</span><span class="token punctuation">.</span>int32</code></pre></div>
<p>The generic <code>decode</code> takes a <em>representation</em> of the type <code>int32</code> and uses
this to select the right binary decoder. Unfortunately, we pay the cost of this
runtime specialisation <em>every time</em> we call <code>int_of_file</code>. If we're invoking
the decoder for a particular type very often &ndash; such as when serialising store
values &ndash; it's more efficient to specialise <code>decode</code> once:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(** Specialised binary decoder for integers. *)</span>
<span class="token keyword">let</span> decode_int32 <span class="token operator">=</span> decode <span class="token module variable">Irmin</span><span class="token punctuation">.</span><span class="token module variable">Type</span><span class="token punctuation">.</span>int32

<span class="token keyword">let</span> int_of_file_fast <span class="token label function">~path</span> <span class="token operator">=</span> open_in_bin path <span class="token operator">|&gt;</span> input_line <span class="token operator">|&gt;</span> decode_int32 contents</code></pre></div>
<p>The question then becomes: how can we change <code>decode</code> to encourage it to be
used in this more-efficient way? We can add a type wrapper &ndash; called <code>staged</code> &ndash;
to prevent the user from passing two arguments to <code>decode</code> at once:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> <span class="token module variable">Staged</span> <span class="token punctuation">:</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> <span class="token operator">+</span><span class="token type-variable function">'a</span> t
  <span class="token keyword">val</span>   stage <span class="token punctuation">:</span> <span class="token type-variable function">'a</span>   <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> t
  <span class="token keyword">val</span> unstage <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> t <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span>
<span class="token keyword">end</span>

<span class="token keyword">val</span> decode <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> t <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>string <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token module variable">Staged</span><span class="token punctuation">.</span>t
<span class="token comment">(** [decode t] needs to be explicitly unstaged before being used. *)</span></code></pre></div>
<p>By forcing the user to add a <code>Staged.unstage</code> type coercion when using this
function, we're encouraging them to hoist such operations out of their
hot-loops:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(** The slow implementation no longer type-checks: *)</span>

<span class="token keyword">let</span> int_of_file <span class="token label function">~path</span> <span class="token operator">=</span> open_in_bin path <span class="token operator">|&gt;</span> input_line <span class="token operator">|&gt;</span> decode <span class="token module variable">Irmin</span><span class="token punctuation">.</span><span class="token module variable">Type</span><span class="token punctuation">.</span>int32
<span class="token comment">(* Error: This expression has type (string -&gt; 'a) Staged.t
 *        but an expression was expected of type string -&gt; 'a *)</span>

<span class="token comment">(* Instead, we know to pull [Staged.t] values out of hot-loops: *)</span>

<span class="token keyword">let</span> decode_int32 <span class="token operator">=</span> <span class="token module variable">Staged</span><span class="token punctuation">.</span>unstage <span class="token punctuation">(</span>decode <span class="token module variable">Irmin</span><span class="token punctuation">.</span><span class="token module variable">Type</span><span class="token punctuation">.</span>int32<span class="token punctuation">)</span>

<span class="token keyword">let</span> int_of_file_fast <span class="token label function">~path</span> <span class="token operator">=</span> open_in_bin path <span class="token operator">|&gt;</span> input_line <span class="token operator">|&gt;</span> decode_int32 contents</code></pre></div>
<p>We made similar changes to the performance-critical generic functions in
<a href="https://mirage.github.io/irmin/irmin/Irmin/Type/index.html"><code>Irmin.Type</code></a>, and observed significant performance improvements.
We also added benchmarks for serialising various types.</p>
<div style="text-align: center;">
  <img src="https://tarides.com/staged-type.svg" style="height: 550px; max-width: 100%"/>
</div>
<p>Relevant PRs: <a href="https://github.com/mirage/irmin/pull/1030">irmin #1030</a> and
<a href="https://github.com/mirage/irmin/pull/1028">irmin #1028</a>.</p>
<p>There are other interesting factors at play, such as altering <code>decode</code> to
increase the efficiency of the specialised decoders; we leave this for a future
blog post.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#more-control-over-indexmerge" aria-label="more control over indexmerge permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>More control over <code>Index.merge</code></h2>
<p>index regularly does a maintenance operation, called <code>merge</code>, to ensure fast
look-ups while having a small memory imprint. This operation is concurrent with
the most of other functions, it is however not concurrent with itself: a second
merge needs to wait for a previous one to finish. When writing big chunks of
data very often, <code>merge</code> operations become blocking. To help measuring and
detecting a blocking <code>merge</code>, we added in the <code>index</code> API calls to check whether
a merge is ongoing, and to time it.</p>
<p>We mentioned that <code>merge</code> is concurrent with most of the other function in
<code>index</code>. One notable exception was <code>close</code>, which had to wait for any ongoing
<code>merge</code> to finish, before closing the index. Now <code>close</code> interrupts an ongoing
merge, but still leaves the index in a clean state.</p>
<p>Relevant PRs: <a href="https://github.com/mirage/index/pull/185">index #185</a>,
<a href="https://github.com/mirage/irmin/pull/1049">irmin #1049</a> and
<a href="https://github.com/mirage/index/pull/215">index #215</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#clearing-stores" aria-label="clearing stores permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Clearing stores</h2>
<p>Another feature we recently added is the possibility to <code>clear</code> the store. It is
implemented by removing the old files on disk and opening fresh ones. However
in <code>irmin-pack</code>, the read-only instance has to detect that a clear occurred. To
do this, we add a <code>generation</code> in the header of the files used by an
<code>irmin-pack</code> store, which is increased by the clear operation. A generation
change signals to the read-only instance that it needs to close the file and
open it again, to be able to read the latest values.</p>
<p>As the header of the files on disk changed with the addition of the clear
operation, the <code>irmin-pack</code> stores created previous to this change are no longer
supported. We added a migration function for stores created with the previous
version (version 1) to the new version (version 2) of the store. You can call
this migration function as follows:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"> <span class="token keyword">let</span> open_store <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token module variable">Store</span><span class="token punctuation">.</span><span class="token module variable">Repo</span><span class="token punctuation">.</span>v config
  <span class="token keyword">in</span>
  <span class="token module variable">Lwt</span><span class="token punctuation">.</span>catch open_store <span class="token punctuation">(</span><span class="token keyword">function</span>
      <span class="token operator">|</span> <span class="token module variable">Irmin_pack</span><span class="token punctuation">.</span><span class="token module variable">Unsupported_version</span> <span class="token variant variable">`V1</span> <span class="token operator">-&gt;</span>
          <span class="token module variable">Logs</span><span class="token punctuation">.</span>app <span class="token punctuation">(</span><span class="token keyword">fun</span> l <span class="token operator">-&gt;</span> l <span class="token string">&quot;migrating store to version 2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token module variable">Store</span><span class="token punctuation">.</span>migrate config <span class="token punctuation">;</span>
          <span class="token module variable">Logs</span><span class="token punctuation">.</span>app <span class="token punctuation">(</span><span class="token keyword">fun</span> l <span class="token operator">-&gt;</span> l <span class="token string">&quot;migration ended, opening store&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          open_store <span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">|</span> exn <span class="token operator">-&gt;</span>
          <span class="token module variable">Lwt</span><span class="token punctuation">.</span>fail exn<span class="token punctuation">)</span></code></pre></div>
<p>Relevant PRs: <a href="https://github.com/mirage/index/pull/211">index #211</a>,
<a href="https://github.com/mirage/irmin/pull/1047">irmin #1047</a>,
<a href="https://github.com/mirage/irmin/pull/1070">irmin #1070</a> and
<a href="https://github.com/mirage/irmin/pull/1071">irmin #1071</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>We hope you've enjoyed this discussion of our recent work. <a href="https://twitter.com/tarides_">Stay
tuned</a> for our next Tezos / MirageOS development update! Thanks
to our commercial customers, users and open-source contributors for making this
work possible.</p>|js}
  };
 
  { title = {js|Introducing irmin-pack|js}
  ; slug = {js|introducing-irmin-pack|js}
  ; description = Some {js|irmin-pack is an Irmin storage backend
that we developed over the last year specifically to meet the
Tezos use-case. Tezos nodes were…|js}
  ; url = {js|https://tarides.com/blog/2020-09-01-introducing-irmin-pack|js}
  ; date = {js|2020-09-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/5dbd4ce5058bf6225c3a8ac98e4dda54/ed842/drawers.jpg|js}
  ; featured = false
  ; body_html = {js|<p><code>irmin-pack</code> is an Irmin <a href="https://irmin.org/tutorial/backend">storage backend</a>
that we developed over the last year specifically to meet the
<a href="https://tezos.gitlab.io/">Tezos</a> use-case. Tezos nodes were initially using an
LMDB-based backend for their storage, which after only a year of activity led to
<code>250 GB</code> disk space usage, with a monthly growth of <code>25 GB</code>. Our goal was to
dramatically reduce this disk space usage.</p>
<p>Part of the <a href="https://tarides.com/blog/2019-11-21-irmin-v2">Irmin.2.0.0 release</a>
and still under active development, it has been successfully integrated as the
storage layer of Tezos nodes and has been running in production for the last ten
months with great results. It reduces disk usage by a factor of 10, while still
ensuring similar performance and consistency guarantees in a memory-constrained
and concurrent environment.</p>
<p><code>irmin-pack</code> was presented along with Irmin v2 at the OCaml workshop 2020; you
can watch the presentation here:</p>
<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%">
  <iframe style="position: absolute; width: 100%; height: 100%; left: 0; right: 0" src="https://www.youtube-nocookie.com/embed/v1lfMUM332w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen">
  </iframe>
</div>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#general-structure" aria-label="general structure permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>General structure</h2>
<p><code>irmin-pack</code> exposes functors that allow the user to provide arbitrary low-level
modules for handling I/O, and provides a fast key-value store interface composed
of three components:</p>
<ul>
<li>The <code>pack</code> is used to store the data contained in the Irmin store, as blobs.</li>
<li>The <code>dict</code> stores the paths where these blobs should live.</li>
<li>The <code>index</code> keeps track of the blobs that are present in the repository by
containing location information in the <code>pack</code>.</li>
</ul>
<p>Each of these use both on-disk storage for persistence and concurrence and
various in-memory caches for speed.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#storing-the-data-in-the-pack-file" aria-label="storing the data in the pack file permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storing the data in the <code>pack</code> file</h3>
<p>The <code>pack</code> contains most of the data stored in this Irmin backend. It is an
append-only file containing the serialized data stored in the Irmin repository.
All three Irmin stores (see our <a href="https://irmin.org/tutorial/architecture">architecture
page</a> in the tutorial to learn more)
are contained in this single file.</p>
<p><code>Content</code> and <code>Commit</code> serialization is straightforward through
<a href="https://docs.mirage.io/irmin/Irmin/Type/index.html"><code>Irmin.Type</code></a>. They are written along with their length (to allow
correct reading) and hash (to enable integrity checks). The hash is used to
resolve internal links inside the pack when nodes are written.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/65f80d5690bb49cd0ead891e2e7346c8/f989d/pack.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 16.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMACSfAAAknwAFlKNyIAAAAwUlEQVQI1x2JXUvDMAAA+///jyB9EATtNupq18GU2NWkMW3TGPop3aZwQh+O47hgyD8YKkvdO9zc4CaLHS2F1ZheUQ9mpRkNpTdIp7FjjfGedmpYFs/fdeC6dPxeegJ3f0cWPvIkDryoHdtzxF6lhElCVr8Sy5hNvuHYpETiwEMWE3/uCPcJkXjm26VYFWOKLbdJEFzEOy6XnFvNV6/QnUL5EmEMupNrl51aX95I3kyO9AUnLVfPc8Uy1vyMFbel5R+3ito8hFIP1gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/65f80d5690bb49cd0ead891e2e7346c8/c5bb3/pack.png" class="gatsby-resp-image-image" alt="The pack file" title="The pack file" srcset="/static/65f80d5690bb49cd0ead891e2e7346c8/04472/pack.png 170w,
/static/65f80d5690bb49cd0ead891e2e7346c8/9f933/pack.png 340w,
/static/65f80d5690bb49cd0ead891e2e7346c8/c5bb3/pack.png 680w,
/static/65f80d5690bb49cd0ead891e2e7346c8/b12f7/pack.png 1020w,
/static/65f80d5690bb49cd0ead891e2e7346c8/b5a09/pack.png 1360w,
/static/65f80d5690bb49cd0ead891e2e7346c8/f989d/pack.png 5206w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#optimizing-large-nodes" aria-label="optimizing large nodes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimizing large nodes</h4>
<p>Serializing nodes is not as simple as contents. In fact, nodes might contain an
arbitrarily large number of children, and serializing them as a long list of
references might harm performance, as that means loading and writing a large
amount of data for each modification, no matter how small this modification
might be. Similarly, browsing the tree means reading large blocks of data, even
though only one child is needed.</p>
<p>For this reason, we implemented a <a href="https://en.wikipedia.org/wiki/Radix_tree">Patricia Tree</a> representation of
internal nodes that allows us to split the child list into smaller parts that
can be accessed and modified independently, while still being quickly available
when needed. This reduces duplication of tree data in the Irmin store and
improves disk access times.</p>
<p>Of course, we provide a custom hashing mechanism, so that hashing the nodes
using this partitioning is still backwards-compatible for users who rely on hash
information regardless of whether the node is split or not.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#optimizing-internal-references" aria-label="optimizing internal references permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Optimizing internal references</h4>
<p>In the Git model, all data are content-addressable (i.e. data are always
referenced by their hash). This naturally lends to indexing data by hashes on
the disk itself (i.e. the links from <code>commits</code> to <code>nodes</code> and from <code>nodes</code> to
<code>nodes</code> or <code>contents</code> are realized by hash).</p>
<p>We did not comply to this approach in <code>irmin-pack</code>, for at least two reasons:</p>
<ul>
<li>
<p>Referencing by hash does not allow fast recovery of the children, since
there is no way to find the relevant blob directly in the <code>pack</code> by providing
the hash. We will go into the details of this later in this post.</p>
</li>
<li>
<p>While hashes are being used as simple objects, their size is not negligible.
The default hashing function in Irmin is BLAKE2B, which provides 64-byte
digests.</p>
</li>
</ul>
<p>Instead, our internal links in the <code>pack</code> file are concretized by the offsets &ndash;
<code>int64</code> integers &ndash; of the children instead of their hash. Provided that the
trees are always written bottom-up (so that children already exist in the <code>pack</code>
when their parents are written), this solves both issues above. The data handled
by the backend is always immutable, and the file is append-only, ensuring that
the links can never be broken.</p>
<p>Of course, that encoding does not break the content-addressable property: one
can always retrieve an arbitrary piece of data through its hash, but it allows
internal links to avoid that indirection.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#deduplicating-the-path-names-through-the-dict" aria-label="deduplicating the path names through the dict permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deduplicating the path names through the <code>dict</code></h3>
<p>In fact, the most common operations when using <code>irmin-pack</code> consist of modifying
the tree's leaves rather then its shape. This is similar to the way most of us
use Git: modifying the contents of files is very frequent, while renaming or
adding new files is rather rare. Even still, when writing a <code>node</code> in a new
commit, that node must contain the path names of its children, which end up
being duplicated a large number of times.</p>
<p>The <code>dict</code> is used for deduplication of path names so that the <code>pack</code> file can
uniquely reference them using shorter identifiers. It is composed of an
in-memory bidirectional hash table, allowing to query from path to identifier
when serializing and referencing, and from identifier to path when deserializing
and dereferencing.</p>
<p>To ensure persistence of the data across multiple runs and in case of crashes,
the small size of the <code>dict</code> &ndash; less than <code>15 Mb</code> in the Tezos use-case &ndash; allows
us to write the bindings to a write-only, append-only file that is fully read
and loaded on start-up.</p>
<p>We guarantee that the <code>dict</code> memory usage is bounded by providing a <code>capacity</code>
parameter. Adding a binding is guarded by this capacity, and will be inlined in
the <code>pack</code> file in case this limit has been reached. This scenario does not
happen during normal use of <code>irmin-pack</code>, but prevents attacks that would make
the memory grow in an unbounded way.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/cec17f425cdf458a385babbac24c0c04/f7171/dict.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 46.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMACSfAAAknwAFlKNyIAAABvUlEQVQoz22O226bUBBF+f//qdT6qbHjxkl8BQIhjRPwDewkYChwOOcAq4K4T+lIW1oz0mwtw/c8VJYhRU6piq+RxX/vSglqLalrSVOrnrWqMOLRFXI6ZWtPWEVL7MOK5W6KdVhhHZY926GJeVj0/HDh99hFZi8UyTPnk4tI1+jCx9h+/8Z+MODhZsDIu2YezBh7Q355456H7k8mTxOW2yVDp+MbZsGUj8QmCU3W7ohXb8xxMwPpY6Q3Y+R8zs65xYxMzP2c1X7WW3U2nWXHd/51f388Oix204uhT94belTZK7rYYOiypIuqShpqkuJEXqXUTY3QJamIOZcfvOcRcfGGUAVxfkTIApqWpqn71FqhlcTgMm3b8ui6xElKViVkIiEtYqQSNHXdP2styUXOuThzyvZUWqC16n//jdEt3d42mvfQ5WrxiB3aLHb3RB8OiD2qCJC5D9WG43HPyHJZHWY4ocmf9Dc0ivYiZXAphJqm3DC4tbh/mTF5nvB2fgAZQOV/pvYJQ58f9wvu1rcsgiki96BVnx1dYW/IZ6HINgyXHk7kYIXmxXCHLgJUHvSGUbRlZDm4Jxs3sr4Y/gV1k563ex97NwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/cec17f425cdf458a385babbac24c0c04/c5bb3/dict.png" class="gatsby-resp-image-image" alt="The dict" title="The dict" srcset="/static/cec17f425cdf458a385babbac24c0c04/04472/dict.png 170w,
/static/cec17f425cdf458a385babbac24c0c04/9f933/dict.png 340w,
/static/cec17f425cdf458a385babbac24c0c04/c5bb3/dict.png 680w,
/static/cec17f425cdf458a385babbac24c0c04/b12f7/dict.png 1020w,
/static/cec17f425cdf458a385babbac24c0c04/b5a09/dict.png 1360w,
/static/cec17f425cdf458a385babbac24c0c04/f7171/dict.png 3456w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#retrieve-the-data-in-the-pack-by-indexing" aria-label="retrieve the data in the pack by indexing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retrieve the data in the <code>pack</code> by indexing</h3>
<p>Since the <code>pack</code> file is append-only, naively reading its data would require a
linear search through the whole file for each lookup. Instead, we provide an
index that maps hashes of data blocks to their location in the <code>pack</code> file,
along with their length. This module allows quick recovery of the values queried
by hash.</p>
<p>It provides a simple key-value interface, that actually hides the most complex
part of <code>irmin-pack</code>.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t
<span class="token keyword">val</span> v <span class="token punctuation">:</span> readonly<span class="token punctuation">:</span>bool <span class="token operator">-&gt;</span> path<span class="token punctuation">:</span>string <span class="token operator">-&gt;</span> t

<span class="token keyword">val</span> find    <span class="token punctuation">:</span> t <span class="token operator">-&gt;</span> <span class="token module variable">Key</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> <span class="token module variable">Value</span><span class="token punctuation">.</span>t
<span class="token keyword">val</span> replace <span class="token punctuation">:</span> t <span class="token operator">-&gt;</span> <span class="token module variable">Key</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> <span class="token module variable">Value</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> unit
<span class="token comment">(* ... *)</span></code></pre></div>
<p>It has lead most of our efforts in the development of <code>irmin-pack</code> and is now
available as a separate library, wisely named <code>index,</code> that you can checkout on
GitHub under <a href="https://github.com/mirage/index/">mirage/index</a> and via <code>opam</code> as
the <code>index</code> and <code>index-unix</code> packages.</p>
<p>When <code>index</code> is used inside <code>irmin-pack</code>, the keys are the hashes of the data
stored in the backend, and the values are the <code>(offset, length)</code> pair that
indicates the location in the <code>pack</code> file. From now on in this post, we will
stick to the <code>index</code> abstraction: <code>key</code> and <code>value</code> will refer to the keys and
values as viewed by the <code>index</code>.</p>
<p>Our index is split into two major parts. The <code>log</code> is relatively small, and most
importantly, bounded; it contains the recently-added bindings. The <code>data</code> is
much larger, and contains older bindings.</p>
<p>The <code>log</code> part consists of a hash table associating keys to values. In order to
ensure concurrent access, and to be able to recover on a crash, we also maintain
a write-only, append-only file with the same contents, such that both always
contain exactly the same data at any time.</p>
<p>When a new key-value binding is added index, the value is simply serialized
along with its key and added to the <code>log</code>.</p>
<p>An obvious caveat of this approach is that the in-memory representation of the
<code>log</code> (the hashtable) is unbounded. It also grows a lot, as the Tezos node
stores more that 400 million objects. Our memory constraint obviously does not
allow such unbounded structures. This is where the <code>data</code> part comes in.</p>
<p>When the <code>log</code> size reaches a &ndash; customizable &ndash; threshold, its bindings are
flushed into a <code>data</code> component, that may already contain flushed data from
former <code>log</code> overloads. We call this operation a <em>merge</em>.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/7663e5dd55a9fa612393be5ae1952bf5/e9c53/merges.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 28.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAC4jAAAuIwF4pT92AAABQElEQVQY032RbXOaQBSF+f9/Km0sQTSFpDqQqBt3QUFY5KVKRczydIY23zI5M8+cuefTOXOtKAxYiZDNXpBWKUmZUNYZTa2pq4ymqfiQMQPm3fCVrOT7Hb/WDo5ycISNLWzi1CeLPFI1J083/D63DANUOmW59VBHQVQK1HFDVL6N90dmZVISJYp9kaAbTV7nHKucojigdUpZFRhjaNsLMhd4scPPyMGLpzwqm8fo4Z+rhzG3AuXjyRnLncdrvuTlsCDMFoSHBcv0iV2tYICmObFKQpy3O2ZyMjJXNs+7OX7s4kcuT/EMy4+nzNQEV97jygnu9n5kLn8w3X5jnQX0/W2c3PYnkiYiLiVSC+o/JWYw3N57uuuF7tphbYs1G/0yIvQr4r+vDgHB/pmkium6ntP5zLGsaM8Xrt1tbP3ZU/4C4hC6W7cBBZQAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/7663e5dd55a9fa612393be5ae1952bf5/c5bb3/merges.png" class="gatsby-resp-image-image" alt="Merging the index" title="Merging the index" srcset="/static/7663e5dd55a9fa612393be5ae1952bf5/04472/merges.png 170w,
/static/7663e5dd55a9fa612393be5ae1952bf5/9f933/merges.png 340w,
/static/7663e5dd55a9fa612393be5ae1952bf5/c5bb3/merges.png 680w,
/static/7663e5dd55a9fa612393be5ae1952bf5/b12f7/merges.png 1020w,
/static/7663e5dd55a9fa612393be5ae1952bf5/b5a09/merges.png 1360w,
/static/7663e5dd55a9fa612393be5ae1952bf5/e9c53/merges.png 7470w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>The important invariant maintained by the <code>merge</code> operation is that the <code>data</code>
file must remain sorted by the hash of the bindings. This will enable a fast
recovery of the data.</p>
<p>During this operation, both the <code>log</code> and the former <code>data</code> are read in sorted
order &ndash; <code>data</code> is already sorted, and <code>log</code> is small thus easy to sort in
memory &ndash; and merged into a <code>merging_data</code> file. This file is atomically renamed
at the end of the operation to replace the older <code>data</code> while still ensuring
correct concurrent accesses.</p>
<p>This operation obviously needs to re-write the whole index, so its execution
is very expensive. For this reason, it is performed by a separate thread in the
background to still allow regular use of the index and be transparent to the
user.</p>
<p>In the meantime, a <code>log_async</code> &ndash; similar to <code>log</code>, with a file and a hash table
&ndash; is used to hold new bindings and ensure the data being merged and the new data
are correctly separated. At the end of the merge, the <code>log_async</code> becomes the
new <code>log</code> and is cleared to be ready for the next merge.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#recovering-the-data" aria-label="recovering the data permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Recovering the data</h4>
<p>This design allows us a fast lookup of the data present in the index. Whenever
<code>find</code> or <code>mem</code> is called, we first look into the <code>log</code>, which is simply a call
to the corresponding <code>Hashtbl</code> function, since this data is contained in memory.
If the data is not found in the <code>log</code>, the <code>data</code> file will be browsed. This
means access to recent values is generally faster, because it does not require
any access to the disk.</p>
<p>Searching in the <code>data</code> file is made efficient by the invariant that we kept
during the <code>merge</code>: the file is sorted by hash. The search algorithm consists in
an interpolation search, which is permitted by the even distribution of the
hashes that we store. The theoretical complexity of the interpolation search is
<code>O(log (log n))</code>, which is generally better than a binary search, provided that
the computation of the interpolant is cheaper than reads, which is the case
here.</p>
<p>This approach allows us to find the data using approximately 5-6 reading steps
in the file, which is good, but still a source of slowdowns. For this reason, we
use a fan-out module on top of the interpolation search, able to tell us the
exact page in which a given key is located, in constant time, for an additional
space cost of <code>~100 Mb</code>. We use this to find the correct page of the disk, then
run the interpolation search in that page only. That approach allows us to find
the correct value with a single read in the <code>data</code> file.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>This new backend is now used byt the Tezos nodes in production, and manages to
reduce the storage size from <code>250 Gb</code> down to <code>25 Gb</code>, with a monthly growth
rate of <code>2 Gb</code> , achieving a tenfold reduction.</p>
<p>In the meantime, it provides and single writer, multiple readers access pattern
that enables bakers and clients to connect to the same storage while it is operated.</p>
<p>On the memory side, all our components are memory bounded, and the bound is
generally customizable, the largest source of memory usage being the <code>log</code> part
of the <code>index</code>. While it can be reduced to fit in <code>1 Gb</code> of memory and run on
small VPS or Raspberry Pi, one can easily set a higher memory limit on a more
powerful machine, and achieve even better time performance.</p>|js}
  };
 
  { title = {js|Announcing Signals and Threads, a new podcast from Jane Street|js}
  ; slug = {js|announcing-signals-and-threads-a-new-podcast-from-jane-street|js}
  ; description = Some {js|I’m excited (and slightly terrified) to announce that Jane Street isreleasing a new podcast, called Signals andThreads, and I’m going to be thehost.|js}
  ; url = {js|https://blog.janestreet.com/announcing-signals-and-threads-index/|js}
  ; date = {js|2020-08-31T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/announcing-signals-and-threads-index/./signals-and-threads.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;m excited (and slightly terrified) to announce that Jane Street is
releasing a new podcast, called <a href="https://signalsandthreads.com/">Signals and
Threads</a>, and I&rsquo;m going to be the
host.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2020 edition|js}
  ; slug = {js|what-the-interns-have-wrought-2020-edition|js}
  ; description = Some {js|It’s been an unusual internship season.|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2020/|js}
  ; date = {js|2020-08-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/what-the-interns-have-wrought-2020/./distributed-wrought.jpg|js}
  ; featured = false
  ; body_html = {js|<p>It&rsquo;s been an unusual internship season.</p>|js}
  };
 
  { title = {js|Fuzzing OCamlFormat with AFL and Crowbar|js}
  ; slug = {js|fuzzing-ocamlformat-with-afl-and-crowbar|js}
  ; description = Some {js|AFL (and fuzzing in general) is often used
to find bugs in low-level code like parsers, but it also works very well to find
bugs in high…|js}
  ; url = {js|https://tarides.com/blog/2020-08-03-fuzzing-ocamlformat-with-afl-and-crowbar|js}
  ; date = {js|2020-08-03T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/e6219992a464284115d27348b49c3910/0132d/feather2.jpg|js}
  ; featured = false
  ; body_html = {js|<p><a href="https://lcamtuf.coredump.cx/afl/">AFL</a> (and fuzzing in general) is often used
to find bugs in low-level code like parsers, but it also works very well to find
bugs in high level code, provided the right ingredients. We applied this
technique to feed random programs to OCamlFormat and found many formatting bugs.</p>
<p>OCamlFormat is a tool to format source code. To do so, it parses the source code
to an Abstract Syntax Tree (AST) and then applies formatting rules to the AST.</p>
<p>It can be tricky to correctly format the output. For example, say we want to
format <code>(a+b)*c</code>. The corresponding AST will look like <code>Apply(&quot;*&quot;, Apply (&quot;+&quot;, Var &quot;a&quot;, Var &quot;b&quot;), Var &quot;c&quot;)</code>. A naive formatter would look like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token keyword">rec</span> format <span class="token operator">=</span> <span class="token keyword">function</span>
  <span class="token operator">|</span> <span class="token module variable">Var</span> s <span class="token operator">-&gt;</span> s
  <span class="token operator">|</span> <span class="token module variable">Apply</span> <span class="token punctuation">(</span>op<span class="token punctuation">,</span> e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
      <span class="token module variable">Printf</span><span class="token punctuation">.</span>sprintf <span class="token string">&quot;%s %s %s&quot;</span> <span class="token punctuation">(</span>format e1<span class="token punctuation">)</span> op <span class="token punctuation">(</span>format e2<span class="token punctuation">)</span></code></pre></div>
<p>But this is not correct, as it will print <code>(a+b)*c</code> as <code>a+b*c</code>, which is a
different program. In this particular case, the common solution would be to
track the relative precedence of the expressions and to emit only necessary
parentheses.</p>
<p>OCamlFormat has similar cases. To make sure we do not change a program when
formatting it, there is an extra check at the end to parse the output and
compare the output AST with the input AST. This ensures that, in case of bugs,
OCamlFormat exits with an error rather than changing the meaning of the input
program.</p>
<p>When we consider the whole OCaml language, the rules are complex and it is
difficult to make sure that we are correctly handling all programs. There are
two main failure modes: either we put too many parentheses, and the program does
not look good, or we do not put enough, and the AST changes (and OCamlFormat
exits with an error). We need a way to make sure that the latter does not
happen. Tests work to some extent, but some edge cases happen only when a
certain combination of language features is used. Because of this combinatorial
explosion, it is impossible to get good coverage using tests only.</p>
<p>Fortunately there is a technique we can use to automatically explore the program
space: fuzzing. For a primer on using this technique on OCaml programs, one can
refer to <a href="https://tarides.com/blog/2019-09-04-an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun">this article</a>.</p>
<p>To make this work we need two elements: a random program generator, and a
property to check. Here, we are interested in programs that are valid (in the
sense that they parse correctly) but do not format correctly. We can use the
OCamlFormat internals to do the following:</p>
<ol>
<li>try to parse input: in case of a parse error, just reject this input as</li>
</ol>
<p>invalid.</p>
<ol>
<li>otherwise, with have a valid program. try to format it. If this happens with</li>
</ol>
<p>no error at all, reject this input as well.</p>
<ol>
<li>otherwise, it means that the AST changed, comments moved, or something</li>
</ol>
<p>similar, in a valid program. This is what we are after.</p>
<p>Generating random programs is a bit more difficult. We can feed random strings
to AFL, but even with a corpus of existing valid code it will generate many
invalid programs. We are not interested in these for this project, we would
rather start from valid programs.</p>
<p>A good way to do that is to use Crowbar to directly generate AST values. Thanks
to <a href="https://github.com/yomimono/ppx_deriving_crowbar"><code>ppx_deriving_crowbar</code></a> and <a href="https://github.com/ocaml-ppx/ppx_import"><code>ppx_import</code></a>
it is possible to generate random values for an external type like
<code>Parsetree.structure</code> (the contents of <code>.ml</code> files). Even more fortunately
<a href="https://github.com/yomimono/ocaml-test-omp/blob/d086037027537ba4e23ce027766187979c85aa3d/test/parsetree_405.ml">somebody already did the work</a>. Thanks, Mindy!</p>
<p>This approach works really well: it generates 5k-10k programs per second, which
is very good performance (AFL starts complaining below 100/s).</p>
<p>Quickly, AFL was able to find crashes related to attributes. These are &quot;labels&quot;
attached to various nodes of the AST. For example the expression <code>(x || y) [@a]</code>
(logical or between <code>x</code> and <code>y</code>, attach attribute <code>a</code> to the &quot;or&quot; expression)
would get formatted as <code>x || y [@a]</code> (attribute <code>a</code> is attached to the <code>y</code>
variable). Once again, there is a check in place in OCamlFormat to make sure
that it does not save the file in this case, but it would exit with an error.</p>
<p>After the fuzzer has run for a bit longer, it found crashes where comments would
jump around in expressions like <code>f (*a*) (*bb*) x</code>. Wait, what? We never told
the program generator how to generate comments. Inspecting the intermediate AST,
the part in the middle is actually an integer literal with value <code>&quot;(*a*) (*bb*)&quot;</code> (integer literals are represented as strings so that <a href="https://github.com/Drup/Zarith-ppx">a third party
library could add literals for arbitrary precision numbers</a> for
example).</p>
<p>AFL comes with a program called <code>afl-tmin</code> that is used to minimize a crash. It
will try to find a smaller example of a program that crashes OCamlFormat. It
works well even with Crowbar in between. For example it is able to turn <code>(new aaaaaa &amp; [0;0;0;0])[@aaaaaaaaaa]</code> into <code>(0&amp;0)[@a]</code> (neither AFL nor OCamlFormat
knows about types, so they can operate on nonsensical programs. Finding a
well-typed version of a crash is usually not very difficult, but it has to be
done manually).</p>
<p>In total, letting AFL run overnight on a single core (that is relatively short
in terms of fuzzing) caused 453 crashes. After minimization and deduplication,
this corresponded to <a href="https://github.com/ocaml-ppx/ocamlformat/issues?q=label:fuzz">about 30 unique issues</a>.</p>
<p>Most of them are related to attributes that OCamlFormat did not try to include
in the output, or where it forgot to add parentheses. Fortunately, there are
safeguards in OCamlFormat: since it checks that the formatting preserves the AST
structure, it will exit with an error instead of outputting a different program.</p>
<p>Once again, fuzzing has proved itself as a powerful technique to find actual
bugs (including high-level ones). A possible approach for a next iteration is to
try to detect more problems during formatting, such as finding cases where lines
are longer than allowed. It is also possible to extend the random program
generator so that it tries to generate comments, and let OCamlFormat check that
they are all laid out correctly in the output. We look forward to employing
fuzzing more extensively for OCamlFormat development in future.</p>|js}
  };
 
  { title = {js|One and a half years of ReasonML in production|js}
  ; slug = {js|one-and-a-half-years-of-reasonml-in-production|js}
  ; description = Some {js|The first Reason application at Ahrefs went online on January 31, 2019. Since then, many more applications have been either rewritten in…|js}
  ; url = {js|https://tech.ahrefs.com/one-and-a-half-years-of-reasonml-in-production-2250cf5ba63b?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2020-07-26T15:19:31-00:00|js}
  ; preview_image = Some {js|https://miro.medium.com/max/1200/1*Nl5vYk_k-mC4j32XEjryHQ.jpeg|js}
  ; featured = false
  ; body_html = {js|<figure><img src="https://cdn-images-1.medium.com/max/1024/1*Nl5vYk_k-mC4j32XEjryHQ.jpeg" alt=""/><figcaption>Photo by <a href="https://unsplash.com/@willianjusten">https://unsplash.com/@willianjusten</a></figcaption></figure><p>The first <a href="https://reasonml.org/">Reason</a> application at <a href="https://ahrefs.com">Ahrefs</a> went online on January 31, 2019. Since then, many more applications have been either rewritten in Reason, are being slowly migrated from React to ReasonReact, or are conceived from the start as Reason projects. It is safe to say that the bet placed on Reason paid off big time. We will never go back to doing pure JavaScript again, with the possible exception of simple backend&nbsp;scripts.</p><p>In the past few years, it&rsquo;s come to light that there are a number of other <a href="https://www.messenger.com/">large</a> <a href="https://www.onegraph.com/">Reason</a>/<a href="https://darklang.com/">BuckleScript</a> <a href="https://onivim.io/">codebases</a> in the wild, but there still isn&rsquo;t a ton of information out there about what it&rsquo;s really like to work with Reason in production. To help remedy that, we thought it would be instructive to ask each of our frontend team members what their Reason journey has been like so&nbsp;far.</p><p>We gave them the following questions as starting points (but they were free to talk about anything they&nbsp;wanted):</p><ul><li>How does Reason compare to other languages you&rsquo;ve used in the&nbsp;past?</li><li>What&rsquo;s your favorite thing about&nbsp;Reason?</li><li>What&rsquo;s your least favorite thing about&nbsp;Reason?</li><li>How does ReasonReact compare to other frameworks you&rsquo;ve&nbsp;used?</li><li>Was it easy to pick up Reason? Why or why&nbsp;not?</li></ul><h4>Javi</h4><ul><li>How does Reason compare to other languages you&rsquo;ve used in the&nbsp;past?</li></ul><p>In the past I worked with languages like Java, C, or less known like Pascal or Prolog. But the languages I&rsquo;ve spent more time with are Objective-C and JavaScript. The main difference between all those languages and Reason is the exhaustiveness that you get from OCaml type checker. This is maybe awkward, but it feels like you stop coding alone and suddenly you have a sidekick always sitting next to you, that is helping you notice the things you forgot about, or found new code that is not consistent with code you or someone else wrote&nbsp;before.</p><p>In a world that is moving towards remote work, where many of us spend hours every day coding physically far from our colleagues, it makes the experience much more delightful. Plus, it allows for teams working on different time zones to keep a healthier work-life balance, because there is less need to have synchronous communication than with more dynamic languages, as more assumptions and design decisions are &ldquo;embedded&rdquo; into the&nbsp;code.</p><ul><li>What&rsquo;s your favorite thing about&nbsp;Reason?</li></ul><p>Can I pick two things? It&rsquo;s hard to choose only&nbsp;one.</p><p>The first one is the exhaustiveness and quality of the type checker, as mentioned above. Sometimes it takes a bit longer to build a feature than what it would in other languages, until the types are figured out. But this is largely compensated by the confidence one has when shipping code to production, or diving into large refactors.</p><p>The second one is the speed of the BuckleScript build system, which is built on top of <a href="https://ninja-build.org/">ninja</a>. I had never worked with such fast build system. As an example, we have recently started to use remote machines to develop at Ahrefs. In one of these machines that has 72 cores, BuckleScript takes roughly 3 seconds to clean build <em>all</em> our Reason code: application, libs, decoders&hellip; everything. Many tens of thousand lines of code! We thought there were something wrong, but we realized the compiler is just So Blazing&nbsp;Fast&trade;&#65039;.</p><ul><li>What&rsquo;s your least favorite thing about&nbsp;Reason?</li></ul><p>I guess we&rsquo;re going through a necessary stage until things stabilize in the future, but there is a lot of fragmentation at the moment between &ldquo;Reason native&rdquo;, which tries to stay closer to OCaml, and &ldquo;Reason web&rdquo;, which has a goal to become friendlier for JavaScript developers.</p><p>I am excited to see what <a href="https://reasonml.org/blog/bucklescript-8-1-new-syntax">BuckleScript new syntax</a> will lead to, but I would also love to see a &ldquo;universal&rdquo; solution that works for the main use cases out of the box, becoming sort of Rails for Ocaml or Reason. <a href="https://github.com/oxidizing/sihl/">sihl</a> is a project that seems to go in that direction and looks very promising.</p><ul><li>How does ReasonReact compare to other frameworks you&rsquo;ve&nbsp;used?</li></ul><p>I consider ReasonReact mostly like React + types on top, because the bindings layer is very thin. The thing that I like most about React is that it follows the Unix philosophy: it does one thing and it does it really well. Maybe we have forgotten already today, but having to maintain and mutate UI based on data updates was one of the main sources of bugs in the past. The other nice thing is that there is so much good content about it: blog posts, documentation, etc.</p><ul><li>Was it easy to pick up Reason? Why or why&nbsp;not?</li></ul><p>It took some time, as with any other language. We have things like syntax or semantics much more ingrained into our brains than we think, so there is always some &ldquo;rewiring&rdquo; time that is needed to learn a new language, even if Reason makes an effort to stay close to JavaScript syntax. The most challenging part was probably the bindings one, because coming from JavaScript, there are no previous knowledge that one can use as foundation to build upon, it&rsquo;s all &ldquo;new knowledge&rdquo;. glennsl <a href="https://github.com/glennsl/bucklescript-ffi-cheatsheet">BuckleScript ffi cheatsheet</a> was a huge help for&nbsp;me.</p><h4>Ze</h4><p>I really like working with Reason, and have wanted to do so for a while. I was quite happy to see that working with it matched my expectations.</p><p>You get so much support from the type system, and still have a lot of flexibility to represent your domain model. Coming from other languages or paradigms, you don&rsquo;t feel limited at all in what you can&nbsp;achieve.</p><p>The language has such a strong type system that you feel much more comfortable with your&nbsp;coding.</p><p>The OCaml type system is there to make sure you code with assurance. This is especially true when refactoring code. You can be sure that everything will work fine after it compiles. If it compiles, it works&nbsp;:)</p><p>It&rsquo;s also very helpful when working on a monorepo. You don&rsquo;t have to keep reading the source code of everything you use to make sure you don&rsquo;t have types mistakes. Changes in code in one lib reflect immediately in all the others. This makes the feedback loop much shorter and&nbsp;safer.</p><p>The editors integrations with the type system are quite good and help a lot to write code better and&nbsp;faster.</p><p>Also, compilation times are super&nbsp;fast.</p><p>Last, but not least, ReasonReact is, for me, the hidden gem of ReasonML. The newcomers that have some difficulty with the language should start with it. IMHO, ReasonReact is simpler and has a better developer experience than React itself. It should be the gateway drug frontend developers need to get started with Reason/OCaml &#128516;</p><h4>Liubomyr</h4><p>To me, all those language features boil down to one essential thing, and it&rsquo;s the easiness of refactoring. New business requirements popups all the time, and often your initial code assumptions are no longer correct. It was such a pain to modify code in a large JS codebase, as you never know how many things you potentially break in the process. With Reason, it has never been easier. If you need to change your data shape or some component API, you just do it, and from there, the compiler will guide you through all the places you broke, and help to fix&nbsp;those.</p><p>Coming from the JS world, it feels like the initial development is slower, because of the learning curve, missing bindings, less StackOverflow answers, but in the end, you are getting a stable software which is way easier to maintain and add features&nbsp;to.</p><h4>Egor</h4><p>I switched to Reason when I joined Ahrefs team about a year ago, before that I worked mostly with Ruby language.</p><p>The first thing that impressed me in ReasonML was code refactoring. Refactoring in language with a strong type system, like ReasonML and OCaml, is much easier than what I am used to. If your program compiles after your refactoring&#8202;&mdash;&#8202;most likely you did everything right, if it doesn&rsquo;t compile&#8202;&mdash;&#8202;you can immediately see what you forgot to change. This can be achieved in languages with a dynamic type system only with a huge amount of code tests (supporting big test suite is a time consuming process as well as code support).</p><p>The other thing that I really like about ReasonML codebase&#8202;&mdash;&#8202;how readable it is. When you just enter into ReasonML world&#8202;&mdash;&#8202;some things can be unfriendly from the first sight, for example, immutable let bindings, but in the end, you realize that these language decisions help you to write cleaner and simpler&nbsp;code.</p><h4>Seif</h4><p>The programming language I used the most in the past is JavaScript. I switched to Reason when I joined Ahrefs a few months ago. From the start, I worked mainly on the code shared by the majority of the tools and I don&rsquo;t think I would have had the same confidence making changes if I was doing it with JavaScript. I love JavaScript&rsquo;s developer experience and accessibility. Reason provided me predictability without hurting these very same things I like about JavaScript.</p><h4>Bryan</h4><p>Reason (and OCaml) is, by far, one of the easiest languages to work with. Easy in the sense that the compiler helps eliminate an entire class of errors so you don&rsquo;t have to worry about them. Additionally, in most other web-centric languages, it&rsquo;s a pain to add features to existing code that you&rsquo;ve not touched for a long time. With strong static typing, I can usually add the feature I want in either the backend or frontend, and then let the compiler tell me what needs to be&nbsp;updated.</p><p>Pattern-matching is one of my favourite features in Reason. To me, it makes more sense to be able to explicitly specify conditions that I&rsquo;m interested in a clear and concise manner, and let the compiler tell me if I missed out a particular condition. Records go hand-in-hand with this. As software programs are made up of data and instructions, records are the perfect data containers. They are quick to define and query, focusing on data rather than behaviour (think classes and instance methods).</p><p>It definitely took a while to pick up Reason mainly because it takes time to become familiar with idiomatic OCaml. But once I crested that learning curve, everything just made sense and all the features of the language that made Reason seemingly difficult to learn&#8202;&mdash;&#8202;strong typing, the functional paradigm, etc, became assistants that helped me to write better&nbsp;code.</p><h4>Feihong</h4><p><a href="https://reasonml.github.io/reason-react/en/">ReasonReact</a> is a great library for making complex UIs in a large codebase because you get the familiarity of React coupled with the type safety of OCaml. Having two well-established technologies in its foundation is a big advantage that ReasonReact has over other functional UI libraries/frameworks in the transpile-to-JS universe. I didn&rsquo;t have any professional OCaml experience before joining, yet the ramp up was made much easier by my existing knowledge of React and the (somewhat superficial) similarity of the Reason syntax to JS. Oftentimes it was possible to correctly guess the intent of existing Reason code without knowing all the syntax, because most React concepts carry over pretty directly. And even though the documentation is incomplete and not perfect, it&rsquo;s quite usable already and among conceptually-similar frameworks is second only to the Elm documentation.</p><p>The compiler errors were difficult to get used to at first. The compiler is fairly good at pointing out the location of the error, but not necessarily as good at explaining the nature or cause of the error. As such, having a REPL would be extremely useful. Actually, OCaml does have its own REPL, but BuckleScript (the compiler used by Reason to translate OCaml to JS) does not at the moment. Nonetheless, the <a href="https://reasonml.github.io/en/try">Try Reason</a> page is a really good tool to try out small snippets of code and is extremely useful while learning the language (we will still occasionally post Try Reason links in our slack channel).</p><h3>Summary</h3><p>The reality is that Ahrefs has always been an OCaml shop, but in the past OCaml was only used to build the backend. Now that we are also using it on the frontend, we get the benefits that our backend colleagues have enjoyed for many years: the expressiveness afforded by pattern matching, the ease of refactoring in large codebases, the stability of a mature programming language, and the confidence of &ldquo;if it compiles, it works&rdquo;. To make a shoddy nautical analogy, it is as if we had built a wooden ship powered by a turbo engine. But now the wooden parts are being replaced with steel and plastic, bringing the exterior of the ship up to modern standards as well. As a result, the ship runs faster and more reliably, making the passengers (our users) more satisfied. Also, pirates (bugs) have a harder time hijacking the ship because it&rsquo;s sturdier and defended by well-disciplined camels. Because the ship keeps getting more and more passengers who want to experience a delightful ride and take pictures with enigmatic camels, we require a constant influx of willing and able boat engineers (who aren&rsquo;t allergic to camels) to extend and maintain the ship. (Yes, that means that <a href="https://ahrefs.com/jobs">we are hiring</a>&#65039;.)</p><p><em>Thanks to Raman and Louis for fact checking this&nbsp;post.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=2250cf5ba63b" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/one-and-a-half-years-of-reasonml-in-production-2250cf5ba63b">One and a half years of ReasonML in production</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|The Jane Street Interview Process &mdash; 2020 Edition|js}
  ; slug = {js|the-jane-street-interview-process-mdash-2020-edition|js}
  ; description = Some {js|We’re busy preparing for our software engineering fall hiringseason. Over the years we’vedone our best to make our interview process more transparent tocandi...|js}
  ; url = {js|https://blog.janestreet.com/jane-street-interview-process-2020/|js}
  ; date = {js|2020-07-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/jane-street-interview-process-2020/ocaml_code.png|js}
  ; featured = false
  ; body_html = {js|<p>We&rsquo;re busy preparing for our software engineering <a href="https://blog.janestreet.com/unraveling/">fall hiring
season</a>. Over the years we&rsquo;ve
done our best to make our interview process more transparent to
candidates. While many candidates show up knowing something about what
our interviews look like, much of the information floating around on
the internet is outdated or wrong. These past few months have also
changed a lot about the process as we&rsquo;ve adapted to working from home
and other effects of COVID-19.</p>|js}
  };
 
  { title = {js|Traceroute|js}
  ; slug = {js|traceroute|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/Traceroute|js}
  ; date = {js|2020-06-24T10:38:10-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Traceroute</h2>
<p>Is a diagnostic utility which displays the route and measures transit delays of
packets across an Internet protocol (IP) network.</p>
<pre><code class="language-bash">$ doas solo5-hvt --net:service=tap0 -- traceroute.hvt --ipv4=10.0.42.2/24 --ipv4-gateway=10.0.42.1 --host=198.167.222.207
            |      ___|
  __|  _ \\  |  _ \\ __ \\
\\__ \\ (   | | (   |  ) |
____/\\___/ _|\\___/____/
Solo5: Bindings version v0.6.5
Solo5: Memory map: 512 MB addressable:
Solo5:   reserved @ (0x0 - 0xfffff)
Solo5:       text @ (0x100000 - 0x212fff)
Solo5:     rodata @ (0x213000 - 0x24bfff)
Solo5:       data @ (0x24c000 - 0x317fff)
Solo5:       heap &gt;= 0x318000 &lt; stack &lt; 0x20000000
2020-06-22 15:41:25 -00:00: INF [netif] Plugging into service with mac 76:9b:36:e0:e5:74 mtu 1500
2020-06-22 15:41:25 -00:00: INF [ethernet] Connected Ethernet interface 76:9b:36:e0:e5:74
2020-06-22 15:41:25 -00:00: INF [ARP] Sending gratuitous ARP for 10.0.42.2 (76:9b:36:e0:e5:74)
2020-06-22 15:41:25 -00:00: INF [udp] UDP interface connected on 10.0.42.2
2020-06-22 15:41:25 -00:00: INF [application]  1  10.0.42.1  351us
2020-06-22 15:41:25 -00:00: INF [application]  2  192.168.42.1  1.417ms
2020-06-22 15:41:25 -00:00: INF [application]  3  192.168.178.1  1.921ms
2020-06-22 15:41:25 -00:00: INF [application]  4  88.72.96.1  16.716ms
2020-06-22 15:41:26 -00:00: INF [application]  5  *
2020-06-22 15:41:27 -00:00: INF [application]  6  92.79.215.112  16.794ms
2020-06-22 15:41:27 -00:00: INF [application]  7  145.254.2.215  21.305ms
2020-06-22 15:41:27 -00:00: INF [application]  8  145.254.2.217  22.05ms
2020-06-22 15:41:27 -00:00: INF [application]  9  195.89.99.1  21.088ms
2020-06-22 15:41:27 -00:00: INF [application] 10  62.115.9.133  20.105ms
2020-06-22 15:41:27 -00:00: INF [application] 11  213.155.135.82  30.861ms
2020-06-22 15:41:27 -00:00: INF [application] 12  80.91.246.200  30.716ms
2020-06-22 15:41:27 -00:00: INF [application] 13  80.91.253.163  28.315ms
2020-06-22 15:41:27 -00:00: INF [application] 14  62.115.145.27  30.436ms
2020-06-22 15:41:27 -00:00: INF [application] 15  80.67.4.239  42.826ms
2020-06-22 15:41:27 -00:00: INF [application] 16  80.67.10.147  47.213ms
2020-06-22 15:41:27 -00:00: INF [application] 17  198.167.222.207  48.598ms
Solo5: solo5_exit(0) called
</code></pre>
<p>This means with a traceroute utility you can investigate which route is taken
to a destination host, and what the round trip time(s) on the path are. The
sample output above is taken from a virtual machine on my laptop to the remote
host 198.167.222.207. You can see there are 17 hops between us, with the first
being my laptop with a tiny round trip time of 351us, the second and third are
using private IP addresses, and are my home network. The round trip time of the
fourth hop is much higher, this is the first hop on the other side of my DSL
modem. You can see various hops on the public Internet: the packets pass from
my Internet provider's backbone across some exchange points to the destination
Internet provider somewhere in Sweden.</p>
<p>The implementation of traceroute relies mainly on the time-to-live (ttl) field
(in IPv6 lingua it is &quot;hop limit&quot;) of IP packets, which is meant to avoid route
cycles that would infinitely forward IP packets in circles. Every router, when
forwarding an IP packet, first checks that the ttl field is greater than zero,
and then forwards the IP packet where the ttl is decreased by one. If the ttl
field is zero, instead of forwarding, an ICMP time exceeded packet is sent back
to the source.</p>
<p>Traceroute works by exploiting this mechanism: a series of IP packets with
increasing ttls is sent to the destination. Since upfront the length of the
path is unknown, it is a reactive system: first send an IP packet with a ttl of
one, if a ICMP time exceeded packet is returned, send an IP packet with a ttl of
two, etc. -- until an ICMP packet of type destination unreachable is received.
Since some hosts do not reply with a time exceeded message, it is crucial for
not getting stuck to use a timeout for each packet: when the timeout is reached,
an IP packet with an increased ttl is sent and an unknown for the ttl is
printed (see the fifth hop in the example above).</p>
<p>The packets send out are conventionally UDP packets without payload. From a
development perspective, one question is how to correlate the ICMP packet
with the sent UDP packet. Conveniently, ICMP packets contain the IP header and
the first eight bytes of the next protocol - the UDP header containing source
port, destination port, checksum, and payload length (each fields of size two
bytes). This means when we record the outgoing ports together with the sent
timestamp, and correlate the later received ICMP packet to the sent packet.
Great.</p>
<p>But as a functional programmer, let's figure whether we can abolish the
(globally shared) state. Since the ICMP packet contains the original IP
header and the first eight bytes of the UDP header, this is where we will
embed data. As described above, the data is the sent timestamp and the value
of the ttl field. For the latter, we can arbitrarily restrict it to 31 (5 bits).
For the timestamp, it is mainly a question about precision and maximum expected
round trip time. Taking the source and destination port are 32 bits, using 5 for
ttl, remaining are 27 bits (an unsigned value up to 134217727). Looking at the
decimal representation, 1 second is likely too small, 13 seconds are sufficient
for the round trip time measurement. This implies our precision is 100ns, by
counting the digits.</p>
<p>Finally to the code. First we need forth and back conversions between ports
and ttl, timestamp:</p>
<pre><code class="language-OCaml">(* takes a time-to-live (int) and timestamp (int64, nanoseconda), encodes them
   into 16 bit source port and 16 bit destination port:
   - the timestamp precision is 100ns (thus, it is divided by 100)
   - use the bits 27-11 of the timestamp as source port
   - use the bits 11-0 as destination port, and 5 bits of the ttl
*)
let ports_of_ttl_ts ttl ts =
  let ts = Int64.div ts 100L in
  let src_port = 0xffff land (Int64.(to_int (shift_right ts 11)))
  and dst_port = 0xffe0 land (Int64.(to_int (shift_left ts 5))) lor (0x001f land ttl)
  in
  src_port, dst_port

(* inverse operation of ports_of_ttl_ts for the range (src_port and dst_port
   are 16 bit values) *)
let ttl_ts_of_ports src_port dst_port =
  let ttl = 0x001f land dst_port in
  let ts =
    let low = Int64.of_int (dst_port lsr 5)
    and high = Int64.(shift_left (of_int src_port) 11)
    in
    Int64.add low high
  in
  let ts = Int64.mul ts 100L in
  ttl, ts
</code></pre>
<p>They should be inverse over the range of valid input: ports are 16 bit numbers,
ttl expected to be at most 31, ts a int64 expressed in nanoseconds.</p>
<p>Related is the function to print out one hop and round trip measurement:</p>
<pre><code class="language-OCaml">(* write a log line of a hop: the number, IP address, and round trip time *)
let log_one now ttl sent ip =
  let now = Int64.(mul (logand (div now 100L) 0x7FFFFFFL) 100L) in
  let duration = Mtime.Span.of_uint64_ns (Int64.sub now sent) in
  Logs.info (fun m -&gt; m &quot;%2d  %a  %a&quot; ttl Ipaddr.V4.pp ip Mtime.Span.pp duration)
</code></pre>
<p>The most logic is when a ICMP packet is received:</p>
<pre><code class="language-OCaml">module Icmp = struct
  type t = {
    send : int -&gt; unit Lwt.t ;
    log : int -&gt; int64 -&gt; Ipaddr.V4.t -&gt; unit ;
    task_done : unit Lwt.u ;
  }

  let connect send log task_done =
    let t = { send ; log ; task_done } in
    Lwt.return t

  (* This is called for each received ICMP packet. *)
  let input t ~src ~dst buf =
    let open Icmpv4_packet in
    (* Decode the received buffer (the IP header has been cut off already). *)
    match Unmarshal.of_cstruct buf with
    | Error s -&gt;
      Lwt.fail_with (Fmt.strf &quot;ICMP: error parsing message from %a: %s&quot; Ipaddr.V4.pp src s)
    | Ok (message, payload) -&gt;
      let open Icmpv4_wire in
      (* There are two interesting cases: Time exceeded (-&gt; send next packet),
         and Destination (port) unreachable (-&gt; we reached the final host and can exit) *)
      match message.ty with
      | Time_exceeded -&gt;
        (* Decode the payload, which should be an IPv4 header and a protocol header *)
        begin match Ipv4_packet.Unmarshal.header_of_cstruct payload with
          | Ok (pkt, off) when
              (* Ensure this packet matches our sent packet: the protocol is UDP
                 and the destination address is the host we're tracing *)
              pkt.Ipv4_packet.proto = Ipv4_packet.Marshal.protocol_to_int `UDP &amp;&amp;
              Ipaddr.V4.compare pkt.Ipv4_packet.dst (Key_gen.host ()) = 0 -&gt;
            let src_port = Cstruct.BE.get_uint16 payload off
            and dst_port = Cstruct.BE.get_uint16 payload (off + 2)
            in
            (* Retrieve ttl and sent timestamp, encoded in the source port and
               destination port of the UDP packet we sent, and received back as
               ICMP payload. *)
            let ttl, sent = ttl_ts_of_ports src_port dst_port in
            (* Log this hop. *)
            t.log ttl sent src;
            (* Sent out the next UDP packet with an increased ttl. *)
            let ttl' = succ ttl in
            Logs.debug (fun m -&gt; m &quot;ICMP time exceeded from %a to %a, now sending with ttl %d&quot;
                           Ipaddr.V4.pp src Ipaddr.V4.pp dst ttl');
            t.send ttl'
          | Ok (pkt, _) -&gt;
            (* Some stray ICMP packet. *)
            Logs.debug (fun m -&gt; m &quot;unsolicited time exceeded from %a to %a (proto %X dst %a)&quot;
                           Ipaddr.V4.pp src Ipaddr.V4.pp dst pkt.Ipv4_packet.proto Ipaddr.V4.pp pkt.Ipv4_packet.dst);
            Lwt.return_unit
          | Error e -&gt;
            (* Decoding error. *)
            Logs.warn (fun m -&gt; m &quot;couldn't parse ICMP time exceeded payload (IPv4) (%a -&gt; %a) %s&quot;
                          Ipaddr.V4.pp src Ipaddr.V4.pp dst e);
            Lwt.return_unit
        end
      | Destination_unreachable when Ipaddr.V4.compare src (Key_gen.host ()) = 0 -&gt;
        (* We reached the final host, and the destination port was not listened to *)
        begin match Ipv4_packet.Unmarshal.header_of_cstruct payload with
          | Ok (_, off) -&gt;
            let src_port = Cstruct.BE.get_uint16 payload off
            and dst_port = Cstruct.BE.get_uint16 payload (off + 2)
            in
            (* Retrieve ttl and sent timestamp. *)
            let ttl, sent = ttl_ts_of_ports src_port dst_port in
            (* Log the final hop. *)
            t.log ttl sent src;
            (* Wakeup the waiter task to exit the unikernel. *)
            Lwt.wakeup t.task_done ();
            Lwt.return_unit
          | Error e -&gt;
            (* Decoding error. *)
            Logs.warn (fun m -&gt; m &quot;couldn't parse ICMP unreachable payload (IPv4) (%a -&gt; %a) %s&quot;
                          Ipaddr.V4.pp src Ipaddr.V4.pp dst e);
            Lwt.return_unit
        end
      | ty -&gt;
        Logs.debug (fun m -&gt; m &quot;ICMP unknown ty %s from %a to %a: %a&quot;
                       (ty_to_string ty) Ipaddr.V4.pp src Ipaddr.V4.pp dst
                       Cstruct.hexdump_pp payload);
        Lwt.return_unit
end
</code></pre>
<p>Now, the remaining main unikernel is the module <code>Main</code>:</p>
<pre><code class="language-OCaml">module Main (R : Mirage_random.S) (M : Mirage_clock.MCLOCK) (Time : Mirage_time.S) (N : Mirage_net.S) = struct
  module ETH = Ethernet.Make(N)
  module ARP = Arp.Make(ETH)(Time)
  module IPV4 = Static_ipv4.Make(R)(M)(ETH)(ARP)
  module UDP = Udp.Make(IPV4)(R)

  (* Global mutable state: the timeout task for a sent packet. *)
  let to_cancel = ref None

  (* Send a single packet with the given time to live. *)
  let rec send_udp udp ttl =
    (* This is called by the ICMP handler which successfully received a
       time exceeded, thus we cancel the timeout task. *)
    (match !to_cancel with
     | None -&gt; ()
     | Some t -&gt; Lwt.cancel t ; to_cancel := None);
    (* Our hop limit is 31 - 5 bit - should be sufficient for most networks. *)
    if ttl &gt; 31 then
      Lwt.return_unit
    else
      (* Create a timeout task which:
         - sleeps for --timeout interval
         - logs an unknown hop
         - sends another packet with increased ttl
      *)
      let cancel =
        Lwt.catch (fun () -&gt;
            Time.sleep_ns (Duration.of_ms (Key_gen.timeout ())) &gt;&gt;= fun () -&gt;
            Logs.info (fun m -&gt; m &quot;%2d  *&quot; ttl);
            send_udp udp (succ ttl))
          (function Lwt.Canceled -&gt; Lwt.return_unit | exc -&gt; Lwt.fail exc)
      in
      (* Assign this timeout task. *)
      to_cancel := Some cancel;
      (* Figure out which source and destination port to use, based on ttl
         and current timestamp. *)
      let src_port, dst_port = ports_of_ttl_ts ttl (M.elapsed_ns ()) in
      (* Send packet via UDP. *)
      UDP.write ~ttl ~src_port ~dst:(Key_gen.host ()) ~dst_port udp Cstruct.empty &gt;&gt;= function
      | Ok () -&gt; Lwt.return_unit
      | Error e -&gt; Lwt.fail_with (Fmt.strf &quot;while sending udp frame %a&quot; UDP.pp_error e)

  (* The main unikernel entry point. *)
  let start () () () net =
    let cidr = Key_gen.ipv4 ()
    and gateway = Key_gen.ipv4_gateway ()
    in
    let log_one = fun port ip -&gt; log_one (M.elapsed_ns ()) port ip
    (* Create a task to wait on and a waiter to wakeup. *)
    and t, w = Lwt.task ()
    in
    (* Setup network stack: ethernet, ARP, IPv4, UDP, and ICMP. *)
    ETH.connect net &gt;&gt;= fun eth -&gt;
    ARP.connect eth &gt;&gt;= fun arp -&gt;
    IPV4.connect ~cidr ~gateway eth arp &gt;&gt;= fun ip -&gt;
    UDP.connect ip &gt;&gt;= fun udp -&gt;
    let send = send_udp udp in
    Icmp.connect send log_one w &gt;&gt;= fun icmp -&gt;

    (* The callback cascade for an incoming network packet. *)
    let ethif_listener =
      ETH.input
        ~arpv4:(ARP.input arp)
        ~ipv4:(
          IPV4.input
            ~tcp:(fun ~src:_ ~dst:_ _ -&gt; Lwt.return_unit)
            ~udp:(fun ~src:_ ~dst:_ _ -&gt; Lwt.return_unit)
            ~default:(fun ~proto ~src ~dst buf -&gt;
                match proto with
                | 1 -&gt; Icmp.input icmp ~src ~dst buf
                | _ -&gt; Lwt.return_unit)
            ip)
        ~ipv6:(fun _ -&gt; Lwt.return_unit)
        eth
    in
    (* Start the callback in a separate asynchronous task. *)
    Lwt.async (fun () -&gt;
        N.listen net ~header_size:Ethernet_wire.sizeof_ethernet ethif_listener &gt;|= function
        | Ok () -&gt; ()
        | Error e -&gt; Logs.err (fun m -&gt; m &quot;netif error %a&quot; N.pp_error e));
    (* Send the initial UDP packet with a ttl of 1. This entails the domino
       effect to receive ICMP packets, send out another UDP packet with ttl
       increased by one, etc. - until a destination unreachable is received,
       or the hop limit is reached. *)
    send 1 &gt;&gt;= fun () -&gt;
    t
end
</code></pre>
<p>The configuration (<code>config.ml</code>) for this unikernel is as follows:</p>
<pre><code class="language-OCaml">open Mirage

let host =
  let doc = Key.Arg.info ~doc:&quot;The host to trace.&quot; [&quot;host&quot;] in
  Key.(create &quot;host&quot; Arg.(opt ipv4_address (Ipaddr.V4.of_string_exn &quot;141.1.1.1&quot;) doc))

let timeout =
  let doc = Key.Arg.info ~doc:&quot;Timeout (in millisecond)&quot; [&quot;timeout&quot;] in
  Key.(create &quot;timeout&quot; Arg.(opt int 1000 doc))

let ipv4 =
  let doc = Key.Arg.info ~doc:&quot;IPv4 address&quot; [&quot;ipv4&quot;] in
  Key.(create &quot;ipv4&quot; Arg.(required ipv4 doc))

let ipv4_gateway =
  let doc = Key.Arg.info ~doc:&quot;IPv4 gateway&quot; [&quot;ipv4-gateway&quot;] in
  Key.(create &quot;ipv4-gateway&quot; Arg.(required ipv4_address doc))

let main =
  let packages = [
    package ~sublibs:[&quot;ipv4&quot;; &quot;udp&quot;; &quot;icmpv4&quot;] &quot;tcpip&quot;;
    package &quot;ethernet&quot;;
    package &quot;arp-mirage&quot;;
    package &quot;mirage-protocols&quot;;
    package &quot;mtime&quot;;
  ] in
  foreign
    ~keys:[Key.abstract ipv4 ; Key.abstract ipv4_gateway ; Key.abstract host ; Key.abstract timeout]
    ~packages
    &quot;Unikernel.Main&quot;
    (random @-&gt; mclock @-&gt; time @-&gt; network @-&gt; job)

let () =
  register &quot;traceroute&quot;
    [ main $ default_random $ default_monotonic_clock $ default_time $ default_network ]
</code></pre>
<p>And voila, that's all the code. If you copy it together (or download the two
files from <a href="https://github.com/roburio/traceroute">the GitHub repository</a>),
and have OCaml, opam, and <a href="https://mirage.io/wiki/install">mirage (&gt;= 3.8.0)</a> installed,
you should be able to:</p>
<pre><code class="language-bash">$ mirage configure -t hvt
$ make depend
$ make
$ solo5-hvt --net:service=tap0 -- traceroute.hvt ...
... get the output shown at top ...
</code></pre>
<p>Enhancements may be to use a different protocol (TCP? or any other protocol ID (may be used to encode more information), encode data into IPv4 ID, or the full 8 bytes of the upper protocol), encrypt/authenticate the data transmitted (and verify it has not been tampered with in the ICMP reply), improve error handling and recovery, send multiple packets for improved round trip time measurements, ...</p>
<p>If you develop enhancements you'd like to share, please sent a pull request to the git repository.</p>
<p>Motivation for this traceroute unikernel was while talking with <a href="https://twitter.com/networkservice">Aaron</a> and <a href="https://github.com/phaer">Paul</a>, who contributed several patches to the IP stack which pass the ttl through.</p>
<p>If you want to support our work on MirageOS unikernels, please <a href="https://robur.coop/Donate">donate to robur</a>. I'm interested in feedback, either via <a href="https://twitter.com/h4nnes">twitter</a>, <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|Really low latency multipliers and cryptographic puzzles|js}
  ; slug = {js|really-low-latency-multipliers-and-cryptographic-puzzles|js}
  ; description = Some {js|At Jane Street, we have some experience using FPGAs for low-latencysystems–FPGAs are programmable hardware where you get the speed of anapplication-specific ...|js}
  ; url = {js|https://blog.janestreet.com/really-low-latency-multipliers-and-cryptographic-puzzles/|js}
  ; date = {js|2020-06-22T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/really-low-latency-multipliers-and-cryptographic-puzzles/lock.png|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, we have some experience using FPGAs for low-latency
systems&ndash;FPGAs are programmable hardware where you get the speed of an
application-specific integrated circuit (ASIC) but without being
committed to a design that&rsquo;s burned into the chip. It wasn&rsquo;t so long
ago that FPGAs were expensive and rare, but these days, you can rent a
$5,000 card on the Amazon AWS cloud for less than $3 an hour.</p>|js}
  };
 
  { title = {js|Using ASCII waveforms to test hardware designs|js}
  ; slug = {js|using-ascii-waveforms-to-test-hardware-designs|js}
  ; description = Some {js|At Jane Street, an “expecttest” is atest where you don’t manually write the output you’d like to checkyour code against – instead, this output is captured au...|js}
  ; url = {js|https://blog.janestreet.com/using-ascii-waveforms-to-test-hardware-designs/|js}
  ; date = {js|2020-06-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/using-ascii-waveforms-to-test-hardware-designs/scientist_testing.jpg|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, an <a href="https://blog.janestreet.com/testing-with-expectations">&ldquo;expect
test&rdquo;</a> is a
test where you don&rsquo;t manually write the output you&rsquo;d like to check
your code against &ndash; instead, this output is captured automatically
and inserted by a tool into the testing code itself. If further runs
produce different output, the test fails, and you&rsquo;re presented with
the diff.</p>|js}
  };
 
  { title = {js|The future of Tezos on MirageOS|js}
  ; slug = {js|the-future-of-tezos-on-mirageos|js}
  ; description = Some {js|We are very glad to announce that Tarides has been awarded two new grants from
the Tezos Foundation. Thanks to these new grants, Tarides…|js}
  ; url = {js|https://tarides.com/blog/2020-04-20-the-future-of-tezos-on-mirageos|js}
  ; date = {js|2020-04-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/bb44e4615f4730d8692d1214f5b238a3/0d665/tezosgrants.png|js}
  ; featured = false
  ; body_html = {js|<p>We are very glad to announce that Tarides has been awarded two new grants from
the Tezos Foundation.</p>
<p>Thanks to these new grants, Tarides will continue to work on the integration
between Tezos and MirageOS. We believe that the secure deployment of blockchains
is still a major challenge today, and that deploying Tezos as a unikernel will
have a big impact in term of safety and security. It will be a key
differentiator that will separate Tezos from other blockchains.</p>
<p>The Tezos codebase is written in OCaml and is currently using more than 100
external packages, among which one third comes from the MirageOS project.
However, it still heavily depends on non-compatible Unix libraries. Making the
Tezos codebase fully compatible with MirageOS will help Tezos with: distribution
and packaging, portability, secure deployment and operational safety.</p>
<p>We&rsquo;ll regularly publish development progress updates, so stay tuned!</p>|js}
  };
 
  { title = {js|Chrome extensions: Finding the missing proof|js}
  ; slug = {js|chrome-extensions-finding-the-missing-proof|js}
  ; description = Some {js|Web browsers have supported customplug-ins andextensions sincethe 1990s, giving users the ability to add their own features andtools for improving workflow o...|js}
  ; url = {js|https://blog.janestreet.com/chrome-extensions-finding-the-missing-proof/|js}
  ; date = {js|2020-04-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/chrome-extensions-finding-the-missing-proof/magnifying-glass.png|js}
  ; featured = false
  ; body_html = {js|<p>Web browsers have supported custom
<a href="https://en.wikipedia.org/wiki/NPAPI">plug-ins</a> and
<a href="https://en.wikipedia.org/wiki/Browser_extension">extensions</a> since
the 1990s, giving users the ability to add their own features and
tools for improving workflow or building closer integration with
applications or databases running on back-end servers.</p>|js}
  };
 
  { title = {js|Watch all of Jane Street's tech talks|js}
  ; slug = {js|watch-all-of-jane-streets-tech-talks|js}
  ; description = Some {js|Jane Street has been posting tech talks from internal speakers andinvited guests for years—and they’re all available on our YouTubechannel:|js}
  ; url = {js|https://blog.janestreet.com/watch-all-of-jane-streets-tech-talks/|js}
  ; date = {js|2020-02-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/watch-all-of-jane-streets-tech-talks/youtube-techtalks.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street has been posting tech talks from internal speakers and
invited guests for years&mdash;and they&rsquo;re all available on our YouTube
channel:</p>|js}
  };
 
  { title = {js|Troubleshooting systemd with SystemTap|js}
  ; slug = {js|troubleshooting-systemd-with-systemtap|js}
  ; description = Some {js|When we set up a schedule on a computer, such as a list of commands torun every day at particular times via Linux cronjobs, weexpect that schedule to execute...|js}
  ; url = {js|https://blog.janestreet.com/troubleshooting-systemd-with-systemtap/|js}
  ; date = {js|2020-02-03T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/troubleshooting-systemd-with-systemtap/data-taps.jpg|js}
  ; featured = false
  ; body_html = {js|<p>When we set up a schedule on a computer, such as a list of commands to
run every day at particular times via Linux <a href="https://www.ostechnix.com/a-beginners-guide-to-cron-jobs">cron
jobs</a>, we
expect that schedule to execute reliably.  Of course we&rsquo;ll check the
logs to see whether the job has failed, but we never question whether
the cron daemon itself will function.  We always assume that it will,
as it always has done; we are not expecting mutiny in the ranks of the
operating system.</p>|js}
  };
 
  { title = {js|Deploying authoritative OCaml-DNS servers as MirageOS unikernels|js}
  ; slug = {js|deploying-authoritative-ocaml-dns-servers-as-mirageos-unikernels|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/DnsServer|js}
  ; date = {js|2019-12-23T21:30:53-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Goal</h2>
<p>Have your domain served by OCaml-DNS authoritative name servers. Data is stored in a git remote, and let's encrypt certificates can be requested to DNS. This software is deployed since more than two years for several domains such as <code>nqsb.io</code> and <code>robur.coop</code>. This present the authoritative server side, and certificate library of the OCaml-DNS implementation formerly known as <a href="https://hannes.robur.coop/Posts/DNS">&micro;DNS</a>.</p>
<h2>Prerequisites</h2>
<p>You need to own a domain, and be able to delegate the name service to your own servers.
You also need two spare public IPv4 addresses (in different /24 networks) for your name servers.
A git server or remote repository reachable via git over ssh.
Servers which support <a href="https://github.com/solo5/solo5">solo5</a> guests, and have the corresponding tender installed.
A computer with <a href="https://opam.ocaml.org">opam</a> (&gt;= 2.0.0) installed.</p>
<h2>Data preparation</h2>
<p>Figure out a way to get the DNS entries of your domain in a <a href="https://tools.ietf.org/html/rfc1034">&quot;master file format&quot;</a>, i.e. what bind uses.</p>
<p>This is a master file for the <code>mirage</code> domain, defining <code>$ORIGIN</code> to avoid typing the domain name after each hostname (use <code>@</code> if you need the domain name only; if you need to refer to a hostname in a different domain end it with a dot (<code>.</code>), i.e. <code>ns2.foo.com.</code>). The default time to live <code>$TTL</code> is an hour (3600 seconds).
The zone contains a <a href="https://tools.ietf.org/html/rfc1035#section-3.3.13">start of authority (<code>SOA</code>) record</a> containing the nameserver, hostmaster, serial, refresh, retry, expiry, and minimum.
Also, a single <a href="https://tools.ietf.org/html/rfc1035#section-3.3.11">name server (<code>NS</code>) record</a> <code>ns1</code> is specified with an accompanying <a href="https://tools.ietf.org/html/rfc1035#section-3.4.1">address (<code>A</code>) records</a> pointing to their IPv4 address.</p>
<pre><code class="language-shell">git-repo&gt; cat mirage
$ORIGIN mirage.
$TTL 3600
@	SOA	ns1	hostmaster	1	86400	7200	1048576	3600
@	NS	ns1
ns1     A       127.0.0.1
www	A	1.1.1.1
git-repo&gt; git add mirage &amp;&amp; git commit -m initial &amp;&amp; git push
</code></pre>
<h2>Installation</h2>
<p>On your development machine, you need to install various OCaml packages. You don't need privileged access if common tools (C compiler, make, libgmp) are already installed. You have <code>opam</code> installed.</p>
<p>Let's create a fresh <code>switch</code> for the DNS journey:</p>
<pre><code class="language-shell">$ opam init
$ opam update
$ opam switch create udns 4.09.0
# waiting a bit, a fresh OCaml compiler is getting bootstrapped
$ eval `opam env` #sets some environment variables
</code></pre>
<p>The last command set environment variables in your current shell session, please use the same shell for the commands following (or run <code>eval $(opam env)</code> in another shell and proceed in there - the output of <code>opam switch</code> sohuld point to <code>udns</code>).</p>
<h3>Validation of our zonefile</h3>
<p>First let's check that OCaml-DNS can parse our zonefile:</p>
<pre><code class="language-shell">$ opam install dns-cli #installs ~/.opam/udns/bin/ozone and other binaries
$ ozone &lt;git-repo&gt;/mirage # see ozone --help
successfully checked zone
</code></pre>
<p>Great. Error reporting is not great, but line numbers are indicated (<code>ozone: zone parse problem at line 3: syntax error</code>), <a href="https://github.com/mirage/ocaml-dns/tree/v4.2.0/zone">lexer and parser are lex/yacc style</a> (PRs welcome).</p>
<p>FWIW, <code>ozone</code> accepts <code>--old &lt;filename&gt;</code> to check whether an update from the old zone to the new is fine. This can be used as <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">pre-commit hook</a> in your git repository to avoid bad parse states in your name servers.</p>
<h3>Getting the primary up</h3>
<p>The next step is to compile the primary server and run it to serve the domain data. Since the git-via-ssh client is not yet released, we need to add a custom opam repository to this switch.</p>
<pre><code class="language-shell"># git via ssh is not yet released, but this opam repository contains the branch information
$ opam repo add git-ssh git+https://github.com/roburio/git-ssh-dns-mirage3-repo.git
# get the `mirage` application via opam
$ opam install lwt mirage

# get the source code of the unikernels
$ git clone -b future https://github.com/roburio/unikernels.git
$ cd unikernels/primary-git

# let's build the server first as unix application
$ mirage configure --prng fortuna #--no-depext if you have all system dependencies
$ make depend
$ make

# run it
$ ./primary_git
# starts a unix process which clones https://github.com/roburio/udns.git
# attempts to parse the data as zone files, and fails on parse error
$ ./primary-git --remote=https://my-public-git-repository
# this should fail with ENOACCESS since the DNS server tries to listen on port 53

# which requires a privileged user, i.e. su, sudo or doas
$ sudo ./primary-git --remote=https://my-public-git-repository
# leave it running, run the following programs in a different shell

# test it
$ host ns1.mirage 127.0.0.1
ns1.mirage has address 127.0.0.1
$ dig any mirage @127.0.0.1
# a DNS packet printout with all records available for mirage
</code></pre>
<p>That's exciting, the DNS server serving answers from a remote git repository.</p>
<h3>Securing the git access with ssh</h3>
<p>Let's authenticate the access by using ssh, so we feel ready to push data there as well. The primary-git unikernel already includes an experimental <a href="https://github.com/haesbaert/awa-ssh">ssh client</a>, all we need to do is setting up credentials - in the following a RSA keypair and the server fingerprint.</p>
<pre><code class="language-shell"># collect the RSA host key fingerprint
$ ssh-keyscan &lt;git-server&gt; &gt; /tmp/git-server-public-keys
$ ssh-keygen -l -E sha256 -f /tmp/git-server-public-keys | grep RSA
2048 SHA256:a5kkkuo7MwTBkW+HDt4km0gGPUAX0y1bFcPMXKxBaD0 &lt;git-server&gt; (RSA)
# we're interested in the SHA256:yyy only

# generate a ssh keypair
$ awa_gen_key # installed by the make depend step above in ~/.opam/udns/bin
seed is pIKflD07VT2W9XpDvqntcmEW3OKlwZL62ak1EZ0m
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5b2cSSkZ5/MAu7pM6iJLOaX9tJsfA8DB1RI34Zygw6FA0y8iisbqGCv6Z94ZxreGATwSVvrpqGo5p0rsKs+6gQnMCU1+sOC4PRlxy6XKgj0YXvAZcQuxwmVQlBHshuq0CraMK9FASupGrSO8/dW30Kqy1wmd/IrqW9J1Cnw+qf0C/VEhIbo7btlpzlYpJLuZboTvEk1h67lx1ZRw9bSPuLjj665yO8d0caVIkPp6vDX20EsgITdg+cFjWzVtOciy4ETLFiKkDnuzHzoQ4EL8bUtjN02UpvX2qankONywXhzYYqu65+edSpogx2TuWFDJFPHgcyO/ZIMoluXGNgQlP awa@awa.local
# please run your own awa_gen_key, don't use the numbers above
</code></pre>
<p>The public key needs is in standard OpenSSH format and needs to be added to the list of accepted keys on your server - the exact steps depend on your git server, if you're running your own with <a href="https://github.com/tv42/gitosis">gitosis</a>, add it as new public key file and grant that key access to the data repository. If you use gitlab or github, you may want to create a new user account and with the generated key.</p>
<p>The private key is not displayed, but only the seed required to re-generate it, when using the same random number generator, in our case <a href="http://mirleft.github.io/ocaml-nocrypto/doc/Nocrypto.Rng.html">fortuna implemented by nocrypto</a> - used by both <code>awa_gen_key</code> and <code>primary_git</code>. The seed is provided as command-line argument while starting <code>primary_git</code>:</p>
<pre><code class="language-shell"># execute with git over ssh, authenticator from ssh-keyscan, seed from awa_gen_key
$ ./primary_git --authenticator=SHA256:a5kkkuo7MwTBkW+HDt4km0gGPUAX0y1bFcPMXKxBaD0 --seed=pIKflD07VT2W9XpDvqntcmEW3OKlwZL62ak1EZ0m --remote=ssh://git@&lt;git-server&gt;/repo-name.git
# started up, you can try the host and dig commands from above if you like
</code></pre>
<p>To wrap up, we now have a primary authoritative name server for our zone running as Unix process, which clones a remote git repository via ssh on startup and then serves it.</p>
<h3>Authenticated data updates</h3>
<p>Our remote git repository is the source of truth, if you need to add a DNS entry to the zone, you git pull, edit the zone file, remember to increase the serial in the SOA line, run <code>ozone</code>, git commit and push to the repository.</p>
<p>So, the <code>primary_git</code> needs to be informed of git pushes. This requires a communication channel from the git server (or somewhere else, e.g. your laptop) to the DNS server. I prefer in-protocol solutions over adding yet another protocol stack, no way my DNS server will talk HTTP REST.</p>
<p>The DNS protocol has an extension for <a href="https://tools.ietf.org/html/rfc1996">notifications of zone changes</a> (as a DNS packet), usually used between the primary and secondary servers. The <code>primary_git</code> accepts these notify requests (i.e. bends the standard slightly), and upon receival pulls the remote git repository, and serves the fresh zone files. Since a git pull may be rather excessive in terms of CPU cycles and network bandwidth, only authenticated notifications are accepted.</p>
<p>The DNS protocol specifies in another extension <a href="https://tools.ietf.org/html/rfc2845">authentication (DNS TSIG)</a> with transaction signatures on DNS packets including a timestamp and fudge to avoid replay attacks. As key material hmac secrets distribued to both the communication endpoints are used.</p>
<p>To recap, the primary server is configured with command line parameters (for remote repository url and ssh credentials), and serves data from a zonefile. If the secrets would be provided via command line, a restart would be necessary for adding and removing keys. If put into the zonefile, they would be publicly served on request. So instead, we'll use another file, still in zone file format, in the top-level domain <code>_keys</code>, i.e. the <code>mirage._keys</code> file contains keys for the <code>mirage</code> zone. All files ending in <code>._keys</code> are parsed with the normal parser, but put into an authentication store instead of the domain data store, which is served publically.</p>
<p>For encoding hmac secrets into DNS zone file format, the <a href="https://tools.ietf.org/html/rfc4034#section-2"><code>DNSKEY</code></a> format is used (designed for DNSsec). The <a href="https://www.isc.org/bind/">bind</a> software comes with <code>dnssec-keygen</code> and <code>tsig-keygen</code> to generate DNSKEY output: flags is 0, protocol is 3, and algorithm identifier for SHA256 is 163 (SHA384 164, SHA512 165). This is reused by the OCaml DNS library. The key material itself is base64 encoded.</p>
<p>Access control and naming of keys follows the DNS domain name hierarchy - a key has the form name._operation.domain, and has access granted to domain and all subdomains of it. Two operations are supported: update and transfer. In the future there may be a dedicated notify operation, for now we'll use update. The name part is ignored for the update operation.</p>
<p>Since we now embedd secret information in the git repository, it is a good idea to restrict access to it, i.e. make it private and not publicly cloneable or viewable. Let's generate a first hmac secret and send a notify:</p>
<pre><code class="language-shell">$ dd if=/dev/random bs=1 count=32 | b64encode -
begin-base64 644 -
kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
====
[..]
git-repo&gt; echo &quot;personal._update.mirage. DNSKEY 0 3 163 kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=&quot; &gt; mirage._keys
git-repo&gt; git add mirage._keys &amp;&amp; git commit -m &quot;add hmac secret&quot; &amp;&amp; git push

# now we need to restart the primary git to get the git repository with the key
$ ./primary_git --seed=... # arguments from above, remote git, host key fingerprint, private key seed

# now test that a notify results in a git pull
$ onotify 127.0.0.1 mirage --key=personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
# onotify was installed by dns-cli in ~/.opam/udns/bin/onotify, see --help for options
# further changes to the hmac secrets don't require a restart anymore, a notify packet is sufficient :D
</code></pre>
<p>Ok, this onotify command line could be setup as a git post-commit hook, or run manually after each manual git push.</p>
<h3>Secondary</h3>
<p>It's time to figure out how to integrate the secondary name server. An already existing bind or something else that accepts notifications and issues zone transfers with hmac-sha256 secrets should work out of the box. If you encounter interoperability issues, please get in touch with me.</p>
<p>The <code>secondary</code> subdirectory of the cloned <code>unikernels</code> repository is another unikernel that acts as secondary server. It's only command line argument is a list of hmac secrets used for authenticating that the received data originates from the primary server. Data is initially transferred by a <a href="https://tools.ietf.org/html/rfc5936">full zone transfer (AXFR)</a>, later updates (upon refresh timer or notify request sent by the primary) use <a href="https://tools.ietf.org/html/rfc1995">incremental (IXFR)</a>. Zone transfer requests and data are authenticated with transaction signatures again.</p>
<p>Convenience by OCaml DNS is that transfer key names matter, and are of the form <primary-ip>.<secondary-ip>._transfer.domain, i.e. <code>1.1.1.1.2.2.2.2._transfer.mirage</code> if the primary server is 1.1.1.1, and the secondary 2.2.2.2. Encoding the IP address in the name allows both parties to start the communication: the secondary starts by requesting a SOA for all domains for which keys are provided on command line, and if an authoritative SOA answer is received, the AXFR is triggered. The primary server emits notification requests on startup and then on every zone change (i.e. via git pull) to all secondary IP addresses of transfer keys present for the specific zone in addition to the notifications to the NS records in the zone.</secondary-ip></primary-ip></p>
<pre><code class="language-shell">$ cd ../secondary
$ mirage configure --prng fortuna
# make depend should not be needed since all packages are already installed by the primary-git
$ make
$ ./secondary
</code></pre>
<h3>IP addresses and routing</h3>
<p>Both primary and secondary serve the data on the DNS port (53) on UDP and TCP. To run both on the same machine and bind them to different IP addresses, we'll use a layer 2 network (ethernet frames) with a host system software switch (bridge interface <code>service</code>), the unikernels as virtual machines (or seccomp-sandboxed) via the <a href="https://github.com/solo5/solo5">solo5</a> backend. Using xen is possible as well. As IP address range we'll use 10.0.42.0/24, and the host system uses the 10.0.42.1.</p>
<p>The primary git needs connectivity to the remote git repository, thus on a laptop in a private network we need network address translation (NAT) from the bridge where the unikernels speak to the Internet where the git repository resides.</p>
<pre><code class="language-shell"># on FreeBSD:
# configure NAT with pf, you need to have forwarding enabled
$ sysctl net.inet.ip.forwarding: 1
$ echo 'nat pass on wlan0 inet from 10.0.42.0/24 to any -&gt; (wlan0)' &gt;&gt; /etc/pf.conf
$ service pf restart

# make tap interfaces UP on open()
$ sysctl net.link.tap.up_on_open: 1

# bridge creation, naming, and IP setup
$ ifconfig bridge create
bridge0
$ ifconfig bridge0 name service
$ ifconfig bridge0 10.0.42.1/24

# two tap interfaces for our unikernels
$ ifconfig tap create
tap0
$ ifconfig tap create
tap1
# add them to the bridge
$ ifconfig service addm tap0 addm tap1
</code></pre>
<h3>Primary and secondary setup</h3>
<p>Let's update our zone slightly to reflect the IP changes.</p>
<pre><code class="language-shell">git-repo&gt; cat mirage
$ORIGIN mirage.
$TTL 3600
@	SOA	ns1	hostmaster	2	86400	7200	1048576	3600
@	NS	ns1
@	NS	ns2
ns1     A       10.0.42.2
ns2	A	10.0.42.3

# we also need an additional transfer key
git-repo&gt; cat mirage._keys
personal._update.mirage. DNSKEY 0 3 163 kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
10.0.42.2.10.0.42.3._transfer.mirage. DNSKEY 0 3 163 cDK6sKyvlt8UBerZlmxuD84ih2KookJGDagJlLVNo20=
git-repo&gt; git commit -m &quot;udpates&quot; . &amp;&amp; git push
</code></pre>
<p>Ok, the git repository is ready, now we need to compile the unikernels for the virtualisation target (see <a href="https://mirage.io/wiki/hello-world#Building-for-Another-Backend">other targets</a> for further information).</p>
<pre><code class="language-shell"># back to primary
$ cd ../primary-git
$ mirage configure -t hvt --prng fortuna # or e.g. -t spt (and solo5-spt below)
# installs backend-specific opam packages, recompiles some
$ make depend
$ make
[...]
$ solo5-hvt --net:service=tap0 -- primary_git.hvt --ipv4=10.0.42.2/24 --ipv4-gateway=10.0.42.1 --seed=.. --authenticator=.. --remote=ssh+git://...
# should now run as a virtual machine (kvm, bhyve), and clone the git repository
$ dig any mirage @10.0.42.2
# should reply with the SOA and NS records, and also the name server address records in the additional section

# secondary
$ cd ../secondary
$ mirage configure -t hvt --prng fortuna
$ make
$ solo5-hvt --net:service=tap1 -- secondary.hvt --ipv4=10.0.42.3/24 --keys=10.0.42.2.10.0.42.3._transfer.mirage:SHA256:cDK6sKyvlt8UBerZlmxuD84ih2KookJGDagJlLVNo20=
# an ipv4-gateway is not needed in this setup, but in real deployment later
# it should start up and transfer the mirage zone from the primary

$ dig any mirage @10.0.42.3
# should now output the same information as from 10.0.42.2

# testing an update and propagation
# edit mirage zone, add a new record and increment the serial number
git-repo&gt; echo &quot;foo A 127.0.0.1&quot; &gt;&gt; mirage
git-repo&gt; vi mirage &lt;- increment serial
git-repo&gt; git commit -m 'add foo' . &amp;&amp; git push
$ onotify 10.0.42.2 mirage --key=personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=

# now check that it worked
$ dig foo.mirage @10.0.42.2 # primary
$ dig foo.mirage @10.0.42.3 # secondary got notified and transferred the zone
</code></pre>
<p>You can also check the behaviour when restarting either of the VMs, whenever the primary is available the zone is synchronised. If the primary is down, the secondary still serves the zone. When the secondary is started while the primary is down, it won't serve any data until the primary is online (the secondary polls periodically, the primary sends notifies on startup).</p>
<h3>Dynamic data updates via DNS, pushed to git</h3>
<p>DNS is a rich protocol, and it also has builtin <a href="https://tools.ietf.org/html/rfc2136">updates</a> that are supported by OCaml DNS, again authenticated with hmac-sha256 and shared secrets. Bind provides the command-line utility <code>nsupdate</code> to send these update packets, a simple <code>oupdate</code> unix utility is available as well (i.e. for integration of dynamic DNS clients). You know the drill, add a shared secret to the primary, git push, notify the primary, and voila we can dynamically in-protocol update. An update received by the primary via this way will trigger a git push to the remote git repository, and notifications to the secondary servers as described above.</p>
<pre><code class="language-shell"># being lazy, I reuse the key above
$ oupdate 10.0.42.2 personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg= my-other.mirage 1.2.3.4

# let's observe the remote git
git-repo&gt; git pull
# there should be a new commit generated by the primary
git-repo&gt; git log

# test it, should return 1.2.3.4
$ dig my-other.mirage @10.0.42.2
$ dig my-other.mirage @10.0.42.3
</code></pre>
<p>So we can deploy further <code>oupdate</code> (or <code>nsupdate</code>) clients, distribute hmac secrets, and have the DNS zone updated. The source of truth is still the git repository, where the primary-git pushes to. Merge conflicts and timing of pushes is not yet dealt with. They are unlikely to happen since the primary is notified on pushes and should have up-to-date data in storage. Sorry, I'm unsure about the error semantics, try it yourself.</p>
<h3>Let's encrypt!</h3>
<p><a href="https://letsencrypt.org/">Let's encrypt</a> is a certificate authority (CA), which certificate is shipped as trust anchor in web browsers. They specified a protocol for <a href="https://tools.ietf.org/html/draft-ietf-acme-acme-05">automated certificate management environment (ACME)</a>, used to get X509 certificates for your services. In the protocol, a certificate signing request (publickey and hostname) is sent to let's encrypt servers, which sends a challenge to proof the ownership of the hostnames. One widely-used way to solve this challenge is running a web server, another is to serve it as text record from the authoritative DNS server.</p>
<p>Since I avoid persistent storage when possible, and also don't want to integrate a HTTP client stack in the primary server, I developed a third unikernel that acts as (hidden) secondary server, performs the tedious HTTP communication with let's encrypt servers, and stores all data in the public DNS zone.</p>
<p>For encoding of certificates, the DANE working group specified <a href="https://tools.ietf.org/html/rfc6698.html#section-7.1">TLSA</a> records in DNS. They are quadruples of usage, selector, matching type, and ASN.1 DER-encoded material. We set usage to 3 (domain-issued certificate), matching type to 0 (no hash), and selector to 0 (full certificate) or 255 (private usage) for certificate signing requests. The interaction is as follows:</p>
<ol>
<li>Primary, secondary, and let's encrypt unikernels are running
</li>
<li>A service (<code>ocertify</code>, <code>unikernels/certificate</code>, or the <code>dns-certify.mirage</code> library) demands a TLS certificate, and has a hmac-secret for the primary DNS
</li>
<li>The service generates a certificate signing request with the desired hostname(s), and performs an nsupdate with TLSA 255 <der encoded="encoded" signing-request="signing-request">
</der></li>
<li>The primary accepts the update, pushes the new zone to git, and sends notifies to secondary and let's encrypt unikernels which (incrementally) transfer the zone
</li>
<li>The let's encrypt unikernel notices while transferring the zone a signing request without a certificate, starts HTTP interaction with let's encrypt
</li>
<li>The let's encrypt unikernel solves the challenge, sends the response as update of a TXT record to the primary nameserver
</li>
<li>The primary pushes the TXT record to git, and notifies secondaries (which transfer the zone)
</li>
<li>The let's encrypt servers request the TXT record from either or both authoritative name servers
</li>
<li>The let's encrypt unikernel polls for the issued certificate and send an update to the primary TLSA 0 <der encoded="encoded" certificate="certificate">
</der></li>
<li>The primary pushes the certificate to git, notifies secondaries (which transfer the zone)
</li>
<li>The service polls TLSA records for the hostname, and use it upon retrieval
</li>
</ol>
<p>Note that neither the signing request nor the certificate contain private key material, thus it is fine to serve them publically. Please also note, that the service polls for the certificate for the hostname in DNS, which is valid (start and end date) certificate and uses the same public key, this certificate is used and steps 3-10 are not executed.</p>
<p>The let's encrypt unikernel does not serve anything, it is a reactive system which acts upon notification from the primary. Thus, it can be executed in a private address space (with a NAT). Since the OCaml DNS server stack needs to push notifications to it, it preserves all incoming signed SOA requests as candidates for notifications on update. The let's encrypt unikernel ensures to always have a connection to the primary to receive notifications.</p>
<pre><code class="language-shell"># getting let's encrypt up and running
$ cd ../lets-encrypt
$ mirage configure -t hvt --prng fortuna
$ make depend
$ make

# run it
$ solo5-hvt --net:service=tap2 -- letsencrypt.hvt --keys=...

# test it
$ ocertify 10.0.42.2 foo.mirage
</code></pre>
<p>For actual testing with let's encrypt servers you need to have the primary and secondary deployed on your remote hosts, and your domain needs to be delegated to these servers. Good luck. And ensure you have backup your git repository.</p>
<p>As fine print, while this tutorial was about the <code>mirage</code> zone, you can stick any number of zones into the git repository. If you use a <code>_keys</code> file (without any domain prefix), you can configure hmac secrets for all zones, i.e. something to use in your let's encrypt unikernel and secondary unikernel. Dynamic addition of zones is supported, just create a new zonefile and notify the primary, the secondary will be notified and pick it up. The primary responds to a signed SOA for the root zone (i.e. requested by the secondary) with the SOA response (not authoritative), and additionally notifications for all domains of the primary.</p>
<h3>Conclusion and thanks</h3>
<p>This tutorial presented how to use the OCaml DNS based unikernels to run authoritative name servers for your domain, using a git repository as the source of truth, dynamic authenticated updates, and let's encrypt certificate issuing.</p>
<p>There are further steps to take, such as monitoring -- have a look at the <code>monitoring</code> branch of the opam repository above, and the <code>future-robur</code> branch of the unikernels repository above, which use a second network interface for reporting syslog and metrics to telegraf / influx / grafana. Some DNS features are still missing, most prominently DNSSec.</p>
<p>I'd like to thank all people involved in this software stack, without other key components, including <a href="https://github.com/mirage/ocaml-git">git</a>, <a href="https://irmin.io/">irmin 2.0</a>, <a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a>, <a href="https://github.com/haesbaert/awa-ssh">awa-ssh</a>, <a href="https://github.com/mirage/ocaml-cohttp">cohttp</a>, <a href="https://github.com/solo5/sol5">solo5</a>, <a href="https://github.com/mirage/mirage">mirage</a>, <a href="https://github.com/mmaker/ocaml-letsencrypt">ocaml-letsencrypt</a>, and more.</p>
<p>If you want to support our work on MirageOS unikernels, please <a href="https://robur.coop/Donate">donate to robur</a>. I'm interested in feedback, either via <a href="https://twitter.com/h4nnes">twitter</a>, <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|Reproducible MirageOS unikernel builds|js}
  ; slug = {js|reproducible-mirageos-unikernel-builds|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/ReproducibleOPAM|js}
  ; date = {js|2019-12-16T18:29:30-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Reproducible builds summit</h2>
<p>I'm just back from the <a href="https://reproducible-builds.org/events/Marrakesh2019/">Reproducible builds summit 2019</a>. In 2018, several people developing <a href="https://ocaml.org">OCaml</a> and <a href="https://opam.ocaml.org">opam</a> and <a href="https://mirage.io">MirageOS</a>, attended <a href="https://reproducible-builds.org/events/paris2018/">the Reproducible builds summit in Paris</a>. The notes from last year on <a href="https://reproducible-builds.org/events/paris2018/report/#Toc11410_331763073">opam reproducibility</a> and <a href="https://reproducible-builds.org/events/paris2018/report/#Toc11681_331763073">MirageOS reproducibility</a> are online. After last years workshop, Raja started developing the opam reproducibilty builder <a href="https://github.com/rjbou/orb">orb</a>, which I extended at and after this years summit. This year before and after the facilitated summit there were hacking days, which allowed further interaction with participants, writing some code and conduct experiments. I had this year again an exciting time at the summit and hacking days, thanks to our hosts, organisers, and all participants.</p>
<h2>Goal</h2>
<p>Stepping back a bit, first look on the <a href="https://reproducible-builds.org/">goal of reproducible builds</a>: when compiling source code multiple times, the produced binaries should be identical. It should be sufficient if the binaries are behaviourally equal, but this is pretty hard to check. It is much easier to check <strong>bit-wise identity of binaries</strong>, and relaxes the burden on the checker -- checking for reproducibility is reduced to computing the hash of the binaries. Let's stick to the bit-wise identical binary definition, which also means software developers have to avoid non-determinism during compilation in their toolchains, dependent libraries, and developed code.</p>
<p>A <a href="https://reproducible-builds.org/docs/test-bench/">checklist</a> of potential things leading to non-determinism has been written up by the reproducible builds project. Examples include recording the build timestamp into the binary, ordering of code and embedded data. The reproducible builds project also developed <a href="https://packages.debian.org/sid/disorderfs">disorderfs</a> for testing reproducibility and <a href="https://diffoscope.org/">diffoscope</a> for comparing binaries with file-dependent readers, falling back to <code>objdump</code> and <code>hexdump</code>. A giant <a href="https://tests.reproducible-builds.org/">test infrastructure</a> with <a href="https://tests.reproducible-builds.org/debian/index_variations.html">lots of variations</a> between the builds, mostly using Debian, has been setup over the years.</p>
<p>Reproducibility is a precondition for trustworthy binaries. See <a href="https://reproducible-builds.org/#why-does-it-matter">why does it matter</a>. If there are no instructions how to get from the published sources to the exact binary, why should anyone trust and use the binary which claims to be the result of the sources? It may as well contain different code, including a backdoor, bitcoin mining code, outputting the wrong results for specific inputs, etc. Reproducibility does not imply the software is free of security issues or backdoors, but instead of a audit of the binary - which is tedious and rarely done - the source code can be audited - but the toolchain (compiler, linker, ..) used for compilation needs to be taken into account, i.e. trusted or audited to not be malicious. <strong>I will only ever publish binaries if they are reproducible</strong>.</p>
<p>My main interest at the summit was to enhance existing tooling and conduct some experiments about the reproducibility of <a href="https://mirage.io">MirageOS unikernels</a> -- a unikernel is a statically linked ELF binary to be run as Unix process or <a href="https://github.com/solo5/solo5">virtual machine</a>. MirageOS heavily uses <a href="https://ocaml.org">OCaml</a> and <a href="https://opam.ocaml.org">opam</a>, the OCaml package manager, and is an opam package itself. Thus, <em>checking reproducibility of a MirageOS unikernel is the same problem as checking reproducibility of an opam package</em>.</p>
<h2>Reproducible builds with opam</h2>
<p>Testing for reproducibility is achieved by taking the sources and compile them twice independently. Afterwards the equality of the resulting binaries can be checked. In trivial projects, the sources is just a single file, or originate from a single tarball. In OCaml, opam uses <a href="https://github.com/ocaml/opam-repository">a community repository</a> where OCaml developers publish their package releases to, but can also use custom repositores, and in addition pin packages to git remotes (url including branch or commit), or a directory on the local filesystem. Manually tracking and updating all dependent packages of a MirageOS unikernel is not feasible: our hello-world compiled for hvt (kvm/BHyve) already has 79 opam dependencies, including the OCaml compiler which is distribued as opam package. The unikernel serving this website depends on 175 opam packages.</p>
<p>Conceptually there should be two tools, the <em>initial builder</em>, which takes the latest opam packages which do not conflict, and exports exact package versions used during the build, as well as hashes of binaries. The other tool is a <em>rebuilder</em>, which imports the export, conducts a build, and outputs the hashes of the produced binaries.</p>
<p>Opam has the concept of a <code>switch</code>, which is an environment where a package set is installed. Switches are independent of each other, and can already be exported and imported. Unfortunately the export is incomplete: if a package includes additional patches as part of the repository -- sometimes needed for fixing releases where the actual author or maintainer of a package responds slowly -- these package neither the patches end up in the export. Also, if a package is pinned to a git branch, the branch appears in the export, but this may change over time by pushing more commits or even force-pushing to that branch. In <a href="https://github.com/ocaml/opam/pull/4040">PR #4040</a> (under discussion and review), also developed during the summit, I propose to embed the additional files as base64 encoded values in the opam file. To solve the latter issue, I modified the export mechanism to <a href="https://github.com/ocaml/opam/pull/4055">embed the git commit hash (PR #4055)</a>, and avoid sources from a local directory and which do not have a checksum.</p>
<p>So the opam export contains the information required to gather the exact same sources and build instructions of the opam packages. If the opam repository would be self-contained (i.e. not depend on any other tools), this would be sufficient. But opam does not run in thin air, it requires some system utilities such as <code>/bin/sh</code>, <code>sed</code>, a GNU make, commonly <code>git</code>, a C compiler, a linker, an assembler. Since opam is available on various operating systems, the plugin <code>depext</code> handles host system dependencies, e.g. if your opam package requires <code>gmp</code> to be installed, this requires slightly different names depending on host system or distribution, take a look at <a href="https://github.com/ocaml/opam-repository/blob/master/packages/conf-gmp/conf-gmp.1/opam">conf-gmp</a>. This also means, opam has rather good information about both the opam dependencies and the host system dependencies for each package. Please note that the host system packages used during compilation are not yet recorded (i.e. which <code>gmp</code> package was installed and used during the build, only that a <code>gmp</code> package has to be installed). The base utilities mentioned above (C compiler, linker, shell) are also not recorded yet.</p>
<p>Operating system information available in opam (such as architecture, distribution, version), which in some cases maps to exact base utilities, is recorded in the build-environment, a separate artifact. The environment variable <a href="https://reproducible-builds.org/specs/source-date-epoch/"><code>SOURCE_DATE_EPOCH</code></a>, used for communicating the same timestamp when software is required to record a timestamp into the resulting binary, is also captured in the build environment.</p>
<p>Additional environment variables may be captured or used by opam packages to produce different output. To avoid this, both the initial builder and the rebuilder are run with minimal environment variables: only <code>PATH</code> (normalised to a whitelist of <code>/bin</code>, <code>/usr/bin</code>, <code>/usr/local/bin</code> and <code>/opt/bin</code>) and <code>HOME</code> are defined. Missing information at the moment includes CPU features: some libraries (gmp?, nocrypto) emit different code depending on the CPU feature.</p>
<h2>Tooling</h2>
<p><em>TL;DR: A <strong>build</strong> builds an opam package, and outputs <code>.opam-switch</code>, <code>.build-hashes.N</code>, and <code>.build-environment.N</code>. A <strong>rebuild</strong> uses these artifacts as input, builds the package and outputs another <code>.build-hashes.M</code> and <code>.build-environment.M</code>.</em></p>
<p>The command-line utility <code>orb</code> can be installed and used:</p>
<pre><code class="language-sh">$ opam pin add orb git+https://github.com/hannesm/orb.git#active
$ orb build --twice --keep-build-dir --diffoscope &lt;your-favourite-opam-package&gt;
</code></pre>
<p>It provides two subcommands <code>build</code> and <code>rebuild</code>. The <code>build</code> command takes a list of local opam <code>--repos</code> where to take opam packages from (defaults to <code>default</code>), a compiler (either a variant <code>--compiler=4.09.0+flambda</code>, a version <code>--compiler=4.06.0</code>, or a pin to a local development version <code>--compiler-pin=~/ocaml</code>), and optionally an existing switch <code>--use-switch</code>. It creates a switch, builds the packages, and emits the opam export, hashes of all files installed by these packages, and the build environment. The flags <code>--keep-build</code> retains the build products, opam's <code>--keep-build-dir</code> in addition temporary build products and generated source code. If <code>--twice</code> is provided, a rebuild (described next) is executed after the initial build.</p>
<p>The <code>rebuild</code> command takes a directory with the opam export and build environment to build the opam package. It first compares the build-environment with the host system, sets the <code>SOURCE_DATE_EPOCH</code> and switch location accordingly and executes the import. Once the build is finished, it compares the hashes of the resulting files with the previous run. On divergence, if build directories were kept in the previous build, and if diffoscope is available and <code>--diffoscope</code> was provided, diffoscope is run on the diverging files. If <code>--keep-build-dir</code> was provided as well, <code>diff -ur</code> can be used to compare the temporary build and sources, including build logs.</p>
<p>The builds are run in parallel, as opam does, this parallelism does not lead to different binaries in my experiments.</p>
<h2>Results and discussion</h2>
<p><strong>All MirageOS unikernels I have deployed are reproducible \\o/</strong>. Also, several binaries such as <code>orb</code> itself, <code>opam</code>, <code>solo5-hvt</code>, and all <code>albatross</code> utilities are reproducible.</p>
<p>The unikernel range from hello world, web servers (e.g. this blog, getting its data on startup via a git clone to memory), authoritative DNS servers, CalDAV server. They vary in size between 79 and 200 opam packages, resulting in 2MB - 16MB big ELF binaries (including debug symbols). The <a href="https://github.com/roburio/reproducible-unikernel-repo">unikernel opam repository</a> contains some reproducible unikernels used for testing. Some work-in-progress enhancements are needed to achieve this:</p>
<p>At the moment, the opam package of a MirageOS unikernel is automatically generated by <code>mirage configure</code>, but only used for tracking opam dependencies. I worked on <a href="https://github.com/mirage/mirage/pull/1022">mirage PR #1022</a> to extend the generated opam package with build and install instructions.</p>
<p>As mentioned above, if locale is set, ocamlgraph needs to be patched to emit a (locale-dependent) timestamp.</p>
<p>The OCaml program <a href="https://github.com/mirage/ocaml-crunch"><code>crunch</code></a> embeds a subdirectory as OCaml code into a binary, which we use in MirageOS quite regularly for static assets, etc. This plays in several ways into reproducibility: on the one hand, it needs a timestamp for its <code>last_modified</code> functionality (and adheres since <a href="https://github.com/mirage/ocaml-crunch/pull/45">June 2018</a> to the <code>SOURCE_DATE_EPOCH</code> spec, thanks to Xavier Clerc). On the other hand, it used before version 3.2.0 (released Dec 14th) hashtables for storing the file contents, where iteration is not deterministic (the insertion is not sorted), <a href="https://github.com/mirage/ocaml-crunch/pull/51">fixed in PR #51</a> by using a Map instead.</p>
<p>In functoria, a tool used to configure MirageOS devices and their dependencies, can emit a list of opam packages which were required to build the unikernel. This uses <code>opam list --required-by --installed --rec &lt;pkgs&gt;</code>, which uses the cudf graph (<a href="https://github.com/mirage/functoria/pull/189#issuecomment-566696426">thanks to Raja for explanation</a>), that is during the rebuild dropping some packages. The <a href="https://github.com/mirage/functoria/pull/189">PR #189</a> avoids by not using the <code>--rec</code> argument, but manually computing the fixpoint.</p>
<p>Certainly, the choice of environment variables, and whether to vary them (as <a href="https://tests.reproducible-builds.org/debian/index_variations.html">debian does</a>) or to not define them (or normalise) while building, is arguably. Since MirageOS does neither support time zone nor internationalisation, there is no need to prematurely solving this issue. On related note, even with different locale settings, MirageOS unikernels are reproducible apart from an <a href="https://github.com/backtracking/ocamlgraph/pull/90">issue in ocamlgraph #90</a> embedding the output of <a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/date.html"><code>date</code></a>, which is different depending on <code>LANG</code> and locale (<code>LC_*</code>) settings.</p>
<p>Prior art in reproducible MirageOS unikernels is the <a href="https://github.com/mirage/qubes-mirage-firewall/">mirage-qubes-firewall</a>. Since <a href="https://github.com/mirage/qubes-mirage-firewall/commit/07ff3d61477383860216c69869a1ffee59145e45">early 2017</a> it is reproducible. Their approach is different by building in a docker container with the opam repository pinned to an exact git commit.</p>
<h2>Further work</h2>
<p>I only tested a certain subset of opam packages and MirageOS unikernels, mainly on a single machine (my laptop) running FreeBSD, and am happy if others will test reproducibility of their OCaml programs with the tools provided. There could as well be CI machines rebuilding opam packages and reporting results to a central repository. I'm pretty sure there are more reproducibility issues in the opam ecosystem. I developed an <a href="https://github.com/roburio/reproducible-testing-repo">reproducible testing opam repository</a> with opam packages that do not depend on OCaml, mainly for further tooling development. Some tests were also conducted on a Debian system with the same result. The variations, apart from build time, were using a different user, and different locale settings.</p>
<p>As mentioned above, more environment, such as the CPU features, and external system packages, should be captured in the build environment.</p>
<p>When comparing OCaml libraries, some output files (cmt / cmti / cma / cmxa) are not deterministic, but contain minimal diverge where I was not able to spot the root cause. It would be great to fix this, likely in the OCaml compiler distribution. Since the final result, the binary I'm interested in, is not affected by non-identical intermediate build products, I hope someone (you?) is interested in improving on this side. OCaml bytecode output also seems to be non-deterministic. There is <a href="https://github.com/coq/coq/issues/11229">a discussion on the coq issue tracker</a> which may be related.</p>
<p>In contrast to initial plans, I did not used the <a href="https://reproducible-builds.org/specs/build-path-prefix-map/"><code>BUILD_PATH_PREFIX_MAP</code></a> environment variable, which is implemented in OCaml by <a href="https://github.com/ocaml/ocaml/pull/1515">PR #1515</a> (and followups). The main reasons are that something in the OCaml toolchain (I suspect the bytecode interpreter) needed absolute paths to find libraries, thus I'd need a symlink from the left-hand side to the current build directory, which was tedious. Also, my installed assembler does not respect the build path prefix map, and BUILD_PATH_PREFIX_MAP is not widely supported. See e.g. the Debian <a href="https://tests.reproducible-builds.org/debian/rb-pkg/unstable/amd64/diffoscope-results/ocaml-zarith.html">zarith</a> package with different build paths and its effects on the binary.</p>
<p>I'm fine with recording the build path (switch location) in the build environment for now - it turns out to end up only once in MirageOS unikernels, likely by the last linking step, which <a href="http://blog.llvm.org/2019/11/deterministic-builds-with-clang-and-lld.html">hopefully soon be solved by llvm 9.0</a>.</p>
<p>What was fun was to compare the unikernel when built on Linux with gcc against a built on FreeBSD with clang and lld - spoiler: they emit debug sections with different dwarf versions, it is pretty big. Other fun differences were between OCaml compiler versions: the difference between minor versions (4.08.0 vs 4.08.1) is pretty small (~100kB as human-readable output), while the difference between major version (4.08.1 vs 4.09.0) is rather big (~900kB as human-readable diff).</p>
<p>An item on my list for the future is to distribute the opam export, build hashes and build environment artifacts in a authenticated way. I want to integrate this as <a href="https://in-toto.io/">in-toto</a> style into <a href="https://github.com/hannesm/conex">conex</a>, my not-yet-deployed implementation of <a href="https://theupdateframework.github.io/">tuf</a> for opam that needs further development and a test installation, hopefully in 2020.</p>
<p>If you want to support our work on MirageOS unikernels, please <a href="https://robur.coop/Donate">donate to robur</a>. I'm interested in feedback, either via <a href="https://twitter.com/h4nnes">twitter</a>, <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|Using Python and OCaml in the same Jupyter notebook|js}
  ; slug = {js|using-python-and-ocaml-in-the-same-jupyter-notebook|js}
  ; description = Some {js|The cover image is based on Jupiter family by NASA/JPL.|js}
  ; url = {js|https://blog.janestreet.com/using-python-and-ocaml-in-the-same-jupyter-notebook/|js}
  ; date = {js|2019-12-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/using-python-and-ocaml-in-the-same-jupyter-notebook/python-ocaml.jpg|js}
  ; featured = false
  ; body_html = {js|<div style="width: 75%; margin: auto; text-align: center; font-style: italic; font-size: 75%">
The cover image is based on <a href="https://commons.wikimedia.org/wiki/File:Jupiter_family.jpg">Jupiter family</a> by NASA/JPL.
</div>|js}
  };
 
  { title = {js|Tarides wins the FIC 2020 startup award|js}
  ; slug = {js|tarides-wins-the-fic-2020-startup-award|js}
  ; description = Some {js|We are very excited to announce that Tarides has won an
award
from the International Cybersecurity Forum (FIC 2020). Organized every year in…|js}
  ; url = {js|https://tarides.com/blog/2019-12-11-tarides-wins-the-fic-2020-startup-award|js}
  ; date = {js|2019-12-11T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/4b2c873a5b60b4a310ecfeda07bf8d58/0d665/logo-FIC.png|js}
  ; featured = false
  ; body_html = {js|<p>We are very excited to announce that Tarides has <a href="https://www.forum-fic.com/en/home/price/the-fic-start-up-award.htm">won an
award</a>
from the International Cybersecurity Forum (FIC 2020).</p>
<p>Organized every year in Lille (France), the International
Cybersecurity Forum has become the leading European event on
cybersecurity and digital trust. Its main goal is to foster reflection
and exchanges within the European cybersecurity ecosystem.</p>
<p>We are very happy to have won the &quot;Coup de Coeur&quot; Prize, which will
bring great visibility to our technological innovations. It is also an
opportunity for us to meet experts in the cybersecurity sector and to
consider additional use-cases for our work. We would like to thank the
<a href="https://ceis.eu/">CEIS</a> for organising the event and the members of
the jury for commending <a href="https://mirage.io">MirageOS</a> and
<a href="https://tarides.com/blog/2019-07-05-i-lab-2019">OSMOSE</a>.</p>
<p>The next FIC will be held on the 28th, 29th and 30th of January
2020 in Lille. For more details about the FIC and to register, visit
<a href="https://www.forum-fic.com/en/home.htm">their website</a>.</p>
<br/>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/dc5973af18f70eb3d969d8aa1c8dfae6/9c311/FIC2020.jpg" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 47.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABvZVlqBwX/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAEBESIf/aAAgBAQABBQINqUYtM9v/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEREiAhMZH/2gAIAQEABj8CoTfBOcG7P//EABsQAAIDAAMAAAAAAAAAAAAAAAERACFBEGGx/9oACAEBAAE/IcTKsvYBTfqE2VONgAQqf//aAAwDAQACAAMAAAAQW/8A/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAERMUH/2gAIAQMBAT8QjukLh//EABYRAQEBAAAAAAAAAAAAAAAAAAARAf/aAAgBAgEBPxC4j//EABwQAQEAAgIDAAAAAAAAAAAAAAERACFRYTFBsf/aAAgBAQABPxAjeYIyIK2G7wT6DShlnHWG9k1E4xJJ1gDEJD7hJDxxn//Z'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/dc5973af18f70eb3d969d8aa1c8dfae6/7bf67/FIC2020.jpg" class="gatsby-resp-image-image" alt="FIC2020 Startup Award Winners" title="FIC2020 Startup Award Winners" srcset="/static/dc5973af18f70eb3d969d8aa1c8dfae6/651be/FIC2020.jpg 170w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/d30a3/FIC2020.jpg 340w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/7bf67/FIC2020.jpg 680w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/9c311/FIC2020.jpg 838w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>|js}
  };
 
  { title = {js|Deep-Learning the Hardest Go Problem in the World|js}
  ; slug = {js|deep-learning-the-hardest-go-problem-in-the-world|js}
  ; description = Some {js|Updates and a New Run|js}
  ; url = {js|https://blog.janestreet.com/deep-learning-the-hardest-go-problem-in-the-world/|js}
  ; date = {js|2019-12-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/deep-learning-the-hardest-go-problem-in-the-world/goproblem.png|js}
  ; featured = false
  ; body_html = {js|<h2>Updates and a New Run</h2>|js}
  };
 
  { title = {js|MirageOS talk at the Paris Open Source Summit|js}
  ; slug = {js|mirageos-talk-at-the-paris-open-source-summit|js}
  ; description = Some {js|We are thrilled to have been selected by the Paris Open Source Summit
committee to talk about “Secure-by-design IoT applications using…|js}
  ; url = {js|https://tarides.com/blog/2019-12-04-mirageos-talk-at-the-paris-open-source-summit|js}
  ; date = {js|2019-12-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/646b9e94e874374ddd8450022db7c3e2/96c5f/paris_from_window.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are thrilled to have been selected by the <a href="https://www.opensourcesummit.paris">Paris Open Source Summit</a>
committee to talk about &ldquo;Secure-by-design IoT applications using MirageOS&rdquo;.</p>
<p>The Paris Open Source Summit is an annual event where you can connect to
open-source communities and learn from tech leaders, project committers and
CTOs about the latest technical solutions, innovative uses and societal
challenges of open digital technology.</p>
<p>Thomas Gazagnaire, Tarides CEO/CTO, will explain what makes MirageOS a good
framework to build IoT applications and how we can use embedded devices running
on ARMv8, ESP32 or RISC-V to run secure and end-to-end open-source
infrastructure services such as VPN proxies and email servers. He will also
highlight how this infrastructure will be used to form the basis of OSMOSE: a
secure, distributed and privacy-preserving platform to write user-centric IoT
applications.</p>
<p>MirageOS is a library operating system (using the MIT license) which enables the
construction of unikernels: specialized services where the runtime binary
contains only the necessary code for execution and no more. Unikernels have a
drastically smaller attack surface than service deployments in traditional
operating systems and could lead to 1000x less code for the full application
stack. Moreover, as MirageOS is written in a memory safe language (OCaml), a
full class of bugs related to memory corruption &ndash; representing <a href="https://msrc-blog.microsoft.com/2019/07/16/a-proactive-approach-to-more-secure-code/">70% of the
released CVEs</a> in classic operating systems written in C &ndash;
can no longer appear. These two properties combined (and more!) allow MirageOS
to build &ldquo;secure-by-design&rdquo; applications where everything &ndash; from the high-level
business logic to the low-level device drivers &ndash; has been designed to be as
secure as possible.</p>
<p>To learn more about the project, attend the Paris Open Source Summit! The talk
will take place during the '<a href="https://www.opensourcesummit.paris/EMBEDDED+&amp;+IOT_168_5745.html">Embedded &amp; IOT</a>' section
at 14:50 &ndash; 15:20 on December 10th, 2019.</p>
<br/>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/7826ecb5d3f2934a405f25446b1eb1d8/72e01/poss_2019.jpg" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBAgP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQP/2gAMAwEAAhADEAAAAbaQxeS0alH/xAAYEAEBAQEBAAAAAAAAAAAAAAABAhIAA//aAAgBAQABBQLRxO5tIfMNZNET3//EABsRAAICAwEAAAAAAAAAAAAAAAECAAMTIZHw/9oACAEDAQE/AXqSpgVmOo7I9yf/xAAYEQADAQEAAAAAAAAAAAAAAAAAAQISIf/aAAgBAgEBPwFU6XTVI//EABoQAAMAAwEAAAAAAAAAAAAAAAABESExMpH/2gAIAQEABj8CuSpVkZoWFo5Xh//EABwQAAICAgMAAAAAAAAAAAAAAAABESExQVGBkf/aAAgBAQABPyHzBTIxowGcD9kdcEMHUGVbR//aAAwDAQACAAMAAAAQ8w//xAAZEQEBAAMBAAAAAAAAAAAAAAABEQAxYUH/2gAIAQMBAT8QLFvXySaMU0V6Y//EABgRAQEAAwAAAAAAAAAAAAAAAAEAEYHw/9oACAECAQE/EExAGBO3f//EABsQAQACAwEBAAAAAAAAAAAAAAEAESExUUFh/9oACAEBAAE/EGo1NNYftdiBKqEympaRAWOfOwWDeEMAQDwDsNrnUM//2Q=='); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/7826ecb5d3f2934a405f25446b1eb1d8/7bf67/poss_2019.jpg" class="gatsby-resp-image-image" alt="Thomas at the Paris Open Source Summit" title="Thomas at the Paris Open Source Summit" srcset="/static/7826ecb5d3f2934a405f25446b1eb1d8/651be/poss_2019.jpg 170w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/d30a3/poss_2019.jpg 340w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/7bf67/poss_2019.jpg 680w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/990cb/poss_2019.jpg 1020w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/72e01/poss_2019.jpg 1024w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>|js}
  };
 
  { title = {js|Introducing the GraphQL API for Irmin 2.0|js}
  ; slug = {js|introducing-the-graphql-api-for-irmin-20|js}
  ; description = Some {js|With the release of Irmin 2.0.0, we are happy to announce a new package - irmin-graphql, which can be used to serve data from Irmin over…|js}
  ; url = {js|https://tarides.com/blog/2019-11-27-introducing-the-graphql-api-for-irmin-2-0|js}
  ; date = {js|2019-11-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/774a33033c774c2c0c5b638f61694621/0d665/irmin-graphql.png|js}
  ; featured = false
  ; body_html = {js|<p>With the release of Irmin 2.0.0, we are happy to announce a new package - <code>irmin-graphql</code>, which can be used to serve data from Irmin over HTTP. This blog post will give you some examples to help you get started, there is also <a href="https://irmin.org/tutorial/graphql">a section in the <code>irmin-tutorial</code></a> with similar information. To avoid writing the same thing twice, this post will cover the basics of getting started, plus a few interesting ideas for queries.</p>
<p>Getting the <code>irmin-graphql</code> server running from the command-line is easy:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ irmin graphql --root<span class="token operator">=</span>/tmp/irmin</code></pre></div>
<p>where <code>/tmp/irmin</code> is the actual path to your repository. This will start the server on <code>localhost:8080</code>, but it's possible to customize this using the <code>--address</code> and <code>--port</code> flags.</p>
<p>The new GraphQL API has been added to address some of the shortcomings that have been identified with the old HTTP API, as well as enable a number of new features and capabilities.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#graphql" aria-label="graphql permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GraphQL</h1>
<p><a href="https://graphql.org/">GraphQL</a> is a query language for exposing data as a graph via an API, typically using HTTP as a transport. The centerpiece of a GraphQL API is the <em>schema</em>, which describes the graph in terms of types and relationships between these types. The schema is accessible by the consumer, and acts as a contract between the API and the consumer, by clearly defining all API operations and fully assigning types to all interactions.</p>
<p>Viewing Irmin data as a graph turns out to be a natural and useful model. Concepts such as branches and commits fit in nicely, and the stored application data is organized as a tree. Such highly hierarchical data can be challenging to interact with using REST, but is easy to represent and navigate with GraphQL.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <span class="gatsby-resp-image-background-image" style="padding-bottom: 74.11764705882352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAADeElEQVQ4y5WSf2xTVRTHTzcQHHMDaRmZESd/aHRxyiTGEDHGGBON/qn/QaL4l/6lLBlBM3UhiK7t66A/3qvOzKEJEOIvJgImaDKHC4zhbLe+/m6lfb/63r13bSnrsvaYW53BH//sJCfnnvfO/dxzz/cC/Mu2CgGwC5LN4ZHAIYhddkHc1+4K7G11+ffYBfE1hyDutHsk4N4hiPC/Vq/XIZWIQSouw6VwCJ4bO7FmzZAPtnik97Z4JOw69glu944gXzs80nkYdELf2QtNg5OXARGhVqv9F5iIRSAmz0EuGW8UPTNyHFqdvoMb3QG81zuCD4mjuMkdwHan77t9X403am71f5jXfRiSMRni8hyEfr26PiTLHZmfLnS8eer00098dmL/rk+/2P94cPTA7uOn+vac/ubF/NWpzrxRcBDGmjkshAgPuI+B3RUEIESxUao2a2p2bSwyD1ZBfzI0OxO+PHVpwtK1H6umcSY3Hx6/aWjjVatwDhHHdF0/mUgmfl5AvJsDX/3yzNo7PVKzXRBtQKnKoVAum1CtLsDLLzy7Mej134GILbllXAfTCK8cHGgbHPpwG3YBHPhF5121IOJtS553NoP0Ndzl8sJmLhQXiVJ1JyGKUCwVPigWDXcqOXeSMW3ANLPrLSv/PGOa07LyLkVJBtmCfoSQ/Ou8qw2uwKF7BP+1re7AD5sE8VuHRzprF8Ru3t1HjGmYyyUwEQ+jaeaQUhUtK99LqXqOEAWzmSimUxH+DYtMo86JiW12QbQ6j36MO4Jj2C2OcvWxczi4lwP7OUBV05hOzWPB+H0FeB+l6ud8nbsex0w6ghZRkFE1OTw50QqHh8fWDflibS7/bIvTd8125GgI3nc+xq/cRojyyM1F1oO41FMqFR62rHz30lLRRojSQYjSu7xc7kGs9lCq7jDMXBci3j4jy+9+f+WK9/z0tO9iKOyZikb9uq7t/luUGxULavUbUCwajbxSIY3IfbG6AMu1cqPWojqYjLYp2cxbGTnSH/1t9lAuEe9nhjFALOuplU1NlCpNPK74XwfZbv3XiNSwlVjaRkvag4u10qMzM5MvqUZmFyvrvYRdb4fVGCHqykH389lyARUlhbqerfOcC7xqICEq8Bnzl6HrWYzKs5hOR5DnhCi+VQL/nCml6gZClDcY0/orFdJXKpt9hChvc9H+ANUxo9tXG1thAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/77be7ca8c9940e693b03660d2d5cee01/c5bb3/git-data-model.png" class="gatsby-resp-image-image" alt="Git data model" title="Git data model" srcset="/static/77be7ca8c9940e693b03660d2d5cee01/04472/git-data-model.png 170w,
/static/77be7ca8c9940e693b03660d2d5cee01/9f933/git-data-model.png 340w,
/static/77be7ca8c9940e693b03660d2d5cee01/c5bb3/git-data-model.png 680w,
/static/77be7ca8c9940e693b03660d2d5cee01/5a190/git-data-model.png 800w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
    </span>
(image from <a href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects">Pro Git</a>)</p>
<p>As a consumer of an API, one of the biggest initial challenges is understanding what operations are exposed and how to use them. Conversely, as a developer of an API, keeping documentation up-to-date is challenging and time consuming. Though no substitute for more free-form documentation, a GraphQL schema provides an excellent base line for understanding a GraphQL API that is guaranteed to be accurate and up-to-date. This issue is definitely true of the old Irmin HTTP API, which was hard to approach for newcomers due to lack of documentation.</p>
<p>Being able to inspect the schema of a GraphQL API enables powerful tooling. A great example of this is <a href="https://tarides.com/graphiql">GraphiQL</a>, which is a browser-based IDE for GraphQL queries. GraphiQL can serve both as an interactive API explorer and query designer with intelligent autocompletion, formatting and more.</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/19632cbb13504bb32d6d6d285ec1f542/82e86/graphiql.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 48.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABd0lEQVQoz3WS6Y6EIBCEff9X3PmzyRyOitA0N2htGp09JtlOKojCZxXNcLlccLvdcL/fvzWOI5RSXYtoWf5I3lsOcCFj3zYQEUqpyDljWDXBh9gnL5VS4LyHmhTIENg5WD4kz9oYqFVjXhRCPPa21roGwxGjYgD7qaNSTlCTxsfnBE0WMWWElPpoLWNd1+40l4LfNQiEfQIToWVCrceCGGP/+0NZXJ8K3gd4DgghwjLDWotaNmDf0WpCaxK/CRCotYHJoBUv30+HGc6HDp5WgjUOPGo4zT3i0wRcbxOC/kSJGiUR9q1g2Latn1mrFfu+YT+JKR1A0VMR2Di4ib6BMyUs04jqp26kldD3DwIT6KvegdKw7lAz+L7CkUNMCblW5LSjlYiWJb6kaxikMwL5rQOYDqAPmFcCkzg0cOR7c17r3mvAP5Xzj8NF2yOysn0eYuqphPluZpjnGY/Ho1+DEMSR7yMz982icSXQQuCrgrOnw/OY3p1+Ac4PCEwKkZ1MAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/19632cbb13504bb32d6d6d285ec1f542/c5bb3/graphiql.png" class="gatsby-resp-image-image" alt="GraphiQL" title="GraphiQL" srcset="/static/19632cbb13504bb32d6d6d285ec1f542/04472/graphiql.png 170w,
/static/19632cbb13504bb32d6d6d285ec1f542/9f933/graphiql.png 340w,
/static/19632cbb13504bb32d6d6d285ec1f542/c5bb3/graphiql.png 680w,
/static/19632cbb13504bb32d6d6d285ec1f542/b12f7/graphiql.png 1020w,
/static/19632cbb13504bb32d6d6d285ec1f542/b5a09/graphiql.png 1360w,
/static/19632cbb13504bb32d6d6d285ec1f542/82e86/graphiql.png 1978w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>The combination of introspection and a strongly typed schema also allows creating smart clients using code generation. This is already a quite wide-spread idea with <a href="https://tarides.com/apollo-swift">Apollo for iOS</a>, <a href="https://tarides.com/apollo-java">Apollo for Android</a> or <a href="https://tarides.com/graphql_ppx"><code>graphql_ppx</code></a> for OCaml/Reason. Though generic GraphQL client libraries will do a fine job interacting with the Irmin GraphQL API, these highlighted libraries will offer excellent ergonomics and type-safety out of the box.</p>
<p>One of the problems that GraphQL set out to solve is that of over- and underfetching. When designing REST API response payloads, there is always a tension between including too little data, which will require clients to make more network requests, and including too much data, which wastes resources for both client and server (serialization, network transfer, deserialization, etc).<br/>
The existing low-level Irmin HTTP API is a perfect example of this. Fetching the contents of a particular file on the master branch requires at least 4 HTTP requests (fetch the branch, fetch the commit, fetch the tree, fetch the blob), i.e. massive underfetching. By comparison, this is something easily solved with a single request to the new GraphQL API. More generally, the GraphQL API allows you to fetch <em>exactly</em> the data you need in a single request without making one-off endpoints.</p>
<p>For the curious, here's the GraphQL query to fetch the contents of <code>README.md</code> from the branch <code>master</code>:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token punctuation">{</span>
  <span class="token object">master</span> <span class="token punctuation">{</span>
    <span class="token object">tree</span> <span class="token punctuation">{</span>
      <span class="token property-query">get</span><span class="token punctuation">(</span><span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;README.md&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The response will look something like this:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;master&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;tree&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;get&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The contents of README.md&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The GraphQL API is not limited to only reading data, you can also write data to your Irmin store. Here's a simple example that will set the key <code>README.md</code> to <code>&quot;foo&quot;</code>, and return the hash of that commit:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">mutation</span> <span class="token punctuation">{</span>
  <span class="token property-query property-mutation">set</span><span class="token punctuation">(</span><span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;README.md&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">value</span><span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property">hash</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>By default, GraphQL allows you to do multiple operations in a single query, so you get bulk operations for free. Here's a more complex example that modifies two different branches, <code>branch-a</code> and <code>branch-b</code>, and then merges <code>branch-b</code> into <code>branch-a</code> <em>all in a single query</em>:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">mutation</span> <span class="token punctuation">{</span>
  <span class="token attr-name">branch_a</span><span class="token punctuation">:</span> <span class="token property-query">set</span><span class="token punctuation">(</span><span class="token attr-name">branch</span><span class="token punctuation">:</span> <span class="token string">&quot;branch-a&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">value</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property">hash</span>
  <span class="token punctuation">}</span>

  <span class="token attr-name">branch_b</span><span class="token punctuation">:</span> <span class="token property-query">set</span><span class="token punctuation">(</span><span class="token attr-name">branch</span><span class="token punctuation">:</span> <span class="token string">&quot;branch-a&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;baz&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">value</span><span class="token punctuation">:</span> <span class="token string">&quot;qux&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property">hash</span>
  <span class="token punctuation">}</span>

  <span class="token property-query">merge_with_branch</span><span class="token punctuation">(</span><span class="token attr-name">branch</span><span class="token punctuation">:</span> <span class="token string">&quot;branch-b&quot;</span><span class="token punctuation">,</span> <span class="token attr-name">from</span><span class="token punctuation">:</span> <span class="token string">&quot;branch-a&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token property">hash</span>
    <span class="token object">tree</span> <span class="token punctuation">{</span>
      <span class="token object">list_contents_recursively</span> <span class="token punctuation">{</span>
        <span class="token property">key</span>
        <span class="token property">value</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here's what the response might look like:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;branch_a&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0a1313ae9dfe1d4339aee946dd76b383e02949b6&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;branch_b&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;28855c277671ccc180c81058a28d3254f17d2f7b&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;merge_with_branch&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7b17437a16a858816d2710a94ccaa1b9c3506d1f&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tree&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;list_contents_recursively&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/foo&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/baz&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;qux&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Overall, the new GraphQL API operates at a much higher level than the old HTTP API, and offers a number of complex operations that were tricky to accomplish before.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#customizable" aria-label="customizable permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Customizable</h1>
<p>With GraphQL, all request and response data is fully described by the schema. Because Irmin allows the user to have custom content types, this leaves the question of what type to assign to such values. By default, the GraphQL API will expose all values as strings, i.e. the serialized version of the data that your application stores. This works quite well when Irmin is used as a simple key-value store, but it can be very inconvenient scheme when storing more complex values. As an example, consider storing contacts (name, email, phone, tags, etc) in your Irmin store, where values have the following type:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* Custom content type: a contact *)</span>
<span class="token keyword">type</span> contact <span class="token operator">=</span> <span class="token punctuation">{</span>
  name <span class="token punctuation">:</span> string<span class="token punctuation">;</span>
  email <span class="token punctuation">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">(* ... *)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Fetching such a value will by default be returned to the client as the JSON encoded representation. Assume we're storing a contact under the key <code>john-doe</code>, which we fetch with the following query:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token punctuation">{</span>
  <span class="token object">master</span> <span class="token punctuation">{</span>
    <span class="token object">tree</span> <span class="token punctuation">{</span>
      <span class="token property-query">get</span><span class="token punctuation">(</span><span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;john-doe&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The response would then look something like this:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;master&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tree&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;get&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\\&quot;name\\&quot;:\\&quot;John Doe\\&quot;, \\&quot;email\\&quot;: \\&quot;john.doe@gmail.com/&quot;</span><span class="token punctuation">,</span> ...<span class="token punctuation">}</span>&quot;
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The client will have to parse this JSON string and cannot choose to only fetch parts of the value (say, only the email). Optimally we would want the client to get a structured response such as the following:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;master&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tree&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;get&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Doe&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;john.doe@gmail.com&quot;</span><span class="token punctuation">,</span>
        ...
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>To achieve this, the new GraphQL API allows providing an &quot;output type&quot; and an &quot;input type&quot; for most of the configurable types in your store (<code>contents</code>, <code>key</code>, <code>metadata</code>, <code>hash</code>, <code>branch</code>). The output type specifies how data is presented to the client, while the input type controls how data can be provided by the client. Let's take a closer look at specifying a custom output type.</p>
<p>Essentially you have to construct a value of type <code>(unit, 'a option) Graphql_lwt.Schema.typ</code> (from the <a href="https://tarides.com/ocaml-graphql-server"><code>graphql-lwt</code></a> package), assuming your content type is <code>'a</code>. We could construct a GraphQL object type for our example content type <code>contact</code> as follows:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* (unit, contact option) Graphql_lwt.Schema.typ *)</span>
<span class="token keyword">let</span> contact_schema_typ <span class="token operator">=</span> <span class="token module variable">Graphql_lwt</span><span class="token punctuation">.</span><span class="token module variable">Schema</span><span class="token punctuation">.</span><span class="token punctuation">(</span>obj <span class="token string">&quot;Contact&quot;</span>
  <span class="token label function">~fields</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span>
    field <span class="token string">&quot;name&quot;</span>
      <span class="token label function">~typ</span><span class="token punctuation">:</span><span class="token punctuation">(</span>non_null string<span class="token punctuation">)</span>
      <span class="token label function">~args</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token label function">~resolve</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">_</span> contact <span class="token operator">-&gt;</span>
        contact<span class="token punctuation">.</span>name
      <span class="token punctuation">)</span>
    <span class="token punctuation">;</span>
    <span class="token comment">(* ... more fields *)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>To use the custom type, you need to instantiate the functor <code>Irmin_unix.Graphql.Server.Make_ext</code> (assuming you're deploying to a Unix target) with an Irmin store (type <code>Irmin.S</code>) and a custom types module (type <code>Irmin_graphql.Server.CUSTOM_TYPES</code>). This requires a bit of plumbing:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* Instantiate the Irmin functor somehow *)</span>
<span class="token keyword">module</span> S <span class="token punctuation">:</span> <span class="token module variable">Irmin</span><span class="token punctuation">.</span>S <span class="token keyword">with</span> <span class="token keyword">type</span> contents <span class="token operator">=</span> contact <span class="token operator">=</span>
  <span class="token comment">(* ... *)</span>

<span class="token comment">(* Custom GraphQL presentation module *)</span>
<span class="token keyword">module</span> <span class="token module variable">Custom_types</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token comment">(* Construct default GraphQL types *)</span>
  <span class="token keyword">module</span> <span class="token module variable">Defaults</span> <span class="token operator">=</span> <span class="token module variable">Irmin_graphql</span><span class="token punctuation">.</span><span class="token module variable">Server</span><span class="token punctuation">.</span><span class="token module variable">Default_types</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span>

  <span class="token comment">(* Use the default types for most things *)</span>
  <span class="token keyword">module</span> <span class="token module variable">Key</span> <span class="token operator">=</span> <span class="token module variable">Defaults</span><span class="token punctuation">.</span><span class="token module variable">Key</span>
  <span class="token keyword">module</span> <span class="token module variable">Metadata</span> <span class="token operator">=</span> <span class="token module variable">Defaults</span><span class="token punctuation">.</span><span class="token module variable">Metadata</span>
  <span class="token keyword">module</span> <span class="token module variable">Hash</span> <span class="token operator">=</span> <span class="token module variable">Defaults</span><span class="token punctuation">.</span><span class="token module variable">Hash</span>
  <span class="token keyword">module</span> <span class="token module variable">Branch</span> <span class="token operator">=</span> <span class="token module variable">Defaults</span><span class="token punctuation">.</span><span class="token module variable">Branch</span>

  <span class="token comment">(* Use custom output type for contents *)</span>
  <span class="token keyword">module</span> <span class="token module variable">Contents</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
    <span class="token keyword">include</span> <span class="token module variable">Defaults</span><span class="token punctuation">.</span><span class="token module variable">Contents</span>
    <span class="token keyword">let</span> schema_typ <span class="token operator">=</span> contact_schema_typ
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> <span class="token module variable">Remote</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">let</span> remote <span class="token operator">=</span> <span class="token module variable">Some</span> s<span class="token punctuation">.</span>remote
<span class="token keyword">end</span>

<span class="token keyword">module</span> <span class="token module variable">GQL</span> <span class="token operator">=</span> <span class="token module variable">Irmin_unix</span><span class="token punctuation">.</span><span class="token module variable">Graphql</span><span class="token punctuation">.</span><span class="token module variable">Server</span><span class="token punctuation">.</span><span class="token module variable">Make_ext</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token module variable">Remote</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token module variable">Custom_types</span><span class="token punctuation">)</span></code></pre></div>
<p>With this in hand, we can now query specifically for the email of <code>john-doe</code>:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">query</span> <span class="token punctuation">{</span>
  <span class="token object">master</span> <span class="token punctuation">{</span>
    <span class="token object">tree</span> <span class="token punctuation">{</span>
      <span class="token property-query">get</span><span class="token punctuation">(</span><span class="token attr-name">key</span><span class="token punctuation">:</span> <span class="token string">&quot;john-doe&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token property">email</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>... and get a nicely structured JSON response back:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;master&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tree&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;get&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;john.doe@gmail.com&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The custom types is very powerful and opens up for transforming or enriching the data at query time, e.g. geocoding the address of a contact, or checking an on-line status.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#watches" aria-label="watches permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Watches</h1>
<p>A core feature of Irmin is the ability to <em>watch</em> for changes to the underlying data store in real-time. <code>irmin-graphql</code> takes advantage of GraphQL subscriptions to expose Irmin watches. Subscriptions are a relative recent addition to the GraphQL spec (<a href="https://tarides.com/graphql-spec-june-2018">June 2018</a>), which allows clients to <em>subscribe</em> to changes. These changes are pushed to the client over a suitable transport mechanism, e.g. websockets, Server-Sent Events, or a chunked HTTP response, as a regular GraphQL response.</p>
<p>As an example, the following query watches for all changes and returns the new hash:</p>
<div class="gatsby-highlight" data-language="graphql"><pre class="language-graphql"><code class="language-graphql"><span class="token keyword">subscription</span> <span class="token punctuation">{</span>
  <span class="token object">watch</span> <span class="token punctuation">{</span>
    <span class="token object">commit</span> <span class="token punctuation">{</span>
      <span class="token property">hash</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>For every change, a message like the following will be sent:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;commit&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c01a59bacc16d89e9cdd344a969f494bb2698d8f&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Under the hood, subscriptions in <code>irmin-graphql</code> are implemented using Irmin watches, but this is opaque to the client -- this will work with any GraphQL spec compliant client!</p>
<p>Here's a video, which hows how the GraphQL response changes live as the Irmin store is being manipulated:</p>
<p><video controls="controls" width="680"><source src="/blog/2019-11-27-introducing-irmin-graphql/irmin-subscriptions.mp4" type="video/mp4"></source></video></p>
<p>Note that the current implementation only supports websockets with more transport options coming soon.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#wrap-up" aria-label="wrap up permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Wrap-up</h1>
<p>Irmin 2.0 ships with a powerful new GraphQL API, that makes it much easier to interact with Irmin over the network. This makes Irmin available for many more languages and contexts, not just applications using OCaml (or Javascript). The new API operates at a much high level than the old API, and offers advanced features such as &quot;bring your own GraphQL types&quot;, and watching for changes via GraphQL subscriptions.</p>
<p>We're looking forward to seeing what you'll build with it!</p>|js}
  };
 
  { title = {js|Irmin v2|js}
  ; slug = {js|irmin-v2|js}
  ; description = Some {js|We are pleased to announce Irmin
2.0.0, a major release of the
Git-like distributed branching and storage substrate that underpins
MirageOS…|js}
  ; url = {js|https://tarides.com/blog/2019-11-21-irmin-v2|js}
  ; date = {js|2019-11-21T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/d702f060cc02fbcb7329077e2d71741d/0d665/irmin2.png|js}
  ; featured = false
  ; body_html = {js|<p>We are pleased to announce <a href="https://github.com/mirage/irmin/releases">Irmin
2.0.0</a>, a major release of the
Git-like distributed branching and storage substrate that underpins
<a href="https://mirage.io">MirageOS</a>.  We began the release process for all the
components that make up Irmin <a href="https://tarides.com/blog/2019-05-13-on-the-road-to-irmin-v2">back in May
2019</a>, and there
have been close to 1000 commits since Irmin 1.4.0 released back in June 2018. To
celebrate this milestone, we have a new logo and opened a dedicated website:
<a href="https://irmin.org">irmin.org</a>.</p>
<p>Our focus this year has been on ensuring the production success of our
early adopters -- such as the
<a href="https://gitlab.com/tezos/tezos/tree/master/src/lib_storage">Tezos</a> blockchain
and the <a href="https://github.com/moby/datakit">Datakit 9P</a>
stack -- as well as spawning new research projects into the practical
application of distributed and mergeable data stores.  We are also
very pleased to welcome several new maintainers into the Mirage
project for their contributions to Irmin, namely
<a href="https://github.com/icristescu">Ioana Cristescu</a>,
<a href="https://github.com/CraigFe">Craig Ferguson</a>,
<a href="https://github.com/andreas">Andreas Garnaes</a>,
<a href="https://github.com/pascutto">Cl&eacute;ment Pascutto</a> and
<a href="https://github.com/zshipko">Zach Shipko</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#new-major-features" aria-label="new major features permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New Major Features</h2>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#new-cli" aria-label="new cli permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New CLI</h3>
<p>While Irmin is normally used as a library, it is obviously useful to
be able to interact with a data store from a shell.  The <code>irmin-unix</code>
opam package now provides an <code>irmin</code> binary that is configured via a
Yaml file and can perform queries and mutations against a Git store.</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;root: .&quot;</span> <span class="token operator">&gt;</span> irmin.yml
$ irmin init
$ irmin <span class="token builtin class-name">set</span> foo/bar <span class="token string">&quot;testing 123&quot;</span>
$ irmin get foo/bar</code></pre></div>
<p>Try <code>irmin --help</code> to see all the commands and options available.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#tezos-and-irmin-pack" aria-label="tezos and irmin pack permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tezos and irmin-pack</h3>
<p>Another big user of Irmin is the <a href="https://tezos.com">Tezos blockchain</a>,
and we have been optimising the persistent space usage of Irmin as their
network grows.  Because Tezos doesn&rsquo;t require full Git format support,
we created a hybrid backend that grabs the best bits of Git (e.g. the
packfile mechanism) and engineered a domain-specific backend tailored
for Tezos usage. Crucially, because of the way Irmin is split into
clean libraries and OCaml modules, we only had to modify a small part
of the codebase and could also reuse elements of our
<a href="https://github.com/mirage/ocaml-git">OCaml-git</a> codebase as well.</p>
<p>The <a href="https://github.com/mirage/irmin/pull/615">irmin-pack backend</a> is available
for <a href="https://github.com/mirage/irmin/pull/888">use in the CLI</a> and provides a
significant improvement in disk usage.  There is a corresponding <a href="https://gitlab.com/tezos/tezos/merge_requests/1268">Tezos merge
request</a> using the Irmin
2.0 code that has been integrated downstream and will become available via
their release process in due course.</p>
<p>As part of this development process, we also released an efficient multi-level
index implementation (imaginatively dubbed
<a href="https://github.com/mirage/index">index</a> in opam). Our implementation takes an
arbitrary IO implementation and user-supplied content types and supplies a
standard key-value interface for persistent storage. Index provides instance
sharing by default, so each OCaml runtime shares a common singleton instance.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#irmin-graphql-and-browser-irmin" aria-label="irmin graphql and browser irmin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Irmin-GraphQL and &ldquo;browser Irmin&rdquo;</h3>
<p>Another new area of huge interest to us is
<a href="https://graphql.org">GraphQL</a> in order to provide frontends with a rich
query language for Irmin-hosted applications.  Irmin 2.0 includes a
built-in GraphQL server so you can <a href="https://twitter.com/cuvius/status/1017136581755457539">manipulate your Git repo via
GraphQL</a>.</p>
<p>If you are interested in (for example) compiling elements of Irmin to
JavaScript or wasm, for usage in frontends, then the Irmin 2.0 release
makes it significantly easier to support this architecture.  We&rsquo;ve
already seen some exploratory efforts <a href="https://github.com/mirage/irmin/issues/681">report issues</a>
when doing this, and we&rsquo;ve had it working ourselves in <a href="http://roscidus.com/blog/blog/2015/04/28/cuekeeper-gitting-things-done-in-the-browser/">Irmin 1.0 Cuekeeper</a>
so we are excited by the potential power of applications built using
this model.  If you have ideas/questions, please get in touch on the
<a href="https://github.com/mirage/irmin/issues">issue tracker</a> with your
usecase.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#wodan" aria-label="wodan permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Wodan</h3>
<p>Irmin&rsquo;s storage layer is also well abstracted, so backends other than
a Unix filesystem or Git are supported.  Irmin can run in highly
diverse and OS-free environments, and so we began engineering the
<a href="https://github.com/mirage/wodan">Wodan filesystem</a> as a
domain-specific filesystem designed for MirageOS, Irmin and modern
flash drives.  See <a href="https://g2p.github.io/research/wodan.pdf">the OCaml Workshop 2017 abstract on
it</a> for more design
rationale.</p>
<p>As part of the Irmin 2.0 release, Wodan is also being prepared for a
release, and you can find <a href="https://github.com/mirage/wodan/tree/master/src/wodan-irmin">Irmin 2.0
support</a>
in the source.  If you&rsquo;d like a standalone block-device based
persistence environment for Irmin, please try this out.  This is the
preferred backend for using Irmin storage in a unikernel.</p>
<p>###&nbsp;Versioned CalDAV</p>
<p>An application pulling all these pieces together is being developed
by our friends at <a href="https://robur.io/About%20Us/Team">Robur</a>: an Irmin-based
<a href="https://github.com/roburio/caldav">CalDAV calendaring server</a>
that even hosts its DNS server using a versioned Irmin store.  We'll
blog more about this as the components get released and stabilised, but
the unikernel enthusiasts among you may want to browse the
<a href="https://github.com/roburio/unikernels/tree/future">Robur unikernels future branch</a>
to see how they are deploying them today.</p>
<p>A huge thank you to all our commercial customers, end users and open-source
developers who have contributed their time, expertise and
financial support to help us achieve our goal of delivering a modern
storage stack in the spirit of Git.  Our next steps for Irmin are to
continue to increase the performance and optimise the storage,
and to build more end-to-end applications using the application core
on top of MirageOS.</p>|js}
  };
 
  { title = {js|How to write a library for BuckleScript and Native|js}
  ; slug = {js|how-to-write-a-library-for-bucklescript-and-native|js}
  ; description = Some {js|This blog post is an introduction on how to setup a library available for both BuckleScript and OCaml, sharing as much code as possible.|js}
  ; url = {js|https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2019-10-22T10:09:09-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p><em>Written with </em><a href="https://twitter.com/javierwchavarri"><em>Javier Ch&aacute;varri</em></a><em> and </em><a href="https://github.com/feihong/"><em>Feihong&nbsp;Hsu</em></a><em>.</em></p><p>The first <a href="https://www.reason-conf.us/">Reason Conf US</a> just ended. Many talks mentioned native compilation. Sharing code between BuckleScript and native artifacts is a use case which is more and more common. This blog post is an introduction on how to set up a library available for both worlds, sharing as much code as possible.</p><h3>The goal</h3><p>What we try to produce is a library with an identical interface for BuckleScript and native. But without duplicating code. It should also be possible to have some parts of the library that are a different implementation depending on the target, as we want to be able to leverage existing libraries that are working only in one of the&nbsp;worlds.</p><h3>The build&nbsp;systems</h3><p>For BuckleScript, there is only one build system: bsb. It is driven by a bsconfig.json file. And is installed as part of the bs-platform.</p><p>On the native side, there are a lot of different build systems that are available. But recently one of them became a de facto standard: dune. It works with a very minimal amount of configuration. And it supports the reason syntax by&nbsp;default.</p><p>These two tools are working in a way which is pretty similar. They share a lot of concepts. And it is easy to set them up so that both are working in the same codebase.</p><p>The main similarities that interest us&nbsp;are:</p><ul><li>The ability to work on specific source directories</li><li>Namespacing in bsb and wrapping in dune are both putting all the<br/>files of the library under a single module&nbsp;name</li></ul><h3>The source code file&nbsp;tree</h3><p>The code of the library is split into 3 directories.</p><pre>&#9500;&#9472;&#9472; js/<br/>&#9500;&#9472;&#9472; native/<br/>&#9492;&#9472;&#9472; shared/</pre><ul><li>shared is meant to host most of the code and all the code in this directory will be compiled in both&nbsp;modes.</li><li>js contains the parts that are specific to BuckleScript.</li><li>native contains the parts that are specific to native&nbsp;OCaml.</li></ul><h3>Set up the build&nbsp;systems</h3><p>Once we have our basic skeleton for the library, it is time to set up the build systems. We want to have two configurations as similar as possible to make them easier to understand. Once we are done, the tree will look like&nbsp;this:</p><pre>&#9500;&#9472;&#9472; bsconfig.json<br/>&#9500;&#9472;&#9472; dune<br/>&#9500;&#9472;&#9472; dune-project<br/>&#9500;&#9472;&#9472; js/<br/>&#9500;&#9472;&#9472; native/<br/>&#9492;&#9472;&#9472; shared/</pre><h4>BuckleScript</h4><p>At the root of the library we need a bsconfig.json file to drive<br/>bsb. The documentation is available at <a href="https://bucklescript.github.io/docs/en/build-configuration%5D(https://bucklescript.github.io/docs/en/build-configuration).">https://bucklescript.github.io/docs/en/build-configuration</a>.</p><p>The main part for us is sources. We will use it to tell bsb to look at the js and shared folders. We also want to set namespace to true, which will wrap all your project&rsquo;s files under a common module&nbsp;name.</p><pre>  &quot;namespace&quot;: true,<br/>  &quot;sources&quot;: [<br/>    {<br/>      &quot;dir&quot;: &quot;js&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }, {<br/>      &quot;dir&quot;: &quot;shared&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }<br/>  ],</pre><p>The rest of the file is as&nbsp;usual.</p><pre>{<br/>  &quot;name&quot;: &quot;sharedlib&quot;,<br/>  &quot;namespace&quot;: true,<br/>  &quot;sources&quot;: [<br/>    {<br/>      &quot;dir&quot;: &quot;js&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }, {<br/>      &quot;dir&quot;: &quot;shared&quot;,<br/>      &quot;subdirs&quot;: true<br/>    }<br/>  ],<br/>  &quot;package-specs&quot;: {<br/>    &quot;module&quot;: &quot;es6&quot;,<br/>    &quot;in-source&quot;: true<br/>  },<br/>  &quot;refmt&quot;: 3,<br/>  &quot;suffix&quot;: &quot;.bs.js&quot;,<br/>  &quot;generate-merlin&quot;: true,<br/>}</pre><h4>Dune</h4><p>We must also add a dune file to the root of the library. For dune, we have different options&#8202;&mdash;&#8202;it is possible to ignore the js directory but read everything else. Or to check only shared and native. To make the configuration similar to BuckleScript, we will go with the second solution.</p><p>The dune directive to do that is dirs. By defaults it tells dune to explore every directory except the ones hidden (starting with a dot) or starting with an underscore. <a href="https://dune.readthedocs.io/en/stable/dune-files.html#dirs-since-1-6">More details in dune&rsquo;s documentation</a>. To make it do what we want, the configuration should&nbsp;be:</p><pre>(dirs shared native)</pre><p>We also use another option of dune to tell it to include the content of those two directories as if it was at the root of the project. Without this stanza, dune would only use the source files at the root of the project and ignore everything in the sub directories.</p><pre>(include_subdirs unqualified)</pre><p>Then we need the usual library stanza to give a name to our library, state the dependencies, compilation flags, etc. In our simple case, the only information needed is the name. We can explicitly set wrapped to true, but this is already the default behavior. The <a href="https://dune.readthedocs.io/en/stable/dune-files.html#library">documentation for the whole library stanza</a> describes how to specify more&nbsp;details.</p><p>The final dune file looks like&nbsp;this:</p><pre>(dirs shared native)<br/> (include_subdirs unqualified)<br/> (library<br/>  (name sharedlib))</pre><p>We also want a basic dune-project. If we don&rsquo;t write it by hand, dune will generate it for us. I am using version 1.10 as an example. But it can be changed to whatever version suits your&nbsp;project.</p><pre>(lang dune 1.10)</pre><h3>Compilation</h3><p>With the setup described above, the compilation for BuckleScript and native is the same as in a setup with only one or the&nbsp;other.</p><ul><li>bsb -make-world for BuckleScript</li><li>dune build @all for&nbsp;dune</li></ul><p>The call to bsb is usally put in package.json in the scripts part, so that the usual yarn build can be used. For native, it depends if you rely on esy or&nbsp;opam.</p><h3>How to consume the&nbsp;library</h3><p>This is exactly the same setup that would be used in a pure BuckleScript or pure native&nbsp;library.</p><p>To use your library in BuckleScript:</p><ul><li>Add the name and version to package.json</li><li>Add the name to bsbconfig.json of consuming library/app</li></ul><p>To use your library in native OCaml, add the name of your library to the libraries part an executable or library stanza,&nbsp;e.g.</p><pre>(executable<br/> (name main)<br/> (libraries sharedlib))</pre><h3>Module naming</h3><p>If you want your module name to contain capital letters in the middle (e.g. TeenageMutantNinjaTurtles), then be aware that <a href="https://bucklescript.github.io/docs/en/build-configuration.html#name-namespace">name munging</a> works differently between bsbconfig.json and dune. For example, if you want to refer to your module as CoolSharedLib in your code, then the name in bsbconfig.json must be cool-shared-lib, and in dune it must be coolSharedLib.</p><h3>Platform specific&nbsp;code</h3><p>The whole library does not have to be exactly the same in the two platform. It is possible to add modules that are available only in one mode. Or to have modules with a different interface.</p><p>For example, by adding a file Foo.re in js but not in native, the library now has a module Foo available when compiled to javascript. But only when compiled to javascript.</p><h3>Downsides</h3><ul><li>Both bsb and dune generate&nbsp;.merlin files when they compile our library. They override each other. It might be troublesome if the version of ocaml used for native code is not 4.02.3. Simply recompile the library for your platform to solve the&nbsp;problem.</li><li>Out of the box, this approach doesn&rsquo;t really allow us to share interface files between both platforms: native and BuckleScript. One workaround for that, if we wanted to share some module Foo, is to:<br/>1. add Foo.mli or Foo.rei file in shared<br/>2. add include FooImplementation in Foo.ml<br/>3. add FooImplementation in both native and js&nbsp;folder</li><li>It&rsquo;s not possible to be platform specific for just a few lines of code (e.g. if IS_NATIVE foo else bar), the minimal per-platform unit is a file/module.</li></ul><h3>Example project</h3><p>We have set up a simple library to showcase what a repository looks like once the whole configuration is in place. It is <a href="https://github.com/ahrefs/hello-native-bucklescript">available on&nbsp;github</a>.</p><p>For now the repository contains only a library. But with this setup, it is actually possible to build an executable too. It is also possible to enrich it, for example by adding <a href="https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081">atdgen to communicate between both sides of the&nbsp;library</a>.</p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=22f45e5e946d" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d">How to write a library for BuckleScript and Native</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|Commas in big numbers everywhere: An OpenType adventure|js}
  ; slug = {js|commas-in-big-numbers-everywhere-an-opentype-adventure|js}
  ; description = Some {js|My job involves a lot of staring at large numbers, mostly latencies innanoseconds, and picking out magnitudes like microseconds. I noticedmyself constantly c...|js}
  ; url = {js|https://blog.janestreet.com/commas-in-big-numbers-everywhere/|js}
  ; date = {js|2019-10-14T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/commas-in-big-numbers-everywhere/numderline_header2.png|js}
  ; featured = false
  ; body_html = {js|<p>My job involves a lot of staring at large numbers, mostly latencies in
nanoseconds, and picking out magnitudes like microseconds. I noticed
myself constantly counting digits in my text editor, in my terminal,
and in <a href="https://jupyter.org/">Jupyter</a> notebooks in my browser.</p>|js}
  };
 
  { title = {js|Mr. MIME - Parse and generate emails|js}
  ; slug = {js|mr-mime---parse-and-generate-emails|js}
  ; description = Some {js|We're glad to announce the first release of mrmime, a parser and a
generator of emails. This library provides an OCaml way to analyze and…|js}
  ; url = {js|https://tarides.com/blog/2019-09-25-mr-mime-parse-and-generate-emails|js}
  ; date = {js|2019-09-25T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/14bcc335478eae1bbad1c2f4cdd244af/0132d/mailboxes2.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We're glad to announce the first release of <a href="https://github.com/mirage/mrmime.git"><code>mrmime</code></a>, a parser and a
generator of emails. This library provides an <em>OCaml way</em> to analyze and craft
an email. The eventual goal is to build an entire <em>unikernel-compatible</em> stack
for email (such as SMTP or IMAP).</p>
<p>In this article, we will show what is currently possible with <code>mrmime</code> and
present a few of the useful libraries that we developed along the way.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#an-email-parser" aria-label="an email parser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>An email parser</h2>
<p>Some years ago, Romain gave <a href="https://www.youtube.com/watch?v=kQkRsNEo25k">a talk</a> about what an email really <em>is</em>.
Behind the human-comprehensible format (or <em>rich-document</em> as we said a
long time ago), there are several details of emails which complicate the process of
analyzing them (and can be prone to security lapses). These details are mostly described
by three RFCs:</p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc822">RFC822</a></li>
<li><a href="https://tools.ietf.org/html/rfc2822">RFC2822</a></li>
<li><a href="https://tools.ietf.org/html/rfc5322">RFC5322</a></li>
</ul>
<p>Even though they are cross-compatible, providing full legacy email parsing is an
archaeological exercise: each RFC retains support for the older design decisions
(which were not recognized as bad or ugly in 1970 when they were first standardized).</p>
<p>The latest email-related RFC (RFC5322) tried to fix the issue and provide a better
<a href="https://tools.ietf.org/html/rfc5234">formal specification</a> of the email format &ndash; but of course, it comes with plenty of
<em>obsolete</em> rules which need to be implemented. In the standard, you find
both the current grammar rule and its obsolete equivalent.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#an-extended-email-parser" aria-label="an extended email parser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>An extended email parser</h3>
<p>Even if the email format can defined by &quot;only&quot; 3 RFCs, you will
miss email internationalization (<a href="https://tools.ietf.org/html/rfc6532">RFC6532</a>), the MIME format
(<a href="https://tools.ietf.org/html/rfc2045">RFC2045</a>, <a href="https://tools.ietf.org/html/rfc2046">RFC2046</a>, <a href="https://tools.ietf.org/html/rfc2047">RFC2047</a>,
<a href="https://tools.ietf.org/html/rfc2049">RFC2049</a>), or certain details needed to be interoperable with SMTP
(<a href="https://tools.ietf.org/html/rfc5321">RFC5321</a>). There are still more RFCs which add extra features
to the email format such as S/MIME or the Content-Disposition field.</p>
<p>Given this complexity, we took the most general RFCs and tried to provide an easy way to deal
with them. The main difficulty is the <em>multipart</em> parser, which deals with email
attachments (anyone who has tried to make an HTTP 1.1 parser knows about this).</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#a-realistic-email-parser" aria-label="a realistic email parser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A realistic email parser</h3>
<p>Respecting the rules described by RFCs is not enough to be able to analyze any
email from the real world: existing email generators can, and do, produce
<em>non-compliant</em> email. We stress-tested <code>mrmime</code> by feeding it a batch of 2
billion emails taken from the wild, to see if it could parse everything (even if
it does not produce the expected result). Whenever we noticed a recurring
formatting mistake, we updated the details of the <a href="https://tools.ietf.org/html/rfc5234">ABNF</a> to enable
<code>mrmime</code> to parse it anyway.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#a-parser-usable-by-others" aria-label="a parser usable by others permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A parser usable by others</h3>
<p>One demonstration of the usability of <code>mrmime</code> is <a href="https://github.com/dinosaure/ocaml-dkim.git"><code>ocaml-dkim</code></a>, which wants to
extract a specific field from your mail and then verify that the hash and signature
are as expected.</p>
<p><code>ocaml-dkim</code> is used by the latest implementation of <a href="https://github.com/mirage/ocaml-dns.git"><code>ocaml-dns</code></a> to request
public keys in order to verify email.</p>
<p>The most important question about <code>ocaml-dkim</code> is: is it able to
verify your email in one pass? Indeed, currently some implementations of DKIM
need 2 passes to verify your email (one to extract the DKIM signature, the other
to digest some fields and bodies). We focused on verifying in a <em>single</em> pass in
order to provide a unikernel SMTP <em>relay</em> with no need to store your email between
verification passes.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#an-email-generator" aria-label="an email generator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>An email generator</h2>
<p>OCaml is a good language for making little DSLs for specialized use-cases. In this
case, we took advantage of OCaml to allow the user to easily craft an email from
nothing.</p>
<p>The idea is to build an OCaml value describing the desired email header, and
then let the Mr. MIME generator transform this into a stream of characters that
can be consumed by, for example, an SMTP implementation. The description step
is quite simple:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token directive important">#require</span> <span class="token string">&quot;mrmime&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token directive important">#require</span> <span class="token string">&quot;ptime.clock.os&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token keyword">open</span> <span class="token module variable">Mrmime</span>

<span class="token keyword">let</span> romain_calascibetta <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">open</span> <span class="token module variable">Mailbox</span> <span class="token keyword">in</span>
  <span class="token module variable">Local</span><span class="token punctuation">.</span><span class="token punctuation">[</span> w <span class="token string">&quot;romain&quot;</span><span class="token punctuation">;</span> w <span class="token string">&quot;calascibetta&quot;</span> <span class="token punctuation">]</span> <span class="token operator">@</span> <span class="token module variable">Domain</span><span class="token punctuation">.</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token punctuation">[</span> a <span class="token string">&quot;gmail&quot;</span><span class="token punctuation">;</span> a <span class="token string">&quot;com&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> john_doe <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">open</span> <span class="token module variable">Mailbox</span> <span class="token keyword">in</span>
  <span class="token module variable">Local</span><span class="token punctuation">.</span><span class="token punctuation">[</span> w <span class="token string">&quot;john&quot;</span> <span class="token punctuation">]</span> <span class="token operator">@</span> <span class="token module variable">Domain</span><span class="token punctuation">.</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token punctuation">[</span> a <span class="token string">&quot;doe&quot;</span><span class="token punctuation">;</span> a <span class="token string">&quot;org&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">|&gt;</span> with_name <span class="token module variable">Phrase</span><span class="token punctuation">.</span><span class="token punctuation">(</span>v <span class="token punctuation">[</span> w <span class="token string">&quot;John&quot;</span><span class="token punctuation">;</span> w <span class="token string">&quot;D.&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> now <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">open</span> <span class="token module variable">Date</span> <span class="token keyword">in</span>
  of_ptime <span class="token label function">~zone</span><span class="token punctuation">:</span><span class="token module variable">Zone</span><span class="token punctuation">.</span><span class="token module variable">GMT</span> <span class="token punctuation">(</span><span class="token module variable">Ptime_clock</span><span class="token punctuation">.</span>now <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> subject <span class="token operator">=</span>
  <span class="token module variable">Unstructured</span><span class="token punctuation">.</span><span class="token punctuation">[</span> v <span class="token string">&quot;A&quot;</span><span class="token punctuation">;</span> sp <span class="token number">1</span><span class="token punctuation">;</span> v <span class="token string">&quot;Simple&quot;</span><span class="token punctuation">;</span> sp <span class="token number">1</span><span class="token punctuation">;</span> v <span class="token string">&quot;Mail&quot;</span> <span class="token punctuation">]</span>

<span class="token keyword">let</span> header <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">open</span> <span class="token module variable">Header</span> <span class="token keyword">in</span>
  <span class="token module variable">Field</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token module variable">Subject</span> <span class="token operator">$</span> subject<span class="token punctuation">)</span>
  <span class="token operator">&amp;</span> <span class="token module variable">Field</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token module variable">Sender</span> <span class="token operator">$</span> romain_calascibetta<span class="token punctuation">)</span>
  <span class="token operator">&amp;</span> <span class="token module variable">Field</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token module variable">To</span> <span class="token operator">$</span> <span class="token module variable">Address</span><span class="token punctuation">.</span><span class="token punctuation">[</span> mailbox john_doe <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">&amp;</span> <span class="token module variable">Field</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token module variable">Date</span> <span class="token operator">$</span> now <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token operator">&amp;</span> empty

<span class="token keyword">let</span> stream <span class="token operator">=</span> <span class="token module variable">Header</span><span class="token punctuation">.</span>to_stream header

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">rec</span> go <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">match</span> stream <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">with</span>
    <span class="token operator">|</span> <span class="token module variable">Some</span> buf <span class="token operator">-&gt;</span> print_string buf<span class="token punctuation">;</span> go <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">in</span>
  go <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>This code produces the following header:</p>
<div class="gatsby-highlight" data-language="mail"><pre class="language-mail"><code class="language-mail">Date: 2 Aug 2019 14:10:10 GMT
To: John &quot;D.&quot; &lt;john@doe.org&gt;
Sender: romain.calascibetta@gmail.com
Subject: A Simple Mail</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#78-character-rule" aria-label="78 character rule permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>78-character rule</h3>
<p>One aspect about email and SMTP is about some historical rules of how to
generate them. One of them is about the limitation of bytes per line. Indeed, a
generator of mail should emit at most 80 bytes per line - and, of course, it
should emits entirely the email line per line.</p>
<p>So <code>mrmime</code> has his own encoder which tries to wrap your mail into this limit.
It was mostly inspired by <a href="https://github.com/inhabitedtype/faraday">Faraday</a> and <a href="https://caml.inria.fr/pub/docs/manual-ocaml/libref/Format.html">Format</a> powered with
GADT to easily describe how to encode/generate parts of an email.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#a-multipart-email-generator" aria-label="a multipart email generator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A multipart email generator</h3>
<p>Of course, the main point about email is to be able to generate a multipart
email - just to be able to send file attachments. And, of course, a deep work
was done about that to make parts, compose them into specific <code>Content-Type</code>
fields and merge them into one email.</p>
<p>Eventually, you can easily make a stream from it, which respects rules (78 bytes
per line, stream line per line) and use it directly into an SMTP implementation.</p>
<p>This is what we did with the project <a href="https://github.com/dinosaure/facteur"><code>facteur</code></a>. It's a little
command-line tool to send with file attachement mails in pure OCaml - but it
works only on an UNIX operating system for instance.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#behind-the-forest" aria-label="behind the forest permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Behind the forest</h2>
<p>Even if you are able to parse and generate an email, more work is needed to get the expected results.</p>
<p>Indeed, email is a exchange unit between people and the biggest deal on that is
to find a common way to ensure a understable communication each others. About
that, encoding is probably the most important piece and when a French person wants
to communicate with a <em>latin1</em> encoding, an American person can still use ASCII.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#rosetta" aria-label="rosetta permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rosetta</h3>
<p>So about this problem, the choice was made to unify any contents to UTF-8 as the
most general encoding of the world. So, we did some libraries which map an encoding flow
to Unicode code-point, and we use <code>uutf</code> (thanks to <a href="https://github.com/dbuenzli">dbuenzli</a>) to normalize it to UTF-8.</p>
<p>The main goal is to avoid a headache to the user about that and even if
contents of the mail is encoded with <em>latin1</em> we ensure to translate it
correctly (and according RFCs) to UTF-8.</p>
<p>This project is <a href="https://github.com/mirage/rosetta"><code>rosetta</code></a> and it comes with:</p>
<ul>
<li><a href="https://github.com/mirage/uuuu"><code>uuuu</code></a> for ISO-8859 encoding</li>
<li><a href="https://github.com/mirage/coin"><code>coin</code></a> for KOI8-{R,U} encoding</li>
<li><a href="https://github.com/mirage/yuscii"><code>yuscii</code></a> for UTF-7 encoding</li>
</ul>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#pecu-and-base64" aria-label="pecu and base64 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pecu and Base64</h3>
<p>Then, bodies can be encoded in some ways, 2 precisely (if we took the main
standard):</p>
<ul>
<li>A base64 encoding, used to store your file</li>
<li>A quoted-printable encoding</li>
</ul>
<p>So, about the <code>base64</code> package, it comes with a sub-package <code>base64.rfc2045</code>
which respects the special case to encode a body according RFC2045 and SMTP
limitation.</p>
<p>Then, <code>pecu</code> was made to encode and decode <em>quoted-printable</em> contents. It was
tested and fuzzed of course like any others MirageOS's libraries.</p>
<p>These libraries are needed for an other historical reason which is: bytes used
to store mail should use only 7 bits instead of 8 bits. This is the purpose of
the base64 and the <em>quoted-printable</em> encoding which uses only 127 possibilities
of a byte. Again, this limitation comes with SMTP protocol.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p><code>mrmime</code> is tackling the difficult task to parse and generate emails according to 50 years of usability, several RFCs and legacy rules.
So, it
still is an experimental project. We reach the first version of it because we
are currently able to parse many mails and then generate them correctly.</p>
<p>Of course, a <em>bug</em> (a malformed mail, a server which does not respect standards
or a bad use of our API) can appear easily where we did not test everything. But
we have the feeling it was the time to release it and let people to use
it.</p>
<p>The best feedback about <code>mrmime</code> and the best improvement is yours. So don't be
afraid to use it and start to hack your emails with it.</p>|js}
  };
 
  { title = {js|Decompress: Experiences with OCaml optimization|js}
  ; slug = {js|decompress-experiences-with-ocaml-optimization|js}
  ; description = Some {js|In our first article we mostly discussed
the API design of decompress and did not talk too much about the issue of
optimizing performance…|js}
  ; url = {js|https://tarides.com/blog/2019-09-13-decompress-experiences-with-ocaml-optimization|js}
  ; date = {js|2019-09-13T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/fff1a2a9a2dbdd9ac7efd7c97ac5aa2a/96c5f/camel_sunset.jpg|js}
  ; featured = false
  ; body_html = {js|<p>In our <a href="https://tarides.com/blog/2019-08-26-decompress-the-new-decompress-api.html">first article</a> we mostly discussed
the API design of <code>decompress</code> and did not talk too much about the issue of
optimizing performance. In this second article, we will relate our experiences
of optimizing <code>decompress</code>.</p>
<p>As you might suspect, <code>decompress</code> needs to be optimized a lot. It was used by
several projects as an underlying layer of some formats (like Git), so it can be
a real bottleneck in those projects. Of course, we start with a footgun by using
a garbage-collected language; comparing the performance of <code>decompress</code> with a C
implementation (like <a href="https://zlib.net/">zlib</a> or <a href="https://github.com/richgel999/miniz">miniz</a>) is obviously not very fair.</p>
<p>However, using something like <code>decompress</code> instead of C implementations can be
very interesting for many purposes, especially when thinking about <em>unikernels</em>.
As we said in the previous article, we can take the advantage of the <em>runtime</em>
and the type-system to provide something <em>safer</em> (of course, it's not really
true since zlib has received several security audits).</p>
<p>The main idea in this article is not to give snippets to copy/paste into your
codebase but to explain some behaviors of the compiler / runtime and hopefully
give you some ideas about how to optimize your own code. We'll discuss the
following optimizations:</p>
<ul>
<li>specialization</li>
<li>inlining</li>
<li>untagged integers</li>
<li>exceptions</li>
<li>unrolling</li>
<li>hot-loop</li>
<li>caml_modify</li>
<li>representation sizes</li>
</ul>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#cautionary-advice" aria-label="cautionary advice permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cautionary advice</h3>
<p>Before we begin discussing optimization, keep this rule in mind:</p>
<blockquote>
<p>Only perform optimization at the <strong>end</strong> of the development process.</p>
</blockquote>
<p>An optimization pass
can change your code significantly, so you need to keep a state of your project
that can be trusted. This state will provide a comparison point for both
benchmarks and behaviors. In other words, your stable implementation will be the
oracle for your benchmarks. If you start with nothing, you'll achieve
arbitrarily-good performance at the cost of arbitrary behavior!</p>
<p>We optimized <code>decompress</code> because we are using it in bigger projects for a long
time (2 years). So we have an oracle (even if <code>zlib</code> can act as an oracle in
this special case).</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#specialization" aria-label="specialization permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Specialization</h2>
<p>One of the biggest specializations in <code>decompress</code> is regarding the <code>min</code>
function. If you don't know, in OCaml <code>min</code> is polymorphic; you can compare
anything. So you probably have some concerns about how <code>min</code> is implemented?</p>
<p>You are right to be concerned: if you examine the details, <code>min</code> calls the C
function <code>do_compare_val</code>, which traverses your structure and does a comparison
according the run-time representation of your structure. Of course, for integers, it
should be only a <code>cmpq</code> assembly instruction. However, some simple code like:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> x <span class="token operator">=</span> min <span class="token number">0</span> <span class="token number">1</span></code></pre></div>
<p>will produce this CMM and assembly code:</p>
<div class="gatsby-highlight" data-language="cmm"><pre class="language-cmm"><code class="language-cmm">(let x/1002 (app{main.ml:1,8-15} &quot;camlStdlib__min_1028&quot; 1 3 val)
   ...)</code></pre></div>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L101:
        movq    $3, %rbx
        movq    $1, %rax
        call    camlStdlib__min_1028@PLT</code></pre></div>
<p>Note that <em><a href="https://en.wikipedia.org/wiki/Lambda_calculus#Beta_reduction">beta-reduction</a></em>, <em><a href="https://en.wikipedia.org/wiki/Inline_expansion">inlining</a></em> and
specialization were not done in this code. OCaml does not optimize your code
very much &ndash; the good point is predictability of the produced assembly output.</p>
<p>If you help the compiler a little bit with:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">external</span> <span class="token punctuation">(</span> <span class="token operator">&lt;=</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> int <span class="token operator">-&gt;</span> int <span class="token operator">-&gt;</span> bool <span class="token operator">=</span> <span class="token string">&quot;%lessequal&quot;</span>
<span class="token keyword">let</span> min a b <span class="token operator">=</span> <span class="token keyword">if</span> a <span class="token operator">&lt;=</span> b <span class="token keyword">then</span> a <span class="token keyword">else</span> b <span class="token punctuation">[</span><span class="token operator">@@</span>inline<span class="token punctuation">]</span>

<span class="token keyword">let</span> x <span class="token operator">=</span> min <span class="token number">0</span> <span class="token number">1</span></code></pre></div>
<p>We have:</p>
<div class="gatsby-highlight" data-language="cmm"><pre class="language-cmm"><code class="language-cmm">(function{main.ml:2,8-43} camlMain__min_1003 (a/1004: val b/1005: val)
 (if (&lt;= a/1004 b/1005) a/1004 b/1005))

(function camlMain__entry ()
 (let x/1006 1 (store val(root-init) (+a &quot;camlMain&quot; 8) 1)) 1a)</code></pre></div>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L101:
        cmpq    %rbx, %rax
        jg      .L100
        ret</code></pre></div>
<p>So we have all optimizations, in this produced code, <code>x</code> was evaluated as <code>0</code>
(<code>let x/... (store ... 1)</code>) (beta-reduction and inlining) and <code>min</code> was
specialized to accept only integers &ndash; so we are able to emit <code>cmpq</code>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#results" aria-label="results permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Results</h3>
<p>With specialization, we won 10 Mb/s on decompression, where <code>min</code> is used
in several places. We completely avoid an indirection and a call to the slow
<code>do_compare_val</code> function.</p>
<p>This kind of specialization is already done by <a href="https://caml.inria.fr/pub/docs/manual-ocaml/flambda.html"><code>flambda</code></a>, however, we
currently use OCaml 4.07.1. So we decided to this kind of optimization by
ourselves.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#inlining" aria-label="inlining permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inlining</h2>
<p>In the first example, we showed code with the <code>[@@inline]</code> keyword which is
useful to force the compiler to inline a little function. We will go outside the
OCaml world and study C code (gcc 5.4.0) to really understand
<em>inlining</em>.</p>
<p>In fact, inlining is not necessarily the best optimization. Consider the
following (nonsensical) C program:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HIDE_ALIGNEMENT</span></span>
<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">,</span> noclone<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">hide</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> ac<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>av<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s <span class="token operator">=</span> <span class="token function">hide</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">clock_t</span> start <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1280000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    s<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span>

  <span class="token class-name">clock_t</span> end <span class="token operator">=</span> <span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%lld\\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We will compile this code with <code>-O2</code> (the second level of optimization in C),
once with <code>-DHIDE_ALIGNEMENT</code> and once without. The assembly emitted differs:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L3:
	movq	%rbp, %rdi
	call	strlen
	subl	$1, %ebx
	movb	$65, 0(%rbp,%rax)
	jne	.L3</code></pre></div>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L3:
	movl	(%rdx), %ecx
	addq	$4, %rdx
	leal	-16843009(%rcx), %eax
	notl	%ecx
	andl	%ecx, %eax
	andl	$-2139062144, %eax
	je	.L3</code></pre></div>
<p>In the first output (with <code>-DHIDE_ALIGNEMENT</code>), the optimization pass
decides to disable inlining of <code>strlen</code>; in the second output (without
<code>-DHIDEAlIGNEMENT</code>), it decides to inline <code>strlen</code> (and do some other clever
optimizations). The reason behind this complex behavior from the compiler is
clearly described <a href="https://stackoverflow.com/a/55589634">here</a>.</p>
<p>But what we want to say is that inlining is <strong>not</strong> an automatic optimization;
it might act as a <em>pessimization</em>. This is the goal of <code>flambda</code>: do the right
optimization under the right context. If you are really curious about what <code>gcc</code>
does and why, even if it's very interesting, the reverse engineering of the
optimization process and which information is relevant about the choice to
optimize or not is deep, long and surely too complicated.</p>
<p>A non-spontaneous optimization is to annotate some parts of your code with
<code>[@@inline never]</code> &ndash; so, explicitly say to the compiler to not inline the
function. This constraint is to help the compiler to generate a smaller code
which will have more chance to fit under the processor cache.</p>
<p>For all of these reasons, <code>[@@inline]</code> should be used sparingly and an oracle to
compare performances if you inline or not this or this function is necessary to
avoid a <em>pessimization</em>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#in-decompress" aria-label="in decompress permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In <code>decompress</code></h3>
<p>Inlining in <code>decompress</code> was done on small functions which need to allocate
to return a value. If we inline them, we can take the opportunity to store
returned value in registers (of course, it depends how many registers are free).</p>
<p>As we said, the goal of the inflator is to translate a bit sequence to a byte.
The largest bit sequence possible according to RFC 1951 has length 15. So, when
we process an inputs flow, we eat it 15 bits per 15 bits. For each packet, we
want to recognize an existing associated bit sequence and then, binded values
will be the real length of the bit sequence and the byte:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> find <span class="token punctuation">:</span> bits<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> len<span class="token punctuation">:</span> int<span class="token punctuation">;</span> byte<span class="token punctuation">:</span> int<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></div>
<p>So for each call to this function, we need to allocate a record/tuple. It's
why we choose to inline this function. <code>min</code> was inlined too and some other
small functions. But as we said, the situation is complex; where we think that
<em>inlining</em> can help us, it's not systematically true.</p>
<p>NOTE: we can recognize bits sequence with, at most, 15 bits because a
<a href="https://zlib.net/feldspar.html">Huffman coding</a> is <a href="https://en.wikipedia.org/wiki/Prefix_code">prefix-free</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#untagged-integers" aria-label="untagged integers permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Untagged integers</h2>
<p>When reading assembly, the integer <code>0</code> is written as <code>$1</code>.
It's because of the <a href="https://blog.janestreet.com/what-is-gained-and-lost-with-63-bit-integers/">GC bit</a> needed to differentiate a pointer
and an unboxed integer. This is why, in OCaml, we talk about a 31-bits integer
or a 63-bits integer (depending on your architecture).</p>
<p>We will not try to start a debate about this arbitrary choice on the
representation of an integer in OCaml. However, we can talk about some
operations which can have an impact on performances.</p>
<p>The biggest example is about the <code>mod</code> operation. Between OCaml and C, <code>%</code> or
<code>mod</code> should be the same:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> f a b <span class="token operator">=</span> a <span class="token operator">mod</span> b</code></pre></div>
<p>The output assembly is:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L105:
        movq    %rdi, %rcx
        sarq    $1, %rcx     // b &gt;&gt; 1
        movq    (%rsp), %rax
        sarq    $1, %rax     // a &gt;&gt; 1
        testq   %rcx, %rcx   // b != 0
        je      .L107
        cqto
        idivq   %rcx         // a % b
        jmp     .L106
.L107:
        movq    caml_backtrace_pos@GOTPCREL(%rip), %rax
        xorq    %rbx, %rbx
        movl    %ebx, (%rax)
        movq    caml_exn_Division_by_zero@GOTPCREL(%rip), %rax
        call    caml_raise_exn@PLT
.L106:
        salq    $1, %rdx     // x &lt;&lt; 1
        incq    %rdx         // x + 1
        movq    %rbx, %rax</code></pre></div>
<p>where idiomatically the same C code produce:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L2:
        movl    -12(%rbp), %eax
        cltd
        idivl   -8(%rbp)
        movl    %edx, -4(%rbp)</code></pre></div>
<p>Of course, we can notice firstly the exception in OCaml (<code>Divided_by_zero</code>) -
which is pretty good because it protects us against an interrupt from assembly
(and keep the trace). Then, we need to <em>untag</em> <code>a</code> and <code>b</code> with <code>sarq</code> assembly
operation. We do, as the C code, <code>idiv</code> and then we must <em>retag</em> returned value
<code>x</code> with <code>salq</code> and <code>incq</code>.</p>
<p>So in some parts, it should be more interesting to use <code>Nativeint</code>. However, by
default, a <code>nativeint</code> is boxed. <em>boxed</em> means that the value is allocated in
the OCaml heap alongside a header.</p>
<p>Of course, this is not what we want so, if our <code>nativeint ref</code> (to have
side-effect, like <code>x</code>) stay inside a function and then, you return the real
value with the deref <code>!</code> operator, OCaml, by a good planet alignment, can
directly use registers and real integers. So it should be possible to avoid
these needed conversions.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#readability-versus-performance" aria-label="readability versus performance permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Readability versus performance</h3>
<p>We use this optimization only in few parts of the code. In fact, switch
between <code>int</code> and <code>nativeint</code> is little bit noisy:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">hold <span class="token operator">:=</span> <span class="token module variable">Nativeint</span><span class="token punctuation">.</span>logor <span class="token operator">!</span>hold <span class="token module variable">Nativeint</span><span class="token punctuation">.</span><span class="token punctuation">(</span>shift_left <span class="token punctuation">(</span>of_int <span class="token punctuation">(</span>unsafe_get_uint8 d<span class="token punctuation">.</span>i <span class="token operator">!</span>i_pos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!</span>bits<span class="token punctuation">)</span></code></pre></div>
<p>In the end, we only gained 0.5Mb/s of inflation rate, so it's not worthwhile
to do systematically this optimization. Especially that the gain is not very
big. But this case show a more troubling problem: loss of readability.</p>
<p>In fact, we can optimize more and more a code (OCaml or C) but we lost, step by
step, readability. You should be afraid by the implementation of <code>strlen</code> for
example. In the end, the loss of readability makes it harder to understand the purpose
of the code, leading to errors whenever some other person (or you in 10 years time)
tries to make a change.</p>
<p>And we think that this kind of optimization is not the way of OCaml in general
where we prefer to produce an understandable and abstracted code than a cryptic
and super fast one.</p>
<p>Again, <code>flambda</code> wants to fix this problem and let the compiler to do this
optimization. The goal is to be able to write a fast code without any pain.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#exceptions" aria-label="exceptions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exceptions</h2>
<p>If you remember our <a href="https://tarides.com/blog/2019-02-08-release-of-base64.html">article</a> about the release of <code>base64</code>, we talked a
bit about exceptions and used them as a <em>jump</em>. In fact, it's pretty
common for an OCaml developer to break the control-flow with an exception.
Behind this common design/optimization, it's about calling convention.</p>
<p>Indeed, choose the <em>jump</em> word to describe OCaml exception is not the best where
we don't use <code>setjmp</code>/<code>longjmp</code>.</p>
<p>In the details, when you start a code with a <code>try .. with</code>, OCaml saves a <em>trap</em>
in the stack which contains information about the <code>with</code>, the catcher. Then,
when you <code>raise</code>, you <em>jump</em> directly to this trap and can just discard several
stack frames (and, by this way, you did not check each return codes).</p>
<p>In several places and mostly in the <em>hot-loop</em>, we use this <em>pattern</em>. However,
it completely breaks the control flow and can be error-prone.</p>
<p>To limit errors and because this pattern is usual, we prefer to use a <em>local</em>
exception which will be used only inside the function. By this way, we enforce
the fact that exception should not (and can not) be caught by something else
than inside the function.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml">    <span class="token keyword">let</span> <span class="token keyword">exception</span> <span class="token module variable">Break</span> <span class="token keyword">in</span>

    <span class="token punctuation">(</span> <span class="token keyword">try</span> <span class="token keyword">while</span> <span class="token operator">!</span>max <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token keyword">do</span>
          <span class="token keyword">if</span> bl_count<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">!</span>max<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">then</span> raise_notrace <span class="token module variable">Break</span>
        <span class="token punctuation">;</span> decr max <span class="token keyword">done</span> <span class="token keyword">with</span> <span class="token module variable">Break</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">;</span></code></pre></div>
<p>This code above produce this assembly code:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">.L105:
        pushq   %r14
        movq    %rsp, %r14
.L103:
        cmpq    $3, %rdi              // while !max &gt;= 1
        jl      .L102
        movq    -4(%rbx,%rdi,4), %rsi // bl_count,(!max)
        cmpq    $1, %rsi              // bl_count.(!max) != 0
        je      .L104
        movq    %r14, %rsp
        popq    %r14
        ret                           // raise_notrace Break
.L104:
        addq    $-2, %rdi             // decr max
        movq    %rdi, 16(%rsp)
        jmp     .L103</code></pre></div>
<p>Where the <code>ret</code> is the <code>raise_notrace Break</code>. A <code>raise_notrace</code> is needed,
otherwise, you will see:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">        movq    caml_backtrace_pos@GOTPCREL(%rip), %rbx
        xorq    %rdi, %rdi
        movl    %edi, (%rbx)
        call    caml_raise_exn@PLT</code></pre></div>
<p>Instead the <code>ret</code> assembly code. Indeed, in this case, we need to store where we
raised the exception.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#unrolling" aria-label="unrolling permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Unrolling</h2>
<p>When we showed the optimization done by <code>gcc</code> when the string is aligned, <code>gcc</code>
did another optimization. Instead of setting the string byte per byte, it decides to
update it 4 bytes per 4 bytes.</p>
<p>This kind of this optimization is an <em>unroll</em> and we did it in <code>decompress</code>.
Indeed, when we reach the <em>copy</em> <em>opcode</em> emitted by the <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">lz77</a>
compressor, we want to <em>blit</em> <em>length</em> byte(s) from a source to the outputs
flow. It can appear that this <code>memcpy</code> can be optimized to copy 4 bytes per 4
bytes &ndash; 4 bytes is generally a good idea where it's the size of an <code>int32</code> and
should fit under any architectures.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> blit src src_off dst dst_off <span class="token operator">=</span>
  <span class="token keyword">if</span> dst_off &ndash; src_off <span class="token operator">&lt;</span> <span class="token number">4</span>
  <span class="token keyword">then</span> slow_blit src src_off dst dst_off
  <span class="token keyword">else</span>
    <span class="token keyword">let</span> len0 <span class="token operator">=</span> len <span class="token operator">land</span> <span class="token number">3</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> len1 <span class="token operator">=</span> len <span class="token operator">asr</span> <span class="token number">2</span> <span class="token keyword">in</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> len1 &ndash; <span class="token number">1</span>
    <span class="token keyword">do</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">4</span> <span class="token keyword">in</span>
      <span class="token keyword">let</span> v <span class="token operator">=</span> unsafe_get_uint32 src <span class="token punctuation">(</span>src_off <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token keyword">in</span>
      unsafe_set_uint32 dst <span class="token punctuation">(</span>dst_off <span class="token operator">+</span> i<span class="token punctuation">)</span> v <span class="token punctuation">;</span>
    <span class="token keyword">done</span> <span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> len0 &ndash; <span class="token number">1</span>
    <span class="token keyword">do</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> len1 <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> i <span class="token keyword">in</span>
      <span class="token keyword">let</span> v <span class="token operator">=</span> unsafe_get_uint8 src <span class="token punctuation">(</span>src_off <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token keyword">in</span>
      unsafe_set_uint8 dst <span class="token punctuation">(</span>dst_off <span class="token operator">+</span> i<span class="token punctuation">)</span> v <span class="token punctuation">;</span>
    <span class="token keyword">done</span></code></pre></div>
<p>In this code, at the beginning, we copy 4 bytes per 4 bytes and if <code>len</code> is not
a multiple of 4, we start the <em>trailing</em> loop to copy byte per byte then. In
this context, OCaml can <em>unbox</em> <code>int32</code> and use registers. So this function does
not deal with the heap, and by this way, with the garbage collector.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#results-1" aria-label="results 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Results</h3>
<p>In the end, we gained an extra 10Mb/s of inflation rate. The <code>blit</code> function is the
most important function when it comes to inflating the window to an output flow.
As the specialization on the <code>min</code> function, this is one of the biggest optimization on
<code>decompress</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#hot-loop" aria-label="hot loop permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>hot-loop</em></h2>
<p>A common design about decompression (but we can find it on hash implementation
too), is the <em>hot-loop</em>. An <em>hot-loop</em> is mainly a loop on the most common
operation in your process. In the context of <code>decompress</code>, the <em>hot-loop</em> is
about a repeated translation from bits-sequence to byte(s) from the inputs flow
to the outputs flow and the window.</p>
<p>The main idea behind the <em>hot-loop</em> is to initialize all information needed for
the translation before to start the <em>hot-loop</em>. Then, it's mostly an imperative
loop with a <em>pattern-matching</em> which corresponds to the current state of the
global computation.</p>
<p>In OCaml, we can take this opportunity to use <code>int ref</code> (or <code>nativeint ref</code>), and then, they will be translated into registers (which is the fastest
area to store something).</p>
<p>Another deal inside the <em>hot-loop</em> is to avoid any allocation &ndash; and it's why we
talk about <code>int</code> or <code>nativeint</code>. Indeed, a more complex structure like an option
will add a blocker to the garbage collection (a call to <code>caml_call_gc</code>).</p>
<p>Of course, this kind of design is completely wrong if we think in a functional
way. However, this is the (biggest?) advantage of OCaml: hide this ugly/hacky
part inside a functional interface.</p>
<p>In the API, we talked about a state which represents the <em>inflation</em> (or the
<em>deflation</em>). At the beginning, the goal is to store into some references
essentials values like the position into the inputs flow, bits available,
dictionary, etc. Then, we launch the <em>hot-loop</em> and only at the end, we update the state.</p>
<p>So we keep the optimal design about <em>inflation</em> and the functional way outside
the <em>hot-loop</em>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#caml_modify" aria-label="caml_modify permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>caml_modify</h2>
<p>One issue that we need to consider is the call to <code>caml_modify</code>. In
fact, for a complex data-structure like an <code>int array</code> or a <code>int option</code> (so,
other than an integer or a boolean or an <em>immediate</em> value), values can move to the
major heap.</p>
<p>In this context, <code>caml_modify</code> is used to assign a new value into your mutable
block. It is a bit slower than a simple assignment but needed to
ensure pointer correspondence between minor heap and major heap.</p>
<p>With this OCaml code for example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">mutable</span> v <span class="token punctuation">:</span> int option <span class="token punctuation">}</span>

<span class="token keyword">let</span> f t v <span class="token operator">=</span> t<span class="token punctuation">.</span>v <span class="token operator">&lt;-</span> v</code></pre></div>
<p>We produce this assembly:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">camlExample__f_1004:
        subq    $8, %rsp
        movq    %rax, %rdi
        movq    %rbx, %rsi
        call    caml_modify@PLT
        movq    $1, %rax
        addq    $8, %rsp
        ret</code></pre></div>
<p>Where we see the call to <code>caml_modify</code> which will be take care about the
assignment of <code>v</code> into <code>t.v</code>. This call is needed mostly because the type of <code>t.v</code> is not an <em>immediate</em> value like an integer. So, for many values in the
<em>inflator</em> and the <em>deflator</em>, we mostly use integers.</p>
<p>Of course, at some points, we use <code>int array</code> and set them at some specific
points of the <em>inflator</em> &ndash; where we inflated the dictionary. However, the impact
of <code>caml_modify</code> is not very clear where it is commonly pretty fast.</p>
<p>Sometimes, however, it can be a real bottleneck in your computation and
this depends on how long your values live in the heap. A little program (which is
not very reproducible) can show that:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token module variable">Array</span><span class="token punctuation">.</span>init <span class="token punctuation">(</span>int_of_string <span class="token module variable">Sys</span><span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token module variable">Random</span><span class="token punctuation">.</span>int <span class="token number">256</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> pr fmt <span class="token operator">=</span> <span class="token module variable">Format</span><span class="token punctuation">.</span>printf fmt

<span class="token keyword">type</span> t0 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">mutable</span> v <span class="token punctuation">:</span> int option <span class="token punctuation">}</span>
<span class="token keyword">type</span> t1 <span class="token operator">=</span> <span class="token punctuation">{</span> v <span class="token punctuation">:</span> int option <span class="token punctuation">}</span>

<span class="token keyword">let</span> f0 <span class="token punctuation">(</span>t0 <span class="token punctuation">:</span> t0<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> <span class="token module variable">Array</span><span class="token punctuation">.</span>length t &ndash; <span class="token number">1</span>
  <span class="token keyword">do</span> <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token keyword">match</span> t0<span class="token punctuation">.</span>v<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">with</span>
             <span class="token operator">|</span> <span class="token module variable">Some</span> <span class="token punctuation">_</span> <span class="token keyword">as</span> v<span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> v
             <span class="token operator">|</span> <span class="token module variable">None</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">-&gt;</span> <span class="token module variable">Some</span> i
             <span class="token operator">|</span> <span class="token module variable">None</span><span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span> <span class="token keyword">in</span>
     t0<span class="token punctuation">.</span>v <span class="token operator">&lt;-</span> v
  <span class="token keyword">done</span><span class="token punctuation">;</span> t0

<span class="token keyword">let</span> f1 <span class="token punctuation">(</span>t1 <span class="token punctuation">:</span> t1<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> t1 <span class="token operator">=</span> ref t1 <span class="token keyword">in</span>
  <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> <span class="token module variable">Array</span><span class="token punctuation">.</span>length t &ndash; <span class="token number">1</span>
  <span class="token keyword">do</span> <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">!</span>t1<span class="token punctuation">.</span>v<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">with</span>
             <span class="token operator">|</span> <span class="token module variable">Some</span> <span class="token punctuation">_</span> <span class="token keyword">as</span> v<span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> v
             <span class="token operator">|</span> <span class="token module variable">None</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">-&gt;</span> <span class="token module variable">Some</span> i
             <span class="token operator">|</span> <span class="token module variable">None</span><span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span> <span class="token keyword">in</span>
     t1 <span class="token operator">:=</span> <span class="token punctuation">{</span> v <span class="token punctuation">}</span>
  <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token operator">!</span>t1

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> t0 <span class="token punctuation">:</span> t0 <span class="token operator">=</span> <span class="token punctuation">{</span> v<span class="token operator">=</span> <span class="token module variable">None</span> <span class="token punctuation">}</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> t1 <span class="token punctuation">:</span> t1 <span class="token operator">=</span> <span class="token punctuation">{</span> v<span class="token operator">=</span> <span class="token module variable">None</span> <span class="token punctuation">}</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> time0 <span class="token operator">=</span> <span class="token module variable">Unix</span><span class="token punctuation">.</span>gettimeofday <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  ignore <span class="token punctuation">(</span>f0 t0<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token keyword">let</span> time1 <span class="token operator">=</span> <span class="token module variable">Unix</span><span class="token punctuation">.</span>gettimeofday <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  ignore <span class="token punctuation">(</span>f1 t1<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token keyword">let</span> time2 <span class="token operator">=</span> <span class="token module variable">Unix</span><span class="token punctuation">.</span>gettimeofday <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>

  pr <span class="token string">&quot;f0: %f ns\\n%!&quot;</span> <span class="token punctuation">(</span>time1 <span class="token operator">-.</span> time0<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  pr <span class="token string">&quot;f1: %f ns\\n%!&quot;</span> <span class="token punctuation">(</span>time2 <span class="token operator">-.</span> time1<span class="token punctuation">)</span> <span class="token punctuation">;</span>

  <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>In our bare-metal server, if you launch the program with 1000, the <code>f0</code>
computation, even if it has <code>caml_modify</code> will be the fastest. However, if you
launch the program with 1000000000, <code>f1</code> will be the fastest.</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ ./a.out 1000
f0: 0.000006 ns
f1: 0.000015 ns
$ ./a.out 1000000000
f0: 7.931782 ns
f1: 5.719370 ns</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#about-decompress" aria-label="about decompress permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>About <code>decompress</code></h3>
<p>At the beginning, our choice was made to have, as @dbuenzli does, mutable
structure to represent state. Then, @yallop did a big patch to update it to an
immutable state and we won 9Mb/s on <em>inflation</em>.</p>
<p>However, the new version is more focused on the <em>hot-loop</em> and it is 3
times faster than before.</p>
<p>As we said, the deal about <code>caml_modify</code> is not clear and depends a lot about
how long your data lives in the heap and how many times you want to update it.
If we localize <code>caml_modify</code> only on few places, it should be fine. But it still
is one of the most complex question about (macro?) optimization.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#smaller-representation" aria-label="smaller representation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Smaller representation</h2>
<p>We've discussed the impact that integer types can have on the use of immediate
values. More generally, the choice of type to represent your values can have
significant performance implications.</p>
<p>For example, a dictionary which associates a bits-sequence (an integer) to the
length of it <strong>AND</strong> the byte, it can be represented by a: <code>(int * int) array</code>, or
more idiomatically <code>{ len: int; byte: int; } array</code> (which is structurally the
same).</p>
<p>However, that means an allocation for each bytes to represent every bytes.
Extraction of it will need an allocation if <code>find : bits:int -&gt; { len: int; byte: int; }</code> is not inlined as we said. And about memory, the array can be
really <em>heavy</em> in your heap.</p>
<p>At this point, we used <code>spacetime</code> to show how many blocks we allocated for a
common <em>inflation</em> and we saw that we allocate a lot. The choice was made to use
a smaller representation. Where <code>len</code> can not be upper than 15 according RFC 1951
and when byte can represent only 256 possibilities (and should fit under one
byte), we can decide to merge them into one integer (which can have, at least,
31 bits).</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> static_literal_tree <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> static_literal_tree <span class="token operator">=</span> <span class="token module variable">Array</span><span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>len<span class="token punctuation">,</span> byte<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>len <span class="token operator">lsl</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">lor</span> byte<span class="token punctuation">)</span> static_literal_tree</code></pre></div>
<p>In the code above, we just translate the static dictionary (for a STATIC DEFLATE
block) to a smaller representation where <code>len</code> will be the left part of the
integer and <code>byte</code> will be the right part. Of course, it's depends on what you
want to store.</p>
<p>Another point is readability. <a href="https://github.com/mirage/ocaml-cstruct#ppx"><code>cstruct-ppx</code></a> and
<a href="https://bitbucket.org/thanatonauts/bitstring/src"><code>bitstring</code></a> can help you but <code>decompress</code>
wants to depend only on OCaml.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>We conclude with some closing advice about optimising your OCaml programs:</p>
<ul>
<li>
<p><strong>Optimization is specific to your task</strong>. The points highlighted in this
article may not fit your particular problem, but they are intended to give you
ideas. Our optimizations were only possible because we completely assimilated
the ideas of <code>zlib</code> and had a clear vision of what we really needed to
optimize (like <code>blit</code>).
<br/><br/>
As your first project, this article can not help you a lot to optimize your
code where it's mostly about <em>micro</em>-optimization under a specific context
(<em>hot-loop</em>). But it helps you to understand what is really done by the
compiler &ndash; which is still really interesting.</p>
</li>
<li>
<p><strong>Optimise only with respect to an oracle</strong>. All optimizations were done
because we did a comparison point between the old implementation of
<code>decompress</code> and <code>zlib</code> as oracles. Optimizations can change the semantics of your
code and you should systematically take care at any step about expected
behaviors. So it's a long run.</p>
</li>
<li>
<p><strong>Use the predictability of the OCaml compiler to your advantage</strong>. For sure,
the compiler does not optimize a lot your code &ndash; but it sill produce realistic
programs if we think about performance. For many cases, <strong>you don't need</strong> to
optimize your OCaml code. And the good point is about expected behavior.
<br/><br/>
The mind-link between the OCaml and the assembly exists (much more than the C
and the assembly sometimes where we let the C compiler to optimize the code).
The cool fact is to keep a mental-model about what is going on on your code
easily without to be afraid by what the compiler can produce. And, in some
critical parts like <a href="https://github.com/mirage/eqaf">eqaf</a>, it's really needed.</p>
</li>
</ul>
<p>We have not discussed benchmarking, which is another hard issue: who should you
compare with? where? how? For example, a global comparison between <code>zlib</code> and
<code>decompress</code> is not very relevant in many ways &ndash; especially because of the
garbage collector. This could be another article!</p>
<p>Finally, all of these optimizations should be done by <code>flambda</code>; the difference
between compiling <code>decompress</code> with or without <code>flambda</code> is not very big. We
optimized <code>decompress</code> by hand mostly to keep compatibility with OCaml (since
<code>flambda</code> needs another switch) and, in this way, to gain an understanding of
<code>flambda</code> optimizations so that we can use it effectively!</p>|js}
  };
 
  { title = {js|An introduction to fuzzing OCaml with AFL, Crowbar and Bun|js}
  ; slug = {js|an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun|js}
  ; description = Some {js|American Fuzzy Lop or AFL is a fuzzer: a program that tries to find bugs in
other programs by sending them various auto-generated inputs…|js}
  ; url = {js|https://tarides.com/blog/2019-09-04-an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun|js}
  ; date = {js|2019-09-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/4eed05522f6733d728f6dc01bbe33e09/eee8e/feather.jpg|js}
  ; featured = false
  ; body_html = {js|<p><a href="http://lcamtuf.coredump.cx/afl/">American Fuzzy Lop</a> or AFL is a <em>fuzzer</em>: a program that tries to find bugs in
other programs by sending them various auto-generated inputs. This article covers the
basics of AFL and shows an example of fuzzing a parser written in OCaml. It also introduces two
extensions: the <a href="https://github.com/stedolan/crowbar/">Crowbar</a> library which can be used to fuzz any kind of OCaml program or
function and the <a href="https://github.com/yomimono/ocaml-bun/">Bun</a> tool for integrating fuzzing into your CI.</p>
<p>All of the examples given in this article are available on GitHub at
<a href="https://github.com/NathanReb/ocaml-afl-examples">ocaml-afl-examples</a>. The <code>README</code> contains all the information you need to understand,
build and fuzz them yourself.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#what-is-afl" aria-label="what is afl permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is AFL?</h2>
<p>AFL actually isn't <em>just</em> a fuzzer but a set of tools. What makes it so good is that it doesn't just
blindly send random input to your program hoping for it to crash; it inspects the execution paths
of the program and uses that information to figure out which mutations to apply to the previous
inputs to trigger new execution paths. This approach allows for much more efficient and reliable
fuzzing (as it will try to maximize coverage) but requires the binaries to be instrumented so the
execution can be monitored.</p>
<p>AFL provides wrappers for the common C compilers that you can use to produce the instrumented
binaries along with the CLI fuzzing client: <code>afl-fuzz</code>.</p>
<p><code>afl-fuzz</code> is straight-forward to use. It takes an input directory containing a few initial valid
inputs to your program, an output directory and the instrumented binary. It will then repeatedly
mutate the inputs and feed them to the program, registering the ones that lead to crashes or
hangs in the output directory.</p>
<p>Because it works in such a way, it makes it very easy to fuzz a parser.</p>
<p>To fuzz a <code>parse.exe</code> binary, that takes a file as its first command-line argument and parses it,
you can invoke <code>afl-fuzz</code> in the following way:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ afl-fuzz -i inputs/ -o findings/ /path/to/parse.exe @@</code></pre></div>
<p>The <code>findings/</code> directory is where <code>afl-fuzz</code> will write the crashes it finds, it will create it
for you if it doesn't exist.
The <code>inputs/</code> directory contains one or more valid input files for your
program. By valid we mean &quot;that don't crash your program&quot;.
Finally the <code>@@</code> part tells <code>afl-fuzz</code> where on the command line the input file should be passed to
your program, in our case, as the first argument.</p>
<p>Note that it is possible to supply <code>afl-fuzz</code> with more detail about how to invoke your program. If
you need to pass it command-line options for instance, you can run it as:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ afl-fuzz -i inputs/ -o findings/ -- /path/to/parse.exe --option=value @@</code></pre></div>
<p>If you wish to fuzz a program that takes its input from standard input, you can also do that by removing the
<code>@@</code> from the <code>afl-fuzz</code> invocation.</p>
<p>Once <code>afl-fuzz</code> starts, it will draw a fancy looking table on the standard output to keep you
updated about its progress. From there, you'll mostly be interested in is the top right
corner which contains the number of crashes and hangs it has found so far:</p>
<p><span class="gatsby-resp-image-wrapper" style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; ">
      <a href="https://tarides.com/static/893fd2c3d0dfbb1c576fd016b6963e96/f2793/afl_example_output.png" class="gatsby-resp-image-link" style="display: block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 63.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACMUlEQVQ4y2WT6W7bMBCEqdsSD1ESD1Fx4jhuDDTv/35fQSZGk/bHggI4Ozs7HAkhBP+WtYIQBMsi2FaBsRViWRFLj9gEwv7f87f6HjFNiHFEaE3ddkjZolRTTikbxqmlk5Jm7GlkTTU2CCm/KvdOiLqmqWvEMI7IeWbzHp8SUilub7+wdmXfE/t+EHxkz/frVlSouuXded5i5DUELlKzDCNVUyO0MWwh4GLEhYBSitfXV5xzHMeBtbYM6aeJIW8iBHPX8mEUH+vC79Vy7ztc1xWVIqvTMTKnhEkJZUwhCyGwLEshaLqO07ahvMecn5gGSWwDaXBchgM1aERT0bUdwqwrKiVsSuh9L2pijKX6vqeqKsZp+hx4HKwpMcWEnR3ORYI7MMpQVxVdVmmXpXi3hoC2ltvbG25d2WPEGFMUjuNYMPF8xjqHmmeeguO6R/SpL5g8uGmanIa1+OdjLITP1ytjJqrrAsrg0+lEDIHgfVGux5Ena7lvjqd5/knYS4lMiXnfGbJ31yvLywuL98XDNVuiFHWORdvSNg3NMDDmjS4Xhhjp+r5Epqy8WMv5OAjOYZTi/XYjel9Wf7lcuN1uReH38ObGlH12Dqs1wzB8Pl5WqLUmHQc+v6AxvN/vxH0v0TFak+/btv1BOE0T5+fnkoR5nvE+UImvlfMquSETPjKYfdr3vYAfJNmj757mfGZ8xqT8Q2ySpv0i/LfypFx50OP7+92DOJeUkuE0IGZBVVf8AS4+KX9Wn+12AAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img src="https://tarides.com/static/893fd2c3d0dfbb1c576fd016b6963e96/c5bb3/afl_example_output.png" class="gatsby-resp-image-image" alt="Example output from afl-fuzz" title="Example output from afl-fuzz" srcset="/static/893fd2c3d0dfbb1c576fd016b6963e96/04472/afl_example_output.png 170w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/9f933/afl_example_output.png 340w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/c5bb3/afl_example_output.png 680w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/f2793/afl_example_output.png 743w" sizes="(max-width: 680px) 100vw, 680px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;" loading="lazy" decoding="async"/>
  </a>
    </span></p>
<p>You might need to change some of your CPU settings to achieve better performance while fuzzing.
<code>afl-fuzz</code>'s output will tell you if that's the case and guide you through the steps required to
make that happen.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#using-afl-to-fuzz-an-ocaml-parser" aria-label="using afl to fuzz an ocaml parser permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using AFL to fuzz an OCaml parser</h2>
<p>First of all, if you want to fuzz an OCaml program with AFL you'll need to produce an instrumented
binary. <code>afl-fuzz</code> has an option to work with regular binaries but you'd lose a lot of what makes it
efficient. To instrument your binary you can simply install a <code>+afl</code> opam switch and build your
executable from there. AFL compiler variants are available from OCaml <code>4.05.0</code> onwards. To install such
a switch you can run:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ opam switch create fuzzing-switch 4.07.1+afl</code></pre></div>
<p>If your program already parses the standard input or a file given to it via the command line, you
can simply build the executable from your <code>+afl</code> switch and adapt the above examples. If it doesn't,
it's still easy to fuzz any parsing function.</p>
<p>Imagine we have a <code>simple-parser</code> library which exposes the following <code>parse_int</code> function:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> parse_int<span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>int<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&gt;</span> <span class="token variant variable">`Msg</span> <span class="token keyword">of</span> string<span class="token punctuation">]</span><span class="token punctuation">)</span> result
<span class="token comment">(** Parse the given string as an int or return [Error (`Msg _)].
    Does not raise, usually... *)</span></code></pre></div>
<p>We want to use AFL to make sure our function is robust and won't crash when receiving unexpected
inputs. As you can see the function returns a result and isn't supposed to raise exceptions. We want
to make sure that's true.</p>
<p>To find crashes, AFL traps the signals sent by your program. That means that it will consider
uncaught OCaml exceptions as crashes. That's good because it makes it really simple to write a
<code>fuzz_me.ml</code> executable that fits what <code>afl-fuzz</code> expects:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token module variable">Sys</span><span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> ic <span class="token operator">=</span> open_in file <span class="token keyword">in</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> in_channel_length ic <span class="token keyword">in</span>
  <span class="token keyword">let</span> content <span class="token operator">=</span> really_input_string ic length <span class="token keyword">in</span>
  close_in ic<span class="token punctuation">;</span>
  ignore <span class="token punctuation">(</span><span class="token module variable">Simple_parser</span><span class="token punctuation">.</span>parse_int content<span class="token punctuation">)</span></code></pre></div>
<p>We have to provide example inputs to AFL so we can write a <code>valid</code> file to the <code>inputs/</code> directory
containing <code>123</code> and an <code>invalid</code> file containing <code>not an int</code>. Both should parse without crashing
and make good starting point for AFL as they should trigger different execution paths.</p>
<p>Because we want to make sure AFL does find crashes we can try to hide a bug in our function:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> parse_int s <span class="token operator">=</span>
  <span class="token keyword">match</span> <span class="token module variable">List</span><span class="token punctuation">.</span>init <span class="token punctuation">(</span><span class="token module variable">String</span><span class="token punctuation">.</span>length s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token module variable">String</span><span class="token punctuation">.</span>get s<span class="token punctuation">)</span> <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">;</span> <span class="token string">'b'</span><span class="token punctuation">;</span> <span class="token string">'c'</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> failwith <span class="token string">&quot;secret crash&quot;</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>
      <span class="token keyword">match</span> int_of_string_opt s <span class="token keyword">with</span>
      <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">Error</span> <span class="token punctuation">(</span><span class="token variant variable">`Msg</span> <span class="token punctuation">(</span><span class="token module variable">Printf</span><span class="token punctuation">.</span>sprintf <span class="token string">&quot;Not an int: %S&quot;</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">|</span> <span class="token module variable">Some</span> i <span class="token operator">-&gt;</span> <span class="token module variable">Ok</span> i<span class="token punctuation">)</span></code></pre></div>
<p>Now we just have to build our native binary from the right switch and let <code>afl-fuzz</code> do the rest:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ afl-fuzz -i inputs/ -o findings/ ./fuzz_me.exe @@</code></pre></div>
<p>It should find that the <code>abc</code> input leads to a crash rather quickly. Once it does, you'll see it in
the top right corner of its output as shown in the picture from the previous section.</p>
<p>At this point you can interrupt <code>afl-fuzz</code> and have a look at the content of the <code>findings/crashes</code>:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ ls findings/crashes/
id:000000,sig:06,src:000111,op:havoc,rep:16  README.txt</code></pre></div>
<p>As you can see it contains a <code>README.txt</code> which will give you some details about the <code>afl-fuzz</code>
invocation used to find the crashes and how to reproduce them in the folder and a file of the form
<code>id:...,sig:...,src:...,op:...,rep:...</code> per crash it found. Here there's just one:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ cat findings/crashes/id:000000,sig:06,src:000111,op:havoc,rep:16
abc</code></pre></div>
<p>As expected it contains our special input that triggers our secret crash. We can rerun the program
with that input ourselves to make sure it does trigger it:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ ./fuzz_me.exe findings/crashes/id:000000,sig:06,src:000111,op:havoc,rep:16
Fatal error: exception Failure(&quot;secret crash&quot;)</code></pre></div>
<p>No surprise here, it does trigger our uncaught exception and crashes shamefully.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#using-crowbar-and-afl-for-property-based-testing" aria-label="using crowbar and afl for property based testing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Crowbar and AFL for property-based testing</h2>
<p>This works well but only being able to fuzz parsers is quite a limitation. That's where <a href="https://github.com/stedolan/crowbar/">Crowbar</a>
comes into play.</p>
<p>Crowbar is a property-based testing framework. It's much like Haskell's <a href="http://hackage.haskell.org/package/QuickCheck">QuickCheck</a>.
To test a given function, you define how its arguments are shaped, a set of properties the result
should satisfy and it will make sure they hold with any combinations of randomly generated
arguments.
Let's clarify that with an example.</p>
<p>I wrote a library called <code>Awesome_list</code> and I want to test its <code>sort</code> function:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> sort<span class="token punctuation">:</span> int list <span class="token operator">-&gt;</span> int list
<span class="token comment">(** Sorts the given list of integers. Result list is sorted in increasing
    order, most of the time... *)</span></code></pre></div>
<p>I want to make sure it really works so I'm going to use Crowbar to generate a whole lot of
lists of integers and verify that when I sort them with <code>Awesome_list.sort</code> the result is, well...
sorted.</p>
<p>We'll write our tests in a <code>fuzz_me.ml</code> file.
First we need to tell Crowbar how to generate arguments for our function. It exposes some
combinators to help you do that:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> int_list <span class="token operator">=</span> <span class="token module variable">Crowbar</span><span class="token punctuation">.</span><span class="token punctuation">(</span>list <span class="token punctuation">(</span>range <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>Here we're telling Crowbar to generate lists of any size, containing integers ranging from 0
to 10. Crowbar also exposes more complex and custom generator combinators so don't worry,
you can use it to build more complex arguments.</p>
<p>Now we need to define our property. Once again it's pretty simple, we just want the output to be
sorted:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> is_sorted l <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">rec</span> is_sorted <span class="token operator">=</span> <span class="token keyword">function</span>
    <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">_</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span>
    <span class="token operator">|</span> hd<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">(</span>hd'<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">_</span> <span class="token keyword">as</span> tl<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> hd <span class="token operator">&lt;=</span> hd' <span class="token operator">&amp;&amp;</span> is_sorted tl
  <span class="token keyword">in</span>
  <span class="token module variable">Crowbar</span><span class="token punctuation">.</span>check <span class="token punctuation">(</span>is_sorted l<span class="token punctuation">)</span></code></pre></div>
<p>All that's left to do now is to register our test:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token module variable">Crowbar</span><span class="token punctuation">.</span>add_test <span class="token label function">~name</span><span class="token punctuation">:</span><span class="token string">&quot;Awesome_list.sort&quot;</span> <span class="token punctuation">[</span>int_list<span class="token punctuation">]</span>
      <span class="token punctuation">(</span><span class="token keyword">fun</span> l <span class="token operator">-&gt;</span> is_sorted <span class="token punctuation">(</span><span class="token module variable">Awesome_list</span><span class="token punctuation">.</span>sort l<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>and to compile that <code>fuzz_me.ml</code> file to a binary. Crowbar will take care of the magic.</p>
<p>We can run that binary in &quot;Quickcheck&quot; mode where it will either try a certain amount of random
inputs or keep trying until one of the properties breaks depending on the command-line options
we pass it.
What we're interested in here is its less common &quot;AFL&quot; mode. Crowbar made it so our executable
can be used with <code>afl-fuzz</code> just like that:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ afl-fuzz -i inputs -o findings -- ./fuzz_me.exe @@</code></pre></div>
<p>What will happen then is that our <code>fuzz_me.exe</code> binary will read the inputs provided by <code>afl-fuzz</code>
and use it to determine which test to run and how to generate the arguments to pass to our function.
If the properties are satisfied, the binary will exit normally; if they aren't, it will make sure
that <code>afl-fuzz</code> interprets that as a crash by raising an exception.</p>
<p>A nice side-effect of Crowbar's approach is that <code>afl-fuzz</code> will still be able to pick up
crashes. For instance, if we implement <code>Awesome_list.sort</code> as:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> sort <span class="token operator">=</span> <span class="token keyword">function</span>
  <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> failwith <span class="token string">&quot;secret crash&quot;</span>
  <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span>
  <span class="token operator">|</span> l <span class="token operator">-&gt;</span> <span class="token module variable">List</span><span class="token punctuation">.</span>sort <span class="token module variable">Pervasives</span><span class="token punctuation">.</span>compare l</code></pre></div>
<p>and use AFL and Crowbar to fuzz-test our function, it will find two crashes: one for the input
<code>[1; 2; 3]</code> which triggers a crash and one for <code>[4; 5; 6]</code> for which the <code>is_sorted</code>
property won't hold.</p>
<p>The content of the input files found by <code>afl-fuzz</code> itself won't be of much help as it needs to be
interpreted by Crowbar to build the arguments that were passed to the function to trigger the bug.
We can invoke the <code>fuzz_me.exe</code> binary ourselves on one of the files in <code>findings/crashes</code>
and the Crowbar binary will replay the test and give us some more helpful information about what
exactly is going on:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ ./fuzz_me.exe findings/crashes/id\\:000000\\,sig\\:06\\,src\\:000011\\,op\\:flip1\\,pos\\:5 
Awesome_list.sort: ....
Awesome_list.sort: FAIL

When given the input:

    [1; 2; 3]
    
the test threw an exception:

    Failure(&quot;secret crash&quot;)
    Raised at file &quot;stdlib.ml&quot;, line 33, characters 17-33
    Called from file &quot;awesome-list/fuzz/fuzz_me.ml&quot;, line 11, characters 78-99
    Called from file &quot;src/crowbar.ml&quot;, line 264, characters 16-19
    
Fatal error: exception Crowbar.TestFailure
$ ./fuzz_me.exe findings/crashes/id\\:000001\\,sig\\:06\\,src\\:000027\\,op\\:arith16\\,pos\\:5\\,val\\:+7 
Awesome_list.sort: ....
Awesome_list.sort: FAIL

When given the input:

    [4; 5; 6]
    
the test failed:

    check false
    
Fatal error: exception Crowbar.TestFailure</code></pre></div>
<p>We can see the actual inputs as well as distinguish the one that broke the invariant from the one
that triggered a crash.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#using-bun-to-run-fuzz-testing-in-ci" aria-label="using bun to run fuzz testing in ci permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using <code>bun</code> to run fuzz testing in CI</h2>
<p>While AFL and Crowbar provide no guarantees they can give you confidence that your implementation
is not broken. Now that you know how to use them, a natural follow-up is to want to run fuzz tests
in your CI to enforce that level of confidence.</p>
<p>Problem is, AFL isn't very CI friendly. First it has this refreshing output that isn't going to look
great on your travis builds output and it doesn't tell you much besides that it could or couldn't find
crashes or invariant infrigements</p>
<p>Hopefully, like most problems, this one has a solution:
<a href="https://github.com/yomimono/ocaml-bun/"><code>bun</code></a>.
<code>bun</code> is a CLI wrapper around <code>afl-fuzz</code>, written in OCaml, that helps you get the best out of AFL
effortlessly. It mostly does two things:</p>
<p>The first is that it will run several <code>afl-fuzz</code> processes in parallel
(one per core by default). <code>afl-fuzz</code> starts with a bunch of deterministic steps. In my experience,
using parallel processes during this phase rarely proved very useful as they tend to find the same
bugs or slight variations of those bugs. It only achieves its full potential in the second phase of
fuzzing.</p>
<p>The second thing, which is the one we're the most interested in, is that <code>bun</code> provides a useful
and CI-friendly summary of what's going on with all the fuzzing processes so far. When one of them
finds a crash, it will stop all processes and pretty-print all of the bug-triggering inputs to help
you reproduce and debug them locally. See an example <code>bun</code> output after a crash was found:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Crashes found! Take a look; copy/paste to save for reproduction:
1432	echo JXJpaWl0IA== | base64 -d &gt; crash_0.$(date -u +%s)
1433	echo NXJhkV8QAA== | base64 -d &gt; crash_1.$(date -u +%s)
1434	echo J3Jh//9qdGFiYmkg | base64 -d &gt; crash_2.$(date -u +%s)
1435	09:35.32:[ERROR]All fuzzers finished, but some crashes were found!</code></pre></div>
<p>Using <code>bun</code> is very similar to using <code>afl-fuzz</code>. Going back to our first parser example, we can
fuzz it with <code>bun</code> like this:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ bun --input inputs/ --output findings/ /path/to/parse.exe</code></pre></div>
<p>You'll note that you don't need to provide the <code>@@</code> anymore. <code>bun</code> assumes that it should pass the
input as the first argument of your to-be-fuzzed binary.</p>
<p><code>bun</code> also comes with an alternative <code>no-kill</code> mode which lets all the fuzzers run indefinitely
instead of terminating them whenever a crash is discovered. It will regularly keep you updated on
the number of crashes discovered so far and when terminated will pretty-print each of them just like
it does in regular mode.</p>
<p>This mode can be convenient if you suspect your implementation may contain a lot of bugs and
you don't want to go through the whole process of fuzz testing it to only find a single bug.</p>
<p>You can use it in CI by running <code>bun --no-kill</code> via <code>timeout</code>. For instance:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">timeout --preserve-status 60m bun --no-kill --input inputs --output findings ./fuzz_me.exe</code></pre></div>
<p>will fuzz <code>fuzz_me.exe</code> for an hour no matter what happens. When <code>timeout</code> terminates <code>bun</code>, it will
provide you with a handful of bugs to fix!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#final-words" aria-label="final words permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Final words</h2>
<p>I really want to encourage you to use those tools and fuzzing in general.
Crowbar and <code>bun</code> are fairly new so you will probably encounter bugs or find that it lacks a feature
you want but combined with AFL they make for very nice tools to effectively test
critical components of your OCaml code base or infrastructure and detect newly-introduced bugs.
They are already used accross the MirageOS ecosystem where it has been used to fuzz the TCP/IP stack
<a href="https://github.com/mirage/mirage-tcpip">mirage-tcpip</a> and the DHCP implementation <a href="https://github.com/mirage/charrua">charrua</a> thanks to
<a href="https://github.com/yomimono/somerandompacket">somerandompacket</a>.
You can consult Crowbar's <a href="https://github.com/stedolan/crowbar/issues/2">hall of fame</a> to find out about bugs uncovered by this
approach.</p>
<p>I also encourage anyone interested to join us in using this promising toolchain, report those bugs,
contribute those extra features and help the community build more robust software.</p>
<p>Finally if you wish to learn more about how to efficienly use fuzzing for testing I recommend the
excellent <a href="https://blog.regehr.org/archives/1687">Write Fuzzable Code</a> article by John Regehr.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2019 edition|js}
  ; slug = {js|what-the-interns-have-wrought-2019-edition|js}
  ; description = Some {js|Jane Street’s intern program yet again is coming to an end, which is anice opportunity to look back over the summer and see what they’veaccomplished.|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2019/|js}
  ; date = {js|2019-08-30T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/what-the-interns-have-wrought-2019/what_interns_wrought2019.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street&rsquo;s intern program yet again is coming to an end, which is a
nice opportunity to look back over the summer and see what they&rsquo;ve
accomplished.</p>|js}
  };
 
  { title = {js|Decompress: The New Decompress API|js}
  ; slug = {js|decompress-the-new-decompress-api|js}
  ; description = Some {js|RFC 1951 is one of the most used standards. Indeed,
when you launch your Linux kernel, it inflates itself according zlib
standard, a…|js}
  ; url = {js|https://tarides.com/blog/2019-08-26-decompress-the-new-decompress-api|js}
  ; date = {js|2019-08-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/eeb13afbb9190097a8d04be9e1361642/6b50e/hammock.jpg|js}
  ; featured = false
  ; body_html = {js|<p><a href="https://tools.ietf.org/html/rfc1951">RFC 1951</a> is one of the most used standards. Indeed,
when you launch your Linux kernel, it inflates itself according <a href="https://zlib.net/">zlib</a>
standard, a superset of RFC 1951. Being a widely-used standard, we decided to
produce an OCaml implementation. In the process, we learned many lessons about
developing OCaml where we would normally use C. So, we are glad to present
<a href="https://github.com/mirage/decompress"><code>decompress</code></a>.</p>
<p>One of the many users of RFC 1951 is <a href="https://git-scm.com/">Git</a>, which uses it to pack data
objects into a <a href="https://git-scm.com/book/en/v2/Git-Internals-Packfiles">PACK file</a>. At the request of <a href="https://github.com/samoht">@samoht</a>,
<code>decompress</code> appeared some years ago as a Mirage-compatible replacement for zlib
to be used for compiling a <a href="https://mirage.io/">MirageOS</a> unikernel with
<a href="https://github.com/mirage/ocaml-git/">ocaml-git</a>. Today, this little project passes a major release with
substantial improvements in several domains.</p>
<p><code>decompress</code> provides an API for inflating and deflating <em>flows</em><code>[1]</code>. The main
goal is to provide a <em>platform-agnostic</em> library: one which may be compiled on
any platform, including JavaScript. We surely cannot be faster than C
implementations like <a href="https://github.com/facebook/zstd">zstd</a> or <a href="https://github.com/lz4/lz4">lz4</a>, but we can play some
optimisation tricks to help bridge the gap. Additionally, OCaml can protect the
user against lot of bugs via the type-system <em>and</em> the runtime too (e.g. using
array bounds checking). <a href="https://github.com/mirleft/ocaml-tls"><code>ocaml-tls</code></a> was implemented partly in
response to the famous <a href="https://en.wikipedia.org/wiki/Heartbleed">failure</a> of <code>openssl</code>; a vulnerability
which could not exist in OCaml.</p>
<p><code>[1]</code>: A <em>flow</em>, in MirageOS land, is an abstraction which wants to receive
and/or transmit something under a standard. So it's usual to say a <em>TLS-flow</em>
for example.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#api-design" aria-label="api design permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>API design</h2>
<p>The API should be the most difficult part of designing a library - it reveals
what we can do and how we should do it. In this way, an API should:</p>
<ol>
<li><strong>constrain the user to avoid security issues</strong>; too much freedom can be a bad</li>
</ol>
<p>thing. As an example, consider the <code>Hashtbl.create</code> function, which allows the
user to pass <code>~random:false</code> to select a fixed hash function. The resulting
hashtable suffers deterministic key collisions, which can be exploited by an
attacker.
<br/><br/>
An example of good security-awareness in API design can be seen in
<a href="https://github.com/mirage/digestif">digestif</a>, which provided an <code>unsafe_compare</code> instead of the common
<code>compare</code> function (before <code>eqaf.0.5</code>). In this way, it enforced the user to
create an alias of it if they want to use a hash in a <code>Map</code> &ndash; however, by this
action, they should know that they are not protected against a timing-attack.</p>
<ol start="2">
<li><strong>allow some degrees of freedom to fit within many environments</strong>; a</li>
</ol>
<p>constrained API cannot support a hostile context. For example, when compiling
to an <a href="https://mirage.io/blog/2018-esp32-booting">ESP32</a> target, even small details such as the length of a stream
input buffer must be user-definable. When deploying to a server, memory
consumption should be deterministic.
<br/><br/>
Of course, this is made difficult when too much freedom will enable misuse of
the API &ndash; an example is <a href="https://github.com/ocaml/dune">dune</a> which wants consciously to limit the user
about what they can do with it.</p>
<ol start="3">
<li><strong>imply an optimal design of how to use it</strong>. Possibilities should serve the
user, but these can make the API harder to understand; this is why
documentation is important. Your API should tell your users how it wants to
be treated.</li>
</ol>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#a-dbuenzli-api" aria-label="a dbuenzli api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A dbuenzli API</h3>
<p>From our experiences with protocol/format, one design stands out: the
<em><a href="https://github.com/dbuenzli/">dbuenzli</a> API</em>. If you look into some famous libraries in the OCaml
eco-system, you probably know <a href="https://github.com/dbuenzli/uutf">uutf</a>, <a href="https://github.com/dbuenzli/jsonm">jsonm</a> or <a href="https://github.com/dbuenzli/xmlm">xmlm</a>. All
of these libraries provide the same API for computing a Unicode/JSON/XML flow &ndash;
of course, the details are not the same.</p>
<p>From a MirageOS perspective, even if they use the <code>in_channel</code>/<code>out_channel</code>
abstraction rather than a <a href="https://github.com/mirage/mirage-flow">Mirage flow</a>, these libraries
are system-agnostic since they let the user to choose input and output buffers.
Most importantly, they don't use the standard OCaml <code>Unix</code> module, which cannot
be used in a unikernel.</p>
<p>The APIs are pretty consistent and try to do their <em>best-effort</em><code>[2]</code> of
decoding. The design has a type <em>state</em> which represents the current system
status; the user passes this to <code>decode</code>/<code>encode</code> to carry out the processing.
Of course, these functions have a side-effect on the state internally, but
this is hidden from the user. One advantage of including states in a design is
that the underlying implementation is very amenable to compiler optimisations (e.g.
tail-call optimisation). Internally, of course, we have a <em>porcelain</em><code>[3]</code>
implementation where any details can have an rational explanation.</p>
<p>In the beginning, <code>decompress</code> wanted to follow the same interface without the
mutability (a choice about performances) and it did. Then, the hard test was to
use it in a bigger project; in this case, <a href="https://github.com/mirage/ocaml-git/">ocaml-git</a>. An iterative
process was used to determine what was really needed, what we should not provide
(like special cases) and what we should provide to reach an uniform API that is
not too difficult to understand.</p>
<p>From this experience, we finalised the initial <code>decompress</code> API and it did not
change significantly for 4 versions (2 years).</p>
<p><code>[2]</code>: <em>best-effort</em> means an user control on the error branch where we don't
leak exception (or more generally, any interrupts)</p>
<p><code>[3]</code>: <em>porcelain</em> means implicit invariants held in the mind of the programmer
(or the assertions/comments).</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-new-decompress-api" aria-label="the new decompress api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The new <code>decompress</code> API</h2>
<p>The new <code>decompress</code> keeps the same inflation logic, but drastically changes the
deflator to make the <em>flush</em> operation clearer. For many purposes, people don't
want to hand-craft their compressed flows &ndash; they just want
<code>of_string</code>/<code>to_string</code> functions. However, in some contexts (like a PNG
encoder/decoder), the user should be able to play with <code>decompress</code> in detail
(OpenPGP needs this too in <a href="https://tools.ietf.org/html/rfc4880">RFC 4880</a>).</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#the-zlib-format" aria-label="the zlib format permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Zlib format</h3>
<p>Both <code>decompress</code> and zlib use <em><a href="https://zlib.net/feldspar.html">Huffman coding</a></em>, an algorithm
for building a dictionary of variable-length codewords for a given set of
symbols (in this case, bytes). The most common byte is assigned the shortest bit
sequence; less common bytes are assigned longer codewords. Using this
dictionary, we just translate each byte into its codeword and we should achieve
a good compression ratio. Of course, there are other details, such as the fact
that all Huffman codes are <a href="https://en.wikipedia.org/wiki/Prefix_code">prefix-free</a>. The compression can be
taken further with the <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">LZ77</a> algorithm.</p>
<p>The <em><a href="https://zlib.net/">zlib</a></em> format, a superset of the <a href="https://tools.ietf.org/html/rfc1951">RFC 1951</a> format, is easy
to understand. We will only consider the RFC 1951 format, since zlib adds only
minor details (such as checksums). It consists of several blocks: DEFLATE
blocks, each with a little header, and the contents. There are 3 kinds of
DEFLATE blocks:</p>
<ul>
<li>a FLAT block; no compression, just a <em>blit</em> from inputs to the current block.</li>
<li>a FIXED block; compressed using a pre-computed Huffman code.</li>
<li>a DYNAMIC block; compressed using a user-specified Huffman code.</li>
</ul>
<p>The FIXED block uses a Huffman dictionary that is computed when the OCaml runtime
is initialised. DYNAMIC blocks use dictionaries specified by the user, and so
these must be transmitted alongside the data (<em>after being compressed with
another Huffman code!</em>). The inflator decompresses this DYNAMIC dictionary and uses
it to do the <em>reverse</em> translation from bit sequences to bytes.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#inflator" aria-label="inflator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inflator</h3>
<p>The design of the inflator did not change a lot from the last version of
<code>decompress</code>. Indeed, it's about to take an input, compute it and return an
output like a flow. Of course, the error case can be reached.</p>
<p>So the API is pretty-easy:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> decode <span class="token punctuation">:</span> decoder <span class="token operator">-&gt;</span> <span class="token punctuation">[</span> <span class="token variant variable">`Await</span> <span class="token operator">|</span> <span class="token variant variable">`Flush</span> <span class="token operator">|</span> <span class="token variant variable">`End</span> <span class="token operator">|</span> <span class="token variant variable">`Malformed</span> <span class="token keyword">of</span> string <span class="token punctuation">]</span></code></pre></div>
<p>As you can see, we have 4 cases: one which expects more inputs (<code>Await</code>), the
second which asks to the user to flush internal buffer (<code>Flush</code>), the <code>End</code> case
when we reach the end of the flow and the <code>Malformed</code> case when we encounter an
error.</p>
<p>For each case, the user can do several operations. Of course, about the <code>Await</code>
case, they can refill the contents with an other inputs buffer with:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> src <span class="token punctuation">:</span> decoder <span class="token operator">-&gt;</span> bigstring <span class="token operator">-&gt;</span> off<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> len<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> unit</code></pre></div>
<p>This function provides the decoder a new input with <code>len</code> bytes to read
starting at <code>off</code> in the given <code>bigstring</code>.</p>
<p>In the <code>Flush</code> case, the user wants some information like how many bytes are
available in the current output buffer. Then, we should provide an action to
<em>flush</em> this output buffer. In the end, this output buffer should be given by
the user (how many bytes they want to allocate to store outputs flow).</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> src <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token variant variable">`Channel</span> <span class="token keyword">of</span> in_channel <span class="token operator">|</span> <span class="token variant variable">`Manual</span> <span class="token operator">|</span> <span class="token variant variable">`String</span> <span class="token keyword">of</span> string <span class="token punctuation">]</span>

<span class="token keyword">val</span> dst_rem <span class="token punctuation">:</span> decoder <span class="token operator">-&gt;</span> int
<span class="token keyword">val</span> flush <span class="token punctuation">:</span> decoder <span class="token operator">-&gt;</span> unit
<span class="token keyword">val</span> decoder <span class="token punctuation">:</span> src <span class="token operator">-&gt;</span> o<span class="token punctuation">:</span>bigstring <span class="token operator">-&gt;</span> w<span class="token punctuation">:</span>bigstring <span class="token operator">-&gt;</span> decoder</code></pre></div>
<p>The last function, <code>decoder</code>, is the most interesting. It lets the user, at the
beginning, choose the context in which they want to inflate inputs. So they
choose:</p>
<ul>
<li><code>src</code>, where come from inputs flow</li>
<li><code>o</code>, output buffer</li>
<li><code>w</code>, window buffer</li>
</ul>
<p><code>o</code> will be used to store inflated outputs, <code>dst_rem</code> will give to us how many
bytes inflator stored in <code>o</code> and <code>flush</code> will just set <code>decoder</code> to be able to
recompute the flow.</p>
<p><code>w</code> is needed for <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">lz77</a> compression. However, as we said, we let
the user give us this intermediate buffer. The idea behind that is to let the
user prepare an <em>inflation</em>. For example, in <a href="https://github.com/mirage/ocaml-git/">ocaml-git</a>, instead of
allocating <code>w</code> systematically when we want to decompress a Git object, we
allocate <code>w</code> one time per threads and all are able to use it and <strong>re-use</strong> it.
In this way, we avoid systematic allocations (and allocate only once time) which
can have a serious impact about performances.</p>
<p>The design is pretty close to one idea, a <em>description</em> step by the <code>decoder</code>
function and a real computation loop with the <code>decode</code> function. The idea is to
prepare the inflation with some information (like <code>w</code> and <code>o</code>) before the main
(and the most expensive) computation. Internally we do that too (but it's mostly
about a macro-optimization).</p>
<p>It's the purpose of OCaml in general, be able to have a powerful way to describe
something (with constraints). In our case, we are very limited to what we need
to describe. But, in others libraries like <a href="https://github.com/inhabitedtype/angstrom">angstrom</a>, the description
step is huge (describe the parser according to the BNF) and then, we use it to
the main computation, in the case of angstrom, the parsing (another
example is [cmdliner][cmdliner]).</p>
<p>This is why <code>decoder</code> can be considered as the main function where <code>decode</code> can
be wrapped under a stream.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#deflator" aria-label="deflator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deflator</h3>
<p>The deflator is a new (complex) deal. Indeed, behind it we have two concepts:</p>
<ul>
<li>the encoder (according to RFC 1951)</li>
<li>the compressor</li>
</ul>
<p>For this new version of <code>decompress</code>, we decide to separate these concepts where
one question leads all: how to put my compression algorithm? (instead to use
<a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">LZ77</a>).</p>
<p>In fact, if you are interested in compression, several algorithms exist and, in
some context, it's preferable to use <a href="https://en.wikipedia.org/wiki/Lempel%E2%80%93Ziv%E2%80%93Markov_chain_algorithm">lzwa</a> for example or rabin's
fingerprint (with <a href="https://github.com/mirage/duff">duff</a>), etc.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#functor" aria-label="functor permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Functor</h4>
<p>The first idea was to provide a <em>functor</em> which expects an implementation of the
compression algorithm. However, the indirection of a functor comes with (big)
performance cost. Consider the following functor example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">module</span> <span class="token keyword">type</span> S <span class="token operator">=</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> t
  <span class="token keyword">val</span> add <span class="token punctuation">:</span> t <span class="token operator">-&gt;</span> t <span class="token operator">-&gt;</span> t
  <span class="token keyword">val</span> one <span class="token punctuation">:</span> t
<span class="token keyword">end</span>

<span class="token keyword">module</span> <span class="token module variable">Make</span> <span class="token punctuation">(</span>S <span class="token punctuation">:</span> S<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token keyword">let</span> succ x <span class="token operator">=</span> S<span class="token punctuation">.</span>add x S<span class="token punctuation">.</span>one <span class="token keyword">end</span>

<span class="token keyword">include</span> <span class="token module variable">Make</span> <span class="token punctuation">(</span><span class="token keyword">struct</span>
  <span class="token keyword">type</span> t <span class="token operator">=</span> int
  <span class="token keyword">let</span> add a b <span class="token operator">=</span> a <span class="token operator">+</span> b
  <span class="token keyword">let</span> one <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> f x <span class="token operator">=</span> succ x</code></pre></div>
<p>Currently, with OCaml 4.07.1, the <code>f</code> function will be a <code>caml_apply2</code>. We might
wish for a simple <a href="https://en.wikipedia.org/wiki/Inline_expansion"><em>inlining</em></a> optimisation, allowing <code>f</code> to become an
<code>addq</code> instruction (indeed, <a href="https://caml.inria.fr/pub/docs/manual-ocaml/flambda.html"><code>flambda</code></a> does this), but optimizing
functors is hard. As we learned from <a href="https://github.com/chambart">Pierre Chambart</a>, it is possible
for the OCaml compiler to optimize functors directly, but this requires
respecting several constraints that are difficult to respect in practice.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#split-encoder-and-compressor" aria-label="split encoder and compressor permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Split encoder and compressor</h4>
<p>So, the choice was done to made the encoder which respects RFC 1951 and the
compressor under some constraints. However, this is not what <a href="https://zlib.net/">zlib</a> did
and, by this way, we decided to provide a new design/API which did not follow,
in first instance, zlib (or some others implementations like
<a href="https://github.com/richgel999/miniz">miniz</a>).</p>
<p>To be fair, the choice from zlib and miniz comes from the first
point about API and the context where they are used. The main problem is the
shared queue between the encoder and the compressor. In C code, it can be hard
for the user to deal with it (where they are liable for buffer overflows).</p>
<p>In OCaml and for <code>decompress</code>, the shared queue can be well-abstracted and API
can ensure assumptions (like bounds checking).</p>
<p>Even if this design is much more complex than before, coverage tests are better
where we can separately test the encoder and the compressor. It breaks down the
initial black-box where compression was intrinsec with encoding &ndash; which was
error-prone. Indeed, <code>decompress</code> had a bug about generation of
Huffman codes but we never reached it because the (bad)
compressor was not able to produce something (a specific lengh with a specific
distance) to get it.</p>
<p>NOTE: you have just read the main reason for the new version of <code>decompress</code>!</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#the-compressor" aria-label="the compressor permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The compressor</h4>
<p>The compressor is the most easy part. The goal is to produce from an inputs
flow, an outputs flow which is an other (more compacted) representation. This
representation consists to:</p>
<ul>
<li>A <em>literal</em>, the byte as is</li>
<li>A <em>copy</em> code with an <em>offset</em> and a <em>length</em></li>
</ul>
<p>The last one say to copy <em>length</em> byte(s) from <em>offset</em>. For example, <code>aaaa</code> can
be compressed as <code>[ Literal 'a'; Copy (offset:1, len:3) ]</code>. By this way, instead
to have 4 bytes, we have only 2 elements which will be compressed then by an
<a href="https://zlib.net/feldspar.html">Huffman coding</a>. This is the main idea of the <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">lz77</a>
compression.</p>
<p>However, the compressor should need to deal with the encoder. An easy interface,
<em>&agrave; la <a href="https://github.com/dbuenzli/uutf">uutf</a></em> should be:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> compress <span class="token punctuation">:</span> state <span class="token operator">-&gt;</span> <span class="token punctuation">[</span> <span class="token variant variable">`Literal</span> <span class="token keyword">of</span> char <span class="token operator">|</span> <span class="token variant variable">`Copy</span> <span class="token keyword">of</span> <span class="token punctuation">(</span>int <span class="token operator">*</span> int<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token variant variable">`End</span> <span class="token operator">|</span> <span class="token variant variable">`Await</span> <span class="token punctuation">]</span></code></pre></div>
<p>But as I said, we need to feed a queue instead.</p>
<hr/>
<p>At this point, the purpose of the queue is not clear and not really explained.
The signature above still is a valid and understandable design. Then, we can
imagine passing <code>Literal</code> and <code>Copy</code> directly to the encoder. However, we should
(for performance purpose) use a delaying tactic between the compressor and the
deflator[^4].</p>
<p>Behind this idea, it's to be able to implement an <em>hot-loop</em> on the encoder
which will iter inside the shared queue and <em>transmit</em>/<em>encode</em> contents
directly to the outputs buffer.</p>
<hr/>
<p>So, when we make a new <code>state</code>, we let the user supply their queue:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">val state : src -&gt; w:bistring -&gt; q:queue -&gt; state
val compress : state -&gt; [ `Flush | `Await | `End ]</code></pre></div>
<p>The <code>Flush</code> case appears when the queue is full. Then, we refind the <code>w</code> window
buffer which is needed to produce the <code>Copy</code> code. A <em>copy code</em> is limited
according RFC 1951 where <em>offset</em> can not be upper than the length of the window
(commonly 32ko). <em>length</em> is limited too to <code>258</code> (an arbitrary choice).</p>
<p>Of course, about the <code>Await</code> case, the compressor comes with a <code>src</code> function as
the inflator. Then, we added some accessors, <code>literals</code> and <code>distances</code>. The
compressor does not build the <a href="https://zlib.net/feldspar.html">Huffman coding</a> which needs
frequencies, so we need firstly to keep counters about that inside the state and
a way to get them (and pass them to the encoder).</p>
<p><code>[4]</code>: About that, you should be interesting by the reason of <a href="https://www.reddit.com/r/unix/comments/6gxduc/how_is_gnu_yes_so_fast/">why GNU yes is so
fast</a> where the secret is just about buffering.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#the-encoder" aria-label="the encoder permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The encoder</h4>
<p>Finally, we can talk about the encoder which will take the shared queue filled
by the compressor and provide an RFC 1951 compliant output flow.</p>
<p>However, we need to consider a special <em>detail</em>. When we want to make a
DYNAMIC block from frequencies and then encode the inputs flow, we can reach a
case where the shared queue contains an <em>opcode</em> (a <em>literal</em> or a <em>copy</em>) which
does not appear in our dictionary.</p>
<p>In fact, if we want to encode <code>[ Literal 'a'; Literal 'b' ]</code>, we will not try to
make a dictionary which will contains the 256 possibilities of a byte but we
will only make a dictionary from frequencies which contains only <code>'a'</code> and
<code>'b'</code>. By this way, we can reach a case where the queue contains an <em>opcode</em>
(like <code>Literal 'c'</code>) which can not be encoded by the <em>pre-determined</em>
Huffman coding &ndash; remember, the DYNAMIC block <strong>starts</strong> with
the dictionary.</p>
<p>Another point is about inputs. The encoder expects, of course, contents from
the shared queue but it wants from the user the way to encode contents: which
block we want to emit. So it has two entries:</p>
<ul>
<li>the shared queue</li>
<li>an <em>user-entry</em></li>
</ul>
<p>So for many real tests, we decided to provide this kind of API:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> dst <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token variant variable">`Channel</span> <span class="token keyword">of</span> out_channel <span class="token operator">|</span> <span class="token variant variable">`Buffer</span> <span class="token keyword">of</span> <span class="token module variable">Buffer</span><span class="token punctuation">.</span>t <span class="token operator">|</span> <span class="token variant variable">`Manual</span> <span class="token punctuation">]</span>

<span class="token keyword">val</span> encoder <span class="token punctuation">:</span> dst <span class="token operator">-&gt;</span> q<span class="token punctuation">:</span>queue <span class="token operator">-&gt;</span> encoder
<span class="token keyword">val</span> encode <span class="token punctuation">:</span> encoder <span class="token operator">-&gt;</span> <span class="token punctuation">[</span> <span class="token variant variable">`Block</span> <span class="token keyword">of</span> block <span class="token operator">|</span> <span class="token variant variable">`Flush</span> <span class="token operator">|</span> <span class="token variant variable">`Await</span> <span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span> <span class="token variant variable">`Ok</span> <span class="token operator">|</span> <span class="token variant variable">`Partial</span> <span class="token operator">|</span> <span class="token variant variable">`Block</span> <span class="token punctuation">]</span>
<span class="token keyword">val</span> dst <span class="token punctuation">:</span> encoder <span class="token operator">-&gt;</span> bigstring <span class="token operator">-&gt;</span> off<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> len<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> unit</code></pre></div>
<p>As expected, we take the shared queue to make a new encoder. Then, we let the
user to specify which kind of block they want to encode by the <code>Block</code>
operation.</p>
<p>The <code>Flush</code> operation tries to encode all elements present inside the shared
queue according to the current block and feed the outputs buffer. From it, the
encoder can returns some values:</p>
<ul>
<li><code>Ok</code> and the encoder encoded all <em>opcode</em> from the shared queue</li>
<li><code>Partial</code>, the outputs buffer is not enough to encode all <em>opcode</em>, the user
should flush it and give to us a new empty buffer with <code>dst</code>. Then, they must
continue with the <code>Await</code> operation.</li>
<li><code>Block</code>, the encoder reachs an <em>opcode</em> which can not be encoded with the
current block (the current dictionary). Then, the user must continue with a new
<code>Block</code> operation.</li>
</ul>
<p>The hard part is about the <em>ping-pong</em> game between the user and the encoder
where a <code>Block</code> expects a <code>Block</code> response from the user and a <code>Partial</code> expects
an <code>Await</code> response. But this design reveals something higher about zlib
this time: the <em>flush</em> mode.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#the-flush-mode" aria-label="the flush mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The <em>flush</em> mode</h4>
<p>Firstly, we talk about <em>mode</em> because zlib does not allow the user to
decide what they want to do when we reach a <code>Block</code> or a <code>Ok</code> case. So, it
defines some <a href="https://www.bolet.org/~pornin/deflate-flush.html">under-specified <em>modes</em></a> to apply a policy of what
to do in this case.</p>
<p>In <code>decompress</code>, we followed the same design and see that it may be not a good
idea where the logic is not very clear and the user wants may be an another
behavior. It was like a <em>black-box</em> with a <em>black-magic</em>.</p>
<p>Because we decided to split encoder and compressor, the idea of the <em>flush mode</em>
does not exists anymore where the user explicitly needs to give to the encoder
what they want (make a new block? which block? keep frequencies?). So we broke
the <em>black-box</em>. But, as we said, it was possible mostly because we can abstract
safely the shared queue between the compressor and the encoder.</p>
<p>OCaml is an expressive language and we can really talk about a queue where, in
C, it will be just an other <em>array</em>. As we said, the deal is about performance,
but now, we allow the user the possibility to write their code in this corner-case
which is when they reachs <code>Block</code>. Behaviors depends only on them.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#apis-in-general" aria-label="apis in general permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>APIs in general</h2>
<p>The biggest challenge of building a library is defining the API - you must
strike a compromise between allowing the user the flexibility to express their
use-case and constraining the user to avoid API misuse. If at all possible,
provide an <em>intuitive</em> API: force the user not to need to think about security
issues, memory consumption or performance.</p>
<p>Avoid making your API so expressive that it becomes unusable, but beware that
this sets hard limits on your users: the current <code>decompress</code> API can be used to
build <code>of_string</code> / <code>to_string</code> functions, but the opposite is not true - you
definitely cannot build a stream API from <code>of_string</code> / <code>to_string</code>.</p>
<p>The best advice when designing a library is to keep in mind what you <strong>really</strong>
want and let the other details fall into place gradually. It is very important
to work in an iterative loop of repeatedly trying to use your library; only this
can highlight bad design, corner-cases and details.</p>
<p>Finally, use and re-use it on your tests (important!) and inside higher-level
projects to give you interesting questions about your design. The last version
of <code>decompress</code> was not used in <a href="https://github.com/mirage/ocaml-git/">ocaml-git</a> mostly because the flush
mode was unclear.</p>|js}
  };
 
  { title = {js|Using OCaml to drive a Raspberry Pi robot car|js}
  ; slug = {js|using-ocaml-to-drive-a-raspberry-pi-robot-car|js}
  ; description = Some {js|Back when the Raspberry Pi was first released in 2012 Michael Bacarella wrotea blog poston using OCaml and Async on this little device.Since then installing ...|js}
  ; url = {js|https://blog.janestreet.com/using-ocaml-to-drive-a-raspberry-pi-robot-car/|js}
  ; date = {js|2019-08-19T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/using-ocaml-to-drive-a-raspberry-pi-robot-car/robot-pi.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Back when the Raspberry Pi was first released in 2012 Michael Bacarella wrote
a <a href="https://blog.janestreet.com/bootstrapping-ocamlasync-on-the-raspberry-pi/">blog post</a>
on using OCaml and Async on this little device.
Since then installing OCaml via opam has become a pretty smooth experience
and everything works out of the box when using Raspbian &ndash; the default Raspberry Pi
distribution.</p>|js}
  };
 
  { title = {js|Do applied programming languages research at Jane Street!|js}
  ; slug = {js|do-applied-programming-languages-research-at-jane-street|js}
  ; description = Some {js|As our Tools & Compilers team has grown, the kinds of projects we workon has become more ambitious. Here are some of the major things we’recurrently work...|js}
  ; url = {js|https://blog.janestreet.com/applied-PL-research/|js}
  ; date = {js|2019-08-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/applied-PL-research/compiler3d.jpg|js}
  ; featured = false
  ; body_html = {js|<p>As our Tools &amp; Compilers team has grown, the kinds of projects we work
on has become more ambitious. Here are some of the major things we&rsquo;re
currently working on:</p>|js}
  };
 
  { title = {js|X509 0.7|js}
  ; slug = {js|x509-07|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/X50907|js}
  ; date = {js|2019-08-15T11:21:30-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Cryptographic material</h2>
<p>Once a private and public key pair is generated (doesn't matter whether it is plain RSA, DSA, ECC on any curve), this is fine from a scientific point of view, and can already be used for authenticating and encrypting. From a practical point of view, the public parts need to be exchanged and verified (usually a fingerprint or hash thereof). This leads to the struggle how to encode this cryptographic material, and how to embed an identity (or multiple), capabilities, and other information into it. <a href="https://en.wikipedia.org/wiki/X.509">X.509</a> is a standard to solve this encoding and embedding, and provides more functionality, such as establishing chains of trust and revocation of invalidated or compromised material. X.509 uses certificates, which contain the public key, and additional information (in a extensible key-value store), and are signed by an issuer, either the private key corresponding to the public key - a so-called self-signed certificate - or by a different private key, an authority one step up the chain. A rather long, but very good introduction to certificates by Mike Malone is <a href="https://smallstep.com/blog/everything-pki.html">available here</a>.</p>
<h2>OCaml ecosystem evolving</h2>
<p>More than 5 years ago David Kaloper and I <a href="https://mirage.io/blog/introducing-x509">released the initial ocaml-x509</a> package as part of our <a href="https://nqsb.io">TLS stack</a>, which contained code for decoding and encoding certificates, and path validation of a certificate chain (as described in <a href="https://tools.ietf.org/html/rfc6125">RFC 5280</a>). The validation logic and the decoder/encoder, based on the ASN.1 grammar specified in the RFC, implemented using David's <a href="https://github.com/mirleft/ocaml-asn1-combinators">asn1-combinators</a> library changed much over time.</p>
<p>The OCaml ecosystem evolved over the years, which lead to some changes:</p>
<ul>
<li>Camlp4 deprecation - we used camlp4 for stream parsers of PEM-encoded certificates, and sexplib.syntax to derive s-expression decoders and encoders;
</li>
<li>Avoiding brittle ppx converters - which we used for s-expression decoders and encoders of certificates after camlp4 was deprecated;
</li>
<li>Build and release system iterations - initially oasis and a packed library, then topkg and ocamlbuild, now dune;
</li>
<li>Introduction of the <code>result</code> type in the standard library - we used to use <code>[ `Ok of certificate option | `Fail of failure ]</code>;
</li>
<li>No more leaking exceptions in the public API;
</li>
<li>Usage of pretty-printers, esp with the <a href="https://erratique.ch/software/fmt">fmt</a> library <code>val pp : Format.formatter -&gt; 'a -&gt; unit</code>, instead of <code>val to_string : t -&gt; string</code> functions;
</li>
<li>Release of <a href="https://erratique.ch/software/ptime">ptime</a>, a platform-independent POSIX time support;
</li>
<li>Release of <a href="https://erratique.ch/software/rresult">rresult</a>, which includes combinators for computation <code>result</code>s;
</li>
<li>Release of <a href="https://github.com/hannesm/gmap">gmap</a>, a <code>Map</code> whose value types depend on the key, used for X.509 extensions, GeneralName, DistinguishedName, etc.;
</li>
<li>Release of <a href="https://github.com/hannesm/domain-name">domain-name</a>, a library for domain name operations (as specified in <a href="https://tools.ietf.org/html/rfc1035">RFC 1035</a>) - used for name validation;
</li>
<li>Usage of the <a href="https://github.com/mirage/alcotest">alcotest</a> unit testing framework (instead of oUnit).
</li>
</ul>
<h2>More use cases for X.509</h2>
<p>Initially, we designed and used ocaml-x509 for providing TLS server endpoints and validation in TLS clients - mostly on the public web, where each operating system ships a set of ~100 trust anchors to validate any web server certificate against. But once you have a X.509 implementation, every authentication problem can be solved by applying it.</p>
<h3>Authentication with path building</h3>
<p>It turns out that the trust anchor sets are not equal across operating systems and versions, thus some web servers serve sets, instead of chains, of certificates - as described in <a href="https://tools.ietf.org/html/rfc4158">RFC 4158</a>, where the client implementation needs to build valid paths and accept a connection if any path can be validated. The path building was initially in 0.5.2 slightly wrong, but fixed quickly in <a href="https://github.com/mirleft/ocaml-x509/commit/1a1476308d24bdcc49d45c4cd9ef539ca57461d2">0.5.3</a>.</p>
<h3>Fingerprint authentication</h3>
<p>The chain of trust validation is useful for the open web, where you as software developer don't know to which remote endpoint your software will ever connect to - as long as the remote has a certificate signed (via intermediates) by any of the trust anchors. In the early days, before <a href="https://letsencrypt.org/">let's encrypt</a> was launched and embedded as trust anchors (or cross-signed by already deployed trust anchors), operators needed to pay for a certificate - a business model where some CAs did not bother to check the authenticity of a certificate signing request, and thus random people owning valid certificates for microsoft.com or google.com.</p>
<p>Instead of using the set of trust anchors, the fingerprint of the server certificate, or preferably the fingerprint of the public key of the certificate, can be used for authentication, as optionally done since some years in <a href="https://github.com/hannesm/jackline/commit/a1e6f3159be1e45e6b690845e1b29366c41239a2">jackline</a>, an XMPP client. Support for this certificate / public key pinning was added in x509 0.2.1 / 0.5.0.</p>
<h3>Certificate signing requests</h3>
<p>Until x509 0.4.0 there was no support for generating certificate signing requests (CSR), as defined in PKCS 10, which are self-signed blobs containing a public key, an identity, and possibly extensions. Such as CSR is sent to the certificate authority, and after validation of ownership of the identity and paying a fee, the certificate is issued. Let's encrypt specified the ACME protocol which automates the proof of ownership: they provide a HTTP API for requesting a challenge, providing the response (the proof of ownership) via HTTP or DNS, and then allow the submission of a CSR and downloading the signed certificate. The ocaml-x509 library provides operations for creating such a CSR, and also for signing a CSR to generate a certificate.</p>
<p>Mindy developed the command-line utility <a href="https://github.com/yomimono/ocaml-certify/">certify</a> which uses these operations from the ocaml-x509 library and acts as a swiss-army knife purely in OCaml for these required operations.</p>
<p>Maker developed a <a href="https://github.com/mmaker/ocaml-letsencrypt">let's encrypt library</a> which implements the above mentioned ACME protocol for provisioning CSR to certificates, also using our ocaml-x509 library.</p>
<p>To complete the required certificate authority functionality, in x509 0.6.0 certificate revocation lists, both validation and signing, was implemented.</p>
<h3>Deploying unikernels</h3>
<p>As <a href="https://hannes.robur.coop/Posts/VMM">described in another post</a>, I developed <a href="https://github.com/hannesm/albatross">albatross</a>, an orchestration system for MirageOS unikernels. This uses ASN.1 for internal socket communication and allows remote management via a TLS connection which is mutually authenticated with a X.509 client certificate. To encrypt the X.509 client certificate, first a TLS handshake where the server authenticates itself to the client is established, and over that connection another TLS handshake is established where the client certificate is requested. Note that this mechanism can be dropped with TLS 1.3, since there the certificates are transmitted over an already encrypted channel.</p>
<p>The client certificate already contains the command to execute remotely - as a custom extension, being it &quot;show me the console output&quot;, or &quot;destroy the unikernel with name = YYY&quot;, or &quot;deploy the included unikernel image&quot;. The advantage is that the commands are already authenticated, and there is no need for developing an ad-hoc protocol on top of the TLS session. The resource limits, assigned by the authority, are also part of the certificate chain - i.e. the number of unikernels, access to network bridges, available accumulated memory, accumulated size for block devices, are constrained by the certificate chain presented to the server, and currently running unikernels. The names of the chain are used for access control - if Alice and Bob have intermediate certificates from the same CA, neither Alice may manage Bob's unikernels, nor Bob may manage Alice's unikernels. I'm using albatross since 2.5 years in production on two physical machines with ~20 unikernels total (multiple users, multiple administrative domains), and it works stable and is much nicer to deal with than <code>scp</code> and custom hacked shell scripts.</p>
<h2>Why 0.7?</h2>
<p>There are still some missing pieces in our ocaml-x509 implementation, namely modern ECC certificates (depending on elliptic curve primitives not yet available in OCaml), RSA-PSS signing (should be straightforward), PKCS 12 (there is a <a href="https://github.com/mirleft/ocaml-x509/pull/114">pull request</a>, but this should wait until asn1-combinators supports the <code>ANY defined BY</code> construct to cleanup the code), ...
Once these features are supported, the library should likely be named PKCS since it supports more than X.509, and released as 1.0.</p>
<p>The 0.7 release series moved a lot of modules and function names around, thus it is a major breaking release. By using a map instead of lists for extensions, GeneralName, ..., the API was further revised - invariants that each extension key (an ASN.1 object identifier) may occur at most once are now enforced. By not leaking exceptions through the public interface, the API is easier to use safely - see <a href="https://github.com/mmaker/ocaml-letsencrypt/commit/dc53518f46310f384c9526b1d96a8e8f815a09c7">let's encrypt</a>, <a href="https://git.robur.io/?p=openvpn.git%3Ba=commitdiff%3Bh=929c53116c1438ba1214f53df7506d32da566ccc">openvpn</a>, <a href="https://github.com/yomimono/ocaml-certify/pull/17">certify</a>, <a href="https://github.com/mirleft/ocaml-tls/pull/394">tls</a>, <a href="https://github.com/mirage/capnp-rpc/pull/158">capnp</a>, <a href="https://github.com/hannesm/albatross/commit/50ed6a8d1ead169b3e322aaccb469e870ad72acc">albatross</a>.</p>
<p>I intended in 0.7.0 to have much more precise types, esp. for the SubjectAlternativeName (SAN) extension that uses a GeneralName, but it turns out the GeneralName is as well used for NameConstraints (NC) in a different way -- IP in SAN is an IPv4 or IPv6 address, in CN it is the IP/netmask; DNS is a domain name in SAN, in CN it is a name starting with a leading dot (i.e. &quot;.example.com&quot;), which is not a valid domain name. In 0.7.1, based on a bug report, I had to revert these variants and use less precise types.</p>
<h2>Conclusion</h2>
<p>The work on X.509 was sponsored by <a href="http://ocamllabs.io/">OCaml Labs</a>. You can support our work at robur by a <a href="https://robur.io/Donate">donation</a>, which we will use to work on our OCaml and MirageOS projects. You can also reach out to us to realize commercial products.</p>
<p>I'm interested in feedback, either via <strike><a href="https://twitter.com/h4nnes">twitter</a></strike> <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|A look at OCaml 4.08|js}
  ; slug = {js|a-look-at-ocaml-408|js}
  ; description = Some {js|Now that OCaml 4.08 has been released, let’s have a look at what wasaccomplished, with a particular focus on how our plans for4.08 fared. I’ll mostly focus o...|js}
  ; url = {js|https://blog.janestreet.com/a-look-at-ocaml-4.08/|js}
  ; date = {js|2019-07-12T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/a-look-at-ocaml-4.08/ocaml_release-2019.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Now that OCaml 4.08 has been released, let&rsquo;s have a look at what was
accomplished, with a particular focus on how <a href="https://blog.janestreet.com/plans-for-ocaml-408/">our plans for
4.08</a> fared. I&rsquo;ll mostly focus on work that we
in the Jane Street Tools &amp; Compilers team were involved with, but we are
just some of the contributors to the OCaml compiler, and I&rsquo;ll have a
quick look at the end of the post at some of the other work that went
into 4.08.</p>|js}
  };
 
  { title = {js|Of Pythons and Camels|js}
  ; slug = {js|of-pythons-and-camels|js}
  ; description = Some {js|Welcome to another post in our series of how to use OCaml for machine learning.In previous posts we’ve discussed artistic style-transfer andreinforcement lea...|js}
  ; url = {js|https://blog.janestreet.com/of-pythons-and-camels/|js}
  ; date = {js|2019-07-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/of-pythons-and-camels/camel-identify.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Welcome to another post in our series of how to use OCaml for machine learning.
In previous posts we&rsquo;ve discussed <a href="https://blog.janestreet.com/deep-learning-experiments-in-ocaml/">artistic style-transfer</a> and
<a href="https://blog.janestreet.com/playing-atari-games-with-ocaml-and-deep-rl/">reinforcement learning</a>. If you haven&rsquo;t read these feel
free to do so now, we&rsquo;ll wait right here until you&rsquo;re done. Ready? Ok, let&rsquo;s
continue &hellip;</p>|js}
  };
 
  { title = {js|Summer 2019|js}
  ; slug = {js|summer-2019|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/Summer2019|js}
  ; date = {js|2019-07-08T19:29:05-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>Working at <a href="https://robur.io">robur</a></h2>
<p>As announced <a href="https://hannes.robur.coop/Posts/DNS">previously</a>, I started to work at robur early 2018. We're a collective of five people, distributed around Europe and the US, with the goal to deploy MirageOS unikernels. We do this by developing bespoke MirageOS unikernels which provide useful services, and deploy them for ourselves. We also develop new libraries and enhance existing ones and other components of MirageOS. Example unikernels include <a href="https://robur.io">our website</a> which uses <a href="https://github.com/Engil/Canopy">Canopy</a>, a <a href="https://robur.io/Our%20Work/Projects#CalDAV-Server">CalDAV server that stores entries in a git remote</a>, and <a href="https://github.com/roburio/unikernels">DNS servers</a> (the latter two are further described below).</p>
<p>Robur is part of the non-profit company <a href="https://techcultivation.org">Center for the Cultivation of Technology</a>, who are managing the legal and administrative sides for us. We're ourselves responsible to acquire funding to pay ourselves reasonable salaries. We received funding for CalDAV from <a href="https://prototypefund.de">prototypefund</a> and further funding from <a href="https://tarides.com">Tarides</a>, for TLS 1.3 from <a href="http://ocamllabs.io/">OCaml Labs</a>; security-audited an OCaml codebase, and received <a href="https://robur.io/Donate">donations</a>, also in the form of Bitcoins. We're looking for further funded collaborations and also contracting, mail us at <code>team@robur.io</code>. Please <a href="https://robur.io/Donate">donate</a> (tax-deductible in EU), so we can accomplish our goal of putting robust and sustainable MirageOS unikernels into production, replacing insecure legacy system that emit tons of CO<span style="vertical-align: baseline; position: relative;bottom: -0.4em;">2</span>.</p>
<h2>Deploying MirageOS unikernels</h2>
<p>While several examples are running since years (the <a href="https://mirage.io">MirageOS website</a>, <a href="http://ownme.ipredator.se">Bitcoin Pi&ntilde;ata</a>, <a href="https://tls.nqsb.io">TLS demo server</a>, etc.), and some shell-scripts for cloud providers are floating around, it is not (yet) streamlined.</p>
<p>Service deployment is complex: you have to consider its configuration, exfiltration of logs and metrics, provisioning with valid key material (TLS certificate, hmac shared secret) and authenticators (CA certificate, ssh key fingerprint). Instead of requiring millions lines of code during orchestration (such as Kubernetes), creating the images (docker), or provisioning (ansible), why not minimise the required configuration and dependencies?</p>
<p><a href="https://hannes.robur.coop/Posts/VMM">Earlier in this blog I introduced Albatross</a>, which serves in an enhanced version as our deployment platform on a physical machine (running 15 unikernels at the moment), I won't discuss more detail thereof in this article.</p>
<h2>CalDAV</h2>
<p><a href="https://linse.me/">Steffi</a> and I developed in 2018 a CalDAV server. Since November 2018 we have a test installation for robur, initially running as a Unix process on a virtual machine and persisting data to files on the disk. Mid-June 2019 we migrated it to a MirageOS unikernel, thanks to great efforts in <a href="https://github.com/mirage/ocaml-git">git</a> and <a href="https://github.com/mirage/irmin">irmin</a>, unikernels can push to a remote git repository. We <a href="https://github.com/haesbaert/awa-ssh/pull/8">extended the ssh library</a> with a ssh client and <a href="https://github.com/mirage/ocaml-git/pull/362">use this in git</a>. This also means our CalDAV server is completely immutable (does not carry state across reboots, apart from the data in the remote repository) and does not have persistent state in the form of a block device. Its configuration is mainly done at compile time by the selection of libraries (syslog, monitoring, ...), and boot arguments passed to the unikernel at startup.</p>
<p>We monitored the resource usage when migrating our CalDAV server from Unix process to a MirageOS unikernel. The unikernel size is just below 10MB. The workload is some clients communicating with the server on a regular basis. We use <a href="https://grafana.com/">Grafana</a> with a <a href="https://www.influxdata.com/">influx</a> time series database to monitor virtual machines. Data is collected on the host system (<code>rusage</code> sysctl, <code>kinfo_mem</code> sysctl, <code>ifdata</code> sysctl, <code>vm_get_stats</code> BHyve statistics), and our unikernels these days emit further metrics (mostly counters: gc statistics, malloc statistics, tcp sessions, http requests and status codes).</p>
<p><a href="https://hannes.robur.coop/static/img/crobur-june-2019.png"><img src="https://hannes.robur.coop/static/img/crobur-june-2019.png" width="700"/></a></p>
<p>Please note that memory usage (upper right) and vm exits (lower right) use logarithmic scale. The CPU usage reduced by more than a factor of 4. The memory usage dropped by a factor of 25, and the network traffic increased - previously we stored log messages on the virtual machine itself, now we send them to a dedicated log host.</p>
<p>A MirageOS unikernel, apart from a smaller attack surface, indeed uses fewer resources and actually emits less CO<span style="vertical-align: baseline; position: relative;bottom: -0.4em;">2</span> than the same service on a Unix virtual machine. So we're doing something good for the environment! :)</p>
<p>Our calendar server contains at the moment 63 events, the git repository had around 500 commits in the past month: nearly all of them from the CalDAV server itself when a client modified data via CalDAV, and two manual commits: the initial data imported from the file system, and one commit for fixing a bug of the encoder in our <a href="https://github.com/roburio/icalendar/pull/2">icalendar library</a>.</p>
<p>Our CalDAV implementation is very basic, scheduling, adding attendees (which requires sending out eMail), is not supported. But it works well for us, we have individual calendars and a shared one which everyone can write to. On the client side we use macOS and iOS iCalendar, Android DAVdroid, and Thunderbird. If you like to try our CalDAV server, have a look <a href="https://github.com/roburio/caldav/tree/future/README.md">at our installation instructions</a>.  Please <a href="https://github.com/roburio/caldav/issues">report issues</a> if you find issues or struggle with the installation.</p>
<h2>DNS</h2>
<p>There has been more work on our DNS implementation, now <a href="https://github.com/mirage/ocaml-dns">here</a>. We included a DNS client library, and some <a href="https://github.com/roburio/unikernels/tree/future">example unikernels</a> are available. They as well require our <a href="https://github.com/roburio/git-ssh-dns-mirage3-repo">opam repository overlay</a>. Please report issues if you run into trouble while experimenting with that.</p>
<p>Most prominently is <code>primary-git</code>, a unikernel which acts as a primary authoritative DNS server (UDP and TCP). On startup, it fetches a remote git repository that contains zone files and shared hmac secrets. The zones are served, and secondary servers are notified with the respective serial numbers of the zones, authenticated using TSIG with the shared secrets. The primary server provides dynamic in-protocol updates of DNS resource records (<code>nsupdate</code>), and after successful authentication pushes the change to the remote git. To change the zone, you can just edit the zonefile and push to the git remote - with the proper pre- and post-commit-hooks an authenticated notify is send to the primary server which then pulls the git remote.</p>
<p>Another noteworthy unikernel is <code>letsencrypt</code>, which acts as a secondary server, and whenever a TLSA record with custom type (0xFF) and a DER-encoded certificate signing request is observed, it requests a signature from letsencrypt by solving the DNS challenge. The certificate is pushed to the DNS server as TLSA record as well. The DNS implementation provides <code>ocertify</code> and <code>dns-mirage-certify</code> which use the above mechanism to retrieve valid let's encrypt certificates. The caller (unikernel or Unix command-line utility) either takes a private key directly or generates one from a (provided) seed and generates a certificate signing request. It then looks in DNS for a certificate which is still valid and matches the public key and the hostname. If such a certificate is not present, the certificate signing request is pushed to DNS (via the nsupdate protocol), authenticated using TSIG with a given secret. This way our public facing unikernels (website, this blog, TLS demo server, ..) block until they got a certificate via DNS on startup - we avoid embedding of the certificate into the unikernel image.</p>
<h2>Monitoring</h2>
<p>We like to gather statistics about the resource usage of our unikernels to find potential bottlenecks and observe memory leaks ;) The base for the setup is the <a href="https://github.com/mirage/metrics">metrics</a> library, which is similarly in design to the <a href="https://erratique.ch/software/logs">logs</a> library: libraries use the core to gather metrics. A different aspect is the reporter, which is globally registered and responsible for exfiltrating the data via their favourite protocol. If no reporter is registered, the work overhead is negligible.</p>
<p><a href="https://hannes.robur.coop/static/img/crobur-june-2019-unikernel.png"><img src="https://hannes.robur.coop/static/img/crobur-june-2019-unikernel.png" width="700"/></a></p>
<p>This is a dashboard which combines both statistics gathered from the host system and various metrics from the MirageOS unikernel. The <code>monitoring</code> branch of our opam repository overlay is used together with <a href="https://github.com/hannesm/monitoring-experiments">monitoring-experiments</a>. The logs errors counter (middle right) was the icalendar parser which tried to parse its badly emitted ics (the bug is now fixed, the dashboard is from last month).</p>
<h2>OCaml libraries</h2>
<p>The <a href="https://github.com/hannesm/domain-name">domain-name</a> library was developed to handle RFC 1035 domain names and host names. It initially was part of the DNS code, but is now freestanding to be used in other core libraries (such as ipaddr) with a small dependency footprint.</p>
<p>The <a href="https://github.com/hannesm/gmap">GADT map</a> is a normal OCaml Map structure, but takes key-dependent value types by using a GADT. This library also was part of DNS, but is more broadly useful, we already use it in our icalendar (the data format for calendar entries in CalDAV) library, our <a href="https://git.robur.io/?p=openvpn.git%3Ba=summary">OpenVPN</a> configuration parser uses it as well, and also <a href="https://github.com/mirleft/ocaml-x509/pull/115">x509</a> - which got reworked quite a bit recently (release pending), and there's preliminary PKCS12 support (which deserves its own article). <a href="https://github.com/hannesm/ocaml-tls">TLS 1.3</a> is available on a branch, but is not yet merged. More work is underway, hopefully with sufficient time to write more articles about it.</p>
<h2>Conclusion</h2>
<p>More projects are happening as we speak, it takes time to upstream all the changes, such as monitoring, new core libraries, getting our DNS implementation released, pushing Conex into production, more features such as DNSSec, ...</p>
<p>I'm interested in feedback, either via <strike><a href="https://twitter.com/h4nnes">twitter</a></strike> <a href="https://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>|js}
  };
 
  { title = {js|i-Lab 2019|js}
  ; slug = {js|i-lab-2019|js}
  ; description = Some {js|We are thrilled to announce that Tarides is laureate of the 21st
edition of the i-Lab innovation contest
for its innovative technological…|js}
  ; url = {js|https://tarides.com/blog/2019-07-05-i-lab-2019|js}
  ; date = {js|2019-07-05T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/989f814ad321d1b5085a22476f444920/d87c0/iLab_2019.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are thrilled to announce that Tarides is laureate of the 21st
edition of the <a href="http://www.enseignementsup-recherche.gouv.fr/cid5745/le-concours-i-lab-2019-un-tremplin-pour-les-entrepreneurs-de-la-deep-tech.html">i-Lab innovation contest</a>
for its innovative technological solution: <strong>OSMOSE</strong>.</p>
<p>Organized by the French Ministry of Higher Education, Research and
Innovation in partnership with Bpifrance, the objective of this
competition is to identify and support innovative technology-based
projects. This year, over 700 applications have been registered and 75
projects rewarded. The jury was composed of fifty experts (business
leaders, researchers, former laureate, start-uppers, engineers,
consultants, investors) and was chaired by Ludovic Le Moan, CEO of
Sigfox.</p>
<p>The OSMOSE solution is a software infrastructure platform to deploy
secure and distributed IoT applications, using low-resource
constraints and providing low-latency performance. This platform is
built upon innovative and open-source projects (in particular MirageOS
and Irmin) which were started at the University of Cambridge, over 10
years ago, where the founders of Tarides met. Tarides uses unikernel
technologies and applies the research done in programming languages to
real-world systems to build safe and performant applications
specialized to their runtime environment.</p>
<p>If you are interested by the project, contact us:
<a href="mailto:contact@tarides.com">contact@tarides.com</a></p>
<p>Or <a href="http://gazagnaire.org/pub/2019.02-osmose.pdf">check our position paper</a>
to learn more about it.</p>|js}
  };
 
  { title = {js|Release of OCamlFormat 0.10|js}
  ; slug = {js|release-of-ocamlformat-010|js}
  ; description = Some {js|We are pleased to announce the release of OCamlFormat 0.10 (available on opam). There have been numerous changes since the last release, so…|js}
  ; url = {js|https://tarides.com/blog/2019-06-27-release-of-ocamlformat-0-10|js}
  ; date = {js|2019-06-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/dd98e4198ca9305bbbd638c382587e5b/eee8e/keyboard.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are pleased to announce the release of OCamlFormat 0.10 (available on opam).</p>
<p>There have been numerous changes since the last release, so here is a comprehensive list of the new features and breaking changes to help the transition from OCamlFormat 0.9.</p>
<p><code>ocamlformat-0.10</code> now works on the 4.08 AST, although the formatting should not differ greatly from the one of <code>ocamlformat-0.9</code> in this regard.
Please note that it is necessary to build <code>ocamlformat</code> with 4.08 to be able to parse new features like <code>let*</code>.</p>
<p>Upgrading from <code>ocamlformat-0.9</code> requires to install the following dependencies:</p>
<ul>
<li>ocaml-migrate-parsetree &gt;= 1.3.1 (upgrade)</li>
<li>uuseg &gt;= 10.0.0 (new)</li>
<li>uutf &gt;= 1.0.1 (upgrade)</li>
</ul>
<p>This release focuses on preserving the style of the original source and on handling more <code>ocp-indent</code> options.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#style-preservation" aria-label="style preservation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Style preservation</h2>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#expression-grouping" aria-label="expression grouping permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Expression grouping</h3>
<p>The new option <code>exp-grouping</code> has been added to preserve the keywords <code>begin</code>/<code>end</code> that are used to delimit expressions instead of parentheses. <code>exp-grouping=parens</code> always uses parentheses to delimit expressions. <code>exp-grouping=preserve</code> preserves the original grouping syntax (parentheses or <code>begin</code>/<code>end</code>).</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#horizontal-alignment" aria-label="horizontal alignment permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Horizontal alignment</h3>
<p>Horizontal alignment is something that users often use to make pattern-matching or type declarations easier to read, and it is a feature that has been requested many times. Three new options have been added to horizontally align the lines.</p>
<p><code>align-cases</code> horizontally aligns the match/try cases:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> fooooooooooo <span class="token operator">=</span>
  <span class="token keyword">match</span> foooooooooooooooooooooooo <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">Bfooooooooooooooooo</span> <span class="token operator">-&gt;</span> foooooooooooo
  <span class="token operator">|</span> C <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span>      <span class="token operator">-&gt;</span> fooooooooooooooooooo
  <span class="token operator">|</span> <span class="token punctuation">_</span>                   <span class="token operator">-&gt;</span> fooooooooooooooooooo</code></pre></div>
<p><code>align-constructors-decl</code> horizontally aligns type declarations:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token punctuation">(</span> <span class="token punctuation">:</span><span class="token punctuation">:</span> <span class="token punctuation">)</span> <span class="token keyword">of</span> a <span class="token operator">*</span> b
  <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token keyword">of</span> looooooooooooooooooooooooooooooooooooooong_break</code></pre></div>
<p><code>align-variants-decl</code> horizontally aligns variants type declarations:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> x <span class="token operator">=</span>
  <span class="token punctuation">[</span> <span class="token variant variable">`Foooooooo</span>      <span class="token keyword">of</span> int
  <span class="token operator">|</span> <span class="token variant variable">`Fooooooooooooo</span> <span class="token keyword">of</span> int <span class="token punctuation">]</span></code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#preserve-blank-lines-in-sequences" aria-label="preserve blank lines in sequences permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preserve blank lines in sequences</h3>
<p>The new option <code>sequence-blank-line</code> decides whether a blank line is preserved between expressions of a sequence. <code>sequence-blank-line=compact</code> will not keep any blank line between expressions of a sequence, this is still the default behavior. <code>sequence-blank-line=preserve</code> will keep a blank line between two expressions of a sequence if the input contains at least one.</p>
<p>This option can help preserving the readability of the code in this situation:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> foo x y <span class="token operator">=</span>
  do_some_setup y <span class="token punctuation">;</span>

  important_function x</code></pre></div>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#supporting-more-ocp-indent-options" aria-label="supporting more ocp indent options permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Supporting more <code>ocp-indent</code> options</h2>
<p>The long term goal of <code>ocamlformat</code> is to handle every <code>ocp-indent</code> option, this release got closer to this goal as the following <code>ocp-indent</code> options are now supported by <code>ocamlformat</code>:</p>
<ul>
<li>max_indent</li>
<li>with</li>
<li>strict_with</li>
<li>ppx_stritem_ext</li>
<li>base</li>
<li>in</li>
<li>type</li>
</ul>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#offset-added-to-a-new-line" aria-label="offset added to a new line permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Offset added to a new line</h3>
<p>The new option <code>max-indent</code> sets the maximum offset (number of columns) added to a new line in addition to the offset of the previous line. If this offset is set to 2 columns, then each new line can only be indented by 2 columns more in addition to the previous line, for example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  fooooo
  <span class="token operator">|&gt;</span> <span class="token module variable">List</span><span class="token punctuation">.</span>iter <span class="token punctuation">(</span><span class="token keyword">fun</span> x <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> x <span class="token operator">$</span> y <span class="token keyword">in</span>
    fooooooooooo x<span class="token punctuation">)</span></code></pre></div>
<p>This option is equivalent to the <code>max_indent</code> option of <code>ocp-indent</code>, and it will be set if <code>max_indent</code> is set in an <code>.ocp-indent</code> configuration file.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#indentation-of-pattern-matching-cases" aria-label="indentation of pattern matching cases permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Indentation of pattern matching cases</h3>
<p>The new options <code>funtion-indent</code> and <code>match-indent</code> respectively decide the indentation of function cases and the indentation of match/try cases.
These options are equivalent to the <code>with</code> option of <code>ocp-indent</code>, and they will be set if <code>with</code> is set in an <code>ocp-indent</code> configuration file.
If the indentation is set to 4 columns, cases are formatted like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> foooooooo <span class="token operator">=</span> <span class="token keyword">function</span>
    <span class="token operator">|</span> fooooooooooooooooooooooo <span class="token operator">-&gt;</span> foooooooooooooooooooooooooo

<span class="token keyword">let</span> foooooooo <span class="token operator">=</span>
  <span class="token keyword">match</span> fooooooooooooooooooooooo <span class="token keyword">with</span>
      <span class="token operator">|</span> fooooooooooooooooooooooo <span class="token operator">-&gt;</span> foooooooooooooooooooooooooo</code></pre></div>
<p>The new options <code>function-indent-nested</code> and <code>match-indent-nested</code> respectively decide whether the <code>function-indent</code> and the <code>match-indent</code> parameters should be applied even when in a sub-block. If these options are set to <code>never</code>, it only applies <code>function-indent</code> or <code>match-indent</code> if the function or match block starts a line. If these options are set to <code>always</code>, then the indent parameters are always applied. The <code>auto</code> value applies the indentation parameter when seen fit.</p>
<p>These options are equivalent to the <code>strict_with</code> option of <code>ocp-indent</code>, and they will be set if <code>strict_with</code> is set in an <code>ocp-indent</code> configuration file.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#indentation-inside-extension-nodes" aria-label="indentation inside extension nodes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Indentation inside extension nodes</h3>
<p>The new option <code>extension-indent</code> sets the indentation of items (that are not at structure level) inside extension nodes.
The new option <code>stritem-extension-indent</code> sets the indentation of structure items inside extension nodes. This option is equivalent to the <code>ppx_stritem_ext</code> option of <code>ocp-indent</code>, and it will be set if <code>ppx_stritem_ext</code> is set in an <code>.ocp-indent</code> configuration file.</p>
<p>For example if <code>extension-indent</code> is set to 5 and <code>stritem-extension-indent</code> is set to 3:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> foo <span class="token operator">=</span>
  <span class="token punctuation">[</span><span class="token operator">%</span>foooooooooo
       fooooooooooooooooooooooooooo foooooooooooooooooooooooooooooooooo
         foooooooooooooooooooooooooooo<span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token operator">@@</span>foooooooooo
       fooooooooooooooooooooooooooo foooooooooooooooooooooooooooooooooo
         foooooooooooooooooooooooooooo<span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token operator">@@@</span>foooooooooo
   fooooooooooooooooooooooooooo foooooooooooooooooooooooooooooooooo
     foooooooooooooooooooooooooooo<span class="token punctuation">]</span></code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#let-binding-indentation" aria-label="let binding indentation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Let-binding indentation</h3>
<p>The new option <code>let-binding-indent</code> sets the indentation of let binding expressions if they do not fit on a single line. This option is equivalent to the <code>base</code> option of <code>ocp-indent</code>.
The new option <code>indent-after-in</code> sets the indentation after <code>let ... in</code>, unless followed by another <code>let</code>. This option is equivalent to the <code>in</code> option of <code>ocp-indent</code>.
The new option <code>type-decl-indent</code> sets the indentation of type declarations if they do not fit on a single line. This option is equivalent to the <code>type</code> option of <code>ocp-indent</code>.</p>
<p>These options will be set if their <code>ocp-indent</code> counterparts are set in an <code>.ocp-indent</code> configuration file.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#miscellaneous-features" aria-label="miscellaneous features permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Miscellaneous features</h2>
<p>This release also brings some new options, new values for existing features, or corrects erroneous behaviours.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#indicate-multiline-delimiters" aria-label="indicate multiline delimiters permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Indicate multiline delimiters</h3>
<p>The former <code>indicate-multiline-delimiters</code> boolean option is now a 3-valued option:</p>
<ul>
<li><code>indicate-multiline-delimiters=space</code> (was equivalent to <code>true</code>) prints a space inside the delimiter to indicate the matching one is on a different line.</li>
<li><code>indicate-multiline-delimiters=no</code> (was equivalent to <code>false</code>) doesn't do anything special to indicate the closing delimiter.</li>
<li><code>indicate-multiline-delimiters=closing-on-separate-line</code> is the new feature of this option, it makes sure that the closing delimiter is on its own line.</li>
</ul>
<p>On this example we can see the closing parenthesis delimiting the nested pattern-matchings are on their own line and are aligned with the matching opening parenthesis:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
   <span class="token keyword">match</span> v <span class="token keyword">with</span>
   <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span>
   <span class="token operator">|</span> <span class="token module variable">Some</span> x <span class="token operator">-&gt;</span>
       <span class="token punctuation">(</span> <span class="token keyword">match</span> x <span class="token keyword">with</span>
       <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span>
       <span class="token operator">|</span> <span class="token module variable">Some</span> x <span class="token operator">-&gt;</span>
           <span class="token punctuation">(</span> <span class="token keyword">match</span> x <span class="token keyword">with</span>
           <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span>
           <span class="token operator">|</span> <span class="token module variable">Some</span> x <span class="token operator">-&gt;</span> x
           <span class="token punctuation">)</span>
       <span class="token punctuation">)</span></code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#formatting-of-literal-strings" aria-label="formatting of literal strings permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Formatting of literal strings</h3>
<p><code>break-string-literals=newlines</code> now takes into account pretty-printing commands like <code>@,</code>, <code>@;</code> and <code>@\\n</code> to produce more readable strings. A new value for this option has been added, <code>break-string-literals=newlines-and-wrap</code>, to break lines at newlines delimiters (including pretty-printing commands) and also wrap the string literals at the margin.</p>
<p>Here is how <code>break-string-literals=newlines-and-wrap</code> formats a string:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> fooooooooooo <span class="token operator">=</span>
  &quot;<span class="token module variable">Lorem</span> ipsum dolor sit amet<span class="token punctuation">,</span> consectetur adipiscing elit<span class="token punctuation">,</span> sed <span class="token keyword">do</span> eiusmod \\
   tempor incididunt ut labore et dolore magna aliqua<span class="token punctuation">.</span><span class="token operator">@</span><span class="token punctuation">;</span>\\
   <span class="token module variable">Ut</span> enim ad minim veniam<span class="token punctuation">,</span> quis nostrud exercitation ullamco laboris nisi \\
   ut aliquip ex ea commodo consequat<span class="token punctuation">.</span><span class="token operator">@</span><span class="token punctuation">;</span>\\
   <span class="token module variable">Duis</span> aute irure dolor <span class="token keyword">in</span> reprehenderit <span class="token keyword">in</span> voluptate velit esse cillum \\
   dolore eu fugiat nulla pariatur<span class="token punctuation">.</span><span class="token operator">@</span><span class="token punctuation">;</span>\\
   <span class="token module variable">Excepteur</span> sint occaecat cupidatat non proident<span class="token punctuation">,</span> sunt <span class="token keyword">in</span> culpa qui \\
   officia deserunt mollit anim id est laborum<span class="token punctuation">.</span>&quot;</code></pre></div>
<p><strong>Warning:</strong> the <code>break-string-literals</code> will likely be removed in the next release and the default behavior would be <code>newlines-and-wrap</code>.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#break-before-the-in-keyword" aria-label="break before the in keyword permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Break before the <code>in</code> keyword</h3>
<p>The new option <code>break-before-in</code> has been added to decide whether the line should break before the <code>in</code> keyword of a <code>let</code> binding. <code>break-before-in=fit-or-vertical</code> will always break the line before the <code>in</code> keyword if the whole <code>let</code> binding does not fit on a single line, it is still the default behavior. <code>break-before-in=auto</code> will only break the line if the <code>in</code> keyword does not fit on the previous line.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">_</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> short <span class="token operator">=</span> this is short <span class="token keyword">in</span>
  <span class="token keyword">let</span> fooo <span class="token operator">=</span>
    <span class="token punctuation">(</span>this is very long<span class="token punctuation">)</span> but <span class="token punctuation">(</span>the <span class="token keyword">in</span> keyword can fit<span class="token punctuation">)</span> on the same line <span class="token keyword">in</span>
  foooooo</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#indentation-of-nested-pattern-matching" aria-label="indentation of nested pattern matching permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Indentation of nested pattern-matching</h3>
<p>The new option <code>nested-match</code> defines the style of pattern-matchings nested in the last case of another pattern-matching. <code>nested-match=wrap</code> wraps the nested pattern-matching with parentheses and adds indentation, this is still the default behavior. <code>nested-match=align</code> vertically aligns the nested pattern-matching under the encompassing pattern-matching, for example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">match</span> v <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span>
  <span class="token operator">|</span> <span class="token module variable">Some</span> x <span class="token operator">-&gt;</span>
  <span class="token keyword">match</span> x <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">None</span> <span class="token operator">-&gt;</span> <span class="token module variable">None</span>
  <span class="token operator">|</span> <span class="token module variable">Some</span> x <span class="token operator">-&gt;</span> x</code></pre></div>
<p>The new option <code>cases-matching-exp-indent</code> decides the indentation of cases right-hand sides which are <code>match</code> or <code>try</code> expressions. <code>cases-matching-exp-indent=compact</code> forces an indentation of 2, unless <code>nested-match</code> is set to <code>align</code> and this is the last case of the pattern matching. <code>compact</code> is the default behavior. <code>cases-matching-exp-indent=normal</code> indents as it would any other expression.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#whitelist-of-files-to-format" aria-label="whitelist of files to format permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Whitelist of files to format</h3>
<p>A new kind of configuration files is now handled by <code>ocamlformat</code>: <code>.ocamlformat-enable</code> files.
If the <code>disable</code> option is set, an <code>.ocamlformat-enable</code> file can list the files that <code>ocamlformat</code> should format even when the <code>disable</code> option is set. Each line in an <code>.ocamlformat-enable</code> file specifies a filename relative to the directory containing the <code>.ocamlformat-enable</code> file.</p>
<p>The <code>.ocamlformat-enable</code> files are using the same syntax as the <code>.ocamlformat-ignore</code> files: lines starting with <code>#</code> are ignored and can be used as comments.</p>
<p>These new configuration files do not contradict the existing <code>.ocamlformat-ignore</code> files, as <code>.ocamlformat-enable</code> are only considered when <code>disable</code> is set, and <code>.ocamlformat-ignore</code> are only considered when <code>disable</code> is not set.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#disable-outside-detected-project" aria-label="disable outside detected project permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Disable outside detected project</h3>
<p>The <code>disable-outside-detected-project</code> option is now set by default.</p>
<p>When the option <code>--enable-outside-detected-project</code> is not set, <code>.ocamlformat</code> files outside of the project (including the one in <code>XDG_CONFIG_HOME</code>) are not read. The project root of an input file is taken to be the nearest ancestor directory that contains a .git or .hg or dune-project file. If no config file is found, formatting is disabled.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#space-around-collection-expressions" aria-label="space around collection expressions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Space around collection-expressions</h3>
<p>The former option <code>space-around-collection-expressions</code> that was deciding whether a space should be added inside the delimiters of collection expressions (lists, arrays, records, variants) has been replaced by 4 new options: <code>space-around-arrays</code>, <code>space-around-lists</code>, <code>space-around-records</code> and <code>space-around-variants</code>, to allow a finer grain customization.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#fit-or-vertical-mode-for-pattern-matching" aria-label="fit or vertical mode for pattern matching permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fit-or-vertical mode for pattern matching</h3>
<p>The <code>break-cases</code> option that decides the shape of pattern matching has a new value <code>fit-or-vertical</code>. <code>break-cases=fit-or-vertical</code> tries to fit all or-patterns on the same line, otherwise breaks each or-pattern (they are wrapped in other modes).
For example if this set of or-patterns does not fit on a single line, we get the following output:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> ffffff <span class="token operator">=</span>
  <span class="token keyword">match</span> foooooooooooo <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">Aaaaaaaaaaaaaaaaa</span>
  <span class="token operator">|</span> <span class="token module variable">Bbbbbbbbbbbbbbbbb</span>
  <span class="token operator">|</span> <span class="token module variable">Ccccccccccccccccc</span>
  <span class="token operator">|</span> <span class="token module variable">Ddddddddddddddddd</span>
  <span class="token operator">|</span> <span class="token module variable">Eeeeeeeeeeeeeeeee</span> <span class="token operator">-&gt;</span> foooooooooooooooooooo
  <span class="token operator">|</span> <span class="token module variable">Fffffffffffffffff</span> <span class="token operator">-&gt;</span> fooooooooooooooooo</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#kr-style-for-if-then-else" aria-label="kr style for if then else permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>K&amp;R style for if-then-else</h3>
<p>The <code>if-then-else</code> option now has a new value <code>k-r</code> that uses parentheses (when necessary) to reproduce a formatting close to the K&amp;R style. For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">_</span> <span class="token operator">=</span>
  <span class="token keyword">if</span> b <span class="token keyword">then</span> <span class="token punctuation">(</span>
    something loooooooooooooooooooooooooooooooong enough to_trigger a break <span class="token punctuation">;</span>
    this is more
  <span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">if</span> b1 <span class="token keyword">then</span> <span class="token punctuation">(</span>
    something loooooooooooooooooooooooooooooooong enough to_trigger a break <span class="token punctuation">;</span>
    this is more
  <span class="token punctuation">)</span> <span class="token keyword">else</span>
    e</code></pre></div>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#breaking-changes" aria-label="breaking changes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Breaking changes</h2>
<ul>
<li>the <code>indicate-multiline-delimiters</code> option is no longer a boolean option but now has 3 values: <code>space</code>, <code>no</code> and <code>closing-on-separate-line</code> that are detailed in this patch note.</li>
<li>the <code>disable-outside-detected-project</code> option is now set by default.</li>
<li>the <code>default</code> preset profile has been removed (it was equivalent to the <code>ocamlformat</code> profile with <code>break-cases=fit</code>).</li>
<li>the <code>space-around-collection-expressions</code> option has been replaced by 4 new options: <code>space-around-arrays</code>, <code>space-around-lists</code>, <code>space-around-records</code> and <code>space-around-variants</code>.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#whats-next" aria-label="whats next permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What's next?</h2>
<p>We strongly encourage our users to try out the <code>conventional</code> preset profile, as we plan to make it the default profile in a future release. This profile's purpose is to reproduce the most commonly encountered styles, and it may be more pleasing to the eye than the current default options.</p>
<p>As stated previously, the <code>break-string-literals</code> will likely be removed in the next release and the default behavior would be <code>newlines-and-wrap</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#credits" aria-label="credits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h2>
<p>This release also contains many other changes and bug fixes that we cannot detail here.</p>
<p>We would like to thank our maintainers and contributors for this release: Jules Aguillon, Josh Berdine, Hugo Heuzard, Guillaume Petiot and Thomas Refis, and especially our industrial users Jane Street, Ahrefs and Nomadic Labs that made this work possible by funding this project and providing helpful contributions and feedback.</p>
<p>We would be happy to provide support for more customers, please contact us at <a href="mailto:contact@tarides.com">contact@tarides.com</a></p>
<p>If you wish to get involved with OCamlFormat development or file an issue, please read the <a href="https://github.com/ocaml-ppx/ocamlformat/blob/master/CONTRIBUTING.md">contributing guide</a>, any contribution is welcomed.</p>|js}
  };
 
  { title = {js|On the road to Irmin v2|js}
  ; slug = {js|on-the-road-to-irmin-v2|js}
  ; description = Some {js|Over the past few months, we have been heavily engaged in release
engineering the Irmin 2.0 release,
which covers multiple years of work on…|js}
  ; url = {js|https://tarides.com/blog/2019-05-13-on-the-road-to-irmin-v2|js}
  ; date = {js|2019-05-13T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/76876b69b77bdec1f25009b2ef2a6d33/ed333/tree_canopy2.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Over the past few months, we have been heavily engaged in release
engineering the <a href="https://github.com/mirage/irmin/issues/658">Irmin 2.0 release</a>,
which covers multiple years of work on all of its constituent
elements. We first began Irmin in late 2013 to act as a
<a href="https://mirage.io/blog/introducing-irmin">Git-like distributed and branchable storage substrate</a>
that would let us escape the <a href="https://www.cl.cam.ac.uk/~pes20/SOSP15-paper102-submitted.pdf">perils of POSIX filesystems</a>.</p>
<p>The Irmin libraries provide snapshotting, branching and merging
operations over storage and can communicate via Git both on-disk and
remotely. Irmin today therefore consists of many discrete OCaml
libraries that compose together to form a set of <a href="https://blog.acolyer.org/2015/01/14/mergeable-persistent-data-structures/">mergeable data structures</a>
that can be used in MirageOS unikernels and normal OCaml daemons such
as <a href="http://tezos.com">Tezos</a>.</p>
<p>In this blog post, we wanted to explain some of the release
engineering ongoing, and to highlight some areas where we could use
help from the community to test out pieces (and hopefully find your
own uses in your own infrastructure for it).  The overall effort is
tracked in <a href="https://github.com/mirage/irmin/issues/658">mirage/irmin#658</a>, so
feel free to comment on there as well.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#ocaml-git" aria-label="ocaml git permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ocaml-git</h3>
<p>Irmin is parameterised over the exact communication mechanisms it uses
between nodes, both as an on-disk format and also the remoting
protocol.  The most important concrete implementation is Git, which
has turned into the world&rsquo;s most popular version control system.  In
order to seamlessly integrate with Irmin, we embarked on an effort to
build a complete re-implementation of
<a href="https://github.com/mirage/ocaml-git">Git from scratch in pure OCaml</a>.</p>
<p>You can read <a href="https://tarides.com/blog/2018-10-19-ocaml-git-2-0.html">details of the git 2.0 release</a>
on this blog, but from a release engineering perspective we have steadily
been fixing corner cases in this implementation.  The development
ocaml-git trees feature <a href="https://github.com/mirage/ocaml-git/pull/348">fixes to https+git</a>,
for <a href="https://github.com/mirage/ocaml-git/pull/351">listing remotes</a>, supporting
<a href="https://github.com/mirage/ocaml-git/pull/341">authenticated URIs</a> and
more.</p>
<p>These fixes are possible because users tried end-to-end usecases that
found these corner cases, so we&rsquo;d really like to see more.  For
example, our friends at <a href="https://robur.io">Robur</a> have submitted fixes
from their integration of it into their upcoming <a href="https://github.com/roburio/caldav">CalDAV engine</a>.
The Mirage <a href="https://github.com/Engil/Canopy">canopy</a> blog engine can now also
push/pull reliably from pure MirageOS unikernels between nodes, which
is a huge step.</p>
<p>If you get a chance to try ocaml-git in your infrastructure, please
let us know how you get along as we prepare a release of the git
libraries with all these fixes (which will be used in Irmin 2.0).</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#wodan" aria-label="wodan permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Wodan</h3>
<p>Irmin&rsquo;s storage layer is also well abstracted, so backends other than
a Unix filesystem or Git are supported.  Irmin can run in highly
diverse and OS-free environments, and so we began engineering the
<a href="https://github.com/mirage/wodan">Wodan filesystem</a> as a
domain-specific filesystem designed for MirageOS, Irmin and modern
flash drives.  See <a href="https://g2p.github.io/research/wodan.pdf">the OCaml Workshop 2017 abstract on
it</a> for more design
rationale)</p>
<p>As part of the Irmin 2.0 release, Wodan is also being prepared for a
release, and you can find <a href="https://github.com/mirage/wodan/tree/master/src/wodan-irmin">Irmin 2.0
support</a>
in the source.  If you&rsquo;d like a standalone block-device based
persistence environment for Irmin, please try this out.  This is the
preferred backend for using Irmin storage in a unikernel.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#tezos-and-irmin-pack" aria-label="tezos and irmin pack permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tezos and irmin-pack</h3>
<p>Another big user of Irmin is the <a href="https://tezos.com">Tezos blockchain</a>,
and we have been optimising the persistent space usage of Irmin as their
network grows.  Because Tezos doesn&rsquo;t require full Git format support,
we created a hybrid backend that grabs the best bits of Git (e.g. the
packfile mechanism) and engineered a domain-specific backend tailored
for Tezos usage. Crucially, because of the way Irmin is split into
clean libraries and OCaml modules, we only had to modify a small part
of the codebase and could also re-use elements of the Git 2.0
engineering effort we described above.</p>
<p>The <a href="https://github.com/mirage/irmin/pull/615">irmin-pack backend</a> is
currently being reviewed and integrated ahead of Irmin 2.0 to provide
a significant improvement in disk usage -- more information to come soon.
There is a corresponding <a href="https://gitlab.com/samoht/tezos/tree/snapshot-irmin-pack">Tezos branch</a>
using the Irmin 2.0 code that will be integrated downstream in Tezos
once we complete the Irmin 2.0 tests.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#irmin-graphql-and-browser-irmin" aria-label="irmin graphql and browser irmin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Irmin-GraphQL and &ldquo;browser Irmin&rdquo;</h3>
<p>Another new area of huge interest to us is
<a href="https://graphql.org">GraphQL</a> in order to provide frontends a rich
query language for Irmin hosted applications.  Irmin 2.0 includes a
builtin GraphQL server so you can <a href="https://twitter.com/cuvius/status/1017136581755457539">manipulate your Git repo via
GraphQL</a>.</p>
<p>If you are interested in (for example) compiling elements of Irmin to
JavaScript or wasm, for usage in frontends, then the Irmin 2.0 release
makes it significantly easier to support this architecture.  We&rsquo;ve
already seen some exploratory efforts <a href="https://github.com/mirage/irmin/issues/681">report issues</a>
when doing this, and we&rsquo;ve had it working ourselves in <a href="http://roscidus.com/blog/blog/2015/04/28/cuekeeper-gitting-things-done-in-the-browser/">Irmin 1.0 Cuekeeper</a>
so we are excited by the potential power of applications built using
this model.  If you have ideas/questions, please get in touch on the
<a href="https://github.com/mirage/irmin/issues">issue tracker</a> with your
usecase.</p>
<p>This post is just the precursor to the Irmin 2.0 release, so expect to
hear more about it in the coming weeks and months.  This is primarily
a call for help from early adopters interested in helping the project
out.  All of our code is liberally licensed open source, and so this
is a good time to tie together end-to-end usecases and help ensure we
don&rsquo;t make any decisions in Irmin 2.0 that go counter to some product
you&rsquo;d like to build. That&rsquo;s only possible with your feedback, so
either get in touch via the <a href="https://github.com/mirage/irmin/issues">issue tracker</a>, on
<a href="https://discuss.ocaml.org">discuss.ocaml.org</a> via the <code>mirageos</code> tag,
or just <a href="mailto:mirageos-devel@lists.xenproject.org">email us</a>.</p>
<p>A huge thank you to all our commercial customers, end users and open
source developers who have contributed their time, expertise and
financial support to help us achieve our goal of delivering a modern
storage stack in the spirit of Git. We look forward to getting Irmin
2.0 into your hands very soon!</p>|js}
  };
 
  { title = {js|Thoughts from AAAI 2019|js}
  ; slug = {js|thoughts-from-aaai-2019|js}
  ; description = Some {js|At Jane Street, for the last several years, we have been increasingly interestedin machine learning and its many use cases. This is why it was exciting whene...|js}
  ; url = {js|https://blog.janestreet.com/thoughts-from-aaai-19/|js}
  ; date = {js|2019-05-13T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/thoughts-from-aaai-19/AAAI.jpg|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, for the last several years, we have been increasingly interested
in machine learning and its many use cases. This is why it was exciting when
earlier this year myself and a few of my colleagues had the opportunity to
attend the AAAI 2019 conference. We&rsquo;d like to take this space to share with you
some of the interesting projects and themes we saw at the conference.</p>|js}
  };
 
  { title = {js|An introduction to OCaml PPX ecosystem|js}
  ; slug = {js|an-introduction-to-ocaml-ppx-ecosystem|js}
  ; description = Some {js|These last few months, I spent some time writing new OCaml PPX rewriters or contributing to existing
ones. It's a really fun experience…|js}
  ; url = {js|https://tarides.com/blog/2019-05-09-an-introduction-to-ocaml-ppx-ecosystem|js}
  ; date = {js|2019-05-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/0e8e776eb4ab9f596324bfe7e318b854/96c5f/circuit_boards.jpg|js}
  ; featured = false
  ; body_html = {js|<p>These last few months, I spent some time writing new OCaml PPX rewriters or contributing to existing
ones. It's a really fun experience. Toying around with the AST taught me a lot about a language I
thought I knew really well. Turns out I actually had no idea what I was doing all these years.</p>
<p>All jokes aside, I was surprised that the most helpful tricks I learned while writing PPX rewriters
weren't properly documented. There already exist a few very good introduction articles on the
subject, like that
<a href="https://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/">2014's article from Whitequark</a>,
this <a href="http://rgrinberg.com/posts/extensions-points-update-1/">more recent one from Rudi Grinberg</a>
or even <a href="https://victor.darvariu.me/jekyll/update/2018/06/19/ppx-tutorial.html">this last one from Victor Darvariu</a>
I only discovered after I actually started writing my own. I still felt like they were slightly
outdated or weren't answering all the questions I had when I started playing with PPX and writing my
first rewriters.</p>
<p>I decided to share my PPX adventures in the hope that it can help others familiarize with this bit
of the OCaml ecosystem and eventually write their first rewriters. The scope of this article is not to
cover every single detail about the PPX internals but just to give a gentle introduction to
beginners to help them get settled. That also means I might omit things that I don't think are worth
mentioning or that might confuse the targetted audience but feel free to comment if you believe
this article missed an important point.</p>
<p>It's worth mentioning that a lot of the nice tricks mentioned in these lines were given to me by a
wonderful human being called &Eacute;tienne Millon, thanks &Eacute;tienne!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#what-is-a-ppx" aria-label="what is a ppx permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is a PPX?</h2>
<p>PPX rewriters or PPX-es are preprocessors that are applied to your code before passing it on to the
compiler. They don't operate on your code directly but on the Abstract Syntax Tree or AST resulting
from its parsing. That means that they can only be applied to syntactically correct OCaml code. You
can think of them as functions that take an AST and return a new AST.</p>
<p>That means that in theory you can do a lot of things with a PPX, including pretty bad and cryptic
things. You could for example replace every instance of <code>true</code> by <code>false</code>, swap the branches of any
<code>if-then-else</code> or randomize the order of every pattern-matching case.
Obviously that's not the kind of behaviour that we want as it would make it impossible to
understand the code since it would be so far from the actual AST the compiler would get.
In practice PPX-es have a well defined scope and only transform parts you explicitly annotated.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#understanding-the-ocaml-ast" aria-label="understanding the ocaml ast permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Understanding the OCaml AST</h3>
<p>First things first, what is an AST. An AST is an abstract representation of your code. As the name
suggests it has a tree-like structure where the root describes your entire file. It has children for
each bits such as a function declaration or a type definition, each of them having their own
children, for example for the function name, its argument and its body and that goes on until you
reach a leaf such as a literal <code>1</code>, <code>&quot;abc&quot;</code> or a variable for instance.
In the case of OCaml it's a set of recursive types allowing us to represent OCaml code as an OCaml
value. This value is what the parser passes to the compiler so it can type check and compile it to
native or byte code.
Those types are defined in OCaml's <code>Parsetree</code> module. The entry points there are the <code>structure</code>
type which describes the content of an <code>.ml</code> file and the <code>signature</code> type which describes the
content of an <code>.mli</code> file.</p>
<p>As mentionned above, a PPX can be seen as a function that transforms an AST. Writing a PPX thus
requires you to understand the AST, both to interpret the one you'll get as input and
to produce the right one as output. This is probably the trickiest part as unless you've already
worked on the OCaml compiler or written a PPX rewriter, that will probably be the first time you two
meet. Chances are also high that'll be a pretty bad first date and you will need some to time
to get to know each other.</p>
<p>The <code>Parsetree</code> module <a href="https://caml.inria.fr/pub/docs/manual-ocaml/compilerlibref/Parsetree.html">documentation</a>,
is a good place to start. The above mentioned <code>structure</code> and <code>signature</code> types are at the root of
the AST but some other useful types to look at at first are:</p>
<ul>
<li><code>expression</code> which describes anything in OCaml that evaluates to a value, the right hand side of a
<code>let</code> binding for instance.</li>
<li><code>pattern</code> which is what you use to deconstruct an OCaml value, the left hand side of a <code>let</code>
binding or a pattern-matching case for example.</li>
<li><code>core_type</code> which describes type expressions ie what you would find on the right hand side of a
value description in a <code>.mli</code>, ie <code>val f : &lt;what_goes_there&gt;</code>.</li>
<li><code>structure_item</code> and <code>signature_item</code> which describe the top level AST nodes you can find in a
<code>structure</code> or <code>signature</code> such as type definitions, value or module declarations.</li>
</ul>
<p>Thing is, it's a bit a rough and there's no detailed explanation about how a specific bit of code is
represented, just type definitions. Most of the time, the type, field, and variant names are
self-explanatory but it can get harder with some of the more advanced language features.
It turns out there are plenty of comments that are really helpful in the actual <code>parsetree.mli</code> file
and that aren't part of the generated documentation. You can find them on
<a href="https://github.com/ocaml/ocaml/blob/trunk/parsing/parsetree.mli">github</a> but I personally prefer to
have it opened in a VIM tab when I work on a PPX so I usually open
<code>~/.opam/&lt;current_working_switch&gt;/lib/ocaml/compiler-libs/parsetree.mli</code>.</p>
<p>This works well while exploring but you might also want a more straightforward approach to
discovering what the AST representation is for some specific OCaml code. The
<a href="https://github.com/ocaml-ppx/ppx_tools"><code>ppx_tools</code></a> opam package comes with a <code>dumpast</code> binary
that pretty prints the AST for any given piece of valid OCaml code. You can install it using opam:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$opam install ppx_tools</code></pre></div>
<p>and then run it using <code>ocamlfind</code>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ocamlfind ppx_tools/dumpast some_file.ml</code></pre></div>
<p>You can use it on <code>.ml</code> and <code>.mli</code> files or to quickly get the AST for an expression with the <code>-e</code>
option:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ocamlfind ppx_tools/dumpast -e &quot;1 + 1&quot;</code></pre></div>
<p>Similarly, you can use the <code>-t</code> or <code>-p</code> options to respectively pretty print ASTs from type
expressions or patterns.</p>
<p>Using <code>dumpast</code> to get both the ASTs of a piece of code using your future PPX and the resulting
preprocessed code is a good way to start and will help you figure out what are the steps required to
get there.</p>
<p>Note that you can use the compiler or <code>utop</code> have a similar feature with the <code>-dparsetree</code> flag.
Running <code>ocamlc/ocamlopt -dparsetree file.ml</code> will pretty print the AST of the given file while
running <code>utop -dparsetree</code> will pretty print the AST of the evaluated code alongside it's
evaluation.
I tend to prefer the pretty printed AST from <code>dumpast</code> but any of these tools will prove helpful
in understanding the AST representation of a given piece of OCaml code.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#language-extensions-interpreted-by-ppx-es" aria-label="language extensions interpreted by ppx es permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Language extensions interpreted by PPX-es</h3>
<p>OCaml 4.02 introduced syntax extensions meant to be used by external tools such as PPX-es. Knowing
their syntax and meaning is important to understand how most of the existing rewriters
work because they usually look for those language extensions in the AST to know which part of it
they need to modify.</p>
<p>The two language extensions we're interested in here are extension nodes and attributes. They are
defined in detail in the OCaml manual (see the
<a href="https://caml.inria.fr/pub/docs/manual-ocaml/attributes.html">attributes</a> and
<a href="https://caml.inria.fr/pub/docs/manual-ocaml/extensionnodes.html">extension nodes</a> sections) but I'll
try to give a good summary here.</p>
<p>Extension nodes are used in place of expressions, module expressions, patterns, type expressions or
module type expressions. Their syntax is <code>[%extension_name payload]</code>. We'll come back to the payload
part a little later.
You can also find extension nodes at the top level of modules or module signatures with the syntax
<code>[%%extension_name payload]</code>.
Hopefully the following cheatsheet can help you remember the basics of how and where you can use
them:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> a <span class="token punctuation">:</span> int
  <span class="token punctuation">;</span> b <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext pl<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> x <span class="token operator">=</span>
  <span class="token keyword">match</span> <span class="token number">1</span> <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token number">0</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext pl<span class="token punctuation">]</span>
  <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext pl<span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span>

<span class="token punctuation">[</span><span class="token operator">%%</span>ext pl<span class="token punctuation">]</span></code></pre></div>
<p>Because extension nodes stand where regular AST nodes should, the compiler won't accept them and
will give you an <code>Uninterpreted extension</code> error. Extension nodes have to be expanded by a PPX for
your code to compile.</p>
<p>Attributes are slightly different although their syntax is very close to extensions. Attributes
are attached to existing AST nodes instead of replacing them. That means that they don't necessarily
need to be transformed and the compiler will ignore unknown attributes by default.
They can come with a payload just like extensions and use <code>@</code> instead of <code>%</code>. The number of <code>@</code>
preceding the attribute name specifies which kind of node they are attached to:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">12</span> <span class="token punctuation">[</span><span class="token operator">@</span>attr pl<span class="token punctuation">]</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token string">&quot;some string&quot;</span> <span class="token punctuation">[</span><span class="token operator">@@</span>attr pl<span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token operator">@@@</span>attr pl<span class="token punctuation">]</span></code></pre></div>
<p>In the first example, the attribute is attached to the expression <code>12</code> while in the second example
it is attached to the whole <code>let b = &quot;some string&quot;</code> value binding. The third one is of a slightly
different nature as it is a floating attribute. It's not attached to anything per-se and just ends
up in the AST as a structure item.
Because there is a wide variety of nodes to which you can attach attributes, I won't go too far into
details here but a good rule of thumb is that you use <code>@@</code> attributes when you want them attached to
structure or signature items, for anything deeper within the AST structure such as patterns,
expressions or core types, use the single <code>@</code> syntax. Looking at the <code>Parsetree</code> documentation can
help you figure out where you can find attributes.</p>
<p>Now let's talk about those payloads I mentioned earlier. You can think of them as &quot;arguments&quot; to
the extension points and attributes. You can pass different kinds of arguments and the syntax varies
for each of them:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext expr_or_str_item<span class="token punctuation">]</span> 
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext<span class="token punctuation">:</span> type_expr_or_sig_item<span class="token punctuation">]</span>
<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>ext<span class="token operator">?</span> pattern<span class="token punctuation">]</span></code></pre></div>
<p>As suggested in the examples, you can pass expressions or structure items using a space character,
type expressions or signature items (anything you'd find at the top level of a module signature)
using a <code>:</code> or a pattern using a <code>?</code>.</p>
<p>Attributes' payload use the same syntax:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token punctuation">[</span><span class="token operator">@</span>attr expr_or_str_item<span class="token punctuation">]</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token string">'b'</span> <span class="token punctuation">[</span><span class="token operator">@</span>attr<span class="token punctuation">:</span> type_expr_or_sig_item<span class="token punctuation">]</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'a'</span> <span class="token punctuation">[</span><span class="token operator">@</span>attr<span class="token operator">?</span> pattern<span class="token punctuation">]</span></code></pre></div>
<p>Some PPX-es rely on other language extensions such as the suffix character you can attach to <code>int</code>
and <code>float</code> literals (<code>10z</code> could be used by a PPX to turn it into <code>Z.of_string &quot;10&quot;</code> for instance)
or quoted strings with a specific identifier (<code>{ppx_name|some quoted string|ppx_name}</code> can be used
if you want your PPX to operate on arbitrary strings and not only syntactically correct OCaml) but
attributes and extensions are the most commonly used ones.</p>
<p>Attributes and extension points can be expressed using an infix syntax. The attribute version is
barely used but some forms of the infix syntax for extension points are used by popular PPX-es and
it is likely you will encounter some of the following:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> infix_let_extension <span class="token operator">=</span>
  <span class="token keyword">let</span><span class="token operator">%</span>ext x <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">in</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">let</span> infix_match_extension <span class="token operator">=</span>
  <span class="token keyword">match</span><span class="token operator">%</span>ext y <span class="token keyword">with</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">let</span> infix_try_extension <span class="token operator">=</span>
  <span class="token keyword">try</span><span class="token operator">%</span>ext f z <span class="token keyword">with</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div>
<p>which are syntactic sugar for:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> infix_let_extension <span class="token operator">=</span>
  <span class="token punctuation">[</span><span class="token operator">%</span>ext <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">in</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> infix_match_extension <span class="token operator">=</span>
  <span class="token punctuation">[</span><span class="token operator">%</span>ext <span class="token keyword">match</span> y <span class="token keyword">with</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

<span class="token keyword">let</span> infix_try_extension <span class="token operator">=</span>
  <span class="token punctuation">[</span><span class="token operator">%</span>ext <span class="token keyword">try</span> f z <span class="token keyword">with</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></code></pre></div>
<p>A good example of a PPX making heavy use of these if
<a href="http://ocsigen.org/lwt/4.1.0/api/Ppx_lwt"><code>lwt_ppx</code></a>. The OCaml manual also contains more examples
of the infix syntax in the Attributes and Extension points sections mentioned above.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#the-two-main-kind-of-ppx-es" aria-label="the two main kind of ppx es permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The two main kind of PPX-es</h3>
<p>There is a wide variety of PPX rewriters but the ones you'll probably see the most are Extensions and
Derivers.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#extensions" aria-label="extensions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extensions</h4>
<p>Extensions will rewrite tagged parts of the AST, usually extension nodes of the form
<code>[%&lt;extension_name&gt; payload]</code>. They will replace them with a different AST node of the same nature ie
if the extension point was located where an expression should be, the rewriter will produce an
expression. Good examples of extensions are:</p>
<ul>
<li><a href="https://github.com/rgrinberg/ppx_getenv2"><code>ppx_getenv2</code></a> which replaces <code>[%getenv SOME_VAR]</code> with
the value of the environment variable <code>SOME_VAR</code> at compile time.</li>
<li><a href="https://github.com/NathanReb/ppx_yojson"><code>ppx_yojson</code></a> which allows you to write <code>Yojson</code> values
using OCaml syntax to mimic actual json. For instance you'd use <code>[%yojson {a = None; b = 1}]</code> to
represent <code>{&quot;a&quot;: null, &quot;b&quot;: 1}</code> instead of the <code>Yojson</code>'s notation:
<code>Assoc [(&quot;a&quot;, Null); (&quot;b&quot;, Int 1)]</code>.</li>
</ul>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#derivers" aria-label="derivers permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Derivers</h4>
<p>Derivers or deriving plugins will &quot;insert&quot; new nodes derived from type definitions annotated with a
<code>[@@deriving &lt;deriver_name&gt;]</code> attribute. They have various applications but are particularly useful
to derive functions that are tedious and error prone to write by hand such as comparison functions,
pretty printers or serializers. It's really convenient as you don't have to update those functions
every time you update your type definitions. They were inspired by Haskell Type classes. Good
examples of derivers are:</p>
<ul>
<li><a href="https://github.com/ocaml-ppx/ppx_deriving"><code>ppx_deriving</code></a> itself comes with a bunch of deriving
plugins such as <code>eq</code>, <code>ord</code> or <code>show</code> which respectively derives, as you might have guessed,
equality, comparison and pretty-printing functions.</li>
<li><a href="https://github.com/ocaml-ppx/ppx_deriving_yojson"><code>ppx_deriving_yojson</code></a> which derives JSON
serializers and deserializers.</li>
<li><a href="https://github.com/janestreet/ppx_sexp_conv"><code>ppx_sexp_conv</code></a> which derives s-expressions
converters.</li>
</ul>
<p>Derivers often let you attach attributes to specify how some parts of the AST should be handled. For
example when using <code>ppx_deriving_yojson</code> you can use <code>[@default some_val]</code> to make a field of an
object optional:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> a<span class="token punctuation">:</span> int
  <span class="token punctuation">;</span> b<span class="token punctuation">:</span> string <span class="token punctuation">[</span><span class="token operator">@</span>default <span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token operator">@@</span>deriving of_yojson<span class="token punctuation">]</span></code></pre></div>
<p>will derive a deserializer that will convert the JSON value <code>{&quot;a&quot;: 1}</code> to the OCaml
<code>{a = 1; b = &quot;&quot;}</code></p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#how-to-write-a-ppx-using-ppxlib" aria-label="how to write a ppx using ppxlib permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to write a PPX using <code>ppxlib</code></h2>
<p>Historically there was a few libraries used by PPX rewriter authors to write their PPX-es, including
<code>ppx_tools</code> and <code>ppx_deriving</code> but as the eco-system evolved, <code>ppxlib</code> emerged and is now the most
up-to-date and maintained library to write and handle PPX-es. It wraps the features of those
libraries in a single one.
I encourage you to use <code>ppxlib</code> to write new PPX-es as it is also easier to make various rewriters
work together if they are all registered through <code>ppxlib</code> and the PPX ecosystem would gain from
being unified around a single PPX library and driver.</p>
<p>It is also a great library and has some really powerful features to help you write your extensions
and derivers.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#writing-an-extension" aria-label="writing an extension permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing an extension</h3>
<p>The entry point of <code>ppxlib</code> for extensions is <code>Ppxlib.Extension.declare</code>. You have to use that
function to build an <code>Extension.t</code>, from which you can then build a <code>Context_free.Rule.t</code> before
registering your transformation so it's actually applied.</p>
<p>The typical <code>my_ppx_extension.ml</code> will look like:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">open</span> <span class="token module variable">Ppxlib</span>

<span class="token keyword">let</span> extension <span class="token operator">=</span>
  <span class="token module variable">Extension</span><span class="token punctuation">.</span>declare
    <span class="token string">&quot;my_extension&quot;</span>
    some_context
    some_pattern
    expand_function

<span class="token keyword">let</span> rule <span class="token operator">=</span> <span class="token module variable">Context_free</span><span class="token punctuation">.</span><span class="token module variable">Rule</span><span class="token punctuation">.</span>extension extension

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token module variable">Driver</span><span class="token punctuation">.</span>register_transformation <span class="token label function">~rules</span><span class="token punctuation">:</span><span class="token punctuation">[</span>rule<span class="token punctuation">]</span> <span class="token string">&quot;my_transformation&quot;</span></code></pre></div>
<p>To compile it as PPX rewriter you'll need to put the following in your dune file:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(library
 (public_name my_ppx)
 (kind ppx_rewriter)
 (libraries ppxlib))</code></pre></div>
<p>Now let's go back a little and look at the important part:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> extension <span class="token operator">=</span>
  <span class="token module variable">Extension</span><span class="token punctuation">.</span>declare
    <span class="token string">&quot;my_extension&quot;</span>
    some_context
    some_pattern
    expand_function</code></pre></div>
<p>Here <code>&quot;my_extension&quot;</code> is the name of your extension and that define how you're going to invoke it
in your extension point. In other words, to use this extension in our code we'll use a
<code>[%my_extension ...]</code> extension point.</p>
<p><code>some_context</code> is a <code>Ppxlib.Extension.Context.t</code> and describes where this extension can be found in
the AST, ie can you use <code>[%my_extension ...]</code> as an expression, a pattern, a core type. The
<code>Ppxlib.Extension.Context</code> module defines a constant for each possible extension context which you
can pass as <code>some_context</code>.
This obviously means that it also describes the type of AST node to which it must be converted and
this property is actually enforced by the <code>some_pattern</code> argument. But we'll come back to that
later.</p>
<p>Finally <code>expand_function</code> is our actual extension implementation, which basically takes the payload,
a <code>loc</code> argument which contains the location of the expanded extension point, a <code>path</code> argument
which is the fully qualified path to the expanded node (eg. <code>&quot;file.ml.A.B&quot;</code>) and returns the
generated code to replace the extension with.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#ast_pattern" aria-label="ast_pattern permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ast_pattern</h4>
<p>Now let's get back to that <code>some_pattern</code> argument.</p>
<p>This is one of the trickiest parts of <code>ppxlib</code> to understand but it's also one its most
powerful features. The type for <code>Ast_pattern</code> is defined as <code>('a, 'b, 'c) t</code> where <code>'a</code> is
the type of AST nodes that are matched, <code>'b</code> is the type of the values you're extracting from the
node as a function type and <code>'c</code> is the return type of that last function. This sounded really
confusing to me at first and I'm guessing it might do to some of you too so let's give it a bit of
context.</p>
<p>Let's look at the type of <code>Extension.declare</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> declare <span class="token punctuation">:</span>
  string <span class="token operator">-&gt;</span>
  <span class="token type-variable function">'context</span> <span class="token module variable">Context</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span>
  <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token type-variable function">'a</span><span class="token punctuation">,</span> <span class="token type-variable function">'context</span><span class="token punctuation">)</span> <span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span>
  <span class="token punctuation">(</span>loc<span class="token punctuation">:</span><span class="token module variable">Location</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> path<span class="token punctuation">:</span>string <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  t</code></pre></div>
<p>Here, the expected pattern first type parameter is <code>payload</code> which means we want a pattern that
matches <code>payload</code> AST nodes. That makes perfect sense since it is used to describe what your
extension's payload should look like and what to do with it.
The last type parameter is <code>'context</code> which again seems logical. As I mentioned earlier our
<code>expand_function</code> should return the same kind of node as the one where the extension was found.
Now what about <code>'a</code>. As you can see, it describes what comes after the base <code>loc</code> and <code>path</code>
parameters of our <code>expand_function</code>. From the pattern point of view, <code>'a</code> describes the parts of the
matched AST node we wish to extract for later consumption, here by our expander.</p>
<p><code>Ast_pattern</code> contains a whole bunch of combinators to let you describe what your pattern should match
and a specific <code>__</code> pattern that you must use to capture the various parts of the matched nodes.
<code>__</code> has type <code>('a, 'a -&gt; 'b, 'b) Ast_pattern.t</code> which means that whenever it's used it changes the
type of consumer function in the returned pattern.</p>
<p>Let's consider a few examples to try wrapping our heads around this. Say I want to write an
extension that takes an expression as a payload and I want to pass this expression to my expander so
I can generate code based on its value. I can declare the extension like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> extension <span class="token operator">=</span>
  <span class="token module variable">Extension</span><span class="token punctuation">.</span>declare
    <span class="token string">&quot;my_extension&quot;</span>
    <span class="token module variable">Extension</span><span class="token punctuation">.</span><span class="token module variable">Context</span><span class="token punctuation">.</span>expression
    <span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span><span class="token punctuation">(</span>single_expr_payload __<span class="token punctuation">)</span>
    expand_function</code></pre></div>
<p>In this example, <code>Extension.Context.expression</code> has type <code>expression Extension.Context.t</code>, the
pattern has type <code>(payload, expression -&gt; expression, expression) Ast_pattern.t</code>. The pattern says we
want to allow a single expression in the payload and capture it. If we decompose it a bit, we can
see that <code>single_expr_payload</code> has type
<code>(expression, 'a, 'b) Ast_pattern.t -&gt; (payload, 'a, 'b) Ast_pattern.t</code> and is passed <code>__</code> which
makes it a <code>(expression, expression -&gt; 'b, 'b) Ast_pattern.t</code> and that's exactly what we want here
as our expander will have type <code>loc: Location.t -&gt; path: string -&gt; expression -&gt; expression</code>!</p>
<p>It works similarly to <code>Scanf.scanf</code> when you think about it. Changing the pattern changes the type of the
consumer function the same way changing the format string does for <code>Scanf</code> functions.</p>
<p>This was a bit easy since we had a custom combinator just for that purpose so let's take a few more
complex examples. Now say we want to only allow pairs of integer and string constants expressions in
our payload. Instead of just capturing any expression and dealing with the error cases in the
<code>expand_function</code> we can let <code>Ast_pattern</code> deal with that and pass an <code>int</code> and <code>string</code> along to
our expander:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span><span class="token punctuation">(</span>single_expr_payload <span class="token punctuation">(</span>pexp_tuple <span class="token punctuation">(</span><span class="token punctuation">(</span>eint __<span class="token punctuation">)</span><span class="token operator">^::</span><span class="token punctuation">(</span>estring __<span class="token punctuation">)</span><span class="token operator">^::</span>nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>This one's a bit more elaborate but the idea is the same, we use <code>__</code> to capture the int and string
from the expression and use combinators to specify that the payload should be made of a pair and
that gives us a: <code>(payload, int -&gt; string -&gt; 'a, 'a) Ast_pattern.t</code> which should be used with a
<code>loc: Location.t -&gt; path: string -&gt; int -&gt; string -&gt; expression</code> expander.</p>
<p>We can also specify that our extension should take something else than an expression as a payload,
say a pattern with no <code>when</code> clause so that it's applied as <code>[%my_ext? some_pattern_payload]</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span><span class="token punctuation">(</span>ppat __ none<span class="token punctuation">)</span></code></pre></div>
<p>or no payload at all and it should just be invoked as <code>[%my_ext]</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span><span class="token punctuation">(</span>pstr nil<span class="token punctuation">)</span></code></pre></div>
<p>You should play with <code>Ast_pattern</code> a bit if you need to express complex patterns as I think it's
the only way to get the hang of it.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#writing-a-deriver" aria-label="writing a deriver permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing a deriver</h3>
<p>Registering a deriver is slightly different from registering an extension but in the end it remains
relatively simple and you will still have to provide the actual implementation in the form of an
<code>expand</code> function.</p>
<p>The typical <code>my_ppx_deriver.ml</code> will look like:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">open</span> <span class="token module variable">Ppxlib</span>

<span class="token keyword">let</span> str_type_decl_generator <span class="token operator">=</span>
  <span class="token module variable">Deriving</span><span class="token punctuation">.</span><span class="token module variable">Generator</span><span class="token punctuation">.</span>make_no_arg
    <span class="token label function">~attributes</span>
    expand_str

<span class="token keyword">let</span> sig_type_decl_generator <span class="token operator">=</span>
  <span class="token module variable">Deriving</span><span class="token punctuation">.</span><span class="token module variable">Generator</span><span class="token punctuation">.</span>make_no_arg
    <span class="token label function">~attributes</span>
    expand_sig

<span class="token keyword">let</span> my_deriver <span class="token operator">=</span>
  <span class="token module variable">Deriving</span><span class="token punctuation">.</span>add
    <span class="token label function">~str_type_decl</span><span class="token punctuation">:</span>str_type_decl_generator
    <span class="token label function">~sig_type_decl</span><span class="token punctuation">:</span>sig_type_decl_generator
    <span class="token string">&quot;my_deriver&quot;</span></code></pre></div>
<p>Which you'll need to compile with the following <code>library</code> stanza:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(library
 (public_name my_ppx)
 (kind ppx_deriver)
 (libraries ppxlib))</code></pre></div>
<p>The <code>Deriving.add</code> function is declared as:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> add
  <span class="token punctuation">:</span>  <span class="token operator">?</span>str_type_decl<span class="token punctuation">:</span><span class="token punctuation">(</span>structure<span class="token punctuation">,</span> rec_flag <span class="token operator">*</span> type_declaration list<span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>str_type_ext <span class="token punctuation">:</span><span class="token punctuation">(</span>structure<span class="token punctuation">,</span> type_extension                  <span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>str_exception<span class="token punctuation">:</span><span class="token punctuation">(</span>structure<span class="token punctuation">,</span> extension_constructor           <span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>sig_type_decl<span class="token punctuation">:</span><span class="token punctuation">(</span>signature<span class="token punctuation">,</span> rec_flag <span class="token operator">*</span> type_declaration list<span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>sig_type_ext <span class="token punctuation">:</span><span class="token punctuation">(</span>signature<span class="token punctuation">,</span> type_extension                  <span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>sig_exception<span class="token punctuation">:</span><span class="token punctuation">(</span>signature<span class="token punctuation">,</span> extension_constructor           <span class="token punctuation">)</span> <span class="token module variable">Generator</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token operator">?</span>extension<span class="token punctuation">:</span><span class="token punctuation">(</span>loc<span class="token punctuation">:</span><span class="token module variable">Location</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> path<span class="token punctuation">:</span>string <span class="token operator">-&gt;</span> core_type <span class="token operator">-&gt;</span> expression<span class="token punctuation">)</span>
  <span class="token operator">-&gt;</span> string
  <span class="token operator">-&gt;</span> t</code></pre></div>
<p>It takes a mandatory string argument, here <code>&quot;my_deriver&quot;</code>, which defines how
user are going to invoke your deriver. In this case we'd need to add a <code>[@@deriving my_deriver]</code> to
a type declaration in a structure or a signature to use it.
Then there's just one optional argument per kind of node to which you can attach a <code>[@@deriving ...]</code>
attribute. <code>type_decl</code> correspond to <code>type = ...</code>, <code>type_ext</code> to <code>type += ...</code> and <code>exception</code> to
<code>exception My_exc of ...</code>.
You need to provide generators for the ones you wish your deriver to handle, <code>ppxlib</code>
will make sure users get a compile error if they try to use it elsewhere.
We can ignore the <code>extension</code> as it's just here for compatibility with <code>ppx_deriving</code>.</p>
<p>Now let's take a look at <code>Generator</code>. Its type is defined as <code>('output_ast, 'input_ast) t</code> where
<code>'input_ast</code> is the type of the node to which the <code>[@@deriving ...]</code> is attached and <code>'output_ast</code>
the type of the nodes it should produce, ie either a <code>structure</code> or a <code>signature</code>. The type of a
generator depends on the expand function it's built from when you use the smart constructor
<code>make_no_arg</code> meaning the expand function should have type
<code>loc: Location.t -&gt; path: string -&gt; 'input_ast -&gt; 'output_ast</code>. This function is the actual
implementation of your deriver and will generate the list of <code>structure_item</code> or <code>signature_item</code>
from the type declaration.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#compatibility-with-ppx_import" aria-label="compatibility with ppx_import permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compatibility with <code>ppx_import</code></h4>
<p><a href="https://github.com/ocaml-ppx/ppx_import"><code>ppx_import</code></a> is a PPX rewriter that lets you import type
definitions and spares you the need to copy and update them every time they change upstream. The
main reason why you would want to do that is because you need to derive values from those types
using a deriver thus the importance of ensuring your deriving plugin is compatible.</p>
<p>Let's take an example to illustrate how <code>ppx_import</code> is used. I'm using a library called <code>blob</code>
which exposes a type <code>Blob.t</code>. For some reason I need to be able to serialize and deserialize
<code>Blob.t</code> values to JSON. I'd like to use a deriver to do that as I don't want to maintain that code
myself. Imagine <code>Blob.t</code> is defined as:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> <span class="token keyword">value</span> <span class="token punctuation">:</span> string
  <span class="token punctuation">;</span> length <span class="token punctuation">:</span> int
  <span class="token punctuation">;</span> id <span class="token punctuation">:</span> int
  <span class="token punctuation">}</span></code></pre></div>
<p>Without <code>ppx_import</code> I would define somewhere a <code>serializable_blob</code> type as follows:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> serializable_blob <span class="token operator">=</span> <span class="token module variable">Blob</span><span class="token punctuation">.</span>t <span class="token operator">=</span>
  <span class="token punctuation">{</span> <span class="token keyword">value</span> <span class="token punctuation">:</span> string
  <span class="token punctuation">;</span> length <span class="token punctuation">:</span> int
  <span class="token punctuation">;</span> id <span class="token punctuation">:</span> int
  <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token operator">@@</span>deriving yojson<span class="token punctuation">]</span></code></pre></div>
<p>That works well especially because the type definition is simple but I don't really care about
having it here, what I really want is just the <code>to_yojson</code> and <code>of_yojson</code> functions. Also now, if
the type definition changes, I have to update it here manually. Maintaining many such imports can be
tedious and duplicates a lot of code unnecessarily.</p>
<p>What I can do instead, thanks to <code>ppx_import</code> is to write it like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> serializable_blob <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>import<span class="token punctuation">:</span> <span class="token module variable">Blob</span><span class="token punctuation">.</span>t<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">@@</span>deriving yojson<span class="token punctuation">]</span></code></pre></div>
<p>which will ultimately be expanded into the above using <code>Blob</code>'s definition of the type <code>t</code>.</p>
<p>Now <code>ppx_import</code> works a bit differently from regular PPX rewriters as it needs a bit more information
than just the AST. We don't need to understand how it works but what it means is that if your
deriving plugin is used with <code>ppx_import</code>, it will be called twice:</p>
<ul>
<li>A first time with <code>ocamldep</code>. This is required to determine the dependencies of a module in terms
of other OCaml modules. PPX-es need to be applied here to find out about dependencies they may
introduce.</li>
<li>A second time before actually compiling the code.</li>
</ul>
<p>The issue here is that during the <code>ocamldep</code> pass, <code>ppx_import</code> doesn't have the information it
needs to import the type definition yet so it can't copy it and it expands:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> u <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">%</span>import A<span class="token punctuation">.</span>t<span class="token punctuation">]</span></code></pre></div>
<p>into:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> u <span class="token operator">=</span> A<span class="token punctuation">.</span>t</code></pre></div>
<p>Only during the second pass will it actually expand it to the copied type definition.</p>
<p>This may be a concern if your deriving plugin can't apply to abstract types because you will
probably raise an error when encountering one, meaning the first phase will fail and the whole
compilation will fail without giving your rewriter a chance to derive anything from the copied
type definition.</p>
<p>The right way to deal with this is to have different a behaviour in the context of <code>ocamldep</code>.
In this case you can ignore such type declaration or eventually, if you know you are going to
inject new dependencies in your generated code, to create dummy values referencing them and just
behave normally in any other context.</p>
<p><code>ppxlib</code> versions <code>0.6.0</code> and higher allow you to do so through the <code>Deriving.Generator.V2</code> API
which passes an abstract <code>ctxt</code> value to your <code>expand</code> function instead of a <code>loc</code> and a <code>path</code>.
You can tell whether it is the <code>ocamldep</code> pass from within the <code>expand</code> function like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">open</span> <span class="token module variable">Ppxlib</span>

<span class="token keyword">let</span> expand <span class="token label function">~ctxt</span> input_ast <span class="token operator">=</span>
  <span class="token keyword">let</span> omp_config <span class="token operator">=</span> <span class="token module variable">Expansion_context</span><span class="token punctuation">.</span><span class="token module variable">Deriver</span><span class="token punctuation">.</span>omp_config ctxt <span class="token keyword">in</span>
  <span class="token keyword">let</span> is_ocamldep_pass <span class="token operator">=</span> <span class="token module variable">String</span><span class="token punctuation">.</span>equal <span class="token string">&quot;ocamldep&quot;</span> omp_config<span class="token punctuation">.</span><span class="token module variable">Migrate_parsetree</span><span class="token punctuation">.</span><span class="token module variable">Driver</span><span class="token punctuation">.</span>tool_name <span class="token keyword">in</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#deriver-attributes" aria-label="deriver attributes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deriver attributes</h4>
<p>You'll have noted the <code>attributes</code> parameter in the examples. It's an optional parameter that lets
you define which attributes your deriver allows the user to attach to various bits of the type,
type extension or exception declaration it is applied to.</p>
<p><code>ppxlib</code> comes with a <code>Attribute</code> module that lets you to properly declare the attributes you want
to allow and make sure they are properly used: correctly spelled, placed and with the right
payload attached. This is especially useful since attributes are by default ignored by the compiler
meaning without <code>ppxlib</code>'s care, plugin users wouldn't get any errors if they misused an attribute
and it might take them a while to figure out they got it wrong and the generated code wasn't
impacted as they hoped.
The <code>Attribute</code> module offers another great feature: <code>Attribute.t</code> values can be used to extract the
attribute payload from an AST node if it is present. That will spare you the need for
inspecting attributes yourself which can prove quite tedious.</p>
<p><code>Ppxlib.Attribute.t</code> is defined as <code>('context, 'payload) t</code> where <code>'context</code> describes to which node
the attribute can be attached and <code>'payload</code>, the type of its payload.
To build such an attribute you must use <code>Ppxlib.Attribute.declare</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> declare
  <span class="token punctuation">:</span>  string
  <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token module variable">Context</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token type-variable function">'b</span><span class="token punctuation">,</span> <span class="token type-variable function">'c</span><span class="token punctuation">)</span> <span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span>t
  <span class="token operator">-&gt;</span> <span class="token type-variable function">'b</span>
  <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token type-variable function">'a</span><span class="token punctuation">,</span> <span class="token type-variable function">'c</span><span class="token punctuation">)</span> t</code></pre></div>
<p>Let's try to declare the <code>default</code> argument from <code>ppx_deriving_yojson</code> I mentioned earlier.</p>
<p>The first <code>string</code> argument is the attribute name. <code>ppxlib</code> support namespaces for the attributes so
that users can avoid conflicting attributes between various derivers applied to the same type
definitions. For instance here we could use <code>&quot;default&quot;</code>. It can prove helpful to use more qualified
name such as <code>&quot;ppx_deriving_yojson.of_yojson.default&quot;</code>. That means that our attribute can be used as
<code>[@@default ...]</code>, <code>[@@of_yojson.default ...]</code> or <code>[@@ppx_deriving.of_yojson.default ...]</code>.
Now if another deriver uses a <code>[@@default ...]</code>, users can apply both derivers and provide different
<code>default</code> values to the different derivers by writing:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> a <span class="token punctuation">:</span> int
  <span class="token punctuation">;</span> b <span class="token punctuation">:</span> string <span class="token punctuation">[</span><span class="token operator">@</span>make<span class="token punctuation">.</span>default <span class="token string">&quot;abc&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">@</span>of_yojson<span class="token punctuation">.</span>default <span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token operator">@@</span>deriving make<span class="token punctuation">,</span>of_yojson<span class="token punctuation">]</span></code></pre></div>
<p>The context argument works very similarly to the one in <code>Extension.declare</code>. Here we want the
attribute to be attached to record field declarations so we'll use
<code>Attribute.Context.label_declaration</code> which has type <code>label_declaration Attribute.Context.t</code>.</p>
<p>The pattern argument is an <code>Ast_pattern.t</code>. Now that we know how to work with those this is pretty
easy. Here we need to accept any expression as a payload since we should be able to apply the
<code>default</code> attribute to any field, regardless of its type and we want to extract that expression from
the payload so we can use it in our deserializer so let's use
<code>Ast_pattern.(single_expr_payload __)</code>.</p>
<p>Finally the last <code>'b</code> argument has the same type as the pattern consumer function. We can use it to
transform what we extracted using the previous <code>Ast_pattern</code> but in this case we just want to
keep the expression as we got it so we'll just use the identity function here.</p>
<p>We end up with the following:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> default_attribute <span class="token operator">=</span>
  <span class="token module variable">Attribute</span><span class="token punctuation">.</span>declare
    <span class="token string">&quot;ppx_deriving_yojson.of_yojson.default&quot;</span>
    <span class="token module variable">Attribute</span><span class="token punctuation">.</span><span class="token module variable">Context</span><span class="token punctuation">.</span>label_declaration
    <span class="token module variable">Ast_pattern</span><span class="token punctuation">.</span><span class="token punctuation">(</span>single_expr_payload __<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">fun</span> expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">)</span></code></pre></div>
<p>and that gives us a <code>(label_declaration, expression) Attribute.t</code>.</p>
<p>You can then use it to collect the attribute payload from a label_declaration:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token module variable">Attribute</span><span class="token punctuation">.</span>get default_attribute label_decl</code></pre></div>
<p>which will return <code>Some expr</code> if the attribute was attached to <code>label_decl</code> or <code>None</code> otherwise.</p>
<p>Because of their polymorphic nature, attributes need to be packed, ie to be wrapped with a variant
to hide the type parameter, so if you want to pass it to <code>Generator.make_no_arg</code> you'll have to do
it like this:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> attributes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token module variable">Attribute</span><span class="token punctuation">.</span>T default_attribute<span class="token punctuation">]</span></code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#writing-your-expand-functions" aria-label="writing your expand functions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writing your expand functions</h3>
<p>In the two last sections I mentioned <code>expand</code> functions that would contain the actual <code>deriver</code> or
<code>extension</code> implementation but didn't actually said anything about how to write those. It will
depend a lot on the purpose of your PPX rewriter and what you're trying to achieve.</p>
<p>Before writing your PPX you should clearly specify what it should be applied to and what code it
should produce. That will help you declaring the right deriving or extension rewriter and from there
you'll know the type of the <code>expand</code> functions you have to write which should help.</p>
<p>A good way to proceed is to use the <code>dumpast</code> tool to pretty print the AST fragments of both the
input of your expander and the output, ie the code it should generate. To take a concrete example,
say you want to write a deriving plugin that generates an <code>equal</code> function from a type definition.
You can start by running <code>dumpast</code> on the following file:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">type</span> some_record <span class="token operator">=</span>
  <span class="token punctuation">{</span> a <span class="token punctuation">:</span> int64
  <span class="token punctuation">;</span> b <span class="token punctuation">:</span> string
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> equal_some_record r r' <span class="token operator">=</span> <span class="token module variable">Int64</span><span class="token punctuation">.</span>equal r<span class="token punctuation">.</span>a r'<span class="token punctuation">.</span>a <span class="token operator">&amp;&amp;</span> <span class="token module variable">String</span><span class="token punctuation">.</span>equal r<span class="token punctuation">.</span>b r'<span class="token punctuation">.</span>b</code></pre></div>
<p>That will give you the AST representation of a record type definition and the equal function you
want to write so you can figure out how to deconstruct your expander's input to be able to generate
the right output.</p>
<p><code>ppxlib</code> exposes smart constructors in <code>Ppxlib.Ast_builder.Default</code> to help you build AST fragments
without having to care too much attributes and such fields as well as some convenience constructors
to keep your code concise and readable.</p>
<p>Another convenience tool <code>ppxlib</code> exposes to help you build AST fragments is <code>metaquot</code>. I recently
wrote a bit of documentation about it
<a href="https://ppxlib.readthedocs.io/en/latest/ppx-for-plugin-authors.html#metaquot">here</a> which you
should take a look at but to sum it up <code>metaquot</code> is a PPX extension allowing you to write AST nodes
using the OCaml syntax they describe instead of the AST types.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#handling-code-locations-in-a-ppx-rewriter" aria-label="handling code locations in a ppx rewriter permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Handling code locations in a PPX rewriter</h4>
<p>When building AST fragments you should keep in mind that you have to set their <code>location</code>. Locations
are part of the AST values that describes the position of the corresponding node in your source
file, including the file name and the line number and offset of both the beginning and the end the
code bit they represent.</p>
<p>Because your code was generated after the file was parsed, it doesn't have a location so you need to
set it yourself. One could think that it doesn't matter and we could use a dummy location but
locations are used by the compiler to properly report errors and that's why a PPX rewriter should care
about how it locates the generated code as it will help the end user to understand whether the error
comes from their code or generated code and how to eventually fix it.</p>
<p>Both <code>Ast_builder</code> and <code>metaquot</code> expect a location. The first explicitly takes it as a labelled
<code>loc</code> argument while the second relies on a <code>loc</code> value being available in the scope. It is
important to set those with care as errors in the generated code doesn't necessarily mean that your
rewriter is bugged. There are valid cases where your rewriter functioned as intended but the generated
code triggers an error. PPX-es often work on the assumption that some values are available in the
scope, if the user doesn't properly provide those it's their responsibility to fix the error. To
help them do so, it is important to properly locate the generated code to guide them as much as
possible.</p>
<p>When writing extensions, using the whole extension point location for the generated code makes
perfect sense as that's where the code will sit. That's fairly easy as this what <code>ppxlib</code> passes
to the expand function through the <code>loc</code> labelled argument. For deriving plugins it's a bit different
as the generated code doesn't replace an existing part of the parsed AST but generate a new one to insert.
Currently <code>ppxlib</code> gives you the <code>loc</code> of the whole type declaration, extension or exception
declaration your deriving plugin is applied to. Ideally it would be nice to be able to locate the
generated code on the plugin name in the <code>deriving</code> attribute payload, ie here:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[@@deriving my_plugin,another_plugin]
            ^^^^^^^^^</code></pre></div>
<p>I'm currently working on making that location available to the <code>expand</code> function. In the meantime,
you should choose a convention. I personally locate all the generated code on the
type declaration. Some choose to locate the generated code on the part of the input AST they're
handling when generating it.</p>
<h4 style="position:relative;"><a href="https://tarides.com/feed.xml#reporting-errors-to-your-rewriter-users" aria-label="reporting errors to your rewriter users permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reporting errors to your rewriter users</h4>
<p>You won't always be able to handle all the AST nodes passed to your expand functions, either because the
end user misused your rewriter or because there are some cases you simply can't deal with.</p>
<p>In those cases you can report the error to the user with <code>Ppxlib.Location.raise_errorf</code>. It works
similarly to <code>printf</code> and you can build your error message from a format string and extra
arguments. It will then raise an exception which will be caught and reported by the compiler.
A good practice is to prefix the error message with the name of your rewriter to help users understand
what's going on, especially with deriving plugin as they might use several of them on the same type
declaration.</p>
<p>Another point to take care of here is, again, locations. <code>raise_errorf</code> takes a labelled <code>loc</code>
arguments. It is used so that your error is reported as any compiler error. Having good locations in
those error messages is just as important as sending clear error messages. Keep in mind that both
the errors you report yourself or errors coming from your generated code will be highlighted by
merlin so when properly set they make it much easier to work with your PPX rewriter.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#testing-your-ppx" aria-label="testing your ppx permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Testing your PPX</h3>
<p>Just as most pieces of code do, a PPX deserves to be tested and it has become easier over the years to
test rewriters.</p>
<p>I personally tend to write as many unit test as possible for my PPX-es internal libraries. I try to
extract helper functions that can easily be unit-tested but I can't test it all that way.
Testing the <code>ast -&gt; ast</code> functions would be tedious as <code>ppxlib</code> and <code>ocaml-migrate-parsetree</code>
don't provide comparison and pretty printing functions that you can use with <code>alcotest</code> or <code>oUnit</code>.
That means you'd have to import the AST types and derive them on your own. That would make a lot
of boiler plate and even if those functions were exposed, writing such tests would be really
tedious. There's a lot of things to take into account. How are you going to build the input AST values
for instance?  If you use <code>metaquot</code>, every node will share the same loc, making it hard to test
that your errors are properly located. If you don't, you will end up with insanely long and
unreadable test code or fixtures.
While that would allow extremely accurate testing for the generated code and errors, it will almost
certainly make your test code unmaintainable, at least given the current tooling.</p>
<p>Don't panic, there is a very good and simple alternative. <code>ppxlib</code> makes it very easy to build a
binary that will parse OCaml code, preprocess the AST with your rewriter and spit it out, formatted as
code again.</p>
<p>You just have to write the following <code>pp.ml</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token module variable">Ppxlib</span><span class="token punctuation">.</span><span class="token module variable">Driver</span><span class="token punctuation">.</span>standalone <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<p>and build the binary with the following <code>dune</code> stanza, assuming your rewriter is called
<code>my_ppx_rewriter</code>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(executable
 (name pp)
 (modules pp)
 (libraries my_ppx_rewriter ppxlib))</code></pre></div>
<p>Because we're humans and the OCaml syntax is meant for us to write and read, it makes for much better
test input/output. You can now write your test input in a regular <code>.ml</code> file, use the <code>pp.exe</code>
binary to &quot;apply&quot; your preprocessor to it and compare the output with another <code>.ml</code> file containing
the code you expect it to generate. This kind of test pattern is really well supported by <code>dune</code>
thanks to the <code>diff</code> user action.</p>
<p>I usually have the following files in a <code>rewriter</code>/<code>deriver</code> folder within my test directory:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">test/rewriter/
&#9500;&#9472;&#9472; dune
&#9500;&#9472;&#9472; test.expected.ml
&#9500;&#9472;&#9472; pp.ml
&#9492;&#9472;&#9472; test.ml</code></pre></div>
<p>Where <code>pp.ml</code> is used to produce the rewriter binary, <code>test.ml</code> contains the input OCaml code and
<code>test.expected.ml</code> the result of preprocessing <code>test.ml</code>. The dune file content is generally similar
to this:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(executable
 (name pp)
 (modules pp)
 (libraries my_ppx_rewriter ppxlib))

(rule
 (targets test.actual.ml)
 (deps (:pp pp.exe) (:input test.ml))
 (action (run ./%{pp} -deriving-keep-w32 both --impl %{input} -o %{targets})))

(alias
 (name runtest)
 (action (diff test.expected.ml test.actual.ml)))

(test
  (name test)
  (modules test)
  (preprocess (pps my_ppx_rewriter)))</code></pre></div>
<p>The first stanza is the one I already introduced above and specifies how to build the rewriter binary.</p>
<p>The <code>rule</code> stanza that comes after that indicates to <code>dune</code> how to produce the actual test output by
applying the rewriter binary to <code>test.ml</code>. You probably noticed the <code>-deriving-keep-w32 both</code> CLI
option passed to <code>pp.exe</code>. By default, <code>ppxlib</code> will generate values or add attributes so that your
generated code doesn't trigger a &quot;Unused value&quot; warning. This is useful in real life situation but
here it will just pollute the test output and make it harder to read so we disable that feature.</p>
<p>The following <code>alias</code> stanza is where all the magic happens. Running <code>dune runtest</code> will now
generate <code>test.actual.ml</code> and compare it to <code>test.expected.ml</code>. It will not only do that but show
you how they differ from each other in a diff format. You can then automatically update
<code>test.expected.ml</code> if you're happy with the results by running <code>dune promote</code>.</p>
<p>Finally the last <code>test</code> stanza is there to ensure that the generated code compiles without type
errors.</p>
<p>This makes a very convenient test setup to write your PPX-es TDD style. You can start by writing an
identity PPX, that will just return its input AST as it is. Then you add some OCaml code using your
soon to be PPX in <code>test.ml</code> and run <code>dune runtest --auto-promote</code> to prefill <code>test.expected.ml</code>.
From there you can start implementing your rewriter and run <code>dune runtest</code> to check on your progress
and update the expected result with <code>dune promote</code>.
Going pure TDD by writing the test works but it's tricky cause you'd have to format your code the
same way <code>pp.exe</code> will format the AST. It would be great to be able to specify how to format
the generated <code>test.actual.ml</code> so that this approach would be more viable and the diff more
readable. Being able to use ocamlformat with a very diff friendly configuration would be great
there. <code>pp.exe</code> seems to offer CLI options to change the code style such as <code>-styler</code> but I haven't
had the chance to experiment with those yet.</p>
<p>Now you can test successful rewriting this way but what about errors? There's a lot of value
ensuring you produce the right errors and on the right code location because that's the kind of
things you can get wrong when refactoring your rewriter code or when people try to contribute.
That isn't as likely to happen if your CI yells when you break the error reporting. So how do we do
that?</p>
<p>Well pretty much the exact same way! We write a file with an erroneous invocation of our rewriter,
run <code>pp.exe</code> on it and compare stderr with what we expect it to be.
There are two major differences here. First we want to collect the stderr output of the rewriter
binary instead of using it to generate a file. The second is that we cant write all of our test
cases in a single file since <code>pp.exe</code> will stop at the first error. That means we need one <code>.ml</code>
file per error test case.
Luckily for us, dune offers ways to do both.</p>
<p>For every error test file we will want to add the following stanzas:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(rule
  (targets test_error.actual)
  (deps (:pp pp.exe) (:input test_error.ml)) 
  (action
    (with-stderr-to
      %{targets}
      (bash &quot;./%{pp} -no-color --impl %{input} || true&quot;)
    )
  )
)

(alias
  (name runtest)
  (action (diff test_error.expected test_error.actual))
)</code></pre></div>
<p>but obviously we don't want to do that by hand every time we add a new test case so we're gonna need
a script to generate those stanzas and then include them into our <code>dune</code> file using
<code>(include dune.inc)</code>.</p>
<p>To achieve that while keeping things as clean as possible I use the following directory structure:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">test/rewriter/
&#9500;&#9472;&#9472; errors
&#9474;   &#9500;&#9472;&#9472; dune
&#9474;   &#9500;&#9472;&#9472; dune.inc
&#9474;   &#9500;&#9472;&#9472; gen_dune_rules.ml
&#9474;   &#9500;&#9472;&#9472; pp.ml
&#9474;   &#9500;&#9472;&#9472; test_some_error.expected
&#9474;   &#9500;&#9472;&#9472; test_some_error.ml
&#9474;   &#9500;&#9472;&#9472; test_some_other_error.expected
&#9474;   &#9492;&#9472;&#9472; test_some_other_error.ml
&#9500;&#9472;&#9472; dune
&#9500;&#9472;&#9472; test.expected.ml
&#9500;&#9472;&#9472; pp.ml
&#9492;&#9472;&#9472; test.ml</code></pre></div>
<p>Compared to our previous setup, we only added the new <code>errors</code> folder. To keep things simple it has
its own <code>pp.ml</code> copy but in the future I'd like to improve it a bit and be able to use the same
<code>pp.exe</code> binary.</p>
<p>The most important files here are <code>gen_dune_rules.ml</code> and <code>dune.inc</code>. The first is just a simple
OCaml script to generate the above stanzas for each test cases in the <code>errors</code> directory. The second
is the file we'll include in the main <code>dune</code>. It's also the file to which we'll write the generated
stanza.</p>
<p>I personally use the following <code>gen_dune_rules.ml</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> output_stanzas filename <span class="token operator">=</span>
  <span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token module variable">Filename</span><span class="token punctuation">.</span>remove_extension filename <span class="token keyword">in</span>
  <span class="token module variable">Printf</span><span class="token punctuation">.</span>printf
    <span class="token punctuation">{</span><span class="token operator">|</span>
<span class="token punctuation">(</span>library
  <span class="token punctuation">(</span>name <span class="token operator">%</span>s<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>modules <span class="token operator">%</span>s<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>preprocess <span class="token punctuation">(</span>pps ppx_yojson<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token punctuation">(</span>rule
  <span class="token punctuation">(</span>targets <span class="token operator">%</span>s<span class="token punctuation">.</span>actual<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>deps <span class="token punctuation">(</span><span class="token punctuation">:</span>pp pp<span class="token punctuation">.</span>exe<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">:</span>input <span class="token operator">%</span>s<span class="token punctuation">.</span>ml<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>action
    <span class="token punctuation">(</span><span class="token keyword">with</span><span class="token operator">-</span>stderr<span class="token operator">-</span><span class="token keyword">to</span>
      <span class="token operator">%%</span><span class="token punctuation">{</span>targets<span class="token punctuation">}</span>
      <span class="token punctuation">(</span>bash <span class="token string">&quot;./%%{pp} -no-color --impl %%{input} || true&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token punctuation">(</span>alias
  <span class="token punctuation">(</span>name runtest<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>action <span class="token punctuation">(</span>diff <span class="token operator">%</span>s<span class="token punctuation">.</span>expected <span class="token operator">%</span>s<span class="token punctuation">.</span>actual<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token operator">|</span><span class="token punctuation">}</span>
    base
    base
    base
    base
    base
    base

<span class="token keyword">let</span> is_error_test <span class="token operator">=</span> <span class="token keyword">function</span>
  <span class="token operator">|</span> <span class="token string">&quot;pp.ml&quot;</span> <span class="token operator">-&gt;</span> <span class="token boolean">false</span>
  <span class="token operator">|</span> <span class="token string">&quot;gen_dune_rules.ml&quot;</span> <span class="token operator">-&gt;</span> <span class="token boolean">false</span>
  <span class="token operator">|</span> filename <span class="token operator">-&gt;</span> <span class="token module variable">Filename</span><span class="token punctuation">.</span>check_suffix filename <span class="token string">&quot;.ml&quot;</span>

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token module variable">Sys</span><span class="token punctuation">.</span>readdir <span class="token string">&quot;.&quot;</span>
  <span class="token operator">|&gt;</span> <span class="token module variable">Array</span><span class="token punctuation">.</span>to_list
  <span class="token operator">|&gt;</span> <span class="token module variable">List</span><span class="token punctuation">.</span>sort <span class="token module variable">String</span><span class="token punctuation">.</span>compare
  <span class="token operator">|&gt;</span> <span class="token module variable">List</span><span class="token punctuation">.</span>filter is_error_test
  <span class="token operator">|&gt;</span> <span class="token module variable">List</span><span class="token punctuation">.</span>iter output_stanzas</code></pre></div>
<p>Nothing spectacular here, we just build the list of all the <code>.ml</code> files in the directory except
<code>pp.ml</code> and <code>gen_dune_rules.ml</code> itself and then generate the right stanzas for each of them. You'll
note the extra <code>library</code> stanza which I add to get dune to generate the right <code>.merlin</code> so that I
can see the error highlights when I edit the files by hand.</p>
<p>With that we're almost good, add the following to the <code>dune</code> file and you're all set:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(executable
  (name pp)
  (modules pp)
  (libraries
    ppx_yojson
    ppxlib
  )
)

(include dune.inc)

(executable
  (name gen_dune_rules)
  (modules gen_dune_rules)
)

(rule
  (targets dune.inc.gen)
  (deps
    (:gen gen_dune_rules.exe)
    (source_tree .)
  )
  (action
    (with-stdout-to
      %{targets}
      (run %{gen})
    ) 
  )
)

(alias
  (name runtest)
  (action (diff dune.inc dune.inc.gen))
)</code></pre></div>
<p>The first stanza is here to specify how to build the rewriter binary, same as before, while the
second stanza just tells dune to include the content of <code>dune.inc</code> within this <code>dune</code> file.</p>
<p>The interesting part comes next. As you can guess the <code>executable</code> stanza builds our little OCaml
script into a <code>.exe</code>. The <code>rule</code> that comes after that specifies how to generate the new stanzas
by running <code>gen_dune_rules</code> and capturing its standard output into a <code>dune.inc.gen</code> file.
The last rule allows you to review the changes to the generated stanza and use promotion to accept
them. Once this is done, the new stanzas will be included to the <code>dune</code> file and the test will be
run for every test cases.</p>
<p>Adding a new test case is then pretty easy, you can simply run:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ touch test/rewriter/errors/some_explicit_test_case_name.{ml,expected} &amp;&amp; dune runtest --auto-promote</code></pre></div>
<p>That will create the new empty test case and update the <code>dune.inc</code> with the corresponding rules.
From there you can proceed the same way as with the successful rewriting tests, update the <code>.ml</code>,
run <code>dune runtest</code> to take a sneak peek at the output and <code>dune promote</code> once you're satisfied with
the result.</p>
<p>I've been pretty happy with this setup so far although there's room for improvement. It would be
nice to avoid duplicating <code>pp.ml</code> for errors testing. This also involves
quite a bit of boilerplate that I have to copy into all my PPX rewriters repositories every time.
Hopefully <a href="https://github.com/ocaml/dune/issues/1855">dune plugins</a> should help with that and I
can't wait for a first version to be released so that I can write a plugin to make this test
pattern more accessible and easier to set up.</p>|js}
  };
 
  { title = {js|7th MirageOS hack retreat|js}
  ; slug = {js|7th-mirageos-hack-retreat|js}
  ; description = Some {js|Let's talk sun, mint tea and OCaml: Yes, you got it, the MirageOS biennial retreat at Marrakesh! For the 7th iteration of the retreat, the…|js}
  ; url = {js|https://tarides.com/blog/2019-05-06-7th-mirageos-hack-retreat|js}
  ; date = {js|2019-05-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/c18127602edbf62c47c7d5df165b2d8b/0132d/moroccan_plates.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Let's talk sun, mint tea and OCaml: Yes, you got it, the <a href="http://retreat.mirage.io">MirageOS biennial retreat</a> at Marrakesh!</p>
<p>For the 7th iteration of the retreat, the majority of the Tarides team took part in the trip to the camels country.
This is a report about what we produced and enjoyed while there.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#charles-edouard-lecat" aria-label="charles edouard lecat permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Charles-Edouard Lecat</h1>
<p>That's it, my first MirageOS retreat is coming soon, let's jump in the plane and here I come. After a nice cab trip and an uncountable number of similar streets, I'm finally at the Riad which will host me for the next 5 days.</p>
<p>It now begins the time to do what I came for: Code, Eat, Sleep and Repeat</p>
<p>I mostly worked on <a href="https://github.com/mirage/colombe">Colombe</a>, the OCaml implementation of the SMTP protocol for which I developed a simple client.
Except some delayed problems (like the integration of the MIME protocol, the TLS wrapping and some others), the client was working perfectly :)
Implementing it was actually really easy as the core of the SMTP protocol was done by @dinosaure who developed over time a really nice way of implementing this kind of API. And as I spend most of my time at Tarides working on his code, I feel really comfortable with it.</p>
<p>One of the awesome thing about this retreat was the people who came: There was so many interesting people, doing various thing, so each time someone had an interrogation, you could almost be sure that someone could help you in a way or another.</p>
<p>But sadly, as I arrived few days after everyone, and just before the week-end, the time flew away reaaaaaally fast, and I did not have the time to do some major code, but I'm already looking forward to the next retreat which, I am sure, will be even more fruitful and attract a lot of nice OCaml developers.</p>
<p>Until then, I will just dream about the awesome food I ate there ;)</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#lucas-pluvinage" aria-label="lucas pluvinage permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lucas Pluvinage</h1>
<p>Second Mirage retreat for me, and this time I had plans: make a small web game with Mirage hosted by an ESP32 device. I figured out that there was not canonical way to make an HTTP/Websocket server with Mirage and I didn't want to stick to a particular library.</p>
<p>Instead, I took my time to develop <code>mirage-http</code>, an abstraction of HTTP that can either have <code>cohttp</code> or <code>httpaf</code> as a backend. On top of that, I've build <code>mirage-websocket</code> which is therefore an HTTP server-independant implementation of websockets (indeed this has a lot of redundancies with <code>ocaml-websocket</code> but for now it's a proof of concept). While making all this I discussed with @anmonteiro who's the Webservers/protocols expert for Mirage ! However I didn't have the time to build something on top of that, but this is still something that I would like achieve at some point.</p>
<p>I also became the &quot;dune guy&quot; as I'm <a href="https://github.com/mirage/mirage/issues/969">working on the Mirage/dune integration</a>, and helped some people with their build system struggles.</p>
<p>It was definitely a rich week, I've learnt a lot of things, enjoyed the sun, ate good food and contributed to the Mirage universe !</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#jules-aguillon" aria-label="jules aguillon permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Jules Aguillon</h1>
<p>This was my first retreat.
It was the occasion to meet OCaml developers from all over the world.
The food was great and the weather perfect.</p>
<p>I submitted some PRs to the OCaml compiler !</p>
<ul>
<li>Hint on type error on int literal <a href="https://github.com/ocaml/ocaml/pull/2301">PR #2301</a>.
It's adding an hint when using <code>int</code> literals instead of other number literals (eg. <code>3</code> instead of <code>3.</code> or <code>3L</code>):</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Line 2, characters 20-21:
2 | let _ = Int32.add a 3
                        ^
Error: This expression has type int but an expression was expected of type
          int32
        Hint: Did you mean `3l'?</code></pre></div>
<ul>
<li>Hint on type error on int operators <a href="https://github.com/ocaml/ocaml/pull/2307">PR #2307</a>. Hint the user when using numerical operators for ints (eg. <code>+</code>) on other kind of numbers (eg. <code>float</code>, <code>int64</code>, etc..). For example:</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Line 8, characters 8-9:
8 | let _ = x + 1.
            ^
Error: This expression has type float but an expression was expected of type
          int
Line 8, characters 10-11:
8 | let _ = x + 1.
              ^
  Hint: Did you mean to use `+.'?</code></pre></div>
<ul>
<li>
<p>Clean up int literal hint <a href="https://github.com/ocaml/ocaml/pull/2313">PR #2313</a>. A little cleanup of the 2 previous PRs.</p>
</li>
<li>
<p>Hint when the expected type is wrapped in a ref <a href="https://github.com/ocaml/ocaml/pull/2319">PR #2319</a>. An other PR adding an hint: When the user forgot to use the <code>!</code> operator on <code>ref</code> values:</p>
</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Line 2, characters 8-9:
2 | let b = a + 1
            ^
Error: This expression has type int ref
        but an expression was expected of type int
  Hint: This is a `ref', did you mean `!a'?</code></pre></div>
<p>The first 3 are merged now.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#gabriel-de-perthuis" aria-label="gabriel de perthuis permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gabriel de Perthuis</h1>
<p>For this retreat my plan was to do something a little different and work on Solo5.</p>
<p><a href="https://github.com/mirage/wodan">Wodan</a>, the storage layer I'm working on,
needs two things from its backends which are not commonly implemented:</p>
<ul>
<li>support for discarding unused blocks (first implemented in mirage-block-unix), and</li>
<li>support for barriers, which are ordering constraints between writes</li>
</ul>
<p>Solo5 provides relevant mirage backends, which are themselves provided by various
virtualised implementations.  Discard was added to most of those, at least those
that were common enough to be easily tested; we just added an &quot;operation not supported&quot;
error code for the other cases.</p>
<p>The virtio implementation was interesting; recent additions to the spec allow discard
support, but few virtual machine managers actually implement that on the backend side.
I tried to integrate with the Chromium OS &quot;crosvm&quot; for that, and had a good time
figuring out how it found the bootloader entry point (turns out the cpu was happily
skipping past invalid instructions to find a slightly misaligned entry point), but
ran out of time to figure out the rest of the integration, which seemed to be more
complex that anticipated.  Because of this virtio discard support will be skipped over
for now.</p>
<p>I also visited the souk, which was an interesting experience.
Turns out I'm bad at haggling, but I brought back interesting things anyway.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>We'd like to thank Hannes Mehnert who organized this retreat and all the attendees who contributed to make it fruitful and inspiring.
You want to take part in the next MirageOS retreat? Stay tuned <a href="http://retreat.mirage.io">here</a>.</p>|js}
  };
 
  { title = {js|Learning ML Depth-First|js}
  ; slug = {js|learning-ml-depth-first|js}
  ; description = Some {js|If you haven’t heard of it, Depth FirstLearning is awonderful resource for learning about machine learning.|js}
  ; url = {js|https://blog.janestreet.com/learning-ml-depth-first/|js}
  ; date = {js|2019-04-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/learning-ml-depth-first/Depth_First_Realigned.svg|js}
  ; featured = false
  ; body_html = {js|<p>If you haven&rsquo;t heard of it, <a href="https://www.depthfirstlearning.com/2018/DFL-Fellowship">Depth First
Learning</a> is a
wonderful resource for learning about machine learning.</p>|js}
  };
 
  { title = {js|Dune 1.9.0|js}
  ; slug = {js|dune-190|js}
  ; description = Some {js|Tarides is pleased to have contributed to the dune 1.9.0 release which
introduces the concept of library variants. Thanks to this update…|js}
  ; url = {js|https://tarides.com/blog/2019-04-10-dune-1-9-0|js}
  ; date = {js|2019-04-10T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/a7294df7159db3785da6121fc6ecadf8/10057/sand_dune2.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Tarides is pleased to have contributed to the dune 1.9.0 release which
introduces the concept of library variants. Thanks to this update,
unikernels builds are becoming easier and faster in the MirageOS
universe! This also opens the door for a better cross-compilation
story, which will ease the addition of new MirageOS backends
(trustzone, ESP32, RISC-V, etc.)</p>
<p><em>This post has also been posted to the
<a href="https://dune.build/blog/dune-1-9-0/">Dune blog</a>.  See also the <a href="https://discuss.ocaml.org/t/ann-dune-1-9-0/3646">the discuss
forum</a> for more
details.</em></p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#dune-190" aria-label="dune 190 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dune 1.9.0</h1>
<p>Changes include:</p>
<ul>
<li>Coloring in the watch mode (<a href="https://github.com/ocaml/dune/pull/1956">#1956</a>)</li>
<li><code>$ dune init</code> command to create or update project boilerplate (<a href="https://github.com/ocaml/dune/pull/1448">#1448</a>)</li>
<li>Allow &quot;.&quot; in c_names and cxx_names (<a href="https://github.com/ocaml/dune/pull/2036">#2036</a>)</li>
<li>Experimental Coq support</li>
<li>Support for library variants and default implementations (<a href="https://github.com/ocaml/dune/pull/1900">#1900</a>)</li>
</ul>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#variants" aria-label="variants permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Variants</h1>
<p>In dune 1.7.0, the concept of virtual library was introduced:
<a href="https://dune.build/blog/virtual-libraries/">https://dune.build/blog/virtual-libraries/</a>. This feature allows to
mark some abstract library as virtual, and then have several
implementations for it. These implementations could be for multiple
targets (<code>unix</code>, <code>xen</code>, <code>js</code>), using different algorithms, using C
code or not. However each implementation in a project dependency tree
had to be manually selected. Dune 1.9.0 introduces features for
automatic selection of implementations.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#library-variants" aria-label="library variants permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Library variants</h2>
<p>Variants is a tagging mechanism to select implementations on the final
linking step. There's not much to add to make your implementation use
variants. For example, you could decide to design a <code>bar_js</code> library
which is the javascript implementation of <code>bar</code>, a virtual
library. All you need to do is specificy a <code>js</code> tag using the
<code>variant</code> option.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(library
 (name bar_js)
 (implements bar)
 (variant js)); &lt;-- variant specification</code></pre></div>
<p>Now any executable that depend on <code>bar</code> can automatically select the
<code>bar_js</code> library variant using the <code>variants</code> option in the dune file.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(executable
 (name foo)
 (libraries bar baz)
 (variants js)); &lt;-- variants selection</code></pre></div>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#common-variants" aria-label="common variants permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Common variants</h2>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#language-selection" aria-label="language selection permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Language selection</h3>
<p>In your projects you might want to trade off speed for portability:</p>
<ul>
<li><code>ocaml</code>: pure OCaml</li>
<li><code>c</code>: OCaml accelerated by C</li>
</ul>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#javascript-backend" aria-label="javascript backend permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript backend</h3>
<ul>
<li><code>js</code>: code aiming for a Node backend, using <code>Js_of_ocaml</code></li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#mirage-backends" aria-label="mirage backends permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mirage backends</h2>
<p>The Mirage project (<a href="https://mirage.io/">mirage.io</a>) will make
extensive use of this feature in order to select the appropriate
dependencies according to the selected backend.</p>
<ul>
<li><code>unix</code>: Unikernels as Unix applications, running on top of <code>mirage-unix</code></li>
<li><code>xen</code>: Xen backend, on top of <code>mirage-xen</code></li>
<li><code>freestanding</code>: Freestanding backend, on top of <code>mirage-solo5</code></li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#default-implementation" aria-label="default implementation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Default implementation</h2>
<p>To facilitate the transition from normal libraries into virtuals ones,
it's possible to specify an implementation that is selected by
default. This default implementation is selected if no implementation
is chosen after variant resolution.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(library
 (name bar)
 (virtual_modules hello)
 (default_implementation bar_unix)); &lt;-- default implementation selection</code></pre></div>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#selection-mechanism" aria-label="selection mechanism permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Selection mechanism</h2>
<p>Implementation is done with respect to some priority rules:</p>
<ul>
<li>manual selection of an implementation overrides everything</li>
<li>after that comes selection by variants</li>
<li>finally unimplemented virtual libraries can select their default implementation</li>
</ul>
<p>Libraries may depend on specific implementations but this is not
recommended. In this case, several things can happen:</p>
<ul>
<li>the implementation conflicts with a manually selected implementation: resolution fails.</li>
<li>the implementation overrides variants and default implementations: a cycle check is done and this either resolves or fails.</li>
</ul>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>Variant libraries and default implementations are fully <a href="https://dune.readthedocs.io/en/latest/variants.html">documented
here</a>. This
feature improves the usability of virtual libraries.</p>
<p>This
<a href="https://github.com/dune-universe/mirage-entropy/commit/576d25d79e3117bba64355ae73597651cfd27631">commit</a>
shows the amount of changes needed to make a virtual library use
variants.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#coq-support" aria-label="coq support permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Coq support</h1>
<p>Dune now supports building Coq projects. To enable the experimental Coq
extension, add <code>(using coq 0.1)</code> to your <code>dune-project</code> file. Then,
you can use the <code>(coqlib ...)</code> stanza to declare Coq libraries.</p>
<p>A typical <code>dune</code> file for a Coq project will look like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(include_subdirs qualified) ; Use if your development is based on sub directories

(coqlib
  (name Equations)                  ; Name of wrapper module
  (public_name equations.Equations) ; Generate an .install file
  (synopsis &quot;Equations Plugin&quot;)     ; Synopsis
  (libraries equations.plugin)      ; ML dependencies (for plugins)
  (modules :standard \\ IdDec)       ; modules to build
  (flags -w -notation-override))    ; coqc flags</code></pre></div>
<p>See the <a href="https://github.com/ocaml/dune/blob/1.9/doc/coq.rst">documentation of the
extension</a> for more
details.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#credits" aria-label="credits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h1>
<p>This release also contains many other changes and bug fixes that can
be found on the <a href="https://discuss.ocaml.org/t/ann-dune-1-9-0/3646">discuss
announce</a>.</p>
<p>Special thanks to dune maintainers and contributors for this release:
<a href="https://github.com/rgrinberg">@rgrinberg</a>,
<a href="https://github.com/emillon">@emillon</a>,
<a href="https://github.com/shonfeder">@shonfeder</a>
and <a href="https://github.com/ejgallego">@ejgallego</a>!</p>|js}
  };
 
  { title = {js|Release of OCamlFormat 0.9|js}
  ; slug = {js|release-of-ocamlformat-09|js}
  ; description = Some {js|We are pleased to announce the release of OCamlFormat (available on opam).
There have been numerous changes since the last release,
so here…|js}
  ; url = {js|https://tarides.com/blog/2019-03-29-release-of-ocamlformat-0-9|js}
  ; date = {js|2019-03-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/b0a6eda566f64c66aa1761737cf3ea4a/0132d/ceiling-arches.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are pleased to announce the release of OCamlFormat (available on opam).
There have been numerous changes since the last release,
so here is a comprehensive list of the new features and breaking changes to help the transition from OCamlFormat 0.8.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#additional-dependencies" aria-label="additional dependencies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Additional dependencies</h1>
<p>OCamlFormat now requires:</p>
<ul>
<li>ocaml &gt;= 4.06 (up from 4.04.1)</li>
<li>dune &gt;= 1.1.1</li>
<li>octavius &gt;= 1.2.0</li>
<li>uutf</li>
</ul>
<p>OCamlFormat_Reason now requires:</p>
<ul>
<li>ocaml &gt;= 4.06</li>
<li>dune &gt;= 1.1.1</li>
<li>ocaml-migrate-parsetree &gt;= 1.0.10 (up from 1.0.6)</li>
<li>octavius &gt;= 1.2.0</li>
<li>uutf</li>
<li>reason &gt;= 3.2.0 (up from 1.13.4)</li>
</ul>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#new-preset-profiles" aria-label="new preset profiles permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New preset profiles</h1>
<p>The <code>ocamlformat</code> profile aims to take advantage of the strengths of a parsetree-based auto-formatter,
and to limit the consequences of the weaknesses imposed by the current implementation.
This is a style which optimizes for what the formatter can do best, rather than to match the style of any existing code.
General guidelines that have directed the design include:</p>
<ul>
<li>Legibility, in the sense of making it as hard as possible for quick visual parsing to give the wrong interpretation,
is of highest priority;</li>
<li>Whenever possible the high-level structure of the code should be obvious by looking only at the left margin,
in particular, it should not be necessary to visually jump from left to right hunting for critical keywords, tokens, etc;</li>
<li>All else equal compact code is preferred as reading without scrolling is easier,
so indentation or white space is avoided unless it helps legibility;</li>
<li>Attention has been given to making some syntactic gotchas visually obvious.</li>
</ul>
<p><code>ocamlformat</code> is the new default profile.</p>
<p>The <code>conventional</code> profile aims to be as familiar and &quot;conventional&quot; appearing as the available options allow.</p>
<p>The <code>default</code> profile is <code>ocamlformat</code> with <code>break-cases=fit</code>.
<code>default</code> is deprecated and will be removed in version 0.10.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#ocamlformat-diff-tool" aria-label="ocamlformat diff tool permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OCamlFormat diff tool</h1>
<p><code>ocamlformat-diff</code> is a tool that uses OCamlFormat to apply the same formatting to compared OCaml files,
so that the formatting differences between the two files are not displayed.
Note that <code>ocamlformat-diff</code> comes in a separate opam package and is not included in the <code>ocamlformat</code> package.</p>
<p>The file comparison is then performed by any diff backend.</p>
<p>The options' documentation is available through <code>ocamlformat-diff --help</code>.</p>
<p>The option <code>--diff</code> allows you to configure the diff command that is used to compare the formatted files.
The default value is the vanilla <code>diff</code>, but you can also use <code>patdiff</code> or any other similar comparison tool.</p>
<p><code>ocamlformat-diff</code> can be integrated with <code>git diff</code>,
as explained in the <a href="https://github.com/ocaml-ppx/ocamlformat/blob/0.9/tools/ocamlformat-diff/README.md">online documentation</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#formatting-docstrings" aria-label="formatting docstrings permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Formatting docstrings</h1>
<p>Previously, the docstrings <code>(** This is a docstring *)</code> could only be formatted like regular comments,
a new option <code>--parse-docstrings</code> has been added so that docstrings can be nicely formatted.</p>
<p>Here is a small example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(** {1 Printers and escapes used by Cmdliner module} *)</span>

<span class="token keyword">val</span> subst_vars <span class="token punctuation">:</span> subst<span class="token punctuation">:</span><span class="token punctuation">(</span>string <span class="token operator">-&gt;</span> string option<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token module variable">Buffer</span><span class="token punctuation">.</span>t <span class="token operator">-&gt;</span> string <span class="token operator">-&gt;</span> string
<span class="token comment">(** [subst b ~subst s], using [b], substitutes in [s] variables of the form
    &quot;$(doc)&quot; by their [subst] definition. This leaves escapes and markup
    directives $(markup,...) intact.
    @raise Invalid_argument in case of illegal syntax. *)</span></code></pre></div>
<p>Note that this option is disabled by default and you have to set it manually by adding <code>--parse-docstrings</code> to your command line
or <code>parse-docstrings=true</code> to your <code>.ocamlformat</code> file.
If you get the following error message:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Error: Formatting of (** ... *) is unstable (e.g. parses as a list or not depending on the margin), please tighten up this comment in the source or disable the formatting using the option --no-parse-docstrings.</code></pre></div>
<p>It means the original docstring cannot be formatted (e.g. because it does not comply with the odoc syntax)
and you have to edit it or disable the formatting of docstrings.</p>
<p>Of course if you think your docstring complies with the odoc syntax and there might be a bug in OCamlFormat,
<a href="https://github.com/ocaml-ppx/ocamlformat/issues">feel free to file an issue on github</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#print-the-configuration" aria-label="print the configuration permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Print the configuration</h1>
<p>The new <code>--print-config</code> flag prints the configuration determined by the environment variable,
the configuration files, preset profiles and command line. Attributes are not considered.</p>
<p>It provides the full list of options with the values they are set to, and the source of this value.
For example <code>ocamlformat --print-config</code> prints:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">profile=ocamlformat (file .ocamlformat:1)
quiet=false (profile ocamlformat (file .ocamlformat:1))
max-iters=10 (profile ocamlformat (file .ocamlformat:1))
comment-check=true (profile ocamlformat (file .ocamlformat:1))
wrap-fun-args=true (profile ocamlformat (file .ocamlformat:1))
wrap-comments=true (file .ocamlformat:5)
type-decl=compact (profile ocamlformat (file .ocamlformat:1))
space-around-collection-expressions=false (profile ocamlformat (file .ocamlformat:1))
single-case=compact (profile ocamlformat (file .ocamlformat:1))
sequence-style=separator (profile ocamlformat (file .ocamlformat:1))
parse-docstrings=true (file .ocamlformat:4)
parens-tuple-patterns=multi-line-only (profile ocamlformat (file .ocamlformat:1))
parens-tuple=always (profile ocamlformat (file .ocamlformat:1))
parens-ite=false (profile ocamlformat (file .ocamlformat:1))
ocp-indent-compat=false (profile ocamlformat (file .ocamlformat:1))
module-item-spacing=sparse (profile ocamlformat (file .ocamlformat:1))
margin=77 (file .ocamlformat:3)
let-open=preserve (profile ocamlformat (file .ocamlformat:1))
let-binding-spacing=compact (profile ocamlformat (file .ocamlformat:1))
let-and=compact (profile ocamlformat (file .ocamlformat:1))
leading-nested-match-parens=false (profile ocamlformat (file .ocamlformat:1))
infix-precedence=indent (profile ocamlformat (file .ocamlformat:1))
indicate-nested-or-patterns=space (profile ocamlformat (file .ocamlformat:1))
indicate-multiline-delimiters=true (profile ocamlformat (file .ocamlformat:1))
if-then-else=compact (profile ocamlformat (file .ocamlformat:1))
field-space=tight (profile ocamlformat (file .ocamlformat:1))
extension-sugar=preserve (profile ocamlformat (file .ocamlformat:1))
escape-strings=preserve (profile ocamlformat (file .ocamlformat:1))
escape-chars=preserve (profile ocamlformat (file .ocamlformat:1))
doc-comments-tag-only=default (profile ocamlformat (file .ocamlformat:1))
doc-comments-padding=2 (profile ocamlformat (file .ocamlformat:1))
doc-comments=after (profile ocamlformat (file .ocamlformat:1))
disable=false (profile ocamlformat (file .ocamlformat:1))
cases-exp-indent=4 (profile ocamlformat (file .ocamlformat:1))
break-struct=force (profile ocamlformat (file .ocamlformat:1))
break-string-literals=wrap (profile ocamlformat (file .ocamlformat:1))
break-sequences=false (profile ocamlformat (file .ocamlformat:1))
break-separators=before (profile ocamlformat (file .ocamlformat:1))
break-infix-before-func=true (profile ocamlformat (file .ocamlformat:1))
break-infix=wrap (profile ocamlformat (file .ocamlformat:1))
break-fun-decl=wrap (profile ocamlformat (file .ocamlformat:1))
break-collection-expressions=fit-or-vertical (profile ocamlformat (file .ocamlformat:1))
break-cases=fit (file .ocamlformat:2)</code></pre></div>
<p>If many input files are specified, only print the configuration for the first file.
If no input file is specified, print the configuration for the root directory if specified,
or for the current working directory otherwise.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#parentheses-around-if-then-else-branches" aria-label="parentheses around if then else branches permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parentheses around if-then-else branches</h1>
<p>A new option <code>parens-ite</code> has been added to decide whether to use parentheses
around if-then-else branches that spread across multiple lines.</p>
<p>If this option is set, the following function:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token keyword">rec</span> loop count a <span class="token operator">=</span>
  <span class="token keyword">if</span> count <span class="token operator">&gt;=</span> self#len
  <span class="token keyword">then</span> a
  <span class="token keyword">else</span>
    <span class="token keyword">let</span> a' <span class="token operator">=</span> f cur#get count a <span class="token keyword">in</span>
    cur#incr <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> a'</code></pre></div>
<p>will be formatted as:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token keyword">rec</span> loop count a <span class="token operator">=</span>
  <span class="token keyword">if</span> count <span class="token operator">&gt;=</span> self#len
  <span class="token keyword">then</span> a
  <span class="token keyword">else</span> <span class="token punctuation">(</span>
    <span class="token keyword">let</span> a' <span class="token operator">=</span> f cur#get count a <span class="token keyword">in</span>
    cur#incr <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> a' <span class="token punctuation">)</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#parentheses-around-tuple-patterns" aria-label="parentheses around tuple patterns permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parentheses around tuple patterns</h1>
<p>A new option <code>parens-tuple-patterns</code> has been added, that mimics <code>parens-tuple</code> but only applies to patterns,
whereas <code>parens-tuples</code> only applies to expressions.
<code>parens-tuple-patterns=multi-line-only</code> mode will try to skip parentheses for single-line tuple patterns,
this is the default value.
<code>parens-tuple-patterns=always</code> always uses parentheses around tuples patterns.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with parens-tuple-patterns=always *)</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment">(* with parens-tuple-patterns=multi-line-only *)</span>
<span class="token keyword">let</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#single-case-pattern-matching-expressions" aria-label="single case pattern matching expressions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Single-case pattern-matching expressions</h1>
<p>The new option <code>single-case</code> defines the style of pattern-matching expressions with only a single case.
<code>single-case=compact</code> will try to format a single case on a single line, this is the default value.
<code>single-case=sparse</code> will always break the line before a single case.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with single-case=compact *)</span>
<span class="token keyword">try</span> some_irrelevant_expression
<span class="token keyword">with</span> <span class="token module variable">Undefined_recursive_module</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span>

<span class="token comment">(* with single-case=sparse *)</span>
<span class="token keyword">try</span> some_irrelevant_expression
<span class="token keyword">with</span>
<span class="token operator">|</span> <span class="token module variable">Undefined_recursive_module</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#space-around-collection-expressions" aria-label="space around collection expressions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Space around collection expressions</h1>
<p>The new option <code>space-around-collection-expressions</code> decides whether to add a space
inside the delimiters of collection expressions (lists, arrays, records).</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* by default *)</span>
<span class="token keyword">type</span> wkind <span class="token operator">=</span> <span class="token punctuation">{</span>f <span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">.</span> <span class="token type-variable function">'a</span> tag <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> kind<span class="token punctuation">}</span>
<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;Nil&quot;</span><span class="token punctuation">,</span> <span class="token module variable">TCnoarg</span> <span class="token module variable">Thd</span><span class="token punctuation">;</span> <span class="token string">&quot;Cons&quot;</span><span class="token punctuation">,</span> <span class="token module variable">TCarg</span> <span class="token punctuation">(</span><span class="token module variable">Ttl</span> <span class="token module variable">Thd</span><span class="token punctuation">,</span> tcons<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment">(* with space-around-collection-expressions *)</span>
<span class="token keyword">type</span> wkind <span class="token operator">=</span> <span class="token punctuation">{</span> f <span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">.</span> <span class="token type-variable function">'a</span> tag <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> kind <span class="token punctuation">}</span>
<span class="token keyword">let</span> l <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">&quot;Nil&quot;</span><span class="token punctuation">,</span> <span class="token module variable">TCnoarg</span> <span class="token module variable">Thd</span><span class="token punctuation">;</span> <span class="token string">&quot;Cons&quot;</span><span class="token punctuation">,</span> <span class="token module variable">TCarg</span> <span class="token punctuation">(</span><span class="token module variable">Ttl</span> <span class="token module variable">Thd</span><span class="token punctuation">,</span> tcons<span class="token punctuation">)</span> <span class="token punctuation">]</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#break-separators" aria-label="break separators permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Break separators</h1>
<p>The new option <code>break-separators</code> decides whether to break before or after separators such as <code>;</code> in list or record expressions,
<code>*</code> in tuples or <code>-&gt;</code> in arrow types.
<code>break-separators=before</code> breaks the expressions before the separator, this is the default value.
<code>break-separators=after</code> breaks the expressions after the separator.
<code>break-separators=after-and-docked</code> breaks the expressions after the separator and docks the brackets for records.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with break-separators=before *)</span>
<span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> foooooooooooooooooooooooo<span class="token punctuation">:</span> foooooooooooooooooooooooooooooooooooooooo
  <span class="token punctuation">;</span> fooooooooooooooooooooooooooooo<span class="token punctuation">:</span> fooooooooooooooooooooooooooo <span class="token punctuation">}</span>

<span class="token comment">(* with break-separators=after *)</span>
<span class="token keyword">type</span> t <span class="token operator">=</span>
  <span class="token punctuation">{</span> foooooooooooooooooooooooo<span class="token punctuation">:</span> foooooooooooooooooooooooooooooooooooooooo<span class="token punctuation">;</span>
    fooooooooooooooooooooooooooooo<span class="token punctuation">:</span> fooooooooooooooooooooooooooo <span class="token punctuation">}</span>

<span class="token comment">(* with break-separators=after-and-docked *)</span>
<span class="token keyword">type</span> t <span class="token operator">=</span> <span class="token punctuation">{</span>
  foooooooooooooooooooooooo<span class="token punctuation">:</span> foooooooooooooooooooooooooooooooooooooooo<span class="token punctuation">;</span>
  fooooooooooooooooooooooooooooo<span class="token punctuation">:</span> fooooooooooooooooooooooooooo
<span class="token punctuation">}</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#not-breaking-before-bindmap-operators" aria-label="not breaking before bindmap operators permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Not breaking before bind/map operators</h1>
<p>The new option <code>break-infix-before-func</code> decides whether to break infix operators
whose right arguments are anonymous functions specially.
This option is set by default, if you disable it with <code>--no-break-infix-before-func</code>,
it will not break before the operator so that the first line of the function appears docked at the end of line after the operator.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* by default *)</span>
f x
<span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span>
g y
<span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
f x <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span> g y <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> f x <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span> g y <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> y <span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">(* with break-infix-before-func = false *)</span>
f x <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span>
g y <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
f x <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span> g y <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> f x <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> y <span class="token operator">-&gt;</span> g y <span class="token operator">&gt;&gt;=</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> y <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#break-toplevel-cases" aria-label="break toplevel cases permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Break toplevel cases</h1>
<p>There is a new value for the <code>break-cases</code> option: <code>toplevel</code>,
that forces top-level cases (i.e. not nested or-patterns) to break across lines,
otherwise breaks naturally at the margin.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> f <span class="token operator">=</span>
  <span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token keyword">function</span>
    <span class="token operator">|</span> H <span class="token keyword">when</span> x y <span class="token operator">&lt;&gt;</span> k <span class="token operator">-&gt;</span> <span class="token number">2</span>
    <span class="token operator">|</span> T <span class="token operator">|</span> P <span class="token operator">|</span> U <span class="token operator">-&gt;</span> <span class="token number">3</span>
  <span class="token keyword">in</span>
  <span class="token keyword">fun</span> x g t h y u <span class="token operator">-&gt;</span>
    <span class="token keyword">match</span> x <span class="token keyword">with</span>
    <span class="token operator">|</span> E <span class="token operator">-&gt;</span> <span class="token number">4</span>
    <span class="token operator">|</span> Z <span class="token operator">|</span> P <span class="token operator">|</span> M <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>
      <span class="token keyword">match</span> y <span class="token keyword">with</span>
      <span class="token operator">|</span> O <span class="token operator">-&gt;</span> <span class="token number">5</span>
      <span class="token operator">|</span> P <span class="token keyword">when</span> h x <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>
          <span class="token keyword">function</span>
          <span class="token operator">|</span> A <span class="token operator">-&gt;</span> <span class="token number">6</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#number-of-spaces-before-docstrings" aria-label="number of spaces before docstrings permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Number of spaces before docstrings</h1>
<p>The new option <code>doc-comments-padding</code> controls how many spaces are printed before doc comments in type declarations.
The default value is 2.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with doc-comments-padding = 2 *)</span>
<span class="token keyword">type</span> t <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> int  <span class="token comment">(** a *)</span><span class="token punctuation">;</span> b<span class="token punctuation">:</span> int  <span class="token comment">(** b *)</span><span class="token punctuation">}</span>

<span class="token comment">(* with doc-comments-padding = 1 *)</span>
<span class="token keyword">type</span> t <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> int <span class="token comment">(** a *)</span><span class="token punctuation">;</span> b<span class="token punctuation">:</span> int <span class="token comment">(** b *)</span><span class="token punctuation">}</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#ignore-files" aria-label="ignore files permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ignore files</h1>
<p>An <code>.ocamlformat-ignore</code> file specifies files that OCamlFormat should ignore.
Each line in an <code>.ocamlformat-ignore</code> file specifies a filename relative to the directory containing the <code>.ocamlformat-ignore</code> file.
Lines starting with <code>#</code> are ignored and can be used as comments.</p>
<p>Here is an example of such <code>.ocamlformat-ignore</code> file:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">#This is a comment
dir2/ignore_1.ml</code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#tag-only-docstrings" aria-label="tag only docstrings permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tag-only docstrings</h1>
<p>The new option <code>doc-comments-tag-only</code> controls the position of doc comments only containing tags.
<code>doc-comments-tag-only=default</code> means no special treatment is done, this is the default value.
<code>doc-comments-tag-only=fit</code> puts doc comments on the same line if it fits.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with doc-comments-tag-only = default *)</span>

<span class="token comment">(** @deprecated  *)</span>
<span class="token keyword">open</span> <span class="token module variable">Module</span>

<span class="token comment">(* with doc-comments-tag-only = fit *)</span>

<span class="token keyword">open</span> <span class="token module variable">Module</span> <span class="token comment">(** @deprecated  *)</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#fit-or-vertical-mode-for-if-then-else" aria-label="fit or vertical mode for if then else permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fit or vertical mode for if-then-else</h1>
<p>There is a new value for the option <code>if-then-else</code>: <code>fit-or-vertical</code>.
<code>fit-or-vertical</code> vertically breaks all branches if they do not fit on a single line.
Compared to the <code>compact</code> (default) value, it breaks all branches if at least one of them does not fit on a single line.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with if-then-else = compact *)</span>
<span class="token keyword">let</span> <span class="token punctuation">_</span> <span class="token operator">=</span>
  <span class="token keyword">if</span> foo <span class="token keyword">then</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">in</span>
    a <span class="token operator">+</span> b
  <span class="token keyword">else</span> <span class="token keyword">if</span> foo <span class="token keyword">then</span> <span class="token number">12</span>
  <span class="token keyword">else</span> <span class="token number">0</span>

<span class="token comment">(* with if-then-else = fit-or-vertical *)</span>
<span class="token keyword">let</span> <span class="token punctuation">_</span> <span class="token operator">=</span>
  <span class="token keyword">if</span> foo <span class="token keyword">then</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">in</span>
    a <span class="token operator">+</span> b
  <span class="token keyword">else</span> <span class="token keyword">if</span> foo <span class="token keyword">then</span>
    <span class="token number">12</span>
  <span class="token keyword">else</span>
    <span class="token number">0</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#check-mode" aria-label="check mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check mode</h1>
<p>A new <code>--check</code> flag has been added.
It checks whether the input files already are formatted.
This flag is mutually exclusive with <code>--inplace</code> and <code>--output</code>.
It returns <code>0</code> if the input files are indeed already formatted, or <code>1</code> otherwise.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#break-function-declarations" aria-label="break function declarations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Break function declarations</h1>
<p>The new option <code>break-fun-decl</code> controls the style for function declarations and types.
<code>break-fun-decl=wrap</code> breaks only if necessary, this is the default value.
<code>break-fun-decl=fit-or-vertical</code> vertically breaks arguments if they do not fit on a single line.
<code>break-fun-decl=smart</code> is like <code>fit-or-vertical</code> but try to fit arguments on their line if they fit.
The <code>wrap-fun-args</code> option now only controls the style for function calls, and no more for function declarations.</p>
<p>For example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* with break-fun-decl = wrap *)</span>
<span class="token keyword">let</span> ffffffffffffffffffff aaaaaaaaaaaaaaaaaaaaaa bbbbbbbbbbbbbbbbbbbbbb
    cccccccccccccccccccccc <span class="token operator">=</span>
  g

<span class="token comment">(* with break-fun-decl = fit-or-vertical *)</span>
<span class="token keyword">let</span> ffffffffffffffffffff
    aaaaaaaaaaaaaaaaaaaaaa
    bbbbbbbbbbbbbbbbbbbbbb
    cccccccccccccccccccccc <span class="token operator">=</span>
  g

<span class="token comment">(* with break-fun-decl = smart *)</span>
<span class="token keyword">let</span> ffffffffffffffffffff
    aaaaaaaaaaaaaaaaaaaaaa bbbbbbbbbbbbbbbbbbbbbb cccccccccccccccccccccc <span class="token operator">=</span>
  g</code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#disable-configuration-in-files-and-attributes" aria-label="disable configuration in files and attributes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Disable configuration in files and attributes</h1>
<p>Two new options have been added so that <code>.ocamlformat</code> configuration files and attributes in OCaml files do not change the
configuration.
These options can be useful if you use some preset profile
and you do not want attributes and <code>.ocamlformat</code> files to interfere with your preset configuration.
<code>--disable-conf-attrs</code> disables the configuration in attributes,
and <code>--disable-conf-files</code> disables <code>.ocamlformat</code> configuration files.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#preserve-module-items-spacing" aria-label="preserve module items spacing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preserve module items spacing</h1>
<p>There is a new value for the option <code>module-item-spacing</code>: <code>preserve</code>,
that will not leave open lines between one-liners of similar sorts unless there is an open line in the input.</p>
<p>For example the line breaks are preserved in the following code:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> cmos_rtc_seconds <span class="token operator">=</span> <span class="token number">0x00</span>
<span class="token keyword">let</span> cmos_rtc_seconds_alarm <span class="token operator">=</span> <span class="token number">0x01</span>
<span class="token keyword">let</span> cmos_rtc_minutes <span class="token operator">=</span> <span class="token number">0x02</span>

<span class="token keyword">let</span> x <span class="token operator">=</span> o

<span class="token keyword">let</span> log_other <span class="token operator">=</span> <span class="token number">0x000001</span>
<span class="token keyword">let</span> log_cpu <span class="token operator">=</span> <span class="token number">0x000002</span>
<span class="token keyword">let</span> log_fpu <span class="token operator">=</span> <span class="token number">0x000004</span></code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#breaking-changes" aria-label="breaking changes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Breaking changes</h1>
<ul>
<li>When <code>--disable-outside-detected-project</code> is set, disable ocamlformat when no <code>.ocamlformat</code> file is found.</li>
<li>Files are not parsed when ocamlformat is disabled.</li>
<li>Disallow <code>-</code> with other input files.</li>
<li>The <code>wrap-fun-args</code> option now only controls the style for function calls, and no more for function declarations.</li>
<li>The default profile is now named <code>ocamlformat</code>.</li>
<li>The deprecated syntax for <code>.ocamlformat</code> files: <code>option value</code> is no more supported anymore and you should use the <code>option = value</code> syntax instead.</li>
</ul>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#miscellaneous-bugfixes" aria-label="miscellaneous bugfixes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Miscellaneous bugfixes</h1>
<ul>
<li>Preserve shebang (e.g. <code>#!/usr/bin/env ocaml</code>) at the beginning of a file.</li>
<li>Improve the formatting when <code>ocp-indent-compat</code> is set.</li>
<li>UTF8 characters are now correctly printed in comments.</li>
<li>Add parentheses around a constrained any-pattern (e.g. <code>let (_ : int) = x1</code>).</li>
<li>Emacs: the temporary buffer is now killed.</li>
<li>Emacs: add the keybinding in tuareg's map instead of merlin's.</li>
<li>Lots of improvements on the comments, docstrings, attributes formatting.</li>
<li>Lots of improvements on the formatting of modules.</li>
<li>Lots of improvements in the Reason support.</li>
<li>Do not rely on the file-system to format sources.</li>
<li>The <code>--debug</code> mode is more user-friendly.</li>
</ul>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#credits" aria-label="credits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h1>
<p>This release also contains many other changes and bug fixes that we cannot detail here.</p>
<p>Special thanks to our maintainers and contributors for this release: Jules Aguillon, Mathieu Barbin, Josh Berdine, J&eacute;r&eacute;mie Dimino, Hugo Heuzard, Ludwig Pacifici, Guillaume Petiot, Nathan Rebours and Louis Roch&eacute;.</p>
<p>If you wish to get involved with OCamlFormat development or file an issue,
please read the <a href="https://github.com/ocaml-ppx/ocamlformat/blob/master/CONTRIBUTING.md">contributing guide</a>,
any contribution is welcomed.</p>|js}
  };
 
  { title = {js|Machining the ultimate hackathon prize|js}
  ; slug = {js|machining-the-ultimate-hackathon-prize|js}
  ; description = Some {js|Jane Street is sponsoring this year’s MakeMIThackathon, and we wanted to create a prize forthe winners that would do justice to the maker spirit of thecompet...|js}
  ; url = {js|https://blog.janestreet.com/hackathon-keyboards/|js}
  ; date = {js|2019-02-28T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/hackathon-keyboards/keyboard.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street is sponsoring this year&rsquo;s <a href="https://makemit.org">MakeMIT
hackathon</a>, and we wanted to create a prize for
the winners that would do justice to the maker spirit of the
competition. As makers ourselves &ndash; it&rsquo;s not unusual to find a
&ldquo;software&rdquo; engineer here who hacks on FPGAs or who has a CNC machine
at home &ndash; it felt natural to get our hands dirty.</p>|js}
  };
 
  { title = {js|Accelerating Self-Play Learning in Go|js}
  ; slug = {js|accelerating-self-play-learning-in-go|js}
  ; description = Some {js|At Jane Street, over the last few years, we’ve been increasingly exploring machine learning to improve our models. Many of us are fascinated by the rapid imp...|js}
  ; url = {js|https://blog.janestreet.com/accelerating-self-play-learning-in-go/|js}
  ; date = {js|2019-02-28T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/accelerating-self-play-learning-in-go/go.jpg|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, over the last few years, we&rsquo;ve been increasingly exploring machine learning to improve our models. Many of us are fascinated by the rapid improvement we see in a wide variety of applications due to developments in deep learning and reinforcement learning, both for its exciting potential for our own problems, and also on a personal level of pure interest and curiosity outside of work.</p>|js}
  };
 
  { title = {js|Release of Base64|js}
  ; slug = {js|release-of-base64|js}
  ; description = Some {js|MirageOS is a library operating system written from the ground up in OCaml.
It has an impossible and incredibly huge goal to re-implement…|js}
  ; url = {js|https://tarides.com/blog/2019-02-08-release-of-base64|js}
  ; date = {js|2019-02-08T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/50a0344945c9df2a67b60ef32ee43a0f/0132d/mailboxes.jpg|js}
  ; featured = false
  ; body_html = {js|<p>MirageOS is a library operating system written from the ground up in OCaml.
It has an impossible and incredibly huge goal to re-implement all of the
world! Looking back at the work accomplished by the MirageOS team, it appears that's
what happened for several years. Re-implementing the entire stack, in particular
the lower layers that we often take for granted, requires a great attention to
detail. While it may seem reasonably easy to implement a given RFC, a huge
amount of work is often hidden under the surface.</p>
<p>In this article, we will explain the development process we went through, as we
updated a small part of the MirageOS stack: the library <code>ocaml-base64</code>. It's a
suitable example as the library is small (few hundreds lines of code), but it
needs ongoing development to ensure good quality and to be able to trust it for
higher level libraries (like <a href="https://github.com/mirage/mrmime">mrmime</a>).</p>
<p>Updating the library was instigated by a problem I ran into with the existing
base64 implementation while working on the e-mail stack. Indeed, we got some
errors when we tried to compute an <em>encoded-word</em> according to the <a href="https://www.ietf.org/rfc/rfc2047.txt">RFC
2047</a>. So after several years of not being touched, we decided to
update <a href="https://github.com/mirage/ocaml-base64"><code>ocaml-base64</code></a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#the-critique-of-pure-reason" aria-label="the critique of pure reason permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Critique of Pure Reason</h1>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-first-problem" aria-label="the first problem permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The first problem</h2>
<p>We started by attempting to use <code>ocaml-base64</code> on some examples extracted from
actual e-mails, and we quickly ran into cases where the library failed. This
highlighted that reality is much more complex than you can imagine from reading
an RFC. In this situation, what do you do: try to implement a best-effort
strategy and continue parsing? Or stick to the letter of the RFC and fail? In
the context of e-mails, which has accumulated a lot of baggage over time, you
cannot get around implementing a best-effort strategy.</p>
<p>The particular error we were seeing was a <code>Not_found</code> exception when decoding an
<em>encoded-word</em>. This exception appeared because the implementation relied on
<code>String.contains</code>, and the input contained a character which was not part of the
base64 alphabet.</p>
<p>This was the first reason why we thought it necessary to rewrite <code>ocaml-base64</code>.
Of course, we could just catch the exception and continue the initial
computation, but then another reason appeared.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-second-problem" aria-label="the second problem permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The second problem</h2>
<p>As <a href="https://github.com/clecat">@clecat</a> and I reviewed RFC 2045, we noticed the
following requirement:</p>
<blockquote>
<p>The encoded output stream must be represented in lines of no more than 76
characters each.</p>
<p>See RFC 2045, section 6.8</p>
</blockquote>
<p>Pretty specific, but general to e-mails, we should never have more than 78
characters per line according to <a href="https://www.ietf.org/rfc/rfc822.txt">RFC 822</a>, nor more than 998 characters
according to <a href="https://www.ietf.org/rfc/rfc2822.txt">RFC 2822</a>.</p>
<p>Having a decoder that abided RFC 2045 more closely, including the requirement
above, further spurred us to implement a new decoder.</p>
<p>As part of the new implementation, we decided to implement tests and fuzzers to
ensure correctness. This also had the benefit, that we could run the fuzzer on
the existing codebase. When fuzzing an encoder/decoder pair, an excellent check
is whether the following isomorphism holds:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> iso0 input <span class="token operator">=</span> <span class="token keyword">assert</span> <span class="token punctuation">(</span>decode <span class="token punctuation">(</span>encode input<span class="token punctuation">)</span> <span class="token operator">=</span> input<span class="token punctuation">)</span>
<span class="token keyword">let</span> iso1 input <span class="token operator">=</span> <span class="token keyword">assert</span> <span class="token punctuation">(</span>encode <span class="token punctuation">(</span>decode input<span class="token punctuation">)</span> <span class="token operator">=</span> input<span class="token punctuation">)</span></code></pre></div>
<p>However, at this point <a href="https://github.com/hannesm">@hannesm</a> ran into another error (see
<a href="https://github.com/mirage/ocaml-base64/issues/20">#20</a>).</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#the-third-problem" aria-label="the third problem permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The third problem</h2>
<p>We started to review the <a href="https://github.com/mirleft/ocaml-nocrypto"><code>nocrypto</code></a> implementation of base64, which
respects our requirements. We had some concerns about the performance of the
implementation though, so we decided to see if we would get a performance
regression by switching to this implementation.</p>
<p>A quick benchmark based on random input revealed the opposite, however!
<code>nocrypto</code>'s implementation was faster than <code>ocaml-base64</code>:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">ocaml-base64's implementation on bytes (length: 5000): 466 272.34ns
nocrypto's implementation on bytes (length: 5000): 137 406.04ns</code></pre></div>
<p>Based on all these observations, we thought there was sufficient reason to
reconsider the <code>ocaml-base64</code> implementation. It's also worth mentioning that
the last real release (excluding <code>dune</code>/<code>jbuilder</code>/<code>topkg</code> updates) is from Dec.
24 2014. So, it's pretty old code and the OCaml eco-system has improved a lot
since 2014.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#implementation--review" aria-label="implementation  review permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementation &amp; review</h1>
<p>We started integrating the <code>nocrypto</code> implementation. Of course, implementing
<a href="https://www.ietf.org/rfc/rfc4648.txt">RFC 4648</a> is not as easy as just reading examples and trying to do
something which works. The devil is in the detail.</p>
<p>@hannesm and <a href="https://github.com/cfcs">@cfcs</a> decided to do a big review of expected behavior
according to the RFC, and another about implementation and security issues.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#canonicalization" aria-label="canonicalization permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Canonicalization</h2>
<p>The biggest problem about RFC 4648 is regarding canonical inputs. Indeed, there
are cases where two different inputs are associated with the same value:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token string">&quot;Zm9vCg==&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">&quot;foo\\n&quot;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token string">&quot;Zm9vCh==&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">&quot;foo\\n&quot;</span></code></pre></div>
<p>This is mostly because the base64 format encodes the input 6 bits at a time. The
result is that 4 base64 encoded bytes are equal to 3 decoded bytes (<code>6 * 4 = 8 * 3</code>). Because of this, 2 base64 encoded bytes provide 1 byte plus 4 bits. What do
we need to do with these 4 bits? Nothing.</p>
<p>That's why the last character in our example can be something else than <code>g</code>. <code>g</code>
is the canonical byte to indicate using the 2 bits afterward the 6 bits
delivered by <code>C</code> (and make a byte - 8 bits). But <code>h</code> can be used where we just
need 2 bits at the end.</p>
<p>Due to this behavior, the check used for fuzzing changes: from a canonical
input, we should check isomorphism.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#invalid-character" aria-label="invalid character permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Invalid character</h2>
<p>As mentioned above (&quot;The first problem&quot;), how should invalid characters be
handled? This happens when decoding a byte which is not a part of the base64
alphabet. In the old version, <code>ocaml-base64</code> would simply leak a <code>Not_found</code>
exception from <code>String.contains</code>.</p>
<p>The MirageOS team has taken <a href="https://mirage.io/wiki/mirage-3.0-errors">a stance on exceptions</a>, which is
to &quot;use exceptions for exceptional conditions&quot; - invalid input is hardly one of
those. This is to avoid any exception leaks, as it can be really hard to track
the origin of an exception in a unikernel. Because of this, several packages
have been updated to return a <code>result</code> type instead, and we wanted the new
implementation to follow suit.</p>
<p>On the other hand, exceptions can be useful when considered as a more
constrained form of assembly jump. Of course, they break the control flow, but
from a performance point of view, it's interesting to use this trick:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">exception</span> <span class="token module variable">Found</span>

<span class="token keyword">let</span> contains str chr <span class="token operator">=</span>
  <span class="token keyword">let</span> idx <span class="token operator">=</span> ref <span class="token number">0</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token module variable">String</span><span class="token punctuation">.</span>length str <span class="token keyword">in</span>
  <span class="token keyword">try</span> <span class="token keyword">while</span> <span class="token operator">!</span>idx <span class="token operator">&lt;</span> len
      <span class="token keyword">do</span> <span class="token keyword">if</span> <span class="token module variable">String</span><span class="token punctuation">.</span>unsafe_get str <span class="token operator">!</span>idx <span class="token operator">=</span> chr <span class="token keyword">then</span> raise <span class="token module variable">Found</span> <span class="token punctuation">;</span> incr idx <span class="token keyword">done</span> <span class="token punctuation">;</span>
      <span class="token module variable">None</span>
  <span class="token keyword">with</span> <span class="token module variable">Found</span> <span class="token operator">-&gt;</span> <span class="token module variable">Some</span> <span class="token operator">!</span>idx</code></pre></div>
<p>This kind of code for example is ~20% faster than <code>String.contains</code>.</p>
<p>As such, exceptions can be a useful tool for performance optimizations, but we
need to be extra careful not to expose them to the users of the library. This
code needs to be hidden behind a fancy functional interface. With this in mind,
we should assert that our <code>decode</code> function never leaks an exception. We'll
describe how we've adressed this problem later.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#special-cases" aria-label="special cases permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Special cases</h2>
<p>RFC 4648 has some detailed cases and while we would sometimes like to work in a
perfect world where we will never need to deal with such errors, from our
experience, we cannot imagine what the end-user will do to formats, protocols
and such.</p>
<p>Even though the RFC has detailed examples, we have to read between lines to know
special cases and how to deal with them.</p>
<p>@hannesm noticed one of these cases, where padding (<code>=</code> sign at the end of
input) is not mandatory:</p>
<blockquote>
<p>The pad character &quot;=&quot; is typically percent-encoded when used in an URI [9],
but if the data length is known implicitly, this can be avoided by skipping
the padding; see section 3.2.</p>
<p>See RFC 4648, section 5</p>
</blockquote>
<p>That mostly means that the following kind of input can be valid:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token label function">~pad</span><span class="token punctuation">:</span><span class="token boolean">false</span> <span class="token string">&quot;Zm9vCg&quot;</span>
<span class="token operator">-</span> <span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">&quot;foo\\n&quot;</span></code></pre></div>
<p>It's only valid in a specific context though: when <em>length is known implicitly</em>.
Only the caller of <code>decode</code> can determine whether the length is implicitly known
such that padding can be omitted. To that end, we've added a new optional
argument <code>?pad</code> to the function <code>Base64.decode</code>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#allocation-sub-off-and-len" aria-label="allocation sub off and len permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Allocation, <code>sub</code>, <code>?off</code> and <code>?len</code></h2>
<p>Xavier Leroy has described the garbage collector in the following way:</p>
<blockquote>
<p>You see, the Caml garbage collector is like a god from ancient mythology:
mighty, but very irritable. If you mess with it, it'll make you suffer in
surprising ways.</p>
</blockquote>
<p>That's probably why my experience with improving the allocation policy of
(<code>ocaml-git</code>)<a href="https://github.com/mirage/ocaml-git">ocaml-git</a> was quite a nightmare. Allowing the user to control
allocation is important for efficiency, and we wanted to <code>ocaml-base64</code> to be a
good citizen.</p>
<p>At the beginning, <code>ocaml-base64</code> had a very simple API:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> decode <span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> string
<span class="token keyword">val</span> encode <span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> string</code></pre></div>
<p>This API forces allocations in two ways.</p>
<p>Firstly, if the caller needs to encode a part of a string, this part needs to be
extracted, e.g. using <code>String.sub</code>, which will allocate a new string. To avoid
this, two new optional arguments have been added to <code>encode</code>: <code>?off</code> and <code>?len</code>,
which specifies the substring to encode. Here's an example:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token comment">(* We want to encode the part 'foo' without prefix or suffix *)</span>

<span class="token comment">(* Old API -- forces allocation *)</span>
<span class="token module variable">Base64</span><span class="token punctuation">.</span>encode <span class="token punctuation">(</span><span class="token module variable">String</span><span class="token punctuation">.</span>sub <span class="token string">&quot;prefix foo suffix&quot;</span> <span class="token number">7</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">&quot;Zm9v&quot;</span>

<span class="token comment">(* New API -- avoids allocation *)</span>
<span class="token module variable">Base64</span><span class="token punctuation">.</span>encode <span class="token label function">~off</span><span class="token punctuation">:</span><span class="token number">7</span> <span class="token label function">~len</span><span class="token punctuation">:</span><span class="token number">3</span> <span class="token string">&quot;prefix foo suffix&quot;</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">&quot;Zm9v&quot;</span></code></pre></div>
<p>Secondly, a new string is allocated to hold the resulting string. We can
calculate a bound on the length of this string in the following manner:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token operator">//</span><span class="token punctuation">)</span> x y <span class="token operator">=</span>
  <span class="token keyword">if</span> y <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token keyword">then</span> raise <span class="token module variable">Division_by_zero</span> <span class="token punctuation">;</span>
  <span class="token keyword">if</span> x <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> y<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span>

<span class="token keyword">let</span> encode input <span class="token operator">=</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token module variable">Bytes</span><span class="token punctuation">.</span>create <span class="token punctuation">(</span><span class="token module variable">String</span><span class="token punctuation">.</span>length input <span class="token operator">//</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">let</span> decode input <span class="token operator">=</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token module variable">Bytes</span><span class="token punctuation">.</span>create <span class="token punctuation">(</span><span class="token module variable">String</span><span class="token punctuation">.</span>length input <span class="token operator">//</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div>
<p>Unfortunately we cannot know the exact length of the result prior to computing
it. This forces a call to <code>String.sub</code> at the end of the computation to return a
string of the correct length. This means we have two allocations rather than
one. To avoid the additional allocation, [@avsm][avsm] proposed to provide a new
type <code>sub = string * int * int</code>. This lets the user call <code>String.sub</code> if
required (and allocate a new string), or use simply use the returned <code>sub</code> for
_blit_ting to another buffer or similar.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#fuzz-everything" aria-label="fuzz everything permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fuzz everything!</h1>
<p>There's a strong trend of fuzzing libraries for MirageOS, which is quite easy
thanks to the brilliant work by <a href="https://github.com/yomimono">@yomimono</a> and <a href="https://github.com/stedolan">@stedolan</a>!
The integrated fuzzing in OCaml builds on <a href="http://lcamtuf.coredump.cx/afl/">American fuzzy lop</a>, which is
very smart about discarding paths of execution that have already been tested and
generating unseen inputs which break your assumptions. My first experience with
fuzzing was with the library <a href="https://github.com/mirage/decompress"><code>decompress</code></a>, and I was impressed by
<a href="https://github.com/mirage/decompress/pull/34">precise error</a> it found about a name clash.</p>
<p>Earlier in this article, I listed some properties we wanted to check for
<code>ocaml-base64</code>:</p>
<ul>
<li>The functions <code>encode</code> and <code>decode</code> should be be isomorphic taking
canonicalization into account:</li>
</ul>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> iso0 input <span class="token operator">=</span>
  <span class="token keyword">match</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token label function">~pad</span><span class="token punctuation">:</span><span class="token boolean">false</span> input <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">Error</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> fail <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">|</span> <span class="token module variable">Ok</span> result0 <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> result1 <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>encode_exn result0 <span class="token keyword">in</span>
    <span class="token keyword">match</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token label function">~pad</span><span class="token punctuation">:</span><span class="token boolean">true</span> result1 <span class="token keyword">with</span>
    <span class="token operator">|</span> <span class="token module variable">Error</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> fail <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">|</span> <span class="token module variable">Ok</span> result2 <span class="token operator">-&gt;</span> check_eq result0 result2

<span class="token keyword">let</span> iso1 input <span class="token operator">=</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>encode_exn input <span class="token keyword">in</span>
  <span class="token keyword">match</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode <span class="token label function">~pad</span><span class="token punctuation">:</span><span class="token boolean">true</span> result0 <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token module variable">Error</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> fail <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">|</span> <span class="token module variable">Ok</span> result1 <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> result2 <span class="token operator">=</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>encode_exn result1 <span class="token keyword">in</span>
    check_eq result0 result2</code></pre></div>
<ul>
<li>The function <code>decode</code> should <em>never</em> raise an exception, but rather return a
result type:</li>
</ul>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> no_exn input <span class="token operator">=</span>
  <span class="token keyword">try</span> ignore <span class="token operator">@@</span> <span class="token module variable">Base64</span><span class="token punctuation">.</span>decode input <span class="token keyword">with</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> fail <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<ul>
<li>And finally, we should randomize <code>?off</code> and <code>?len</code> arguments to ensure that we
don't get an <code>Out_of_bounds</code> exception when accessing input.</li>
</ul>
<p>Just because we've applied fuzzing to the new implementation for a long time, it
doesn't mean that the code is completely infallible. People can use our library
in an unimaginable way (and it's mostly what happens in the real world) and get
an unknowable error.</p>
<p>But, with the fuzzer, we've managed to test some properties across a very wide
range of input instead of unit testing with random (or not so random) inputs
from our brains. This development process allows <em>fixing the semantics</em> of
implementations (even if it's <strong>not</strong> a formal definition of semantics), but
it's better than nothing or outdated documentation.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>Based on our recent update to <code>ocaml-base64</code>, this blog post explains our
development process as go about rewriting the world to MirageOS, one bit at a
time. There's an important point to be made though:</p>
<p><code>ocaml-base64</code> is a small project. Currently, the implementation is about 250
lines of code. So it's a really small project. But as stated in the
introduction, we are fortunate enough to push the restart button of the computer
world - yes, we want to make a new operating system.</p>
<p>That's a massive task, and we shouldn't make it any harder on ourselves than
necessary. As such, we need to justify any step, any line of code, and why we
decided to spend our time on any change (why we decided to re-implement <code>git</code>
for example). So before committing any time to projects, we try to do a deep
analysis of the problem, get feedback from others, and find a consensus between
what we already know, what we want and what we should have (in the case of
<code>ocaml-base64</code>, @hannesm did a look on the PHP implementation and the Go
implementation).</p>
<p>Indeed, this is a hard question which nobody can answer perfectly in isolation.
So, the story of this update to <code>ocaml-base64</code> is an invitation for you to enter
the arcanas of the computer world through MirageOS :) ! Don't be afraid!</p>|js}
  };
 
  { title = {js|Playing Atari Games with OCaml and Deep Reinforcement Learning|js}
  ; slug = {js|playing-atari-games-with-ocaml-and-deep-reinforcement-learning|js}
  ; description = Some {js|In a previous blog postwe detailed how we used OCaml to reproduce some classical deep-learning resultsthat would usually be implemented in Python. Here we wi...|js}
  ; url = {js|https://blog.janestreet.com/playing-atari-games-with-ocaml-and-deep-rl/|js}
  ; date = {js|2019-02-02T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/playing-atari-games-with-ocaml-and-deep-rl/atari.jpg|js}
  ; featured = false
  ; body_html = {js|<p>In a <a href="https://blog.janestreet.com/deep-learning-experiments-in-ocaml/">previous blog post</a>
we detailed how we used OCaml to reproduce some classical deep-learning results
that would usually be implemented in Python. Here we will do the same with
some Reinforcement Learning (RL) experiments.</p>|js}
  };
 
  { title = {js|L2 Regularization and Batch Norm|js}
  ; slug = {js|l2-regularization-and-batch-norm|js}
  ; description = Some {js|This blog post is about an interesting detail about machine learningthat I came across as a researcher at Jane Street - that of the interaction between L2 re...|js}
  ; url = {js|https://blog.janestreet.com/l2-regularization-and-batch-norm/|js}
  ; date = {js|2019-01-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/l2-regularization-and-batch-norm/l2-batch-norm_19b.png|js}
  ; featured = false
  ; body_html = {js|<p>This blog post is about an interesting detail about machine learning
that I came across as a researcher at Jane Street - that of the 
interaction between L2 regularization, also known as
weight decay, and batch normalization.</p>|js}
  };
 
  { title = {js|A tutorial for building web applications with Incr_dom|js}
  ; slug = {js|a-tutorial-for-building-web-applications-with-incrdom|js}
  ; description = Some {js|At Jane Street, our web UIs are built on top of an in-house frameworkcalled Incr_dom, modeled inpart on React’s virtualDOM. Rendering differentviews efficien...|js}
  ; url = {js|https://blog.janestreet.com/a-tutorial-for-building-web-applications-with-incrdom/|js}
  ; date = {js|2019-01-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/a-tutorial-for-building-web-applications-with-incrdom/incr_dom.png|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, our web UIs are built on top of an in-house framework
called <a href="https://github.com/janestreet/incr_dom">Incr_dom</a>, modeled in
part on <a href="https://reactjs.org/docs/faq-internals.html">React&rsquo;s virtual
DOM</a>. Rendering different
views efficiently in response to changes made to a shared model is a
quintessentially incremental computation&mdash;so it should be no surprise
that Incr_dom is built on top of
<a href="https://blog.janestreet.com/introducing-incremental/">Incremental</a>.</p>|js}
  };
 
  { title = {js|How configurator reads C constants|js}
  ; slug = {js|how-configurator-reads-c-constants|js}
  ; description = None
  ; url = {js|https://dune.build/blog/configurator-constants/|js}
  ; date = {js|2019-01-03T00:00:00-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p>Dune comes with a library to query OS-specific information, called configurator.
It is able to evaluate C expressions and turn them into OCaml value.
Surprisingly, it even works when compiling for a different architecture. How can
it do that?</p>|js}
  };
 
  { title = {js|MirageOS, towards a smaller and safer OS|js}
  ; slug = {js|mirageos-towards-a-smaller-and-safer-os|js}
  ; description = Some {js|This presentation by Romain Calascibetta took place at Lambda World Cádiz on October 26th, 2018 at the Palacio de Congresos in Cádiz, Spain.MirageOS, towards...|js}
  ; url = {js|https://www.youtube.com/watch?v=urG5BjvjW18|js}
  ; date = {js|2018-12-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://i.ytimg.com/vi/urG5BjvjW18/maxresdefault.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Presentation about MirageOS in Lambda World Cad&igrave;z on October 26th</p>|js}
  };
 
  { title = {js|ocaml-git 2.0|js}
  ; slug = {js|ocaml-git-20|js}
  ; description = Some {js|I'm very happy to announce a new major release of ocaml-git (2.0).
This release is a 2-year effort to get a revamped
streaming API offering…|js}
  ; url = {js|https://tarides.com/blog/2018-10-19-ocaml-git-2-0|js}
  ; date = {js|2018-10-19T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/1d805022c72839f1abe63b28f225fd32/0132d/mesh.jpg|js}
  ; featured = false
  ; body_html = {js|<p>I'm very happy to announce a new major release of <code>ocaml-git</code> (2.0).
This release is a 2-year effort to get a revamped
streaming API offering a full control over memory
allocation. This new version also adds production-ready implementations of
the wire protocol: <code>git push</code> and <code>git pull</code> now work very reliably
using the raw Git and smart HTTP protocol (SSH support will come
soon). <code>git gc</code> is also implemented, and all of the basic bricks are
now available to create Git servers. MirageOS support is available
out-of-the-box.</p>
<p>Two years ago, we decided to rewrite <code>ocaml-git</code> and split it into
standalone libraries. More details about these new libraries are also
given below.</p>
<p>But first, let's focus on <code>ocaml-git</code>'s new design. The primary goal was
to fix memory consumption issues that our users noticed with the previous version,
and to make <code>git push</code> work reliably. We also took care about
not breaking the API too much, to ease the transition for current users.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#controlled-allocations" aria-label="controlled allocations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controlled allocations</h2>
<p>There is a big difference in the way <code>ocaml-git</code> and <code>git</code>
are designed: <code>git</code> is a short-lived command-line tool which does not
care that much about allocation policies, whereas we wanted to build a
library that can be linked with long-lived Git client and/or server
applications. We had to make some (performance) compromises to support
that use-case, at the benefit of tighter allocation policies &mdash; and hence
more predictable memory consumption patterns.
Other Git libraries such as <a href="https://libgit2.org/">libgit2</a>
also have to <a href="https://libgit2.org/security/">deal</a> with similar concerns.</p>
<p>In order to keep a tight control on the allocated memory, we decided to
use <a href="https://github.com/mirage/decompress">decompress</a> instead of
<code>camlzip</code>. <code>decompress</code> allows the users to provide their own buffer
instead of allocating dynamically. This allowed us to keep a better
control on memory consumption. See below for more details on <code>decompress</code>.</p>
<p>We also used <a href="https://github.com/inhabitedtype/angstrom">angstrom</a> and
<a href="https://github.com/mirage/encore">encore</a> to provide a streaming interface
to encode and decode Git objects. The streaming API is currently hidden
to the end-user, but it helped us a lot to build abstraction and, again, on
managing the allocation policy of the library.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#complete-pack-file-support-including-gc" aria-label="complete pack file support including gc permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Complete PACK file support (including GC)</h2>
<p>In order to find the right abstraction for manipulating pack files in
a long-lived application, we experimented with
<a href="https://github.com/dinosaure/sirodepac">various</a>
<a href="https://github.com/dinosaure/carton">prototypes</a>. We haven't found the
right abstractions just yet, but we believe the PACK format could be useful
to store any kind of data in the future (and not especially Git objects).</p>
<p>We implemented <code>git gc</code> by following the same heuristics as
<a href="https://github.com/git/git/blob/master/Documentation/technical/pack-heuristics.txt">Git</a>
to compress pack files and
we produce something similar in size &mdash; <code>decompress</code> has a good ratio about
compression &mdash; and we are using <code>duff</code>, our own implementation of <code>xdiff</code>, the
binary diff algorithm used by Git (more details on <code>duff</code> below).
We also had to re-implement the streaming algorithm to reconstruct <code>idx</code> files on
the fly, when receiving pack file on the network.</p>
<p>One notable feature of our compression algorithms is they work without
the assumption that the underlying system implements POSIX: hence,
they can work fully in-memory, in a browser using web storage or
inside a MirageOS unikernel with <a href="https://github.com/mirage/wodan">wodan</a>.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#production-ready-push-and-pull" aria-label="production ready push and pull permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Production-ready push and pull</h2>
<p>We re-implemented and abstracted the <a href="https://github.com/git/git/blob/master/Documentation/technical/http-protocol.txt">Git Smart protocol</a>, and used that
abstraction to make <code>git push</code> and <code>git pull</code> work over HTTP.  By
default we provide a <a href="https://github.com/mirage/cohttp">cohttp</a>
implementation but users can use their own &mdash; for instance based on
<a href="https://github.com/inhabitedtype/httpaf">httpaf</a>.
As proof-of-concept, the <a href="https://github.com/mirage/ocaml-git/pull/227">initial
pull-request</a> of <code>ocaml-git</code> 2.0 was
created using this new implementation; moreover, we wrote a
prototype of a Git client compiled with <code>js_of_ocaml</code>, which was able
to run <code>git pull</code> over HTTP inside a browser!</p>
<p>Finally, that implementation will allow MirageOS unikernels to synchronize their
internal state with external Git stores (hosted for instance on GitHub)
using push/pull mechanisms. We also expect to release a server-side implementation
of the smart HTTP protocol, so that the state of any unikernel can be inspected
via <code>git pull</code>. Stay tuned for more updates on that topic!</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#standalone-dependencies" aria-label="standalone dependencies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Standalone Dependencies</h2>
<p>Below you can find the details of the new stable releases of libraries that are
used by <code>ocaml-git</code> 2.0.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#optint-and-checkseum" aria-label="optint and checkseum permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>optint</code> and <code>checkseum</code></h3>
<p>In some parts of <code>ocaml-git</code>, we need to compute a Circular
Redundancy Check value. It is 32-bit integer value. <code>optint</code> provides
an abstraction of it but structurally uses an unboxed integer or a
boxed <code>int32</code> value depending on target (32 bit or 64 bit architecture).</p>
<p><code>checkseum</code> relies on <code>optint</code> and provides 3 implementations of CRC:</p>
<ul>
<li>Adler32 (used by <code>zlib</code> format)</li>
<li>CRC32 (used by <code>gzip</code> format and <code>git</code>)</li>
<li>CRC32-C (used by <code>wodan</code>)</li>
</ul>
<p><code>checkseum</code> uses the <em>linking trick</em>: this means that users of the
library program against an abstract API (only the <code>cmi</code> is provided);
at link-time, users have to select which implementation to use:
<code>checkseum.c</code> (the C implementation) or <code>checkseum.ocaml</code> (the OCaml
implementation). The process is currently a bit cumbersome but upcoming
<code>dune</code> release will make that process much more transparent to the users.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#encore-angkor" aria-label="encore angkor permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>encore</code> (/<em>angkor</em>/)</h3>
<p>In <code>git</code>, we work with Git <em>objects</em> (<em>tree</em>, <em>blob</em> or
<em>commit</em>). These objects are encoded in a specific format. Then,
the hash of these objects are computed from the encoded
result to get a unique identifier. For example, the hash of your last commit is:
<code>sha1(encode(commit))</code>.</p>
<p>A common operation in <code>git</code> is to decode Git objects from an encoded
representation of them (especially in <code>.git/objects/*</code> as a <em>loose</em>
file) and restore them in another part of your Git repository (like in a
PACK file or on the command-line).</p>
<p>Hence, we need to ensure that encoding is always deterministic, and
that decoding an encoded Git object is always the identity, e.g. there is
an <em>isomorphism</em> between the decoder and the encoder.</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">let</span> decoder <span class="token operator">&lt;.&gt;</span> encoder <span class="token punctuation">:</span> <span class="token keyword">value</span> <span class="token operator">-&gt;</span> <span class="token keyword">value</span> <span class="token operator">=</span> id
<span class="token keyword">let</span> encoder <span class="token operator">&lt;.&gt;</span> decoder <span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> string <span class="token operator">=</span> id</code></pre></div>
<p><a href="https://github.com/mirage/encore">encore</a> is a library in which you
can describe a format (like Git format) and from it, we can derive a
streaming decoder <strong>and</strong> encoder that are isomorphic by
construction.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#duff" aria-label="duff permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>duff</code></h3>
<p><a href="https://github.com/mirage/duff">duff</a> is a pure implementation in
OCaml of the <code>xdiff</code> algorithm.
Git has an optimized representation of your Git repository. It's a
PACK file. This format uses a binary diff algorithm called <code>xdiff</code>
to compress binary data. <code>xdiff</code> takes a source A and a target B and try
to find common sub-strings between A and B.</p>
<p>This is done by a Rabin's fingerprint of the source A applied to the
target B. The fingerprint can then be used to produce a lightweight
representation of B in terms of sub-strings of A.</p>
<p><code>duff</code> implements this algorithm (with additional Git's constraints,
regarding the size of the sliding windows) in OCaml. It provides a
small binary <code>xduff</code> that complies with the format of Git without the <code>zlib</code>
layer.</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ xduff diff source target &gt; target.xduff
$ xduff patch source &lt; target.xduff &gt; target.new
$ diff target target.new
$ echo $?
0</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#decompress" aria-label="decompress permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>decompress</code></h3>
<p><a href="https://github.com/mirage/decompress">decompress</a>
is a pure implementation in OCaml of <code>zlib</code> and
<code>rfc1951</code>. You can compress and decompress data flows and, obviously,
Git does this compression in <em>loose</em> files and PACK files.</p>
<p>It provides a non-blocking interface and is easily usable in a server
context. Indeed, the implementation never allocates and only relies on
what the user provides (<code>window</code>, input and output buffer). Then, the
distribution provides an easy example of how to use <code>decompress</code>:</p>
<div class="gatsby-highlight" data-language="ocaml"><pre class="language-ocaml"><code class="language-ocaml"><span class="token keyword">val</span> inflate<span class="token punctuation">:</span> <span class="token operator">?</span>level<span class="token punctuation">:</span>int <span class="token operator">-&gt;</span> string <span class="token operator">-&gt;</span> string
<span class="token keyword">val</span> deflate<span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> string</code></pre></div>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#digestif" aria-label="digestif permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>digestif</code></h3>
<p><a href="https://github.com/mirage/digestif">digestif</a> is a toolbox providing
many implementations of hash algorithms such as:</p>
<ul>
<li>MD5</li>
<li>SHA1</li>
<li>SHA224</li>
<li>SHA256</li>
<li>SHA384</li>
<li>SHA512</li>
<li>BLAKE2B</li>
<li>BLAKE2S</li>
<li>RIPEMD160</li>
</ul>
<p>Like <code>checkseum</code>, <code>digestif</code> uses the linking trick too: from a
shared interface, it provides 2 implementations, in C (<code>digestif.c</code>)
and OCaml (<code>digestif.ocaml</code>).</p>
<p>Regarding Git, we use the SHA1 implementation and we are ready to
migrate <code>ocaml-git</code> to BLAKE2{B,S} as the Git core team expects - and,
in the OCaml world, it is just a <em>functor</em> application with
another implementation.</p>
<h3 style="position:relative;"><a href="https://tarides.com/feed.xml#eqaf" aria-label="eqaf permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>eqaf</code></h3>
<p>Some applications require that secret values are compared in constant
time. Functions like <code>String.equal</code> do not have this property, so we
have decided to provide a small package &mdash; <a href="https://github.com/mirage/eqaf">eqaf</a> &mdash;
providing a <em>constant-time</em> <code>equal</code> function.
<code>digestif</code> uses it to check equality of hashes &mdash; it also exposes
<code>unsafe_compare</code> if you don't care about timing attacks in your application.</p>
<p>Of course, the biggest work on this package is not about the
implementation of the <code>equal</code> function but a way to check the
constant-time assumption on this function. Using this, we did a
<a href="https://github.com/mirage/eqaf/tree/master/test">benchmark</a> on Linux,
Windows and Mac to check it.</p>
<p>An interesting fact is that after various experiments, we replaced the
initial implementation in C (extracted from OpenBSD's <a href="https://man.openbsd.org/timingsafe_bcmp.3">timingsafe_memcmp</a>) with an OCaml
implementation behaving in a much more predictable way on all the
tested platforms.</p>
<h2 style="position:relative;"><a href="https://tarides.com/feed.xml#conclusion" aria-label="conclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h2>
<p>The upcoming version 2.0 of <a href="https://irmin.org">Irmin</a> is using ocaml-git
to create small applications that <a href="https://github.com/mirage/irmin/blob/master/examples/push.ml">push and pull their state
to GitHub</a>.
We think that Git offers a very nice model to persist data for distributed
applications and we hope that more people will use ocaml-git to experiment
and manipulate application data in Git. Please
<a href="https://github.com/mirage/ocaml-git/issues">send us</a> your feedback!</p>|js}
  };
 
  { title = {js|OCamlFormat 0.8|js}
  ; slug = {js|ocamlformat-08|js}
  ; description = Some {js|We are proud to announce the release of OCamlFormat 0.8 (available on opam). To ease the transition from the previous 0.7 release here are…|js}
  ; url = {js|https://tarides.com/blog/2018-10-17-ocamlformat-0-8|js}
  ; date = {js|2018-10-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/9b70dfbba6abba837b47f644a75b33dc/0132d/code_black1.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We are proud to announce the release of OCamlFormat 0.8 (available on opam). To ease the transition from the previous 0.7 release here are some highlights of the new features of this release. The <a href="https://github.com/ocaml-ppx/ocamlformat/blob/v0.8/CHANGES.md#08-2018-10-09">full changelog</a> is available on the project repository.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#precedence-of-options" aria-label="precedence of options permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Precedence of options</h1>
<p>In the previous version you could override command line options with <code>.ocamlformat</code> files configuration. 0.8 fixed this so that the OCamlFormat configuration is first established by reading <code>.ocamlformat</code> and <code>.ocp-indent</code> files:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">margin = 77
wrap-comments = true</code></pre></div>
<p>By default, these files in current and all ancestor directories for each input file are used, as well as the global configuration defined in <code>$XDG_CONFIG_HOME/ocamlformat</code>. The global <code>$XDG_CONFIG_HOME/ocamlformat</code> configuration has the lowest priority, then the closer the directory is to the processed file, the higher the priority. In each directory, both <code>.ocamlformat</code> and <code>.ocp-indent</code> files are read, with <code>.ocamlformat</code> files having the higher priority.</p>
<p>For now <code>ocp-indent</code> options support is very partial and is expected to be extended in the future.</p>
<p>Then the parameters can be overriden with the <code>OCAMLFORMAT</code> environment variable:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">OCAMLFORMAT=field-space=tight,type-decl=compact</code></pre></div>
<p>and finally the parameters can be overriden again with the command lines parameters.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#reading-input-from-stdin" aria-label="reading input from stdin permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading input from stdin</h1>
<p>It is now possible to read the input from stdin instead of OCaml files. The following command invokes OCamlFormat that reads its input from the pipe:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">echo &quot;let f x = x + 1&quot; | ocamlformat --name a.ml -</code></pre></div>
<p>The <code>-</code> on the command line indicates that <code>ocamlformat</code> should read from stdin instead of expecting input files. It is then necessary to use the <code>--name</code> option to designate the input (<code>a.ml</code> here).</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#preset-profiles" aria-label="preset profiles permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preset profiles</h1>
<p>Preset profiles allow you to have a consistent configuration without needing to tune every option.</p>
<p>Preset profiles set all options, overriding lower priority configuration. A preset profile can be set using the <code>--profile</code> (or <code>-p</code>) option. You can pass the option <code>--profile=&lt;name&gt;</code> on the command line or add <code>profile = &lt;name&gt;</code> in an <code>.ocamlformat</code> configuration file.</p>
<p>The available profiles are:</p>
<ul>
<li><code>default</code> sets each option to its default value</li>
<li><code>compact</code> sets options for a generally compact code style</li>
<li><code>sparse</code> sets options for a generally sparse code style</li>
<li><code>janestreet</code> is the profile used at JaneStreet</li>
</ul>
<p>To get a better feel of it, here is the formatting of the <a href="https://github.com/ocaml/ocaml/blob/trunk/typing/env.ml#L227-L234"><code>mk_callback</code></a> function from the OCaml compiler with the <code>compact</code> profile:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">let mk_callback rest name desc = function
  | None -&gt; nothing
  | Some f -&gt; (
      fun () -&gt;
        match rest with
        | [] -&gt; f name None
        | (hidden, _) :: _ -&gt; f name (Some (desc, hidden)) )</code></pre></div>
<p>then the same function formatted with the <code>sparse</code> profile:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">let mk_callback rest name desc = function
  | None -&gt;
      nothing
  | Some f -&gt;
      fun () -&gt;
        ( match rest with
        | [] -&gt;
            f name None
        | (hidden, _) :: _ -&gt;
            f name (Some (desc, hidden)) )</code></pre></div>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#project-root" aria-label="project root permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Project root</h1>
<p>The project root of an input file is taken to be the nearest ancestor directory that contains a <code>.git</code> or <code>.hg</code> or <code>dune-project</code> file.
If the new option <code>--disable-outside-detected-project</code> is set, <code>.ocamlformat</code> configuration files are not read outside of the current project. If no configuration file is found, formatting is disabled.</p>
<p>A new option, <code>--root</code> allows to specify the root directory for a project. If specified, OCamlFormat only takes into account <code>.ocamlformat</code> configuration files inside the root directory and its subdirectories.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#credits" aria-label="credits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h1>
<p>This release also contains many other changes and bug fixes that we cannot detail here. Check out the <a href="https://github.com/ocaml-ppx/ocamlformat/blob/v0.8/CHANGES.md#08-2018-10-09">full changelog</a>.</p>
<p>Special thanks to our maintainers and contributors for this release: David Allsopp, Josh Berdine, Hugo Heuzard, Brandon Kase, Anil Madhavapeddy and Guillaume Petiot.</p>|js}
  };
 
  { title = {js|OCaml Workshop 2018|js}
  ; slug = {js|ocaml-workshop-2018|js}
  ; description = Some {js|Videos are available online. 
The OCaml Users and Developers Workshop brings together industrial users of OCaml with academics and hackers who are working on extending the language, type system and tools. Previous editions have been colocated with ICFP 2012 in Copenhagen, ICFP 2013 in Boston, ICFP 2014 in Gothenburg, ICFP 2015 in Vancouver, ICFP 2016 in Nara, and ICFP 2017 in Oxford, following the OCaml Meetings in Paris in 2010 and 2011. 
OCaml 2018 will be held on September 27th, 2018 in St. Louis, Missouri, USA, colocated with ICFP 2018.|js}
  ; url = {js|https://icfp18.sigplan.org/track/ocaml-2018-papers#program|js}
  ; date = {js|2018-09-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://icfp18.sigplan.org/getImage/carousel/skyline.jpg?1488894339000|js}
  ; featured = false
  ; body_html = {js|<p>The OCaml Users and Developers Workshop brings together industrial
users of OCaml with academics and hackers who are working on extending
the language, type system and tools. OCaml 2018 was held on September
27th, 2018 in St. Louis, Missouri, USA, colocated with ICFP 2018.</p>
<p><strong>Check Tarides' talks: <a href="https://docs.google.com/presentation/d/e/2PACX-1vRnRiGeBWC6ctpSge0gTFuxprNTiS2qtNpvax_A8pD6Ob5ySfL9_SlPKCIoLDCbmsYjTAkMFnlUwqSl/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.p1">RFCs, all the way down!</a> and <a href="https://speakerdeck.com/avsm/the-ocaml-platform-1-dot-0-2018">The OCaml Platform 1.0</a>.
</strong></p>|js}
  };
 
  { title = {js|How to shuffle a big dataset|js}
  ; slug = {js|how-to-shuffle-a-big-dataset|js}
  ; description = Some {js|At Jane Street, we often work with data that has a very lowsignal-to-noise ratio, but fortunately we also have a lot of data.Where practitioners in many fiel...|js}
  ; url = {js|https://blog.janestreet.com/how-to-shuffle-a-big-dataset/|js}
  ; date = {js|2018-09-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/how-to-shuffle-a-big-dataset/shuffle_zoom.png|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, we often work with data that has a very low
signal-to-noise ratio, but fortunately we also have a <em>lot</em> of data.
Where practitioners in many fields might be accustomed to
having tens or hundreds of thousands of correctly labeled
examples, some of our problems are more like having a billion training
examples whose labels have only a slight tendency to be correct.
These large datasets present a number of interesting engineering
challenges.  The one we address here: <em>How do you shuffle a really
large dataset?</em>  (If you&rsquo;re not familiar with why one might need this,
jump to the section <a href="https://blog.janestreet.com/feed.xml#whyshuffle">Why shuffle</a> below.)</p>|js}
  };
 
  { title = {js|Deep learning experiments in OCaml|js}
  ; slug = {js|deep-learning-experiments-in-ocaml|js}
  ; description = Some {js|Last year we held a machine learning seminar in our London office,which was an opportunity to reproduce some classical deep learningresults with a nice twist...|js}
  ; url = {js|https://blog.janestreet.com/deep-learning-experiments-in-ocaml/|js}
  ; date = {js|2018-09-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/deep-learning-experiments-in-ocaml/camel.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Last year we held a machine learning seminar in our London office,
which was an opportunity to reproduce some classical deep learning
results with a nice twist: we used OCaml as a programming language
rather than Python. This allowed us to train models defined in a
functional way in OCaml on a GPU using TensorFlow.</p>|js}
  };
 
  { title = {js|Getting started with atdgen and bucklescript|js}
  ; slug = {js|getting-started-with-atdgen-and-bucklescript|js}
  ; description = Some {js|atdgen is a project to create types and data structures that can be serialized to JSON. It is very convenient when communicating between…|js}
  ; url = {js|https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2018-09-12T02:53:58-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p><a href="https://github.com/mjambon/atd">atdgen</a> is a project to create types and data structures that can be serialized to JSON. It is very convenient when communicating between multiple processes, creating a REST API or consuming JSON objects from other tools. It can be compared to <a href="https://json-schema.org/">JSON schema</a> or <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>, but with richer types and more features.</p><p>The idea is to write a list of types in a specification file, an&nbsp;.atd file. Then running atdgen, it is possible to generate OCaml or Java code to serialize/deserialize values of those types to/from corresponding json.</p><p>Until very recently, atdgen could generate code only for native OCaml. But <a href="https://github.com/mjambon/atd/pull/44">the support of bucklescript has been merged</a>! atdgen the cli tool is still a native OCaml binary. But it can output some OCaml code that can be compiled using <a href="https://bucklescript.github.io/">bucklescript</a>.</p><p>The work to implement this new feature of atdgen has been funded by <a href="https://ahrefs.com/">Ahrefs</a>. We highly appreciate open source tools. And as much as possible, we prefer to contribute to existing open source projects rather than to re-invent the wheel internally.</p><h3>Installation</h3><p>To install atdgen we first need to install <a href="https://opam.ocaml.org">opam</a> (OCaml package manager), as atdgen doesn&rsquo;t provide ready to use binaries and is only distributed as source package via opam. The procedure is simple and documented here: <a href="https://opam.ocaml.org/doc/2.0/Install.html">https://opam.ocaml.org/doc/2.0/Install.html</a></p><p>Then we need to initialize opam and create a switch. Any version of ocaml greater or equal to 4.03.0 should be&nbsp;fine.</p><pre>opam init -a<br/>opam switch create . 4.07.1 -y</pre><p>Once it is done, we have to install the development version of atdgen. The support of bucklescript is not officially released.</p><pre>opam pin add atd --dev-repo   <br/>opam pin add atdgen --dev-repo</pre><p>Make sure that atdgen is available.</p><pre>$ which atdgen                 <br/>(current $PWD)/_opam/bin/atdgen</pre><p>Of course, we need bucklescript.</p><pre>yarn init                 <br/>yarn add bs-platform --dev</pre><p>We also need the bucklescript runtime for atdgen, as it is not currently provided by atdgen itself. So we have written and open-sourced our version of the runtime&nbsp;: <a href="https://github.com/ahrefs/bs-atdgen-codec-runtime">https://github.com/ahrefs/bs-atdgen-codec-runtime</a>.</p><p>This runtime is responsible for the conversion between JSON values and OCaml values. The JSON values are based on the standard <a href="https://bucklescript.github.io/bucklescript/api/Js.Json.html#TYPEt">Js.Json.t type</a> provided by bucklescript to be sure that it is easy to interoperate with the rest of the ecosystem.</p><p>It is published on npm for easy integration in bucklescript projects.</p><pre>yarn add @ahrefs/bs-atdgen-codec-runtime</pre><h3>Project configuration</h3><p>After the previous section, package.json should be almost ready. We can add a few scripts to make it more convenient to compile the project. Here is how it should look once completed.</p><pre>{<br/>  &quot;name&quot;: &quot;demo-bs-atdgen&quot;,<br/>  &quot;version&quot;: &quot;0.0.1&quot;,<br/>  &quot;description&quot;: &quot;demo of atdgen with bucklescript&quot;,<br/>  &quot;scripts&quot;: {<br/>    &quot;clean&quot;: &quot;bsb -clean-world&quot;,<br/>    &quot;build&quot;: &quot;bsb -make-world&quot;,<br/>    &quot;watch&quot;: &quot;bsb -make-world -w&quot;,<br/>    &quot;atdgen&quot;: &quot;atdgen -t meetup.atd &amp;&amp; atdgen -bs meetup.atd&quot;<br/>  },<br/>  &quot;devDependencies&quot;: {<br/>    &quot;bs-platform&quot;: &quot;^4.0.5&quot;<br/>  },<br/>  &quot;peerDependencies&quot;: {<br/>    &quot;bs-platform&quot;: &quot;^4.0.5&quot;<br/>  },<br/>  &quot;dependencies&quot;: {<br/>    &quot;<a href="http://twitter.com/ahrefs/bs-atdgen-codec-runtime">@ahrefs/bs-atdgen-codec-runtime</a>&quot;: &quot;^1.0.4&quot;<br/>  }<br/>}</pre><p>The bucklescript configuration is very simple. We use the basic configuration that can be found in any bucklescript project. Except that we need to add one dependency to bsconfig.json:</p><pre>{<br/>  &quot;name&quot;: &quot;demo-bs-atdgen&quot;,<br/>  &quot;version&quot;: &quot;0.0.1&quot;,<br/>  &quot;sources&quot;: {<br/>    &quot;dir&quot;: &quot;src&quot;,<br/>    &quot;subdirs&quot;: true<br/>  },<br/>  &quot;package-specs&quot;: {<br/>    &quot;module&quot;: &quot;commonjs&quot;,<br/>    &quot;in-source&quot;: true<br/>  },<br/>  &quot;suffix&quot;: &quot;.bs.js&quot;,<br/>  &quot;bs-dependencies&quot;: [<br/>    &quot;<a href="http://twitter.com/ahrefs/bs-atdgen-codec-runtime">@ahrefs/bs-atdgen-codec-runtime</a>&quot;<br/>  ],<br/>  &quot;warnings&quot;: {<br/>    &quot;error&quot;: &quot;+101&quot;<br/>  },<br/>  &quot;generate-merlin&quot;: true,<br/>  &quot;namespace&quot;: true,<br/>  &quot;refmt&quot;: 3<br/>}</pre><h3>First ATD definitions</h3><p>It is time to create a first&nbsp;.atd file, containing our types. This part is also documented on <a href="https://atd.readthedocs.io/en/latest/tutorial.html#getting-started">https://atd.readthedocs.io/en/latest/tutorial.html#getting-started</a></p><p>For this example, I decided to go with a meetup event. Put the type definitions in src/meetup.atd.</p><pre>(* This is a comment. Same syntax as in ocaml. *)</pre><pre>type access = [ Private | Public ]</pre><pre>(* the date will be a float in the json and a Js.Date.t in ocaml *)<br/>type date = float wrap &lt;ocaml module=&quot;Js.Date&quot; wrap=&quot;Js.Date.fromFloat&quot; unwrap=&quot;Js.Date.valueOf&quot;&gt;</pre><pre>(* Some people don't want to provide a phone number, make it optional *)<br/>type person = {<br/>  name: string;<br/>  email: string;<br/>  ?phone: string nullable;<br/>}</pre><pre>type event = {<br/>  access: access;<br/>  name: string;<br/>  host: person;<br/>  date: date;<br/>  guests: person list;<br/>}</pre><pre>type events = event list</pre><p>We use the atdgen binary (compiled previously) to generate the ocaml types and the code to serialize/deserialize those&nbsp;types.</p><pre>atdgen -t meetup.atd # generates an ocaml file containing the types<br/>atdgen -bs meetup.atd # generates the code to (de)serialize</pre><p>The generated files&nbsp;are:</p><ul><li>meetup_t.ml(i) which contain the ocaml types corresponding to our ATD definitions.</li><li>meetup_bs.ml(i) which contain the ocaml code to transform from and to json&nbsp;values.</li></ul><p>At this point we can compile our&nbsp;project.</p><pre>yarn build</pre><p>If everything worked properly, we now have two&nbsp;.bs.js files in the src directory.</p><pre>$ tree src<br/>src<br/>&#9500;&#9472;&#9472; meetup.atd<br/>&#9500;&#9472;&#9472; meetup_bs.bs.js<br/>&#9500;&#9472;&#9472; meetup_bs.ml<br/>&#9500;&#9472;&#9472; meetup_bs.mli<br/>&#9500;&#9472;&#9472; meetup_t.bs.js<br/>&#9500;&#9472;&#9472; meetup_t.ml<br/>&#9492;&#9472;&#9472; meetup_t.mli</pre><pre>0 directories, 7 files</pre><p>At this point, we can create new OCaml/Reason files in the src directory and use all the code atdgen generated for us. Two examples to illustrate that.</p><h3>Query a REST&nbsp;API</h3><p>A common usage of atdgen is to decode the JSON returned by a REST API. Here is a short example, using the reason syntax and bs-fetch.</p><pre>let get = (url, decode) =&gt;<br/>  Js.Promise.(<br/>    Fetch.fetchWithInit(<br/>      url,<br/>      Fetch.RequestInit.make(~method_=Get, ()),<br/>    )<br/>    |&gt; then_(Fetch.Response.json)<br/>    |&gt; then_(json =&gt; json |&gt; decode |&gt; resolve)<br/>  );</pre><pre>let v: Meetup_t.events =<br/>  get(<br/>    &quot;<a href="http://localhost:8000/events">http://localhost:8000/events</a>&quot;,<br/>    Atdgen_codec_runtime.Decode.decode(Meetup_bs.read_events),<br/>  );</pre><h3>Read and write a JSON&nbsp;file</h3><p>Atdgen for bucklescript doesn&rsquo;t take care of converting a string to a JSON object. Which allows us to use the performant json parser included in nodejs or the&nbsp;browser.</p><pre>let read_events filename =<br/>  (* Read and parse the json file from disk, this doesn't involve atdgen. *)<br/>  let json =<br/>    Node_fs.readFileAsUtf8Sync filename<br/>    |&gt; Js.Json.parseExn<br/>  in<br/>  (* Turn it into a proper record. The annotation is of course optional. *)<br/>  let events: Meetup_t.events =<br/>    Atdgen_codec_runtime.Decode.decode Meetup_bs.read_events json<br/>  in<br/>  events</pre><p>The reverse operation, converting a record to a JSON object and writing it in a file is also straightforward.</p><pre>let write_events filename events =<br/>  Atdgen_codec_runtime.Encode.encode Meetup_bs.write_events events (* turn a list of records into json *)<br/>  |. Js.Json.stringifyWithSpace 2   (* convert the json to a pretty string *)<br/>  |&gt; Node_fs.writeFileAsUtf8Sync filename  (* write the json in our file *)</pre><h3>Full example</h3><p>Now that we have our functions to read and write events, we can build a small cli to pretty print the list of events and add new&nbsp;events.</p><p>The source code of the full example is available <a href="https://github.com/ahrefs/bs-atdgen-codec-runtime/tree/master/example">on&nbsp;github</a>.</p><p>You can run it like&nbsp;this:</p><pre>$ echo &quot;[]&quot; &gt; events.json<br/>$ nodejs src/cli.bs.js add louis <a href="mailto:louis@nospam.com">louis@nospam.com</a><br/>$ nodejs src/cli.bs.js add bob <a href="mailto:bob@nospam.com">bob@nospam.com</a><br/>$ nodejs src/cli.bs.js print<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:16 GMT<br/>access: public<br/>host: bob &lt;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&gt;<br/>guests: 1<br/>=== OCaml/Reason Meetup! summary ===<br/>date: Tue, 11 Sep 2018 15:04:13 GMT<br/>access: public<br/>host: louis &lt;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&gt;<br/>guests: 1<br/>$ cat events.json<br/>[<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&quot;,<br/>        &quot;name&quot;: &quot;bob&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678256177,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;<a href="mailto:bob@nospam.com">bob@nospam.com</a>&quot;,<br/>      &quot;name&quot;: &quot;bob&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  },<br/>  {<br/>    &quot;guests&quot;: [<br/>      {<br/>        &quot;email&quot;: &quot;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&quot;,<br/>        &quot;name&quot;: &quot;louis&quot;<br/>      }<br/>    ],<br/>    &quot;date&quot;: 1536678253790,<br/>    &quot;host&quot;: {<br/>      &quot;email&quot;: &quot;<a href="mailto:louis@nospam.com">louis@nospam.com</a>&quot;,<br/>      &quot;name&quot;: &quot;louis&quot;<br/>    },<br/>    &quot;name&quot;: &quot;OCaml/Reason Meetup!&quot;,<br/>    &quot;access&quot;: &quot;Public&quot;<br/>  }<br/>]</pre><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=1f3a14004081" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081">Getting started with atdgen and bucklescript</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|Dune 1.2.0|js}
  ; slug = {js|dune-120|js}
  ; description = Some {js|After a tiny but important patch release as 1.1.1, the dune team is thrilled to
announce the release of dune 1.2.0! Here are some highlights…|js}
  ; url = {js|https://tarides.com/blog/2018-09-06-dune-1-2-0|js}
  ; date = {js|2018-09-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tarides.com/static/98e7b693b372846010bfcd8d54746146/0132d/sand_dune1.jpg|js}
  ; featured = false
  ; body_html = {js|<p>After a tiny but important patch release as 1.1.1, the dune team is thrilled to
announce the release of dune 1.2.0! Here are some highlights of the new
features in that version. The full list of changes can be found <a href="https://github.com/ocaml/dune/blob/e3af33b43a87d7fa2d15f7b41d8bd942302742ec/CHANGES.md#120-14092018">in the dune
repository</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#watch-mode" aria-label="watch mode permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Watch mode</h1>
<p>When developing, it is common to edit a file, run a build, read the error
message, and fix the error. Since this is a very tight loop and developers are
doing this hundreds or thousands times a day, it is crucial to have the
quickest feedback possible.</p>
<p><code>dune build</code> and <code>dune runtest</code> now accept <a href="https://dune.readthedocs.io/en/latest/usage.html#watch-mode">a <code>-w</code>
flag</a> that will
watch the filesystem for changes, and trigger a new build.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#better-error-messages" aria-label="better error messages permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Better error messages</h1>
<p>Inspired by the great work done in
<a href="http://elm-lang.org/blog/compiler-errors-for-humans">Elm</a> and
<a href="https://reasonml.github.io/blog/2017/08/25/way-nicer-error-messages.html">bucklescript</a>,
dune now displays the relevant file in error messages.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"> % cat dune
(executable
 (name my_program)
 (librarys cmdliner)
)
 % dune build
File &quot;dune&quot;, line 3, characters 2-10:
3 |  (librarys cmdliner)
      ^^^^^^^^
Error: Unknown field librarys
Hint: did you mean libraries?</code></pre></div>
<p>Many messages have also been improved, in particular to help users <a href="https://dune.readthedocs.io/en/latest/migration.html#check-list">switching
from the <code>jbuild</code> format to the <code>dune</code>
format</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#dune-unstable-fmt" aria-label="dune unstable fmt permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dune unstable-fmt</h1>
<p>Are you confused about how to format S-expressions? You are not alone.
That is why we are gradually introducing a formatter for <code>dune</code> files. It can
transform a valid but ugly <code>dune</code> into one that is consistently formatted.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text"> % cat dune
(executable( name ls) (libraries cmdliner)
(preprocess (pps ppx_deriving.std)))
 % dune unstable-fmt dune
(executable
 (name ls)
 (libraries cmdliner)
 (preprocess
  (pps ppx_deriving.std)
 )
)</code></pre></div>
<p>This feature is not ready yet for the end user (hence the <code>unstable</code> part),
and in particular the concrete syntax is not stable yet.
But having it already in the code base will make it possible to build useful
integrations with <code>dune</code> itself (to automatically reformat all dune files in a
project, for example) and common editors, so that they format <code>dune</code> files on
save.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#first-class-support-of-findlib-plugins" aria-label="first class support of findlib plugins permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>First class support of findlib plugins</h1>
<p>It is now easy to support findlib plugins by just adding the <code>findlib.dynload</code>
library dependency. Then you can use <code>Fl_dynload</code> module in your code which
will automatically do the right thing. <a href="https://dune.readthedocs.io/en/latest/advanced-topics.html#dynamic-loading-of-packages">A complete example can be found in the
dune manual</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#promote-only-certain-files" aria-label="promote only certain files permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promote only certain files</h1>
<p>The <code>dune promote</code> command now accept a list of files. This is useful to
promote just the file that is opened in a text editor for example. Some emacs
bindings are provided to do this, which works particularly well with
<a href="https://dune.readthedocs.io/en/latest/tests.html#inline-expectation-tests">inline expectation tests</a>.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#deprecation-message-for-wrapped-modes" aria-label="deprecation message for wrapped modes permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deprecation message for (wrapped) modes</h1>
<p>By default, libraries are <code>(wrapped true)</code>, which means that they expose a
single OCaml module (source files are exposed as submodules of this main
module). This is usually desired as it makes link-time name collisions less
likely. However, a lot of libraries are using <code>(wrapped false)</code> (expose all
source files as modules) to keep compatibility.</p>
<p>It can be challenging to transition from <code>(wrapped false)</code> to <code>(wrapped true)</code>
because it breaks compatibility. That is why we have added <code>(wrapped (transition &quot;message&quot;))</code> which will generate wrapped modules but keep unwrapped
modules with a deprecation message to help coordinate the change.</p>
<h1 style="position:relative;"><a href="https://tarides.com/feed.xml#credits" aria-label="credits permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewbox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h1>
<p>Special thanks to our contributors for this release: @aantron, @anuragsoni,
@bobot, @ddickstein, @dra27, @drjdn, @hongchangwu, @khady, @kodek16,
@prometheansacrifice and @ryyppy.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2018 edition|js}
  ; slug = {js|what-the-interns-have-wrought-2018-edition|js}
  ; description = Some {js|Yet again, intern season is coming to a close, and so it’s time tolook back at what the interns have achieved in their short time withus.  I’m always impress...|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2018/|js}
  ; date = {js|2018-08-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/what-the-interns-have-wrought-2018/smelting.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Yet again, intern season is coming to a close, and so it&rsquo;s time to
look back at what the interns have achieved in their short time with
us.  I&rsquo;m always impressed by what our interns manage to squeeze into
the summer, and this year is no different.</p>|js}
  };
 
  { title = {js|Station F|js}
  ; slug = {js|station-f|js}
  ; description = Some {js|With more than 30 startup programs, 35 public administrations, 150 VC funds, 4 mentorship offices and 600 events per year, STATION F offers all the best resources and knowledge to empower the next generation of entrepreneurs. Startups will benefit from the community and meet other great entrepreneurs.|js}
  ; url = {js|https://stationf.co/|js}
  ; date = {js|2018-07-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://stationf.co/img/cards/og_image.png|js}
  ; featured = false
  ; body_html = {js|<p>We are thrilled to have been accepted into the Founders Progam's 3rd
batch at <a href="https://stationf.co/">Station F</a>! Station F is
&quot;the only startup campus gathering a whole entrepreneurial ecosystem
under one roof&quot; and is providing 3000+ desks and 26 international
startup programs. Our Paris offices are now located in that incredible
place, close to &quot;m&eacute;tro Chevaleret&quot; (Paris 13).</p>
<p><strong>If you are in Paris, drop us an email to visit
<a href="%20https://stationf.co/campus/">our beautiful campus</a>!</strong></p>|js}
  };
 
  { title = {js|Plans for OCaml 4.08|js}
  ; slug = {js|plans-for-ocaml-408|js}
  ; description = Some {js|With the external release of OCaml 4.07.0 imminent, we in Jane Street’sTools & Compilers group have been planning what we want to work on forinclusion in...|js}
  ; url = {js|https://blog.janestreet.com/plans-for-ocaml-408/|js}
  ; date = {js|2018-06-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/plans-for-ocaml-408/ocaml_release.jpg|js}
  ; featured = false
  ; body_html = {js|<p>With the external release of OCaml 4.07.0 imminent, we in Jane Street&rsquo;s
Tools &amp; Compilers group have been planning what we want to work on for
inclusion in OCaml 4.08. These days OCaml uses (or at least attempts) a
time-based release process with releases scheduled every 6 months. We&rsquo;re
trying to avoid rushing in changes at the last minute &ndash; as we&rsquo;ve been
prone to do in the past &ndash; so this list is restricted to things we could
conceivably finish in the next 4-5 months.</p>|js}
  };
 
  { title = {js|OCaml Users in Paris (OUPS)|js}
  ; slug = {js|ocaml-users-in-paris-oups|js}
  ; description = Some {js|Wed, May 23, 7:00 PM CEST: Le prochain OUPS aura lieu mercredi 23 mai. Le rendez-vous est fixé à 19h. Le programme sera habituel, exposés suivis d'une discussion autour d'un pot avec des pizzas.

Ce|js}
  ; url = {js|https://www.meetup.com/ocaml-paris/events/250836568/|js}
  ; date = {js|2018-05-23T00:00:00-00:00|js}
  ; preview_image = Some {js|https://secure-content.meetupstatic.com/images/classic-events/257293542/676x380.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Thomas Gazagnaire gave a presentation on MirageOS to the
<a href="https://www.meetup.com/ocaml-paris/">OCaml meetup in Paris</a>.</p>
<p><strong>Check the <a href="http://gazagnaire.org/pub/2018.05.OUPS.pdf">slides</a>
for more details.</strong></p>|js}
  };
 
  { title = {js|MirageOS + Tezos funding|js}
  ; slug = {js|mirageos--tezos-funding|js}
  ; description = Some {js|We believe that Tezos will drive social, political and economic innovation on a global scale.|js}
  ; url = {js|https://tezos.foundation|js}
  ; date = {js|2018-05-23T00:00:00-00:00|js}
  ; preview_image = Some {js|https://tezos.foundation/wp-content/uploads/2020/04/blue-bg.png|js}
  ; featured = false
  ; body_html = {js|<p>We are excited to announce that the <a href="https://tezos.foundation">Tezos Foundation</a>
will trust Tarides to package Tezos nodes as MirageOS unikernel, which will help participants
establish nodes on the Tezos network in a more efficient and secure manner.</p>|js}
  };
 
  { title = {js|Irmin usability enhancements|js}
  ; slug = {js|irmin-usability-enhancements|js}
  ; description = Some {js|For the next few months I will be working on Irmin, focusing on improving general usability. The goal of this effort is to make Irmin more accessible to potential users and clean up the rough edges for existing users.  One of the biggest problems I see right now is that the documentation is out of sync with the current implementation. I’ve just been getting starting refreshing the documentation and tutorials, however here are a few more projects that @samoht and I have discussed:   Better RPC AP...|js}
  ; url = {js|https://discuss.ocaml.org/t/irmin-usability-enhancements/2017|js}
  ; date = {js|2018-05-18T00:00:00-00:00|js}
  ; preview_image = Some {js|https://aws1.discourse-cdn.com/standard11/uploads/ocaml/original/2X/d/d4dc9fe40b17e2bcced034f9fe103917b7999275.svg|js}
  ; featured = false
  ; body_html = {js|<p>Zach Shipko is working on improving the UI/UX for Irmin.
He is looking for <a href="https://discuss.ocaml.org/t/irmin-usability-enhancements/2017">feedback</a>
to make Irmin more accessible to potential users and clean up the rough edges for existing users.</p>|js}
  };
 
  { title = {js|Invited lecture at ENS|js}
  ; slug = {js|invited-lecture-at-ens|js}
  ; description = None
  ; url = {js|http://www.di.ens.fr/~pouzet/cours/systeme/|js}
  ; date = {js|2018-05-17T00:00:00-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p>Thomas Gazagnaire gave an invited lecture at
<a href="http://www.di.ens.fr/">the computer science department of ENS</a>,
in Paris. This was part of the system and network L3 course.</p>
<p><strong>Check the <a href="http://gazagnaire.org/ens/mirage.pdf">slides</a> (in english)
and the <a href="http://gazagnaire.org/ens/mirage.tar.gz">exercices</a> (in french).</strong></p>|js}
  };
 
  { title = {js|Repeatable exploratory programming|js}
  ; slug = {js|repeatable-exploratory-programming|js}
  ; description = Some {js|Expect tests are a technique I’ve written aboutbefore, but until recently, it’s been alittle on the theoretical side. That’s because it’s been hard to taketh...|js}
  ; url = {js|https://blog.janestreet.com/repeatable-exploratory-programming/|js}
  ; date = {js|2018-04-22T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/repeatable-exploratory-programming/lambdasoup.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Expect tests are a technique I&rsquo;ve written about
<a href="https://blog.janestreet.com/testing-with-expectations">before</a>, but until recently, it&rsquo;s been a
little on the theoretical side. That&rsquo;s because it&rsquo;s been hard to take
these ideas out for a spin due to lack of tooling outside of Jane
Street&rsquo;s walls.</p>|js}
  };
 
  { title = {js|The Bitcoin Piñata - no candy for you|js}
  ; slug = {js|the-bitcoin-piata---no-candy-for-you|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/Pinata|js}
  ; date = {js|2018-04-18T11:38:17-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>History</h2>
<p>On February 10th 2015 David Kaloper-Mer&scaron;injak and Hannes Mehnert
<a href="https://mirage.io/announcing-bitcoin-pinata">launched</a> (read also <a href="http://amirchaudhry.com/bitcoin-pinata">Amir's
description</a>) our <a href="https://en.wikipedia.org/wiki/Bug_bounty_program">bug bounty
program</a> in the form of our
<a href="http://ownme.ipredator.se">Bitcoin Pi&ntilde;ata</a> MirageOS unikernel.  Thanks again to
<a href="https://ipredator.se">IPredator</a> for both hosting our services and lending us
the 10 Bitcoins!  We <a href="https://mirage.io/blog/bitcoin-pinata-results">analysed</a> a
bit more in depth after running it for five months.  Mindy recently wrote about
<a href="https://somerandomidiot.com/blog/2018/04/17/whacking-the-bitcoin-pinata/">whacking the Bitcoin
Pi&ntilde;ata</a>.</p>
<p>On March 18th 2018, after more than three years, IPredator, the lender of the Bitcoins, repurposed the 10 Bitcoins for other projects.  Initially, we thought that the Pi&ntilde;ata would maybe run for a month or two, but IPredator, David, and I decided to keep it running.  The update of the Pi&ntilde;ata's bounty is a good opportunity to reflect on the project.</p>
<p>The 10 Bitcoin in the Pi&ntilde;ata were fluctuating in price over time, at peak worth 165000&euro;.</p>
<p>From the start of the Pi&ntilde;ata project, we published the <a href="https://github.com/mirleft/btc-pinata">source code</a>, the virtual machine image, and the versions of the used libraries in a git repository.  Everybody could develop their exploits locally before launching them against our Pi&ntilde;ata.  The Pi&ntilde;ata provides TLS endpoints, which require private keys and certificates.  These are generated by the Pi&ntilde;ata at startup, and the secret for the Bitcoin wallet is provided as a command line argument.</p>
<p>Initially the Pi&ntilde;ata was deployed on a Linux/Xen machine, later it was migrated to a FreeBSD host using BHyve and VirtIO with <a href="https://github.com/solo5/solo5">solo5</a>, and in December 2017 it was migrated to native BHyve (<a href="https://hannes.robur.coop/Posts/Solo5">using <code>ukvm-bin</code> and solo5</a>).  We also changed the Pi&ntilde;ata code to accomodate for updates, such as the <a href="https://mirage.io/blog/announcing-mirage-30-release">MirageOS 3.0 release</a>, and the discontinuation of floating point numbers for timestamps (asn1-combinators 0.2.0, x509 0.6.0, tls 0.9.0).</p>
<h2>Motivation</h2>
<p>We built the Pi&ntilde;ata for many purposes: to attract security professionals to evaluate our <a href="https://mirage.io/blog/introducing-ocaml-tls">from-scratch developed TLS stack</a>, to gather empirical data for our <a href="https://usenix15.nqsb.io">Usenix Security 15 paper</a>, and as an improvement to current bug bounty programs.</p>
<p>Most bug bounty programs require communication via forms and long wait times for
human experts to evaluate the potential bug.  This evaluation is subjective,
intransparent, and often requires signing of non-disclosure agreements (NDA),
even before the evaluation starts.</p>
<p>Our Pi&ntilde;ata <em>automates</em> these parts, getting rid of wait times and NDAs.  To get
the private wallet key that holds the bounty, you need to successfully establish
an authenticated TLS session or find a flaw elsewhere in the stack, which allows
to read arbitrary memory.  Everyone can track transactions of the blockchain and
see if the wallet still contains the bounty.</p>
<p>Of course, the Pi&ntilde;ata can't prove that our stack is secure, and it can't prove
that the access to the wallet is actually inside.  But trust us, it is!</p>
<h2>Observations</h2>
<p>I still remember vividly the first nights in February 2015, being so nervous that I woke up every two hours and checked the blockchain.  Did the Pi&ntilde;ata still have the Bitcoins?  I was familiar with the code of the Pi&ntilde;ata and was afraid there might be a bug which allows to bypass authentication or leak the private key.  So far, this doesn't seem to be the case.</p>
<p>In April 2016 we stumbled upon an <a href="https://hannes.robur.coop/Posts/BadRecordMac">information disclosure in the virtual network
device driver for Xen in MirageOS</a>.  Given enough
bandwidth, this could have been used to access the private wallet key.  We
upgraded the Pi&ntilde;ata and released the <a href="https://mirage.io/blog/MSA00">MirageOS Security Advisory
00</a>.</p>
<p>We analysed the Pi&ntilde;ata's access logs to the and bucketed them into website traffic and bounty connections.  We are still wondering what happened in July 2015 and July 2017 where the graph shows spikes.  Could it be a presentation mentioning the Pi&ntilde;ata, or a new automated tool which tests for TLS vulnerabilities, or an increase in market price for Bitcoins?</p>
<p><img src="https://hannes.robur.coop/static/img/pinata_access_20180403.png" alt="Pi&ntilde;ata access"/> <img src="https://hannes.robur.coop/static/img/pinata_access_cumulative_20180403.png" alt="Pi&ntilde;ata access cumulative"/></p>
<p>The cumulative graph shows that more than 500,000 accesses to the Pi&ntilde;ata website, and more than 150,000 attempts at connecting to the Pi&ntilde;ata bounty.</p>
<p>You can short-circuit the client and server Pi&ntilde;ata endpoint and observe the private wallet key being transferred on your computer, TLS encrypted with the secret exchanged by client and server, using <code>socat -x TCP:ownme.ipredator.se:10000 TCP:ownme.ipredator.se:10002</code>.</p>
<p>If you attempted to exploit the Pi&ntilde;ata, please let us know what you tried!  Via
<strike><a href="https://twitter.com/h4nnes">twitter</a></strike>
<a href="http://mastodon.social/@hannesm">hannesm@mastodon.social</a> or via eMail.</p>
<p>Since <a href="https://hannes.robur.coop/Posts/DNS">the start of 2018</a> we are developing robust software and systems at <a href="http://robur.io">robur</a>.  If you like our work and want to support us with donations or development contracts, please get in touch with <code>team@robur.io</code>.  Robur is a project of the German non-profit <a href="https://techcultivation.org">Center for the cultivation of technology</a>.  Donations to robur are tax-deductible in Europe.</p>|js}
  };
 
  { title = {js|HotPOST'18|js}
  ; slug = {js|hotpost18|js}
  ; description = Some {js|The 10th International Workshop on Hot Topics in Pervasive Mobile and Online Social Networking (HotPOST 2018)   Monday, April 16, 2018 ● 13:30 – 17:30 ● Room: Iolani 5  |js}
  ; url = {js|http://infocom2018.ieee-infocom.org/content/workshop-hotpost-hot-topics-pervasive-mobile-and-online-social-networking-program|js}
  ; date = {js|2018-04-16T00:00:00-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p>Anil Madhavapeddy and Gemma Gordon presented our new operating system for
connected buildings: <a href="http://kcsrk.info/papers/osmose_feb_18.pdf">OSMOSE</a>
to <a href="http://hotpost18.weebly.com/">HotPOST&rsquo;18</a>. OSMOSE is based on
MirageOS and Irmin and we hope to explore that area more in the coming months!</p>|js}
  };
 
  { title = {js|OCaml all the way down|js}
  ; slug = {js|ocaml-all-the-way-down|js}
  ; description = Some {js|One of the joys of working at Jane Street for the last 15 or so yearshas been seeing how our software stack has grown in scope. When Istarted, I was building...|js}
  ; url = {js|https://blog.janestreet.com/ocaml-all-the-way-down/|js}
  ; date = {js|2018-04-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/ocaml-all-the-way-down/fpga.jpg|js}
  ; featured = false
  ; body_html = {js|<p>One of the joys of working at Jane Street for the last 15 or so years
has been seeing how our software stack has grown in scope. When I
started, I was building pretty narrowly focused systems for doing
statistical research on trading strategies, and then building systems
for executing those same strategies.</p>|js}
  };
 
  { title = {js|Putting the I back in IDE: Towards a Github Explorer|js}
  ; slug = {js|putting-the-i-back-in-ide-towards-a-github-explorer|js}
  ; description = Some {js|Imagine a system for editing and reviewing code where:|js}
  ; url = {js|https://blog.janestreet.com/putting-the-i-back-in-ide-towards-a-github-explorer/|js}
  ; date = {js|2018-03-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/putting-the-i-back-in-ide-towards-a-github-explorer/postimage.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Imagine a system for editing and reviewing code where:</p>|js}
  };
 
  { title = {js|Learn OCaml in NYC|js}
  ; slug = {js|learn-ocaml-in-nyc|js}
  ; description = Some {js|Interested in learning OCaml? In the NYC area? Then this mightbe for you!|js}
  ; url = {js|https://blog.janestreet.com/learn-ocaml-nyc/|js}
  ; date = {js|2018-02-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/learn-ocaml-nyc/ocaml_workshop.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Interested in learning OCaml? In the NYC area? Then this might
be for you!</p>|js}
  };
 
  { title = {js|Proofs (and Refutations) using Z3|js}
  ; slug = {js|proofs-and-refutations-using-z3|js}
  ; description = Some {js|People often think of formal methods and theorem provers as forbiddingtools, cool in theory but with a steep learning curve that makes themhard to use in rea...|js}
  ; url = {js|https://blog.janestreet.com/proofs-and-refutations-using-z3/|js}
  ; date = {js|2018-02-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/proofs-and-refutations-using-z3/proof.jpg|js}
  ; featured = false
  ; body_html = {js|<p>People often think of formal methods and theorem provers as forbidding
tools, cool in theory but with a steep learning curve that makes them
hard to use in real life. In this post, we&rsquo;re going to describe a case
we ran into recently where we were able to leverage theorem proving
technology, Z3 in particular, to validate some real world engineering
we were doing on the OCaml compiler. This post is aimed at readers
interested in compilers, but assumes no familiarity with actual
compiler development.</p>|js}
  };
 
  { title = {js|An Architecture for Interspatial Communication|js}
  ; slug = {js|an-architecture-for-interspatial-communication|js}
  ; description = None
  ; url = {js|http://kcsrk.info/papers/osmose_feb_18.pdf|js}
  ; date = {js|2018-02-14T00:00:00-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<p>Position paper on
<a href="http://kcsrk.info/papers/osmose_feb_18.pdf">&ldquo;An Architecture for Interspatial Communication&rdquo;</a>
accepted to <a href="http://hotpost18.weebly.com/">HotPOST&rsquo;18</a>.</p>|js}
  };
 
  { title = {js|My 2018 contains robur and starts with re-engineering DNS|js}
  ; slug = {js|my-2018-contains-robur-and-starts-with-re-engineering-dns|js}
  ; description = None
  ; url = {js|https://hannes.robur.coop/Posts/DNS|js}
  ; date = {js|2018-01-11T14:02:01-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<h2>2018</h2>
<p>At the end of 2017, I resigned from my PostDoc position at University of
Cambridge (in the <a href="https://www.cl.cam.ac.uk/~pes20/rems/">rems</a> project).  Early
December 2017 I organised the <a href="https://mirage.io/blog/2017-winter-hackathon-roundup">4th MirageOS hack
retreat</a>, with which I'm
very satisfied.  In March 2018 the <a href="http://retreat.mirage.io">5th retreat</a> will
happen (please sign up!).</p>
<p>In 2018 I moved to Berlin and started to work for the (non-profit) <a href="https://techcultivation.org">Center for
the cultivation of technology</a> with our
<a href="http://robur.io">robur.io</a> project &quot;At robur, we build performant bespoke
minimal operating systems for high-assurance services&quot;.  robur is only possible
by generous donations in autumn 2017, enthusiastic collaborateurs, supportive
friends, and a motivated community, thanks to all.  We will receive funding from
the <a href="https://prototypefund.de/project/robur-io/">prototypefund</a> to work on a
<a href="https://robur.io/Our%20Work/Projects#CalDAV-Server">CalDAV server</a> implementation in OCaml
targeting MirageOS.  We're still looking for donations and further funding,
please get in touch.  Apart from CalDAV, I want to start the year by finishing
several projects which I discovered on my hard drive.  This includes DNS, <a href="https://hannes.robur.coop/Posts/Conex">opam
signing</a>, TCP, ... .  My personal goal for 2018 is to develop a
flexible <code>mirage deploy</code>, because after configuring and building a unikernel, I
want to get it smoothly up and running (spoiler: I already use
<a href="https://hannes.robur.coop/Posts/VMM">albatross</a> in production).</p>
<p>To kick off (3% of 2018 is already used) this year, I'll talk in more detail
about <a href="https://github.com/roburio/udns">&micro;DNS</a>, an opinionated from-scratch
re-engineered DNS library, which I've been using since Christmas 2017 in production for
<a href="https://github.com/hannesm/ns.nqsb.io">ns.nqsb.io</a> and
<a href="https://git.robur.io/?p=ns.robur.io.git%3Ba=summary">ns.robur.io</a>.  The
development started in March 2017, and continued over several evenings and long
weekends.  My initial motivation was to implement a recursive resolver to run on
my laptop.  I had a working prototype in use on my laptop over 4 months in the
summer 2017, but that code was not in a good shape, so I went down the rabbit
hole and (re)wrote a server (and learned more about GADT).  A configurable
resolver needs a server, as local overlay, usually anyways.  Furthermore,
dynamic updates are standardised and thus a configuration interface exists
inside the protocol, even with hmac-signatures for authentication!
Coincidentally, I started to solve another issue, namely automated management of let's
encrypt certificates (see <a href="https://github.com/hannesm/ocaml-letsencrypt/tree/nsupdate">this
branch</a> for an
initial hack).  On my journey, I also reported a cache poisoning vulnerability,
which was fixed in <a href="https://docs.docker.com/docker-for-windows/release-notes/#docker-community-edition-17090-ce-win32-2017-10-02-stable">Docker for
Windows</a>.</p>
<p>But let's get started with some content.  Please keep in mind that while the
code is publicly available, it is not yet released (mainly since the test
coverage is not high enough, and the lack of documentation).  I appreciate early
adopters, please let me know if you find any issues or find a use case which is
not straightforward to solve.  This won't be the last article about DNS this
year - persistent storage, resolver, let's encrypt support are still missing.</p>
<h2>What is DNS?</h2>
<p>The <a href="https://en.wikipedia.org/wiki/DNS">domain name system</a> is a core Internet
protocol, which translates domain names to IP addresses.  A domain name is
easier to memorise for human beings than an IP address.  DNS is hierarchical and
decentralised.  It was initially &quot;specified&quot; in Nov 1987 in <a href="https://tools.ietf.org/html/rfc1034">RFC
1034</a> and <a href="https://tools.ietf.org/html/rfc1035">RFC
1035</a>.  Nowadays it spans over more than 20
technical RFCs, 10 security related, 5 best current practises and another 10
informational.  The basic encoding and mechanisms did not change.</p>
<p>On the Internet, there is a set of root servers (administrated by IANA) which
provide the information about which name servers are authoritative for which top level
domain (such as &quot;.com&quot;).  They provide the information about which name servers are
responsible for which second level domain name (such as &quot;example.com&quot;), and so
on.  There are at least two name servers for each domain name in separate
networks - in case one is unavailable the other can be reached.</p>
<p>The building blocks for DNS are: the resolver, a stub (<code>gethostbyname</code> provided
by your C library) or caching forwarding resolver (at your ISP), which send DNS
packets to another resolver, or a recursive resolver which, once seeded with the
root servers, finds out the IP address of a requested domain name.  The other
part are authoritative servers, which reply to requests for their configured
domain.</p>
<p>To get some terminology, a DNS client sends a query, consisting of a domain
name and a query type, and expects a set of answers, which are called resource
records, and contain: name, time to live, type, and data.  The resolver
iteratively requests resource records from authoritative servers, until the requested
domain name is resolved or fails (name does not exist, server
failure, server offline).</p>
<p>DNS usually uses UDP as transport which is not reliable and limited to 512 byte
payload on the Internet (due to various middleboxes).  DNS can also be
transported via TCP, and even via TLS over UDP or TCP.  If a DNS packet
transferred via UDP is larger than 512 bytes, it is cut at the 512 byte mark,
and a bit in its header is set.  The receiver can decide whether to use the 512
bytes of information, or to throw it away and attempt a TCP connection.</p>
<h3>DNS packet</h3>
<p>The packet encoding starts with a 16bit identifier followed by a 16bit header
(containing operation, flags, status code), and four counters, each 16bit,
specifying the amount of resource records in the body: questions, answers,
authority records, and additional records.  The header starts with one bit
operation (query or response), four bits opcode, various flags (recursion,
authoritative, truncation, ...), and the last four bit encode the response code.</p>
<p>A question consists of a domain name, a query type, and a query class.  A
resource record additionally contains a 32bit time to live, a length, and the
data.</p>
<p>Each domain name is a case sensitive string of up to 255 bytes, separated by <code>.</code>
into labels of up to 63 bytes each.  A label is either encoded by its length
followed by the content, or by an offset to the start of a label in the current
DNS frame (poor mans compression).  Care must be taken during decoding to avoid
cycles in offsets.  Common operations on domain names are comparison: equality,
ordering, and also whether some domain name is a subdomain of another domain
name, should be efficient.  My initial representation na&iuml;vely was a list of
strings, now it is an array of strings in reverse order.  This speeds up common
operations by a factor of 5 (see test/bench.ml).</p>
<p>The only really used class is <code>IN</code> (for Internet), as mentioned in <a href="https://tools.ietf.org/html/rfc6895">RFC
6895</a>.  Various query types (<code>MD</code>, <code>MF</code>,
<code>MB</code>, <code>MG</code>, <code>MR</code>, <code>NULL</code>, <code>AFSDB</code>, ...) are barely or never used.  There is no
need to convolute the implementation and its API with these legacy options (if
you have a use case and see those in the wild, please tell me).</p>
<p>My implemented packet decoding does decompression, only allows valid internet
domain names, and may return a partial parse - to use as many resource records
in truncated packets as possible.  There are no exceptions raised, the parsing
uses a monadic style error handling.  Since label decompression requires the
parser to know absolute offsets, the original buffer and the offset is manually
passed around at all times, instead of using smaller views on the buffer.  The
decoder does not allow for gaps, when the outer resource data length specifies a
byte length which is not completely consumed by the specific resource data
subparser (an A record must always consume four bytes).  Failing to check this can
lead to a way to exfiltrate data without getting noticed.</p>
<p>Each zone (a served domain name) contains a SOA &quot;start of authority&quot; entry,
which includes the primary nameserver name, the hostmaster's email address (both
encoded as domain name), a serial number of the zone, a refresh, retry, expiry,
and minimum interval (all encoded as 32bit unsigned number in seconds).  Common
resource records include A, which payload is 32bit IPv4 address.  A nameserver
(NS) record carries a domain name as payload.  A mail exchange (MX) whose
payload is a 16bit priority and a domain name.  A CNAME record is an alias to
another domain name.  These days, there are even records to specify the
certificate authority authorisation (CAA) records containing a flag (critical),
a tag (&quot;issue&quot;) and a value (&quot;letsencrypt.org&quot;).</p>
<h2>Server</h2>
<p>The operation of a DNS server is to listen for a request and serve a reply.
Data to be served can be canonically encoded (the RFC describes the format) in a
zone file.  Apart from insecurity in DNS server implementations, another attack
vector are amplification attacks where an attacker crafts a small UDP frame
with a fake source IP address, and the server answers with a large response to
that address which may lead to a DoS attack.  Various mitigations exist
including rate limiting, serving large replies only via TCP, ...</p>
<p>Internally, the zone file data is stored in a tree (module
<a href="https://github.com/roburio/udns/blob/master/server/dns_trie.mli">Dns_trie</a>
<a href="https://github.com/roburio/udns/blob/master/server/dns_trie.ml">implementation</a>),
where each node contains two maps: <code>sub</code>, which key is a label and value is a
subtree and <code>dns_map</code> (module Dns_map), which key is a resource record type and
value is the resource record.  Both use the OCaml
<a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Map.html">Map</a> (&quot;also known
as finite maps or dictionaries, given a total ordering function over the
keys. All operations over maps are purely applicative (no side-effects). The
implementation uses balanced binary trees, and therefore searching and insertion
take time logarithmic in the size of the map&quot;).</p>
<p>The server looks up the queried name, and in the returned Dns_map the queried
type. The found resource records are sent as answer, which also includes the
question and authority information (NS records of the zone) and additional glue
records (IP addresses of names mentioned earlier in the same zone).</p>
<h3>Dns_map</h3>
<p>The data structure which contains resource record types as key, and a collection
of matching resource records as values.  In OCaml the value type must be
homogenous - using a normal sum type leads to an unneccessary unpacking step
(or lacking type information):</p>
<pre><code class="language-OCaml">let lookup_ns t =
  match Map.find NS t with
  | None -&gt; Error `NotFound
  | Some (NS nameservers) -&gt; Ok nameservers
  | Some _ -&gt; Error `NotFound
</code></pre>
<p>Instead, I use in my current rewrite <a href="https://en.wikipedia.org/wiki/Generalized_algebraic_data_type">generalized algebraic data
types</a> (read
<a href="http://caml.inria.fr/pub/docs/manual-ocaml/extn.html#sec251">OCaml manual</a> and
<a href="http://mads-hartmann.com/ocaml/2015/01/05/gadt-ocaml.html">Mads Hartmann blog post about use cases for
GADTs</a>, <a href="https://andreas.github.io/2018/01/05/modeling-graphql-type-modifiers-with-gadts/">Andreas
Garn&aelig;s about using GADTs for GraphQL type
modifiers</a>)
to preserve a relation between key and value (and A record has a list of IPv4
addresses and a ttl as value) - similar to
<a href="http://erratique.ch/software/hmap">hmap</a>, but different: a closed key-value
mapping (the GADT), no int for each key and mutable state.  Thanks to Justus
Matthiesen for helping me with GADTs and this code.  Look into the
<a href="https://github.com/roburio/udns/blob/master/src/dns_map.mli">interface</a> and
<a href="https://github.com/roburio/udns/blob/master/src/dns_map.ml">implementation</a>.</p>
<pre><code class="language-OCaml">(* an ordering relation, I dislike using int for that *)
module Order = struct
  type (_,_) t =
    | Lt : ('a, 'b) t
    | Eq : ('a, 'a) t
    | Gt : ('a, 'b) t
end

module Key = struct
  (* The key and its value type *)
  type _ t =
    | Soa : (int32 * Dns_packet.soa) t
    | A : (int32 * Ipaddr.V4.t list) t
    | Ns : (int32 * Dns_name.DomSet.t) t
    | Cname : (int32 * Dns_name.t) t

  (* we need a total order on our keys *)
  let compare : type a b. a t -&gt; b t -&gt; (a, b) Order.t = fun t t' -&gt;
    let open Order in
    match t, t' with
    | Cname, Cname -&gt; Eq | Cname, _ -&gt; Lt | _, Cname -&gt; Gt
    | Ns, Ns -&gt; Eq | Ns, _ -&gt; Lt | _, Ns -&gt; Gt
    | Soa, Soa -&gt; Eq | Soa, _ -&gt; Lt | _, Soa -&gt; Gt
    | A, A -&gt; Eq
end

type 'a key = 'a Key.t

(* our OCaml Map with an encapsulated constructor as key *)
type k = K : 'a key -&gt; k
module M = Map.Make(struct
    type t = k
    (* the price I pay for not using int as three-state value *)
    let compare (K a) (K b) = match Key.compare a b with
      | Order.Lt -&gt; -1
      | Order.Eq -&gt; 0
      | Order.Gt -&gt; 1
  end)

(* v contains a key and value pair, wrapped by a single constructor *)
type v = V : 'a key * 'a -&gt; v

(* t is the main type of a Dns_map, used by clients *)
type t = v M.t

(* retrieve a typed value out of the store *)
let get : type a. a Key.t -&gt; t -&gt; a = fun k t -&gt;
  match M.find (K k) t with
  | V (k', v) -&gt;
    (* this comparison is superfluous, just for the types *)
    match Key.compare k k' with
    | Order.Eq -&gt; v
    | _ -&gt; assert false
</code></pre>
<p>This helps me to programmaticaly retrieve tightly typed values from the cache,
important when code depends on concrete values (i.e. when there are domain
names, look these up as well and add as additional records).  Look into <a href="https://github.com/roburio/udns/blob/master/server/dns_server.ml">server/dns_server.ml</a></p>
<h3>Dynamic updates, notifications, and authentication</h3>
<p><a href="https://tools.ietf.org/html/rfc2136">Dynamic updates</a> specify in-protocol
record updates (supported for example by <code>nsupdate</code> from ISC bind-tools),
<a href="https://tools.ietf.org/html/rfc1996">notifications</a> are used by primary servers
to notify secondary servers about updates, which then initiate a <a href="https://tools.ietf.org/html/rfc5936">zone
transfer</a> to retrieve up to date
data. <a href="https://tools.ietf.org/html/rfc2845">Shared hmac secrets</a> are used to
ensure that the transaction (update, zone transfer) was authorised.  These are
all protocol extensions, there is no need to use out-of-protocol solutions.</p>
<p>The server logic for update and zone transfer frames is slightly more complex,
and includes a dependency upon an authenticator (implemented using the
<a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> library, and
<a href="http://erratique.ch/software/ptime">ptime</a>).</p>
<h3>Deployment and Let's Encrypt</h3>
<p>To deploy servers without much persistent data, an authentication schema is
hardcoded in the dns-server: shared secrets are also stored as DNS entries
(DNSKEY), and <code>_transfer.zone</code>, <code>_update.zone</code>, and <code>_key-management.zone</code> names
are introduced to encode the permissions.  A <code>_transfer</code> key also needs to
encode the IP address of the primary (to know where to request zone transfers)
and secondary IP (to know where to send notifications).</p>
<p>Please have a look at
<a href="https://git.robur.io/?p=ns.robur.io.git%3Ba=summary">ns.robur.io</a> and the <a href="https://github.com/roburio/udns/blob/master/mirage/examples">examples</a> for more details.  The shared secrets are provided as boot parameter of the unikernel.</p>
<p>I hacked maker's
<a href="https://github.com/hannesm/ocaml-letsencrypt/tree/nsupdate">ocaml-letsencrypt</a>
library to use &micro;DNS and sending update frames to the given IP address.  I
already used this to have letsencrypt issue various certificates for my domains.</p>
<p>There is no persistent storage of updates yet, but this can be realised by
implementing a secondary (which is notified on update) that writes every new
zone to persistent storage (e.g. <a href="https://github.com/mirage/mirage-block">disk</a>
or <a href="https://github.com/mirage/ocaml-git">git</a>).  I also plan to have an
automated Let's Encrypt certificate unikernel which listens for certificate
signing requests and stores signed certificates in DNS.  Luckily the year only
started and there's plenty of time left.</p>
<p>I'm interested in feedback, either via <strike><a href="https://twitter.com/h4nnes">twitter</a></strike>
hannesm@mastodon.social or via eMail.</p>|js}
  };
 
  { title = {js|Work on the OCaml compiler at Jane Street!|js}
  ; slug = {js|work-on-the-ocaml-compiler-at-jane-street|js}
  ; description = Some {js|As Jane Street grows, the quality of the development tools we usematters more and more.  We increasingly work on the OCaml compileritself: adding useful lang...|js}
  ; url = {js|https://blog.janestreet.com/work-on-the-ocaml-compiler-at-jane-street/|js}
  ; date = {js|2017-12-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/work-on-the-ocaml-compiler-at-jane-street/compiler3d.jpg|js}
  ; featured = false
  ; body_html = {js|<p>As Jane Street grows, the quality of the development tools we use
matters more and more.  We increasingly work on the OCaml compiler
itself: adding useful language features, fine-tuning the type system
and improving the performance of the generated code. Alongside this,
we also work on the surrounding toolchain, developing new tools for
profiling, debugging, documentation and build automation.</p>|js}
  };
 
  { title = {js|Does batch size matter?|js}
  ; slug = {js|does-batch-size-matter|js}
  ; description = Some {js|This post is aimed at readers who are already familiar withstochastic gradient descent(SGD) and terms like “batch size”.  For an introduction to theseideas, ...|js}
  ; url = {js|https://blog.janestreet.com/does-batch-size-matter/|js}
  ; date = {js|2017-10-31T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/does-batch-size-matter/batch-01.png|js}
  ; featured = false
  ; body_html = {js|<p><i>This post is aimed at readers who are already familiar with
<a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">stochastic gradient descent</a>
(SGD) and terms like &ldquo;batch size&rdquo;.  For an introduction to these
ideas, I recommend Goodfellow et al.&rsquo;s
<a href="http://www.deeplearningbook.org/">Deep Learning</a>, in particular the
introduction and, for more about SGD, Chapter 8.  The relevance of SGD
is that it has made it feasible to work with much more complex models
than was formerly possible.</i></p>|js}
  };
 
  { title = {js|How Jane Street Does Code Review (Jane Street Tech Talk)|js}
  ; slug = {js|how-jane-street-does-code-review-jane-street-tech-talk|js}
  ; description = Some {js|It’s time for our nextJane Street Tech Talk. Whenwe’ve solicited suggestions for topics, one common request has been totalk about our internal development pr...|js}
  ; url = {js|https://blog.janestreet.com/jane-street-tech-talk-how-jane-street-does-code-review/|js}
  ; date = {js|2017-10-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/jane-street-tech-talk-how-jane-street-does-code-review/image.png|js}
  ; featured = false
  ; body_html = {js|<p>It&rsquo;s time for our next
<a href="https://www.janestreet.com/tech-talks/">Jane Street Tech Talk</a>. When
we&rsquo;ve solicited suggestions for topics, one common request has been to
talk about our internal development process. Our next talk,
<a href="https://www.janestreet.com/tech-talks/code-review/">How Jane Street Does Code Review</a>,
should fit the bill. The talk is being given by our own Ian Henry, and
discusses how we approach code review, and in particular how Iron, the
code review system we&rsquo;ve been using and improving for some years now,
fits in to that process.</p>|js}
  };
 
  { title = {js|Jane Street Tech Talk, Verifying Network Data Planes|js}
  ; slug = {js|jane-street-tech-talk-verifying-network-data-planes|js}
  ; description = Some {js|After a summer hiatus, the Jane Street Tech Talks series is back onfor the fall! Last we left it, our very own Dominick LoBraicopresented on the evolution of...|js}
  ; url = {js|https://blog.janestreet.com/jane-street-tech-talk-verifying-network-data-planes/|js}
  ; date = {js|2017-09-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/jane-street-tech-talk-verifying-network-data-planes/tech-talk-nate-foster.png|js}
  ; featured = false
  ; body_html = {js|<p>After a summer hiatus, the Jane Street Tech Talks series is back on
for the fall! Last we left it, our very own Dominick LoBraico
presented on the evolution of our internal configuration methodology
and the systems that support it. For anybody that missed it, you can
check out a recording of the talk <a href="https://www.youtube.com/watch?v=0pX7-AG52BU">on YouTube</a>.</p>|js}
  };
 
  { title = {js|Real world machine learning (part 1)|js}
  ; slug = {js|real-world-machine-learning-part-1|js}
  ; description = Some {js|Trading is a competitive business. You need great people and greattechnology, of course, but also trading strategies that make money.Where do those strategie...|js}
  ; url = {js|https://blog.janestreet.com/real-world-machine-learning-part-1/|js}
  ; date = {js|2017-08-28T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/real-world-machine-learning-part-1/inverse_colors.gif|js}
  ; featured = false
  ; body_html = {js|<p>Trading is a competitive business. You need great people and great
technology, of course, but also trading strategies that make money.
Where do those strategies come from? In this post we&rsquo;ll discuss how
the interplay of data, math and technology informs how we develop and
run strategies.</p>|js}
  };
 
  { title = {js|How to design a tree diffing algorithm|js}
  ; slug = {js|how-to-design-a-tree-diffing-algorithm|js}
  ; description = Some {js|For those of you interested in whatwhatinternsdo at Jane Street, here’s apost from former internTristan Hume, on his work developing tree-diffing algorithms ...|js}
  ; url = {js|https://blog.janestreet.com/how-to-design-a-tree-diffing-algorithm/|js}
  ; date = {js|2017-08-25T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>For those of you interested in what
<a href="https://blog.janestreet.com/what-the-interns-have-wrought-rpc_parallel-and-core_profiler">what</a>
<a href="https://blog.janestreet.com/what-the-interns-have-wrought-2016">interns</a>
<a href="https://blog.janestreet.com/what-the-interns-have-wrought-2017">do</a> at Jane Street, here&rsquo;s a
<a href="http://thume.ca/2017/06/17/tree-diffing/">post</a> from former intern
Tristan Hume, on his work developing tree-diffing algorithms last
summer at Jane Street. It&rsquo;s a fun (and very detailed!) read.</p>|js}
  };
 
  { title = {js|Ironing out your development style|js}
  ; slug = {js|ironing-out-your-development-style|js}
  ; description = Some {js|People seem to enjoy talking about programming methodologies. Theygive them cute names, likeeXtreme programming,Agile, andScrum; runconferences and buildcomm...|js}
  ; url = {js|https://blog.janestreet.com/ironing-out-your-development-style/|js}
  ; date = {js|2017-08-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/ironing-out-your-development-style/story.jpg|js}
  ; featured = false
  ; body_html = {js|<p>People seem to enjoy talking about programming methodologies. They
give them cute names, like
<a href="http://www.extremeprogramming.org/">eXtreme programming</a>,
<a href="https://www.agilealliance.org/">Agile</a>, and
<a href="https://www.scrum.org/resources/what-is-scrum">Scrum</a>; run
<a href="https://www.scrumalliance.org/sgcal">conferences</a> and build
<a href="https://www.scrumalliance.org/community">communities</a> around them;
write
<a href="https://www.amazon.com/Extreme-Programming-Explained-Embrace-Change/dp/0321278658/ref=sr_1_1?ie=UTF8&amp;qid=1503346126&amp;sr=8-1&amp;keywords=extreme%20programming">books</a>
that describe how to use them in excruciating detail; and
<a href="http://agilemanifesto.org/">manifestos</a> that lay out their
philosophy.</p>|js}
  };
 
  { title = {js|Hiring an FPGA engineer|js}
  ; slug = {js|hiring-an-fpga-engineer|js}
  ; description = Some {js|Jane Street is looking to hire an engineer with experience in bothsoftware and hardware design to work on FPGA-based applications, andon tools for creating s...|js}
  ; url = {js|https://blog.janestreet.com/hiring-an-fpga-engineer/|js}
  ; date = {js|2017-08-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/hiring-an-fpga-engineer/fpga_hiring.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street is looking to hire an engineer with experience in both
software and hardware design to work on FPGA-based applications, and
on tools for creating such applications.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2017 edition|js}
  ; slug = {js|what-the-interns-have-wrought-2017-edition|js}
  ; description = Some {js|Intern season is coming to a close, and it’s a nice time to look back(as I’ve done inpreviousyears) and review some of whatthe interns did while they were he...|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2017/|js}
  ; date = {js|2017-08-14T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/what-the-interns-have-wrought-2017/what_interns_wrought.png|js}
  ; featured = false
  ; body_html = {js|<p>Intern season is coming to a close, and it&rsquo;s a nice time to look back
(as I&rsquo;ve done in
<a href="https://blog.janestreet.com/what-the-interns-have-wrought-rpc_parallel-and-core_profiler">previous</a>
<a href="https://blog.janestreet.com/what-the-interns-have-wrought-2016">years</a>) and review some of what
the interns did while they were here. The dev intern program has grown
considerably, with almost 40 dev interns between our NY, London, and
Hong Kong offices.</p>|js}
  };
 
  { title = {js|Skylake bug: a detective story|js}
  ; slug = {js|skylake-bug-a-detective-story|js}
  ; description = Some {js|It was a dark and stormy night; the skylake CPU buzzed with excitement, and then, suddenly, the hyperthreads started to lock up..|js}
  ; url = {js|https://tech.ahrefs.com/skylake-bug-a-detective-story-ab1ad2beddcd?source=rss----303662d88bae--ocaml|js}
  ; date = {js|2017-06-28T18:34:51-00:00|js}
  ; preview_image = None
  ; featured = false
  ; body_html = {js|<blockquote>It was a dark and stormy night; the skylake CPU buzzed with excitement, and then, suddenly, the hyperthreads started to lock&nbsp;up..</blockquote><p>Or something like&nbsp;that.</p><p>This week a new erratum for the Intel Skylake and Kabylake processors families was brought to public attention on <a href="https://lists.debian.org/debian-devel/2017/06/msg00308.html">the Debian mailing list</a>, and then on <a href="https://news.ycombinator.com/item?id=14630183">various</a> <a href="https://www.reddit.com/r/programming/comments/6jfgfp/warning_intel_skylakekaby_lake_processors_broken/">social media</a> and <a href="http://www.theregister.co.uk/2017/06/25/intel_skylake_kaby_lake_hyperthreading/">news&nbsp;outlets</a>.</p><p>We have been investigating this issue since January with the core <a href="http://ocaml.org">OCaml</a> team, as we were struggling with a mysterious bug affecting our developers machines, and ultimately our production system, resulting in a corruption of important data in our databases.</p><p>At <a href="https://ahrefs.com">Ahrefs</a>, we operate a fleet of thousands of servers, running a wide variety of services (huge web crawler among others). At this scale, dealing with unexpected application behaviors is common. While we try to reduce the probability of the software not functioning as expected, bugs are sadly a real part of our everyday life. Even though we can assume the underlying hardware running any infrastructure can be thought of as more reliable and less prone to bugs than software components, issues can still arise in unexpected ways. When the number of servers increases, it is not unusual to observe faults in the hardware preventing the system from functioning as specified.</p><p>It is certainly not frequent to encounter such problems in CPUs but reading through <a href="https://www3.intel.com/content/dam/www/public/us/en/documents/specification-updates/desktop-6th-gen-core-family-spec-update.pdf">the list of errata published by any manufacturer,</a> each CPU model contains a fair amount of bugs. This story is about the bug in the microcode of Skylake processor leading to incorrect code execution under certain conditions. This is certainly scary at first sight: how can we trust our system if we cannot trust its main component&nbsp;? Yet, like software bugs, processor defects can be identified, contained, and we can take actions to prevent them from impacting the operation of the infrastructure.</p><p>We do not know the full implications of this particular bug, especially security implications in case of untrusted code execution. But we&rsquo;d like to tell the story of this erratum from our point of view, to provide some context, and show that dealing with it was not much different than dealing with any usual software flaw. While this post aims to cover our own perspective on this adventure, we would like to thank Mark Shinwell, Xavier Leroy, Fr&eacute;d&eacute;ric Bour, everyone involved in the <a href="https://caml.inria.fr/mantis/view.php?id=7452">Mantis issue</a> and the OCaml IRC channel for their help and time spent investigating with us. Update: Xavier Leroy told his own side of the story in another <a href="http://gallium.inria.fr/blog/intel-skylake-bug/">blog&nbsp;post.</a></p><h3>Setting the&nbsp;scene</h3><p>Our story starts in late 2016 after some of our backend developers received new laptops to work on. After a few days Enguerrand Decorne noticed unusual crashes during compilation of our OCaml codebase.</p><p>This issue, considered mildly annoying at first, seemed to affect only Enguerrand&rsquo;s machine. For a few days no other machine would exhibit the same behavior, so we figured this was a fault specific to his system configuration.</p><p>However, concerns were subsequently raised after witnessing the generation of invalid machine code and later on, after the deployment of a service on one of our new clusters composed of Skylake Xeon processors, leading to the insertion of corrupted data into our storage system. The priority raised from the annoying level, to potentially critical. Other developers started working together to obtain more information and assess the impact on our infrastructure. Soon after we were able to reproduce the issue on several machines.</p><p>The remainder of this post is a technical description of the steps taken to ensure that our systems were operating safely. It is intended to show that such low level CPU issues is not necessarily fatal&#8202;&mdash;&#8202;in less than two weeks, with the great help of core OCaml developers, we identified the conditions of the crash and set up a workaround.</p><h3>Tracking down crashes in&nbsp;OCaml</h3><p>Most of our backend code is written in <a href="https://ocaml.org">OCaml</a>, a high level and expressive language supporting functional programming style (among others), which allows us to develop robust systems with ease, thanks to its strong type system and mature&nbsp;legacy.</p><p>The compiler segfaults were definitely a surprise, since this shouldn&rsquo;t happen for any program written in OCaml, as type system and other features (such as automatic bounds-checking) usually guard us from such errors. However, stack overflows can be possible sources of segfault (when a non-optimal recursion is running too deep), so our first intuition was to increase the stack size when running the compiler. This didn&rsquo;t change anything, and the reported fault address wasn&rsquo;t anywhere near the stack address&nbsp;bound.</p><p>Before witnessing the crash on other machines, we suspected a failure in the virtualization software used by our two developers that were able to reproduce the crash, who use VMware as a part of their development workflow. We tried early on to switch to Virtualbox, but the migration proved itself fruitless as the crashes kept appearing. After a short while we began encountering the same issue on physical machines, so we ruled out a possible virtualization software&nbsp;bug.</p><p>The usual debugging process for crashing OCaml code didn&rsquo;t prove effective&#8202;&mdash;&#8202;we needed to narrow down our approach.</p><p>OCaml ships with <a href="https://realworldocaml.org/v1/en/html/the-compiler-backend-byte-code-and-native-code.html">two backend implementations</a>: a bytecode interpreter and a native compiler. We were able to reproduce the issue using both a native compiler and a compiler running on the bytecode interpreter. Consequently, this ruled out a miscompilation coming from the code <em>emitted</em> by the compiler, the OCaml runtime <em>itself</em> was misbehaving.</p><p>The runtime code is written in C, and implements low level functionalities, including the garbage collector used by both backends. After rebuilding the runtime with debug symbols, we were able to retrieve a proper stack trace and core dump. The stack trace pointed to the garbage collector&rsquo;s mark phase. OCaml&rsquo;s GC is a classic generational mark and sweep collector. The mark phase walks the heap starting from pointers on the stack and other registered root values, and marks every reachable block of&nbsp;memory.</p><p>Further inspection with <strong><em>gdb</em></strong> of the frame and address of crash revealed that the marking code encountered a corrupted block header with invalid size information, causing what looked like a buffer overrun error. Each memory block allocated in OCaml heap begins with a header word, storing metadata used by the GC, including a tag describing the kind of value present in this memory block. The header contains the size of the block, and the crash happened when the mark code was attempting to scan an array which was supposed to be more than 1TB&nbsp;large.</p><p>This was obviously not the cause of the problem but rather the consequence: something corrupted the header word after this block had been properly allocated, postponing the crash until the next GC cycle. It was the right time to escalate <a href="https://caml.inria.fr/mantis/view.php?id=7452">the issue to the OCaml bugtracker</a>, after isolating a proper test case to reproduce the&nbsp;issue.</p><h3>A set of strange&nbsp;leads</h3><p>Escalating the issue to Mantis made us to take a step back and gather our findings, and we quickly got great feedback from the OCaml core&nbsp;team.</p><p>At this point, what does the problem look&nbsp;like?</p><p>We only had sparse information, but <strong><em>dmesg</em></strong> gave us interesting data point. When a page fault occurs and the kernel detects an incorrect memory access, it logs a line in kernel log buffer containing the fault address, the instruction pointer and stack&nbsp;pointer.</p><p>[22985.879907] ocamlopt.opt[48221]: segfault at af8 ip 00005564455169bd sp 00007ffc9f36b130 error 4 in ocamlopt.opt[556445006000+613000]</p><p>Next to the 3 addresses, already available in the coredumps, an error code is reported. This number in decimal form is actually a bitset, and the flags are documented in the Linux kernel sources in <a href="https://github.com/torvalds/linux/blob/v4.11/arch/x86/mm/fault.c#L41">arch/x86/mm/fault.c</a>. Error 4 can thus be read as a read access page fault from user mode, trying to read memory which had not been previously mmap&rsquo;ed.</p><p>Error codes reported following our crashes involved protection faults or access to unmapped addresses, which corroborated our earlier buffer overrun hypothesis. More interestingly we witnessed a crash with the PF_RSVD flag enabled. This left us puzzled, none of us had ever seen such fault before. Apparently it indicates that the the page table was somehow corrupted, with some entries having non-zero bits reserved by the x86 architecture specification.</p><p>It was scary that the corruption would escape the process address space, and to our limited knowledge, it could only have been caused by kernel issue or potentially hardware issues, like memory errors. Yet we were able to reproduce this on several machines with different kernel version, and different hardware. We blamed virtual machines earlier but this theory was debunked already. We still have no explanation at this time, and pursuit on this front would require intimate knowledge of virtual memory implementations that we didn&rsquo;t&nbsp;have.</p><p>One developer wasn&rsquo;t able to reproduce the problem at all on his machine after hours of testing, but something was fishy: it didn&rsquo;t sound right that an OCaml runtime bug would be able to modify the page table. Maybe it was some corner case with reserved addresses, but this something was beyond our reach here. Out of ideas, it was time to get some assistance from tools intended to track memory corruptions, like <a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">asan and&nbsp;ubsan</a>.</p><p>Running <strong><em>Asan</em></strong> didn&rsquo;t yield any meaningful results. <strong><em>Valgrind</em></strong> was later tried, following advises from the OCaml team, but every tools were preventing the crash. Quickly reproducing the bug for testing required running code in a loop, keeping the CPU and memory fully&nbsp;busy.</p><p>This was harder to do on developers machines, due to limited resources and other processes running, and Address Sanitizer would only increase the resources usage. Dedicating a powerful server would make further investigations more comfortable, and increase the likeliness of reproducing with instrumented code.</p><p>But with great surprise, it was not possible to reproduce the problem on a server machine, with and without instrumented code. This is when we realised that all the machines exhibiting the crashes were running a processor of the Intel Skylake processors family, while the server and other developer machines had CPUs from the Broadwell family.</p><h3>The hardware, an unusual&nbsp;suspect</h3><p>In the meantime several core OCaml developers had been closely investigating the issue and started auditing recent changes in the runtime, and identified a few suspicious changes and known&nbsp;bugs.</p><p>Certainly they were more qualified for this task, but it acted as an incentive to examine the history of this bug from our angle. At first, we had assumed that the bug was specific to the new laptop with virtual machines. This could not explain why the crash never manifested on older workstations equipped with Skylake processors. Several other developers had been using them for a few months, and only noticed the crash after awareness of the issue had been raised by Enguerrand.</p><p>What had changed, besides Skylake? Only a few week before, an internal migration from OCaml version 4.02.3 to 4.03.0 was rolled out in our codebase. Intrigued, we went ahead and tested OCaml 4.02.3 again, which showed no memory corruptions after several tests. It was time to browse the <a href="https://raw.githubusercontent.com/ocaml/ocaml/trunk/Changes">OCaml changelog</a> for runtime related entries. The search stopped quickly on a promising item in the list: the OCaml C runtime build optimisation level had been increased to -O2 from&nbsp;-O1.</p><p>Could the optimizations dig out an undefined behavior in C code, leading to bad assumptions in the GC code corrupting the heap&nbsp;? Rebuilding the runtime with -O1did not corrupt memory, so the source of the corruption was in the runtime <em>and</em> was triggered by some gcc specific optimization pass. This sounded like undefined behavior, although the information we had led us to some hardware&nbsp;bug.</p><p>The next day, Xavier Leroy commented on the bugreport reporting that the crash had been observed in the past. Another industrial OCaml user was affected, and they had discovered HyperThreading was part of the necessary conditions. After running the test case for several hours on several machines with HT disabled in the UEFI setup, it was clear we were facing a similar situation. This led to the hypothesis of a hardware&nbsp;bug:</p><blockquote><em>Is it crazy to imagine that gcc -O2 on the OCaml 4.03 runtime produces a specific instruction sequence that causes hardware issues in (some steppings of) Skylake processors with hyperthreading? Perhaps it is&nbsp;crazy.</em></blockquote><p>This possibility had struck us too, motivated by the HyperThreading, the page table corruption and the Skylake specific set of conditions.</p><p>This issue had certainly a strange profile. But nobody was ready to fully embrace the cpu bug hypothesis yet. We convinced ourselves that disabling HT could affect cache pressure and unfold some undefined behaviours.</p><p>HT could also explain the non-determinism, since cache pressure would depend on timings and scheduling. None of us had sufficient experience in this area to assess the strength of such hypothesis, and we did not quite buy it on a single threaded OCaml program. Our debugging motto claims that &ldquo;assumptions are not&nbsp;facts&rdquo;.</p><p>It was time to browse Intel errata list and attempt to update the CPU microcode. Although, the errata descriptions are formulated in vague terms, none of the issues disclosed at this time were looking similar to the situation under investigation. Unfortunately, CPUs microcode had no fix waiting for us either. OCaml developers investigated the errata list from their side but the lack of detailed information turned this into a fruitless and complex&nbsp;task.</p><p>In the absence of better alternative, we focused our work on pinpointing the exact source of the crash as if it was a software bug, in the hope of either finding a code issue or ruling out this hypothesis while getting more detailed data. We needed a way to identify the problematic code and find a workaround. From our side, it was not only a matter of finding whether or not there was a bug in OCaml code, but more crucially we needed a guarantee on the quality of our generated code running critical services in production.</p><h3>Identifying the offending code</h3><p>The other OCaml user affected by this issue reported that they had solved the problem by switching to another C compiler. Building the runtime with clang instead of GCC would prevent the GC from crashing. They also suggested to obtain a diff of the generated assembly. Indeed, once built with clang, the runtime would not crash. But clang generates widely different assembly from GCC and we did not have the resources to analyse several hundred thousand lines of&nbsp;changes.</p><p>If we could isolate the problematic C code, comparing the generated code would be easier. The problem had the form of a well known&nbsp;nail:</p><ul><li>Around 50 C files composing the OCaml&nbsp;runtime,</li><li>There is a good state (when built with gcc&nbsp;-O1)</li><li>And a bad state (when built with gcc&nbsp;-O2)</li></ul><p>This nail comes with a precious hammer: bisection.</p><p>The bisection approach had a downside in this occasion. Any state can be labeled bad with certainty as soon as the test crashes, but we would need to wait several hours to be confident enough to trust a non crashing test as good data-point. The reproducibility was not always consistent and a non-crashing state could be a false negative still waiting to trigger the conditions leading to the crash. A reduction of search space was necessary.</p><p>All the coredumps we had showed that the fault was caused by a corrupted heap block header, and our testcase involved the compiler. The OCaml compiler is not 100% deterministic, and IO/s primitives and unix environment in the runtime can affect timings and allocation patterns. But it sounded sensible to assume that the code corrupting a heap header block was also the code reading and writing those blocks: the major&nbsp;GC.</p><p>This hypothesis made bisecting fast: the first file we tried, <strong><em>major_gc.c</em></strong>, turned out to be the one. To make sure it was not a subtle issue in linker, reordering symbols or code blocks, we tried a few others files and confirmed changing the optimization level of some other files alone made no difference.</p><p>But the generated code difference was still way too large. Bringing this topic up on the <a href="http://webchat.freenode.net/?channels=#ocaml">OCaml IRC</a> discussion channel led to some useful inputs. We were taught that gcc supports an attribute to enable specific optimizations at the function level, using __attribute__((optimize(&quot;options,...&quot;))). Following the same strategy, it was easy to trace the source of the malfunctioning code to the <strong><em>sweep_slice</em></strong> function, which implements the sweeping phase of the classic mark and sweep garbage collector for the old generation.</p><p>Ignoring the subtle details of incremental GC, the <strong><em>sweep_slice</em></strong> function is the last pass of a normal major collection cycle. It is responsible for scanning all blocks in the major heap, and reclaiming unreachable blocks to the list of unallocated space.</p><p>The bulk of this function is a switch taking action for each block depending on its status&nbsp;:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/cfbc19fddccc5f2c1a76fcc802fae049/href">https://medium.com/media/cfbc19fddccc5f2c1a76fcc802fae049/href</a></iframe><p>This finding felt consistent with the information at hand. When the block is reachable, the color (describing the reachability status of the block) is reset. If the block became unreachable (<em>while color</em>) - it is reclaimed. In both cases, the block header is modified.</p><p>Getting back to the assembly&nbsp;diff.</p><p>Nobody in the team knows a great deal about assembly and we only have a really basic understanding of most of the instructions used in both versions. It quickly became obvious that the noise level in this diff, with thousands of lines of changed, was still too high for us to spot anything related to the problem. This problem was getting far beyond the common knowledge of everyone in the&nbsp;team.</p><p>But this was still sounding like your day to day bug tracking process. The less you know, the more careful you need to be, tackling the problem step by step. We stuck to what approach had served us well until now: bisecting.</p><p>We went through the list of optimisation passes enabled by GCC at -O2. This is a fair amount of optimisation passes and it would have been too time consuming to try them one by one, given the time needed to trigger the crash. Yet we had a hint: a memory corruption was happening semi randomly in the garbage collector. We were also keeping the undefined behaviour bug as a potential explanation. It was likely a pass which would change the structure of the code, reordering blocks and changing conditions.</p><p>After reading the description of all switches in the detailed gcc manual, the -ftree-* pass family looked promising. This set of transformations works on the <a href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA form</a> internal representation, a widespread intermediate language representation which has the benefit of being easy to read. They seem to make a huge impact on the generated assembly code, moving code blocks around and making assumptions on code invariants in order to move around, simplify or eliminate conditional checks altogether.</p><p>By looking at output of those passes on the related source code, we narrowed down the list of transformations to a couple of interesting passes, one of them being -ftree-vrp, which stands for Value Range Propagation. This pass computes bounds for each name binding and propagates proofs that a value must lie in a given&nbsp;range.</p><p>It turned out most of the other passes depended on it for further optimisations. Even though the issue ended up not being a bad assumptions in the range values, checking this pass proved to be worthwhile: enabling -ftree-vrp on <strong><em>sweep_slice</em></strong> function while every thing else was built with -O1 was enough to trigger a&nbsp;crash.</p><p>GCC provides very good diagnostics output, and after reading the manual we found the -fdump-tree-* switch to dump the SSA form before and after specific pass. The output is designed to be read by a human and provides meaningful naming, with source code locations, alongside the ranges propagated by the VRP pass. We spent some time studying the output and matched the difference in SSA tree between the crashing and not crashing&nbsp;code.</p><p>Examining the bounds and invariants derived by gcc, it was clear that no wrong hypothesis was&nbsp;stated.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/a5a311d0b5a4f890f9541f0aed91e73e/href">https://medium.com/media/a5a311d0b5a4f890f9541f0aed91e73e/href</a></iframe><p>The only meaningful observable change involves the suppression of rechecking the loop condition in the else branch of the <strong><em>sweep_slice</em></strong> function, after Value Range Propagation proved that the condition was invariant in this&nbsp;branch.</p><p>Often, reading the code carefully is the fastest way to find a bug. But after spending hours staring at the major GC code, it was clear enough that this check removal should not cause any semantic&nbsp;changes.</p><p>In this process, we identified a suspicious bit of code, where a signed long variable was promoted to unsigned according to C standard rules, which was changing the bounds derived by gcc, assuming it was always positive. But after some thinking we realised it made no difference at assembly level and although wrong, this assumption was not used anywhere.</p><p>We were now ready to rule out the possibility of a bug in OCaml runtime. It was still possible that GCC backend had a bug and was miscompiling this particular shape of code. And we were back at the assembly level again. After writing some awk formatting script to cleanup assembly and minimise noise in the diff (by renaming labels, detecting spurious code move, etc), and preventing inlining, we found a minimal assembly patch causing the&nbsp;crash.</p><p>There were only cosmetic differences. The test removal was propagated down to assembly and caused gcc to reorganise the layout of each switch case&nbsp;block.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/532ab4896b11177a96203fd0c81eaa58/href">https://medium.com/media/532ab4896b11177a96203fd0c81eaa58/href</a></iframe><p>Among those minor differences and changes of layout, we noticed a particular change which impacted exactly the reachable block header updated which could have caused header corruption. In the unoptimised version, the updating code looked like&nbsp;this:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/38ca30a1decf86233084721c3803b1c4/href">https://medium.com/media/38ca30a1decf86233084721c3803b1c4/href</a></iframe><p>For some reason, the block pointer was spilled to the&nbsp;stack.</p><p>Perhaps naively, and because we had earlier emitted the hypothesis of HT impacting cache pressure, we spent a few hours staring at this code and check if we were missing something subtle which could affect the control flow of the whole function and the stack location from which it was reloaded could be corrupted.</p><p>Despite our lack of assembly knowledge, after spending several hours reading this tiny change, we got convinced that it made strictly no semantic difference. Reading the x86 manual carefully didn&rsquo;t give any hint on any subtle behavior which would trigger. Executing any of those two sequence of instruction should give the exact same&nbsp;output.</p><h3>Mitigating the&nbsp;issue</h3><p>We were now quite certain it was a CPU&nbsp;bug.</p><p>The OCaml developers had reached the same conclusion, and were working on escalating the issue to Intel. After internal discussions we decided to keep this bug as low profile as possible since we were unsure about potential security implications, especially for JIT implementations.</p><p>Even if we had no confirmation at this point nor any explanations of the cause of this bug, which was beyond our reach, we could take&nbsp;actions.</p><p>The first step was to decide against getting any new Skylake based servers until further announcement. We were left with several Skylake machines but we refrained from deploying any OCaml code on them. OCaml comes with a great package manager, <a href="https://opam.ocaml.org/">opam</a>, which supports compiler switches. Switches allow to set up a clean and distinct environment with specific packages and compiler configuration.</p><p>We patched our internal opam repository to distribute unoptimised runtime to all developers and moved forward, waiting for further announcements.</p><p>This situation made us realise that microcode requires constant updates, just like any other software in the stack. We raised awareness on this topic in our devops team, and they took measure to ensure we could roll out updates to prod&nbsp;easily.</p><h3>Happy end</h3><p>In late May, devops team noticed a <a href="http://metadata.ftp-master.debian.org/changelogs/non-free/i/intel-microcode/intel-microcode_3.20170511.1_changelog">debian package update for intel-microcode</a> containing the following change:</p><pre>Likely fix nightmare-level Skylake erratum SKL150. Fortunately,<br/>either this erratum is very-low-hitting, or gcc/clang/icc/msvc<br/>won&rsquo;t usually issue the affected opcode pattern and it ends up<br/>being rare.<br/>SKL150 &mdash; Short loops using both the AH/BH/CH/DH registers and<br/>the corresponding wide register *may* result in unpredictable<br/>system behavior. Requires both logical processors of the same<br/>core (i.e. sibling hyperthreads) to be active to trigger, as<br/>well as a &ldquo;complex set of micro-architectural conditions&rdquo;</pre><p>The erratum description immediately rang a bell as it matched the diff in the assembly we had observed. We tested the microcode update and confirmed it fixed the corruption.</p><p>Finally, our Skylake CPUs were feeling safe and OCaml compiler was&nbsp;happy.</p><p><a href="https://ahrefs.com"><em>Ahrefs</em></a><em> runs an internet-scale bot that crawls the whole Web 24/7. Our backend system is powered by a custom petabyte-scale distributed key-value storage implemented in OCaml (and some C++ and Rust). We are a small team and strongly believe in better technology leading to better solutions for real-world problems. We worship functional languages and static typing, extensively employ code generation and meta-programming, value code clarity and predictability, and are constantly seeking to automate repetitive tasks and eliminate boilerplate. And we are&nbsp;</em><a href="https://ahrefs.com/jobs"><em>hiring</em></a><em>!</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=ab1ad2beddcd" width="1" height="1" alt=""/><hr/><p><a href="https://tech.ahrefs.com/skylake-bug-a-detective-story-ab1ad2beddcd">Skylake bug: a detective story</a> was originally published in <a href="https://tech.ahrefs.com">ahrefs</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>|js}
  };
 
  { title = {js|When Bash Scripts Bite|js}
  ; slug = {js|when-bash-scripts-bite|js}
  ; description = Some {js|There are abundant resources online trying to scare programmers away from usingshell scripts. Most of them, if anything, succeed in convincing the reader tob...|js}
  ; url = {js|https://blog.janestreet.com/when-bash-scripts-bite/|js}
  ; date = {js|2017-05-11T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>There are abundant resources online trying to scare programmers away from using
shell scripts. Most of them, if anything, succeed in convincing the reader to
blindly put something that resembles</p>|js}
  };
 
  { title = {js|Looking for a technical writer|js}
  ; slug = {js|looking-for-a-technical-writer|js}
  ; description = Some {js|Update: I’m excited to say that we’ve now hired a (great!) technicalwriter, so the position is closed.|js}
  ; url = {js|https://blog.janestreet.com/looking-for-a-technical-writer/|js}
  ; date = {js|2017-05-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p><em>Update: I&rsquo;m excited to say that we&rsquo;ve now hired a (great!) technical
writer, so the position is closed.</em></p>|js}
  };
 
  { title = {js|Caveat Configurator: how to replace configs with code, and why you might not want to|js}
  ; slug = {js|caveat-configurator-how-to-replace-configs-with-code-and-why-you-might-not-want-to|js}
  ; description = Some {js|We have a new tech talk coming up onMay 17th, from our very own Dominick LoBraico. This one is about how torepresent configurations with programs. In some se...|js}
  ; url = {js|https://blog.janestreet.com/caveat-configurator-how-to-replace-configs-with-code-and-why-you-might-not-want-to/|js}
  ; date = {js|2017-04-25T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/caveat-configurator-how-to-replace-configs-with-code-and-why-you-might-not-want-to/dominick-talk.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We have a new <a href="https://www.janestreet.com/tech-talks/">tech talk</a> coming up on
May 17th, from our very own Dominick LoBraico. This one is about how to
represent configurations with programs. In some sense, this is an obvious idea.
Lots of programmers have experienced the dysphoria that comes from watching your
elegant little configuration format metamorphize into a badly constructed
programming language with miserable tools. This happens because, as you try to
make your configs clearer and more concise, you often end up walking down the
primrose path of making your config format ever more language-like. But you
never really have the time to make it into a proper language.</p>|js}
  };
 
  { title = {js|This is not the performance you were looking for: the tricks systems play on us|js}
  ; slug = {js|this-is-not-the-performance-you-were-looking-for-the-tricks-systems-play-on-us|js}
  ; description = Some {js|It’s often surprising just how much software performance depends on how thesoftware is deployed. All the time and effort you’ve invested in optimizationcan b...|js}
  ; url = {js|https://blog.janestreet.com/this-is-not-the-performance-you-were-looking-for-the-tricks-systems-play-on-us/|js}
  ; date = {js|2017-04-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>It&rsquo;s often surprising just how much software performance depends on how the
software is deployed. All the time and effort you&rsquo;ve invested in optimization
can be erased by a few bad decisions in scheduler policy, affinity, or
background workload on a server.</p>|js}
  };
 
  { title = {js|Trivial meta-programming with cinaps|js}
  ; slug = {js|trivial-meta-programming-with-cinaps|js}
  ; description = Some {js|From now and then, I found myself having to write some mechanical and repetitivecode. The usual solution for this is to write a code generator; for instance ...|js}
  ; url = {js|https://blog.janestreet.com/trivial-meta-programming-with-cinaps/|js}
  ; date = {js|2017-03-20T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>From now and then, I found myself having to write some mechanical and repetitive
code. The usual solution for this is to write a code generator; for instance in
the form of a ppx rewriter in the case of OCaml code. This however comes with a
cost: code generators are harder to review than plain code and it is a new
syntax to learn for other developers. So when the repetitive pattern is local to
a specific library or not widely used, it is often not worth the effort.
Especially if the code in question is meant to be reviewed and maintained by
several people.</p>|js}
  };
 
  { title = {js|One more talk, two more videos|js}
  ; slug = {js|one-more-talk-two-more-videos|js}
  ; description = Some {js|I’m happy to announce our next public techtalk, called SevenImplementations of Incremental, on Wednesday, April 5th, presented by yourstruly. You can registe...|js}
  ; url = {js|https://blog.janestreet.com/one-more-talk-two-more-videos/|js}
  ; date = {js|2017-03-15T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;m happy to announce our next <a href="https://events.janestreet.com/home/tech-talks/">public tech
talk</a>, called <strong>Seven
Implementations of Incremental</strong>, on Wednesday, April 5th, presented by yours
truly. You can register
<a href="https://docs.google.com/forms/d/e/1FAIpQLSdtly4y-jYcLUVH8BJS-uKoiaKrQlRXSIWZeczw3tgwTx_6HA/viewform?c=0&amp;w=1">here</a>.</p>|js}
  };
 
  { title = {js|What a Jane Street software engineering interview is like|js}
  ; slug = {js|what-a-jane-street-software-engineering-interview-is-like|js}
  ; description = Some {js|Are you thinking aboutapplying to Jane Streetfor a software engineering role? Or already have a phone interview scheduled but unsurewhat to expect? Read on a...|js}
  ; url = {js|https://blog.janestreet.com/what-a-jane-street-dev-interview-is-like/|js}
  ; date = {js|2017-02-28T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Are you thinking about
<a href="https://www.janestreet.com/join-jane-street/apply/">applying</a> to Jane Street
for a software engineering role? Or already have a phone interview scheduled but unsure
what to expect? Read on as we walk through an example phone interview with you.</p>|js}
  };
 
  { title = {js|Jane Street Tech Talks: Verifying Puppet Configs|js}
  ; slug = {js|jane-street-tech-talks-verifying-puppet-configs|js}
  ; description = Some {js|Our first Jane Street Tech Talk went really well!Thanks to everyone who came and made it a fun event.|js}
  ; url = {js|https://blog.janestreet.com/jane-street-tech-talks-verifying-puppet-configs/|js}
  ; date = {js|2017-02-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/jane-street-tech-talks-verifying-puppet-configs/untangling_puppet.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Our first <a href="https://blog.janestreet.com/how-to-build-an-exchange/">Jane Street Tech Talk</a> went really well!
Thanks to everyone who came and made it a fun event.</p>|js}
  };
 
  { title = {js|How to Build an Exchange|js}
  ; slug = {js|how-to-build-an-exchange|js}
  ; description = Some {js|UPDATE: We are full up. Tons of people signed up for the talk, and we’renow at the limit of what we feel like we can support in the space. Thanks forall the ...|js}
  ; url = {js|https://blog.janestreet.com/how-to-build-an-exchange/|js}
  ; date = {js|2017-01-11T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/how-to-build-an-exchange/build_exchange.jpg|js}
  ; featured = false
  ; body_html = {js|<p><strong>UPDATE</strong>: <em>We are full up. Tons of people signed up for the talk, and we&rsquo;re
now at the limit of what we feel like we can support in the space. Thanks for
all the interest, and if you didn&rsquo;t get into this one, don&rsquo;t worry, we have more
talks coming!</em></p>|js}
  };
 
  { title = {js|A brief trip through Spacetime|js}
  ; slug = {js|a-brief-trip-through-spacetime|js}
  ; description = Some {js|Spacetime is a new memory profiling facility for OCaml to help find space leaksand unwanted allocations. Whilst still a little rough around the edges, we’vef...|js}
  ; url = {js|https://blog.janestreet.com/a-brief-trip-through-spacetime/|js}
  ; date = {js|2017-01-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/a-brief-trip-through-spacetime/spacetime.jpg|js}
  ; featured = false
  ; body_html = {js|<p>Spacetime is a new memory profiling facility for OCaml to help find space leaks
and unwanted allocations. Whilst still a little rough around the edges, we&rsquo;ve
found it to be a very useful tool. Since there&rsquo;s not much documentation for
using spacetime beyond <a href="https://github.com/lpw25/prof_spacetime/blob/master/Readme.md">this
readme</a>, I&rsquo;ve
written a little intro to give people an idea of how to use it.</p>|js}
  };
 
  { title = {js|A solution to the ppx versioning problem|js}
  ; slug = {js|a-solution-to-the-ppx-versioning-problem|js}
  ; description = Some {js|Ppx is a preprocessing system for OCaml where one maps over the OCaml abstractsyntax tree (AST) to interpret some special syntax fragments to generate code.|js}
  ; url = {js|https://blog.janestreet.com/an-solution-to-the-ppx-versioning-problem/|js}
  ; date = {js|2016-11-08T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Ppx is a preprocessing system for OCaml where one maps over the OCaml abstract
syntax tree (AST) to interpret some special syntax fragments to generate code.</p>|js}
  };
 
  { title = {js|Observations of a functional programmer|js}
  ; slug = {js|observations-of-a-functional-programmer|js}
  ; description = Some {js|I was recently invited to do the keynote at the Commercial Users of FunctionalProgramming workshop, a 15-year-old gathering which isattached to ICFP, the pri...|js}
  ; url = {js|https://blog.janestreet.com/observations-of-a-functional-programmer/|js}
  ; date = {js|2016-10-27T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I was recently invited to do the keynote at the <a href="http://cufp.org/2016/">Commercial Users of Functional
Programming</a> workshop, a 15-year-old gathering which is
attached to ICFP, the primary academic functional programming conference.</p>|js}
  };
 
  { title = {js|What the interns have wrought, 2016|js}
  ; slug = {js|what-the-interns-have-wrought-2016|js}
  ; description = Some {js|Now that the interns have mostly gone back to school, it’s a good time to lookback at what they did while they were here. We had a bumper crop – more than 30...|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-2016/|js}
  ; date = {js|2016-09-13T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Now that the interns have mostly gone back to school, it&rsquo;s a good time to look
back at what they did while they were here. We had a bumper crop &ndash; more than 30
dev interns between our London, New York and Hong Kong offices &ndash; and they
worked on just about every corner of our code-base.</p>|js}
  };
 
  { title = {js|Unraveling of the tech hiring market|js}
  ; slug = {js|unraveling-of-the-tech-hiring-market|js}
  ; description = Some {js|Recruiting talented people has always been challenging.|js}
  ; url = {js|https://blog.janestreet.com/unraveling/|js}
  ; date = {js|2016-08-31T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Recruiting talented people has always been challenging.</p>|js}
  };
 
  { title = {js|Do you love dev tools? Come work at Jane Street.|js}
  ; slug = {js|do-you-love-dev-tools-come-work-at-jane-street|js}
  ; description = Some {js|In the last few years, we’ve spent more and more effort working on developertools, to the point where we now have a tools-and-compilers group devoted to thea...|js}
  ; url = {js|https://blog.janestreet.com/do-you-love-dev-tools-come-work-at-jane-street/|js}
  ; date = {js|2016-08-30T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>In the last few years, we&rsquo;ve spent more and more effort working on developer
tools, to the point where we now have a tools-and-compilers group devoted to the
area, for which we&rsquo;re actively hiring.</p>|js}
  };
 
  { title = {js|Let syntax, and why you should use it|js}
  ; slug = {js|let-syntax-and-why-you-should-use-it|js}
  ; description = Some {js|Earlier this year, we createda ppx_let, a PPX rewriter thatintroduces a syntax for working with monadic and applicative libraries likeCommand, Async, Result ...|js}
  ; url = {js|https://blog.janestreet.com/let-syntax-and-why-you-should-use-it/|js}
  ; date = {js|2016-06-21T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Earlier this year, we created
a <a href="http://github.com/janestreet/ppx_let">ppx_let</a>, a PPX rewriter that
introduces a syntax for working with monadic and applicative libraries like
Command, Async, Result and Incremental. We&rsquo;ve now amassed about six months of
experience with it, and we&rsquo;ve now seen enough to recommend it to a wider
audience.</p>|js}
  };
 
  { title = {js|ppx_core: context-free rewriters for better semantics and faster compilation|js}
  ; slug = {js|ppxcore-context-free-rewriters-for-better-semantics-and-faster-compilation|js}
  ; description = Some {js|At Jane Street, we have always been heavy users of pre-processors, first withcamlp4 and now ppx. Pre-processing makes the infrastructure a bit more complex,b...|js}
  ; url = {js|https://blog.janestreet.com/ppx_core-context-free-rewriters-for-better-semantic-and-faster-compilation/|js}
  ; date = {js|2016-05-23T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>At Jane Street, we have always been heavy users of pre-processors, first with
camlp4 and now ppx. Pre-processing makes the infrastructure a bit more complex,
but it save us a lot of time by taking care of a lot of tedious boilerplate code
and in some case makes the code a bit prettier.</p>|js}
  };
 
  { title = {js|Seven Implementations of Incremental|js}
  ; slug = {js|seven-implementations-of-incremental|js}
  ; description = Some {js|We finally got a decent recording of one of my favorite talks. This one is aboutour Incremental library (which Iwrote about here), and in particular about th...|js}
  ; url = {js|https://blog.janestreet.com/seven-implementations-of-incremental/|js}
  ; date = {js|2016-03-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/seven-implementations-of-incremental/ron-photo.jpg|js}
  ; featured = false
  ; body_html = {js|<p>We finally got a decent recording of one of my favorite talks. This one is about
our <a href="https://github.com/janestreet/incremental">Incremental</a> library (which I
wrote about <a href="https://blog.janestreet.com/introducing-incremental/">here</a>), and in particular about the
story of how we got to the present, quite performant, implementation.</p>|js}
  };
 
  { title = {js|OCaml 4.03: Everything else|js}
  ; slug = {js|ocaml-403-everything-else|js}
  ; description = Some {js|In my previous post I wrote about Flambda, which is the singlebiggest feature coming to OCaml in this release. In this post, I’ll review theother features of...|js}
  ; url = {js|https://blog.janestreet.com/ocaml-4-03-everything-else/|js}
  ; date = {js|2016-03-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>In my <a href="https://blog.janestreet.com/flambda">previous post</a> I wrote about Flambda, which is the single
biggest feature coming to OCaml in this release. In this post, I&rsquo;ll review the
other features of 4.03 that caught my eye.</p>|js}
  };
 
  { title = {js|A better inliner for OCaml, and why it matters|js}
  ; slug = {js|a-better-inliner-for-ocaml-and-why-it-matters|js}
  ; description = Some {js|OCaml 4.03 is branched and a first release candidate is imminent, so it seemslike a good time to take stock of what’s coming.|js}
  ; url = {js|https://blog.janestreet.com/flambda/|js}
  ; date = {js|2016-02-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>OCaml 4.03 is branched and a first release candidate is imminent, so it seems
like a good time to take stock of what&rsquo;s coming.</p>|js}
  };
 
  { title = {js|Self Adjusting DOM and Diffable Data|js}
  ; slug = {js|self-adjusting-dom-and-diffable-data|js}
  ; description = Some {js|In my last post, I gave some simple examples showing howyou could useself adjusting computations,or SAC, as embodied by our Incremental library, toincrementa...|js}
  ; url = {js|https://blog.janestreet.com/self-adjusting-dom-and-diffable-data/|js}
  ; date = {js|2016-02-10T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>In my last <a href="https://blog.janestreet.com/self-adjusting-dom/">post</a>, I gave some simple examples showing how
you could use
<a href="http://www.umut-acar.org/self-adjusting-computation">self adjusting computations</a>,
or SAC, as embodied by our <a href="https://blog.janestreet.com/introducing-incremental/">Incremental</a> library, to
incrementalize the computation of virtual dom nodes. In this post, I&rsquo;d like to
discuss how we can extend this approach to more realistic scales, and some of
the extensions to Incremental itself that are required to get there.</p>|js}
  };
 
  { title = {js|Self Adjusting DOM|js}
  ; slug = {js|self-adjusting-dom|js}
  ; description = Some {js|I’ve been thinking recently about how tostructure dynamic web applications, and in particular about the role thatincremental computation should play.|js}
  ; url = {js|https://blog.janestreet.com/self-adjusting-dom/|js}
  ; date = {js|2016-02-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;ve been <a href="https://blog.janestreet.com/incrementality-and-the-web/">thinking recently</a> about how to
structure dynamic web applications, and in particular about the role that
incremental computation should play.</p>|js}
  };
 
  { title = {js|Incremental computation and the web|js}
  ; slug = {js|incremental-computation-and-the-web|js}
  ; description = Some {js|I’ve recently been thinking about the world of JavaScript and web applications.That’s odd for me, since I know almost nothing about the web. Indeed, JaneStre...|js}
  ; url = {js|https://blog.janestreet.com/incrementality-and-the-web/|js}
  ; date = {js|2016-01-30T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;ve recently been thinking about the world of JavaScript and web applications.
That&rsquo;s odd for me, since I know almost nothing about the web. Indeed, Jane
Street&rsquo;s use of web technologies is quite minimal &ndash; nearly all of our user
interfaces are text based, and all told we&rsquo;ve been pretty happy with that.</p>|js}
  };
 
  { title = {js|Why OCaml?|js}
  ; slug = {js|why-ocaml|js}
  ; description = None
  ; url = {js|https://blog.janestreet.com/why-ocaml/|js}
  ; date = {js|2016-01-25T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<div class="video-container">
  <iframe src="https://youtube.com/embed/v1CmGbOGb2I?rel=0" width="560" height="315" frameborder="0" allowfullscreen=""></iframe>
</div>|js}
  };
 
  { title = {js|Testing with expectations|js}
  ; slug = {js|testing-with-expectations|js}
  ; description = Some {js|Testing is important, and it’s hard to get people to do as much of it as theyshould. Testing tools matter because the smoother the process is, the more tests...|js}
  ; url = {js|https://blog.janestreet.com/testing-with-expectations/|js}
  ; date = {js|2015-12-02T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Testing is important, and it&rsquo;s hard to get people to do as much of it as they
should. Testing tools matter because the smoother the process is, the more tests
people will write.</p>|js}
  };
 
  { title = {js|Quickcheck for Core|js}
  ; slug = {js|quickcheck-for-core|js}
  ; description = Some {js|Automated testing is a powerful tool for finding bugs and specifying correctnessproperties of code. Haskell’s Quickcheck library is the most well-knownautoma...|js}
  ; url = {js|https://blog.janestreet.com/quickcheck-for-core/|js}
  ; date = {js|2015-10-26T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Automated testing is a powerful tool for finding bugs and specifying correctness
properties of code. Haskell&rsquo;s Quickcheck library is the most well-known
automated testing library, based on over 15 years of research into how to write
property-base tests, generate useful sources of inputs, and report manageable
counterexamples. Jane Street&rsquo;s Core library has not had anything comparable up
until now; version 113.00 of Core finally has a version of Quickcheck,
integrating automated testing with our other facilities like s-expression
reporting for counterexample values, and support for asynchronous tests using
Async.</p>|js}
  };
 
  { title = {js|rsync rounds timestamps to the nearest second|js}
  ; slug = {js|rsync-rounds-timestamps-to-the-nearest-second|js}
  ; description = Some {js|I’m not sure how I’ve managed to use rsync for so many years without evernoticing this, but hey, you learn something new every day!|js}
  ; url = {js|https://blog.janestreet.com/rsync-rounds-timestamps-to-the-nearest-second/|js}
  ; date = {js|2015-10-07T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;m not sure how I&rsquo;ve managed to use rsync for so many years without ever
noticing this, but hey, you learn something new every day!</p>|js}
  };
 
  { title = {js|No (functional) experience required|js}
  ; slug = {js|no-functional-experience-required|js}
  ; description = Some {js|Jane Street is a serious functional programming shop. We use OCaml, a staticallytyped functional language for almost everything and have what is probably the...|js}
  ; url = {js|https://blog.janestreet.com/no-functional-experience-required/|js}
  ; date = {js|2015-08-19T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Jane Street is a serious functional programming shop. We use OCaml, a statically
typed functional language for almost everything and have what is probably the
largest OCaml codebase anywhere.</p>|js}
  };
 
  { title = {js|Introducing Incremental|js}
  ; slug = {js|introducing-incremental|js}
  ; description = Some {js|I’m pleased to announce the release ofIncremental (wellcommented mlihere),a powerful library for building self-adjusting computations, i.e.,computations that...|js}
  ; url = {js|https://blog.janestreet.com/introducing-incremental/|js}
  ; date = {js|2015-07-18T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/introducing-incremental/introducing_incremental.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;m pleased to announce the release of
<a href="https://github.com/janestreet/incremental">Incremental</a> (well
commented mli
<a href="https://github.com/janestreet/incremental/blob/master/src/incremental_intf.ml">here</a>),
a powerful library for building <em>self-adjusting computations</em>, <em>i.e.</em>,
computations that can be updated efficiently when their inputs change.</p>|js}
  };
 
  { title = {js|Converting a code base from camlp4 to ppx|js}
  ; slug = {js|converting-a-code-base-from-camlp4-to-ppx|js}
  ; description = Some {js|As with many projects in the OCaml world, at Jane Street we have been working onmigrating from camlp4 to ppx. After having developed equivalent ppx rewriters...|js}
  ; url = {js|https://blog.janestreet.com/converting-a-code-base-from-camlp4-to-ppx/|js}
  ; date = {js|2015-07-08T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>As with many projects in the OCaml world, at Jane Street we have been working on
migrating from camlp4 to ppx. After having developed equivalent ppx rewriters
for our camlp4 syntax extensions, the last step is to actually translate the
code source of all our libraries and applications from the camlp4 syntax to the
standard OCaml syntax with extension points and attributes.</p>|js}
  };
 
  { title = {js|CPU Registers and OCaml|js}
  ; slug = {js|cpu-registers-and-ocaml|js}
  ; description = Some {js|Even though registers are a low-level CPU concept, having some knowledge aboutthem can help write faster code. Simply put, a CPU register is a storage for as...|js}
  ; url = {js|https://blog.janestreet.com/cpu-registers-and-ocaml-2/|js}
  ; date = {js|2015-05-05T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Even though registers are a low-level CPU concept, having some knowledge about
them can help write faster code. Simply put, a CPU register is a storage for a
single variable. CPU can keep data in memory or cache or in registers and
registers are often much faster. Furthermore, some operations are possible only
when the data is in registers. Hence, the OCaml compiler tries to keep as many
variables as it can in the registers.</p>|js}
  };
 
  { title = {js|Reverse web proxy in ~50 lines of BASH|js}
  ; slug = {js|reverse-web-proxy-in-50-lines-of-bash|js}
  ; description = Some {js|In the spirit of reinventing the wheel for fun, I hacked this together as aquick challenge to myself last week. It’s a little rough around the edges, but Ith...|js}
  ; url = {js|https://blog.janestreet.com/reverse-web-proxy-in-50-lines-of-bash/|js}
  ; date = {js|2015-05-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>In the spirit of reinventing the wheel for fun, I hacked this together as a
quick challenge to myself last week. It&rsquo;s a little rough around the edges, but I
thought it was too cute not to share. If you have any bug fixes, please post
them in the comments.</p>|js}
  };
 
  { title = {js|Building a lower-latency GC|js}
  ; slug = {js|building-a-lower-latency-gc|js}
  ; description = Some {js|We’ve been doing a bunch of work recently on improving the responsiveness ofOCaml’s garbage collector. I thought it would be worth discussing thesedevelopmen...|js}
  ; url = {js|https://blog.janestreet.com/building-a-lower-latency-gc/|js}
  ; date = {js|2015-04-10T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>We&rsquo;ve been doing a bunch of work recently on improving the responsiveness of
OCaml&rsquo;s garbage collector. I thought it would be worth discussing these
developments publicly to see if there was any useful feedback to be had on the
ideas that we&rsquo;re investigating.</p>|js}
  };
 
  { title = {js|Faster OCaml to C calls|js}
  ; slug = {js|faster-ocaml-to-c-calls|js}
  ; description = Some {js|The official OCaml documentation “Interfacing C withOCaml” doesn’tdocument some interesting performance features.|js}
  ; url = {js|https://blog.janestreet.com/faster-ocaml-to-c-calls/|js}
  ; date = {js|2015-04-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>The official OCaml documentation <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/intfc.html">&ldquo;Interfacing C with
OCaml&rdquo;</a> doesn&rsquo;t
document some interesting performance features.</p>|js}
  };
 
  { title = {js|Why GADTs matter for performance|js}
  ; slug = {js|why-gadts-matter-for-performance|js}
  ; description = Some {js|When GADTs (Generalized Algebraic DataTypes) landed inOCaml, I wasn’t particularly happy about it. I assumed that it was the kind ofnonsense you get when you...|js}
  ; url = {js|https://blog.janestreet.com/why-gadts-matter-for-performance/|js}
  ; date = {js|2015-03-30T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>When GADTs (<a href="http://en.wikipedia.org/wiki/Generalized_algebraic_data_type">Generalized Algebraic Data
Types</a>) landed in
OCaml, I wasn&rsquo;t particularly happy about it. I assumed that it was the kind of
nonsense you get when you let compiler writers design your programming language.</p>|js}
  };
 
  { title = {js|A lighter Core|js}
  ; slug = {js|a-lighter-core|js}
  ; description = Some {js|We recently released a version of our open source libraries with a muchanticipatedchange– Async_kernel, the heart of the Async concurrent programming library...|js}
  ; url = {js|https://blog.janestreet.com/a-lighter-core/|js}
  ; date = {js|2015-03-21T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>We recently released a version of our open source libraries with a much
anticipated
<a href="https://github.com/janestreet/async_kernel/commit/bf11c4211595b2589b6517aefafceb2ad3bdc0fd">change</a>
&ndash; Async_kernel, the heart of the Async concurrent programming library, now
depends only on Core_kernel rather than on Core.</p>|js}
  };
 
  { title = {js|Centralizing distributed version control, revisited|js}
  ; slug = {js|centralizing-distributed-version-control-revisited|js}
  ; description = Some {js|7 years ago, I wrote a blogpostabout how we at Jane Street were using our distributed version control system(hg, though the story would be the same for git) ...|js}
  ; url = {js|https://blog.janestreet.com/centralizing-distributed-version-control-revisited/|js}
  ; date = {js|2015-03-04T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>7 years ago, I wrote a <a href="https://blog.janestreet.com/centralizing-distributed-version-control/" title="Centralizing Distributed Version Control">blog
post</a>
about how we at Jane Street were using our distributed version control system
(<code class="highlighter-rouge">hg</code>, though the story would be the same for <code class="highlighter-rouge">git</code>) in a partially centralized
way. Essentially, we built a centralized repo and a continuous integration
system whose job was to merge in new changesets. The key responsibility of this
system was to make sure that a change was rejected unless it merged, compiled
and <a href="http://graydon2.dreamwidth.org/1597.html" title="The Not Rocket Science Rule">tested
cleanly</a>.</p>|js}
  };
 
  { title = {js|Making making better|js}
  ; slug = {js|making-making-better|js}
  ; description = Some {js|We spend a lot of time and effort on training new people, and it never stops forlong. Right now our winter-intern class is ending; in five months we’ll have ...|js}
  ; url = {js|https://blog.janestreet.com/making-making-better/|js}
  ; date = {js|2015-01-31T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>We spend a lot of time and effort on training new people, and it never stops for
long. Right now our winter-intern class is ending; in five months we&rsquo;ll have a
slew of new interns to get up to speed, and a few months after that we&rsquo;ll have
an incoming class of new hires.</p>|js}
  };
 
  { title = {js|13 Virtues|js}
  ; slug = {js|13-virtues|js}
  ; description = Some {js|Very early on in his life, while on lengthy voyage from London to Philadelphia,Ben Franklin created a system of thirteen virtues to live his life by. He spen...|js}
  ; url = {js|https://blog.janestreet.com/13-virtues/|js}
  ; date = {js|2015-01-02T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Very early on in his life, while on lengthy voyage from London to Philadelphia,
Ben Franklin created a system of thirteen virtues to live his life by. He spent
the remainder of his days giving special focus to one virtue per week in a 13
week cycle, as well as noting the virtues he failed to live up to at the end of
each day.</p>|js}
  };
 
  { title = {js|Inspecting the Environment of a Running Process|js}
  ; slug = {js|inspecting-the-environment-of-a-running-process|js}
  ; description = Some {js|Sometimes its useful to be able see the values of environment variables inrunning processes. We can use the following test program to see how well we canacco...|js}
  ; url = {js|https://blog.janestreet.com/inspecting-the-environment-of-a-running-process/|js}
  ; date = {js|2014-12-01T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Sometimes its useful to be able see the values of environment variables in
running processes. We can use the following test program to see how well we can
accomplish this:</p>|js}
  };
 
  { title = {js|How to choose a teaching language|js}
  ; slug = {js|how-to-choose-a-teaching-language|js}
  ; description = Some {js|If you were teaching a programming course, what language would you teach it in?|js}
  ; url = {js|https://blog.janestreet.com/how-to-choose-a-teaching-language/|js}
  ; date = {js|2014-11-17T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>If you were teaching a programming course, what language would you teach it in?</p>|js}
  };
 
  { title = {js|Interviewing At Jane Street|js}
  ; slug = {js|interviewing-at-jane-street|js}
  ; description = Some {js|Software Engineering Interviews at Jane Street|js}
  ; url = {js|https://blog.janestreet.com/interviewing-at-jane-street/|js}
  ; date = {js|2014-10-24T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<h1>Software Engineering Interviews at Jane Street</h1>|js}
  };
 
  { title = {js|What the interns have wrought: RPC_parallel and Core_profiler|js}
  ; slug = {js|what-the-interns-have-wrought-rpcparallel-and-coreprofiler|js}
  ; description = Some {js|We’re in the midst of intern hiring season, and so we get a lot of questionsabout what it’s like to be an intern at Jane Street. One of the things peoplemost...|js}
  ; url = {js|https://blog.janestreet.com/what-the-interns-have-wrought-rpc_parallel-and-core_profiler/|js}
  ; date = {js|2014-10-16T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>We&rsquo;re in the midst of intern hiring season, and so we get a lot of questions
about what it&rsquo;s like to be an intern at Jane Street. One of the things people
most want to know is what kind of projects they might work on as an intern.</p>|js}
  };
 
  { title = {js|What is gained and lost with 63-bit integers?|js}
  ; slug = {js|what-is-gained-and-lost-with-63-bit-integers|js}
  ; description = Some {js|Almost every programming language uses 64-bit integers on typical modern Intelmachines. OCaml uses a special 63-bit representation. How does it affect OCaml?|js}
  ; url = {js|https://blog.janestreet.com/what-is-gained-and-lost-with-63-bit-integers/|js}
  ; date = {js|2014-09-29T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Almost every programming language uses 64-bit integers on typical modern Intel
machines. OCaml uses a special 63-bit representation. How does it affect OCaml?</p>|js}
  };
 
  { title = {js|Clearly Failing|js}
  ; slug = {js|clearly-failing|js}
  ; description = Some {js|The Parable Of The Perfect Connection|js}
  ; url = {js|https://blog.janestreet.com/clearly-failing/|js}
  ; date = {js|2014-08-23T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<h1>The Parable Of The Perfect Connection</h1>|js}
  };
 
  { title = {js|The ML Workshop looks fantastic|js}
  ; slug = {js|the-ml-workshop-looks-fantastic|js}
  ; description = Some {js|I’m a little biased, by being on the steering committee, but this year’s MLworkshop looks really interesting. Here’s a link to the program:|js}
  ; url = {js|https://blog.janestreet.com/the-ml-workshop-looks-fantastic/|js}
  ; date = {js|2014-07-31T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I&rsquo;m a little biased, by being on the steering committee, but this year&rsquo;s ML
workshop looks really interesting. Here&rsquo;s a link to the program:</p>|js}
  };
 
  { title = {js|Simple top-down development in OCaml|js}
  ; slug = {js|simple-top-down-development-in-ocaml|js}
  ; description = Some {js|Often when writing a new module, I want to write the interface first and savethe implementation for later. This lets me use the module as a black box,extendi...|js}
  ; url = {js|https://blog.janestreet.com/simple-top-down-development-in-ocaml/|js}
  ; date = {js|2014-07-18T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Often when writing a new module, I want to write the interface first and save
the implementation for later. This lets me use the module as a black box,
extending the interface as needed to support the rest of the program. When
everything else is finished, I can fill in the implementation, knowing the full
interface I need to support. Of course sometimes the implementation needs to
push back on the interface &ndash; this pattern isn&rsquo;t an absolute &ndash; but it&rsquo;s certainly
a useful starting point. The trick is getting the program to compile at
intermediate stages when the implementation hasn&rsquo;t been filled in.</p>|js}
  };
 
  { title = {js|What's in a name?|js}
  ; slug = {js|whats-in-a-name|js}
  ; description = Some {js|In the once upon a time days of the First Age of Magic, the prudent sorcererregarded his own true name as his most valued possession but also the greatestt...|js}
  ; url = {js|https://blog.janestreet.com/whats-in-a-name/|js}
  ; date = {js|2014-07-10T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<blockquote>
  <p>In the once upon a time days of the First Age of Magic, the prudent sorcerer
regarded his own true name as his most valued possession but also the greatest
threat to his continued good health, for&mdash;the stories go&mdash;once an enemy, even a
weak unskilled enemy, learned the sorcerer&rsquo;s true name, then routine and
widely known spells could destroy or enslave even the most powerful. As times
passed, and we graduated to the Age of Reason and thence to the first and
second industrial revolutions, such notions were discredited. Now it seems
that the Wheel has turned full circle (even if there never really was a First
Age) and we are back to worrying about true names again.</p>

  <p>&ndash; <em>True Names</em>, V.&nbsp;Vinge</p>
</blockquote>|js}
  };
 
  { title = {js|Inspecting Internal TCP State on Linux|js}
  ; slug = {js|inspecting-internal-tcp-state-on-linux|js}
  ; description = Some {js|Sometimes it can be useful to inspect the state of a TCP endpoint. Things suchas the current congestion window, the retransmission timeout (RTO), duplicateac...|js}
  ; url = {js|https://blog.janestreet.com/inspecting-internal-tcp-state-on-linux/|js}
  ; date = {js|2014-07-09T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>Sometimes it can be useful to inspect the state of a TCP endpoint. Things such
as the current congestion window, the retransmission timeout (RTO), duplicate
ack threshold, etc. are not reflected in the segments that flow over the wire.
Therefore, just looking at packet captures can leave you scratching your head as
to why a TCP connection is behaving a certain way.</p>|js}
  };
 
  { title = {js|Making “never break the build” scale|js}
  ; slug = {js|making-never-break-the-build-scale|js}
  ; description = Some {js|I just stumbled across a post fromearlier this year by Graydon Hoare, of Rust fame.The post is about what he calls the “Not Rocket Science Rule”, which says ...|js}
  ; url = {js|https://blog.janestreet.com/making-never-break-the-build-scale/|js}
  ; date = {js|2014-07-06T00:00:00-00:00|js}
  ; preview_image = Some {js|https://blog.janestreet.com/static/img/header.png|js}
  ; featured = false
  ; body_html = {js|<p>I just stumbled across a <a href="http://graydon2.dreamwidth.org/1597.html">post</a> from
earlier this year by Graydon Hoare, of <a href="http://www.rust-lang.org/">Rust</a> fame.
The post is about what he calls the &ldquo;Not Rocket Science Rule&rdquo;, which says that
you should automatically maintain a repository that never fails its tests. The
advantages of the NRS rule are pretty clear. By ensuring that you never break
the build, you shield people from having to deal with bugs that could easily
have been caught automatically.</p>|js}
  }]

